<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lord of the Mysteries - Blind Card Battler</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Primary colors */
            --color-gold: #ffd700;
            --color-purple: #4a4a8a;
            --color-purple-light: #6a4a8a;
            --color-triumph: #aa44ff;
            --color-text: #e8e8e8;
            --color-text-muted: #b8b8b8;
            --color-text-dim: #999;
            --color-error: #ff6b6b;
            --color-success: #4a8a4a;
            --color-danger: #ff4a4a;
            --color-warning: #ffa500;
            --color-info: #4a9eff;
            --color-player: #4a9eff;
            --color-opponent: #ff4a4a;

            /* Background variations */
            --bg-dark: rgba(0, 0, 0, 0.3);
            --bg-darker: rgba(0, 0, 0, 0.4);
            --bg-darkest: rgba(0, 0, 0, 0.5);
            --bg-gold-subtle: rgba(255, 215, 0, 0.1);
            --bg-gold-light: rgba(255, 215, 0, 0.15);
            --bg-gold-medium: rgba(255, 215, 0, 0.2);
            --bg-triumph-subtle: rgba(170, 68, 255, 0.1);
            --bg-triumph-light: rgba(170, 68, 255, 0.2);

            /* Transitions */
            --transition-instant: all 0.15s ease;
            --transition-fast: all 0.2s ease;
            --transition-medium: all 0.3s ease;
            --transition-slow: all 0.5s ease;

            /* Sizing */
            --sidebar-width: 340px;
            --container-max-width: 1400px;
            --border-radius-sm: 6px;
            --border-radius-md: 12px;
            --border-radius-lg: 16px;

            /* Responsive card sizing */
            --card-width: 140px;
            --card-height: 180px;
            --played-card-width: 120px;
            --played-card-height: 160px;
            --card-back-width: 80px;
            --card-back-height: 100px;
            --touch-target-min: 44px;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: #e8e8e8;
            transition: background 0.3s ease, color 0.3s ease;
        }

        /* Light Mode Theme */
        body.light-mode {
            background: linear-gradient(135deg, #f0f0f5 0%, #e8e8f0 50%, #dde0e8 100%);
            color: #1a1a2e;
        }

        body.light-mode {
            --color-text: #1a1a2e;
            --color-text-muted: #555;
            --color-text-dim: #777;
            --bg-dark: rgba(0, 0, 0, 0.08);
            --bg-darker: rgba(0, 0, 0, 0.12);
            --bg-darkest: rgba(0, 0, 0, 0.18);
            --bg-gold-subtle: rgba(180, 140, 0, 0.15);
            --bg-gold-light: rgba(180, 140, 0, 0.2);
            --bg-gold-medium: rgba(180, 140, 0, 0.25);
        }

        /* Theme toggle button */
        .theme-toggle {
            position: fixed;
            top: 15px;
            right: 15px;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: 2px solid var(--color-gold);
            background: var(--bg-dark);
            color: var(--color-gold);
            font-size: 20px;
            cursor: pointer;
            z-index: 1001;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition-fast);
        }

        .theme-toggle:hover {
            background: var(--bg-gold-subtle);
            transform: scale(1.1);
        }

        body.light-mode .theme-toggle {
            background: rgba(255, 255, 255, 0.8);
            border-color: #4a4a8a;
            color: #4a4a8a;
        }

        /* Light mode - cards and containers */
        body.light-mode .card {
            background: linear-gradient(135deg, #ffffff 0%, #f0f0f5 100%);
            border-color: #4a4a8a;
            color: #1a1a2e;
        }

        body.light-mode .card:hover:not(.disabled) {
            border-color: var(--color-gold);
            box-shadow: 0 0 15px rgba(180, 140, 0, 0.4);
        }

        body.light-mode .played-card {
            background: linear-gradient(135deg, #ffffff 0%, #f0f0f5 100%);
            border-color: #4a4a8a;
        }

        body.light-mode .hp-bar {
            background: rgba(0, 0, 0, 0.15);
        }

        body.light-mode .modal-content,
        body.light-mode .achievement-modal-content,
        body.light-mode .welcome-content,
        body.light-mode .intro-screen {
            background: linear-gradient(135deg, #ffffff 0%, #f5f5fa 100%);
            color: #1a1a2e;
        }

        body.light-mode .sidebar-box,
        body.light-mode .stats-box,
        body.light-mode .game-over-box {
            background: rgba(255, 255, 255, 0.85);
            border-color: rgba(74, 74, 138, 0.3);
        }

        body.light-mode .battle-area {
            background: rgba(255, 255, 255, 0.5);
        }

        body.light-mode input {
            background: #ffffff;
            border-color: #4a4a8a;
            color: #1a1a2e;
        }

        body.light-mode .btn-play,
        body.light-mode .welcome-btn {
            color: #ffffff;
        }

        .game-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Main 3-column layout */
        .main-layout {
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }

        .left-sidebar {
            width: 340px;
            flex-shrink: 0;
            position: sticky;
            top: 20px;
        }

        .achievement-box {
            background: var(--bg-dark);
            border: 2px solid var(--color-purple);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 15px;
        }

        .achievement-box-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .achievement-box h3 {
            color: var(--color-gold);
            font-size: 14px;
            margin: 0;
        }

        .achievement-see-all {
            font-size: 10px;
            color: var(--color-text-dim);
            cursor: pointer;
            transition: color 0.2s;
        }

        .achievement-see-all:hover {
            color: var(--color-gold);
        }

        .achievement-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .achievement-placeholder {
            color: #666;
            font-size: 12px;
            text-align: center;
            font-style: italic;
        }

        .achievement-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
            padding: 8px 10px;
            background: var(--bg-gold-subtle);
            border-radius: 6px;
            border: 1px solid var(--color-purple);
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .achievement-item:hover {
            background: var(--bg-gold-medium);
            border-color: var(--color-gold);
        }

        .achievement-item .achievement-header {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .achievement-item .achievement-icon {
            font-size: 20px;
            flex-shrink: 0;
        }

        .achievement-item .achievement-name {
            font-size: 12px;
            color: var(--color-gold);
            font-weight: bold;
        }

        .achievement-item .achievement-difficulty {
            font-size: 9px;
            color: var(--color-text-dim);
            margin-left: auto;
        }

        .achievement-item .achievement-desc {
            font-size: 10px;
            color: var(--color-text-muted);
            padding-left: 28px;
            display: none;
            line-height: 1.4;
        }

        .achievement-item.expanded .achievement-desc {
            display: block;
        }

        .achievement-item.expanded {
            background: var(--bg-gold-light);
        }

        .achievement-item.triumph {
            border-color: #6a4a8a;
            background: var(--bg-triumph-subtle);
        }

        .achievement-item.triumph:hover {
            background: var(--bg-triumph-light);
            border-color: #aa44ff;
        }

        .achievement-item.triumph.expanded {
            background: rgba(170, 68, 255, 0.15);
        }

        .achievement-item .achievement-title {
            font-size: 10px;
            color: var(--color-text-dim);
            padding-left: 28px;
            display: none;
            margin-top: 4px;
        }

        .achievement-item.expanded .achievement-title {
            display: block;
        }

        .achievement-count {
            font-size: 10px;
            color: #666;
            text-align: center;
            margin-top: 6px;
        }

        .achievement-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            z-index: 300;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .achievement-modal.show {
            display: flex;
        }

        .achievement-modal-content {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border: 2px solid var(--color-purple);
            border-radius: 16px;
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }

        .achievement-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #4a4a8a;
        }

        .achievement-modal-header h2 {
            color: var(--color-gold);
            font-size: 18px;
            margin: 0;
        }

        .achievement-modal-hint {
            text-align: center;
            font-size: 11px;
            color: #666;
            margin: 0;
            padding: 5px 15px 10px;
            border-bottom: 1px solid #4a4a8a;
        }

        .achievement-modal-body {
            padding: 15px;
            overflow-y: auto;
            flex: 1;
        }

        .achievement-modal-section {
            margin-bottom: 15px;
        }

        .achievement-modal-section h3 {
            color: var(--color-text-dim);
            font-size: 12px;
            margin: 0 0 8px 0;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .achievement-modal-grid {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .achievement-modal-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            border: 1px solid #3a3a5a;
        }

        .achievement-modal-item.unlocked {
            background: var(--bg-gold-subtle);
            border-color: #4a4a8a;
        }

        .achievement-modal-item.locked {
            opacity: 0.5;
        }

        .achievement-modal-item .ach-icon {
            font-size: 20px;
            width: 28px;
            text-align: center;
        }

        .achievement-modal-item .ach-info {
            flex: 1;
        }

        .achievement-modal-item .ach-name {
            font-size: 12px;
            font-weight: bold;
            color: var(--color-gold);
        }

        .achievement-modal-item.locked .ach-name {
            color: var(--color-text-dim);
        }

        .achievement-modal-item .ach-desc {
            font-size: 10px;
            color: var(--color-text-muted);
        }

        .achievement-modal-item .ach-difficulty {
            font-size: 10px;
            color: #666;
        }

        .achievement-modal-item .ach-title {
            font-size: 10px;
            color: var(--color-text-dim);
            margin-top: 4px;
        }

        .achievement-modal-content .triumph-section h3 {
            color: #aa44ff;
        }

        .achievement-modal-item.triumph-item {
            border-color: #552266;
        }

        .achievement-modal-item.triumph-item.unlocked {
            background: rgba(170, 68, 255, 0.15);
            border-color: #aa44ff;
        }

        .achievement-modal-item.triumph-item.unlocked .ach-name {
            color: #cc88ff;
        }

        .achievement-modal-item.selectable {
            cursor: pointer;
            position: relative;
        }

        .achievement-modal-item.selectable:hover {
            transform: scale(1.02);
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
        }

        .achievement-modal-item.triumph-item.selectable:hover {
            box-shadow: 0 0 10px rgba(170, 68, 255, 0.3);
        }

        .achievement-modal-content .achievement-modal-item.selected {
            border: 2px solid #ffd700;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.4);
        }

        .achievement-modal-content .achievement-modal-item.triumph-item.selected {
            border: 2px solid #aa44ff;
            box-shadow: 0 0 15px rgba(170, 68, 255, 0.4);
        }

        .selected-badge {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #ffd700;
            color: #1a1a2e;
            font-size: 8px;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 4px;
            text-transform: uppercase;
        }

        .triumph-item .selected-badge {
            background: #aa44ff;
            color: white;
        }

        .achievement-notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: linear-gradient(135deg, #2a2a4a, #1a1a2e);
            border: 2px solid #ffd700;
            border-radius: 12px;
            padding: 15px 25px;
            display: flex;
            align-items: center;
            gap: 15px;
            z-index: 1000;
            opacity: 0;
            transition: var(--transition-slow);
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.3);
        }

        .achievement-notification.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .achievement-notification-icon {
            font-size: 36px;
        }

        .achievement-notification-text {
            display: flex;
            flex-direction: column;
        }

        .achievement-notification-title {
            color: var(--color-gold);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .achievement-notification-name {
            color: white;
            font-size: 18px;
            font-weight: bold;
        }

        /* Triumph Notification */
        .triumph-notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: linear-gradient(135deg, #2a1a3a, #1a0a2e);
            border: 2px solid #aa44ff;
            border-radius: 12px;
            padding: 15px 25px;
            display: flex;
            align-items: center;
            gap: 15px;
            z-index: 1000;
            opacity: 0;
            transition: all 0.5s ease;
            box-shadow: 0 0 40px rgba(170, 68, 255, 0.5);
        }

        .triumph-notification.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .triumph-notification-icon {
            font-size: 40px;
        }

        .triumph-notification-text {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .triumph-notification-title {
            color: #aa44ff;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .triumph-notification-name {
            color: white;
            font-size: 18px;
            font-weight: bold;
        }

        .triumph-notification-title-earned {
            color: var(--color-text-dim);
            font-size: 12px;
        }

        /* Title Effects */
        .title-text {
            font-weight: bold;
            display: inline-block;
        }

        .title-text.golden-shimmer {
            background: linear-gradient(90deg, #ffd700, #fff8dc, #ffd700, #daa520, #ffd700);
            background-size: 200% auto;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: golden-shimmer 2s linear infinite;
        }

        @keyframes golden-shimmer {
            0% { background-position: 0% center; }
            100% { background-position: 200% center; }
        }

        .title-text.madness-pulse {
            background: linear-gradient(90deg, #ff4444, #aa00aa, #ff4444, #ff0066, #aa00aa);
            background-size: 200% auto;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: madness-pulse 1.5s ease-in-out infinite;
        }

        @keyframes madness-pulse {
            0%, 100% { background-position: 0% center; opacity: 1; }
            50% { background-position: 100% center; opacity: 0.8; }
        }

        .title-text.crystal-cool {
            background: linear-gradient(90deg, #66ccff, #aaeeff, #ffffff, #aaeeff, #66ccff);
            background-size: 200% auto;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: crystal-cool 3s linear infinite;
            text-shadow: 0 0 10px rgba(102, 204, 255, 0.5);
        }

        @keyframes crystal-cool {
            0% { background-position: 0% center; }
            100% { background-position: 200% center; }
        }

        .title-text.blood-drip {
            background: linear-gradient(180deg, #ff4444, #aa0000, #660000);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: blood-drip 2s ease-in-out infinite;
        }

        @keyframes blood-drip {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(2px); }
        }

        .title-text.mystic-runes {
            background: linear-gradient(90deg, #9944ff, #ff44ff, #44ffff, #9944ff);
            background-size: 300% auto;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: mystic-runes 4s linear infinite;
            text-shadow: 0 0 15px rgba(153, 68, 255, 0.6);
        }

        @keyframes mystic-runes {
            0% { background-position: 0% center; }
            100% { background-position: 300% center; }
        }

        .title-text.ghostly-fade {
            color: #aaccff;
            animation: ghostly-fade 3s ease-in-out infinite;
        }

        @keyframes ghostly-fade {
            0%, 100% { opacity: 1; transform: translateX(0); }
            25% { opacity: 0.5; }
            50% { opacity: 0.8; transform: translateX(2px); }
            75% { opacity: 0.4; }
        }

        .title-text.elegant-gold {
            background: linear-gradient(90deg, #ffd700, #fffacd, #ffd700);
            background-size: 200% auto;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            font-style: italic;
            animation: elegant-gold 3s ease-in-out infinite;
        }

        @keyframes elegant-gold {
            0%, 100% { background-position: 0% center; }
            50% { background-position: 100% center; }
        }

        .title-text.foggy-glitch {
            color: #c8d0e0;
            text-shadow:
                0 0 10px rgba(150, 160, 180, 0.8),
                0 0 20px rgba(100, 120, 150, 0.5),
                0 0 30px rgba(80, 100, 140, 0.3);
            animation: foggy-glitch 4s ease-in-out infinite;
            position: relative;
        }

        @keyframes foggy-glitch {
            0%, 100% {
                opacity: 1;
                transform: translateX(0);
                filter: blur(0px);
            }
            7% {
                opacity: 0.8;
                transform: translateX(-2px);
                filter: blur(0.5px);
            }
            8% {
                opacity: 1;
                transform: translateX(2px);
                filter: blur(0px);
            }
            9% {
                transform: translateX(0);
            }
            45%, 55% {
                opacity: 1;
                filter: blur(0px);
            }
            50% {
                opacity: 0.7;
                filter: blur(1px);
            }
            77% {
                opacity: 1;
                transform: translateX(0);
            }
            78% {
                opacity: 0.6;
                transform: translateX(1px) skewX(-2deg);
                filter: blur(0.5px);
            }
            79% {
                opacity: 0.9;
                transform: translateX(-1px) skewX(1deg);
            }
            80% {
                opacity: 1;
                transform: translateX(0) skewX(0);
                filter: blur(0px);
            }
        }

        /* === OUTER DEITY TITLE EFFECTS === */

        .title-text.sefirah-glow {
            background: linear-gradient(90deg, #c9a227, #fff, #c9a227, #8b6914, #c9a227);
            background-size: 300% auto;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: sefirah-glow 3s ease-in-out infinite;
            text-shadow: 0 0 20px rgba(201, 162, 39, 0.5);
        }

        @keyframes sefirah-glow {
            0%, 100% { background-position: 0% center; filter: brightness(1); }
            50% { background-position: 100% center; filter: brightness(1.3); }
        }

        .title-text.void-pulse {
            color: #1a1a2e;
            text-shadow: 0 0 10px #000, 0 0 20px #1a1a2e, 0 0 30px #2a2a4e;
            animation: void-pulse 2s ease-in-out infinite;
        }

        @keyframes void-pulse {
            0%, 100% { text-shadow: 0 0 10px #000, 0 0 20px #1a1a2e; opacity: 0.8; }
            50% { text-shadow: 0 0 20px #000, 0 0 40px #2a2a4e, 0 0 60px #3a3a5e; opacity: 1; }
        }

        .title-text.moon-shimmer {
            color: #e8e8ff;
            text-shadow: 0 0 10px #aaaaff, 0 0 20px #8888dd;
            animation: moon-shimmer 3s ease-in-out infinite;
        }

        @keyframes moon-shimmer {
            0%, 100% { text-shadow: 0 0 10px #aaaaff, 0 0 20px #8888dd; }
            50% { text-shadow: 0 0 20px #ccccff, 0 0 40px #aaaaff, 0 0 60px #8888dd; }
        }

        .title-text.frenzy-flicker {
            color: #ff4444;
            animation: frenzy-flicker 0.5s ease-in-out infinite;
        }

        @keyframes frenzy-flicker {
            0%, 100% { opacity: 1; color: #ff4444; }
            25% { opacity: 0.7; color: #ff6666; }
            50% { opacity: 1; color: #cc2222; }
            75% { opacity: 0.8; color: #ff4444; }
        }

        .title-text.knowledge-glow {
            color: #88ccff;
            text-shadow: 0 0 10px #4488ff, 0 0 20px #2266dd;
            animation: knowledge-glow 2s ease-in-out infinite;
        }

        @keyframes knowledge-glow {
            0%, 100% { text-shadow: 0 0 10px #4488ff, 0 0 20px #2266dd; }
            50% { text-shadow: 0 0 15px #66aaff, 0 0 30px #4488ff; }
        }

        .title-text.war-flame {
            background: linear-gradient(90deg, #ff4400, #ffaa00, #ff4400, #ff0000, #ff4400);
            background-size: 200% auto;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: war-flame 1.5s linear infinite;
        }

        @keyframes war-flame {
            0% { background-position: 0% center; }
            100% { background-position: 200% center; }
        }

        .title-text.solar-radiance {
            color: #fff;
            text-shadow: 0 0 10px #ffd700, 0 0 20px #ffaa00, 0 0 30px #ff8800, 0 0 40px #ff6600;
            animation: solar-radiance 2s ease-in-out infinite;
        }

        @keyframes solar-radiance {
            0%, 100% { text-shadow: 0 0 10px #ffd700, 0 0 20px #ffaa00, 0 0 30px #ff8800; }
            50% { text-shadow: 0 0 20px #fff, 0 0 40px #ffd700, 0 0 60px #ffaa00; }
        }

        .title-text.abyssal-corruption {
            color: #8844aa;
            text-shadow: 0 0 10px #440066, 0 0 20px #220033;
            animation: abyssal-corruption 3s ease-in-out infinite;
        }

        @keyframes abyssal-corruption {
            0%, 100% { color: #8844aa; transform: scale(1); }
            50% { color: #aa66cc; transform: scale(1.02); }
        }

        .title-text.holy-radiance {
            color: #ffffcc;
            text-shadow: 0 0 15px #ffd700, 0 0 30px #ffcc00;
            animation: holy-radiance 2s ease-in-out infinite;
        }

        @keyframes holy-radiance {
            0%, 100% { text-shadow: 0 0 15px #ffd700, 0 0 30px #ffcc00; }
            50% { text-shadow: 0 0 25px #fff, 0 0 50px #ffd700; }
        }

        .title-text.order-pulse {
            color: #aaaaaa;
            text-shadow: 0 0 5px #888;
            animation: order-pulse 1.5s steps(2) infinite;
        }

        @keyframes order-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .title-text.fortune-spin {
            background: linear-gradient(90deg, #ff0000, #ff8800, #ffff00, #00ff00, #0088ff, #8800ff, #ff0000);
            background-size: 700% auto;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: fortune-spin 4s linear infinite;
        }

        @keyframes fortune-spin {
            0% { background-position: 0% center; }
            100% { background-position: 700% center; }
        }

        .title-text.creation-shimmer {
            background: linear-gradient(90deg, #fff, #ffd700, #fff, #88ccff, #fff, #ff88cc, #fff);
            background-size: 400% auto;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: creation-shimmer 5s ease-in-out infinite;
            text-shadow: 0 0 30px rgba(255, 255, 255, 0.5);
        }

        @keyframes creation-shimmer {
            0%, 100% { background-position: 0% center; }
            50% { background-position: 400% center; }
        }

        /* Player Title Display */
        #player-title {
            text-align: center;
            font-size: 12px;
            margin-top: 5px;
            display: none;
        }

        /* Secret Code Popup */
        .secret-word {
            cursor: text;
        }

        .secret-popup {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 400;
            justify-content: center;
            align-items: center;
        }

        .secret-popup.show {
            display: flex;
        }

        .secret-popup-content {
            background: linear-gradient(135deg, #1a1a2e, #0f0f1a);
            border: 2px solid var(--color-purple);
            border-radius: 16px;
            padding: 30px;
            text-align: center;
            max-width: 300px;
        }

        .secret-popup-content h3 {
            color: var(--color-gold);
            margin-bottom: 20px;
            font-size: 16px;
        }

        .secret-code-input {
            width: 150px;
            padding: 12px;
            font-size: 24px;
            text-align: center;
            letter-spacing: 8px;
            background: var(--bg-darkest);
            border: 2px solid var(--color-purple);
            border-radius: 8px;
            color: var(--color-gold);
            font-family: monospace;
        }

        .secret-code-input:focus {
            outline: 2px solid var(--color-gold);
            outline-offset: 2px;
            border-color: var(--color-gold);
        }

        .secret-popup-buttons {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .secret-popup-btn {
            padding: 8px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: var(--transition-fast);
        }

        .secret-popup-btn.submit {
            background: #ffd700;
            color: #1a1a2e;
            font-weight: bold;
        }

        .secret-popup-btn.submit:hover {
            background: #ffed4a;
        }

        .secret-popup-btn.cancel {
            background: rgba(255, 255, 255, 0.1);
            color: var(--color-text-dim);
        }

        .secret-popup-btn.cancel:hover {
            background: rgba(255, 255, 255, 0.2);
            color: var(--color-text-muted);
        }

        .secret-message {
            margin-top: 15px;
            font-size: 12px;
            color: var(--color-text-dim);
            min-height: 18px;
        }

        .secret-message.error {
            color: #ff6666;
        }

        .secret-message.success {
            color: #66ff66;
        }

        .secret-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
        }

        .secret-tab {
            flex: 1;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--color-purple);
            border-radius: 6px;
            color: var(--color-text-dim);
            cursor: pointer;
            font-size: 12px;
            transition: var(--transition-fast);
        }

        .secret-tab:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--color-text-muted);
        }

        .secret-tab.active {
            background: var(--color-purple);
            color: white;
            border-color: var(--color-gold);
        }

        .secret-tab-content {
            min-height: 80px;
        }

        .secret-tab-content.hidden {
            display: none;
        }

        .secret-hint {
            font-size: 11px;
            color: var(--color-text-dim);
            margin-bottom: 10px;
        }

        /* GM Panel */
        .gm-panel {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 500;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .gm-panel.show {
            display: flex;
        }

        .gm-panel-content {
            background: linear-gradient(135deg, #1a0a0a, #2a1a1a);
            border: 2px solid #ff4444;
            border-radius: 16px;
            max-width: 600px;
            width: 100%;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
        }

        .gm-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #ff4444;
        }

        .gm-panel-header h2 {
            color: #ff4444;
            font-size: 18px;
            margin: 0;
        }

        .gm-close-btn {
            background: none;
            border: none;
            color: #ff4444;
            font-size: 28px;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }

        .gm-close-btn:hover {
            color: #ff6666;
        }

        .gm-panel-toolbar {
            padding: 10px 20px;
            border-bottom: 1px solid #442222;
        }

        .gm-reset-btn {
            background: #442222;
            border: 1px solid #ff4444;
            color: #ff6666;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
        }

        .gm-reset-btn:hover {
            background: #552222;
        }

        .gm-achievement-list {
            padding: 15px;
            overflow-y: auto;
            flex: 1;
        }

        .gm-section {
            margin-bottom: 20px;
        }

        .gm-section-header {
            color: #ff8844;
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #442222;
        }

        .gm-achievement-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px;
            background: rgba(255, 68, 68, 0.1);
            border: 1px solid #442222;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .gm-achievement-item:hover {
            background: rgba(255, 68, 68, 0.2);
            border-color: #ff4444;
        }

        .gm-achievement-item.unlocked {
            background: rgba(68, 255, 68, 0.1);
            border-color: #44ff44;
            cursor: default;
        }

        .gm-achievement-item.unlocked:hover {
            background: rgba(68, 255, 68, 0.15);
        }

        .gm-ach-icon {
            font-size: 24px;
            flex-shrink: 0;
        }

        .gm-ach-info {
            flex: 1;
        }

        .gm-ach-name {
            font-size: 13px;
            font-weight: bold;
            color: var(--color-gold);
        }

        .gm-achievement-item.unlocked .gm-ach-name {
            color: #66ff66;
        }

        .gm-ach-desc {
            font-size: 11px;
            color: var(--color-text-muted);
        }

        .gm-ach-status {
            font-size: 11px;
            color: var(--color-text-dim);
            flex-shrink: 0;
        }

        .gm-achievement-item.unlocked .gm-ach-status {
            color: #66ff66;
            font-size: 16px;
        }

        /* GM Triumph Section */
        .gm-triumph-section {
            border-top: 2px solid #aa44ff;
            margin-top: 20px;
            padding-top: 15px;
        }

        .gm-panel .gm-triumph-header {
            color: #aa44ff;
            border-bottom-color: #552266;
        }

        .gm-panel .gm-triumph-item {
            background: rgba(170, 68, 255, 0.1);
            border-color: #552266;
        }

        .gm-panel .gm-triumph-item:hover {
            background: rgba(170, 68, 255, 0.2);
            border-color: #aa44ff;
        }

        .gm-panel .gm-triumph-item.unlocked {
            background: rgba(170, 68, 255, 0.15);
            border-color: #aa44ff;
        }

        .gm-triumph-title {
            font-size: 10px;
            color: var(--color-text-dim);
            margin-top: 4px;
        }

        /* Switch Display Popup */
        .switch-display-popup {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1100;
            justify-content: center;
            align-items: center;
        }

        .switch-display-popup.show {
            display: flex;
        }

        .switch-display-content {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border: 2px solid #ffd700;
            border-radius: 12px;
            padding: 20px 30px;
            text-align: center;
            max-width: 300px;
            animation: popup-appear 0.3s ease;
        }

        @keyframes popup-appear {
            from {
                transform: scale(0.8);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .switch-display-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .switch-display-icon {
            font-size: 32px;
        }

        .switch-display-name {
            font-size: 16px;
            font-weight: bold;
            color: var(--color-gold);
        }

        .switch-display-question {
            color: #ccc;
            font-size: 14px;
            margin-bottom: 20px;
        }

        .switch-display-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .switch-display-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: bold;
            transition: var(--transition-fast);
        }

        .switch-display-btn.yes {
            background: #ffd700;
            color: #1a1a2e;
        }

        .switch-display-btn.yes:hover {
            background: #ffed4a;
        }

        .switch-display-btn.no {
            background: rgba(255, 255, 255, 0.1);
            color: var(--color-text-muted);
        }

        .switch-display-btn.no:hover {
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
        }

        .center-content {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .right-sidebar {
            width: 340px;
            flex-shrink: 0;
            position: sticky;
            top: 20px;
        }

        h1 {
            text-align: center;
            color: var(--color-gold);
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            margin-bottom: 5px;
        }

        .subtitle {
            text-align: center;
            color: var(--color-text-dim);
            margin-bottom: 15px;
            font-size: 14px;
        }

        /* Mode Selection */
        .mode-selection {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .mode-btn {
            padding: 10px 15px;
            font-size: 13px;
            font-weight: bold;
            border: 2px solid #444;
            border-radius: 8px;
            cursor: pointer;
            background: rgba(0,0,0,0.3);
            color: var(--color-text-muted);
            transition: var(--transition-fast);
            flex: 1;
        }

        .mode-btn:hover {
            border-color: #666;
            color: #fff;
        }

        .mode-btn.active {
            border-color: var(--color-gold);
            color: var(--color-gold);
            background: var(--bg-gold-subtle);
        }

        /* AI Difficulty Selection */
        .difficulty-selection {
            display: none;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 15px;
            padding: 12px;
            background: var(--bg-dark);
            border: 1px solid #4a4a8a;
            border-radius: 8px;
        }

        .difficulty-selection.show {
            display: flex;
        }

        .difficulty-label {
            font-size: 11px;
            color: var(--color-text-dim);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 4px;
        }

        .difficulty-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .difficulty-btn {
            padding: 10px 8px;
            font-size: 11px;
            font-weight: bold;
            border: 2px solid #333;
            border-radius: 6px;
            cursor: pointer;
            background: rgba(0,0,0,0.3);
            color: var(--color-text-muted);
            transition: var(--transition-fast);
            text-align: center;
        }

        .difficulty-btn:hover {
            transform: scale(1.02);
        }

        .difficulty-btn.easy {
            border-color: #3a5a3a;
        }

        .difficulty-btn.easy:hover,
        .difficulty-btn.easy.active {
            border-color: #4a8a4a;
            color: #6c6;
            background: rgba(76, 138, 76, 0.2);
        }

        .difficulty-btn.medium {
            border-color: #5a5a3a;
        }

        .difficulty-btn.medium:hover,
        .difficulty-btn.medium.active {
            border-color: #aa8a4a;
            color: #cc9;
            background: rgba(170, 138, 74, 0.2);
        }

        .difficulty-btn.hard {
            border-color: #5a3a3a;
        }

        .difficulty-btn.hard:hover,
        .difficulty-btn.hard.active {
            border-color: #aa4a4a;
            color: #c66;
            background: rgba(170, 74, 74, 0.2);
        }

        .difficulty-btn.god {
            border-color: #5a3a6a;
            position: relative;
            overflow: hidden;
        }

        .difficulty-btn.god::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(170, 68, 255, 0.1), transparent);
            animation: godShimmer 3s infinite;
        }

        @keyframes godShimmer {
            0% { transform: translateX(-100%) rotate(45deg); }
            100% { transform: translateX(100%) rotate(45deg); }
        }

        .difficulty-btn.god:hover,
        .difficulty-btn.god.active {
            border-color: #aa44ff;
            color: #cc88ff;
            background: rgba(170, 68, 255, 0.25);
            box-shadow: 0 0 15px rgba(170, 68, 255, 0.3);
        }

        .difficulty-desc {
            font-size: 9px;
            color: #666;
            font-weight: normal;
            margin-top: 2px;
        }

        /* Title Row with Game Type Toggle */
        .title-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 5px;
        }

        .title-row h1 {
            margin: 0;
        }

        /* Game Type Toggle (Pathways vs Outer Deities) */
        .game-type-toggle {
            display: flex;
            gap: 5px;
            padding: 4px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 6px;
        }

        .game-type-btn {
            padding: 6px 10px;
            font-size: 10px;
            font-weight: bold;
            border: 2px solid #333;
            border-radius: 4px;
            cursor: pointer;
            background: rgba(0, 0, 0, 0.3);
            color: var(--color-text-dim);
            transition: var(--transition-fast);
            text-align: center;
        }

        .game-type-btn:hover {
            border-color: #555;
            color: var(--color-text);
        }

        .game-type-btn.active {
            border-color: #aa44ff;
            color: #cc88ff;
            background: rgba(170, 68, 255, 0.15);
        }

        .game-type-btn.pathways.active {
            border-color: var(--color-gold);
            color: var(--color-gold);
            background: var(--bg-gold-subtle);
        }

        /* Connection Status */
        .connection-status {
            text-align: center;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 10px;
            font-weight: bold;
            display: none;
        }

        .connection-status.waiting {
            display: block;
            background: rgba(255, 165, 0, 0.2);
            border: 2px solid #ffa500;
            color: #ffa500;
        }

        .connection-status.connected {
            display: block;
            background: rgba(0, 255, 136, 0.2);
            border: 2px solid #00ff88;
            color: #00ff88;
        }

        .connection-status.playing {
            display: block;
            background: rgba(74, 158, 255, 0.2);
            border: 2px solid #4a9eff;
            color: #4a9eff;
        }

        /* HP Bars - Vertical stacked in left sidebar */
        .hp-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .hp-bar-container {
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            padding: 15px;
        }

        .hp-bar-container.player {
            border: 2px solid #4a9eff;
        }

        .hp-bar-container.opponent {
            border: 2px solid #ff4a4a;
        }

        .hp-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-weight: bold;
        }

        .hp-bar {
            height: 25px;
            background: #333;
            border-radius: 5px;
            overflow: hidden;
        }

        .hp-fill {
            height: 100%;
            transition: width 0.5s ease;
        }

        .hp-fill.player {
            background: linear-gradient(90deg, #4a9eff, #00d4ff);
        }

        .hp-fill.opponent {
            background: linear-gradient(90deg, #ff4a4a, #ff8800);
        }

        /* Madness Bar */
        .madness-bar-container {
            margin-top: 10px;
            padding-top: 8px;
            border-top: 1px solid rgba(128, 0, 128, 0.3);
        }

        .madness-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            font-size: 12px;
            color: #b380b3;
        }

        .madness-bar {
            height: 12px;
            background: #1a0a1a;
            border-radius: 3px;
            overflow: hidden;
            border: 1px solid #4a004a;
        }

        .madness-fill {
            height: 100%;
            background: linear-gradient(90deg, #6a0dad, #9932cc, #ff00ff);
            transition: width 0.5s ease;
            box-shadow: 0 0 8px rgba(153, 50, 204, 0.6);
        }

        .madness-multiplier {
            font-size: 11px;
            text-align: right;
            margin-top: 3px;
            color: #888;
            transition: color 0.3s ease;
        }

        .madness-multiplier.danger-2x {
            color: #ffaa00;
            font-weight: bold;
        }

        /* Multiplier Display */
        .multiplier-display {
            text-align: center;
            padding: 10px;
            margin-bottom: 15px;
            font-size: 18px;
            font-weight: bold;
            border-radius: 8px;
            background: var(--bg-gold-subtle);
            border: 2px solid transparent;
            transition: var(--transition-medium);
        }

        .multiplier-display.active {
            background: rgba(255, 215, 0, 0.3);
            border-color: var(--color-gold);
            color: var(--color-gold);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        /* Battle Area */
        .battle-area {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 50px;
            margin-bottom: 20px;
            min-height: 180px;
        }

        .played-card {
            width: 120px;
            height: 160px;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            text-align: center;
            padding: 10px;
            font-weight: bold;
            transition: var(--transition-medium);
        }

        .played-card.empty {
            background: rgba(255,255,255,0.1);
            border: 2px dashed #555;
            color: #666;
            justify-content: center;
        }

        .played-card.face-down {
            background: linear-gradient(135deg, #2a2a4a, #1a1a3a);
            border: 2px solid #444;
            justify-content: center;
        }

        .played-card.revealed {
            border: 2px solid #ffd700;
        }

        .played-card.inner-god-card {
            border: 2px solid;
            border-image: linear-gradient(90deg, #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #4b0082, #9400d3, #ff0000) 1;
        }

        .inner-god-name {
            font-size: 16px;
            font-weight: bold;
            text-align: center;
            padding: 10px;
            line-height: 1.3;
        }

        .played-card.waiting {
            background: linear-gradient(135deg, #3a3a2a, #2a2a1a);
            border: 2px solid #ffa500;
            animation: waiting-pulse 1.5s infinite;
            justify-content: center;
        }

        @keyframes waiting-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .vs-text {
            font-size: 24px;
            font-weight: bold;
            color: var(--color-gold);
        }

        /* Hand Section */
        .hand-section {
            margin-bottom: 20px;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .hand-label {
            text-align: center;
            margin-bottom: 10px;
            color: var(--color-text-muted);
        }

        .hand {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .card {
            width: 140px;
            height: 180px;
            background: linear-gradient(135deg, #2d2d5a, #1a1a3a);
            border: 2px solid var(--color-purple);
            border-radius: 12px;
            cursor: pointer;
            transition: var(--transition-fast);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 15px;
            position: relative;
        }

        .card:hover {
            transform: translateY(-10px);
            border-color: var(--color-gold);
            box-shadow: 0 10px 30px rgba(255, 215, 0, 0.3);
        }

        .card.selected {
            transform: translateY(-15px);
            border-color: #00ff88;
            box-shadow: 0 15px 40px rgba(0, 255, 136, 0.4);
        }

        .card.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .card.disabled:hover {
            transform: none;
            border-color: #4a4a8a;
            box-shadow: none;
        }

        /* Custom tooltip for flavor text */
        .card::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: var(--color-gold);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
            white-space: normal;
            max-width: 200px;
            text-align: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.15s;
            z-index: 100;
            border: 1px solid #ffd700;
        }

        .card:hover::after {
            opacity: 1;
        }

        .card.disabled:hover::after {
            opacity: 0;
        }

        .card-name {
            font-size: 14px;
            font-weight: bold;
            color: var(--color-gold);
            margin-bottom: 8px;
            text-align: center;
            width: 100%;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        /* Rainbow text for Big Hit cards */
        .card-name.rainbow {
            background: linear-gradient(90deg, #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #4b0082, #9400d3, #ff0000);
            background-size: 200% auto;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: rainbow-shift 3s linear infinite;
        }

        @keyframes rainbow-shift {
            0% { background-position: 0% center; }
            100% { background-position: 200% center; }
        }

        .card-icon {
            width: 60px;
            height: 60px;
            margin-bottom: 8px;
        }

        .card-icon img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .card-weight {
            position: absolute;
            bottom: 8px;
            right: 8px;
            font-size: 10px;
            color: #666;
        }

        .card-weight.fresh {
            color: #00ff88;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        button {
            padding: 12px 30px;
            font-size: 16px;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        button:focus-visible {
            outline: 2px solid var(--color-gold);
            outline-offset: 2px;
        }

        .btn-play {
            background: linear-gradient(135deg, #00aa55, #008844);
            color: white;
        }

        .btn-play:hover:not(:disabled) {
            background: linear-gradient(135deg, #00cc66, #00aa55);
            transform: scale(1.05);
        }

        .btn-new-game {
            background: linear-gradient(135deg, #4a9eff, #0066cc);
            color: white;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .btn-new-game:hover {
            background: linear-gradient(135deg, #66b3ff, #4a9eff);
            transform: scale(1.05);
        }

        .btn-new-game.show {
            display: inline-flex;
        }

        .btn-help {
            background: linear-gradient(135deg, #666, #444);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 18px;
            font-weight: bold;
            padding: 0;
        }

        .btn-help:hover {
            background: linear-gradient(135deg, #888, #666);
            transform: scale(1.05);
        }

        /* Battle Log */
        /* Battle Log - Right sidebar */
        .battle-log {
            background: rgba(0,0,0,0.4);
            border-radius: 10px;
            padding: 15px;
            max-height: 700px;
            overflow-y: auto;
        }

        .battle-log h3 {
            color: var(--color-gold);
            margin-bottom: 10px;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .log-entry {
            padding: 8px 12px;
            margin-bottom: 8px;
            border-radius: 5px;
            font-size: 13px;
            line-height: 1.4;
        }

        .log-entry.win {
            background: rgba(0, 255, 136, 0.15);
            border-left: 3px solid #00ff88;
        }

        .log-entry.lose {
            background: rgba(255, 74, 74, 0.15);
            border-left: 3px solid #ff4a4a;
        }

        .log-entry.draw {
            background: var(--bg-gold-light);
            border-left: 3px solid #ffd700;
        }

        .log-entry.info {
            background: rgba(74, 158, 255, 0.15);
            border-left: 3px solid #4a9eff;
        }

        .log-flavor {
            font-style: italic;
            color: var(--color-text-muted);
            margin-top: 5px;
            font-size: 12px;
        }

        .log-entry.clickable {
            cursor: pointer;
            transition: transform 0.15s, box-shadow 0.15s;
        }

        .log-entry.clickable:hover {
            transform: translateX(5px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        /* Battle Detail Modal */
        .battle-detail-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            overflow-y: auto;
        }

        .battle-detail-modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .battle-detail-content {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border: 2px solid var(--color-purple);
            border-radius: 15px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .battle-detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .battle-detail-header h2 {
            color: var(--color-gold);
            font-size: 24px;
        }

        .battle-detail-body {
            color: #ccc;
        }

        .battle-detail-placeholder {
            text-align: center;
            padding: 40px;
            color: var(--color-text-dim);
            font-style: italic;
        }

        .battle-detail-turn {
            text-align: center;
            color: var(--color-text-dim);
            font-size: 14px;
            margin-bottom: 15px;
        }

        .battle-detail-matchup {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .battle-detail-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .battle-detail-card img {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            border: 2px solid var(--color-purple);
        }

        .battle-detail-card span {
            font-size: 12px;
            color: var(--color-text-muted);
        }

        .battle-detail-vs {
            font-size: 24px;
            font-weight: bold;
            color: var(--color-gold);
        }

        .battle-detail-outcome {
            text-align: center;
            font-size: 28px;
            font-weight: bold;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .battle-detail-outcome.win {
            color: #00ff88;
            background: rgba(0, 255, 136, 0.1);
        }

        .battle-detail-outcome.lose {
            color: #ff4a4a;
            background: rgba(255, 74, 74, 0.1);
        }

        .battle-detail-outcome.draw {
            color: var(--color-gold);
            background: var(--bg-gold-subtle);
        }

        .battle-detail-stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
            padding: 15px;
            background: var(--bg-dark);
            border-radius: 8px;
        }

        .battle-detail-stat {
            text-align: center;
        }

        .stat-label {
            display: block;
            font-size: 11px;
            color: var(--color-text-dim);
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: 16px;
            font-weight: bold;
            color: #fff;
        }

        .stat-value.positive {
            color: #00ff88;
        }

        .stat-value.negative {
            color: #ff4a4a;
        }

        .battle-detail-section {
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            border-left: 3px solid #4a4a8a;
        }

        .battle-detail-section h3 {
            color: var(--color-gold);
            font-size: 16px;
            margin-bottom: 10px;
        }

        .battle-detail-section p {
            font-size: 14px;
            line-height: 1.6;
            color: #ccc;
        }

        .battle-reason {
            font-style: italic;
            color: var(--color-text-muted);
            margin-bottom: 10px;
        }

        .battle-story {
            font-style: normal;
            text-align: justify;
        }

        /* Ability Modal Styles */
        .ability-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1100;
            justify-content: center;
            align-items: center;
        }

        .ability-modal.active {
            display: flex;
        }

        .ability-modal-content {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border: 2px solid var(--color-gold);
            border-radius: 15px;
            padding: 25px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .ability-modal-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .ability-modal-header h2 {
            color: var(--color-gold);
            font-size: 22px;
            margin-bottom: 8px;
        }

        .ability-modal-header p {
            color: var(--color-text-muted);
            font-size: 14px;
        }

        .ability-modal-body {
            margin-bottom: 20px;
        }

        .ability-modal-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .ability-modal-option {
            background: var(--bg-dark);
            border: 2px solid var(--color-purple);
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .ability-modal-option:hover {
            border-color: var(--color-gold);
            background: var(--bg-gold-subtle);
        }

        .ability-modal-option.selected {
            border-color: var(--color-gold);
            background: var(--bg-gold-light);
        }

        .ability-option-title {
            color: var(--color-gold);
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 5px;
        }

        .ability-option-desc {
            color: var(--color-text-muted);
            font-size: 13px;
        }

        .ability-modal-cards {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            padding: 15px 0;
        }

        .ability-modal-card {
            background: var(--bg-dark);
            border: 2px solid var(--color-purple);
            border-radius: 10px;
            padding: 12px;
            width: 100px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .ability-modal-card:hover {
            border-color: var(--color-gold);
            transform: translateY(-3px);
        }

        .ability-modal-card.selected {
            border-color: var(--color-gold);
            background: var(--bg-gold-light);
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
        }

        .ability-modal-card img {
            width: 50px;
            height: 50px;
            border-radius: 6px;
            margin-bottom: 8px;
        }

        .ability-modal-card .card-name {
            font-size: 11px;
            color: var(--color-gold);
            font-weight: bold;
        }

        .ability-modal-card.blinded {
            background: repeating-linear-gradient(45deg, #1a1a2e, #1a1a2e 10px, #2a2a4a 10px, #2a2a4a 20px);
        }

        .ability-modal-card.blinded img {
            opacity: 0;
        }

        .ability-modal-card.blinded .card-name {
            color: var(--color-text-dim);
        }

        .ability-modal-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .ability-modal-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .ability-modal-btn.primary {
            background: linear-gradient(135deg, #4a8a4a, #2a5a2a);
            color: white;
        }

        .ability-modal-btn.primary:hover {
            background: linear-gradient(135deg, #5a9a5a, #3a6a3a);
        }

        .ability-modal-btn.primary:disabled {
            background: #333;
            color: #666;
            cursor: not-allowed;
        }

        .ability-modal-btn.secondary {
            background: linear-gradient(135deg, #6a3a3a, #4a2a2a);
            color: white;
        }

        .ability-modal-btn.secondary:hover {
            background: linear-gradient(135deg, #7a4a4a, #5a3a3a);
        }

        .ability-modal-btn.danger {
            background: linear-gradient(135deg, #8a4a4a, #5a2a2a);
            color: white;
        }

        /* Damage/Heal popup animation */
        .effect-popup {
            position: fixed;
            font-size: 28px;
            font-weight: bold;
            pointer-events: none;
            z-index: 1200;
            animation: popupFloat 1.5s ease-out forwards;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }

        .effect-popup.damage {
            color: #ff4a4a;
        }

        .effect-popup.heal {
            color: #00ff88;
        }

        .effect-popup.effect {
            color: var(--color-gold);
        }

        @keyframes popupFloat {
            0% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
            50% {
                opacity: 1;
                transform: translateY(-30px) scale(1.2);
            }
            100% {
                opacity: 0;
                transform: translateY(-60px) scale(0.8);
            }
        }

        /* Blinded hand card style */
        .card.blinded .card-icon,
        .card.blinded .card-name {
            visibility: hidden;
        }

        .card.blinded::after {
            content: '?';
            position: absolute;
            font-size: 48px;
            color: var(--color-text-dim);
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .card.decoy-active {
            border-color: #aa44ff;
            box-shadow: 0 0 15px rgba(170, 68, 255, 0.5);
            pointer-events: none;
        }

        .card.decoy-active::before {
            content: 'DECOY';
            position: absolute;
            top: 5px;
            right: 5px;
            background: #aa44ff;
            color: white;
            font-size: 9px;
            padding: 2px 5px;
            border-radius: 3px;
            font-weight: bold;
        }

        /* Game Over Overlay */
        .game-over-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1200;
        }

        .game-over-overlay.show {
            display: flex;
        }

        .game-over-content {
            text-align: center;
            padding: 40px;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border-radius: 20px;
            border: 3px solid #ffd700;
        }

        .game-over-content h2 {
            font-size: 48px;
            margin-bottom: 20px;
        }

        .game-over-content.victory h2 {
            color: #00ff88;
        }

        .game-over-content.defeat h2 {
            color: #ff4a4a;
        }

        .game-over-content p {
            font-size: 18px;
            margin-bottom: 30px;
            color: var(--color-text-muted);
        }

        .game-over-hint {
            font-size: 14px;
            color: #666;
            margin-top: 20px;
            font-style: italic;
        }

        /* Opponent hand (face down) */
        .opponent-hand {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .card-back {
            width: 80px;
            height: 100px;
            background: linear-gradient(135deg, #3d3d6b, #2a2a4a);
            border: 2px solid #555;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
        }

        /* Player indicator */
        .player-indicator {
            text-align: center;
            padding: 8px 20px;
            margin-bottom: 15px;
            border-radius: 20px;
            font-weight: bold;
            display: inline-block;
        }

        .player-indicator.player1 {
            background: rgba(74, 158, 255, 0.3);
            border: 2px solid #4a9eff;
            color: #4a9eff;
        }

        .player-indicator.player2 {
            background: rgba(255, 74, 74, 0.3);
            border: 2px solid #ff4a4a;
            color: #ff4a4a;
        }

        .player-indicator-container {
            text-align: center;
        }

        /* Room Code Input */
        .room-code-section {
            display: none;
            text-align: center;
            margin-bottom: 15px;
        }

        .room-code-section.show {
            display: block;
        }

        .room-code-label {
            margin-bottom: 8px;
            color: var(--color-text-muted);
            font-size: 14px;
        }

        .room-code-input {
            width: 120px;
            padding: 12px;
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            letter-spacing: 8px;
            background: rgba(0,0,0,0.4);
            border: 2px solid var(--color-purple);
            border-radius: 8px;
            color: var(--color-gold);
            outline: none;
        }

        .room-code-input:focus {
            border-color: var(--color-gold);
        }

        .room-code-input::placeholder {
            color: #555;
            letter-spacing: 4px;
        }

        .btn-join {
            margin-left: 10px;
            padding: 12px 20px;
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .btn-join:hover {
            background: linear-gradient(135deg, #a66bbe, #9b59b6);
            transform: scale(1.05);
        }

        .btn-join:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .room-code-display {
            margin-top: 10px;
            font-size: 12px;
            color: var(--color-text-dim);
        }

        /* Match Type Selector */
        .match-type-selector {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .match-type-btn {
            padding: 10px 20px;
            background: var(--bg-dark);
            color: var(--color-text-muted);
            border: 2px solid var(--color-purple);
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition-fast);
            font-weight: bold;
        }

        .match-type-btn:hover {
            background: rgba(155, 89, 182, 0.2);
        }

        .match-type-btn.active {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            color: white;
            border-color: #9b59b6;
        }

        .public-match-ui {
            text-align: center;
        }

        .btn-find-match {
            padding: 15px 40px;
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .btn-find-match:hover {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            transform: scale(1.05);
        }

        .btn-find-match:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-leave-match {
            padding: 10px 20px;
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: var(--transition-fast);
            margin-top: 10px;
        }

        .btn-leave-match:hover {
            background: linear-gradient(135deg, #c0392b, #e74c3c);
            transform: scale(1.05);
        }

        .matchmaking-status {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            margin-top: 15px;
        }

        .matchmaking-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--bg-dark);
            border-top: 4px solid var(--color-gold);
            border-right: 4px solid var(--color-triumph);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.3), 0 0 30px rgba(170, 68, 255, 0.2);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #matchmaking-text {
            color: var(--color-gold);
            font-size: 16px;
        }

        .btn-cancel-match {
            padding: 8px 20px;
            background: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
            border: 1px solid #e74c3c;
            border-radius: 6px;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .btn-cancel-match:hover {
            background: rgba(231, 76, 60, 0.4);
        }

        /* Welcome Screen */
        .welcome-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 40px 20px;
            text-align: center;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            z-index: 600;
        }

        .welcome-screen.hidden {
            display: none;
        }

        .welcome-content {
            background: var(--bg-darkest);
            border: 2px solid var(--color-purple);
            border-radius: 20px;
            padding: 50px 60px;
            max-width: 450px;
        }

        .welcome-screen h1 {
            font-size: 32px;
            color: var(--color-gold);
            text-shadow: 2px 2px 8px rgba(0,0,0,0.8);
            margin-bottom: 8px;
        }

        .welcome-subtitle {
            font-size: 14px;
            color: var(--color-text-dim);
            margin-bottom: 40px;
        }

        .welcome-choice p,
        .welcome-new-player p,
        .welcome-returning p,
        .welcome-back p {
            color: #ccc;
            font-size: 16px;
            margin-bottom: 20px;
        }

        .welcome-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
        }

        .welcome-btn {
            padding: 14px 28px;
            font-size: 16px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: var(--transition-fast);
            font-weight: bold;
        }

        .welcome-btn.new-player {
            background: linear-gradient(135deg, #4a8a4a, #2d5a2d);
            color: white;
        }

        .welcome-btn.new-player:hover {
            background: linear-gradient(135deg, #5a9a5a, #3d6a3d);
            transform: translateY(-2px);
        }

        .welcome-btn.returning-player {
            background: linear-gradient(135deg, #4a4a8a, #2d2d5a);
            color: white;
        }

        .welcome-btn.returning-player:hover {
            background: linear-gradient(135deg, #5a5a9a, #3d3d6a);
            transform: translateY(-2px);
        }

        .welcome-btn.confirm {
            background: linear-gradient(135deg, #8a7a4a, #5a4a2d);
            color: white;
            padding: 12px 40px;
        }

        .welcome-btn.confirm:hover:not(:disabled) {
            background: linear-gradient(135deg, #9a8a5a, #6a5a3d);
            transform: translateY(-2px);
        }

        .welcome-btn.confirm:disabled {
            background: rgba(80, 80, 80, 0.5);
            color: #666;
            cursor: not-allowed;
        }

        .welcome-btn.back {
            background: rgba(100, 100, 100, 0.5);
            color: #ccc;
            padding: 12px 24px;
        }

        .welcome-btn.back:hover {
            background: rgba(120, 120, 120, 0.5);
        }

        .player-code-display {
            font-size: 48px;
            font-weight: bold;
            color: var(--color-gold);
            letter-spacing: 12px;
            margin: 20px 0;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
            font-family: 'Courier New', monospace;
        }

        .player-code-display.loading {
            animation: code-pulse 1s ease-in-out infinite;
            color: var(--color-text-dim);
        }

        @keyframes code-pulse {
            0%, 100% { opacity: 0.4; }
            50% { opacity: 1; }
        }

        .welcome-new-player .code-note {
            font-size: 12px;
            color: var(--color-text-dim);
            margin-bottom: 25px;
        }

        .code-input-container {
            margin: 20px 0;
        }

        .code-input-container input {
            font-size: 36px;
            font-weight: bold;
            text-align: center;
            letter-spacing: 10px;
            width: 180px;
            padding: 12px;
            border: 2px solid var(--color-purple);
            border-radius: 10px;
            background: var(--bg-darker);
            color: var(--color-gold);
            font-family: 'Courier New', monospace;
        }

        .code-input-container input:focus {
            outline: 2px solid var(--color-gold);
            outline-offset: 2px;
            border-color: var(--color-gold);
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
        }

        .code-input-container input::placeholder {
            color: #444;
        }

        .returning-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        .welcome-returning .code-error {
            color: #ff6b6b;
            font-size: 12px;
            margin-top: 15px;
        }

        .code-error.hidden {
            display: none;
        }

        .different-code {
            font-size: 12px;
            color: #666;
            margin-top: 20px;
            cursor: pointer;
            text-decoration: underline;
        }

        .different-code:hover {
            color: var(--color-text-dim);
        }

        .no-code-link {
            font-size: 12px;
            color: #666;
            margin-top: 20px;
            cursor: pointer;
            text-decoration: underline;
        }

        .no-code-link:hover {
            color: var(--color-text-dim);
        }

        .welcome-choice.hidden,
        .welcome-new-player.hidden,
        .welcome-returning.hidden,
        .welcome-back.hidden {
            display: none;
        }

        /* Intro Screen */
        .intro-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            padding: 60px 20px 40px 20px;
            overflow-y: auto;
            text-align: center;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            z-index: 500;
        }

        .intro-screen.hidden {
            display: none;
        }

        .intro-screen h1 {
            font-size: 48px;
            color: var(--color-gold);
            text-shadow: 2px 2px 8px rgba(0,0,0,0.8);
            margin-bottom: 10px;
        }

        .intro-screen .subtitle {
            font-size: 18px;
            color: var(--color-text-muted);
            margin-bottom: 40px;
        }

        .intro-box {
            background: rgba(0,0,0,0.4);
            border: 2px solid var(--color-purple);
            border-radius: 16px;
            padding: 30px 40px;
            max-width: 600px;
            margin-bottom: 30px;
        }

        .intro-box h2 {
            color: var(--color-gold);
            margin-bottom: 15px;
            font-size: 22px;
        }

        .intro-box p {
            color: #ccc;
            line-height: 1.6;
            margin-bottom: 15px;
            font-size: 15px;
        }

        .intro-box ul {
            text-align: left;
            color: #ccc;
            line-height: 1.8;
            padding-left: 20px;
            font-size: 14px;
        }

        .intro-box li {
            margin-bottom: 8px;
        }

        .intro-box li strong {
            color: var(--color-gold);
        }

        .intro-screen.overlay-mode {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(10, 10, 20, 0.95);
            z-index: 200;
            overflow-y: auto;
        }

        .intro-close-btn {
            position: absolute;
            top: 20px;
            right: 80px;
            background: var(--bg-darkest);
            border: 2px solid #666;
            color: var(--color-text-muted);
            width: 44px;
            height: 44px;
            border-radius: 50%;
            font-size: 28px;
            cursor: pointer;
            transition: var(--transition-medium);
            display: none;
            justify-content: center;
            align-items: center;
            line-height: 1;
        }

        .intro-close-btn:hover {
            border-color: var(--color-gold);
            color: var(--color-gold);
        }

        .overlay-mode .intro-close-btn {
            display: flex;
        }

        .overlay-mode .btn-play {
            display: none;
        }

        .btn-play {
            padding: 18px 60px;
            font-size: 22px;
            font-weight: bold;
            background: linear-gradient(135deg, #ffd700, #ff8c00);
            color: #1a1a2e;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: var(--transition-medium);
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .btn-play:hover {
            transform: scale(1.05);
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.5);
        }

        .game-container.hidden {
            display: none;
        }

        /* Pathway Reference Panel */
        .pathway-reference {
            background: rgba(0,0,0,0.3);
            border: 2px solid var(--color-purple);
            border-radius: 10px;
            padding: 12px;
            margin-top: 15px;
            max-height: 350px;
            overflow-y: auto;
        }

        .pathway-reference h3 {
            color: var(--color-gold);
            font-size: 14px;
            margin-bottom: 10px;
            text-align: center;
        }

        .pathway-grid {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 6px;
            justify-content: center;
            padding: 0 4px;
        }

        .pathway-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 6px;
            border-radius: 6px;
            background: rgba(0,0,0,0.2);
            min-height: 44px;
            min-width: 0;
            box-sizing: border-box;
            cursor: pointer;
        }

        .pathway-item:hover {
            background: var(--bg-gold-subtle);
        }

        .pathway-item img {
            width: 24px;
            height: 24px;
            object-fit: contain;
        }

        .pathway-item span {
            font-size: 10px;
            color: #ccc;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .pathway-item.big-hit {
            border: 2px solid transparent;
            background:
                linear-gradient(rgba(0,0,0,0.4), rgba(0,0,0,0.4)) padding-box,
                linear-gradient(90deg, #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #4b0082, #9400d3, #ff0000) border-box;
            background-size: 100% 100%, 200% auto;
            animation: rainbow-border-shift 3s linear infinite;
        }

        @keyframes rainbow-border-shift {
            0% { background-position: 0% 0%, 0% center; }
            100% { background-position: 0% 0%, 200% center; }
        }

        .pathway-item.big-hit span {
            background: linear-gradient(90deg, #ff4444, #ffaa44, #ffff66, #66ff66, #66aaff, #aa66ff, #ff66aa, #ff4444);
            background-size: 200% auto;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: rainbow-shift 3s linear infinite;
            font-size: 10px;
            font-weight: bold;
        }

        /* Scrollbar styling for pathway reference */
        .pathway-reference::-webkit-scrollbar {
            width: 6px;
        }

        .pathway-reference::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.2);
            border-radius: 3px;
        }

        .pathway-reference::-webkit-scrollbar-thumb {
            background: #4a4a8a;
            border-radius: 3px;
        }

        /* Pathway Detail View */
        .pathway-detail {
            display: none;
        }

        .pathway-detail.active {
            display: block;
            max-height: 500px;
            overflow-y: auto;
        }

        .pathway-grid.hidden {
            display: none;
        }

        .pathway-reference h3.hidden {
            display: none;
        }

        /* Inner God Summon Area */
        .inner-god-summon-area {
            display: none;
            margin-bottom: 12px;
            padding: 8px;
            border-radius: 8px;
            background: linear-gradient(135deg, rgba(75, 0, 130, 0.3), rgba(138, 43, 226, 0.3));
            border: 2px solid transparent;
            background-clip: padding-box;
        }

        .inner-god-summon-area.has-gods {
            display: block;
            border: 2px solid;
            border-image: linear-gradient(90deg, #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #4b0082, #9400d3, #ff0000) 1;
            animation: inner-god-glow 2s ease-in-out infinite;
        }

        @keyframes inner-god-glow {
            0%, 100% { box-shadow: 0 0 10px rgba(138, 43, 226, 0.5); }
            50% { box-shadow: 0 0 20px rgba(138, 43, 226, 0.8), 0 0 30px rgba(75, 0, 130, 0.5); }
        }

        .inner-god-summon-title {
            font-size: 11px;
            color: #daa520;
            text-align: center;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-shadow: 0 0 10px rgba(218, 165, 32, 0.5);
        }

        .inner-god-summon-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .inner-god-summon-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 12px;
            border-radius: 6px;
            background: rgba(0, 0, 0, 0.4);
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(218, 165, 32, 0.3);
            min-height: 48px;
        }

        .inner-god-summon-item:hover {
            background: rgba(218, 165, 32, 0.2);
            border-color: #daa520;
            transform: scale(1.02);
        }

        .inner-god-summon-item img {
            width: 28px;
            height: 28px;
            object-fit: contain;
            border-radius: 4px;
        }

        .inner-god-summon-item .god-info {
            flex: 1;
        }

        .inner-god-summon-item .god-name {
            font-size: 11px;
            font-weight: bold;
            background: linear-gradient(90deg, #ff4444, #ffaa44, #ffff66, #66ff66, #66aaff, #aa66ff, #ff66aa, #ff4444);
            background-size: 200% auto;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: rainbow-shift 3s linear infinite;
        }

        .inner-god-summon-item .god-hint {
            font-size: 9px;
            color: #999;
        }

        .inner-god-summon-item .summon-btn {
            padding: 8px 12px;
            font-size: 11px;
            background: linear-gradient(135deg, #4b0082, #8a2be2);
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            text-transform: uppercase;
            font-weight: bold;
            min-height: 36px;
        }

        .inner-god-summon-item .summon-btn:hover {
            background: linear-gradient(135deg, #6b238e, #9932cc);
        }

        .pathway-detail-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .btn-back {
            background: none;
            border: 1px solid #666;
            color: var(--color-text-muted);
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
        }

        .btn-back:hover {
            border-color: var(--color-gold);
            color: var(--color-gold);
        }

        .pathway-detail-icon {
            width: 50px;
            height: 50px;
            object-fit: contain;
        }

        .pathway-detail-name {
            color: var(--color-gold);
            font-size: 16px;
            font-weight: bold;
        }

        .pathway-detail-flavor {
            color: var(--color-text-muted);
            font-style: italic;
            font-size: 11px;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #4a4a8a;
        }

        .pathway-detail-section {
            margin-bottom: 10px;
        }

        .pathway-detail-section h4 {
            color: var(--color-gold);
            font-size: 11px;
            margin-bottom: 4px;
        }

        .pathway-detail-section p {
            color: #ccc;
            font-size: 10px;
            line-height: 1.5;
        }

        .abilities-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .abilities-list li {
            color: #ccc;
            font-size: 10px;
            line-height: 1.4;
            margin-bottom: 8px;
            padding-left: 12px;
            position: relative;
        }

        .abilities-list li::before {
            content: '';
            position: absolute;
            left: 0;
            color: var(--color-gold);
            font-size: 8px;
        }

        .abilities-list .ability-name {
            color: var(--color-gold);
            font-weight: bold;
        }

        /* ===== ABILITY PHASE UI ===== */
        .ability-phase-section {
            display: none;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border: 2px solid var(--color-purple);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .ability-phase-section.active {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .ability-phase-header {
            text-align: center;
            margin-bottom: 12px;
        }

        .ability-phase-header h3 {
            color: var(--color-gold);
            font-size: 16px;
            margin: 0 0 4px 0;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .ability-phase-header p {
            color: var(--color-text-dim);
            font-size: 11px;
            margin: 0;
        }

        .ability-cards-container {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .ability-card-column {
            flex: 1;
            min-width: 180px;
            max-width: 220px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--color-purple);
            border-radius: 8px;
            padding: 10px;
        }

        .ability-card-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--color-purple);
        }

        .ability-card-header img {
            width: 24px;
            height: 24px;
        }

        .ability-card-header .card-name {
            color: var(--color-gold);
            font-size: 12px;
            font-weight: bold;
        }

        .ability-list-container {
            max-height: 200px;
            overflow-y: auto;
        }

        .ability-list-container::-webkit-scrollbar {
            width: 4px;
        }

        .ability-list-container::-webkit-scrollbar-thumb {
            background: var(--color-purple);
            border-radius: 2px;
        }

        .ability-btn {
            display: block;
            width: 100%;
            padding: 6px 8px;
            margin-bottom: 4px;
            background: linear-gradient(135deg, #2a2a4a, #1a1a3a);
            border: 1px solid transparent;
            border-radius: 4px;
            color: var(--color-text);
            font-size: 10px;
            text-align: left;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .ability-btn:hover {
            background: linear-gradient(135deg, #3a3a5a, #2a2a4a);
            border-color: var(--color-gold);
        }

        .ability-btn.selected {
            background: linear-gradient(135deg, #4a3a1a, #3a2a0a);
            border-color: var(--color-gold);
            box-shadow: 0 0 8px rgba(255, 215, 0, 0.3);
        }

        .ability-btn .ability-name {
            color: var(--color-gold);
            font-weight: bold;
            display: block;
            margin-bottom: 2px;
        }

        .ability-btn .ability-desc {
            color: var(--color-text-dim);
            font-size: 9px;
            line-height: 1.3;
            display: block;
        }

        .ability-phase-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 12px;
        }

        .btn-use-ability {
            padding: 10px 24px;
            background: linear-gradient(135deg, #4a8a4a, #2a5a2a);
            border: 2px solid #6aba6a;
            border-radius: 8px;
            color: white;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-use-ability:hover:not(:disabled) {
            background: linear-gradient(135deg, #5a9a5a, #3a6a3a);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(106, 186, 106, 0.4);
        }

        .btn-use-ability:disabled {
            background: linear-gradient(135deg, #3a3a3a, #2a2a2a);
            border-color: #555;
            color: #777;
            cursor: not-allowed;
        }

        .btn-skip-ability {
            padding: 10px 24px;
            background: linear-gradient(135deg, #4a4a4a, #2a2a2a);
            border: 2px solid #666;
            border-radius: 8px;
            color: var(--color-text-muted);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-skip-ability:hover {
            background: linear-gradient(135deg, #5a5a5a, #3a3a3a);
            border-color: #888;
        }

        .ability-used-indicator {
            display: none;
            text-align: center;
            padding: 10px;
            background: linear-gradient(135deg, #2a4a2a, #1a3a1a);
            border: 1px solid #4a8a4a;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .ability-used-indicator.show {
            display: block;
        }

        .ability-used-indicator .ability-used-text {
            color: #8aba8a;
            font-size: 12px;
        }

        .ability-used-indicator .ability-used-name {
            color: var(--color-gold);
            font-weight: bold;
        }

        /* View All Button */
        .btn-view-all {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #4a4a8a, #2d2d5a);
            border: 1px solid #6a6aaa;
            border-radius: 6px;
            color: var(--color-gold);
            font-size: 12px;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .btn-view-all:hover {
            background: linear-gradient(135deg, #5a5a9a, #3d3d6a);
            border-color: var(--color-gold);
        }

        /* Summon Guide Button */
        .btn-summon-guide {
            display: none;
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #4a2a6a, #2d1a4a);
            border: 1px solid #9a6aca;
            border-radius: 6px;
            color: #e0b0ff;
            font-size: 12px;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .btn-summon-guide:hover {
            background: linear-gradient(135deg, #5a3a7a, #3d2a5a);
            border-color: #e0b0ff;
            box-shadow: 0 0 10px rgba(224, 176, 255, 0.3);
        }

        .btn-summon-guide.visible {
            display: block;
        }

        /* Inner God Summon Section in Modal */
        .inner-god-summon-section {
            display: none;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, rgba(74, 42, 106, 0.3), rgba(45, 26, 74, 0.3));
            border: 1px solid #9a6aca;
            border-radius: 12px;
        }

        .inner-god-summon-section.visible {
            display: block;
        }

        .summon-section-title {
            color: #e0b0ff;
            font-size: 22px;
            margin-bottom: 8px;
            text-align: center;
        }

        .summon-section-desc {
            color: #aaa;
            font-size: 13px;
            text-align: center;
            margin-bottom: 20px;
        }

        .inner-god-summon-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
        }

        .summon-card {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: rgba(20, 20, 40, 0.6);
            border: 1px solid rgba(154, 106, 202, 0.4);
            border-radius: 8px;
            transition: var(--transition-fast);
        }

        .summon-card:hover {
            border-color: #e0b0ff;
            background: rgba(30, 30, 50, 0.8);
        }

        .summon-card-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #9a6aca;
            flex-shrink: 0;
        }

        .summon-card-info {
            flex: 1;
        }

        .summon-card-name {
            color: #e0b0ff;
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 6px;
        }

        .summon-card-pathways {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }

        .summon-pathway-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            object-fit: cover;
            border: 1px solid rgba(154, 106, 202, 0.6);
            transition: var(--transition-fast);
        }

        .summon-pathway-icon:hover {
            border-color: var(--color-gold);
            transform: scale(1.1);
        }

        /* Pathway Table Modal */
        .pathway-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 1000;
            overflow-y: auto;
        }

        .pathway-modal.active {
            display: block;
        }

        .pathway-modal-content {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
        }

        .pathway-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .pathway-modal-header h2 {
            color: var(--color-gold);
            font-size: 28px;
        }

        .btn-close-modal {
            background: none;
            border: 2px solid #ff4a4a;
            color: #ff4a4a;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: var(--transition-fast);
        }

        .btn-close-modal:hover {
            background: #ff4a4a;
            color: #000;
        }

        /* Pathway Table */
        .pathway-table {
            width: 100%;
            border-collapse: collapse;
        }

        .pathway-table th,
        .pathway-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #4a4a8a;
        }

        .pathway-table th {
            background: var(--bg-gold-subtle);
            color: var(--color-gold);
            font-size: 14px;
            position: sticky;
            top: 0;
        }

        .pathway-table tr:hover {
            background: rgba(255, 215, 0, 0.05);
        }

        .pathway-table td {
            color: #ccc;
            font-size: 12px;
            vertical-align: top;
        }

        .pathway-table .pathway-icon-cell {
            width: 50px;
        }

        .pathway-table .pathway-icon-cell img {
            width: 40px;
            height: 40px;
            object-fit: contain;
        }

        .pathway-table .pathway-name-cell {
            color: var(--color-gold);
            font-weight: bold;
            font-size: 14px;
            white-space: nowrap;
        }

        .pathway-table .pathway-flavor-cell {
            font-style: italic;
            color: var(--color-text-muted);
        }

        .pathway-table .pathway-desc-cell {
            max-width: 300px;
            line-height: 1.4;
        }

        .pathway-table .pathway-abilities-cell {
            max-width: 350px;
            line-height: 1.5;
        }

        .pathway-table .ability-item {
            margin-bottom: 6px;
        }

        .pathway-table .ability-item strong {
            color: var(--color-gold);
        }

        /* Leaderboard Modal Styles */
        .leaderboard-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 1000;
            overflow-y: auto;
        }

        .leaderboard-modal.active {
            display: block;
        }

        .leaderboard-modal-content {
            max-width: 700px;
            margin: 20px auto;
            padding: 20px;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border: 2px solid #4a4a8a;
            border-radius: 16px;
        }

        .leaderboard-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .leaderboard-modal-header h2 {
            color: var(--color-gold);
            font-size: 24px;
            margin: 0;
        }

        .leaderboard-tabs {
            display: flex;
            gap: 5px;
            padding: 4px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .leaderboard-tab {
            flex: 1;
            padding: 10px 12px;
            font-size: 12px;
            font-weight: bold;
            border: 2px solid #333;
            border-radius: 6px;
            cursor: pointer;
            background: rgba(0, 0, 0, 0.3);
            color: var(--color-text-dim);
            transition: var(--transition-fast);
            text-align: center;
            min-width: 80px;
        }

        .leaderboard-tab:hover {
            border-color: #555;
            color: var(--color-text);
        }

        .leaderboard-tab.active {
            border-color: var(--color-gold);
            color: var(--color-gold);
            background: var(--bg-gold-subtle);
        }

        .leaderboard-sub-tabs {
            display: none;
            gap: 5px;
            padding: 4px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 6px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .leaderboard-sub-tabs.show {
            display: flex;
        }

        .leaderboard-sub-tab {
            padding: 8px 14px;
            font-size: 11px;
            font-weight: bold;
            border: 1px solid #444;
            border-radius: 4px;
            cursor: pointer;
            background: rgba(0, 0, 0, 0.2);
            color: var(--color-text-dim);
            transition: var(--transition-fast);
        }

        .leaderboard-sub-tab:hover {
            border-color: #666;
            color: var(--color-text);
        }

        .leaderboard-sub-tab.active {
            border-color: #aa44ff;
            color: #cc88ff;
            background: rgba(170, 68, 255, 0.15);
        }

        .leaderboard-table-container {
            max-height: 400px;
            overflow-y: auto;
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.2);
        }

        .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
        }

        .leaderboard-table th,
        .leaderboard-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #3a3a5a;
        }

        .leaderboard-table th {
            background: rgba(0, 0, 0, 0.4);
            color: var(--color-gold);
            font-size: 12px;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .leaderboard-table td {
            color: #ccc;
            font-size: 13px;
        }

        .leaderboard-table tr:hover {
            background: rgba(255, 215, 0, 0.05);
        }

        .leaderboard-table .rank-1 td:first-child {
            color: #ffd700;
            font-weight: bold;
        }

        .leaderboard-table .rank-2 td:first-child {
            color: #c0c0c0;
            font-weight: bold;
        }

        .leaderboard-table .rank-3 td:first-child {
            color: #cd7f32;
            font-weight: bold;
        }

        .leaderboard-modal .leaderboard-table .current-player {
            background: var(--bg-gold-subtle);
        }

        .leaderboard-modal .leaderboard-table .current-player td {
            color: var(--color-gold);
            font-weight: bold;
        }

        .leaderboard-modal .leaderboard-player-name {
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .leaderboard-modal .leaderboard-player-name:hover {
            color: var(--color-gold);
            text-decoration: underline;
        }

        .leaderboard-loading,
        .leaderboard-empty {
            display: none;
            text-align: center;
            padding: 40px;
            color: var(--color-text-dim);
            font-style: italic;
        }

        .leaderboard-loading.show,
        .leaderboard-empty.show {
            display: block;
        }

        button.btn-leaderboard {
            background: linear-gradient(135deg, #5a4a2a, #3a3a1a);
            border: 1px solid var(--color-gold);
        }

        button.btn-leaderboard:hover {
            background: linear-gradient(135deg, #6a5a3a, #4a4a2a);
        }

        .btn-leaderboard-main {
            width: 100%;
            padding: 12px 20px;
            margin-bottom: 15px;
            background: linear-gradient(135deg, #5a4a2a, #3a3a1a);
            border: 2px solid var(--color-gold);
            border-radius: 8px;
            color: var(--color-gold);
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .btn-leaderboard-main:hover {
            background: linear-gradient(135deg, #6a5a3a, #4a4a2a);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 215, 0, 0.2);
        }

        @media (max-width: 600px) {
            .leaderboard-modal-content {
                margin: 10px;
                padding: 15px;
            }

            .leaderboard-tab {
                padding: 8px 10px;
                font-size: 10px;
                min-width: 60px;
            }

            .leaderboard-table th,
            .leaderboard-table td {
                padding: 8px 10px;
                font-size: 11px;
            }

            .leaderboard-table-container {
                max-height: 300px;
            }
        }

        /* Player Profile Modal Styles */
        .profile-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 1000;
            overflow-y: auto;
        }

        .profile-modal.active {
            display: block;
        }

        .profile-modal-content {
            max-width: 600px;
            margin: 20px auto;
            padding: 20px;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border: 2px solid #4a4a8a;
            border-radius: 16px;
        }

        .profile-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .profile-modal-header h2 {
            color: var(--color-gold);
            font-size: 22px;
            margin: 0;
        }

        .profile-search {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
        }

        .profile-search input {
            flex: 1;
            padding: 10px 15px;
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid #4a4a8a;
            border-radius: 6px;
            color: #fff;
            font-size: 14px;
        }

        .profile-search input:focus {
            outline: none;
            border-color: var(--color-gold);
        }

        .btn-profile-search {
            padding: 10px 20px;
            background: linear-gradient(135deg, #4a4a8a, #2d2d5a);
            border: 1px solid #6a6aaa;
            border-radius: 6px;
            color: var(--color-gold);
            font-weight: bold;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .btn-profile-search:hover {
            background: linear-gradient(135deg, #5a5a9a, #3d3d6a);
            border-color: var(--color-gold);
        }

        .profile-content {
            display: none;
        }

        .profile-content.show {
            display: block;
        }

        .profile-header {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .profile-avatar {
            width: 70px;
            height: 70px;
            background: linear-gradient(135deg, #4a4a8a, #2d2d5a);
            border: 3px solid var(--color-gold);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            color: var(--color-gold);
        }

        .profile-info {
            flex: 1;
        }

        .profile-name {
            font-size: 20px;
            font-weight: bold;
            color: #fff;
            margin-bottom: 4px;
        }

        .profile-title-container {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }

        .profile-title {
            font-size: 13px;
            color: #aa44ff;
            font-style: italic;
        }

        .profile-title:empty {
            display: none;
        }

        .btn-change-title {
            padding: 2px 8px;
            font-size: 10px;
            background: rgba(170, 68, 255, 0.2);
            border: 1px solid #aa44ff;
            border-radius: 4px;
            color: #aa44ff;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .btn-change-title:hover {
            background: rgba(170, 68, 255, 0.4);
        }

        .title-selector {
            margin-bottom: 15px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            border: 1px solid #4a4a8a;
        }

        .title-selector h4 {
            color: var(--color-gold);
            font-size: 14px;
            margin: 0 0 10px 0;
        }

        .title-selector-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
            max-height: 200px;
            overflow-y: auto;
        }

        .title-selector-item {
            padding: 10px 12px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid #3a3a5a;
            border-radius: 6px;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .title-selector-item:hover {
            background: rgba(170, 68, 255, 0.2);
            border-color: #aa44ff;
        }

        .title-selector-item.selected {
            background: rgba(255, 215, 0, 0.15);
            border-color: var(--color-gold);
        }

        .title-selector-item .title-name {
            font-size: 13px;
            font-weight: bold;
        }

        .title-selector-item .title-source {
            font-size: 10px;
            color: var(--color-text-dim);
            margin-top: 2px;
        }

        .profile-code {
            font-size: 12px;
            color: var(--color-text-dim);
        }

        .profile-badge {
            font-size: 32px;
        }

        .profile-section {
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            border-left: 3px solid #4a4a8a;
        }

        .profile-section h3 {
            color: var(--color-gold);
            font-size: 14px;
            margin: 0 0 12px 0;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .profile-stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        .profile-stat {
            text-align: center;
            padding: 12px 8px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
        }

        .profile-stat .stat-value {
            display: block;
            font-size: 22px;
            font-weight: bold;
            color: var(--color-gold);
            margin-bottom: 4px;
        }

        .profile-stat .stat-label {
            display: block;
            font-size: 10px;
            color: var(--color-text-dim);
            text-transform: uppercase;
        }

        .profile-mode-stats {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .profile-mode-stat {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 6px;
        }

        .profile-mode-stat .mode-name {
            color: #ccc;
            font-size: 13px;
        }

        .profile-mode-stat .mode-stats {
            color: var(--color-gold);
            font-size: 13px;
            font-weight: bold;
        }

        .profile-titles {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .profile-title-badge {
            padding: 8px 14px;
            background: var(--bg-triumph-subtle);
            border: 1px solid #aa44ff;
            border-radius: 20px;
            color: #cc88ff;
            font-size: 12px;
            font-weight: bold;
        }

        .profile-title-badge.active {
            background: var(--bg-triumph-light);
            border-color: var(--color-gold);
        }

        /* Title effects override default colors */
        .profile-title-badge.title-text {
            -webkit-text-fill-color: inherit;
        }

        .profile-achievements-summary {
            text-align: center;
            margin-bottom: 12px;
            color: var(--color-text-dim);
            font-size: 13px;
        }

        .profile-achievements-summary span {
            color: var(--color-gold);
            font-weight: bold;
        }

        .profile-achievements {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
        }

        .profile-ach-icon {
            width: 36px;
            height: 36px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid #4a4a8a;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            cursor: help;
            transition: var(--transition-fast);
        }

        .profile-ach-icon:hover {
            border-color: var(--color-gold);
            transform: scale(1.1);
        }

        .profile-ach-icon.locked {
            opacity: 0.3;
            filter: grayscale(1);
        }

        .profile-empty {
            color: var(--color-text-dim);
            font-style: italic;
            text-align: center;
            padding: 10px;
        }

        .profile-loading,
        .profile-error {
            display: none;
            text-align: center;
            padding: 40px;
            color: var(--color-text-dim);
            font-style: italic;
        }

        .profile-loading.show,
        .profile-error.show {
            display: block;
        }

        .profile-error {
            color: #ff6b6b;
        }

        .profile-footer {
            display: none;
            margin-top: 20px;
            text-align: center;
        }

        .profile-footer.show {
            display: block;
        }

        .btn-view-own {
            padding: 10px 25px;
            background: linear-gradient(135deg, #4a4a8a, #2d2d5a);
            border: 1px solid #6a6aaa;
            border-radius: 6px;
            color: var(--color-gold);
            font-weight: bold;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .btn-view-own:hover {
            background: linear-gradient(135deg, #5a5a9a, #3d3d6a);
            border-color: var(--color-gold);
        }

        .btn-profile-main {
            width: 100%;
            padding: 12px 20px;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #4a3a6a, #2d2d4a);
            border: 2px solid #aa44ff;
            border-radius: 8px;
            color: #cc88ff;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .btn-profile-main:hover {
            background: linear-gradient(135deg, #5a4a7a, #3d3d5a);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(170, 68, 255, 0.2);
        }

        @media (max-width: 600px) {
            .profile-modal-content {
                margin: 10px;
                padding: 15px;
            }

            .profile-stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .profile-header {
                flex-direction: column;
                text-align: center;
            }

            .profile-avatar {
                width: 60px;
                height: 60px;
                font-size: 24px;
            }

            .profile-search {
                flex-direction: column;
            }
        }

        .btn-discord {
            display: block;
            background: #5865F2;
            color: white;
            text-align: center;
            text-decoration: none;
            padding: 10px;
            border-radius: 6px;
            font-weight: bold;
            margin-bottom: 20px;
            transition: background 0.2s;
        }

        .btn-discord:hover {
            background: #4752C4;
            color: white;
        }

        .feedback-divider {
            text-align: center;
            border-bottom: 1px solid #333;
            line-height: 0.1em;
            margin: 20px 0;
            color: #666;
            font-size: 12px;
            text-transform: uppercase;
        }

        .feedback-divider span {
            background: #1a1a2e;
            padding: 0 10px;
        }
        /* Feedback Modal Styles */
        .feedback-btn-container {
            margin-top: 15px;
            margin-bottom: 15px;
            text-align: center;
        }

        .btn-feedback {
            background: rgba(255, 255, 255, 0.1);
            border: 1px dashed #666;
            color: #aaa;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
            width: 100%;
        }

        .btn-feedback:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: #999;
            color: #fff;
        }

        .feedback-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .feedback-modal.active {
            display: flex;
        }

        .feedback-content {
            background: #1a1a2e;
            border: 2px solid #444;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            padding: 25px;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.8);
            position: relative;
        }

        .feedback-header h2 {
            color: #ffd700;
            margin-bottom: 15px;
            border-bottom: 1px solid #333;
            padding-bottom: 10px;
        }

        .feedback-form-group {
            margin-bottom: 15px;
        }

        .feedback-form-group label {
            display: block;
            margin-bottom: 5px;
            color: #ccc;
            font-weight: bold;
            font-size: 14px;
        }

        .feedback-input, .feedback-select, .feedback-textarea {
            width: 100%;
            padding: 10px;
            background: #111;
            border: 1px solid #444;
            border-radius: 6px;
            color: #eee;
            font-family: inherit;
        }

        .feedback-textarea {
            min-height: 120px;
            resize: vertical;
        }

        .honey-trap {
            opacity: 0;
            position: absolute;
            top: 0;
            left: 0;
            height: 0;
            width: 0;
            z-index: -1;
        }

        /* ============================================
           RESPONSIVE STYLES
           ============================================ */

        /* Touch-friendly defaults */
        .card, .played-card, button {
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        /* ============================================
           TABLET BREAKPOINT (max-width: 1024px)
           ============================================ */
        @media (max-width: 1024px) {
            .left-sidebar,
            .right-sidebar {
                width: 280px;
            }

            .main-layout {
                gap: 15px;
            }

            .card {
                width: 120px;
                height: 155px;
                padding: 12px;
            }

            .card-icon {
                width: 50px;
                height: 50px;
            }

            .card-name {
                font-size: 12px;
            }

            .played-card {
                width: 100px;
                height: 135px;
                padding: 8px;
            }

            .card-back {
                width: 70px;
                height: 88px;
            }

            .battle-area {
                gap: 35px;
            }

            .pathway-grid {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }

            h1 {
                font-size: 22px;
            }

            .pathway-modal-content {
                max-width: 95%;
            }

            .pathway-table .pathway-desc-cell,
            .pathway-table .pathway-abilities-cell {
                max-width: 250px;
            }
        }

        /* ============================================
           MOBILE BREAKPOINT (max-width: 768px)
           ============================================ */
        @media (max-width: 768px) {
            /* ===== CLEAN MOBILE LAYOUT ===== */

            /* Reposition tooltips below cards on mobile */
            .card::after {
                bottom: auto;
                top: 100%;
                margin-top: 5px;
            }

            /* Single column, minimal gaps */
            .main-layout {
                flex-direction: column;
                gap: 10px;
            }

            /* Hide sidebars - only show essential content */
            .left-sidebar,
            .right-sidebar {
                width: 100%;
                position: static;
            }

            /* HIDE non-essential elements on mobile */
            .achievement-box,
            .pathway-reference,
            .battle-log,
            .feedback-btn {
                display: none;
            }

            /* Reorder for clean mobile flow */
            .left-sidebar {
                order: 1;
            }

            .center-content {
                order: 2;
                width: 100%;
            }

            .right-sidebar {
                order: 3;
            }

            /* Compact HP bars side by side */
            .hp-section {
                flex-direction: row;
                gap: 8px;
            }

            .hp-bar-container {
                flex: 1;
                padding: 8px 10px;
                border-radius: 8px;
            }

            .hp-label {
                font-size: 11px;
                margin-bottom: 4px;
            }

            .hp-bar {
                height: 18px;
            }

            .hp-text {
                font-size: 10px;
            }

            /* Hide title/subtitle on mobile - save space */
            .center-content > h1,
            .center-content > .subtitle {
                display: none;
            }

            /* Compact opponent hand */
            .opponent-hand {
                margin-bottom: 8px;
            }

            .opponent-hand .hand-label {
                font-size: 10px;
                margin-bottom: 4px;
            }

            .card-back {
                width: 45px;
                height: 56px;
                font-size: 14px;
                border-radius: 6px;
            }

            /* Clean battle area */
            .battle-area {
                gap: 15px;
                min-height: 100px;
                margin: 10px 0;
                padding: 10px;
            }

            .played-card {
                width: 80px;
                height: 105px;
                padding: 6px;
                border-radius: 8px;
            }

            .played-card .card-icon {
                width: 30px;
                height: 30px;
            }

            .played-card .card-name {
                font-size: 9px;
            }

            .vs-text {
                font-size: 14px;
                padding: 4px 10px;
            }

            /* Ability Phase - Mobile */
            .ability-phase-section {
                padding: 10px;
                margin-bottom: 10px;
            }

            .ability-phase-header h3 {
                font-size: 14px;
            }

            .ability-phase-header p {
                font-size: 10px;
            }

            .ability-cards-container {
                flex-direction: column;
                gap: 8px;
            }

            .ability-card-column {
                min-width: 100%;
                max-width: 100%;
                padding: 8px;
            }

            .ability-card-header {
                margin-bottom: 6px;
                padding-bottom: 6px;
            }

            .ability-card-header img {
                width: 20px;
                height: 20px;
            }

            .ability-card-header .card-name {
                font-size: 11px;
            }

            .ability-list-container {
                max-height: 120px;
            }

            .ability-btn {
                padding: 8px 10px;
                margin-bottom: 4px;
                min-height: 44px;
            }

            .ability-btn .ability-name {
                font-size: 11px;
            }

            .ability-btn .ability-desc {
                font-size: 10px;
            }

            .ability-phase-actions {
                gap: 8px;
                margin-top: 10px;
            }

            .btn-use-ability,
            .btn-skip-ability {
                padding: 12px 20px;
                font-size: 14px;
                min-height: 44px;
            }

            .ability-used-indicator {
                padding: 8px;
                margin-bottom: 10px;
            }

            .ability-used-indicator .ability-used-text {
                font-size: 11px;
            }

            /* Player hand - the main focus */
            .player-hand {
                margin-top: 10px;
            }

            .player-hand .hand-label {
                font-size: 11px;
                margin-bottom: 6px;
            }

            .hand {
                gap: 6px;
                justify-content: center;
            }

            .card {
                width: 72px;
                height: 92px;
                padding: 6px;
                border-radius: 8px;
                min-width: 48px;
                min-height: 48px;
            }

            .card-icon {
                width: 28px;
                height: 28px;
            }

            .card-name {
                font-size: 8px;
                margin-top: 4px;
            }

            .card-type,
            .card-weight {
                display: none;
            }

            /* Compact action buttons */
            .action-buttons {
                gap: 8px;
                margin-top: 12px;
            }

            .btn-play,
            .btn-new-game {
                padding: 10px 24px;
                font-size: 14px;
                min-height: 40px;
            }

            .btn-help {
                width: 40px;
                height: 40px;
                font-size: 16px;
            }

            /* Mode selection - compact row */
            .mode-selection {
                gap: 6px;
                margin-top: 10px;
            }

            .mode-btn {
                flex: 1;
                padding: 10px 10px;
                font-size: 12px;
                min-height: 44px;
            }

            /* Difficulty selection - compact */
            .difficulty-selection {
                padding: 8px;
                margin-bottom: 10px;
            }

            .difficulty-buttons {
                grid-template-columns: 1fr 1fr;
                gap: 6px;
            }

            .difficulty-btn {
                padding: 10px 8px;
                font-size: 11px;
                min-height: 44px;
            }

            .difficulty-desc {
                font-size: 9px;
            }

            /* Multiplier - inline and compact */
            .multiplier-display {
                padding: 6px 10px;
                font-size: 12px;
                margin-bottom: 8px;
            }

            .multiplier-value {
                font-size: 16px;
            }

            /* ===== MODALS - Full screen on mobile ===== */
            .achievement-modal-content {
                max-width: 100%;
                max-height: 95vh;
                border-radius: 12px;
                margin: 10px;
            }

            .pathway-modal-content {
                max-width: 100%;
                margin: 5px;
                padding: 12px;
                max-height: 95vh;
            }

            .pathway-table {
                font-size: 11px;
            }

            .pathway-table th,
            .pathway-table td {
                padding: 6px 4px;
            }

            .pathway-table .pathway-desc-cell,
            .pathway-table .pathway-abilities-cell {
                max-width: 150px;
            }

            .feedback-content {
                width: 95%;
            }

            /* Ability Modal - mobile optimized */
            .ability-modal-content {
                width: 95%;
                max-width: 95%;
                padding: 15px;
                max-height: 90vh;
            }

            .ability-modal-header h2 {
                font-size: 18px;
            }

            .ability-modal-option {
                padding: 12px;
                min-height: 48px;
            }

            .ability-modal-card {
                width: 80px;
                padding: 10px;
                min-height: 48px;
            }

            .ability-modal-card img {
                width: 40px;
                height: 40px;
            }

            .ability-modal-btn {
                padding: 12px 20px;
                font-size: 14px;
                min-height: 44px;
            }

            /* ===== WELCOME/INTRO - Clean mobile ===== */
            .welcome-content {
                padding: 25px 20px;
                max-width: 95%;
            }

            .welcome-screen h1 {
                font-size: 24px;
            }

            .welcome-subtitle {
                font-size: 13px;
            }

            .intro-screen {
                padding: 15px;
            }

            .intro-screen h1 {
                font-size: 22px;
                margin-bottom: 5px;
            }

            .intro-screen .subtitle {
                font-size: 12px;
                margin-bottom: 15px;
            }

            .intro-box {
                padding: 15px;
                max-width: 100%;
                margin-bottom: 12px;
            }

            .intro-box h2 {
                font-size: 16px;
            }

            .intro-box p,
            .intro-box li {
                font-size: 12px;
            }

            .intro-close-btn {
                top: 10px;
                right: 70px;
                width: 36px;
                height: 36px;
                font-size: 20px;
            }

            /* Game over */
            .game-over-content {
                padding: 25px 20px;
            }

            .game-over-content h2 {
                font-size: 28px;
            }

            /* GM Panel */
            .gm-panel-content {
                max-width: 95%;
                padding: 15px;
            }

            /* Secret popup */
            .secret-popup-content {
                max-width: 90%;
                padding: 20px;
            }

            .secret-code-input {
                font-size: 16px;
                width: 120px;
            }

            /* CRITICAL: All inputs must be 16px+ to prevent iOS auto-zoom */
            input,
            select,
            textarea,
            .room-code-input,
            .profile-search input,
            .feedback-input,
            .feedback-select,
            .feedback-textarea {
                font-size: 16px !important;
            }

            /* Notifications - bottom of screen on mobile */
            .achievement-notification,
            .triumph-notification {
                left: 10px;
                right: 10px;
                top: auto;
                bottom: 20px;
                transform: translateX(0) translateY(100px);
            }

            .achievement-notification.show,
            .triumph-notification.show {
                transform: translateX(0) translateY(0);
            }

            /* ===== PATHWAY GRID TABLET ===== */
            .pathway-grid {
                grid-template-columns: repeat(2, minmax(0, 1fr));
                gap: 8px;
            }

            .pathway-item {
                padding: 10px 8px;
                gap: 8px;
                min-width: 0;
            }

            .pathway-item img {
                width: 28px;
                height: 28px;
            }

            .pathway-item span {
                font-size: 12px;
            }

            .pathway-item.big-hit span {
                font-size: 12px;
            }
        }

        /* ============================================
           SMALL PHONE BREAKPOINT (max-width: 480px)
           ============================================ */
        @media (max-width: 480px) {
            /* ===== ULTRA MINIMAL PHONE LAYOUT ===== */

            .game-container {
                padding: 8px;
            }

            /* Keep HP bars side by side but smaller */
            .hp-section {
                flex-direction: row;
                gap: 6px;
            }

            .hp-bar-container {
                padding: 6px 8px;
            }

            .hp-bar {
                height: 16px;
            }

            .hp-label {
                font-size: 10px;
            }

            .hp-text {
                font-size: 9px;
            }

            /* Tiny opponent cards */
            .card-back {
                width: 38px;
                height: 48px;
                font-size: 11px;
            }

            /* Compact battle area */
            .battle-area {
                gap: 10px;
                min-height: 85px;
                margin: 8px 0;
                padding: 8px;
            }

            .played-card {
                width: 65px;
                height: 85px;
                padding: 5px;
            }

            .played-card .card-icon {
                width: 24px;
                height: 24px;
            }

            .played-card .card-name {
                font-size: 10px;
                line-height: 1.2;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .vs-text {
                font-size: 11px;
                padding: 3px 8px;
            }

            /* Player cards - sized for touch targets (minimum 48px for tapping) */
            .card {
                width: 68px;
                height: 88px;
                padding: 6px;
                border-radius: 6px;
                min-height: 48px;
                min-width: 48px;
            }

            .card-icon {
                width: 26px;
                height: 26px;
            }

            .card-name {
                font-size: 10px;
                margin-top: 3px;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .hand {
                gap: 6px;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                padding: 10px 0;
            }

            .hand-label {
                font-size: 9px;
            }

            /* Action buttons in a row */
            .action-buttons {
                flex-direction: row;
                gap: 6px;
                margin-top: 10px;
            }

            .btn-play,
            .btn-new-game {
                padding: 10px 18px;
                font-size: 13px;
                min-height: 44px;
            }

            .btn-help {
                width: 44px;
                height: 44px;
                font-size: 16px;
            }

            /* Mode selection - single row */
            .mode-selection {
                flex-direction: row;
                gap: 4px;
            }

            .mode-btn {
                padding: 10px 8px;
                font-size: 10px;
                min-height: 44px;
            }

            /* Multiplier tiny */
            .multiplier-display {
                padding: 4px 8px;
                font-size: 10px;
            }

            .multiplier-value {
                font-size: 14px;
            }

            /* ===== WELCOME/INTRO SCREENS ===== */
            .welcome-content {
                padding: 20px 15px;
            }

            .welcome-screen h1 {
                font-size: 20px;
            }

            .welcome-subtitle {
                font-size: 11px;
            }

            .welcome-buttons {
                flex-direction: column;
                gap: 10px;
            }

            .welcome-btn {
                width: 100%;
                padding: 14px 16px;
                font-size: 15px;
                min-height: 48px;
            }

            .player-code-display {
                font-size: 24px;
                letter-spacing: 5px;
            }

            .code-input-container input {
                font-size: 16px;
                width: 140px;
                min-height: 48px;
            }

            .intro-screen {
                padding: 10px;
            }

            .intro-screen h1 {
                font-size: 18px;
            }

            .intro-screen .subtitle {
                font-size: 11px;
            }

            .intro-box {
                padding: 12px;
                margin-bottom: 10px;
            }

            .intro-box h2 {
                font-size: 14px;
            }

            .intro-box p,
            .intro-box li {
                font-size: 11px;
            }

            .intro-close-btn {
                width: 44px;
                height: 44px;
                font-size: 20px;
                right: 70px;
            }

            /* ===== MODALS FULL SCREEN ===== */
            .achievement-modal-content,
            .pathway-modal-content,
            .gm-panel-content,
            .feedback-content {
                max-width: 100%;
                width: 100%;
                max-height: 100vh;
                border-radius: 0;
                margin: 0;
            }

            .achievement-modal,
            .pathway-modal,
            .gm-panel,
            .feedback-modal {
                padding: 0;
            }

            .pathway-table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .pathway-table {
                font-size: 10px;
                min-width: 500px;
            }

            /* Game over */
            .game-over-content {
                padding: 20px 15px;
            }

            .game-over-content h2 {
                font-size: 24px;
            }

            .game-over-content p {
                font-size: 12px;
            }

            .game-over-buttons {
                flex-direction: column;
                gap: 8px;
            }

            .game-over-buttons button {
                width: 100%;
            }

            /* Notifications smaller */
            .achievement-notification,
            .triumph-notification {
                padding: 8px 10px;
            }

            .achievement-notification-icon,
            .triumph-notification-icon {
                font-size: 20px;
            }

            .achievement-notification-name,
            .triumph-notification-name {
                font-size: 11px;
            }

            /* Secret popup */
            .secret-popup-content {
                padding: 15px;
                max-width: 95%;
            }

            .secret-code-input {
                font-size: 16px;
                width: 110px;
            }

            /* Room code */
            .room-code-section {
                padding: 8px;
            }

            .room-code {
                font-size: 18px;
                letter-spacing: 3px;
            }

            /* ===== PATHWAY GRID MOBILE FIX ===== */
            .pathway-grid {
                grid-template-columns: repeat(2, minmax(0, 1fr));
                gap: 8px;
                padding: 0 2px;
            }

            .pathway-item {
                padding: 10px 8px;
                gap: 8px;
                min-height: 48px;
                min-width: 0;
            }

            .pathway-item img {
                width: 32px;
                height: 32px;
            }

            .pathway-item span {
                font-size: 13px;
            }

            .pathway-item.big-hit span {
                font-size: 13px;
            }

            /* Pathway reference section */
            .pathway-reference h3 {
                font-size: 14px;
                margin-bottom: 8px;
            }
        }

        /* ============================================
           UTILITY CLASSES (cleaned up inline styles)
           ============================================ */
        .dev-wipe-btn {
            position: absolute;
            bottom: 10px;
            right: 10px;
            opacity: 0.1;
            background: red;
            color: white;
            border: none;
            font-size: 10px;
            padding: 5px;
            cursor: pointer;
            border-radius: 4px;
        }

        .main-screen-stats {
            margin-bottom: 15px;
            font-size: 13px;
            color: var(--color-text-dim);
            text-align: center;
            height: 20px;
        }

        .ability-modal-instruction {
            color: var(--color-text-muted);
            margin-bottom: 15px;
        }

        .triumph-subtitle {
            font-size: 10px;
            color: var(--color-text-muted);
        }

        .ability-log-card {
            color: var(--color-gold);
        }

        .ability-log-name {
            color: #8aba8a;
        }

        .pvp-ready-text {
            font-size: 12px;
            color: var(--color-text-dim);
        }

        .pvp-locked-text {
            font-size: 12px;
            color: #00ff88;
        }

        .difficulty-header {
            color: #aa44ff;
            font-size: 11px;
            margin: 10px 0 5px 0;
        }

        .triumph-name-small {
            font-size: 9px;
            color: #777;
            margin-top: 2px;
        }

        .unknown-card-placeholder {
            width: 40px;
            height: 40px;
            background: #333;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .unknown-card-placeholder-large {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #2a2a4a, #1a1a2e);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            color: #666;
        }

        .ability-cards-scroll {
            max-height: 400px;
            overflow-y: auto;
        }

        .pvp-card-preview-img {
            width: 40px;
            height: 40px;
            margin-bottom: 2px;
        }

        .pvp-card-preview-name {
            font-size: 9px;
            color: #ffd700;
        }

        /* ============================================
           REDUCED MOTION ACCESSIBILITY
           ============================================ */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }

            /* Keep essential state changes visible but quick */
            .hp-fill,
            .madness-fill {
                transition: width 0.3s ease !important;
            }
        }

        /* ============================================
           TUTORIAL MODE STYLES
           ============================================ */
        .tutorial-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 10000;
            pointer-events: none;
        }


        /* Overlay stays pointer-events: none so clicks pass through to game */
        /* Individual tutorial UI elements get pointer-events: auto */

        .tutorial-progress {
            pointer-events: auto;
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            transition: top 0.3s ease, bottom 0.3s ease;
        }

        /* Move progress dots to right side during chapter 5 (Game Modes) */
        .tutorial-progress.side-position {
            top: 50%;
            left: auto;
            right: 20px;
            transform: translateY(-50%);
            flex-direction: column;
            display: flex;
            gap: 12px;
            padding: 12px 24px;
            background: rgba(0, 0, 0, 0.85);
            border: 2px solid var(--color-gold);
            border-radius: 30px;
            z-index: 10002;
        }

        .tutorial-progress-dot {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: rgba(255, 215, 0, 0.2);
            border: 2px solid var(--color-gold);
            transition: all 0.3s ease;
            position: relative;
            cursor: pointer;
        }

        .tutorial-progress-dot:hover {
            transform: scale(1.2);
            box-shadow: 0 0 8px var(--color-gold);
        }

        .tutorial-progress-dot.locked {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .tutorial-progress-dot.locked:hover {
            transform: none;
            box-shadow: none;
        }

        .tutorial-progress-dot.completed {
            background: var(--color-gold);
        }

        .tutorial-progress-dot.active {
            background: var(--color-gold);
            box-shadow: 0 0 12px var(--color-gold);
            animation: tutorialPulse 1.5s ease-in-out infinite;
        }

        /* Labels removed - just show dots */

        @keyframes tutorialPulse {
            0%, 100% { box-shadow: 0 0 12px var(--color-gold); }
            50% { box-shadow: 0 0 24px var(--color-gold), 0 0 36px rgba(255, 215, 0, 0.5); }
        }

        .tutorial-skip-btn {
            position: fixed;
            top: 20px;
            right: 80px;
            padding: 10px 20px;
            background: rgba(0, 0, 0, 0.7);
            border: 1px solid #666;
            border-radius: 6px;
            color: #999;
            font-size: 12px;
            cursor: pointer;
            z-index: 10002;
            transition: all 0.2s ease;
            pointer-events: auto;
        }

        .tutorial-skip-btn:hover {
            border-color: var(--color-error);
            color: var(--color-error);
            background: rgba(255, 0, 0, 0.1);
        }

        .tutorial-chapter-title {
            position: fixed;
            top: 70px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 24px;
            color: var(--color-gold);
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
            z-index: 10002;
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        .tutorial-chapter-title.visible {
            opacity: 1;
        }

        .tutorial-instruction-box {
            position: fixed;
            max-width: 400px;
            padding: 20px 24px;
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.95), rgba(26, 26, 46, 0.95));
            border: 2px solid var(--color-gold);
            border-radius: 12px;
            color: var(--color-text);
            font-size: 16px;
            line-height: 1.6;
            z-index: 10001;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.3);
            pointer-events: auto;
        }

        /* Arrow base styles */
        .tutorial-instruction-box::after {
            content: '';
            position: absolute;
            width: 0;
            height: 0;
            border: 12px solid transparent;
        }

        .tutorial-instruction-box.position-center {
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .tutorial-instruction-box.position-center::after {
            display: none;
        }

        /* Position for pointing at right sidebar (battle log) - box directly above, arrow pointing down */
        .tutorial-instruction-box.position-above-battle-log {
            bottom: auto;
            top: auto;
            right: 20px;
            left: auto;
            transform: none;
            /* Position will be set dynamically by JS to be directly above the battle log */
        }

        .tutorial-instruction-box.position-above-battle-log::after {
            display: block;
            bottom: -24px;
            left: 50%;
            transform: translateX(-50%);
            border: 16px solid transparent;
            border-top: 16px solid var(--color-gold);
            border-bottom: none;
        }

        .tutorial-instruction-box.position-top {
            top: 120px;
            left: 50%;
            transform: translateX(-50%);
        }

        /* Arrow pointing down (for position-top, box is above content) */
        /* Arrow pointing UP (for position-top, box is below element at top of screen) */
        .tutorial-instruction-box.position-top::after {
            display: block;
            top: -24px;
            bottom: auto;
            left: 50%;
            transform: translateX(-50%);
            border: 16px solid transparent;
            border-bottom: 16px solid var(--color-gold);
            border-top: none;
        }

        .tutorial-instruction-box.position-bottom {
            top: 30%;
            left: 50%;
            transform: translate(-50%, 0);
        }

        /* Arrow pointing down (for position-bottom, pointing to content below) */
        .tutorial-instruction-box.position-bottom::after {
            display: block;
            bottom: -24px;
            left: 50%;
            transform: translateX(-50%);
            border: 16px solid transparent;
            border-top: 16px solid var(--color-gold);
            border-bottom: none;
        }

        .tutorial-instruction-box.position-left {
            top: 50%;
            left: 40px;
            transform: translateY(-50%);
        }

        /* Arrow pointing right (for position-left) */
        .tutorial-instruction-box.position-left::after {
            display: block;
            right: -24px;
            top: 50%;
            transform: translateY(-50%);
            border: 16px solid transparent;
            border-left: 16px solid var(--color-gold);
            border-right: none;
        }

        .tutorial-instruction-box.position-right {
            top: 50%;
            right: 40px;
            transform: translateY(-50%);
        }

        /* Hide arrow for position-right since we use the diagonal connector line */
        .tutorial-instruction-box.position-right::after {
            display: none;
        }

        /* Diagonal connector line for tutorial box */
        .tutorial-connector-line {
            position: fixed;
            pointer-events: none;
            z-index: 10001;
        }

        .tutorial-connector-line line {
            stroke: var(--color-gold);
            stroke-width: 3;
        }

        .tutorial-connector-line polygon {
            fill: var(--color-gold);
        }

        /* Position for pointing at left sidebar elements (HP bars, madness) - box to the right, arrow pointing left */
        .tutorial-instruction-box.position-left-sidebar {
            top: 20%;
            left: 320px;
            transform: translateY(-50%);
        }

        .tutorial-instruction-box.position-left-sidebar::after {
            display: block;
            left: -24px;
            top: 50%;
            transform: translateY(-50%);
            border: 16px solid transparent;
            border-right: 16px solid var(--color-gold);
            border-left: none;
        }

        .tutorial-instruction-title {
            font-size: 18px;
            color: var(--color-gold);
            margin-bottom: 12px;
            font-weight: bold;
        }

        .tutorial-instruction-text {
            margin-bottom: 16px;
        }

        .tutorial-instruction-text strong {
            color: var(--color-gold);
        }

        .tutorial-continue-btn {
            display: block;
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, var(--color-gold), #b8860b);
            border: none;
            border-radius: 6px;
            color: #1a1a2e;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .tutorial-continue-btn:hover {
            transform: scale(1.02);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }

        .tutorial-continue-btn:disabled {
            background: #444;
            color: #888;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Tutorial spotlight effect - darkens everything except highlighted elements */
        .tutorial-spotlight {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            z-index: 100;
            pointer-events: none;
        }

        /* Boost main layout above spotlight when tutorial is active */
        .main-layout:has(.tutorial-highlight) {
            position: relative;
            z-index: 101;
        }

        .main-layout.tutorial-active {
            position: relative;
            z-index: 101;
        }

        /* Highlighted element styling - pops ABOVE the darkening */
        .tutorial-highlight {
            position: relative !important;
            z-index: 102 !important;
            isolation: isolate;
            animation: tutorialHighlightPulse 0.8s ease-in-out infinite;
            box-shadow: 0 0 0 8px var(--color-gold), 0 0 50px var(--color-gold), 0 0 100px rgba(255, 215, 0, 0.9), inset 0 0 40px rgba(255, 215, 0, 0.4) !important;
            border-radius: 8px;
            outline: 5px solid #fff !important;
            outline-offset: 6px;
            border: 5px solid var(--color-gold) !important;
        }

        /* Ensure sidebars pop above darkening when they contain highlighted elements */
        .left-sidebar:has(.tutorial-highlight),
        .right-sidebar:has(.tutorial-highlight),
        .center-content:has(.tutorial-highlight) {
            position: relative !important;
            z-index: 101 !important;
        }

        /* Fallback for browsers without :has() - add class via JS */
        .sidebar-highlight-active {
            position: relative !important;
            z-index: 101 !important;
        }

        /* Directly ensure highlighted elements and their contents are above darkening */
        .tutorial-highlight,
        .tutorial-highlight * {
            position: relative;
            z-index: 102 !important;
        }

        #player-hand.tutorial-highlight,
        .hand.tutorial-highlight {
            position: relative !important;
            z-index: 102 !important;
            background: linear-gradient(135deg, #000000, #1a1a2e) !important;
        }

        #player-hand.tutorial-highlight .card,
        .hand.tutorial-highlight .card {
            position: relative !important;
            z-index: 102 !important;
        }

        @keyframes tutorialHighlightPulse {
            0%, 100% {
                box-shadow: 0 0 0 8px var(--color-gold), 0 0 50px var(--color-gold), 0 0 100px rgba(255, 215, 0, 0.9), inset 0 0 40px rgba(255, 215, 0, 0.4);
                transform: scale(1);
            }
            50% {
                box-shadow: 0 0 0 14px var(--color-gold), 0 0 80px var(--color-gold), 0 0 120px rgba(255, 215, 0, 1), inset 0 0 60px rgba(255, 215, 0, 0.6);
                transform: scale(1.02);
            }
        }

        /* Make battle log readable when highlighted - match tutorial box style */
        .battle-log.tutorial-highlight {
            background: linear-gradient(135deg, #000000, #1a1a2e) !important;
            padding: 20px !important;
        }

        .battle-log.tutorial-highlight h3 {
            color: var(--color-gold) !important;
            font-size: 20px !important;
            font-weight: bold !important;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
            margin-bottom: 15px !important;
        }

        .battle-log.tutorial-highlight #log-content {
            background: rgba(0, 0, 0, 0.5) !important;
            padding: 10px !important;
            border-radius: 6px !important;
        }

        .battle-log.tutorial-highlight .log-entry {
            color: #ffffff !important;
            font-size: 15px !important;
            padding: 10px 12px !important;
            margin-bottom: 8px !important;
            background: rgba(255, 255, 255, 0.15) !important;
            border-radius: 6px !important;
            line-height: 1.5 !important;
        }

        .battle-log.tutorial-highlight .log-entry.win {
            background: rgba(0, 200, 0, 0.3) !important;
            color: #66ff66 !important;
        }

        .battle-log.tutorial-highlight .log-entry.lose {
            background: rgba(200, 0, 0, 0.3) !important;
            color: #ff6666 !important;
        }

        .battle-log.tutorial-highlight .log-entry.info {
            background: rgba(100, 150, 255, 0.3) !important;
            color: #99ccff !important;
        }

        .battle-log.tutorial-highlight .log-entry.draw {
            background: rgba(255, 200, 0, 0.3) !important;
            color: #ffdd66 !important;
        }

        /* UI Lock - disable clicks except on allowed elements */
        .tutorial-ui-locked {
            pointer-events: none !important;
        }

        .tutorial-ui-locked .tutorial-allowed {
            pointer-events: auto !important;
        }

        /* Tutorial modals */
        .tutorial-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10003;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .tutorial-modal.visible {
            opacity: 1;
            visibility: visible;
        }

        .tutorial-modal-content {
            max-width: 500px;
            padding: 40px;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border: 3px solid var(--color-gold);
            border-radius: 16px;
            text-align: center;
            box-shadow: 0 0 50px rgba(255, 215, 0, 0.3);
        }

        .tutorial-modal-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .tutorial-modal-title {
            font-size: 28px;
            color: var(--color-gold);
            margin-bottom: 16px;
        }

        .tutorial-modal-text {
            font-size: 16px;
            color: var(--color-text);
            margin-bottom: 24px;
            line-height: 1.6;
        }

        .tutorial-modal-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .tutorial-modal-btn {
            padding: 14px 28px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .tutorial-modal-btn.primary {
            background: linear-gradient(135deg, var(--color-gold), #b8860b);
            color: #1a1a2e;
        }

        .tutorial-modal-btn.primary:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }

        .tutorial-modal-btn.secondary {
            background: transparent;
            border: 2px solid #666;
            color: #999;
        }

        .tutorial-modal-btn.secondary:hover {
            border-color: var(--color-error);
            color: var(--color-error);
        }

        .tutorial-modal-btn.danger {
            background: var(--color-error);
            color: white;
        }

        .tutorial-modal-btn.danger:hover {
            background: #ff3333;
            transform: scale(1.05);
        }

        /* Tutorial rewards display */
        .tutorial-rewards {
            margin: 20px 0;
            padding: 20px;
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid var(--color-gold);
            border-radius: 8px;
        }

        .tutorial-reward-item {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 20px;
            color: var(--color-gold);
        }

        .tutorial-reward-item .coin-icon {
            font-size: 24px;
        }

        /* Tutorial menu button for returning players */
        .btn-tutorial-menu {
            position: fixed;
            bottom: 20px;
            left: 20px;
            padding: 10px 16px;
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid var(--color-purple);
            border-radius: 8px;
            color: var(--color-text-muted);
            font-size: 12px;
            cursor: pointer;
            z-index: 100;
            transition: all 0.2s ease;
            display: none;
        }

        .btn-tutorial-menu:hover {
            border-color: var(--color-gold);
            color: var(--color-gold);
            background: rgba(255, 215, 0, 0.1);
        }

        .btn-tutorial-menu.visible {
            display: block;
        }

        /* Tutorial prompt for new players */
        .tutorial-prompt {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10005;
        }

        .tutorial-prompt-content {
            max-width: 450px;
            padding: 40px;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border: 3px solid var(--color-gold);
            border-radius: 16px;
            text-align: center;
        }

        .tutorial-prompt-title {
            font-size: 24px;
            color: var(--color-gold);
            margin-bottom: 20px;
        }

        .tutorial-prompt-text {
            font-size: 14px;
            color: var(--color-text);
            margin-bottom: 24px;
            line-height: 1.6;
        }

        .tutorial-prompt-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .tutorial-prompt-btn {
            padding: 16px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .tutorial-prompt-btn.start {
            background: linear-gradient(135deg, var(--color-gold), #b8860b);
            color: #1a1a2e;
        }

        .tutorial-prompt-btn.start:hover {
            transform: scale(1.02);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }

        .tutorial-prompt-btn.skip {
            background: transparent;
            border: 1px solid #555;
            color: #888;
            font-size: 12px;
            padding: 10px;
        }

        .tutorial-prompt-btn.skip:hover {
            border-color: #888;
            color: #aaa;
        }

        /* Tutorial hidden states */
        .tutorial-prompt.hidden,
        .tutorial-overlay.hidden,
        .tutorial-modal.hidden,
        .tutorial-instruction-box.hidden {
            display: none !important;
        }

        /* Tutorial difficulty selector for final test */
        .tutorial-difficulty-selector {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 16px;
            flex-wrap: wrap;
        }

        .tutorial-difficulty-btn {
            padding: 10px 20px;
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid var(--color-purple);
            border-radius: 8px;
            color: var(--color-text);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .tutorial-difficulty-btn:hover {
            border-color: var(--color-gold);
            background: rgba(255, 215, 0, 0.1);
        }

        .tutorial-difficulty-btn.required {
            border-color: var(--color-gold);
            color: var(--color-gold);
        }

        .tutorial-difficulty-btn.optional {
            border-style: dashed;
            opacity: 0.7;
        }

        .tutorial-difficulty-btn.completed {
            background: rgba(74, 138, 74, 0.3);
            border-color: var(--color-success);
            color: var(--color-success);
        }

        .tutorial-chapter-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 300px;
            overflow-y: auto;
        }

        .tutorial-chapter-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }

        .tutorial-chapter-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--color-gold);
        }

        .tutorial-chapter-btn .chapter-num {
            width: 28px;
            height: 28px;
            background: var(--color-gold);
            color: #000;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            flex-shrink: 0;
        }

        .tutorial-chapter-btn .chapter-info {
            flex: 1;
        }

        .tutorial-chapter-btn .chapter-title {
            font-weight: 600;
            color: var(--color-text);
            font-size: 13px;
        }

        .tutorial-chapter-btn .chapter-steps {
            font-size: 10px;
            color: var(--color-text-dim);
        }

        .tutorial-chapter-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .tutorial-chapter-btn.disabled:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.1);
        }
    </style>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
</head>
<body>
    <!-- Theme Toggle Button -->
    <button class="theme-toggle" id="theme-toggle" onclick="toggleTheme()" title="Toggle light/dark mode">
        <span id="theme-icon"></span>
    </button>

    <!-- Welcome Screen (New/Returning Player) -->
    <div class="welcome-screen" id="welcome-screen">
        <div class="welcome-content">
            <h1>Welcome to Pathway Clash</h1>
            <p class="welcome-subtitle">A Lord of the Mysteries Card Game</p>

            <div class="welcome-choice" id="welcome-choice">
                <p>Are you a new or returning player?</p>
                <div class="welcome-buttons">
                    <button class="welcome-btn new-player" onclick="setupNewPlayer()">New Player</button>
                    <button class="welcome-btn returning-player" onclick="showReturningPlayerInput()">Returning Player</button>
                </div>
                <p class="no-code-link" onclick="skipPlayerCode()">No code please</p>
            </div>

            <div class="welcome-new-player hidden" id="welcome-new-player">
                <p>Your unique player code is:</p>
                <div class="player-code-display" id="new-player-code"></div>
                <p class="code-note">Save this code! You'll need it to continue your progress.</p>
                <button class="welcome-btn confirm" id="new-player-continue-btn" onclick="confirmNewPlayer()" disabled>Continue</button>
            </div>

            <div class="welcome-returning hidden" id="welcome-returning">
                <p>Enter your player code:</p>
                <div class="code-input-container">
                    <input type="text" id="returning-code-input" maxlength="10" placeholder="0000" autocomplete="off" inputmode="numeric">
                </div>
                <div class="returning-buttons">
                    <button class="welcome-btn back" onclick="showWelcomeChoice()">Back</button>
                    <button class="welcome-btn confirm" onclick="submitReturningCode()">Continue</button>
                </div>
                <p class="code-error hidden" id="code-error">Invalid code format. Please enter 4 digits.</p>
            </div>

            <div class="welcome-back hidden" id="welcome-back">
                <p>Welcome back!</p>
                <div class="player-code-display" id="existing-player-code"></div>
                <button class="welcome-btn confirm" onclick="continueExistingPlayer()">Continue</button>
                <p class="different-code" onclick="showReturningPlayerInput()">Use a different code?</p>
            </div>
        </div>
    </div>

    <!-- Tutorial Prompt (for new players) -->
    <div class="tutorial-prompt hidden" id="tutorial-prompt">
        <div class="tutorial-prompt-content">
            <div class="tutorial-prompt-title">Welcome to Pathway Clash!</div>
            <div class="tutorial-prompt-text">
                Would you like to learn how to play? The tutorial will guide you through all game mechanics and reward you with <strong style="color: #ffd700;">100 coins</strong> upon completion.
            </div>
            <div class="tutorial-prompt-buttons">
                <button class="tutorial-prompt-btn start" onclick="startTutorialFromPrompt()">Start Tutorial</button>
                <button class="tutorial-prompt-btn skip" onclick="skipTutorialFromPrompt()">Skip for now (I know how to play)</button>
            </div>
        </div>
    </div>

    <!-- Tutorial Overlay -->
    <div class="tutorial-overlay hidden" id="tutorial-overlay">
        <div class="tutorial-spotlight" id="tutorial-spotlight"></div>
        <div class="tutorial-progress" id="tutorial-progress">
            <div class="tutorial-progress-dot" data-chapter="1. Basics"></div>
            <div class="tutorial-progress-dot" data-chapter="2. Abilities"></div>
            <div class="tutorial-progress-dot" data-chapter="3. Card Tiers"></div>
            <div class="tutorial-progress-dot" data-chapter="4. Strategy"></div>
            <div class="tutorial-progress-dot" data-chapter="5. Modes"></div>
            <div class="tutorial-progress-dot" data-chapter="6. Test"></div>
        </div>
        <button class="tutorial-skip-btn" onclick="showTutorialSkipWarning()">Skip Tutorial</button>
        <div class="tutorial-chapter-title" id="tutorial-chapter-title"></div>
        <div class="tutorial-instruction-box hidden" id="tutorial-instruction-box">
            <div class="tutorial-instruction-title" id="tutorial-instruction-title"></div>
            <div class="tutorial-instruction-text" id="tutorial-instruction-text"></div>
            <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                <button class="tutorial-continue-btn" id="tutorial-continue-btn" onclick="advanceTutorialStep()">Continue</button>
                <button class="tutorial-continue-btn hidden" id="tutorial-exit-review-btn" onclick="exitTutorialReview()" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);">Exit Review</button>
            </div>
        </div>
        <!-- Diagonal connector line for tutorial -->
        <svg class="tutorial-connector-line hidden" id="tutorial-connector-line" width="100%" height="100%" style="position:fixed;top:0;left:0;width:100%;height:100%;">
            <defs>
                <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                    <polygon points="0 0, 10 3.5, 0 7" fill="#FFD700" />
                </marker>
            </defs>
            <line id="tutorial-connector" x1="0" y1="0" x2="0" y2="0" stroke="#FFD700" stroke-width="3" marker-end="url(#arrowhead)" />
        </svg>
    </div>

    <!-- Tutorial Chapter Complete Modal -->
    <div class="tutorial-modal hidden" id="tutorial-chapter-modal">
        <div class="tutorial-modal-content">
            <div class="tutorial-modal-icon" id="tutorial-chapter-icon"></div>
            <div class="tutorial-modal-title" id="tutorial-chapter-modal-title">Chapter Complete!</div>
            <div class="tutorial-modal-text" id="tutorial-chapter-modal-text"></div>
            <div class="tutorial-modal-buttons">
                <button class="tutorial-modal-btn primary" onclick="continueToNextChapter()">Continue</button>
            </div>
        </div>
    </div>

    <!-- Tutorial Skip Warning Modal -->
    <div class="tutorial-modal hidden" id="tutorial-skip-modal">
        <div class="tutorial-modal-content">
            <div class="tutorial-modal-icon"></div>
            <div class="tutorial-modal-title">Skip Tutorial?</div>
            <div class="tutorial-modal-text">
                You'll miss out on learning important game mechanics and the <strong style="color: #ffd700;">100 coin reward</strong>. You can always access the tutorial from the menu later, but rewards are only available on your first playthrough.
            </div>
            <div class="tutorial-modal-buttons">
                <button class="tutorial-modal-btn secondary" onclick="hideTutorialSkipWarning()">Go Back</button>
                <button class="tutorial-modal-btn danger" onclick="confirmSkipTutorial()">Skip Anyway</button>
            </div>
        </div>
    </div>

    <!-- Tutorial Complete Modal -->
    <div class="tutorial-modal hidden" id="tutorial-complete-modal">
        <div class="tutorial-modal-content">
            <div class="tutorial-modal-icon"></div>
            <div class="tutorial-modal-title">Tutorial Complete!</div>
            <div class="tutorial-modal-text" id="tutorial-complete-text">
                Congratulations! You've mastered all the basics of Pathway Clash.
            </div>
            <div class="tutorial-rewards" id="tutorial-rewards">
                <div class="tutorial-reward-item">
                    <span class="coin-icon"></span>
                    <span id="tutorial-reward-amount">+100 Coins</span>
                </div>
            </div>
            <div class="tutorial-modal-buttons">
                <button class="tutorial-modal-btn primary" onclick="finishTutorial()">Start Playing!</button>
            </div>
        </div>
    </div>

    <!-- Tutorial Final Test Modal -->
    <div class="tutorial-modal hidden" id="tutorial-final-test-modal">
        <div class="tutorial-modal-content">
            <div class="tutorial-modal-icon"></div>
            <div class="tutorial-modal-title" id="tutorial-test-title">Final Test</div>
            <div class="tutorial-modal-text" id="tutorial-test-text">
                Put your skills to the test! Beat the AI to complete the tutorial.
            </div>
            <div class="tutorial-difficulty-selector" id="tutorial-difficulty-selector">
                <button class="tutorial-difficulty-btn required" id="tutorial-btn-easy" onclick="startTutorialTest('easy')">Easy AI</button>
                <button class="tutorial-difficulty-btn required" id="tutorial-btn-medium" onclick="startTutorialTest('medium')" disabled>Medium AI</button>
                <button class="tutorial-difficulty-btn optional" id="tutorial-btn-hard" onclick="startTutorialTest('hard')">Hard AI</button>
                <button class="tutorial-difficulty-btn optional" id="tutorial-btn-god" onclick="startTutorialTest('god')">God AI</button>
            </div>
            <div class="tutorial-modal-buttons" style="margin-top: 20px;">
                <button class="tutorial-modal-btn primary hidden" id="tutorial-btn-finish" onclick="completeTutorial()" style="background: var(--color-success);"> Finish Tutorial & Claim Rewards</button>
                <button class="tutorial-modal-btn secondary" id="tutorial-btn-exit" onclick="exitTutorialEarly()"> Exit Without Rewards</button>
            </div>
        </div>
    </div>

    <!-- Tutorial Chapter Select Modal -->
    <div class="tutorial-modal hidden" id="tutorial-chapter-select-modal">
        <div class="tutorial-modal-content" style="max-width: 400px;">
            <div class="tutorial-modal-icon"></div>
            <div class="tutorial-modal-title">Tutorial Reference</div>
            <div class="tutorial-modal-text" style="margin-bottom: 15px;">
                Select a chapter to review. You can browse at your own pace!
            </div>
            <div class="tutorial-chapter-list" id="tutorial-chapter-list">
                <!-- Chapters will be populated dynamically -->
            </div>
            <div class="tutorial-modal-buttons" style="margin-top: 15px;">
                <button class="tutorial-modal-btn primary" onclick="startFullTutorialReview()"> Full Tutorial</button>
                <button class="tutorial-modal-btn secondary" onclick="closeTutorialChapterSelect()">Close</button>
            </div>
        </div>
    </div>

    <!-- Tutorial Menu Button (for returning players) -->
    <button class="btn-tutorial-menu" id="btn-tutorial-menu" onclick="openTutorialFromMenu()"> Tutorial</button>

    <!-- Intro Screen -->
    <div class="intro-screen hidden" id="intro-screen">
        <button class="intro-close-btn" onclick="hideTutorial()">&times;</button>
        <h1>Pathway Clash</h1>
        <p class="subtitle">A <span class="secret-word" onclick="handleSecretClick()">Lord</span> of the Mysteries Card Game</p>

        <div class="intro-box">
            <h2>What is this?</h2>
            <p>A blind card battler based on the 22 Pathways from Lord of the Mysteries. Each pathway has unique strengths and weaknesses against others, creating a strategic rock-paper-scissors style game.</p>
        </div>

        <div class="intro-box">
            <h2>How to Play</h2>
            <ul>
                <li><strong>Draw 3 cards</strong> from the 22 pathways each round</li>
                <li><strong>Select a card</strong> to play against your opponent</li>
                <li><strong>Win, lose, or draw</strong> based on pathway matchups</li>
                <li><strong>Deal damage</strong> when you win - stronger matchups deal more!</li>
                <li><strong>First to 0 HP loses</strong> the match</li>
            </ul>
        </div>

        <div class="intro-box">
            <h2>Tips</h2>
            <ul>
                <li><strong>Hover over cards</strong> to see their flavor text</li>
                <li><strong>Watch the battle log</strong> to see matchup results and damage</li>
                <li><strong>Rainbow names</strong> indicate powerful "Big Hit" pathways</li>
                <li><strong>Draws</strong> double the damage multiplier for the next round!</li>
                <li><strong>Press ?</strong> anytime during the game to view this screen</li>
            </ul>
        </div>

        <div class="intro-box">
            <h2>Game Modes</h2>
            <p>Use the toggle buttons next to the title to switch between two modes:</p>
            <ul>
                <li><strong>Pathways</strong> - Battle with the 22 Pathways from Lord of the Mysteries</li>
                <li><strong>Outer Deities</strong> - Battle with 10 cosmic Outer Deities, each with unique matchups and abilities</li>
            </ul>
        </div>

        <button class="dev-wipe-btn" onclick="wipeDatabase()">WIPE DB</button>
        <button class="btn-play" onclick="startGame()">Play</button>
    </div>

    <!-- Secret Code Popup -->
    <div class="secret-popup" id="secret-popup">
        <div class="secret-popup-content">
            <h3>Secret Access</h3>
            <div class="secret-tabs">
                <button class="secret-tab active" onclick="switchSecretTab('panel')" id="tab-panel">GM Panel</button>
                <button class="secret-tab" onclick="switchSecretTab('signin')" id="tab-signin">GM Sign In</button>
            </div>
            <div class="secret-tab-content" id="secret-panel-content">
                <p class="secret-hint">Enter 4-digit panel code</p>
                <input type="text" class="secret-code-input" id="secret-code-input" maxlength="4" placeholder="0000" pattern="[0-9]*" inputmode="numeric">
            </div>
            <div class="secret-tab-content hidden" id="secret-signin-content">
                <p class="secret-hint">Enter GM credentials</p>
                <input type="text" class="secret-code-input" id="gm-signin-input" maxlength="7" placeholder="gmhaha#" autocomplete="off">
            </div>
            <div class="secret-message" id="secret-message"></div>
            <div class="secret-popup-buttons">
                <button class="secret-popup-btn cancel" onclick="closeSecretPopup()">Cancel</button>
                <button class="secret-popup-btn submit" onclick="submitSecretCode()">Submit</button>
            </div>
        </div>
    </div>

    <!-- GM Panel -->
    <div class="gm-panel" id="gm-panel">
        <div class="gm-panel-content">
            <div class="gm-panel-header">
                <h2>GM Panel - Achievement Testing</h2>
                <button class="gm-close-btn" onclick="closeGMPanel()">&times;</button>
            </div>
            <div class="gm-panel-toolbar">
                <button class="gm-reset-btn" onclick="gmResetAllAchievements()">Reset All Achievements</button>
            </div>
            <div class="gm-achievement-list" id="gm-achievement-list"></div>
        </div>
    </div>

    <!-- Switch Display Popup -->
    <div class="switch-display-popup" id="switch-display-popup">
        <div class="switch-display-content">
            <div class="switch-display-header">
                <span class="switch-display-icon" id="switch-display-icon"></span>
                <span class="switch-display-name" id="switch-display-name"></span>
            </div>
            <p class="switch-display-question">Display this achievement?</p>
            <div class="switch-display-buttons">
                <button class="switch-display-btn no" onclick="cancelSwitchDisplay()">Keep Current</button>
                <button class="switch-display-btn yes" onclick="confirmSwitchDisplay()">Yes, Display</button>
            </div>
        </div>
    </div>

    <div class="game-container hidden" id="game-container">
        <!-- Room Code Section (PvP only) -->
        <div class="room-code-section" id="room-code-section">
            <!-- Match Type Selector -->
            <div class="match-type-selector" id="match-type-selector">
                <button class="match-type-btn active" id="btn-private-match" onclick="setMatchType('private')">Private Room</button>
                <button class="match-type-btn" id="btn-public-match" onclick="setMatchType('public')">Public Match</button>
            </div>

            <!-- Private Room UI -->
            <div class="private-room-ui" id="private-room-ui">
                <div class="room-code-label">Enter a 4-digit room code (both players use same code)</div>
                <input type="text" class="room-code-input" id="room-code-input" maxlength="4" placeholder="0000" pattern="[0-9]*" inputmode="numeric">
                <button class="btn-join" id="btn-join" onclick="joinRoom()">Join</button>
                <div class="room-code-display" id="room-code-display"></div>
            </div>

            <!-- Public Match UI -->
            <div class="public-match-ui" id="public-match-ui" style="display: none;">
                <div class="room-code-label">Get matched with a random opponent</div>
                <button class="btn-find-match" id="btn-find-match" onclick="joinPublicQueue()">Find Match</button>
                <div class="matchmaking-status" id="matchmaking-status" style="display: none;">
                    <div class="matchmaking-spinner"></div>
                    <span id="matchmaking-text">Searching for opponent...</span>
                    <button class="btn-cancel-match" onclick="leavePublicQueue()">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Player Indicator (PvP only) -->
        <div class="player-indicator-container" id="player-indicator-container" style="display: none;">
            <span class="player-indicator" id="player-indicator">Player 1</span>
        </div>

        <!-- Connection Status (PvP only) -->
        <div class="connection-status" id="connection-status"></div>

        <!-- Main 3-column Layout -->
        <div class="main-layout">
            <!-- Left Sidebar: HP Bars -->
            <div class="left-sidebar">
                <!-- Achievement Box -->
                <div class="achievement-box" id="achievement-box">
                    <div class="achievement-box-header">
                        <h3>Achievements</h3>
                        <span class="achievement-see-all" onclick="openAchievementModal()">See All</span>
                    </div>
                    <div class="achievement-list" id="achievement-list">
                        <div class="achievement-placeholder">No achievements yet</div>
                    </div>
                </div>

                <div class="hp-section">
                    <div class="hp-bar-container player">
                        <div class="hp-label">
                            <span id="player-label">You</span>
                            <span id="player-hp-text">100 HP</span>
                        </div>
                        <div class="hp-bar">
                            <div class="hp-fill player" id="player-hp-bar" style="width: 100%"></div>
                        </div>
                        <div class="madness-bar-container">
                            <div class="madness-label">
                                <span>Madness</span>
                                <span id="player-madness-text">0%</span>
                            </div>
                            <div class="madness-bar">
                                <div class="madness-fill" id="player-madness-bar" style="width: 0%"></div>
                            </div>
                            <div class="madness-multiplier" id="player-madness-mult">1x DMG</div>
                        </div>
                    </div>
                    <div class="hp-bar-container opponent">
                        <div class="hp-label">
                            <span id="opponent-label">Opponent</span>
                            <span id="opponent-hp-text">100 HP</span>
                        </div>
                        <div class="hp-bar">
                            <div class="hp-fill opponent" id="opponent-hp-bar" style="width: 100%"></div>
                        </div>
                        <div class="madness-bar-container" id="opponent-madness-container">
                            <div class="madness-label">
                                <span>Madness</span>
                                <span id="opponent-madness-text">0%</span>
                            </div>
                            <div class="madness-bar">
                                <div class="madness-fill" id="opponent-madness-bar" style="width: 0%"></div>
                            </div>
                            <div class="madness-multiplier" id="opponent-madness-mult">1x DMG</div>
                        </div>
                    </div>
                </div>

                <!-- Pathway Reference -->
                <div class="pathway-reference">
                    <button class="btn-view-all" onclick="openPathwayTable()"> View Full Pathway Guide</button>
                    <button class="btn-summon-guide" id="btn-summon-guide" onclick="openPathwayTable(true)"> Inner God Summon Guide</button>
                    <h3 id="pathway-grid-title">All 22 Pathways</h3>

                    <!-- Inner God Summon Area (appears when Above the Sequences are available) -->
                    <div class="inner-god-summon-area" id="inner-god-summon-area">
                        <div class="inner-god-summon-title"> Above the Sequences Ready </div>
                        <div class="inner-god-summon-list" id="inner-god-summon-list"></div>
                    </div>

                    <div class="pathway-grid" id="pathway-grid"></div>

                    <!-- Detail View (hidden by default) -->
                    <div class="pathway-detail" id="pathway-detail">
                        <button class="btn-back" onclick="showPathwayGrid()"> Back</button>
                        <div class="pathway-detail-header">
                            <img class="pathway-detail-icon" id="detail-icon" src="" alt="">
                            <span class="pathway-detail-name" id="detail-name"></span>
                        </div>
                        <div class="pathway-detail-flavor" id="detail-flavor"></div>
                        <div class="pathway-detail-section">
                            <h4>Description</h4>
                            <p id="detail-description"></p>
                        </div>
                        <div class="pathway-detail-section">
                            <h4>Abilities</h4>
                            <ul id="detail-abilities" class="abilities-list"></ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Center: Game Area -->
            <div class="center-content">
                <div class="title-row">
                    <div class="game-type-toggle" id="game-type-toggle">
                        <button class="game-type-btn" id="type-inner-vs-outer" onclick="switchGameType('inner_vs_outer')">Inner vs Outer</button>
                        <button class="game-type-btn pathways active" id="type-pathways" onclick="switchGameType('pathways')">Pathways</button>
                        <button class="game-type-btn" id="type-outer" onclick="switchGameType('outer_deities')">Outer Deities</button>
                    </div>
                    <h1>Pathway Clash</h1>
                </div>
                <p class="subtitle">Lord of the Mysteries - Blind Card Battler</p>
                <div id="main-screen-stats" class="main-screen-stats"></div>

                <!-- Opponent's Hand (face down) -->
                <div class="hand-section">
                    <div class="hand-label">Opponent's Hand</div>
                    <div class="opponent-hand">
                        <div class="card-back">?</div>
                        <div class="card-back">?</div>
                        <div class="card-back">?</div>
                    </div>
                </div>

                <!-- Battle Area -->
                <div class="battle-area">
                    <div class="played-card empty" id="player-played">
                        <div>Your Card</div>
                    </div>
                    <div class="vs-text">VS</div>
                    <div class="played-card empty" id="opponent-played">
                        <div>Opponent's Card</div>
                    </div>
                </div>

                <!-- Ability Phase Section -->
                <div class="ability-phase-section" id="ability-phase-section">
                    <div class="ability-phase-header">
                        <h3>Ability Phase</h3>
                        <p>Select an ability from any card in your hand (optional)</p>
                    </div>
                    <div class="ability-cards-container" id="ability-cards-container">
                        <!-- Populated dynamically -->
                    </div>
                    <div class="ability-phase-actions">
                        <button class="btn-use-ability" id="btn-use-ability" disabled onclick="confirmAbility()">Use Ability</button>
                        <button class="btn-skip-ability" id="btn-skip-ability" onclick="skipAbility()">Skip</button>
                    </div>
                </div>

                <!-- Ability Used Indicator -->
                <div class="ability-used-indicator" id="ability-used-indicator">
                    <span class="ability-used-text">Ability activated: <span class="ability-used-name" id="ability-used-name"></span></span>
                </div>

                <!-- Your Hand -->
                <div class="hand-section">
                    <div class="hand-label">Your Hand - Select a card to play</div>
                    <div class="hand" id="player-hand"></div>
                </div>

                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn-play" id="play-btn" disabled>Play Card</button>
                    <button class="btn-new-game" id="new-game-btn" onclick="newGame()">New Game</button>
                    <button class="btn-help" id="help-btn" onclick="showTutorial()">?</button>
                </div>
            </div>

            <!-- Right Sidebar: Mode Selection + Battle Log -->
            <div class="right-sidebar">
                <!-- Multiplier Display -->
                <div class="multiplier-display" id="multiplier-display">
                    Damage Multiplier: x1
                </div>

                <!-- Mode Selection -->
                <div class="mode-selection">
                    <button class="mode-btn active" id="mode-ai" onclick="setMode('ai')">vs AI</button>
                    <button class="mode-btn" id="mode-pvp" onclick="setMode('pvp')">vs Player</button>
                </div>

                <!-- Leaderboards Button -->
                <button class="btn-leaderboard-main" onclick="openLeaderboard()"> Leaderboards</button>
                <button class="btn-profile-main" onclick="openProfile()"> Player Profile</button>

                <!-- AI Difficulty Selection -->
                <div class="difficulty-selection show" id="difficulty-selection">
                    <div class="difficulty-label">AI Difficulty</div>
                    <div class="difficulty-buttons">
                        <button class="difficulty-btn easy" id="diff-easy" onclick="setAIDifficulty('easy')">
                            Easy
                            <div class="difficulty-desc">Random plays</div>
                        </button>
                        <button class="difficulty-btn medium active" id="diff-medium" onclick="setAIDifficulty('medium')">
                            Medium
                            <div class="difficulty-desc">Prefers good cards</div>
                        </button>
                        <button class="difficulty-btn hard" id="diff-hard" onclick="setAIDifficulty('hard')">
                            Hard
                            <div class="difficulty-desc">Smart decisions</div>
                        </button>
                        <button class="difficulty-btn god" id="diff-god" onclick="setAIDifficulty('god')">
                            God Mode
                            <div class="difficulty-desc">Beyond mortal</div>
                        </button>
                    </div>
                </div>

                <div class="feedback-btn-container">
                    <button class="btn-feedback" onclick="openFeedback()"> Report Bug / Feedback</button>
                </div>

                <div class="battle-log">
                    <h3>Battle Log</h3>
                    <div id="log-content">
                        <div class="log-entry info">Game started! Select a card from your hand.</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Game Over Overlay -->
    <div class="game-over-overlay" id="game-over" onclick="dismissGameOver(event)">
        <div class="game-over-content" id="game-over-content">
            <h2 id="game-over-title">Victory!</h2>
            <p id="game-over-text">You have defeated your opponent!</p>
            <p class="game-over-hint">Click anywhere to view battle log</p>
        </div>
    </div>

    <!-- Achievement Modal -->
    <div class="achievement-modal" id="achievement-modal">
        <div class="achievement-modal-content">
            <div class="achievement-modal-header">
                <h2>All Achievements</h2>
                <button class="btn-close-modal" onclick="closeAchievementModal()"></button>
            </div>
            <p class="achievement-modal-hint">Click any unlocked achievement to display it</p>
            <div class="achievement-modal-body" id="achievement-modal-body">
            </div>
        </div>
    </div>

    <!-- Pathway Table Modal -->
    <div class="pathway-modal" id="pathway-modal">
        <div class="pathway-modal-content">
            <div class="pathway-modal-header">
                <h2>Complete Pathway Guide</h2>
                <button class="btn-close-modal" onclick="closePathwayTable()"> Close</button>
            </div>

            <!-- Inner God Summons Section (only in Inner vs Outer mode) -->
            <div class="inner-god-summon-section" id="inner-god-summon-section">
                <h3 class="summon-section-title"> Inner God Summons</h3>
                <p class="summon-section-desc">Collect all required pathways to summon these powerful Above the Sequences</p>
                <div class="inner-god-summon-grid" id="inner-god-summon-grid"></div>
            </div>

            <table class="pathway-table">
                <thead>
                    <tr>
                        <th></th>
                        <th>Pathway</th>
                        <th>Summary</th>
                        <th>Description</th>
                        <th>Abilities</th>
                    </tr>
                </thead>
                <tbody id="pathway-table-body">
                </tbody>
            </table>
        </div>
    </div>

    <!-- Leaderboard Modal -->
    <div class="leaderboard-modal" id="leaderboard-modal">
        <div class="leaderboard-modal-content">
            <div class="leaderboard-modal-header">
                <h2>Leaderboards</h2>
                <button class="btn-close-modal" onclick="closeLeaderboard()"> Close</button>
            </div>

            <!-- Main tabs -->
            <div class="leaderboard-tabs">
                <button class="leaderboard-tab active" id="tab-overall" onclick="switchLeaderboardTab('overall')">Overall</button>
                <button class="leaderboard-tab" id="tab-gameType" onclick="switchLeaderboardTab('gameType')">Game Mode</button>
                <button class="leaderboard-tab" id="tab-opponent" onclick="switchLeaderboardTab('opponent')">Opponent</button>
                <button class="leaderboard-tab" id="tab-difficulty" onclick="switchLeaderboardTab('difficulty')">AI Difficulty</button>
            </div>

            <!-- Sub-tabs (shown conditionally) -->
            <div class="leaderboard-sub-tabs" id="leaderboard-sub-tabs"></div>

            <!-- Table -->
            <div class="leaderboard-table-container">
                <table class="leaderboard-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Player</th>
                            <th>Wins</th>
                            <th>Games</th>
                            <th>Win Rate</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboard-body"></tbody>
                </table>
            </div>

            <div class="leaderboard-loading" id="leaderboard-loading">Loading...</div>
            <div class="leaderboard-empty" id="leaderboard-empty">No data yet.</div>
        </div>
    </div>

    <!-- Player Profile Modal -->
    <div class="profile-modal" id="profile-modal">
        <div class="profile-modal-content">
            <div class="profile-modal-header">
                <h2 id="profile-modal-title">Player Profile</h2>
                <button class="btn-close-modal" onclick="closeProfile()"> Close</button>
            </div>

            <!-- Profile Search (for viewing others) -->
            <div class="profile-search" id="profile-search">
                <input type="text" id="profile-search-input" placeholder="Enter player code..." maxlength="10">
                <button class="btn-profile-search" onclick="searchPlayerProfile()">Search</button>
            </div>

            <!-- Profile Content -->
            <div class="profile-content" id="profile-content">
                <!-- Player Header -->
                <div class="profile-header">
                    <div class="profile-avatar" id="profile-avatar">?</div>
                    <div class="profile-info">
                        <div class="profile-name" id="profile-name">Player</div>
                        <div class="profile-title-container">
                            <div class="profile-title title-text" id="profile-title"></div>
                            <button class="btn-change-title" id="btn-change-title" onclick="openTitleSelector()" style="display:none;">Change</button>
                        </div>
                        <div class="profile-code" id="profile-code">#0000</div>
                    </div>
                    <div class="profile-badge" id="profile-badge"></div>
                </div>

                <!-- Title Selector (for GMs) -->
                <div class="title-selector" id="title-selector" style="display:none;">
                    <h4>Select Title</h4>
                    <div class="title-selector-list" id="title-selector-list"></div>
                </div>

                <!-- Stats Section -->
                <div class="profile-section">
                    <h3>Statistics</h3>
                    <div class="profile-stats-grid">
                        <div class="profile-stat">
                            <span class="stat-value" id="profile-wins">0</span>
                            <span class="stat-label">Wins</span>
                        </div>
                        <div class="profile-stat">
                            <span class="stat-value" id="profile-losses">0</span>
                            <span class="stat-label">Losses</span>
                        </div>
                        <div class="profile-stat">
                            <span class="stat-value" id="profile-games">0</span>
                            <span class="stat-label">Games</span>
                        </div>
                        <div class="profile-stat">
                            <span class="stat-value" id="profile-winrate">0%</span>
                            <span class="stat-label">Win Rate</span>
                        </div>
                    </div>
                </div>

                <!-- Game Mode Stats -->
                <div class="profile-section">
                    <h3>Game Modes</h3>
                    <div class="profile-mode-stats" id="profile-mode-stats"></div>
                </div>

                <!-- Titles Section -->
                <div class="profile-section">
                    <h3>Titles Earned</h3>
                    <div class="profile-titles" id="profile-titles">
                        <div class="profile-empty">No titles earned yet</div>
                    </div>
                </div>

                <!-- Achievements Section -->
                <div class="profile-section">
                    <h3>Achievements</h3>
                    <div class="profile-achievements-summary" id="profile-achievements-summary">
                        <span id="profile-ach-count">0</span> / <span id="profile-ach-total">0</span> Achievements
                    </div>
                    <div class="profile-achievements" id="profile-achievements">
                        <div class="profile-empty">No achievements yet</div>
                    </div>
                </div>
            </div>

            <div class="profile-loading" id="profile-loading">Loading profile...</div>
            <div class="profile-error" id="profile-error">Player not found.</div>

            <!-- View Own Profile Button (when viewing others) -->
            <div class="profile-footer" id="profile-footer">
                <button class="btn-view-own" onclick="openOwnProfile()">View My Profile</button>
            </div>
        </div>
    </div>

    <!-- Battle Detail Modal -->
    <div class="battle-detail-modal" id="battle-detail-modal">
        <div class="battle-detail-content">
            <div class="battle-detail-header">
                <h2>Battle Details</h2>
                <button class="btn-close-modal" onclick="closeBattleDetail()"> Close</button>
            </div>
            <div class="battle-detail-body" id="battle-detail-body">
                <div class="battle-detail-placeholder">
                    Battle details will be displayed here.
                </div>
            </div>
        </div>
    </div>

    <!-- Feedback Modal -->
    <div class="feedback-modal" id="feedback-modal">
        <div class="feedback-content">
            <div class="feedback-header">
                <h2>Send Feedback</h2>
            </div>
            <div class="feedback-body">
                <a href="https://discord.gg/62gpGPtmsQ" target="_blank" class="btn-discord">Join our Discord Community</a>
                <div class="feedback-divider"><span>OR SEND ANONYMOUS FEEDBACK</span></div>
                <div class="feedback-form-group">
                    <label>Type</label>
                    <select class="feedback-select" id="fb-type">
                        <option value="bug">Bug Report</option>
                        <option value="balance">Balance Suggestion</option>
                        <option value="feature">Feature Request</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                
                <!-- HONEYPOT FIELD (Hidden) -->
                <input type="text" id="website_url" class="honey-trap" tabindex="-1" autocomplete="off">
                
                <div class="feedback-form-group">
                    <label>Message</label>
                    <textarea class="feedback-textarea" id="fb-message" placeholder="What is on your mind?"></textarea>
                </div>

                <div class="feedback-form-group">
                    <label>Contact (Optional)</label>
                    <input type="text" class="feedback-input" id="fb-contact" placeholder="Discord or Email if you want a reply">
                </div>

                <div class="action-buttons">
                    <button class="btn-play" onclick="submitFeedback()">Submit</button>
                    <button class="btn-new-game" onclick="closeFeedback()">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Ability Effect Modal -->
    <div class="ability-modal" id="ability-modal">
        <div class="ability-modal-content">
            <div class="ability-modal-header">
                <h2 id="ability-modal-title">Ability Effect</h2>
                <p id="ability-modal-subtitle"></p>
            </div>
            <div class="ability-modal-body" id="ability-modal-body">
                <!-- Dynamic content inserted here -->
            </div>
            <div class="ability-modal-buttons" id="ability-modal-buttons">
                <!-- Dynamic buttons inserted here -->
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // THEME TOGGLE (Light/Dark Mode)
        // ============================================
        function toggleTheme() {
            const body = document.body;
            const icon = document.getElementById('theme-icon');

            if (body.classList.contains('light-mode')) {
                body.classList.remove('light-mode');
                icon.textContent = '';
                localStorage.setItem('pathwayClash_theme', 'dark');
            } else {
                body.classList.add('light-mode');
                icon.textContent = '';
                localStorage.setItem('pathwayClash_theme', 'light');
            }
        }

        // Initialize theme from saved preference
        (function initTheme() {
            const savedTheme = localStorage.getItem('pathwayClash_theme');
            const icon = document.getElementById('theme-icon');

            if (savedTheme === 'light') {
                document.body.classList.add('light-mode');
                if (icon) icon.textContent = '';
            }
        })();

        // ============================================
        // DOM ELEMENT CACHE (Performance Optimization)
        // ============================================
        // Cache frequently accessed DOM elements to avoid repeated getElementById calls
        const DOM = {
            _cache: {},
            get(id) {
                if (!this._cache[id]) {
                    this._cache[id] = document.getElementById(id);
                }
                return this._cache[id];
            },
            // Clear cache (call if elements are dynamically replaced)
            clear(id) {
                if (id) {
                    delete this._cache[id];
                } else {
                    this._cache = {};
                }
            }
        };

        // ============================================
        // SHARED FIREBASE CONFIGURATION
        // ============================================
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyCVt-PrFmAOXTproKCbMyW6GvCjfzhk-LQ",
            authDomain: "lotm-game.firebaseapp.com",
            databaseURL: "https://lotm-game-default-rtdb.firebaseio.com",
            projectId: "lotm-game",
            storageBucket: "lotm-game.firebasestorage.app",
            messagingSenderId: "1042718576272",
            appId: "1:1042718576272:web:ac0116ca2877c6e4231215"
        };

        // Shared Firebase instance
        let firebaseInitialized = false;
        let sharedDatabase = null;

        function ensureFirebaseInitialized() {
            if (!firebaseInitialized && FIREBASE_CONFIG.apiKey !== "YOUR_API_KEY") {
                if (firebase.apps.length === 0) {
                    firebase.initializeApp(FIREBASE_CONFIG);
                }
                sharedDatabase = firebase.database();
                firebaseInitialized = true;
            }
            return sharedDatabase;
        }

        // ============================================
        // FEEDBACK SYSTEM
        // ============================================
        let feedbackOpenTime = 0;

        function openFeedback() {
            DOM.get("feedback-modal").classList.add("active");
            feedbackOpenTime = Date.now(); // Start the timer

            // Clear previous inputs
            DOM.get("fb-message").value = "";
            DOM.get("website_url").value = ""; // Clear honeypot
        }

        function closeFeedback() {
            DOM.get("feedback-modal").classList.remove("active");
        }

        function submitFeedback() {
            const db = ensureFirebaseInitialized();
            if (!db) {
                alert("Database not connected. Cannot send feedback.");
                return;
            }

            // 1. HONEYPOT CHECK
            const honey = DOM.get("website_url").value;
            if (honey !== "") {
                console.log("Spam detected.");
                closeFeedback();
                return; // Silently fail for bots
            }

            // 2. TIME TRAP CHECK (Must take at least 2 seconds)
            const timeTaken = Date.now() - feedbackOpenTime;
            if (timeTaken < 2000) {
                console.log("Too fast. Bot detected.");
                closeFeedback();
                return; // Silently fail
            }

            const type = DOM.get("fb-type").value;
            const message = DOM.get("fb-message").value.trim();
            const contact = DOM.get("fb-contact").value.trim();

            if (!message) {
                alert("Please enter a message.");
                return;
            }

            // Send to Firebase
            const feedbackRef = db.ref("feedback").push();
            feedbackRef.set({
                type: type,
                message: message,
                contact: contact,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                playerCode: playerCode || "Anonymous",
                gameMode: gameMode, // Global variable from game state
                userAgent: navigator.userAgent
            }).then(() => {
                alert("Feedback sent! Thank you.");
                closeFeedback();
            }).catch(error => {
                console.error("Error sending feedback:", error);
                alert("Error sending feedback. Please try again.");
            });
        }

        // ============================================
        // PLAYER IDENTIFICATION SYSTEM (Firebase-backed)
        // ============================================
        let playerCode = localStorage.getItem('pathwayClash_playerCode') || null;
        let playerDb = null; // Firebase database reference for player system

        function initPlayerFirebase() {
            if (!playerDb) {
                playerDb = ensureFirebaseInitialized();
            }
            return playerDb;
        }

        function initWelcomeScreen() {
            if (playerCode) {
                // Returning player on same device - show welcome back
                DOM.get('welcome-choice').classList.add('hidden');
                DOM.get('welcome-back').classList.remove('hidden');
                DOM.get('existing-player-code').textContent = playerCode;
                updatePlayerStatsDisplay();
            }
            // else - show the default choice screen (already visible)
        }

        async function setupNewPlayer() {
            // Show loading state
            const choiceDiv = DOM.get('welcome-choice');
            const newPlayerDiv = DOM.get('welcome-new-player');
            const codeDisplay = DOM.get('new-player-code');

            choiceDiv.classList.add('hidden');
            newPlayerDiv.classList.remove('hidden');
            codeDisplay.textContent = '....';
            codeDisplay.classList.add('loading');

            try {
                initPlayerFirebase();

                // Use Firebase transaction to atomically get and increment the counter
                const counterRef = playerDb.ref('playerCounter');

                const result = await counterRef.transaction((currentValue) => {
                    // Start from 1 if no counter exists
                    return (currentValue || 0) + 1;
                });

                if (result.committed) {
                    // Format as 4-digit code (will grow beyond 4 digits after 9999 players)
                    playerCode = String(result.snapshot.val()).padStart(4, '0');

                    // Register this player code in Firebase
                    await playerDb.ref('players/' + playerCode).set({
                        createdAt: firebase.database.ServerValue.TIMESTAMP,
                        lastSeen: firebase.database.ServerValue.TIMESTAMP
                    });

                    // Save locally
                    localStorage.setItem('pathwayClash_playerCode', playerCode);

                    // Show the code and enable continue button
                    codeDisplay.classList.remove('loading');
                    codeDisplay.textContent = playerCode;
                    DOM.get('new-player-continue-btn').disabled = false;
                } else {
                    throw new Error('Transaction failed');
                }
            } catch (error) {
                console.error('Error creating player code:', error);
                codeDisplay.classList.remove('loading');
                codeDisplay.textContent = 'Error';
                alert('Could not connect to server. Please check your internet connection and try again.');
                showWelcomeChoice();
            }
        }

        function confirmNewPlayer() {
            // Hide welcome screen
            DOM.get('welcome-screen').classList.add('hidden');

            // Check if tutorial should be shown
            if (shouldShowTutorial()) {
                // Show tutorial prompt for new players
                showTutorialPrompt();
            } else {
                // Skip to intro screen
                DOM.get('intro-screen').classList.remove('hidden');
            }
        }

        function showReturningPlayerInput() {
            DOM.get('welcome-choice').classList.add('hidden');
            DOM.get('welcome-back').classList.add('hidden');
            DOM.get('welcome-returning').classList.remove('hidden');
            const codeError = DOM.get('code-error');
            codeError.classList.add('hidden');
            codeError.textContent = 'Invalid code format. Please enter numbers only.';
            const returningInput = DOM.get('returning-code-input');
            returningInput.value = '';
            returningInput.focus();
        }

        function showWelcomeChoice() {
            DOM.get('welcome-returning').classList.add('hidden');
            DOM.get('welcome-new-player').classList.add('hidden');
            DOM.get('welcome-back').classList.add('hidden');
            DOM.get('welcome-choice').classList.remove('hidden');
        }

        function skipPlayerCode() {
            // Skip player code - mainly for GMs to avoid taking up number slots
            playerCode = null;
            localStorage.removeItem('pathwayClash_playerCode');
            DOM.get('welcome-screen').classList.add('hidden');
            DOM.get('intro-screen').classList.remove('hidden');
            // Update tutorial menu button
            updateTutorialMenuButton();
        }

        async function submitReturningCode() {
            const input = DOM.get('returning-code-input');
            const errorEl = DOM.get('code-error');
            const code = input.value.trim();

            // Validate: must be numeric (any length, will be padded)
            if (!/^\d+$/.test(code)) {
                errorEl.textContent = 'Invalid code format. Please enter numbers only.';
                errorEl.classList.remove('hidden');
                input.focus();
                return;
            }

            // Pad to at least 4 digits
            const paddedCode = code.padStart(4, '0');

            try {
                initPlayerFirebase();

                // Check if this player code exists in Firebase
                const playerRef = playerDb.ref('players/' + paddedCode);
                const snapshot = await playerRef.once('value');

                if (!snapshot.exists()) {
                    errorEl.textContent = 'Player code not found. Please check your code or create a new account.';
                    errorEl.classList.remove('hidden');
                    input.focus();
                    return;
                }

                // Valid code - update last seen and save locally
                await playerRef.update({
                    lastSeen: firebase.database.ServerValue.TIMESTAMP
                });

                playerCode = paddedCode;
                localStorage.setItem('pathwayClash_playerCode', playerCode);

                // Proceed to tutorial
                DOM.get('welcome-screen').classList.add('hidden');
                DOM.get('intro-screen').classList.remove('hidden');
            } catch (error) {
                console.error('Error verifying player code:', error);
                errorEl.textContent = 'Could not verify code. Please check your internet connection.';
                errorEl.classList.remove('hidden');
            }
        }

        function continueExistingPlayer() {
            // Update last seen in Firebase
            try {
                initPlayerFirebase();
                playerDb.ref('players/' + playerCode).update({
                    lastSeen: firebase.database.ServerValue.TIMESTAMP
                });
            } catch (e) {
                // Non-critical, continue anyway
            }

            // Player is continuing with their existing code
            DOM.get('welcome-screen').classList.add('hidden');
            DOM.get('intro-screen').classList.remove('hidden');

            // Update tutorial menu button (they can access it manually if needed)
            updateTutorialMenuButton();
        }

        // Initialize welcome screen on page load
        document.addEventListener('DOMContentLoaded', initWelcomeScreen);

        // Allow Enter key to submit returning code
        document.addEventListener('DOMContentLoaded', function() {
            const returningInput = DOM.get('returning-code-input');
            if (returningInput) {
                returningInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        submitReturningCode();
                    }
                });
            }

            // Initialize AI difficulty buttons
            if (typeof initDifficultyButtons === 'function') {
                initDifficultyButtons();
            }
        });

        // ============================================
        // INTRO SCREEN
        // ============================================
        function startGame() {
            updatePlayerStatsDisplay();
            const introScreen = DOM.get('intro-screen');
            introScreen.classList.add('hidden');
            introScreen.classList.remove('overlay-mode');
            DOM.get('game-container').classList.remove('hidden');
            resetGameState();
            // Don't auto-start - wait for user to click New Game
            // Show the New Game button so player can start
            DOM.get('new-game-btn').classList.add('show');
        }

        function showTutorial() {
            const introScreen = DOM.get('intro-screen');
            introScreen.classList.remove('hidden');
            introScreen.classList.add('overlay-mode');
        }

        function hideTutorial() {
            const introScreen = DOM.get('intro-screen');
            introScreen.classList.add('hidden');
            introScreen.classList.remove('overlay-mode');

            // Mark tutorial as completed
            localStorage.setItem('pathwayClash_tutorialDone', 'true');
            tutorialCompleted = true;
        }

        // ============================================
        // SECRET CODE EASTER EGG
        // ============================================
        let secretClickTimes = [];
        const SECRET_CLICK_COUNT = 3;
        const SECRET_CLICK_WINDOW = 5000; // 5 seconds

        function handleSecretClick() {
            const now = Date.now();
            secretClickTimes.push(now);

            // Remove clicks older than 5 seconds
            secretClickTimes = secretClickTimes.filter(time => now - time < SECRET_CLICK_WINDOW);

            if (secretClickTimes.length >= SECRET_CLICK_COUNT) {
                secretClickTimes = [];
                openSecretPopup();
            }
        }

        let currentSecretTab = 'panel';

        function openSecretPopup() {
            document.getElementById('secret-popup').classList.add('show');
            document.getElementById('secret-code-input').value = '';
            document.getElementById('gm-signin-input').value = '';
            document.getElementById('secret-message').textContent = '';
            document.getElementById('secret-message').className = 'secret-message';
            switchSecretTab('panel');
        }

        function closeSecretPopup() {
            document.getElementById('secret-popup').classList.remove('show');
        }

        function switchSecretTab(tab) {
            currentSecretTab = tab;

            // Update tab buttons
            document.getElementById('tab-panel').classList.toggle('active', tab === 'panel');
            document.getElementById('tab-signin').classList.toggle('active', tab === 'signin');

            // Update tab content
            document.getElementById('secret-panel-content').classList.toggle('hidden', tab !== 'panel');
            document.getElementById('secret-signin-content').classList.toggle('hidden', tab !== 'signin');

            // Clear message and focus appropriate input
            document.getElementById('secret-message').textContent = '';
            document.getElementById('secret-message').className = 'secret-message';

            if (tab === 'panel') {
                document.getElementById('secret-code-input').focus();
            } else {
                document.getElementById('gm-signin-input').focus();
            }
        }

        function submitSecretCode() {
            const messageEl = document.getElementById('secret-message');

            if (currentSecretTab === 'panel') {
                // GM Panel access (4-digit code)
                const code = document.getElementById('secret-code-input').value;

                if (code.length !== 4 || !/^\d{4}$/.test(code)) {
                    messageEl.textContent = 'Please enter a 4-digit code';
                    messageEl.className = 'secret-message error';
                    return;
                }

                // GM Code: 1617
                if (code === '1617') {
                    closeSecretPopup();
                    openGMPanel();
                } else {
                    messageEl.textContent = 'Invalid code';
                    messageEl.className = 'secret-message error';
                }
            } else {
                // GM Sign In (7-character code: gmhaha1, gmhaha2, or gmhaha3)
                const code = document.getElementById('gm-signin-input').value.toLowerCase();

                if (code === 'gmhaha1') {
                    // Sign in as GM 1
                    playerCode = 'GM001';
                    localStorage.setItem('pathwayClash_playerCode', playerCode);
                    messageEl.textContent = 'Signed in as GM 1';
                    messageEl.className = 'secret-message success';
                    setTimeout(() => {
                        closeSecretPopup();
                        document.getElementById('welcome-screen').classList.add('hidden');
                        document.getElementById('intro-screen').classList.remove('hidden');
                    }, 1000);
                } else if (code === 'gmhaha2') {
                    // Sign in as GM 2
                    playerCode = 'GM002';
                    localStorage.setItem('pathwayClash_playerCode', playerCode);
                    messageEl.textContent = 'Signed in as GM 2';
                    messageEl.className = 'secret-message success';
                    setTimeout(() => {
                        closeSecretPopup();
                        document.getElementById('welcome-screen').classList.add('hidden');
                        document.getElementById('intro-screen').classList.remove('hidden');
                    }, 1000);
                } else if (code === 'gmhaha3') {
                    // Sign in as GM 3
                    playerCode = 'GM003';
                    localStorage.setItem('pathwayClash_playerCode', playerCode);
                    messageEl.textContent = 'Signed in as GM 3';
                    messageEl.className = 'secret-message success';
                    setTimeout(() => {
                        closeSecretPopup();
                        document.getElementById('welcome-screen').classList.add('hidden');
                        document.getElementById('intro-screen').classList.remove('hidden');
                    }, 1000);
                } else {
                    messageEl.textContent = 'Invalid GM credentials';
                    messageEl.className = 'secret-message error';
                }
            }
        }

        // ============================================
        // GM PANEL (Achievement Testing)
        // ============================================
        function openGMPanel() {
            const panel = document.getElementById('gm-panel');
            const list = document.getElementById('gm-achievement-list');
            list.innerHTML = '';

            // Group achievements by difficulty
            const grouped = {};
            for (const [id, ach] of Object.entries(ACHIEVEMENTS)) {
                const diff = ach.difficulty || 1;
                if (!grouped[diff]) grouped[diff] = [];
                grouped[diff].push({ id, ...ach });
            }

            // Sort by difficulty
            const sortedDiffs = Object.keys(grouped).sort((a, b) => Number(a) - Number(b));

            for (const diff of sortedDiffs) {
                const section = document.createElement('div');
                section.className = 'gm-section';

                const header = document.createElement('div');
                header.className = 'gm-section-header';
                header.textContent = ''.repeat(Number(diff)) + ` Difficulty ${diff}`;
                section.appendChild(header);

                for (const ach of grouped[diff]) {
                    const item = document.createElement('div');
                    const isUnlocked = unlockedAchievements.includes(ach.id);
                    item.className = 'gm-achievement-item' + (isUnlocked ? ' unlocked' : '');
                    item.innerHTML = `
                        <span class="gm-ach-icon">${ach.icon}</span>
                        <div class="gm-ach-info">
                            <div class="gm-ach-name">${ach.name}</div>
                            <div class="gm-ach-desc">${ach.desc}</div>
                        </div>
                        <span class="gm-ach-status">${isUnlocked ? '' : 'Click to unlock'}</span>
                    `;
                    if (!isUnlocked) {
                        item.onclick = () => gmUnlockAchievement(ach.id);
                    }
                    section.appendChild(item);
                }

                list.appendChild(section);
            }

            // Add Hidden Triumphs section grouped by difficulty
            const triumphSection = document.createElement('div');
            triumphSection.className = 'gm-section gm-triumph-section';

            const triumphMainHeader = document.createElement('div');
            triumphMainHeader.className = 'gm-section-header gm-triumph-header';
            triumphMainHeader.textContent = ' Hidden Triumphs (Grant Titles)';
            triumphSection.appendChild(triumphMainHeader);

            // Group triumphs by difficulty
            const triumphsByDiff = {};
            for (const [id, triumph] of Object.entries(HIDDEN_TRIUMPHS)) {
                const diff = triumph.difficulty || 5;
                if (!triumphsByDiff[diff]) triumphsByDiff[diff] = [];
                triumphsByDiff[diff].push({ id, ...triumph });
            }

            // Sort and display by difficulty
            const triumphDiffs = Object.keys(triumphsByDiff).sort((a, b) => Number(a) - Number(b));
            for (const diff of triumphDiffs) {
                const diffHeader = document.createElement('div');
                diffHeader.className = 'gm-section-header';
                diffHeader.style.cssText = 'font-size: 12px; color: #aa44ff; margin-top: 10px;';
                diffHeader.textContent = ''.repeat(1) + ` Difficulty ${diff}`;
                triumphSection.appendChild(diffHeader);

                for (const triumph of triumphsByDiff[diff]) {
                    const item = document.createElement('div');
                    const isUnlocked = unlockedTriumphs.includes(triumph.id);
                    item.className = 'gm-achievement-item gm-triumph-item' + (isUnlocked ? ' unlocked' : '');
                    item.innerHTML = `
                        <span class="gm-ach-icon">${triumph.icon}</span>
                        <div class="gm-ach-info">
                            <div class="gm-ach-name title-text ${triumph.titleEffect}">${triumph.title}</div>
                            <div class="gm-ach-desc">${triumph.desc}</div>
                            <div class="gm-triumph-name" style="font-size: 10px; color: #777;">${triumph.name}</div>
                        </div>
                        <span class="gm-ach-status">${isUnlocked ? '' : 'Click to unlock'}</span>
                    `;
                    if (!isUnlocked) {
                        item.onclick = () => gmUnlockTriumph(triumph.id);
                    }
                    triumphSection.appendChild(item);
                }
            }

            list.appendChild(triumphSection);

            panel.classList.add('show');
        }

        function closeGMPanel() {
            document.getElementById('gm-panel').classList.remove('show');
        }

        function gmUnlockAchievement(achievementId) {
            if (!unlockedAchievements.includes(achievementId)) {
                unlockedAchievements.push(achievementId);
                localStorage.setItem('pathwayClash_achievements', JSON.stringify(unlockedAchievements));
                showAchievementNotification(achievementId);
                updateAchievementDisplay();
                // Refresh the GM panel to show updated status
                openGMPanel();
            }
        }

        function gmUnlockTriumph(triumphId) {
            if (!unlockedTriumphs.includes(triumphId)) {
                unlockedTriumphs.push(triumphId);
                localStorage.setItem('pathwayClash_triumphs', JSON.stringify(unlockedTriumphs));
                showTriumphNotification(triumphId);
                updateAchievementDisplay();
                // Auto-equip the title if no title is active
                if (!activeTitle) {
                    setActiveTitle(triumphId);
                }
                // Refresh the GM panel to show updated status
                openGMPanel();
            }
        }

        function gmResetAllAchievements() {
            if (confirm('Reset ALL achievements and triumphs? This cannot be undone.')) {
                unlockedAchievements = [];
                unlockedTriumphs = [];
                activeTitle = null;
                localStorage.setItem('pathwayClash_achievements', JSON.stringify(unlockedAchievements));
                localStorage.setItem('pathwayClash_triumphs', JSON.stringify(unlockedTriumphs));
                localStorage.removeItem('pathwayClash_activeTitle');
                updateAchievementDisplay();
                updateTitleDisplay();
                openGMPanel();
            }
        }

        // Allow Enter key to submit, Escape to close
        document.addEventListener('DOMContentLoaded', function() {
            const secretInput = document.getElementById('secret-code-input');
            if (secretInput) {
                secretInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        submitSecretCode();
                    }
                });
            }

            const gmSigninInput = document.getElementById('gm-signin-input');
            if (gmSigninInput) {
                gmSigninInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        submitSecretCode();
                    }
                });
            }

            // Click outside to close
            document.getElementById('secret-popup').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeSecretPopup();
                }
            });

            document.getElementById('gm-panel').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeGMPanel();
                }
            });

            // Escape key to close
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    if (document.getElementById('gm-panel').classList.contains('show')) {
                        closeGMPanel();
                    } else if (document.getElementById('secret-popup').classList.contains('show')) {
                        closeSecretPopup();
                    }
                }
            });
        });

        // ============================================
        // PATHWAY DETAIL VIEW
        // ============================================
        function showPathwayDetail(pathwayName) {
            const pathway = getCurrentPathways().find(p => p.name === pathwayName);
            if (!pathway) return;

            document.getElementById('pathway-grid').classList.add('hidden');
            document.getElementById('pathway-grid-title').classList.add('hidden');
            document.getElementById('pathway-detail').classList.add('active');

            document.getElementById('detail-icon').src = pathway.icon;
            document.getElementById('detail-icon').alt = pathway.name;
            document.getElementById('detail-name').textContent = pathway.name;
            document.getElementById('detail-flavor').textContent = pathway.flavor;
            document.getElementById('detail-description').textContent = pathway.description || 'No description yet.';

            const abilitiesList = document.getElementById('detail-abilities');
            abilitiesList.innerHTML = '';
            if (pathway.abilities && Array.isArray(pathway.abilities)) {
                pathway.abilities.forEach(ability => {
                    const li = document.createElement('li');
                    li.innerHTML = `<span class="ability-name">${ability.name}:</span> ${ability.desc}`;
                    abilitiesList.appendChild(li);
                });
            } else {
                const li = document.createElement('li');
                li.textContent = 'No abilities listed yet.';
                abilitiesList.appendChild(li);
            }
        }

        function showPathwayGrid() {
            document.getElementById('pathway-grid').classList.remove('hidden');
            document.getElementById('pathway-grid-title').classList.remove('hidden');
            document.getElementById('pathway-detail').classList.remove('active');
        }

        // ============================================
        // PATHWAY TABLE MODAL
        // ============================================
        let pathwayTablePopulated = false;
        let innerGodSummonGridPopulated = false;

        function openPathwayTable(scrollToSummons = false) {
            const modal = document.getElementById('pathway-modal');
            const summonSection = document.getElementById('inner-god-summon-section');
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';

            // Show/hide summon section based on game type
            if (gameType === 'inner_vs_outer') {
                summonSection.classList.add('visible');
                if (!innerGodSummonGridPopulated) {
                    populateInnerGodSummonGrid();
                    innerGodSummonGridPopulated = true;
                }
                // Scroll to summon section if requested
                if (scrollToSummons) {
                    setTimeout(() => summonSection.scrollIntoView({ behavior: 'smooth' }), 100);
                }
            } else {
                summonSection.classList.remove('visible');
            }

            // Populate table on first open
            if (!pathwayTablePopulated) {
                populatePathwayTable();
                pathwayTablePopulated = true;
            }

            // Trigger tutorial event for pathway reference opened
            handleTutorialEvent('pathwaysOpened');
        }

        function populateInnerGodSummonGrid() {
            const grid = document.getElementById('inner-god-summon-grid');
            grid.innerHTML = '';

            INNER_GODS.forEach(god => {
                const card = document.createElement('div');
                card.className = 'summon-card';

                // Get pathway icons
                const pathwayIconsHtml = god.combinedPathways.map(pathwayName => {
                    const pathway = PATHWAYS.find(p => p.name === pathwayName);
                    if (pathway) {
                        return `<img src="${pathway.icon}" alt="${pathwayName}" title="${pathwayName}" class="summon-pathway-icon">`;
                    }
                    return '';
                }).join('');

                card.innerHTML = `
                    <img src="${god.icon}" alt="${god.name}" class="summon-card-icon">
                    <div class="summon-card-info">
                        <div class="summon-card-name">${god.name}</div>
                        <div class="summon-card-pathways">${pathwayIconsHtml}</div>
                    </div>
                `;

                grid.appendChild(card);
            });
        }

        function closePathwayTable() {
            const modal = document.getElementById('pathway-modal');
            modal.classList.remove('active');
            document.body.style.overflow = '';
        }

        function populatePathwayTable() {
            const tbody = document.getElementById('pathway-table-body');
            tbody.innerHTML = '';

            getCurrentPathways().forEach(pathway => {
                const row = document.createElement('tr');

                // Format abilities
                let abilitiesHtml = '';
                if (pathway.abilities && Array.isArray(pathway.abilities)) {
                    abilitiesHtml = pathway.abilities.map(a =>
                        `<div class="ability-item"><strong>${a.name}:</strong> ${a.desc}</div>`
                    ).join('');
                }

                row.innerHTML = `
                    <td class="pathway-icon-cell"><img src="${pathway.icon}" alt="${pathway.name}"></td>
                    <td class="pathway-name-cell">${pathway.name}</td>
                    <td class="pathway-flavor-cell">${pathway.flavor}</td>
                    <td class="pathway-desc-cell">${pathway.description || 'No description yet.'}</td>
                    <td class="pathway-abilities-cell">${abilitiesHtml || 'No abilities listed.'}</td>
                `;

                tbody.appendChild(row);
            });
        }

        // Close modal on escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closePathwayTable();
                closeLeaderboard();
                closeProfile();
            }
        });

        // ============================================
        // LEADERBOARD SYSTEM
        // ============================================
        let currentLeaderboardTab = 'overall';
        let currentLeaderboardSubTab = null;
        let leaderboardCache = {};

        // Sub-tab configurations
        const leaderboardSubTabs = {
            gameType: [
                { key: 'pathways', label: 'Pathways' },
                { key: 'outer_deities', label: 'Outer Deities' },
                { key: 'inner_vs_outer', label: 'Inner vs Outer' }
            ],
            opponent: [
                { key: 'ai', label: 'vs AI' },
                { key: 'pvp', label: 'vs Players' }
            ],
            difficulty: [
                { key: 'easy', label: 'Easy' },
                { key: 'medium', label: 'Medium' },
                { key: 'hard', label: 'Hard' },
                { key: 'god', label: 'God' }
            ]
        };

        function openLeaderboard() {
            const modal = document.getElementById('leaderboard-modal');
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';

            // Reset to overall tab
            switchLeaderboardTab('overall');
        }

        function closeLeaderboard() {
            const modal = document.getElementById('leaderboard-modal');
            modal.classList.remove('active');
            document.body.style.overflow = '';
        }

        function switchLeaderboardTab(tab) {
            currentLeaderboardTab = tab;

            // Update tab active states
            document.querySelectorAll('.leaderboard-tab').forEach(t => {
                t.classList.remove('active');
            });
            document.getElementById('tab-' + tab).classList.add('active');

            // Handle sub-tabs
            const subTabsContainer = document.getElementById('leaderboard-sub-tabs');

            if (tab === 'overall') {
                subTabsContainer.classList.remove('show');
                currentLeaderboardSubTab = null;
                loadLeaderboard('overall', null);
            } else {
                // Show sub-tabs
                const subTabs = leaderboardSubTabs[tab];
                if (subTabs && subTabs.length > 0) {
                    subTabsContainer.innerHTML = subTabs.map((st, index) =>
                        `<button class="leaderboard-sub-tab ${index === 0 ? 'active' : ''}"
                                 onclick="switchLeaderboardSubTab('${tab}', '${st.key}')">${st.label}</button>`
                    ).join('');
                    subTabsContainer.classList.add('show');

                    // Load first sub-tab
                    currentLeaderboardSubTab = subTabs[0].key;
                    loadLeaderboard(tab, currentLeaderboardSubTab);
                }
            }
        }

        function switchLeaderboardSubTab(mainTab, subTab) {
            currentLeaderboardSubTab = subTab;

            // Update sub-tab active states
            document.querySelectorAll('.leaderboard-sub-tab').forEach(t => {
                t.classList.remove('active');
            });
            event.target.classList.add('active');

            loadLeaderboard(mainTab, subTab);
        }

        function loadLeaderboard(category, subCategory) {
            const loadingEl = document.getElementById('leaderboard-loading');
            const emptyEl = document.getElementById('leaderboard-empty');
            const tableContainer = document.querySelector('.leaderboard-table-container');

            // Show loading
            loadingEl.classList.add('show');
            emptyEl.classList.remove('show');
            tableContainer.style.display = 'none';

            // Check cache
            const cacheKey = category + '_' + (subCategory || 'all');
            if (leaderboardCache[cacheKey]) {
                renderLeaderboard(leaderboardCache[cacheKey]);
                return;
            }

            // Fetch from Firebase
            const db = ensureFirebaseInitialized();
            if (!db) {
                loadingEl.classList.remove('show');
                emptyEl.textContent = 'Database not available.';
                emptyEl.classList.add('show');
                return;
            }

            db.ref('players').once('value')
                .then(snapshot => {
                    const players = [];
                    snapshot.forEach(child => {
                        const code = child.key;
                        const data = child.val();

                        // Skip GMs
                        if (code.startsWith('GM')) return;

                        players.push({ code, ...data });
                    });

                    const processed = processLeaderboardData(players, category, subCategory);
                    leaderboardCache[cacheKey] = processed;
                    renderLeaderboard(processed);
                })
                .catch(error => {
                    console.error('Error loading leaderboard:', error);
                    loadingEl.classList.remove('show');
                    emptyEl.textContent = 'Error loading data.';
                    emptyEl.classList.add('show');
                });
        }

        function processLeaderboardData(players, category, subCategory) {
            let processed = [];

            if (category === 'overall') {
                // Use overall wins
                processed = players.map(p => ({
                    code: p.code,
                    name: p.displayName || p.code,
                    wins: p.wins || 0,
                    games: p.gamesPlayed || 0
                }));
            } else {
                // Get category mapping
                const categoryMap = {
                    'gameType': 'gameType',
                    'opponent': 'opponentType',
                    'difficulty': 'aiDifficulty'
                };

                const statCategory = categoryMap[category];

                processed = players.map(p => {
                    const stats = p.stats && p.stats[statCategory] && p.stats[statCategory][subCategory];
                    return {
                        code: p.code,
                        name: p.displayName || p.code,
                        wins: stats ? stats.wins : 0,
                        games: stats ? stats.games : 0
                    };
                });
            }

            // Sort by wins (desc), then by win rate (desc), then by games (desc)
            processed.sort((a, b) => {
                if (b.wins !== a.wins) return b.wins - a.wins;
                const rateA = a.games > 0 ? a.wins / a.games : 0;
                const rateB = b.games > 0 ? b.wins / b.games : 0;
                if (rateB !== rateA) return rateB - rateA;
                return b.games - a.games;
            });

            // Filter out players with 0 games in this category
            processed = processed.filter(p => p.games > 0);

            return processed;
        }

        function renderLeaderboard(data) {
            const loadingEl = document.getElementById('leaderboard-loading');
            const emptyEl = document.getElementById('leaderboard-empty');
            const tableContainer = document.querySelector('.leaderboard-table-container');
            const tbody = document.getElementById('leaderboard-body');

            loadingEl.classList.remove('show');

            if (!data || data.length === 0) {
                emptyEl.textContent = 'No data yet.';
                emptyEl.classList.add('show');
                tableContainer.style.display = 'none';
                return;
            }

            emptyEl.classList.remove('show');
            tableContainer.style.display = 'block';

            tbody.innerHTML = data.map((player, index) => {
                const rank = index + 1;
                const winRate = player.games > 0 ? Math.round((player.wins / player.games) * 100) : 0;
                const isCurrentPlayer = playerCode && player.code === playerCode;

                let rankClass = '';
                if (rank === 1) rankClass = 'rank-1';
                else if (rank === 2) rankClass = 'rank-2';
                else if (rank === 3) rankClass = 'rank-3';

                const playerClass = isCurrentPlayer ? 'current-player' : '';

                return `
                    <tr class="${rankClass} ${playerClass}">
                        <td>${rank}</td>
                        <td class="leaderboard-player-name" onclick="viewProfileFromLeaderboard('${player.code}')">${player.name}</td>
                        <td>${player.wins}</td>
                        <td>${player.games}</td>
                        <td>${winRate}%</td>
                    </tr>
                `;
            }).join('');
        }

        // ============================================
        // PLAYER PROFILE SYSTEM
        // ============================================
        let currentProfileCode = null;
        let isViewingOwnProfile = true;

        function openProfile() {
            const modal = document.getElementById('profile-modal');
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';

            // Default to viewing own profile
            openOwnProfile();
        }

        function openOwnProfile() {
            isViewingOwnProfile = true;
            currentProfileCode = playerCode;

            document.getElementById('profile-modal-title').textContent = 'My Profile';
            document.getElementById('profile-footer').classList.remove('show');
            document.getElementById('profile-search-input').value = '';

            if (playerCode) {
                loadProfile(playerCode);
            } else {
                showProfileError('Please log in to view your profile.');
            }
        }

        function closeProfile() {
            const modal = document.getElementById('profile-modal');
            modal.classList.remove('active');
            document.body.style.overflow = '';
        }

        function viewProfileFromLeaderboard(code) {
            // Close leaderboard and open profile
            closeLeaderboard();

            const modal = document.getElementById('profile-modal');
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';

            isViewingOwnProfile = code === playerCode;
            currentProfileCode = code;

            document.getElementById('profile-modal-title').textContent = isViewingOwnProfile ? 'My Profile' : 'Player Profile';
            document.getElementById('profile-footer').classList.toggle('show', !isViewingOwnProfile && playerCode);
            document.getElementById('profile-search-input').value = code;

            loadProfile(code);
        }

        function searchPlayerProfile() {
            const input = document.getElementById('profile-search-input');
            const code = input.value.trim().toUpperCase();

            if (!code || code.length < 4) {
                alert('Please enter a valid player code (at least 4 characters).');
                return;
            }

            isViewingOwnProfile = code === playerCode;
            currentProfileCode = code;

            document.getElementById('profile-modal-title').textContent = 'Player Profile';
            document.getElementById('profile-footer').classList.toggle('show', !isViewingOwnProfile && playerCode);

            loadProfile(code);
        }

        function loadProfile(code) {
            const contentEl = document.getElementById('profile-content');
            const loadingEl = document.getElementById('profile-loading');
            const errorEl = document.getElementById('profile-error');

            contentEl.classList.remove('show');
            errorEl.classList.remove('show');
            loadingEl.classList.add('show');

            const db = ensureFirebaseInitialized();
            if (!db) {
                showProfileError('Database not available.');
                return;
            }

            db.ref('players/' + code).once('value')
                .then(snapshot => {
                    if (!snapshot.exists()) {
                        showProfileError('Player not found.');
                        return;
                    }

                    const data = snapshot.val();
                    renderProfile(code, data);
                })
                .catch(error => {
                    console.error('Error loading profile:', error);
                    showProfileError('Error loading profile.');
                });
        }

        function showProfileError(message) {
            document.getElementById('profile-loading').classList.remove('show');
            document.getElementById('profile-content').classList.remove('show');
            const errorEl = document.getElementById('profile-error');
            errorEl.textContent = message;
            errorEl.classList.add('show');
        }

        function renderProfile(code, data) {
            const loadingEl = document.getElementById('profile-loading');
            const contentEl = document.getElementById('profile-content');

            loadingEl.classList.remove('show');
            contentEl.classList.add('show');

            // Check if GM account
            const isGM = code.startsWith('GM');

            // Basic info
            const displayName = data.displayName || (isGM ? 'Game Master ' + code : 'Player ' + code);
            document.getElementById('profile-name').textContent = displayName;
            document.getElementById('profile-code').textContent = '#' + code;

            // Avatar - use special icon for GMs
            const avatar = isGM ? '' : displayName.charAt(0).toUpperCase();
            document.getElementById('profile-avatar').textContent = avatar;

            // Active title and badge
            renderProfileTitle(data, isGM);

            // Stats - GMs get infinity
            if (isGM) {
                document.getElementById('profile-wins').textContent = '';
                document.getElementById('profile-losses').textContent = '';
                document.getElementById('profile-games').textContent = '';
                document.getElementById('profile-winrate').textContent = '';
            } else {
                const wins = data.wins || 0;
                const losses = data.losses || 0;
                const games = data.gamesPlayed || 0;
                const winRate = games > 0 ? Math.round((wins / games) * 100) : 0;

                document.getElementById('profile-wins').textContent = wins;
                document.getElementById('profile-losses').textContent = losses;
                document.getElementById('profile-games').textContent = games;
                document.getElementById('profile-winrate').textContent = winRate + '%';
            }

            // Game mode stats
            renderProfileModeStats(data, isGM);

            // Titles
            renderProfileTitles(data, isGM);

            // Achievements
            renderProfileAchievements(data, isGM);
        }

        // GM title selection storage
        let selectedGMTitle = localStorage.getItem('pathwayClash_gmTitle') || 'above_sequences';

        function renderProfileTitle(data, isGM) {
            const titleEl = document.getElementById('profile-title');
            const badgeEl = document.getElementById('profile-badge');
            const changeTitleBtn = document.getElementById('btn-change-title');
            const titleSelector = document.getElementById('title-selector');

            // Reset title classes
            titleEl.className = 'profile-title title-text';
            titleSelector.style.display = 'none';

            const isOwnProfile = currentProfileCode === playerCode;

            // GMs can select any title
            if (isGM) {
                changeTitleBtn.style.display = isOwnProfile ? 'inline-block' : 'none';

                // Get selected title info
                if (selectedGMTitle === 'above_sequences') {
                    titleEl.textContent = 'Above the Sequences';
                    titleEl.classList.add('sefirah-glow');
                    badgeEl.innerHTML = '';
                } else {
                    const triumph = HIDDEN_TRIUMPHS[selectedGMTitle];
                    if (triumph) {
                        titleEl.textContent = triumph.title;
                        if (triumph.titleEffect) {
                            titleEl.classList.add(triumph.titleEffect);
                        }
                        badgeEl.innerHTML = triumph.icon;
                    }
                }
                return;
            }

            // Regular players: show change button if viewing own profile and has triumphs
            const playerTriumphs = data.triumphs || unlockedTriumphs || [];
            const hasTriumphs = playerTriumphs.length > 0;
            changeTitleBtn.style.display = (isOwnProfile && hasTriumphs) ? 'inline-block' : 'none';

            // Check for active title
            const titleId = data.activeTitle || activeTitle;
            if (titleId && HIDDEN_TRIUMPHS[titleId]) {
                const triumph = HIDDEN_TRIUMPHS[titleId];
                titleEl.textContent = triumph.title;
                if (triumph.titleEffect) {
                    titleEl.classList.add(triumph.titleEffect);
                }
            } else if (hasTriumphs) {
                // Default to first triumph if none selected
                const firstTriumph = HIDDEN_TRIUMPHS[playerTriumphs[0]];
                if (firstTriumph) {
                    titleEl.textContent = firstTriumph.title;
                    if (firstTriumph.titleEffect) {
                        titleEl.classList.add(firstTriumph.titleEffect);
                    }
                }
            } else {
                titleEl.textContent = '';
            }

            // Check for displayed badge
            const displayed = data.displayedAchievement;
            if (displayed) {
                const item = displayed.isTriumph ? HIDDEN_TRIUMPHS[displayed.id] : ACHIEVEMENTS[displayed.id];
                if (item) {
                    badgeEl.innerHTML = item.icon;
                } else {
                    badgeEl.innerHTML = '';
                }
            } else {
                badgeEl.innerHTML = '';
            }
        }

        function openTitleSelector() {
            const titleSelector = document.getElementById('title-selector');
            const listEl = document.getElementById('title-selector-list');
            const isGM = playerCode && playerCode.startsWith('GM');

            // Toggle visibility
            if (titleSelector.style.display === 'block') {
                titleSelector.style.display = 'none';
                return;
            }

            titleSelector.style.display = 'block';

            // Build title options
            let html = '';

            if (isGM) {
                // GMs get "Above the Sequences" default option
                const isSelected = selectedGMTitle === 'above_sequences';
                html += `
                    <div class="title-selector-item ${isSelected ? 'selected' : ''}" onclick="selectTitle('above_sequences')">
                        <div class="title-name title-text sefirah-glow">Above the Sequences</div>
                        <div class="title-source">Game Master Default</div>
                    </div>
                `;

                // GMs get ALL triumph titles
                Object.entries(HIDDEN_TRIUMPHS).forEach(([id, triumph]) => {
                    if (triumph.title) {
                        const isSelected = selectedGMTitle === id;
                        html += `
                            <div class="title-selector-item ${isSelected ? 'selected' : ''}" onclick="selectTitle('${id}')">
                                <div class="title-name title-text ${triumph.titleEffect || ''}">${triumph.title}</div>
                                <div class="title-source">${triumph.name}</div>
                            </div>
                        `;
                    }
                });
            } else {
                // Regular players only see their unlocked triumphs
                // Option to show no title
                const noTitleSelected = !activeTitle;
                html += `
                    <div class="title-selector-item ${noTitleSelected ? 'selected' : ''}" onclick="selectTitle(null)">
                        <div class="title-name" style="color: #888;">No Title</div>
                        <div class="title-source">Hide your title</div>
                    </div>
                `;

                unlockedTriumphs.forEach(id => {
                    const triumph = HIDDEN_TRIUMPHS[id];
                    if (triumph && triumph.title) {
                        const isSelected = activeTitle === id;
                        html += `
                            <div class="title-selector-item ${isSelected ? 'selected' : ''}" onclick="selectTitle('${id}')">
                                <div class="title-name title-text ${triumph.titleEffect || ''}">${triumph.title}</div>
                                <div class="title-source">${triumph.name}</div>
                            </div>
                        `;
                    }
                });

                if (unlockedTriumphs.length === 0) {
                    html += '<div class="profile-empty">Unlock triumphs to earn titles!</div>';
                }
            }

            listEl.innerHTML = html;
        }

        function selectTitle(titleId) {
            const isGM = playerCode && playerCode.startsWith('GM');
            const titleSelector = document.getElementById('title-selector');
            titleSelector.style.display = 'none';

            if (isGM) {
                // GMs use their own storage
                selectedGMTitle = titleId || 'above_sequences';
                localStorage.setItem('pathwayClash_gmTitle', selectedGMTitle);
                renderProfileTitle({}, true);
            } else {
                // Regular players use the existing system
                setActiveTitle(titleId);
                // Re-render with current data
                renderProfileTitle({
                    activeTitle: titleId,
                    triumphs: unlockedTriumphs,
                    displayedAchievement: displayedAchievement
                }, false);
            }
        }

        function renderProfileModeStats(data, isGM) {
            const container = document.getElementById('profile-mode-stats');

            // GMs get infinity for all modes
            if (isGM) {
                const allModes = [
                    'Pathways', 'Outer Deities', 'Inner vs Outer',
                    'vs AI', 'vs Players',
                    'Easy AI', 'Medium AI', 'Hard AI', 'God Mode AI'
                ];
                container.innerHTML = allModes.map(mode => `
                    <div class="profile-mode-stat">
                        <span class="mode-name">${mode}</span>
                        <span class="mode-stats">W / G (%)</span>
                    </div>
                `).join('');
                return;
            }

            const stats = data.stats || {};

            let html = '';

            // Game types
            const gameTypes = [
                { key: 'pathways', label: 'Pathways' },
                { key: 'outer_deities', label: 'Outer Deities' },
                { key: 'inner_vs_outer', label: 'Inner vs Outer' }
            ];

            gameTypes.forEach(gt => {
                const s = stats.gameType && stats.gameType[gt.key];
                if (s && s.games > 0) {
                    const rate = Math.round((s.wins / s.games) * 100);
                    html += `
                        <div class="profile-mode-stat">
                            <span class="mode-name">${gt.label}</span>
                            <span class="mode-stats">${s.wins}W / ${s.games}G (${rate}%)</span>
                        </div>
                    `;
                }
            });

            // Opponent types
            const opponentTypes = [
                { key: 'ai', label: 'vs AI' },
                { key: 'pvp', label: 'vs Players' }
            ];

            opponentTypes.forEach(ot => {
                const s = stats.opponentType && stats.opponentType[ot.key];
                if (s && s.games > 0) {
                    const rate = Math.round((s.wins / s.games) * 100);
                    html += `
                        <div class="profile-mode-stat">
                            <span class="mode-name">${ot.label}</span>
                            <span class="mode-stats">${s.wins}W / ${s.games}G (${rate}%)</span>
                        </div>
                    `;
                }
            });

            // AI difficulties
            const difficulties = [
                { key: 'easy', label: 'Easy AI' },
                { key: 'medium', label: 'Medium AI' },
                { key: 'hard', label: 'Hard AI' },
                { key: 'god', label: 'God Mode AI' }
            ];

            difficulties.forEach(d => {
                const s = stats.aiDifficulty && stats.aiDifficulty[d.key];
                if (s && s.games > 0) {
                    const rate = Math.round((s.wins / s.games) * 100);
                    html += `
                        <div class="profile-mode-stat">
                            <span class="mode-name">${d.label}</span>
                            <span class="mode-stats">${s.wins}W / ${s.games}G (${rate}%)</span>
                        </div>
                    `;
                }
            });

            if (!html) {
                html = '<div class="profile-empty">No game mode stats yet</div>';
            }

            container.innerHTML = html;
        }

        function renderProfileTitles(data, isGM) {
            const container = document.getElementById('profile-titles');

            // GMs have ALL titles
            if (isGM) {
                let html = '';
                Object.entries(HIDDEN_TRIUMPHS).forEach(([id, triumph]) => {
                    if (triumph.title) {
                        const effectClass = triumph.titleEffect ? `title-text ${triumph.titleEffect}` : '';
                        html += `<span class="profile-title-badge active ${effectClass}" title="${triumph.name}">${triumph.title}</span>`;
                    }
                });
                container.innerHTML = html;
                return;
            }

            const triumphs = data.triumphs || [];
            const activeTitle = data.activeTitle;

            if (triumphs.length === 0) {
                container.innerHTML = '<div class="profile-empty">No titles earned yet</div>';
                return;
            }

            let html = '';
            triumphs.forEach(triumphId => {
                const triumph = HIDDEN_TRIUMPHS[triumphId];
                if (triumph && triumph.title) {
                    const isActive = triumphId === activeTitle;
                    const effectClass = triumph.titleEffect ? `title-text ${triumph.titleEffect}` : '';
                    html += `<span class="profile-title-badge ${isActive ? 'active' : ''} ${effectClass}" title="${triumph.name}">${triumph.title}</span>`;
                }
            });

            container.innerHTML = html || '<div class="profile-empty">No titles earned yet</div>';
        }

        function renderProfileAchievements(data, isGM) {
            const container = document.getElementById('profile-achievements');
            const totalAchievements = Object.keys(ACHIEVEMENTS).length;

            // GMs have ALL achievements
            if (isGM) {
                document.getElementById('profile-ach-count').textContent = '';
                document.getElementById('profile-ach-total').textContent = totalAchievements;

                let html = '';
                Object.values(ACHIEVEMENTS).forEach(ach => {
                    html += `<span class="profile-ach-icon" title="${ach.name}: ${ach.desc}">${ach.icon}</span>`;
                });
                container.innerHTML = html;
                return;
            }

            const achievements = data.achievements || [];

            document.getElementById('profile-ach-count').textContent = achievements.length;
            document.getElementById('profile-ach-total').textContent = totalAchievements;

            if (achievements.length === 0) {
                container.innerHTML = '<div class="profile-empty">No achievements yet</div>';
                return;
            }

            let html = '';
            // Show unlocked achievements
            achievements.forEach(achId => {
                const ach = ACHIEVEMENTS[achId];
                if (ach) {
                    html += `<span class="profile-ach-icon" title="${ach.name}: ${ach.desc}">${ach.icon}</span>`;
                }
            });

            container.innerHTML = html;
        }

        // Sync profile data to Firebase (called when achievements/titles change)
        function syncProfileToFirebase() {
            if (!playerCode || !playerDb || playerCode.startsWith('GM')) return;

            const profileData = {
                achievements: unlockedAchievements,
                triumphs: unlockedTriumphs,
                activeTitle: activeTitle,
                displayedAchievement: displayedAchievement,
                lastUpdated: firebase.database.ServerValue.TIMESTAMP
            };

            playerDb.ref('players/' + playerCode).update(profileData)
                .catch(error => console.error('Error syncing profile:', error));
        }

        // ============================================
        // PATHWAY DATA
        // ============================================
        const PATHWAYS = [
            {
                name: 'Fool',
                icon: 'images/fool.png',
                flavor: 'Master of disguise, weaver of fate',
                abilityCategory: 'fool',
                description: 'The Fool is the master of deception, preparation, and unseen control. Rather than overwhelming foes with power, they manipulate the battlefield through disguise, illusion, and fate. Identities are tools to be worn and discarded, while history and coincidence become weapons. A Fool rarely fights head-on; enemies instead face traps, proxies, and outcomes that seem inevitable. To confront a Fool is to question what is realand whether the battle was already decided before it began.',
                abilities: [
                    { name: 'Disguise & Identity Manipulation', desc: 'Alter appearance, aura, and perceived identity, enabling infiltration and misdirection resistant to detection.' },
                    { name: 'Marionette Control', desc: 'Weakened enemies can be converted into marionettes that retain partial abilities and act as proxies or sacrifices.' },
                    { name: 'Historical Projection', desc: 'Summon temporary projections of historical figures or abilities to influence combat or terrain.' },
                    { name: 'Fate Thread Manipulation', desc: 'Subtly influence probability to avoid fatal outcomes or ensure critical coincidences.' },
                    { name: 'Illusion Domain', desc: 'Layered illusions distort perception, judgment, and spiritual senses.' },
                    { name: 'Prepared Rituals', desc: 'Symbols and anchors trigger effects such as ambushes, escapes, or reversals when conditions are met.' },
                    { name: "Fool's Escape", desc: 'When facing death, abandon identity or presence to survive at great cost.' }
                ]
            },
            {
                name: 'Door',
                icon: 'images/door.png',
                flavor: 'Wanderer between worlds and dimensions',
                abilityCategory: 'door',
                description: 'The Door pathway commands space itself. Practitioners can open passages between locations, dimensions, and even concepts. In combat, they are nearly impossible to pin downteleporting at will, banishing foes to distant realms, or sealing areas entirely. They excel at controlling engagement distance and denying enemies any foothold. Fighting a Door is like grasping smoke; the moment you close in, they are already elsewhere.',
                abilities: [
                    { name: 'Teleportation', desc: 'Instantly relocate self or others across any distance, ignoring physical barriers.' },
                    { name: 'Dimensional Banishment', desc: 'Send targets to other dimensions or sealed spaces temporarily or permanently.' },
                    { name: 'Spatial Sealing', desc: 'Lock down areas to prevent entry, exit, or teleportation by others.' },
                    { name: 'Portal Creation', desc: 'Open stable or unstable doorways connecting distant locations.' },
                    { name: 'Space Folding', desc: 'Compress or expand distances, making far things near or near things unreachable.' },
                    { name: 'Wanderer\'s Immunity', desc: 'Resist spatial manipulation and forced displacement from other sources.' }
                ]
            },
            {
                name: 'Error',
                icon: 'images/error.png',
                flavor: 'Stealer of all, corruptor of existence',
                abilityCategory: 'error',
                description: 'The Error pathway embodies theft, corruption, and the unraveling of order. Practitioners steal abilities, items, concepts, and even luck from their targets. They insert flaws into enemy techniques, corrupt magical processes, and turn strengths into weaknesses. In battle, facing an Error means watching your carefully prepared abilities fail at critical moments while your opponent wields your own power against you.',
                abilities: [
                    { name: 'Ability Theft', desc: 'Temporarily or permanently steal powers, skills, or Beyonder abilities from targets.' },
                    { name: 'Corruption Insertion', desc: 'Plant errors and flaws into enemy abilities, items, or rituals causing malfunction.' },
                    { name: 'Luck Drain', desc: 'Steal fortune from targets, causing their actions to fail while boosting own success.' },
                    { name: 'Concept Theft', desc: 'Steal abstract concepts like "sharpness" from a blade or "loyalty" from a servant.' },
                    { name: 'Bug Exploitation', desc: 'Identify and exploit weaknesses in any system, technique, or defense.' },
                    { name: 'Existence Erosion', desc: 'Gradually corrupt a target\'s very existence, causing them to "error out" of reality.' }
                ]
            },
            {
                name: 'Visionary',
                icon: 'images/visionary.png',
                flavor: 'Seer of minds, shaper of thoughts',
                abilityCategory: 'visionary',
                description: 'The Visionary pathway dominates the mental realm. Practitioners read thoughts, implant ideas, rewrite memories, and trap minds in fabricated realities. At higher sequences, they can author entire narratives that reshape how events unfold. In combat, physical defenses mean nothingthe battle is fought in the mind, where a Visionary can make you believe you\'ve already lost, or simply rewrite your intent to fight.',
                abilities: [
                    { name: 'Mind Reading', desc: 'Perceive surface thoughts, deep memories, and hidden intentions of targets.' },
                    { name: 'Mental Domination', desc: 'Override a target\'s will, controlling their actions directly.' },
                    { name: 'Memory Manipulation', desc: 'Alter, erase, or fabricate memories with precision.' },
                    { name: 'Illusion Worlds', desc: 'Trap targets in mental constructs indistinguishable from reality.' },
                    { name: 'Narrative Authority', desc: 'Write "scripts" that influence how events and people behave.' },
                    { name: 'Thought Implantation', desc: 'Plant ideas that targets believe are their own original thoughts.' },
                    { name: 'Collective Unconscious Access', desc: 'Tap into shared mental realms to influence groups or gather vast knowledge.' }
                ]
            },
            {
                name: 'White Tower',
                icon: 'images/white tower.png',
                flavor: 'Keeper of knowledge, master of wisdom',
                abilityCategory: 'knowledge',
                description: 'The White Tower pathway pursues absolute knowledge and analytical perfection. Practitioners possess superhuman intelligence, perfect memory, and the ability to calculate optimal outcomes. They decode enemy abilities instantly, predict attack patterns, and devise counter-strategies in moments. In battle, they turn combat into a solved equationevery move anticipated, every weakness catalogued, every victory calculated before the first blow.',
                abilities: [
                    { name: 'Absolute Analysis', desc: 'Instantly understand any phenomenon, ability, or system upon observation.' },
                    { name: 'Predictive Modeling', desc: 'Calculate probable futures and optimal action sequences with high accuracy.' },
                    { name: 'Knowledge Weaponization', desc: 'Transform understanding into direct powerknowing a weakness makes it exploitable.' },
                    { name: 'Perfect Memory', desc: 'Recall any information ever learned with perfect clarity.' },
                    { name: 'Counter-Formula Creation', desc: 'Rapidly devise specific counters to any observed ability or attack.' },
                    { name: 'Omniscient Domain', desc: 'Create zones where all information is known and no secrets can exist.' }
                ]
            },
            {
                name: 'Sun',
                icon: 'images/sun.png',
                flavor: 'Holy light that purifies all darkness',
                abilityCategory: 'purification',
                description: 'The Sun pathway channels holy radiance and purifying flame. Practitioners wield light as both weapon and shield, burning away corruption, undead, and darkness. They heal allies, resurrect the fallen, and stand as beacons of absolute opposition to evil. In combat, they are relentless purifierstheir light reveals all hidden things and their flames leave no shadow for enemies to hide within.',
                abilities: [
                    { name: 'Holy Light Manipulation', desc: 'Command sacred radiance to illuminate, blind, damage, or purify.' },
                    { name: 'Purifying Flames', desc: 'Summon fires that specifically burn evil, corruption, and undeath.' },
                    { name: 'Divine Healing', desc: 'Restore wounds, cure diseases, and cleanse spiritual corruption.' },
                    { name: 'Resurrection', desc: 'Return the recently dead to life, restoring body and soul.' },
                    { name: 'Light Judgment', desc: 'Channel concentrated holy power into devastating offensive strikes.' },
                    { name: 'Illumination Field', desc: 'Create areas where darkness, concealment, and lies cannot exist.' },
                    { name: 'Solar Avatar', desc: 'Transform into a being of pure light with vastly amplified power.' }
                ]
            },
            {
                name: 'Tyrant',
                icon: 'images/tyrant.png',
                flavor: 'Commander of storms and seas',
                abilityCategory: 'destruction',
                description: 'The Tyrant pathway commands the primal forces of naturestorms, seas, lightning, and wind. Practitioners are forces of devastation, calling down hurricanes and tsunamis upon their enemies. They also embody dominion and authority, compelling obedience through sheer presence. In combat, they overwhelm with environmental destruction, leaving no safe ground while their lightning strikes with the certainty of divine judgment.',
                abilities: [
                    { name: 'Storm Summoning', desc: 'Call forth hurricanes, thunderstorms, and devastating weather at will.' },
                    { name: 'Lightning Command', desc: 'Direct precise or widespread electrical devastation upon targets.' },
                    { name: 'Ocean Authority', desc: 'Control seas, summon tsunamis, and command water in all forms.' },
                    { name: 'Wind Manipulation', desc: 'Shape air currents from gentle breezes to cutting gales.' },
                    { name: 'Tyrant\'s Aura', desc: 'Project overwhelming presence that compels submission and fear.' },
                    { name: 'Weather Domain', desc: 'Transform the battlefield environment entirely to your advantage.' },
                    { name: 'Divine Punishment', desc: 'Channel nature\'s wrath into singular, devastating judgments.' }
                ]
            },
            {
                name: 'Hanged Man',
                icon: 'images/hanged man.png',
                flavor: 'Walker between life and death',
                abilityCategory: 'death',
                description: 'The Hanged Man pathway exists in the liminal space between life and death. Practitioners manipulate spirits, inflict curses, and wield powers of decay and disease. They can enter death-like states to avoid harm, communicate with the deceased, and turn the boundary of mortality into a weapon. In combat, they are patient corruptorstheir curses accumulate, their diseases spread, and time itself becomes their ally.',
                abilities: [
                    { name: 'Spirit Manipulation', desc: 'Command, communicate with, and bind spirits and souls.' },
                    { name: 'Curse Weaving', desc: 'Inflict persistent curses that weaken, harm, or doom targets over time.' },
                    { name: 'Disease Control', desc: 'Create, spread, or cure plagues and spiritual sicknesses.' },
                    { name: 'Death State', desc: 'Enter a condition between life and death, becoming immune to many effects.' },
                    { name: 'Soul Grazing', desc: 'Damage or drain the soul directly, bypassing physical defenses.' },
                    { name: 'Undying Persistence', desc: 'Survive lethal damage by existing partially in death\'s domain.' },
                    { name: 'Death Prophecy', desc: 'Foresee or influence the circumstances of a target\'s eventual death.' }
                ]
            },
            {
                name: 'Darkness',
                icon: 'images/darkness.png',
                flavor: 'Shadow that consumes all light',
                abilityCategory: 'darkness',
                description: 'The Darkness pathway commands shadow, concealment, and the cold void. Practitioners become one with darknessinvisible, intangible, and everywhere shadows fall. They assassinate from impossible angles, drain warmth and hope, and create zones of absolute blackness. In combat, they are patient hunters who strike from nowhere and vanish before retaliation, slowly surrounding enemies in inescapable night.',
                abilities: [
                    { name: 'Shadow Meld', desc: 'Become one with darkness, achieving perfect concealment and intangibility.' },
                    { name: 'Darkness Domain', desc: 'Create zones of absolute blackness that blind and disorient.' },
                    { name: 'Shadow Travel', desc: 'Move instantly between connected shadows across any distance.' },
                    { name: 'Cold Void', desc: 'Drain heat, light, and vitality from an area or target.' },
                    { name: 'Shadow Constructs', desc: 'Form solid weapons, barriers, or creatures from darkness.' },
                    { name: 'Assassination Arts', desc: 'Strike with lethal precision from concealment, bypassing defenses.' },
                    { name: 'Light Devouring', desc: 'Consume and extinguish light sources, including magical illumination.' }
                ]
            },
            {
                name: 'Death',
                icon: 'images/death.png',
                flavor: 'Ruler of the undead realm',
                abilityCategory: 'death',
                description: 'The Death pathway commands the forces of mortality and undeath. Practitioners raise armies of the dead, exist as immortal undead themselves, and wield the cold finality of death as a weapon. They are nearly impossible to destroy permanently, reforming from destruction and growing stronger through accumulated souls. In combat, they overwhelm through attritionwhat they kill joins their army, and they themselves refuse to stay dead.',
                abilities: [
                    { name: 'Undead Creation', desc: 'Raise and command corpses, skeletons, and spiritual undead.' },
                    { name: 'Death Touch', desc: 'Inflict lethal necrotic damage through contact, withering life force.' },
                    { name: 'Soul Binding', desc: 'Capture and utilize souls for power, information, or servitude.' },
                    { name: 'Undying Form', desc: 'Exist as an undead being immune to aging, poison, and biological needs.' },
                    { name: 'Necromantic Regeneration', desc: 'Reform from destruction by drawing on death energy or bound souls.' },
                    { name: 'Death Authority', desc: 'Command or resist death effects, and sense mortality in others.' },
                    { name: 'Army of the Dead', desc: 'Maintain vast numbers of undead servants across great distances.' }
                ]
            },
            {
                name: 'Twilight Giant',
                icon: 'images/twilight giant.png',
                flavor: 'Ancient strength that shakes the earth',
                abilityCategory: 'destruction',
                description: 'The Twilight Giant pathway embodies primordial physical might and ancient warrior traditions. Practitioners possess strength to shatter mountains, durability to ignore most attacks, and combat mastery refined over millennia. They wield legendary weapons and armor, and their very footsteps shake the earth. In combat, they are unstoppable juggernautsno barrier holds them, no blow fells them, and their strikes end battles decisively.',
                abilities: [
                    { name: 'Titanic Strength', desc: 'Possess physical power capable of reshaping terrain and overwhelming any defense.' },
                    { name: 'Unbreakable Body', desc: 'Resist damage through supernaturally dense flesh and regeneration.' },
                    { name: 'Giant Transformation', desc: 'Grow to enormous size, multiplying strength and reach.' },
                    { name: 'Weapon Mastery', desc: 'Achieve supernatural skill with all weapons, especially ancient giant arms.' },
                    { name: 'Earth Shaking', desc: 'Create earthquakes, fissures, and terrain upheaval through sheer force.' },
                    { name: 'Warrior\'s Instinct', desc: 'React to threats with preternatural speed and battle-honed intuition.' },
                    { name: 'Legendary Armaments', desc: 'Wield and empower weapons of mythical origin and power.' }
                ]
            },
            {
                name: 'Red Priest',
                icon: 'images/red priest.png',
                flavor: 'Flames of war, destruction incarnate',
                abilityCategory: 'destruction',
                description: 'The Red Priest pathway channels the pure essence of war, destruction, and flame. Practitioners are living weaponstheir fires burn without limit, their mere presence incites violence, and they grow stronger through conflict. They command armies with supernatural coordination and turn battlefields into infernos. In combat, they are overwhelming offense incarnate, burning through defenses and turning every exchange into escalating devastation.',
                abilities: [
                    { name: 'War Flames', desc: 'Command fires that burn hotter and spread faster in conflict.' },
                    { name: 'Destruction Aura', desc: 'Amplify damage dealt in your presence while weakening defenses.' },
                    { name: 'Battle Fury', desc: 'Enter states of enhanced combat ability fueled by violence and rage.' },
                    { name: 'Army Command', desc: 'Coordinate and enhance allied forces with supernatural efficiency.' },
                    { name: 'Weapon Summoning', desc: 'Create or enhance weapons of war from flames and destruction.' },
                    { name: 'Conflict Empowerment', desc: 'Grow stronger the longer battle continues and the more destruction occurs.' },
                    { name: 'Apocalypse Fire', desc: 'Unleash flames capable of annihilating armies and scorching the land.' }
                ]
            },
            {
                name: 'Demoness',
                icon: 'images/demoness.png',
                flavor: 'Beauty that hides deadly intent',
                abilityCategory: 'stealth',
                description: 'The Demoness pathway wields desire, calamity, and corruption as weapons. Practitioners possess supernatural beauty and charm that clouds judgment and inflames obsession. They bring disaster upon their enemies through manipulated emotions and accumulated misfortune. In combat, they rarely fight directlyinstead, enemies destroy themselves through poor decisions, allies turn traitor, and calamities strike at the worst possible moments.',
                abilities: [
                    { name: 'Supernatural Allure', desc: 'Project irresistible beauty and charm that clouds minds and judgment.' },
                    { name: 'Desire Manipulation', desc: 'Sense, amplify, and redirect the desires and emotions of others.' },
                    { name: 'Calamity Attraction', desc: 'Cause disasters and misfortune to befall targets through accumulated bad luck.' },
                    { name: 'Corruption Spread', desc: 'Spiritually taint targets, warping their morality and desires over time.' },
                    { name: 'Assassin\'s Grace', desc: 'Strike with lethal precision when targets are distracted by desire.' },
                    { name: 'Emotion Feeding', desc: 'Drain and consume emotions for power, leaving targets hollow.' },
                    { name: 'Form Shifting', desc: 'Transform appearance to embody any desire or ideal beauty.' }
                ]
            },
            {
                name: 'Justiciar',
                icon: 'images/justiciar.png',
                flavor: 'Law absolute, judgment unquestioned',
                abilityCategory: 'justiciar',
                description: 'The Justiciar pathway embodies absolute law and divine judgment. Practitioners establish rules that cannot be broken, punish transgressors with certainty, and see through all deception to truth. Their prohibitions carry the weight of realitywhat they forbid becomes impossible. In combat, they define the rules of engagement, forbid enemy abilities, and execute judgment that cannot be appealed or escaped.',
                abilities: [
                    { name: 'Absolute Prohibition', desc: 'Declare actions forbidden, making them impossible within your authority.' },
                    { name: 'Truth Sight', desc: 'See through all lies, illusions, and deceptions automatically.' },
                    { name: 'Judgment Execution', desc: 'Deliver punishments that scale to the severity of transgressions.' },
                    { name: 'Law Domain', desc: 'Create zones where your established rules are reality.' },
                    { name: 'Contract Binding', desc: 'Create unbreakable agreements enforced by your authority.' },
                    { name: 'Order Imposition', desc: 'Suppress chaos, randomness, and rule-breaking in your presence.' },
                    { name: 'Divine Authority', desc: 'Speak with the weight of absolute law that compels acknowledgment.' }
                ]
            },
            {
                name: 'Black Emperor',
                icon: 'images/black emperor.png',
                flavor: 'Distortion of rules, chaos enthroned',
                abilityCategory: 'fate',
                description: 'The Black Emperor pathway commands distortion, loopholes, and the subversion of order. Practitioners twist rules rather than break them, finding exceptions that shouldn\'t exist and exploiting technicalities in reality itself. They manipulate authority structures and corrupt systems from within. In combat, they turn enemy abilities against their users, find impossible escapes from certain death, and make the unfair seem perfectly legal.',
                abilities: [
                    { name: 'Rule Distortion', desc: 'Twist laws and rules to create loopholes and exceptions.' },
                    { name: 'Authority Manipulation', desc: 'Usurp, redirect, or corrupt chains of command and control.' },
                    { name: 'Technicality Exploitation', desc: 'Find and abuse unintended interactions in any system.' },
                    { name: 'Conspiracy Weaving', desc: 'Create and manage complex plots that subvert established order.' },
                    { name: 'Black Throne', desc: 'Project authority that feels legitimate despite its corrupt nature.' },
                    { name: 'System Corruption', desc: 'Cause organizations, rituals, and structures to malfunction from within.' },
                    { name: 'Chaos Seeding', desc: 'Introduce entropy and disorder that spreads through ordered systems.' }
                ]
            },
            {
                name: 'Hermit',
                icon: 'images/hermit.png',
                flavor: 'Seeker of secrets, wielder of elements',
                abilityCategory: 'knowledge',
                description: 'The Hermit pathway pursues forbidden knowledge and elemental mastery. Practitioners command multiple elements, uncover hidden truths, and wield magic refined through isolation and study. They hoard secrets that grant power and understand connections invisible to others. In combat, they are versatile spellcastersadapting elemental attacks to any situation while their secret knowledge reveals enemy weaknesses.',
                abilities: [
                    { name: 'Elemental Mastery', desc: 'Command fire, water, earth, air, and their combinations with expertise.' },
                    { name: 'Secret Sensing', desc: 'Detect hidden things, lies, and concealed information automatically.' },
                    { name: 'Knowledge Hoarding', desc: 'Accumulate secrets that grant power and leverage over others.' },
                    { name: 'Ritual Expertise', desc: 'Perform complex magical ceremonies with enhanced effectiveness.' },
                    { name: 'Elemental Fusion', desc: 'Combine elements into advanced effects like magma, lightning, or ice.' },
                    { name: 'Hermit\'s Insight', desc: 'Understand connections and truths hidden from normal perception.' },
                    { name: 'Alchemy', desc: 'Transform substances and create potions, poisons, and magical items.' }
                ]
            },
            {
                name: 'Paragon',
                icon: 'images/paragon.png',
                flavor: 'Perfection through machinery and order',
                abilityCategory: 'creation',
                description: 'The Paragon pathway seeks perfection through mechanical precision and systematic order. Practitioners enhance themselves with machinery, create intricate devices, and optimize everything to flawless efficiency. They construct zones of absolute control where nothing operates outside designed parameters. In combat, they deploy mechanical armies, personal augmentations, and environmental systems that create perfect, inescapable kill zones.',
                abilities: [
                    { name: 'Mechanical Enhancement', desc: 'Augment body and abilities with precise, powerful machinery.' },
                    { name: 'Construct Creation', desc: 'Build mechanical servants, weapons, and autonomous systems.' },
                    { name: 'System Optimization', desc: 'Improve efficiency of any process, ability, or mechanism.' },
                    { name: 'Control Zone', desc: 'Create areas where all functions operate under your precise control.' },
                    { name: 'Perfect Calculation', desc: 'Process information and execute actions with machine precision.' },
                    { name: 'Technology Command', desc: 'Interface with and control existing machinery and devices.' },
                    { name: 'Modular Adaptation', desc: 'Reconfigure abilities and equipment to suit any situation.' }
                ]
            },
            {
                name: 'Mother',
                icon: 'images/mother.png',
                flavor: 'Life eternal, nature\'s embrace',
                abilityCategory: 'creation',
                description: 'The Mother pathway embodies life, nature, and endless growth. Practitioners command plants, animals, and the forces of nature itself. They heal with a touch, grow forests in moments, and possess regeneration that makes them nearly impossible to kill permanently. In combat, they overwhelm through endless vitalityterrain becomes hostile jungle, wounds heal instantly, and the natural world rises to defend its champion.',
                abilities: [
                    { name: 'Nature Command', desc: 'Control plants, animals, and natural phenomena at will.' },
                    { name: 'Regeneration', desc: 'Heal from virtually any wound, regrowing even lost limbs.' },
                    { name: 'Life Bestowal', desc: 'Grant vitality, heal others, and accelerate natural growth.' },
                    { name: 'Terrain Transformation', desc: 'Reshape landscapes into forests, jungles, or natural fortresses.' },
                    { name: 'Beast Bonding', desc: 'Command and enhance animals as loyal, empowered servants.' },
                    { name: 'Vitality Aura', desc: 'Radiate life energy that heals allies and strengthens nature.' },
                    { name: 'Eternal Youth', desc: 'Maintain perfect health and cease aging entirely.' }
                ]
            },
            {
                name: 'Moon',
                icon: 'images/moon.png',
                flavor: 'Ever-changing, never constant',
                abilityCategory: 'stealth',
                description: 'The Moon pathway embodies transformation, predation, and constant change. Practitioners shapeshift freely, possess powerful regeneration tied to lunar cycles, and can assume monstrous hunting forms. They spread lycanthropy and command other shifters. In combat, they are relentless predatorsadapting their form to counter any threat, healing from devastating wounds, and hunting with primal ferocity that never tires.',
                abilities: [
                    { name: 'Shapeshifting', desc: 'Transform into any creature or hybrid form at will.' },
                    { name: 'Lunar Regeneration', desc: 'Heal rapidly from wounds, enhanced during moon phases.' },
                    { name: 'Predator Form', desc: 'Assume optimized hunting shapes with enhanced combat abilities.' },
                    { name: 'Lycanthropy Spread', desc: 'Infect others with shapeshifting curses under your influence.' },
                    { name: 'Moon Empowerment', desc: 'Draw power from lunar light, peaking at full moon.' },
                    { name: 'Primal Senses', desc: 'Possess supernatural tracking, smell, and hunting instincts.' },
                    { name: 'Pack Command', desc: 'Lead and enhance other shapeshifters and lycanthropes.' }
                ]
            },
            {
                name: 'Chained',
                icon: 'images/chained.png',
                flavor: 'Prisoner and jailer, bound together',
                abilityCategory: 'binding',
                description: 'The Chained pathway masters imprisonment, binding, and restriction. Practitioners create inescapable restraints, seal away powers, and trap beings in prisons physical and conceptual. Paradoxically, they also understand freedomtheir own restrictions become sources of power when released. In combat, they deny enemy capabilities systematically, sealing away threats one by one until their opponent is helpless.',
                abilities: [
                    { name: 'Binding Chains', desc: 'Create unbreakable restraints that seal movement and abilities.' },
                    { name: 'Power Sealing', desc: 'Lock away specific abilities, preventing their use entirely.' },
                    { name: 'Prison Creation', desc: 'Construct inescapable cells in physical space or conceptual realms.' },
                    { name: 'Restriction Domain', desc: 'Create zones where specific actions become impossible.' },
                    { name: 'Seal Breaking', desc: 'Release your own restrictions for bursts of amplified power.' },
                    { name: 'Binding Contracts', desc: 'Create agreements that physically enforce their terms.' },
                    { name: 'Jailer\'s Authority', desc: 'Command prisons, seals, and bindings created by others.' }
                ]
            },
            {
                name: 'Abyss',
                icon: 'images/abyss.png',
                flavor: 'Depths of madness, whispers of the deep',
                abilityCategory: 'death',
                description: 'The Abyss pathway channels the incomprehensible horrors of the deep void. Practitioners wield madness as a weapon, summon tentacled abominations, and corrupt minds with forbidden knowledge. Their very presence erodes sanity. In combat, they attack the mind as readily as the bodyenemies go mad, see impossible things, and are dragged into darkness by things that should not exist.',
                abilities: [
                    { name: 'Madness Projection', desc: 'Assault minds with sanity-breaking visions and impossible knowledge.' },
                    { name: 'Tentacle Summoning', desc: 'Call forth writhing appendages from void spaces to grasp and crush.' },
                    { name: 'Abyssal Corruption', desc: 'Taint targets with deep madness that spreads and worsens.' },
                    { name: 'Horror Manifestation', desc: 'Summon creatures of nightmare that defy natural law.' },
                    { name: 'Void Gaze', desc: 'Lock eyes to directly damage sanity and will.' },
                    { name: 'Deep Whispers', desc: 'Implant maddening thoughts that erode judgment over time.' },
                    { name: 'Reality Erosion', desc: 'Cause local reality to become unstable and nightmarish.' }
                ]
            },
            {
                name: 'Wheel of Fortune',
                icon: 'images/key of light.png',
                flavor: 'Luck favors the bold... sometimes',
                abilityCategory: 'fate',
                description: 'The Wheel of Fortune pathway commands probability and fate itself. Practitioners manipulate luck, ensure fortunate outcomes for themselves, and curse enemies with disaster. They can glimpse and influence destiny, turning certain defeat into unexpected victory. In combat, their attacks always find openings, enemy strikes miss inexplicably, and the most unlikely circumstances consistently favor the fortunate one.',
                abilities: [
                    { name: 'Luck Manipulation', desc: 'Bend probability to ensure favorable outcomes for any action.' },
                    { name: 'Misfortune Curse', desc: 'Doom targets to suffer bad luck and unfortunate coincidences.' },
                    { name: 'Fate Glimpsing', desc: 'See possible futures and the threads of destiny.' },
                    { name: 'Probability Field', desc: 'Create zones where luck consistently favors you and harms enemies.' },
                    { name: 'Fortune Reversal', desc: 'Swap the luck between yourself and a target instantly.' },
                    { name: 'Destiny Alteration', desc: 'Make subtle changes to fate that compound into major differences.' },
                    { name: 'Miracle Chance', desc: 'Cause extremely unlikely events to occur when most needed.' }
                ]
            }
        ];

        // ============================================
        // INNER GODS DATA (Extremely Rare Draws)
        // ============================================
        const INNER_GODS = [
            {
                name: 'God Almighty',
                icon: 'images/god_almighty.png',
                flavor: 'A true deity',
                titleEffect: 'sefirah-glow',
                isInnerGod: true,
                combinedPathways: ['Visionary', 'Sun', 'Tyrant', 'Hanged Man', 'White Tower'],
                description: 'The supreme being who sits upon the Sefirah Castle, wielding the combined authorities of Visionary, Sun, Tyrant, Hanged Man, and White Tower. An entity of absolute divine power whose very existence defines reality itself.',
                abilities: [
                    { name: 'Divine Omniscience', desc: 'See all things across time and space; no secret is hidden from the Almighty.' },
                    { name: 'Holy Radiance', desc: 'Unleash purifying light that cleanses all corruption and burns away lies.' },
                    { name: 'Storm of Judgment', desc: 'Command catastrophic weather to smite the unworthy.' },
                    { name: 'Blood Sacrifice Authority', desc: 'Control the sacred bonds of sacrifice and martyrdom.' },
                    { name: 'Absolute Calculation', desc: 'Process infinite variables to achieve perfect outcomes.' }
                ]
            },
            {
                name: 'Lord of the Mysteries',
                icon: 'images/lord_of_mysteries.png',
                flavor: 'Total eclipse',
                titleEffect: 'foggy-glitch',
                isInnerGod: true,
                combinedPathways: ['Fool', 'Error', 'Door'],
                description: 'The supreme ruler of secrets and the unknown, combining the Fool\'s myriad identities, the Error\'s theft of all powers, and the Door\'s mastery of space and summoning. This entity IS mystery itself - the ultimate trickster who wears infinite masks across infinite worlds.',
                abilities: [
                    { name: 'Veil of Mystery', desc: 'Shroud reality in impenetrable fog; truth becomes unknowable.' },
                    { name: 'Fooling All', desc: 'Become anyone or anything; identity is merely a mask to wear.' },
                    { name: 'Steal Everything', desc: 'Take any power, ability, or concept as your own.' },
                    { name: 'Lord\'s Authority', desc: 'As master of mysteries, define what can and cannot be perceived.' }
                ]
            },
            {
                name: 'Eternal Darkness',
                icon: 'images/eternal_darkness.png',
                flavor: 'Abyss watcher',
                titleEffect: 'void-pulse',
                isInnerGod: true,
                combinedPathways: ['Darkness', 'Death', 'Twilight Giant'],
                description: 'The lord of the lightless realm, combining Darkness, Death, and Twilight Giant into one terrifying entity. Where this being walks, all light dies and only entropy remains.',
                abilities: [
                    { name: 'Absolute Darkness', desc: 'Create void where no light can exist and all perception fails.' },
                    { name: 'Death\'s Embrace', desc: 'Command the transition between life and death absolutely.' },
                    { name: 'Colossal Form', desc: 'Assume giant form of impossible scale and durability.' },
                    { name: 'Entropy Field', desc: 'Accelerate decay in all things within your domain.' }
                ]
            },
            {
                name: 'Anarchy',
                icon: 'images/anarchy.png',
                flavor: 'Primordial chaos',
                titleEffect: 'order-pulse',
                isInnerGod: true,
                combinedPathways: ['Black Emperor', 'Justiciar'],
                description: 'The paradoxical entity of order through chaos, combining Black Emperor\'s distortion with Justiciar\'s law. This being embodies the truth that absolute order and absolute chaos are the same.',
                abilities: [
                    { name: 'Law of Chaos', desc: 'Impose rules that only you can break; create paradoxical order.' },
                    { name: 'Reality Distortion', desc: 'Bend space, time, and causality to your whims.' },
                    { name: 'Absolute Judgment', desc: 'Enforce or revoke any law, contract, or rule instantly.' },
                    { name: 'Primordial Authority', desc: 'Tap into the chaos that existed before creation.' }
                ]
            },
            {
                name: 'Key of Light',
                icon: 'images/key_of_light.png',
                flavor: 'Refracted edge',
                titleEffect: 'holy-radiance',
                isInnerGod: true,
                combinedPathways: ['Wheel of Fortune'],
                description: 'The Sefirah pillar of fate and fortune, wielding absolute authority over probability and destiny. Every roll of the dice, every twist of fate, answers to this entity.',
                abilities: [
                    { name: 'Absolute Fortune', desc: 'Guarantee any outcome; make the impossible certain.' },
                    { name: 'Fate Rewriting', desc: 'Change what has already been determined; alter destiny itself.' },
                    { name: 'Probability Collapse', desc: 'Force all possibilities to resolve in your favor simultaneously.' },
                    { name: 'Sefirah Authority', desc: 'Command the pillar of fate that supports reality.' }
                ]
            },
            {
                name: 'Father of Devils',
                icon: 'images/father_of_devils.png',
                flavor: 'Diablo',
                titleEffect: 'abyssal-corruption',
                isInnerGod: true,
                combinedPathways: ['Abyss', 'Chained'],
                description: 'The lord of all devils and imprisoner of gods, combining the Abyss\'s corruption with the Chained\'s binding power. This entity rules the depths where fallen angels dwell.',
                abilities: [
                    { name: 'Infernal Corruption', desc: 'Corrupt anything with abyssal malice that spreads eternally.' },
                    { name: 'Divine Chains', desc: 'Bind even gods and seal their powers completely.' },
                    { name: 'Devil Summoning', desc: 'Call forth legions of devils from the deepest abyss.' },
                    { name: 'Sin Authority', desc: 'Embody and weaponize all mortal sins.' }
                ]
            },
            {
                name: 'Demon of Knowledge',
                icon: 'images/demon_of_knowledge.png',
                flavor: 'A true dictionary',
                titleEffect: 'knowledge-glow',
                isInnerGod: true,
                combinedPathways: ['White Tower'],
                description: 'The ultimate repository of all knowledge, transcending even the White Tower pathway. This entity knows everything that has been, is, or could be - and that knowledge is both power and madness.',
                abilities: [
                    { name: 'Omniscience', desc: 'Know everything - past, present, future, and all possibilities.' },
                    { name: 'Knowledge Weaponization', desc: 'Turn pure information into devastating attacks.' },
                    { name: 'Reality Analysis', desc: 'Perceive the fundamental code of existence itself.' },
                    { name: 'Forbidden Truths', desc: 'Reveal knowledge that drives minds to madness or enlightenment.' }
                ]
            },
            {
                name: 'Calamity of Destruction',
                icon: 'images/calamity_of_destruction.png',
                flavor: 'War and plague united',
                titleEffect: 'frenzy-flicker',
                isInnerGod: true,
                combinedPathways: ['Demoness', 'Red Priest'],
                description: 'The apocalyptic fusion of Demoness and Red Priest - beauty that kills and war that devastates. This entity embodies annihilation in its purest form: seductive catastrophe and fiery doom intertwined.',
                abilities: [
                    { name: 'Seductive Destruction', desc: 'Charm targets before annihilating them; death comes with a kiss.' },
                    { name: 'Plague of War', desc: 'Spread devastating diseases that ignite into infernos.' },
                    { name: 'Calamity Incarnate', desc: 'Become the disaster itself - fire, plague, and ruin made flesh.' },
                    { name: 'Apocalyptic Beauty', desc: 'Destruction so complete it becomes art; cities fall in gorgeous ruin.' }
                ]
            }
        ];

        // Inner Gods Big Hit List (for display purposes)
        const INNER_GOD_BIG_HIT_LIST = ['God Almighty', 'Key of Light', 'Father of Devils'];

        // Inner God Sefirah Groups (each is unique)
        const INNER_GOD_SEFIRAH_GROUPS = {
            'God Almighty': 'sefirah_god',
            'Lord of the Mysteries': 'sefirah_mysteries',
            'Eternal Darkness': 'sefirah_darkness',
            'Anarchy': 'sefirah_anarchy',
            'Key of Light': 'sefirah_light',
            'Father of Devils': 'sefirah_devils',
            'Demon of Knowledge': 'sefirah_knowledge',
            'Calamity of Destruction': 'sefirah_calamity'
        };

        // ============================================
        // INNER GOD SUMMON SYSTEM
        // ============================================

        // Check which Inner Gods are available based on drawn pathways
        function checkAvailableInnerGods() {
            if (gameType !== 'inner_vs_outer') return [];

            const available = [];
            const drawnPathways = gameState.drawnPathwaysThisGame;

            INNER_GODS.forEach(god => {
                // Check if all required pathways have been drawn
                const allPathwaysDrawn = god.combinedPathways.every(pathway =>
                    drawnPathways.has(pathway)
                );

                // Check if this god is not already in the available list
                const notAlreadyAvailable = !gameState.availableInnerGods.includes(god.name);

                if (allPathwaysDrawn && notAlreadyAvailable) {
                    available.push(god.name);
                }
            });

            return available;
        }

        // Update the Inner God summon area UI
        function updateInnerGodSummonArea() {
            const summonArea = document.getElementById('inner-god-summon-area');
            const summonList = document.getElementById('inner-god-summon-list');

            if (!summonArea || !summonList) return;

            // Safety check for gameState
            if (typeof gameState === 'undefined' || !gameState.availableInnerGods) {
                summonArea.classList.remove('has-gods');
                summonList.innerHTML = '';
                return;
            }

            // Only show in inner_vs_outer mode when playing as pathways and when gods are available
            if (gameType !== 'inner_vs_outer' || innerVsOuterPlayerSide !== 'pathways' || gameState.availableInnerGods.length === 0) {
                summonArea.classList.remove('has-gods');
                summonList.innerHTML = '';
                return;
            }

            summonArea.classList.add('has-gods');
            summonList.innerHTML = '';

            gameState.availableInnerGods.forEach(godName => {
                const god = INNER_GODS.find(g => g.name === godName);
                if (!god) return;

                const item = document.createElement('div');
                item.className = 'inner-god-summon-item';
                item.innerHTML = `
                    <img src="${god.icon}" alt="${god.name}">
                    <div class="god-info">
                        <div class="god-name">${god.name}</div>
                        <div class="god-hint">${god.combinedPathways.join(' + ')}</div>
                    </div>
                    <button class="summon-btn">SUMMON</button>
                `;
                item.onclick = () => summonInnerGod(godName);
                summonList.appendChild(item);
            });
        }

        // Summon an Inner God to play this turn
        function summonInnerGod(godName) {
            // Can only summon during card selection phase (not during ability phase or after playing)
            if (gameState.gameOver || waitingForOpponent || gameState.abilityPhaseActive) {
                addLogEntry('Cannot summon right now!', 'info');
                return;
            }

            const god = INNER_GODS.find(g => g.name === godName);
            if (!god) return;

            // Remove from available list (consumed)
            gameState.availableInnerGods = gameState.availableInnerGods.filter(n => n !== godName);

            // Clear the drawn pathways for this god's components so it must be earned again
            god.combinedPathways.forEach(pathway => {
                gameState.drawnPathwaysThisGame.delete(pathway);
            });

            // Set the Inner God as the card being played
            gameState.playingInnerGod = godName;

            // Update UI
            updateInnerGodSummonArea();

            // Log the summon
            addLogEntry(` ${godName} has been summoned! This ancient power will fight for you this turn!`, 'win');

            // Auto-play the Inner God
            playInnerGodCard(godName);
        }

        // Play the Inner God card (replaces normal card selection)
        function playInnerGodCard(godName) {
            const god = INNER_GODS.find(g => g.name === godName);
            if (!god) return;

            // Clear any selected card
            gameState.selectedCard = null;

            // Determine opponent's card - use forced card if set, otherwise AI selection
            let opponentCard;
            if (gameState.forcedOpponentCard) {
                opponentCard = gameState.opponentHand.find(c => c.name === gameState.forcedOpponentCard);
                if (!opponentCard) {
                    opponentCard = aiSelectCard(null); // Inner God, no player card to counter
                }
                gameState.forcedOpponentCard = null;
            } else {
                opponentCard = aiSelectCard(null); // Inner God, no player card to counter
            }

            // Show the Inner God in the player's played area
            const playerPlayedEl = DOM.get('player-played');
            const opponentPlayedEl = DOM.get('opponent-played');

            playerPlayedEl.className = 'played-card revealed inner-god-card';
            playerPlayedEl.style.background = 'linear-gradient(135deg, #4b0082, #8a2be2)';
            playerPlayedEl.innerHTML = `
                <div class="inner-god-name title-text ${god.titleEffect}">${godName}</div>
            `;

            opponentPlayedEl.className = 'played-card revealed';
            opponentPlayedEl.style.background = 'linear-gradient(135deg, #4a1a1a, #2a0a0a)';
            const opponentBigHitList = getOpponentBigHitList();
            const opponentIsBigHit = opponentBigHitList.includes(opponentCard.name);
            opponentPlayedEl.innerHTML = `
                <div class="card-icon"><img src="${opponentCard.icon}" alt="${opponentCard.name}"></div>
                <div class="card-name ${opponentIsBigHit ? 'rainbow' : ''}" ${!opponentIsBigHit ? 'style="color: var(--color-gold);"' : ''}>${opponentCard.name}</div>
            `;

            // Resolve the battle
            resolveBattle(godName, opponentCard.name);

            // Clear turn-based ability states after battle resolution
            gameState.forcedPlayerCard = null;
            gameState.playerBlinded = false;
            gameState.opponentBlinded = false;
            gameState.foolDecoyActive = false;
            gameState.foolDecoyCardIndex = null;
            gameState.playingInnerGod = null;

            updateUI();

            if (gameState.playerHP <= 0 || gameState.opponentHP <= 0) {
                gameState.gameOver = true;
                showGameOver();
                return;
            }

            gameState.turn++;
            gameState.handsRevealed = false; // Reset Supernova reveal

            setTimeout(() => {
                drawHands();
                renderHand();
                renderOpponentHand();

                playerPlayedEl.className = 'played-card empty';
                playerPlayedEl.style.background = '';
                playerPlayedEl.innerHTML = '<div>Your Card</div>';

                opponentPlayedEl.className = 'played-card empty';
                opponentPlayedEl.style.background = '';
                opponentPlayedEl.innerHTML = '<div>Opponent\'s Card</div>';

                updateUI();
                showAbilityPhase();
            }, 1500);
        }

        // ============================================
        // OUTER DEITIES DATA
        // ============================================
        const OUTER_DEITIES = [
            {
                name: 'Mother Goddess of Depravity',
                icon: 'images/Mother Goddess of Depravity.png',
                flavor: 'Origin of Evil; Mother of All',
                sefirah: 'Brood Hive',
                targetedPathways: ['Moon', 'Mother'],
                abilityCategory: 'outer_depravity',
                description: 'The Mother Goddess of Depravity represents the corruption of life and fertility itself. She births monstrous offspring and spreads depravity through desire and flesh. Her influence twists maternal instincts into something horrific, and her followers embrace corruption as enlightenment.',
                abilities: [
                    { name: 'Corruption of Flesh', desc: 'Twist living matter into depraved forms that serve the Mother.' },
                    { name: 'Birth of Monsters', desc: 'Spawn horrific offspring to overwhelm enemies.' },
                    { name: 'Maternal Domination', desc: 'Subvert maternal bonds and instincts to serve depravity.' },
                    { name: 'Depravity\'s Embrace', desc: 'Convert enemies through overwhelming corruption of body and soul.' }
                ]
            },
            {
                name: 'Mother Tree of Desire',
                icon: 'images/Mother Tree of Desire.png',
                flavor: 'Father of Devils; Heartless God',
                sefirah: 'Tenebrous World',
                targetedPathways: ['Abyss', 'Chained'],
                abilityCategory: 'outer_desire',
                description: 'The Mother Tree of Desire grants wishes at terrible cost. Devils serve this entity, binding mortals through contracts of temptation. Every desire fulfilled creates chains of obligation, and the Tree feeds on the souls of those who bargain.',
                abilities: [
                    { name: 'Wish Granting', desc: 'Grant any desire in exchange for binding contracts.' },
                    { name: 'Devil Summoning', desc: 'Call forth devils to enforce contracts and tempt mortals.' },
                    { name: 'Soul Binding', desc: 'Forge unbreakable contracts that claim souls.' },
                    { name: 'Temptation Incarnate', desc: 'Manifest the deepest desires of targets to control them.' }
                ]
            },
            {
                name: 'Son of Chaos',
                icon: 'images/Son of Chaos.png',
                flavor: 'The Anarchy; Indefinable Mist',
                sefirah: 'Nation of Disorder',
                targetedPathways: ['Black Emperor', 'Justiciar'],
                abilityCategory: 'outer_chaos',
                description: 'The Son of Chaos embodies pure disorder and the dissolution of all structure. Where this entity touches, laws break down, authority crumbles, and reality becomes fluid. It is formless, directionless, and utterly antithetical to civilization.',
                abilities: [
                    { name: 'Reality Dissolution', desc: 'Break down the laws governing existence in an area.' },
                    { name: 'Chaos Propagation', desc: 'Spread disorder that corrupts order and structure.' },
                    { name: 'Formless Existence', desc: 'Exist without fixed form, immune to targeted effects.' },
                    { name: 'Anarchy Field', desc: 'Create zones where no rules or authorities can function.' }
                ]
            },
            {
                name: 'Circle of Inevitability',
                icon: 'images/Circle of Inevitability.png',
                flavor: 'The Eternal Cycle',
                sefirah: 'Key of Light',
                targetedPathways: ['Wheel of Fortune', 'Fool', 'Error'],
                abilityCategory: 'outer_inevitability',
                description: 'The Circle of Inevitability represents the eternal recurrence of all things. Past, present, and future fold into one endless loop. Nothing truly ends, nothing truly beginsall events repeat in infinite variation. Escape is impossible; everything returns.',
                abilities: [
                    { name: 'Cyclical Fate', desc: 'Trap targets in repeating loops of events.' },
                    { name: 'Inevitable Return', desc: 'Ensure that what was destroyed will rise again.' },
                    { name: 'Temporal Folding', desc: 'Merge past and future into the present moment.' },
                    { name: 'Pattern Imposition', desc: 'Force events to follow predetermined cycles.' }
                ]
            },
            {
                name: 'Primordial Hunger',
                icon: 'images/Primordial Hunger.png',
                flavor: 'Symbol of Devouring',
                sefirah: 'Chaos Sea / City of Calamity',
                targetedPathways: ['Hanged Man'],
                abilityCategory: 'outer_hunger',
                description: 'The Primordial Hunger is consumption given form. It devours without thought, without purpose, without end. Stars, souls, conceptsall are food. It represents the ultimate entropy of the universe, the mouth that swallows everything.',
                abilities: [
                    { name: 'Absolute Consumption', desc: 'Devour anythingmatter, energy, concepts, souls.' },
                    { name: 'Hunger Aura', desc: 'Drain vitality from all nearby existence.' },
                    { name: 'Endless Appetite', desc: 'Grow stronger with each thing consumed.' },
                    { name: 'Void Maw', desc: 'Open portals to endless consuming darkness.' }
                ]
            },
            {
                name: 'Supernova Dominator',
                icon: 'images/Supernova Dominator.png',
                flavor: 'Ruler of Stars',
                sefirah: 'Chaos Sea',
                targetedPathways: ['Sun', 'Tyrant'],
                abilityCategory: 'outer_supernova',
                description: 'The Supernova Dominator commands stellar authoritythe power of suns, the fury of cosmic explosions, the light that burns across galaxies. This entity operates on scales that dwarf worlds, with power that purifies through annihilation.',
                abilities: [
                    { name: 'Stellar Purification', desc: 'Unleash cleansing fire of cosmic intensity.' },
                    { name: 'Cosmic Authority', desc: 'Command astronomical forces and phenomena.' },
                    { name: 'Supernova Release', desc: 'Channel the explosive death of stars as weapons.' },
                    { name: 'Light Absolute', desc: 'Create light so intense it annihilates darkness and corruption.' }
                ]
            },
            {
                name: 'Inextinguishable Ravings',
                icon: 'images/Inextinguishable Ravings.png',
                flavor: 'Philosophical Essence',
                sefirah: 'Knowledge Moor',
                targetedPathways: ['Hermit', 'Paragon'],
                abilityCategory: 'outer_ravings',
                description: 'The Inextinguishable Ravings represent knowledge corrupted into madness. Every truth learned from this entity comes wrapped in insanity. Scholars who seek its wisdom find their minds unraveling as forbidden understanding floods in.',
                abilities: [
                    { name: 'Maddening Wisdom', desc: 'Grant knowledge that destroys sanity.' },
                    { name: 'Philosophical Dissolution', desc: 'Break minds through impossible concepts.' },
                    { name: 'Raving Infection', desc: 'Spread madness through shared information.' },
                    { name: 'Truth Corruption', desc: 'Turn understanding itself into a weapon against the knower.' }
                ]
            },
            {
                name: 'Monarch of Decay',
                icon: 'images/Monarch of Decay.png',
                flavor: 'Irreversible Entropy',
                sefirah: 'River of Eternal Darkness',
                targetedPathways: ['Darkness', 'Death', 'Twilight Giant'],
                abilityCategory: 'outer_decay',
                description: 'The Monarch of Decay embodies entropythe universal truth that all things end. Patient and absolute, this entity need not act; simply existing accelerates the decay of everything nearby. Time, matter, hopeall rot eventually.',
                abilities: [
                    { name: 'Entropic Field', desc: 'Accelerate decay in all matter and energy.' },
                    { name: 'Patient Dissolution', desc: 'Wait while everything around slowly crumbles.' },
                    { name: 'Inevitable Ending', desc: 'Ensure that nothing can resist eventual decay.' },
                    { name: 'Rot Authority', desc: 'Command the process of deterioration itself.' }
                ]
            },
            {
                name: 'High-Dimensional Overseer',
                icon: 'images/High-Dimensional Overseer.png',
                flavor: 'Lord of Dimensions',
                sefirah: 'Sefirah Castle',
                targetedPathways: ['Door', 'Visionary'],
                abilityCategory: 'outer_overseer',
                description: 'The High-Dimensional Overseer perceives reality from perspectives impossible for lower beings. It exists across multiple dimensions simultaneously, seeing through all illusions, escaping all traps, understanding all realities as facets of a greater whole.',
                abilities: [
                    { name: 'Dimensional Transcendence', desc: 'Exist beyond normal spatial constraints.' },
                    { name: 'Perspective Absolute', desc: 'See through all illusions and deceptions.' },
                    { name: 'Reality Shifting', desc: 'Move between dimensional states at will.' },
                    { name: 'Higher Understanding', desc: 'Comprehend existence from elevated viewpoints.' }
                ]
            },
            {
                name: 'Goddess of Fate',
                icon: 'images/Goddess of Fate.png',
                flavor: 'Weaver of All Fates',
                sefirah: 'Key of Light',
                targetedPathways: ['Wheel of Fortune'],
                abilityCategory: 'outer_fate',
                description: 'The Goddess of Fate weaves the tapestry of destiny itself. Every thread represents a life, every knot a turning point. Nothing escapes her loomeven other Outer Deities find their actions woven into her grand design.',
                abilities: [
                    { name: 'Fate Weaving', desc: 'Control the destiny of any target.' },
                    { name: 'Thread Cutting', desc: 'End lives by severing their fate threads.' },
                    { name: 'Predetermined Outcome', desc: 'Ensure specific events must occur.' },
                    { name: 'Tapestry Sight', desc: 'See all possible futures and the threads connecting them.' }
                ]
            }
        ];

        // Outer Deity Sefirah groupings
        const OUTER_DEITY_SEFIRAH_GROUPS = {
            'Mother Goddess of Depravity': 'brood_hive',
            'Mother Tree of Desire': 'tenebrous_world',
            'Son of Chaos': 'nation_of_disorder',
            'Circle of Inevitability': 'key_of_light',
            'Primordial Hunger': 'chaos_sea',
            'Supernova Dominator': 'chaos_sea',
            'Inextinguishable Ravings': 'knowledge_moor',
            'Monarch of Decay': 'river_of_darkness',
            'High-Dimensional Overseer': 'sefirah_castle',
            'Goddess of Fate': 'key_of_light'
        };

        // Outer Deity tier lists
        const OUTER_DEITY_BIG_HIT_LIST = ['Goddess of Fate', 'Circle of Inevitability', 'High-Dimensional Overseer', 'Supernova Dominator'];
        const OUTER_DEITY_MEDIUM_HIT_LIST = ['Primordial Hunger', 'Monarch of Decay'];
        const OUTER_DEITY_LOW_TIER_LIST = ['Mother Goddess of Depravity', 'Mother Tree of Desire', 'Inextinguishable Ravings', 'Son of Chaos'];

        // Outer Deity power ratings
        const OUTER_DEITY_POWER_RATINGS = {
            'Goddess of Fate': 0.90,
            'Circle of Inevitability': 0.85,
            'High-Dimensional Overseer': 0.85,
            'Supernova Dominator': 0.80,
            'Primordial Hunger': 0.65,
            'Monarch of Decay': 0.50,
            'Mother Goddess of Depravity': 0.40,
            'Mother Tree of Desire': 0.35,
            'Inextinguishable Ravings': 0.25,
            'Son of Chaos': 0.15
        };

        // Difficulty level explanations
        const DIFF_EXPLANATIONS = {
            'Low': 'A decisive advantage. The winner\'s abilities directly counter the loser with minimal resistance. Victory is almost guaranteed with competent execution.',
            'Mid': 'A clear but contested advantage. The winner has favorable matchup tools, but the loser can threaten with well-timed plays. Mistakes can be punished.',
            'High': 'A hard-fought battle. The winner holds an edge, but the loser has dangerous options that demand respect. The margin for error is thin on both sides.',
            'Extreme': 'Nearly even. Both pathways have lethal tools against each other. Victory depends heavily on timing, preparation, and capitalizing on small openings.',
            'Variable': 'Unpredictable outcome. These pathways share deep connections (same Sefirah) that create reality-warping interference. The battle could swing either way based on metaphysical factors beyond raw power.'
        };

        // Detailed matchup explanations and stories
        // Key format: "PathwayA vs PathwayB" (alphabetically ordered for non-mirrors)
        const MATCHUP_DETAILS = {
    // === MIRROR MATCHUPS ===
    'Fool vs Fool': {
        explanation: 'A battle between two Fools is a descent into infinite recursion. Because both possess the ability to manipulate history, graft concepts, and utilize Paper Figurine Substitutes, any lethal blow is instantly negated or transferred. They can summon Historical Projections of angels, but the opponent can summon the exact same projection to counter. Divinations interfere with one another, resulting in a chaotic fog of fate where neither can lock onto the "real" body of the other. It becomes a battle of spirituality consumption rather than tactical superiority, invariably ending in a stalemate as resources run dry.',
        story: 'The fog was thick, not with weather, but with the weight of history. Kleinor what looked like himsnapped his fingers, and an Air Bullet the caliber of a coastal cannon erupted. His opponent, identical in every way, didn\'t dodge. The bullet struck, tearing the figure into confettia Paper Figurine Substitute. Suddenly, the attacker felt a cold muzzle against his temple. He swapped positions with a marionette instantly, the bullet striking a wooden puppet instead. "Grafting," the first Fool whispered, connecting the concept of "beginning" to "end." The battle restarted, yet concluded simultaneously. Historical Projections of ancient wyrms emerged from the void on both sides, colliding in a mute explosion of spirituality before vanishing. They were mirrors reflecting mirrors, a corridor of infinite jesters. One pulled a miracle from the past; the other wished it away. They stood amidst a ruined city of their own making, neither having moved a single step, both knowing that to continue was to play a game of chess where every piece was a King.'
    },
    'Door vs Door': {
        explanation: 'When two Planeswalkers clash, the concept of "location" loses all meaning. Both combatants possess absolute mastery over space, allowing them to blink through the Spirit World and exile attacks into the void. If one attempts to seal the space, the other can simply Record that ability and counter-seal or blink out before the barrier forms. Attacks pass through Phasing bodies, and spatial cuts are nullified by spatial distortion. It is a high-speed game of tag across dimensions where neither can be pinned down long enough to land a decisive blow.',
        story: 'Space fractured like shattered glass. One instant, they were atop a cathedral spire; the next, they were falling through the crimson moonlight of the Spirit World. The first Traveler slashed his hand downward, a blade of distorted space slicing through where his opponent stood. But the opponent was already gone, manifested as a star-like symbol on a doorframe three miles away. "Exile," one intoned. The surrounding space folded, attempting to banish the enemy to the chaotic void. The enemy merely laughed, his body turning into a swarm of translucent worms that burrowed through the spatial barrier as if it were water. They reappeared behind the caster, mimicking the exact same exile technique. They flickered across the city, appearing as strobing lights, opening door after door. Neither could trap the other, for a door that locks is useless against a key that opens everything. They remained in perpetual motion, two ghosts haunting the same infinite hallway.'
    },
    'Error vs Error': {
        explanation: 'A confrontation between Errors is a headache of paradoxes. Both sides attempt to Steal the other\'s thoughts, abilities, and time. However, the authority of the Error pathway creates a loop: "I stole your theft of my theft." Avatars swarm the battlefield, but every main body is a decoy, and every decoy is a main body. If one tries to exploit a bug in reality, the other patches it or creates a new error to nullify the advantage. It is a logical deadlock where the victor is undecided because the timeline of the victory keeps getting stolen.',
        story: 'The gentleman adjusted his monocle. His opponent, standing across the clock tower, adjusted an identical monocle on the same eye. "Interesting," they said in unison. The first Error reached out, stealing the distance between them. He arrived instantly, driving a dagger into the opponent\'s chest. The opponent didn\'t bleed; instead, he stole the "damage" and grafted it onto a gargoyle nearby, which crumbled to dust. "I\'ll take that," the second Error smiled, stealing the first one\'s intention to attack. The first one paused, confused, before stealing the second one\'s stolen time to regain his initiative. Clocks spun wildly, hands moving backward and forward. Avatars parasitized avatars, a nesting doll of deception. They stood frozen for an hour, though only a second passed, locked in a mental battle of theft and counter-theft. Finally, they both tipped their hats. To continue would be a glitch in the universe that even they couldn\'t rationalize.'
    },
    'Visionary vs Visionary': {
        explanation: 'The battle of Visionaries is silent and terrifying. It is a war of scripts. One writes a reality where they win; the other perceives this weaving of the subconscious and rewrites the narrative to make that victory a dream. They drag each other into collective mindscapes, summoning imaginary dragons and angels. However, since their mental authorities are equal, neither can fully hypnotize or dominate the other. The fabric of reality shifts constantlya sunny day becomes a storm, then a voidas they edit the world in real-time, resulting in a narrative deadlock.',
        story: 'The dusty saloon didn\'t exist. Neither did the sun outside. They were floating in a blank white void, yet both perceived a bustling city. "The enemy stumbles, his heart failing," the first Visionary spoke, the words vibrating with the power of Author. "But that was merely a hallucination caused by his own anxiety," the second Visionary countered, smoothing the page of a golden book. The heart attack vanished. In the mindscape, a Spectator dragon roared, diving down. The opponent imagined a giant cross, pinning the dragon to the ground. Reality warped like wet clay. They sat across from each other at a table that appeared and disappeared with their focus. One tried to plant a psychological cue; the other noticed it and treated it as a performance. They were two gods arguing over the plot of a book they were both writing. Without a difference in sequence or artifact, the story could never end, trapped in eternal revision.'
    },
    'White Tower vs White Tower': {
        explanation: 'This is a stalemate of perfect information. Both Polymaths analyze the situation instantly, simulating thousands of future possibilities. Before the first spell is cast, both combatants know the trajectory, the counter-spell, and the counter-counter-spell. They can imitate each other\'s abilities perfectly. Because they identify all weak points simultaneously, they effectively neutralize each other\'s offense. The fight often resembles two statues staring at one another, as any move is deemed "statistically disadvantageous" before it is even made.',
        story: 'The library was silent. The first White Tower Beyonder raised a finger, preparing a spell of blazing sunlight. He stopped. His eyes of wisdom saw that his opponent had already calculated the refraction angle and prepared a mirror shield. He shifted his stance to use a psychic pierce. The opponent shifted his weight to the left, pre-emptively dodging the invisible vector. "Probability of success: 0.0001%," the first muttered. "Agreed," the second replied. They stood amidst a storm of data, eyes glowing white. They simulated a fistfight; it ended in a double knockout. They simulated a magical duel; it ended in mutual exhaustion. They imitated each other\'s breathing techniques, canceling out any stamina advantage. To an observer, nothing was happening. To them, they had already fought a thousand wars in the span of a heartbeat, every single one ending in a draw.'
    },
    'Sun vs Sun': {
        explanation: 'When two sources of absolute light clash, shadows cease to exist, but so does victory. Both utilize Unshadowed domains, Holy Light, and Purification. However, one cannot purify that which is already pure. Their defensive buffs (Armor of Light) negate their offensive capabilities (Holy Fire). Notary contracts made to bind the opponent are countered by the opponent\'s own authority to authenticate or deny. It is a contest of raw output, turning the battlefield into a blinding white hell where neither can be corrupted or harmed.',
        story: 'The catacombs were instantly vaporized, replaced by a searing, holy brilliance. A pillar of sacred fire descended, only to be caught by a hand glowing with the same radiance. "Purge!" shouted the first Priest. "Sanctify!" roared the second. The competing domains of light clashed, pressing against each other like physical walls. The ground turned to glass. One summoned a cross of light to impale the other; the other chanted a hymn, buffing his defense until he was harder than diamond. They were immune to each other\'s fear induction. They cleansed each other of non-existent sins. It was like trying to burn fire with fire. The intensity grew until the air itself ionized, but the two golden figures stood amidst the annihilation, untouched, their holiness canceling out the judgment of the other.'
    },
    'Tyrant vs Tyrant': {
        explanation: 'A mirror match of Tyrants is a natural disaster. Hurricanes collide with tsunamis, and lightning strikes are intercepted by other lightning strikes. Since both possess the constitution of a Sea King and resistance to electricity, their primary damage output is severely mitigated. They can both fly and breathe underwater, removing terrain advantages. The sheer volume of noise and chaos makes subtle tactics impossible, turning the fight into a brute-force stamina contest where their catastrophic attacks merely buffet each other without landing lethal damage.',
        story: 'The ocean swelled to the height of mountains. Rain fell like bullets. Two figures hovered in the eye of the storm, crackling with blue arcs of electricity. "Die!" A bolt of lightning thicker than a skyscraper fell. The opponent caught it with his bare hands, redirecting it into the churning sea. He retaliated with a singing voice that shattered the eardrums of every fish for miles. The first Tyrant grimaced but stood firm, his wind armor deflecting the sonic blast. They collided in mid-air, a boom appearing seconds later. Fists wrapped in storms met chests harder than steel. Tsunamis crashed into each other, canceling out into chaotic foam. It was a display of apocalyptic power, yet neither god of storms could drown the other.'
    },
    'Hanged Man vs Hanged Man': {
        explanation: 'This fight is a grotesque display of endurance and corruption. Both Shepherds possess grazed souls and shadows, allowing them to cycle through various abilities. However, both are highly resistant to madness and corruption. When one attempts to use Flesh Magic or degenerate whispers, the other counters with their own dark authority. They can listen to the "entity" within the other, predicting moves. Attempts to "graze" the opponent fail as their soul hierarchies are equal. It becomes a muddy, bloody attrition war of regeneration.',
        story: 'The alleyway dripped with black sludge. Shadows writhed, detaching from the walls to strike. The first Shepherd released a grazed soula wraith that screamed. The second Shepherd simply opened his mouth, his shadow rising up to devour the wraith whole. "Degenerate," one whispered. The other\'s flesh rippled, eyes appearing on his arm, but he merely laughed, using his own flesh magic to reabsorb the mutation. Blood magic clashed with blood magic, turning the cobblestones slick. They slashed at each other with swords formed of shadows, wounds healing moments after opening. They knew the madness in the other\'s eyes because they shared it. It was a stalemate of suffering, two monsters trying to corrupt what was already rotten.'
    },
    'Darkness vs Darkness': {
        explanation: 'A battle that effectively does not happen. Both combatants utilize Concealment, erasing their presence, sound, and concept from the world. They exist in a state of "Horror," putting enemies to sleep, but both have high resistance to slumber and fear. If one creates a domain of darkness, the other feels right at home. Attacks are silent and invisible, but so are the dodges. They essentially vanish from reality, stalking each other in a void where neither can find the purchase to land a killing blow.',
        story: 'The lantern flickered and died. Silence fellabsolute, unnatural silence. There was no wind, no breath, no heartbeat. The first Nightwatcher merged with the shadows, erasing his existence. The second did the same. To an observer, the street was empty. Inside the realm of darkness, a blade of pure midnight swung. It passed through empty air. A Spirit Body traveled through the reflection of a puddle, emerging to strike, but the target had already Concealed his location. They were two voids circling each other. The soothing lullaby of the Evernight descended, but both minds remained cold and awake. It was a peaceful war, a duel of nothingness where the only winning move was to remain hidden longer than the other.'
    },
    'Death vs Death': {
        explanation: 'A war of attrition involving armies that cannot die. Both Death pathway Beyonders command the undead, creating skeletons, zombies, and wraiths. However, they both possess authority over these creatures, leading to a situation where minions switch sides constantly or simply stand confused. Lethal attacks like "Death Knell" are less effective against those who are already half-dead. They can navigate the Underworld freely, making entrapment impossible. It ends up being a dull clash of spirit energy where bodies pile up but the controllers remain safe.',
        story: 'The graveyard soil churned. A skeletal hand burst forth, followed by a thousand more. The first Death Consul raised his pale hand, and the army charged. The second Consul raised his scythe, and the army halted, confused by the conflicting commands of authority. "Wither," the first intoned. The second\'s skin greyed, but he simply shed the decaying layer like a snake. They launched Spirit Piercings that vanished into the other\'s massive spirit bodies. A colossal bone dragon erupted from the ground, only to be dismantled bone by bone by the opponent\'s Necromancy. They stood amidst a swirling vortex of souls, the gate to the Underworld open wide, yet neither could push the other through. They were gatekeepers of the same door, refusing to let the other pass.'
    },
    'Twilight Giant vs Twilight Giant': {
        explanation: 'The definition of an unstoppable force meeting an immovable object. Both combatants rely on overwhelming physical strength, dawn armor, and massive weaponry. They are immune to most status effects and possess "decay" abilities that rot surroundings. However, their physical defenses are so high that they can tank each other\'s hits for days. The landscape is destroyed utterlymountains flattened, cities razedbut the giants themselves remain standing, locked in a contest of sheer stamina and durability.',
        story: 'The ground shook with the force of a tectonic shift. Two giants, twenty meters tall and clad in the armor of twilight, collided. The shockwave flattened the surrounding forest instantly. A claymore the size of a ship\'s mast swung down. The opponent caught it on a shield of solidified dusk light. Sparks showered like fireworks. "ROAR!" The shout shattered boulders. They traded blows that would kill dragons. Armor cracked and regenerated. They commanded the earth to swallow the other, but both stood firm, immovable. The sky turned orange as they summoned the light of dusk, decaying the very air, but their bodies were built to endure the end of days. It was a slugfest of mythic proportions, simple, brutal, and endless.'
    },
    'Red Priest vs Red Priest': {
        explanation: 'A battlefield of chaos where tactics cancel out. Both are master strategists and manipulators of war. They set traps, but the opponent anticipates them. They try to provoke the other into a rage, but both thrive in frenzy. The area turns into a sea of fire, but Red Priests are immune to high temperatures and can control the flames. Iron and blood fly, but the "Conspirator" ability ensures that every plot has a counter-plot. It is a stalemate of intelligence and firepower.',
        story: 'The trenches were burning. The first War Bishop snapped his fingers, and the air detonated into a fireball. The second Bishop inhaled, sucking the flames into his lungs and exhaling a spear of white-hot plasma. "Your left flank is exposed," the first taunted, trying to Incite madness. "A feint," the second replied, clear-headed despite the Battle Frenzy. Steel swords, enhanced by spirituality, clashed with the ringing of bells. They orchestrated invisible armies, setting up kill zones that the other avoided perfectly. The ground melted into magma. They fought inside the inferno, laughing, two gods of war playing a game of chess where the board was on fire and the pieces were screaming.'
    },
    'Demoness vs Demoness': {
        explanation: 'A deadly dance where the primary weaponscharm and diseaseare rendered useless. A Demoness is immune to the plagues of another, and their charm has little effect on a being of the same pathway (who understands the manipulation perfectly). They rely on invisible threads, black flames, and mirrors. They can substitute with mirrors to avoid death. The fight is a spectacle of agility and cruelty, but with their high regeneration and escape mechanics, neither can pin the other down long enough to kill.',
        story: 'The ballroom was filled with invisible webs. A beautiful woman in black smiled, her charm radiating like perfume. The woman in white across from her sneered, unaffected. "Pestilence," the woman in black whispered. A cloud of pathogens exploded. The woman in white walked through it, breathing deeply. "Delicious." They moved faster than the eye could follow. Invisible threads snapped taut, slicing stone pillars but sliding harmlessly off hardened skin. Mirrors shattered in sequence as they swapped places, appearing and disappearing. Black flames that froze the soul licked at their heels. It was a fight of vanity and viciousness, scratching and tearing, but the wounds healed instantly. They were reflections in a broken mirror, unable to destroy the image without destroying themselves.'
    },
    'Justiciar vs Justiciar': {
        explanation: 'A bureaucratic deadlock. Both Arbiters define the "rules" of the battle. One says "Flying is prohibited," the other enforces "Ground movement is prohibited." They layer restrictions until they can barely move, or their rules contradict and shatter. Their high defense and "Order" capabilities make them tanks. Punishments like "Psychic Whip" are resisted by their disciplined minds. It becomes a legal battle of who has the higher authority, but with equal sequence, no law binds the other permanently.',
        story: 'The air grew heavy with the weight of Order. "Prohibition: Lethal Force," the first Justiciar declared. A bronze sheen covered the area. The bullets fired by the second dropped harmlessly. "Deprivation: Speech," the second countered. The first\'s mouth sealed shut. But the first simply wrote a new rule in the air with his finger. "Distortion: Exemption." The rules layered over one another, forming a cage of logic. They stood rigid, armor gleaming, trading verdicts. One summoned a gavel of light; the other summoned a scale to weigh the attack, finding it lacking. The world around them froze into a grey tableau of absolute order, where nothing could change, and therefore, no one could win.'
    },
    'Black Emperor vs Black Emperor': {
        explanation: 'A chaotic mess where disorder is the norm. Both specialize in "Distortion"twisting the logic of attacks, distance, and intent. If one attacks, the other distorts the direction. If one tries to impose a rule, the other subverts it. They grow in size, their "bribe" abilities canceling out aggression momentarily. The battle is a headache of shifting realities where up is down, near is far, and lethal damage is distorted into a light tap. Since both thrive on chaos, the environment collapses, but the combatants remain.',
        story: 'The Black Emperor grew to the size of a tower. "Gravity is reversed!" Debris floated up, but the Fool remained anchored. The Emperor swiped a massive hand, Distorting the space to ensure the hit connected. Reality bent like a funhouse mirror. Distance became meaninglessa step forward moved you backward. They threw distortions at each other until the very concept of "direction" gave up. The battlefield was a abstract painting, colors and shapes defying geometry. Neither could land a clean hit because "clean" had been distorted into "messy."'
    },
    'Hermit vs Hermit': {
        explanation: 'A duel of classic wizardry. Both use starlight, scrolls, and fairy tales. They can analyze the "secrets" of the other\'s spells to dismantle them. Mystical re-enactment allows them to cast powerful magic, but the opponent knows the exact counter-spell. The Hidden Sage\'s whispers affect both, or neither. They turn into information streams to dodge physical damage. It is a spectacle of lights and geometry, but their knowledge of the arcane is too matched for a surprise victory.',
        story: 'Stars fell from the ceiling. The first Mystic unfolded a scroll, bringing the story of "The Dragon and the Knight" to life. A fire-breathing construct emerged. The second Mystic pushed up his glasses and cast "Deconstruction," turning the dragon back into ink and paper. Beams of pure starlight crisscrossed the room. They turned into streams of data, bypassing walls and reappearing to cast curses. "I see your fate," one proclaimed. "And I have rewritten the variables," the other retorted. They threw potions, scrolls, and gaze attacks. The environment shifted from a library to a galaxy. It was a battle of scholars, precise and dazzling, but ultimately a peer review where neither paper was accepted.'
    },
    'Paragon vs Paragon': {
        explanation: 'An industrial war of attrition. Both control machinery, alter physical constants, and optimize efficiency. If one builds a turret, the other hacks it or builds a shield perfectly calibrated to stop that caliber. They engage in a resource war, constructing golems and artillery instantly. "Civilization" domains allow them to rewrite the laws of physics in the area, but these cancel out. It ends with broken gears, scrap metal, and two inventors standing amidst the wreckage calculating that further combat is inefficient.',
        story: 'The factory floor came alive. Gears spun, and steam hissed. The first Artisan slammed his hand on the ground, and the metal floor folded up into a giant mechanical spider. The second Artisan merely pointed, and the spider\'s joints rusted instantly, collapsing it. "Conductivity: Zero," one stated. Lightning weapons failed. "Friction: Max," the other countered. The first was stuck to the floor. They threw alchemical grenades and commanded armies of clockwork puppets. Lasers cut through smoke. It was a storm of steel and mathematics. Every invention was met with a perfect dismantlement. They were two engineers trying to disassemble each other while simultaneously building defenses. The noise was deafening, the result: 50% scrap, 50% stalemate.'
    },
    'Mother vs Mother': {
        explanation: 'A battle of overflowing life. Both command nature, healing, and biological manipulation. Vines choke vines; forests sprout instantly to block attacks. If one is injured, they regenerate in seconds. They can summon giant creatures, but the opponent can pacify or control them. Life Deprivation is countered by Life Bestowal. The battlefield becomes an impenetrable jungle of flesh and blood, a biological singularity where death is banned and the fight continues eternally.',
        story: 'The wasteland bloomed instantly. Enormous roots erupted, shattering the bedrock. The first Planter summoned a horde of hybrid beastswolves with insect mandibles. The second Planter released a cloud of pheromones, and the beasts turned docile, lying down. "Wither," one commanded. The plants turned brown. "Bloom," the other whispered. They exploded back into green vibrancy. They stood in a garden of horrors, flesh warping and healing. Arms were cut off and regrown. Poison was absorbed as nutrients. It was a sickeningly vibrant display of vitality, a cancer of life fighting itself, growing ever larger but never concluding.'
    },
    'Moon vs Moon': {
        explanation: 'A frantic, bloody clash of beasts. Both turn into vampires or giant wolves, possessing extreme speed, regeneration, and dark magic. They summon the Crimson Moon to freeze the opponent, but the opponent is attuned to the same moon. Poisons don\'t work. Injuries heal instantly. It is a blur of claws and fangs, a savage brawl where the damage output cannot keep up with the recovery rate.',
        story: 'The crimson moon hung low. Two blurs collided, creating a shockwave of red light. Claws tore through flesh, but the wounds knitted together before the blood could hit the ground. "Freeze!" The moonlight solidified, binding one. He shattered it with a flex of raw strength, transforming into a giant wolf. The other matched the form. They tumbled, tearing at throats. Darkness corroded the ground. They summoned bats to swarm, but the bats refused to attack a master of the Moon. It was a primal, endless feast of violence where the main course was never finished.'
    },
    'Chained vs Chained': {
        explanation: 'A contest of restraint and endurance. Both are "Prisoners" of their own desires, capable of possessing enemies (Wraith) and silencing areas. However, they can restrain the other\'s spirit body. Chains bind chains. Curses are cast, but their tolerance for pain and curse is absolute. The fight is often stationarytwo figures staring at each other, suppressing the other\'s abilities, locked in a psychic and physical grapple where neither can escape the other\'s seal.',
        story: 'Silence. The room was dark. Chains rattled from nowhere, wrapping around the first Prisoner. He didn\'t struggle; instead, he liquified, turning into a Wraith to slip the bonds. He dove into the opponent\'s body to possess him. The opponent\'s mind was a steel trap. He clamped down, trapping the intruder inside. "Get out," the second hissed. "Make me." They fought on the spiritual plane, tearing at souls. Physical bodies sat slumped like dolls. Curses rotted the furniture. It was a battle of will, a quiet, terrifying struggle of two madmen in straitjackets trying to strangle each other with their minds.'
    },
    'Abyss vs Abyss': {
        explanation: 'A descent into madness that both enjoy. Both use the "Language of Foulness" to corrupt and damage, but Devils are resistant to corruption. Magma and sulfur fill the arena. They transform into mythological demon forms, trading blows that carry extreme mental contamination. Since they are both already "depraved," the mental attacks are like casual conversation. It\'s a dirty, sluggish brawl in the mud of the Abyss.',
        story: 'The air smelled of sulfur and rot. "Die, filth," the first Devil spat, the words carrying a lethal curse. The second Devil laughed, the curse sliding off his slimy skin. "Is that all?" They expanded into hulking demonic forms, horns clashing. Magma erupted from the cracks in the floor. They flung balls of corrosive acid and filth. Danger intuition warned them of every strike, leading to perfect dodges. They wallowed in the corruption, two monsters in a pit, tearing at each other with delight, neither finding the madness effective against a creature born of it.'
    },
    'Wheel of Fortune vs Wheel of Fortune': {
        explanation: 'The most absurd of all matchups. A battle of pure probability. One tries to make the other unlucky; the other resets fate. Attacks miss due to banana peels, sudden gusts of wind, or birds flying in the way. Critical hits become grazes. Infinite loops of "Reboot" occur whenever one is about to lose. It is a slapstick comedy where the universe bends over backward to ensure neither side gets what they want.',
        story: 'The Monster raised a gun. He fired. The gun jammed. He threw the gun. The opponent slipped on a wet patch, dodging the throw, but fell onto a sharp rock. "Ouch," the opponent said, unharmed due to a "lucky" angle of impact. The opponent cast "Misfortune." A chandelier fell. The first Monster tripped, and the chandelier missed him by an inch, crushing the floor where he just stood. "Reboot," one whispered, sensing a bad future. The fight restarted. They threw dice. Both landed on zeroa result that shouldn\'t exist. Coins landed on their edges. Lightning struck the ground between them. They stood in the center of a probability storm, untouched, realizing that fate refused to pick a winner.'
    },

    // === FOOL VS ALL ===
    'Abyss vs Fool': {
        explanation: 'The Abyss relies on corruption and "Danger Intuition," but the Fool is the ultimate deceiver. The Fool can use Paper Figurine Substitutes to absorb the fatal corruption of the Abyss or Graft the concept of "corruption" onto a random object nearby. While the Abyss can sense danger, the Fool\'s attacks often come from history or grafted concepts, which do not register as immediate threats until it is too late. The Fool eventually traps the Devil in a loop of false realities, baiting them into a fatal mistake.',
        story: 'The Devil roared, magma erupting from his skin. "I smell your fear!" he bellowed, lunging at the figure in the trench coat. The figure dissolved into paper confetti. "You smell only paper," a voice whispered from everywhere. The Devil spun, sensing a lethal threat from the right. He unleashed a torrent of filth, but it hit nothing. The Fool stood on a steeple, manipulating invisible threads. He didn\'t attack directly; instead, he Grafted the coordinates of the "sky" to the "ground" beneath the Devil\'s feet. The Devil fell upward, disoriented. "Corruption!" the Devil screamed, unleashing a mental plague. The Fool summoned a Historical Projection of an angel to purify it instantly. The Devil found himself fighting a shadow, then a puppet, then a memory of himself. He was drowning in a play where the director hated him. Finally, the Fool snapped his fingers, and the "distance" between the Devil\'s heart and a supernova in history was removed.'
    },
    'Black Emperor vs Fool': {
        explanation: 'The Black Emperor dominates by Distorting rules and enforcing disorder, but the Fool cheats reality entirely. When the Black Emperor distorts the path of a bullet, the Fool Grafts the bullet\'s destination directly to the Emperor\'s head, bypassing the path entirely. Historical Projections allow the Fool to summon armies that are unaffected by the Emperor\'s specific authority over the present laws. The Fool\'s ability to "fool" time and fate overrides the Black Emperor\'s ability to distort space and law.',
        story: 'The Black Emperor grew to the size of a tower, his voice twisting the laws of physics. "Gravity is reversed!" Debris floated up, but the Fool remained anchored. "Gravity is a concept," the Fool murmured, "and I have grafted myself to the floor." The Emperor swiped a massive hand, Distorting the space to ensure the hit connected. It struck a Marionette instead. The real Fool emerged from the Spirit World behind the giant. "Disorder!" the Emperor commanded, trying to scatter the Fool\'s spirituality. The Fool laughed, pulling a jeweled glove from the void. He didn\'t fight the distortion; he simply stole the Emperor\'s thought process, causing him to forget the next rule. Taking advantage of the confusion, the Fool summoned a projection of a God-slayer spear from the Fourth Epoch. Before the Emperor could distort the damage, the spear was already embedded in his chest, the concept of "hit" having been established before the throw.'
    },
    'Chained vs Fool': {
        explanation: 'The Chained pathway excels at restriction and possession, but they cannot bind a target that can turn into paper or vanish into history. The Fool\'s Marionettes are immune to the Chained\'s curses, serving as perfect proxies. If the Chained attempts to possess the Fool, they risk entering the Sefirah Castle, a domain of absolute dominance for the Fool. The Fool simply kites the Chained, using Historical Projections to wear them down while remaining untouchable.',
        story: 'Chains of condensed curse-power shot from the shadows, wrapping tight around the Fool\'s throat. The Chained Beyonder pulled, expecting to drag the soul out. Instead, the figure collapsed into a pile of paper scraps. "Predictable," came the whisper. The Chained silenced the area, preventing vocal spells, and turned into a Wraith to possess the enemy. He dove into the Fool\'s chestand screamed. He had possessed a Marionette made of wood and worm-spirituality. The real Fool stood safely in the Fog of History. He reached out and pinched the air, Grafting the Wraith\'s "intangibility" to "solid stone." The Wraith solidified instantly, trapped inside the wooden puppet. "A prisoner should stay in his cell," the Fool remarked, summoning a cannon from history to blast the immobilized enemy into dust.'
    },
    'Darkness vs Fool': {
        explanation: 'Darkness relies on Concealment and the element of surprise. However, the Fool is the King of Divination. The Fool can divine the location of the enemy even through concealment, or simply bombard the entire area with Historical Projections. The Fool\'s ability to summon light-based angels from history directly counters the darkness. Furthermore, the Fool can "Graft" the concept of "Daylight" into the domain of "Night," breaking the Darkness Beyonder\'s advantage.',
        story: 'The battlefield was a void of absolute midnight. No light, no sound. The Darkness Beyonder moved like a ghost, a scythe raised to harvest the Fool\'s soul. Suddenly, a blinding sun erupted in the center of the pitch black. The Fool had summoned a Historical Projection of the Sun God. The Darkness hissed, retreating as the concealment sizzled away. "Found you," the Fool said. He didn\'t use eyes; he used Spirit Threads. He saw the connections radiating from the shadow. The Darkness tried to drag the Fool into an eternal slumber. The Fool felt his eyelids droop, but his Spirit Body was already active, swapping places with a puppet. The scythe decapitated the puppet. The Fool appeared behind the Darkness, holding a staff. He didn\'t strike; he Grafted the concept of "The End" to the current moment. The Darkness found their spirituality drained instantly, the battle ending before the night could reclaim the sky.'
    },
    'Death vs Fool': {
        explanation: 'Death commands the undead and spirits, but the Fool manipulates the spirit threads that bind them. The Fool can turn the Death Beyonder\'s own army into Marionettes. While Death can kill the living, the Fool can resurrect via Miracles or hide in the Fog of History where death has no authority. The Fool\'s ability to "Graft" allows him to disconnect the concept of "Death" from himself, making lethal attacks harmless.',
        story: 'The river of the dead flowed across the plain. Wraiths wailed, and skeletal hands grasped at the Fool\'s ankles. The Death Consul stood atop a bone dragon, radiating the aura of the Underworld. "Join your ancestors," the Consul intoned, casting a Death Knell. The Fool didn\'t dodge. The attack struck, and the Fool died. Then, the Fool walked out from behind a tree. "I have died many times in history," he said. "That was just one of them." The Consul commanded the skeletons to charge, but they halted. The Fool had seized their Spirit Threads. Slowly, the army of the dead turned to face their master. The Fool tipped his hat. "Your soldiers are now my puppets." The Consul tried to sever the connection, but the Fool Grafted the "loyalty" of the army to "The Fool." Swarmed by his own minions, the Consul fell, unable to kill a man who treated death as a parlor trick.'
    },
    'Demoness vs Fool': {
        explanation: 'The Demoness relies on Charm, Seduction, and Disease. The Fool is the hard counter. Marionettes cannot be seduced or sickened. The Fool fights through proxies, staying safely out of range of the Demoness\'s plagues. If infected, the Fool transfers the disease to a Paper Figurine. The Fool\'s cold rationality and ability to see fate allow him to bypass the Demoness\'s emotional manipulations and traps.',
        story: 'The Demoness smiled, a smile that had toppled kingdoms. "Don\'t you want to rest?" she asked, her voice laced with a charm that rewrote the brain\'s desire centers. The Fool stood motionless. Then, his head fell off. It was a wooden head. "You are flirting with a log," a voice echoed from the air. The Demoness scowled, unleashing a cloud of black plague. The flowers withered; the birds fell dead. The plague rushed toward the source of the voice, but the Fool had already Grafted the "location" of the plague to the "mirror" in the Demoness\'s hand. The glass blackened and shattered. The Demoness screamed as her own toxicity reflected back onto her. She tried to turn invisible, but the Fool pulled a projection of a high-sequence Hunter from history. "Find her," he ordered. The Hunter, immune to fire and fear, flushed her out, ending the calamity.'
    },
    'Door vs Fool': {
        explanation: 'A draw caused by the interference of the same Sefirah (Sefirah Castle). Both pathways originate from the same source, causing abilities to glitch when used against each other. The Door can Exile the Fool, but the Fool can Graft his location back. The Fool can summon projections, but the Door can Replicate them. It is a battle of slippery eels; the Door cannot be trapped, and the Fool cannot be killed. They chase each other through dimensions and history, neither gaining a definitive edge.',
        story: 'The Fool reached out to turn the Door Beyonder into a marionette. The Spirit Threads vibratedand vanished. The Door had blinked into the Spirit World. "Spatial Exile," the Door mage chanted, banishing the Fool to the turbulent void. Seconds later, the Fool stepped out of a door he drew in the air. "Grafting," he explained, having connected the void to the battlefield. They stood ten paces apart. The Fool summoned a meteor; the Door opened a portal and sent the meteor to the moon. The Door tried to copy the Fool\'s abilities, but the Sefirah Castle buzzed in both their minds, creating a headache that disrupted the spell. "We are wasting time," the Door said, flickering like a broken hologram. "Agreed," the Fool nodded, fading into the fog. Neither could pin the other down without destroying the very reality they stood on.'
    },
    'Error vs Fool': {
        explanation: 'Another stalemate due to Sefirah interference. The Error steals the Fool\'s thoughts; the Fool fools the Error\'s theft. If the Fool summons a projection, the Error steals its time, making it vanish. If the Error creates a bug to win, the Fool uses a Miracle to reset the state. It is a headache-inducing logic loop where "Theft" meets "Deceit." They know each other\'s tricks too well, and the higher-level authority of the Lord of the Mysteries cancels out their decisive moves.',
        story: 'The Fool prepared a Lightning Strike. The Error adjusted his monocle and Stole the "intention" to attack. The Fool stood there, blinking, wondering why he had his hand raised. "My turn," the Error grinned, parasitizing the Fool\'s body. But inside, he found only a castle of gray fog that rejected him violently. He was forced out. The Fool, regaining his senses, turned the Error into a marionette. The Error allowed it, only to reveal that the marionette was actually an Avatar, a bug that corrupted the Fool\'s control threads. "I stole your control," the Error laughed. "I grafted the control to a rock," the Fool countered. The rock began to dance. They looked at each other, exhausted. Every move was stolen, parried, or deceived. It was a game of rock-paper-scissors where both players threw "Gun" at the same time and the universe refused to let either fire.'
    },
    'Hanged Man vs Fool': {
        explanation: 'An extreme stalemate. The Hanged Man is a master of corruption and regeneration. The Fool cannot easily kill him because he heals too fast and uses "Shadows" to mitigate damage. Conversely, the Hanged Man cannot corrupt the Fool because the Fool can discard his body (Paper Figurine) or cleanse corruption with Historical Projections of the Sun. The Fool controls the pace, but the Hanged Man is an unkillable cockroach of a tank. The battle drags on until spirituality runs dry.',
        story: 'The Hanged Man was a mass of writhing flesh and shadowed souls. The Fool hit him with an Air Cannon that blew his torso apart. Blood sprayed, turning into seeking vipers. The torso knitted itself back together in seconds. "You cannot kill what is already fallen," the Shepherd gurgled. The Fool frowned. He summoned an Angel of the Sun. Holy light bathed the Shepherd, burning his flesh, but the Shepherd simply Grazed a Wraith to phase through the floor and hide. The Fool tried to convert him into a marionette, but the Shepherd\'s soul was a chaotic mess of screaming voices that resisted control. The Shepherd counter-attacked with a Degeneration curse. The Fool swapped with a paper man. They stood in the ruins, one unable to die, the other unable to be caught. It was a war of disgust versus patience.'
    },
    'Hermit vs Fool': {
        explanation: 'The Hermit wields complex spells and the eyes of mystery, but the Fool is the embodiment of Mystery. The Hermit\'s analysis fails against the Fool\'s anti-divination fog. The Fool can interfere with the Hermit\'s connection to the Hidden Sage. While the Hermit casts long-winded rituals, the Fool snaps his fingers for a Miracle or an air bullet. The speed and unpredictability of the Fool overwhelm the scholarly approach of the Hermit.',
        story: 'The Hermit completed the geometry for a star-fall spell. "By the power of the cosmos..." Bang. An invisible air bullet shattered the Hermit\'s shield. The Fool didn\'t wait for the lecture to finish. "Analysis," the Hermit shouted, eyes glowing with data streams, trying to predict the Fool\'s next move. Result: Error. Future Indeterminate. The Fool smiled behind his fog. "You read books. I write history." He summoned a projection of the Hermit\'s own mentor from the past. The Hermit froze, emotionally compromised. In that second of hesitation, Spirit Threads wrapped around the Hermit\'s limbs. The spell fizzled out. The Hermit tried to turn into information to escape, but the Fool Grafted the concept of "Information" to "Paper." The Hermit was trapped in a folded piece of origami, silenced.'
    },
    'Justiciar vs Fool': {
        explanation: 'The Justiciar creates rules: "No Teleportation," "No Projectiles." The Fool uses Miracles, which are by definition exceptions to rules. If the Justiciar bans movement, the Fool "wishes" to be elsewhere. The Fool can also Graft the "penalty" of breaking a rule to the Justiciar himself. The rigid logic of the Justiciar cannot contain the chaotic, reality-bending nature of the Fool.',
        story: '"Prohibition: Deceit!" the Justiciar boomed. A bronze barrier descended. The Fool felt the restriction. He couldn\'t use Paper Substitutes. He smiled. "Then I shall use truth." He summoned a Historical Projection of a meteorite. This was not a trick; it was a real meteorite from the past. "Prohibition: External Objects!" the Justiciar shouted, sweating. The meteorite slowed. The Fool pointed a finger. "Grafting." He connected the space in front of his finger to the space inside the Justiciar\'s helmet. He fired a simple bullet. The bullet bypassed the distance and the armor, appearing directly inside the defense. The Justiciar fell, his laws intact but his life forfeit. You cannot legislate a miracle.'
    },
    'Moon vs Fool': {
        explanation: 'The Moon pathway relies on biology, summoning beasts, and regeneration. The Fool counters this by controlling the Spirit Threads of the summoned beasts, turning them against the master. The Fool can also summon the Sun (via history) to suppress the Moon\'s power. The Moon Beyonder is a physical juggernaut, but the Fool never engages physically, using layers of deceit and puppets to wear the beast down.',
        story: 'The Moon Beyonder howled, transforming into a mountain of muscle and fur. The Crimson Moon descended, bathing the area in red light. The Fool watched from a rooftop. "A puppet show," he mused. As the Beast charged, the Fool manipulated the threads of the creature\'s own shadow. The shadow rebelled, tripping the giant wolf. The Fool then summoned a projection of a Sun Priest. The holy light sizzled the vampire-like skin of the Moon Beyonder. The Beast roared, trying to use a mass-area silence spell. The Fool swapped with a marionette. The real Fool appeared above the Beast, dropping a historical projection of a massive ancient ruin on top of it. The Beast regenerated, but the Fool was already weaving the threads of its soul. The Beast\'s eyes went dull. It sat down, rolled over, and waited for orders.'
    },
    'Mother vs Fool': {
        explanation: 'The Mother pathway commands life and nature. They can animate plants and heal endlessly. However, the Fool can Graft the concept of "Life" to "Inanimate Object," stopping the growth. The Fool can summon fire-based projections to burn the forests. Most importantly, the Fool targets the soul (Spirit Body) directly via threads, bypassing the physical regeneration of the Mother pathway. A biological tank is useless if the pilot is mind-controlled.',
        story: 'The city became a jungle. Vines crushed skyscrapers. The Mother Beyonder stood at the center, a goddess of fertility. "Life is eternal," she declared. The Fool walked through the overgrowth. Plants lashed out, but he turned into paper and fluttered away. He reappeared and snapped his fingers. A sea of scarlet firethe flames of a Red Priesterupted from the void, summoned from history. The jungle screamed as it burned. "You destroy, I create!" The Mother healed the plants instantly. "Then I shall control," the Fool replied. He focused on the Mother Beyonder herself. While she was busy healing the forest, she failed to protect her own Spirit Body. Invisible threads latched onto her. She tried to transfer her life force to a tree to escape, but the Fool Grafted the "Tree" back to her "Body." Trapped in her own form, she became the newest addition to the Fool\'s collection.'
    },
    'Paragon vs Fool': {
        explanation: 'Paragon uses logic, technology, and physical laws. The Fool uses the illogical. A Paragon might build a perfect shield, but the Fool Grafts the attack to appear *behind* the shield. The Fool can summon projections of technology that the Paragon doesn\'t understand (from lost epochs) or simply use magic that defies physics. Machines cannot calculate the probability of a Miracle, causing the Paragon\'s predictive models to crash.',
        story: 'The Paragon stood inside a mecha made of divinely enhanced alloy. "Target locked. Probability of evasion: 0%." A laser fired. The Fool didn\'t dodge. The laser hit... a mirror. The beam reflected back, melting the mecha\'s arm. "Refractive index manipulated?" the Paragon analyzed, confused. "No," the Fool whispered. "A Miracle." The Fool summoned a projection of an ancient, rusted key. He inserted it into the air. The mecha\'s joints locked up. The Fool had Grafted the concept of a "Locked Door" to the machine\'s "Movement Systems." The Paragon frantically typed codes to override, but the logic error was metaphysical, not digital. The Fool casually walked up to the cockpit, phased through the metal with a Spirit World traversal, and tapped the pilot on the shoulder.'
    },
    'Red Priest vs Fool': {
        explanation: 'The Red Priest is a master of war and conspiracy, but the Fool is the god of preparation. The Red Priest sets a trap; the Fool has already divined it. The Red Priest uses an army; the Fool turns them into marionettes. The Fool avoids the direct confrontation that the Red Priest craves, using teleportation and history to kite the warrior. The Red Priest\'s fire is potent, but the Fool can simply Graft the heat away.',
        story: 'The battlefield was an inferno. The Red Priest laughed, swinging a sword of pure plasma. "Fight me, coward!" The Fool stood on a hill. "I am fighting," he said calmly. The Priest charged, but the ground beneath him turned into a sticky spiderweba projection of a Demoness ability. He burned it away, but the delay was enough. The Fool pulled a cannon from the fog of history. "A gun?" The Priest scoffed, raising a fire shield. The Fool fired. The bullet was Grafted to the concept of "The Priest\'s Heart." It didn\'t travel through the air; it simply existed in the gun, then existed in the heart. The Priest gasped, the flames dying out. He looked at his chest, where a flower bloomed from the wounda final mockery from a Magician.'
    },
    'Sun vs Fool': {
        explanation: 'The Sun is the natural enemy of the undead and shadows, but the Fool is neither. The Fool uses living Marionettes and historical projections. While the Sun can purge the fog, the Fool can summon the fog back endlessly. The Fool wins by outmaneuvering the Sun\'s direct, honest attacks with deceit. The Sun cannot "Purify" history or a concept. The Fool Grafts the blinding light to "Darkness," nullifying the Sun\'s greatest advantage.',
        story: 'The Sun Saint raised a staff. "Let there be Light!" A wave of purification swept the ruins. Shadows boiled away. The Fool shielded his eyes, his paper substitute burning to ash. "Bright," the Fool admitted. "But static." He summoned a projection of a Black Emperor. The order of the battlefield distorted. The holy light bent, curving around the Fool. The Sun Saint tried to lock the Fool in a Notary contract, but the Fool used "grafting" to sign the contract with the name of a random insect. "You are in violation!" the Saint shouted at the insect. The Fool took advantage of the distraction to manipulate the Saint\'s threads. The Saint felt his arms stiffen. He summoned holy fire to burn the threads, but the Fool had already swapped places with a mirror image. A dagger from the shadowssimple, physical, and grafted with "Lethal" propertiesended the sermon.'
    },
    'Twilight Giant vs Fool': {
        explanation: 'The Twilight Giant is a physical tank with high magic resistance. However, they are slow and straightforward compared to the Fool. The Fool uses "Kiting" tacticsteleporting, using marionettes, and attacking from the fog. The Giant swings a sword that can split islands, but the Fool is never where the sword lands. The Fool eventually wears the Giant down with weird abilities (spirit body attacks) that armor cannot block.',
        story: 'The Giant swung a sword the size of a building. The air pressure alone shattered windows for miles. The blade crashed down on the Fool. The Fool exploded into confetti. The Giant roared, swinging again at the reappearing figure. Another paper substitute. "Stop running!" the Giant bellowed. "Stop missing," the Fool whispered. The Fool began to juggle. He threw magical fireballs that did nothing to the Giant\'s armor. The Giant laughed, charging. He didn\'t notice the invisible threads wrapping around his ankles. The Fool pulled. The Giant tripped, the earth shaking with the impact. Before he could rise, the Fool summoned a projection of a high-sequence Arbiter to apply "Gravity x100." The Giant struggled to stand, pinned by his own weight, while the Fool leisurely prepared a ritual to harvest a new, very large marionette.'
    },
    'Tyrant vs Fool': {
        explanation: 'The Tyrant commands storms and lightningmassive AOE damage. The Fool counters this by hiding in the Sefirah Castle or the Fog of History, where weather cannot reach. If a lightning bolt approaches, the Fool Grafts it to the ground harmlessly. The Tyrant is impulsive; the Fool is calculating. The Fool baits the Tyrant into exhausting his spirituality on massive attacks that hit nothing but paper.',
        story: 'A hurricane tore through the city. Lightning struck like a relentless drumbeat. The Tyrant floated in the eye of the storm. "I will drown you!" The Fool sat on a park bench, protected by a barrier of distorted space. "A bit loud," he commented. A tsunami crashed down. The Fool opened a door in the air and walked into the Spirit World, letting the water pass beneath him. He reappeared behind the Tyrant. The Tyrant spun, electricity crackling. "Die!" The Fool held up a hand. "Grafting." He connected the lightning bolt to the Tyrant\'s own body. The bolt arced back, striking its master. The Tyrant convulsed, resistant but stunned. In that second, the Fool\'s spirit threads latched on. The storm raged on, but the storm\'s master was now a silent puppet dancing on strings.'
    },
    'Visionary vs Fool': {
        explanation: 'A clash of the highest orderAuthor vs Director. The Visionary writes the script; the Fool fools the script. It is an extreme draw. If the Visionary writes "The Fool dies," the Fool uses a Miracle to resurrect. If the Fool tries to attack, the Visionary "Imagines" a shield. They fight in a realm where reality is fluid. The Fool has the advantage of "The Mysteries" (unpredictability), while the Visionary has "Omniscience." They cancel each other out, trapping them in a story that never resolves.',
        story: 'The Visionary sat in a garden that hadn\'t existed a moment ago. "The Fool arrives and surrenders," he wrote in a golden book. The Fool walked into the garden. He knelt. Then, he exploded into a swarm of worms that ate the book. "A plot twist," the Visionary noted, unperturbed. He imagined a cage of mental dragon scales around the worms. The Fool Grafts the concept of "Inside" to "Outside." The worms were instantly free. "You cannot defeat the narrative," the Visionary stated. "I am the exception to the narrative," the Fool retorted. He summoned a projection of the Visionary himself. The two Adams stared at each other. Reality began to crack. The sky flickered between blue and red. They realized that to continue would be to shatter the mind of every living being nearby. They nodded, and the garden vanished, leaving an empty void.'
    },
    'Wheel of Fortune vs Fool': {
        explanation: 'Wheel of Fortune relies on Probability and Luck. The Fool relies on Miracles (which override probability) and Fate (which manages luck). If the Monster tries to make the Fool unlucky, the Fool "reboots" his state to before the bad luck occurred. The Fool can see the threads of fate and cut them. The Wheel spins, but the Fool holds the brake. The Fool simply has higher authority over the "possibilities" of the outcome.',
        story: 'The Monster flipped a coin. "Heads, you die. Tails, I win." The coin spun in the air. A bird flew by and knocked it down. It landed on Heads. A meteorite fell from the sky toward the Fool. The Fool snapped his fingers. "Miracle." The meteorite turned into a bouquet of flowers. "That was a 0.00001% chance!" the Monster complained. "I prefer 100%," the Fool said. He reached into the fog of history and pulled out a "Bad Ending" for the Monster. The Monster tried to Reboot the loop. The Fool interfered with the Sefirah, jamming the reset. The Monster found himself trapped in a sequence of events where every "lucky" escape led him closer to the Fool\'s marionette threads. The luck ran out, and the Fool closed the curtains on the show.'
    },
    'White Tower vs Fool': {
        explanation: 'The White Tower predicts the future and analyzes abilities. The Fool is the "Blind Spot" of fate. The White Tower cannot predict the Fool\'s actions because the Fool is shielded by the gray fog. Every calculation returns "Error." The Fool Grafts false information to the White Tower\'s analysis, leading them into traps. The White Tower relies on knowledge; the Fool relies on the unknown. You cannot calculate the variable of a Miracle.',
        story: '"I have analyzed your combat pattern," the Polymath stated. "You will swap with a paper figurine in 3 seconds." The Fool smiled. He didn\'t swap. He walked forward and punched the Polymath in the face. "Impossible," the Polymath gasped, clutching his nose. "That was statistically suboptimal!" "I am a Fool," the figure replied. "I don\'t do optimal." The Polymath cast a spell to bind the Fool, calculating the exact trajectory. The Fool Grafts the spell\'s target to the Polymath\'s own shadow. The spell missed. The Polymath tried to read the Fool\'s mind, but stared into an abyss of madness and fog that blinded him. Panicked, unable to predict a single move, the master of knowledge was taken apart by a man who refused to make sense.'
    },

    // === DOOR VS ALL ===
    'Abyss vs Door': {
        explanation: 'The Abyss relies on contact to corrupt and destroy, utilizing "filth" and mental contamination. The Door pathway is the hard counter to close-range corruption. The Door Beyonder can simply Exile the corruption into the void or utilize "Space Concealment" to ensure the Devil never finds a target. If the Devil tries to slow them down with sludge, the Door Beyonder teleports instantly. The Devil ends up fighting a phantom that refuses to be touched.',
        story: 'The Devil laughed, his skin oozing with a corruption that melted the stone floor. "Come here," he growled, the Language of Foulness polluting the air. The Door Beyonder stood at the end of the hall. He didn\'t run; he simply opened a door in the air. The corruption surged forward like a tidal wave. It passed through the door and vanished, dumped into the starry void. "Is that all?" the Traveler asked. The Devil charged, claws extending. The Traveler shattered into a swarm of translucent worms, blinking past the Devil to reappear behind him. "Exile." Space folded around the Devil. He roared as he was pulled into a pocket dimension of turbulence. He tried to break out with raw strength, but there was no wall to hit, only infinite distance. The Traveler closed the door, dusting off his hands.'
    },
    'Black Emperor vs Door': {
        explanation: 'The Black Emperor can Distort the rules of reality, but the Door pathway manipulates the space wherein those rules exist. The Door Beyonder can create a "Spatial Barrier" that isolates the Emperor\'s distortion effects. Even if the Emperor distorts the distance to close the gap, the Door Beyonder can "Record" that distortion and play it back, or simply blink to a coordinate the Emperor hasn\'t distorted yet. The Door\'s mobility makes it impossible for the Emperor to impose his authority effectively.',
        story: 'The Black Emperor slammed his scepter down. "Distance is distorted! You are within reach!" The hallway stretched and warped. The Traveler, who was miles away, suddenly found himself inches from the Emperor\'s fist. "Impressive," the Traveler noted, vanishing. He reappeared on a rooftop. "But you only distorted the path, not the destination." The Emperor tried to "Bribe" the space to lock the Traveler down. The Traveler responded by Replicating a "Psychic Piercing" from a recorded history. The Emperor flinched. The Traveler then used "Space Destruction," shattering the area around the Emperor. The Emperor tried to Distort the damage, but the space itself was gone, leaving nothing to distort. He fell into the void, his laws failing where no reality existed to rule over.'
    },
    'Chained vs Door': {
        explanation: 'The Chained pathway excels at binding and sealing enemies. However, a Door Beyonder is the ultimate escape artist. "Space Swap" allows them to escape any physical bind, and "Phasing" allows them to ignore walls. Even if the Chained uses a "Soul shriek" or possession, the Door Beyonder can blink into the Spirit World where the Chained cannot follow easily. The Chained is a jailer trying to catch a ghost that holds the skeleton key to the prison.',
        story: 'Chains of shadow erupted from the ground, wrapping the Traveler tight. "Restrain," the Prisoner commanded. The chains tightenedand fell empty. The Traveler stood five feet to the left. "A nice trick," the Traveler said. The Prisoner turned into a Wraith, shrieking a curse that petrified the soul. He lunged to possess the Traveler. The Traveler didn\'t dodge; he opened a door on his own chest. The Wraith flew right through the portal, exiting onto a glacier in the Northern Continent. The Prisoner, confused and freezing, tried to return, but the door was shut. The Traveler looked at the empty room. "I hate clingy people," he muttered, teleporting away to find a better drink.'
    },
    'Darkness vs Door': {
        explanation: 'A stalemate of elusive powers. The Darkness Beyonder uses Concealment to vanish; the Door Beyonder uses Space Concealment to vanish. They are two voids staring at each other. If the Darkness tries to "Sleep" the Door, the Door blinks away to a safe coordinate. If the Door tries to attack, the Darkness absorbs the impact or isn\'t there. Neither has a reliable way to pin the other down, resulting in a game of hide-and-seek where no one is found.',
        story: 'The lights went out. The world was pitch black. The Nightwatcher moved silently, erasing his presence. He sensed a heartbeat and struck. His blade hit empty air. "Too slow," a voice echoed. A Door opened in the darkness, releasing a recorded blast of holy light. The Nightwatcher hissed, retreating into the shadows. He used the serenity of the night to lull the Traveler to sleep. The Traveler yawned, feeling the drowsiness, and immediately teleported three cities away to wake up. He returned a second later, refreshed. "You can\'t hide forever," the Traveler said, distorting the space in the room to turn the darkness inside out. "Neither can you," the darkness whispered back. They circled each other, invisible and untouchable, ghosts haunting the same graveyard.'
    },
    'Death vs Door': {
        explanation: 'Death relies on an army of undead and spirit pressure. The Door Beyonder counters this with "Exile." They can open a massive portal and dump the entire undead army into the starry void. The "Death Knell" requires a target, but the Door Beyonder is constantly shifting coordinates. Even if the Door Beyonder is hit by a withering curse, they can "Reset" their state by recording a previous version of themselves or escaping to a safe house to heal instantly via artifacts.',
        story: 'The Death Consul raised his pale hand. "Wither." The gray wind of decay swept forward. The Traveler spun his cane, and the space in front of him twisted like a lens. The wind curved around him, hitting the wall behind. "My turn," the Traveler said. He pointed at the Consul\'s bone dragon. A massive door, ornate and starry, opened beneath the beast. Gravity reversed for the dragon alone. It fell *upward*, vanishing into the cosmos. The Consul looked calm, but his main tank was gone. He summoned wraiths. The Traveler turned into a frequency of starlight, phasing through the spirits. He reappeared behind the Consul, placing a hand on his shoulder. "Travel," he whispered. The Consul was instantly transported to the heart of a volcano. The heat didn\'t kill him, but the inconvenience was absolute.'
    },
    'Demoness vs Door': {
        explanation: 'The Demoness uses threads, plague, and black flames. The Door Beyonder refuses to engage with any of it. They can "Record" the Demoness\'s charm to use against her minions. If she releases a plague, the Door Beyonder exiles the air in the room. The Demoness\'s threads rely on physical connection or space, but the Door Beyonder cuts space itself. It is a one-sided harassment where the Door Beyonder strikes from a distance and vanishes before the Demoness can react.',
        story: 'The Demoness blew a kiss. A pink mist, laden with mind-altering toxins, drifted forward. The Traveler didn\'t hold his breath; he simply stepped sideways, crossing ten miles instantly. He watched through a spatial window. "She\'s dangerous," he noted. He opened a portal directly above her head. Through it, he dropped a boulder he had recorded earlier. The Demoness smashed the boulder with a hair-whip, but the dust obscured her vision. "Plague Storm!" she shrieked, unleashing black hurricanes. The Traveler partitioned the space around her. The storm raged inside a 10-meter box, unable to expand. The Demoness choked on her own toxicity, banging on invisible walls. The Traveler waved goodbye and closed the viewing window, leaving her in her own quarantine zone.'
    },
    'Error vs Door': {
        explanation: 'A chaotic draw due to the same Sefirah origin. The Door tries to teleport; the Error steals the destination. The Error tries to steal time; the Door exiles the theft. They understand each other\'s foundational logic too well. The Door can "Replicate" the Error\'s abilities, and the Error can "Deceit" the space. It becomes a glitchy mess where coordinates are wrong, time is wrong, and both combatants are likely to stop fighting because it\'s a waste of spirituality.',
        story: 'The Traveler tried to blink behind the enemy. He arrived in front of him. "Bug?" the Traveler asked. "Theft," the Error corrected, adjusting his monocle. "I stole your orientation." The Error tried to Parasitize the Traveler. The Traveler turned into a swarm of wormsWorms of Star. The Error turned into Worms of Time. The two swarms collided, mixing in a gross display of mythical biology. "I\'m recording this," the Traveler\'s voice echoed. "I\'ve already stolen the recording," the Error replied. Space folded in on itself. Time skipped a beat. They stood back to back, realized the futility, and walked away in opposite directions, only to bump into each other again because the geometry of the room had broken.'
    },
    'Hanged Man vs Door': {
        explanation: 'The Hanged Man is a tanky debuffer, but they are too slow. The Door Beyonder dictates the range of engagement. If the Shepherd tries to "Graze" the Traveler, the Traveler is already gone. The Traveler can kite the Shepherd infinitely, bombarding him with recorded attacks from other pathways. The Shepherd\'s corruption is dangerous, but it cannot corrupt someone who exists in a different spatial layer.',
        story: 'The Shepherd\'s shadow rose up, a massive tide of darkness and screaming souls. The Traveler yawned. "You guys always lack cardio." He teleported to the top of a clock tower. The Shepherd looked up, eyes glowing red. He cast a blood curse. The Traveler felt a twinge of pain but immediately "Recorded" the state of his body from five seconds ago and overwrote his current reality. The pain vanished. "Here, have a present," the Traveler shouted. He opened a portal. Through it came the pressure of the deep seaa recorded attack from a Tyrant. The high-pressure water jet slammed the Shepherd into the pavement. While the Shepherd regenerated, the Traveler was already in a caf across the street, watching the devastation.'
    },
    'Hermit vs Door': {
        explanation: 'The Hermit requires setup: scrolls, rituals, and fairy tales. The Door pathway is instant. Before the Hermit can finish reciting a spell, the Door Beyonder has teleported behind them and delivered a lethal blow. The Hermit\'s "Mystical Re-enactment" can be dodged by leaving the area. The Door Beyonder\'s ability to traverse the Spirit World allows them to bypass the Hermit\'s magical defenses entirely.',
        story: 'The Mystic unrolled a scroll. "Once upon a time, there was a dragon..." "The end," the Traveler interrupted. He appeared directly behind the Mystic, a spatial blade forming in his hand. The Mystic\'s passive danger intuition flared, turning him into information to disperse. "Not fast enough." The Traveler "locked" the space. The stream of data hit an invisible wall. The Mystic reformed, stumbling. "How?" "I read the end of the book," the Traveler smirked. He opened a door beneath the Mystic\'s feet that led to the upper atmosphere. The Mystic fell, his spells useless against gravity and lack of oxygen.'
    },
    'Justiciar vs Door': {
        explanation: 'The ultimate counter. The Justiciar\'s "Prohibition" ability can forbid "Teleportation" or "Movement." Once the Door Beyonder is grounded, they lose their primary advantage. The Justiciar\'s high defense and "Deprivation" abilities strip the Traveler of their recorded powers. Trapped in a cage of order, the slippery Planeswalker is crushed by the iron fist of the law.',
        story: '"Prohibition: Spatial Movement," the Justiciar declared. The voice was like a hammer striking an anvil. The Traveler tried to blink. Nothing happened. He tried to open a door. The air remained solid. Panic set in. "You are under arrest," the Justiciar stated, walking forward with heavy, metallic steps. The Traveler tried to use a recorded Fireball. "Deprivation: Offense." The fire fizzled. The Traveler was now just a person in a trench coat fighting a tank. The Justiciar swung a fist of condensed order. The Traveler tried to run, but "Prohibition: Evasion" had already been enacted. The blow connected, and the master of space was flattened by the inescapable weight of the law.'
    },
    'Moon vs Door': {
        explanation: 'The Moon Beyonder is a beast of biological violence. The Door Beyonder simply refuses to brawl. They keep the distance at "maximum." If the Beast charges, the Traveler teleports. If the Beast summons moonlight, the Traveler warps the light. The Traveler can exile the Beast to the moon itself, which, while the Beast\'s domain, removes them from the battlefield, counting as a win.',
        story: 'The Werewolf tore through the wall, claws dripping with acidic saliva. It was faster than sound. But the Traveler wasn\'t there. He was standing on the chandelier. "Down boy," he teased. The Wolf leaped, jaws snapping shut on air as the Traveler blinked to the balcony. The Traveler utilized "Space Cutting," sending invisible blades of distorted dimension at the beast. The Wolf regenerated the cuts instantly. "Annoying," the Traveler sighed. He opened a massive door in front of the charging beast. The Wolf ran through itand came out falling from the sky, 20,000 feet up. The Traveler watched the re-entry burn. "Let\'s see you regenerate from being a smear on the pavement."'
    },
    'Mother vs Door': {
        explanation: 'The Mother pathway fills the battlefield with life, vines, and toxins. The Door Beyonder treats this terrain as irrelevant. They can walk through the vines via the Spirit World. They can Exile the giant plants. While the Mother Beyonder can heal, they cannot defend against a spatial slash that severs their head and exiles it to a different continent. The mobility gap is too wide.',
        story: 'The garden grew aggressively. Vines sought to strangle the Traveler; pollen sought to paralyze him. The Traveler turned ethereal, walking through the giant stalks as if they were ghosts. "Nice garden," he commented. The Planter commanded the earth to swallow him. The Traveler blinked, appearing directly in front of the Planter. "Space Cut." A line of black void appeared on the Planter\'s neck. The Planter tried to transfer the damage to a surrogate tree, but the "head" was already gone, teleported to a deep sea trench. The body stood there for a moment, headless, before collapsing. The Traveler dusted pollen off his coat. "Needs pruning."'
    },
    'Paragon vs Door': {
        explanation: 'Paragon builds fortresses and turrets. The Door Beyonder bypasses walls. There is no fortress secure against a Planeswalker. The Traveler can teleport directly into the cockpit or control room. They can "Replicate" the Paragon\'s own technology or simply warp the space inside the machine to destroy it. The Paragon relies on physical constants; the Traveler alters them.',
        story: 'The Artisan sat inside the "God-Killer" tank. Triple-layered shields, void-energy cannons, automated targeting. "Target acquired," the AI droned. Suddenly, a knock came from the *inside* of the cockpit. The Artisan spun around. The Traveler was sitting in the co-pilot seat. "Nice chair," the Traveler said. "How?!" The Artisan reached for a weapon. The Traveler touched the control panel. "Scramble." He utilized his authority to randomize the spatial connections of the wiring. The tank went haywire, turrets firing at each other. The Traveler blinked out to a safe distance to watch the fireworks. "Hardware is good," he muttered, "but software is vulnerable to entry."'
    },
    'Red Priest vs Door': {
        explanation: 'The Red Priest commands armies and fire. The Door Beyonder redirects the fire. When a Red Priest launches a massive fireball, the Traveler opens a portal in its path and another portal behind the Priest. The Priest is hit by his own attack. The Traveler\'s mobility prevents the Priest from setting up a "trap" or "conspiracy." You cannot encircle an enemy who can move in four dimensions.',
        story: 'The War Bishop laughed, the city around him burning. "There is no escape! The fire consumes all!" A massive spear of white flame hurtled toward the Traveler. The Traveler didn\'t move. A swirling vortex opened in front of him. The spear entered the vortex. A split second later, a similar vortex opened directly behind the War Bishop. The spear emerged, striking the Bishop in the back. "Friendly fire is a tragedy," the Traveler\'s voice echoed from the rooftops. The Bishop roared, turning into a mist of iron and blood to hunt the coward. But the Traveler was already gone, leaving only a recording of mocking laughter. Every trap the Bishop set was bypassed; every attack was redirected. The God of War was fighting his own reflection.'
    },
    'Sun vs Door': {
        explanation: 'The Sun illuminates all, preventing shadows. But the Door doesn\'t hide in shadows; he hides in space. The Traveler can bend the light around him, rendering him invisible even in broad daylight. The Sun\'s "Purification" hits empty space. The Traveler can "Record" the Sun\'s own holy fire and cast it back. Ultimately, the Traveler can leave the domain of the Sun faster than the Sun can expand it.',
        story: 'The Sun Saint created a domain of absolute light. "Reveal yourself!" The Traveler stood in the center, yet the light bent around him, creating a silhouette of distorted space. "You are too bright," the Traveler complained. The Saint cast a "Holy Smite." A pillar of light descended. The Traveler opened a door *above* the pillar, redirecting the light into the ground harmlessly. He then blinked behind the Saint. "Exile." The Saint was pulled into a portal. He found himself in deep space, far from the sun. His power waned in the cold darkness. The Traveler closed the portal. "Let\'s see you photosynthesize without a star."'
    },
    'Twilight Giant vs Door': {
        explanation: 'The Twilight Giant is a melee powerhouse. The Door Beyonder is a ranged kiter. The Giant can swing a sword that cuts hurricanes, but he cannot cut a man who is currently in the Spirit World. The Traveler whittles the Giant down with spatial cuts and recorded attacks, never allowing the Giant to close the distance. It is a frustrating fight for the Giant, who is swinging at smoke.',
        story: 'The Giant swung his claymore, the wind pressure shattering windows. The Traveler teleported to the hilt of the sword, ran up the blade, and kicked the Giant in the face. Before the Giant could grab him, he vanished. "Fight me!" the Giant bellowed. "No," the Traveler replied from a hundred yards away. He snapped his fingers. A spatial rift opened on the Giant\'s armor, slicing through the metal. The Giant charged, covering the distance in a single leap. The Traveler waited until the last second, then opened a portal on the ground. The Giant fell through, appearing 500 feet in the air, falling back down. "Gravity is a harsh mistress," the Traveler noted, watching the impact.'
    },
    'Tyrant vs Door': {
        explanation: 'The Tyrant commands the storm. The Traveler leaves the storm. If the Tyrant summons a hurricane, the Traveler teleports to the eye or outside the radius. Lightning is fast, but instant transmission is faster. The Traveler can "Record" the lightning and use it. The Tyrant\'s destruction is indiscriminate, but the Traveler\'s evasion is precise. The Traveler wins by avoiding the AOE until the Tyrant runs out of spirituality.',
        story: 'The ocean churned. Lightning turned the night into day. The Tyrant hovered on a waterspout. "Drown!" A tsunami approached. The Traveler simply walked through a door and appeared on a dry cliff overlooking the bay. "Missed," he shouted. The Tyrant sent a volley of lightning bolts. The Traveler opened portals in their path, sending the electricity harmlessly into the Spirit World. He then Replicated a "Mental Charm" he had recorded from a Dragon. The Tyrant, focused on physical destruction, faltered for a second. In that second, the Traveler warped the space around the Tyrant\'s neck. A clean cut. The storm died as the master fell.'
    },
    'Visionary vs Door': {
        explanation: 'The Visionary controls the narrative. The Traveler tries to teleport away, but the Visionary writes, "The Traveler arrives in a cage." The Visionary doesn\'t need to catch the Traveler; they simply define the destination. The Traveler\'s greatest asset, mobility, becomes a liability when the map is being rewritten by the enemy. The Visionary invents a "reason" why the Traveler cannot leave, and reality obliges.',
        story: 'The Traveler sensed danger. He prepared to teleport to his safe house. "The Traveler felt a sudden urge to visit the zoo," a voice narrated from the sky. The Traveler blinked. He was not in his safe house. He was in a cage. "What?" He tried to open a door. "The door was locked, for the key had been lost centuries ago," the voice continued. The spatial portal refused to open. The Traveler panicked, turning into worms to burrow out. "The worms realized they were actually birds," the Visionary wrote. The Traveler transformed against his will, chirping. The Visionary closed the book. "And they lived happily ever after in the cage." The Traveler, mind rewritten, sat on the perch, defeated.'
    },
    'Wheel of Fortune vs Door': {
        explanation: 'A bizarre stalemate. The Traveler tries to teleport, but "bad luck" causes him to miscalculate coordinates, appearing inside a wall. The Monster tries to use "Misfortune," but the Traveler exiles the bad luck. The Traveler tries to run, but slips on a banana peel (fate). The Monster tries to hit him, but the Traveler accidentally blinks away. It is a comedy of errors where space and probability refuse to cooperate.',
        story: 'The Traveler opened a portal to strike from behind. He stepped throughand fell into a sewer. "Bad luck," the Monster giggled, rolling a die. The Traveler climbed out, smelling awful. "I\'ll exile you!" He cast the spell. A bird flew in the way. The bird was exiled. "Reboot," the Monster whispered. The Traveler found himself back in the sewer. "Stop that!" The Traveler tried to Record the Monster\'s ability. The record failed due to "corruption." The Traveler tried to leave. He teleported... and arrived two feet to the left. The Monster clapped. They stared at each other, the Traveler afraid to move for fear of tripping, the Monster afraid to attack for fear of missing. They agreed to call it a draw and walked away carefully.'
    },
    'White Tower vs Door': {
        explanation: 'The White Tower predicts; the Door moves instantly. The Polymath knows *where* the Traveler will appear, but the Traveler appears there for zero seconds before moving again. The Polymath can simulate the "Space" abilities, creating barriers, but the Traveler is the original master. It is a high-speed chess game where the pieces move on their own. The Polymath predicts the checkmate, but the Traveler removes the board.',
        story: 'The Polymath\'s eyes glowed white. "Coordinates 40, 50. Strike now." He fired a spell at the empty air. A split second later, the Traveler appeared there and was hit. "Predictable," the Polymath stated. "Painful," the Traveler grunted, regenerating. "Let\'s try random." The Traveler began blinking frantically, a strobe light of motion. The Polymath\'s brain overheated trying to track the probability of 500 jumps per minute. "Analysis overload," the Polymath muttered. The Traveler appeared behind him. The Polymath had predicted this and cast a shield. The Traveler predicted the shield and had already teleported a grenade inside it. The explosion threw them both back. They stood up, dusted themselves off, and realized neither could land a clean hit. Draw.'
    },

    // === BATCH 4: ERROR VS REMAINING ===
    'Abyss vs Error': {
        explanation: 'The Abyss relies on corruption and "Danger Intuition." The Error creates a bug in that intuition. When the Devil senses danger from the left, the attack actually comes from the right due to a stolen spatial logic. The Error can Steal the "corruption" from their own body and gift it back to the Devil. Even if the Devil enters a magma state, the Error steals the time allowed for that transformation, reverting them to a vulnerable form.',
        story: 'The Devil laughed, spreading wings of sulfur and fire. "I see your fear." "You see what I want you to see," the Error replied, adjusting his monocle. The Devil lunged, his claws dripping with lethal poison. He struck the Error\'s chest. "Stolen," the Error whispered. The wound on the Error\'s chest vanished and appeared on the Devil\'s own chest. The Devil roared in confusion. He tried to unleash a mental scream, but the Error stole the "breath" required to scream. The Devil choked, gasping for air that wasn\'t there. "A bug in your respiratory system," the Error noted. "Let me patch that for you... by removing it entirely." He stole the Devil\'s remaining time. The Devil turned to ash instantly, his immortality expiring in a single stolen second.'
    },
    'Black Emperor vs Error': {
        explanation: 'The Black Emperor distorts rules; the Error creates bugs in those distortions. If the Emperor magnifies distance, the Error steals the distance. If the Emperor imposes "Disorder," the Error steals the "Chaos" to restore order for himself. The Error acts as a hacker against a corrupted system admin. The Error steals the Emperor\'s "Authority," leaving the Emperor powerless to enforce his own distortions.',
        story: '"Disorder!" the Black Emperor commanded. The gravity in the room shifted sideways. The Error walked comfortably on the wall. "I stole the concept of \'Down\' for myself," he explained. The Emperor grew giant, swinging a fist that warped space. The Error didn\'t dodge. He stole the "impact" of the punch. The Emperor\'s fist connected, but the force was transferred to the Emperor\'s own jaw. "Stop exploiting loopholes!" the Emperor bellowed. "You are the law," the Error smiled, "but I am the glitch." He unleashed a swarm of Avatars. The Emperor tried to distort them away, but the Avatars parasitized the distortion itself. The Emperor\'s power flickered, his majestic armor rusting as the Error stole the "maintenance" of his state. The Emperor collapsed, a king dethroned by a system error.'
    },
    'Chained vs Error': {
        explanation: 'The Chained relies on binding and curbing desires. The Error steals the "restraint." The Chained tries to silence the Error, but the Error steals the "Silence" and casts it on the Chained. The Error can parasitize the Chained Beyonder, controlling them from the inside. Since the Chained has low resistance to mental intrusion compared to their physical resistance, the Error\'s avatars find a happy home in their spirit body.',
        story: 'Chains wrapped around the Error. "You are bound," the Prisoner stated. "I steal the lock," the Error replied. The chains clicked open. The Prisoner turned into a Wraith, shrieking a curse. The Error adjusted his monocle and stole the "sound." The shriek was silent. "My turn." The Error pointed a finger. The Prisoner felt a wriggling in his mind. He tried to suppress it with his iron will, but the Error stole his "Focus." The Prisoner\'s concentration shattered. "Get out of my head!" "It\'s quite spacious in here," the Error\'s voice echoed from inside the Prisoner\'s own thoughts. The Prisoner\'s hand moved against his will, punching himself in the face. Then he picked up his own knife. "A tragic suicide," the Error narrated as the Prisoner slit his own throat.'
    },
    'Darkness vs Error': {
        explanation: 'Darkness conceals; Error steals the concealment. When the Darkness Beyonder tries to hide, the Error steals the "shadow" they are using. The Error can steal the "sleep" induced by the Darkness and give it back to them. The Error\'s ability to find loopholes allows them to see through the concealment, treating the hidden enemy as visible. It is a nightmare for the Darkness, as their primary defense is simply taken away.',
        story: 'The room went pitch black. The Nightwatcher vanished. "I steal the photons," the Error said. Suddenly, he was glowing, illuminating the room. The Nightwatcher was revealed, squinting. "Slumber," the Nightwatcher chanted. The Error felt tired. He reached out and "stole" the fatigue from his own brain, holding it as a grey ball of light. He threw it at the Nightwatcher. The Nightwatcher collapsed, snoring instantly. "Wake up," the Error said, parasitizing the sleeping body. He walked the Nightwatcher off a cliff. "Actually, keep sleeping. It\'s less messy that way."'
    },
    'Death vs Error': {
        explanation: 'Death controls the dead; Error controls the control. The Error parasitizes the undead army, turning them against the Death Consul. When the Consul uses "Death Knell," the Error steals the "Targeting," causing the attack to miss or hit a bystander. The Error can even steal the "Death" state, effectively resurrecting themselves if killed, or stealing the "Life" from the Consul directly.',
        story: '"Die," the Death Consul commanded, unleashing a wave of grey decay. The Error stood firm. "I steal the definition of \'Alive\'." He became an inanimate object for a split second, immune to death, then reverted. The Consul summoned a bone dragon. The Error adjusted his monocle. "Nice pet. I\'ll take it." He stole the spirit threads connecting the Consul to the dragon. The dragon paused, eyes turning the same crystal shape as the monocle. It whipped around and breathed rot-fire on the Consul. "Traitor!" the Consul screamed. "Just a change in management," the Error laughed, sitting on the dragon\'s head as it devoured its former master.'
    },
    'Demoness vs Error': {
        explanation: 'The Demoness uses charm and plague. The Error steals the "Charm," making the Demoness repulsive. He steals the "symptoms" of the plague and grafts them onto the Demoness. Her invisible threads are stolen and used to bind her. The Error treats the Demoness\'s emotional manipulation as a variable to be edited. He is immune to the seduction because he steals the "attraction" before it registers.',
        story: 'The Demoness smiled, her beauty blinding. "Love me," she whispered. The Error looked bored. "I steal your vanity." The Demoness\'s face sagged; her hair grayed. She screamed, rushing to a mirror. "My face!" "Focus," the Error chided. She unleashed a pestilence. The Error stole the vector of transmission. The disease stayed inside her lungs, unable to spread. She began to cough blood. "You ruined everything!" she shrieked, lashing out with black flames. The Error stole the "heat." The flames turned cold and harmless. "You are just a collection of bad code," he muttered, finishing her off with a stolen Clock Hand slash.'
    },
    'Hermit vs Error': {
        explanation: 'The Hermit casts spells; the Error steals the mana. Before the Hermit can complete a ritual, the Error steals the "progress," resetting the spell to zero. The Error can parasitize the Hermit\'s eyes, feeding them false information. The Hermit\'s knowledge becomes their downfall as the Error introduces bugs into their logic, causing spells to backfire catastrophically.',
        story: 'The Mystic drew a complex geometric symbol. "Starlight, hear my..." "Yoink," the Error said. He stole the third line of the hexagon. The spell collapsed, exploding in the Mystic\'s face. "You disrupted the geometry!" the Mystic coughed. "I debugged it," the Error corrected. The Mystic tried to turn into information to flee. The Error stole the "bandwidth." The Mystic froze, halfway between flesh and data, buffering. "Loading..." the Error mocked. He walked up to the frozen Mystic and stole his "existence." The Mystic faded away like a deleted file.'
    },
    'Justiciar vs Error': {
        explanation: 'The Justiciar creates rules; the Error is the criminal who breaks them. The Error steals the "Authority" of the rule. If the Justiciar says "No movement," the Error steals the definition of "movement." He finds the loophole in every law. The Justiciar\'s order is rigid; the Error is fluid. The Error eventually steals the Justiciar\'s own ability to enforce the law, leaving the judge powerless.',
        story: '"Prohibition: Theft!" the Justiciar boomed. The Error laughed. "I steal that rule." The bronze barrier vanished. The Justiciar blinked. "That is illegal!" "I am above the law," the Error replied. The Justiciar tried to imprison him. The Error stole the "lock" from the psychic jail. He walked out. Then, he parasitized the Justiciar\'s shadow. "Why are you hitting yourself?" the Error asked as the Justiciar\'s own hand drew his pistol and aimed it at his head. "Order... must..." the Justiciar gasped. "Chaos is more fun," the Error whispered, pulling the trigger.'
    },
    'Mother vs Error': {
        explanation: 'Mother creates life; Error parasitizes it. The Error creates avatars that infest the giant plants, turning the forest against the Mother. He steals the "Growth" trigger, causing plants to wither or grow backward. He steals the "healing" from the Mother Beyonder, preventing regeneration. It is a biological nightmare where the life force is hijacked.',
        story: 'The forest came alive to crush the intruder. The Error touched a tree. "Parasitize." The tree turned gray, then crystal. It whipped its branches around, crushing the Planter\'s other minions. "You corrupt nature!" the Planter yelled, healing a wound. "I steal your health," the Error said. The wound reopened. The Planter looked pale, her vitality draining into the Error. She tried to summon a giant mandrake. The Error stole the "summoning" action. The mandrake appeared next to the Error, obeying him. "Nature has a new dad," the Error grinned.'
    },
    'Moon vs Error': {
        explanation: 'The Moon Beyonder regenerates and transforms. The Error steals the "Timing" of the regeneration, delaying it until after death. He steals the "Moonlight" energy. When the Beast attacks, the Error steals the accuracy. The Error can parasitize the Beast\'s simple mind easily, riding the werewolf like a puppet.',
        story: 'The Vampire rushed forward, claws extended. The Error stood still. At the last second, he stole the "distance." The Vampire overshot, crashing into a wall. "Clumsy," the Error noted. The Vampire healed instantly. "You cannot kill me!" "I steal your tomorrow," the Error said. The Vampire aged fifty years in a second. His fur turned white; his muscles atrophied. He collapsed, wheezing. "What... did you... do?" "I took your future time," the Error explained, pocketing a glowing clock. "You are out of minutes."'
    },
    'Paragon vs Error': {
        explanation: 'Paragon relies on machines and logic. The Error causes "System Failure." He steals the electrical signals, the code, and the blueprints. Machines turn on their creator. The Error is the ultimate computer virus. A physical turret cannot target a concept, and the Error steals the "Targeting System" logic board without touching it.',
        story: 'The Artisan piloted a mech. "Systems Green. Fire." Nothing happened. "System Error: Trigger not found," the AI reported. The Artisan frantically typed. "Reroute power!" "System Error: Power stolen." The mech shut down. The cockpit opened. The Error was sitting on the rim. "Nice hardware. Terrible security," he said. The Artisan pulled a laser pistol. The Error stole the battery. The Artisan threw the pistol. The Error stole the kinetic energy; the pistol dropped straight down. "Give up," the Error said. "I own your tech."'
    },
    'Red Priest vs Error': {
        explanation: 'The Red Priest prepares a war; the Error steals the initiative. The Error steals the "heat" from the fireballs. He steals the "loyalty" of the soldiers. The Red Priest\'s conspiracies are riddled with bugs. While the Red Priest is a master tactician, the Error changes the rules of the game mid-play, making strategy irrelevant.',
        story: 'The War Bishop launched a spear of flame. The Error adjusted his monocle. The flame vanished. "I needed a light," the Error said, lighting a cigarette with his finger. The Bishop roared, inciting a frenzy. The Error stole the "anger." The Bishop suddenly felt calm and confused. "Why are we fighting?" the Bishop asked. "Exactly," the Error said, stabbing him. The Bishop gasped, the rage returning too late. "You... cheater." "Winner," the Error corrected.'
    },
    'Sun vs Error': {
        explanation: 'The Sun purifies; the Error steals the light. The Sun Beyonder casts a buff; the Error steals it for himself. The Sun tries to Notarize a contract; the Error steals the pen. The Error can exploit the "dogmatic" nature of the Sun to find logical loopholes in their holy laws. He steals the "Day," turning the battlefield dark.',
        story: '"Holy Light!" the Priest shouted. The beam descended, but curved into the Error\'s hand. "Thanks for the power-up." The Error glowed with stolen holiness. The Priest tried to Purify him. The Error stole the "Target." The Purification hit the Priest instead. "I burn!" the Priest screamed. "Irony," the Error chuckled. He summoned an avatar in the shape of an angel. The Priest hesitated. The Error stole that hesitation to land a fatal blow. "Never trust your eyes," he whispered to the dying saint.'
    },
    'Twilight Giant vs Error': {
        explanation: 'The Giant is a tank. The Error ignores armor by stealing the "Durability." The Giant swings a sword; the Error steals the "Strength" behind the swing. The Giant is too slow to catch the slippery thief. The Error eventually parasitizes the Giant, piloting the massive body to destroy its own allies.',
        story: 'The Giant swung a hammer. It hit the Error, but there was no impact. "I stole the kinetic energy," the Error explained, tapping the hammer. The Giant tried to crush him. The Error stole the Giant\'s "Balance." The behemoth toppled over. While the Giant struggled to rise, the Error walked onto his chest. "Parasitizing such a large body takes time," he admitted. "But I have yours." He stole the Giant\'s time. The Giant moved in slow motion. The Error calmly walked into the Giant\'s ear. Minutes later, the Giant stood up, eyes wearing a monocle. "I like being tall," the Error rumbled.'
    },
    'Tyrant vs Error': {
        explanation: 'The Tyrant summons storms. The Error steals the "Trigger." Lightning builds up but never strikes. The Error steals the "Water" from the tsunami, leaving dry land. The Tyrant\'s rage is stolen, leaving him apathetic. The Error creates a bug where the Tyrant is conductive to his own electricity.',
        story: 'Thunder boomed. "I am the Lord of Storms!" "I am the Lord of Glitches," the Error shouted back. A lightning bolt fell. The Error stole the "Charge." The bolt fizzled into static. The Tyrant summoned a hurricane. The Error stole the "Wind Direction." The hurricane reversed, sucking the Tyrant in. "Impossible!" The Error appeared next to him in the eye of the storm. "I\'ll take that trident." He stole the weapon from the Tyrant\'s hand. "And your liver." He stole that too. The Tyrant fell, dissected by a thief who took pieces of him faster than he could regenerate.'
    },
    'Visionary vs Error': {
        explanation: 'The Error LOSES this matchup. The Visionary controls the mind and the narrative. If the Error tries to steal, the Visionary writes "The Error decides not to steal." The Visionary knows the Error is coming (Psychology). Mental plagues infect the Error\'s avatars instantly. You cannot create a bug in a story if the author simply writes you out of the plot.',
        story: 'The Error reached out to steal the Visionary\'s thought. Suddenly, the Error forgot why he was there. "You are tired," the Visionary said gently. "I am... tired," the Error agreed, eyes drooping. "You want to give me your characteristics," the Visionary suggested. The Error\'s hand moved to his own chest. "Yes... a gift." He ripped out his own Beyonder characteristic. The Visionary took it. "Thank you." The Error collapsed, having played a role in a script he didn\'t know he was reading.'
    },
    'Wheel of Fortune vs Error': {
        explanation: 'The Wheel controls luck; the Error steals the luck. If the Monster gets a "Lucky Hit," the Error steals the result. If the Monster tries to Reboot, the Error steals the "Reset Point." The Error creates a loop of bad luck that the Monster cannot escape because the variable of "Chance" has been stolen and replaced with "Certainty of Death."',
        story: 'The Monster rolled a die. "Six!" The Error flicked his wrist. "I stole the dots. It\'s a one." The Monster tripped. "Reboot!" the Monster cried. The world dissolved... and reformed exactly as it was. "I stole the past," the Error grinned. "You can\'t go back there." The Monster panicked, throwing random debris. The Error stole the "Trajectories." The debris floated in mid-air. "Game over," the Error said, stealing the Monster\'s probability of survival. The Monster\'s heart stopped for no medical reason.'
    },
    'White Tower vs Error': {
        explanation: 'The White Tower analyzes; the Error provides false data. The Polymath calculates a 100% success rate, but the Error steals the "1" from the "100." The Error creates a logic paradox that stuns the Polymath. While the Polymath is simulating, the Error steals the time they used to think, killing them in the past.',
        story: '"I have predicted your theft," the Polymath said. "I have placed a trap." The Error smiled. "I stole the trap." He held up the magical mine. The Polymath blanched. "Recalculating..." "System Error," the Error interrupted. He stole the Polymath\'s ability to do math. "Two plus two is... fish?" the Polymath stammered, confused. The Error patted him on the cheek. "Ignorance is bliss." He parasitized the confused scholar, turning the library of knowledge into a den of thieves.'
    },

    // === BATCH 5: VISIONARY VS REMAINING ===
    'Abyss vs Visionary': {
        explanation: 'A clash of minds. The Abyss uses corruption and madness. The Visionary is the master of the mind. The Visionary can "Soothe" the madness or "Imagine" that the corruption is actually candy. However, the Abyss is chaotic and hard to script completely. It ends in a draw or a difficult win where the Visionary isolates the Devil\'s mind from his body, trapping him in a peaceful dream while his body rots.',
        story: 'The Devil screamed a language that melted ears. The Visionary listened like a therapist. "You are angry," the Visionary noted. The Devil paused. The rage felt... distant. "The magma is actually cool water," the Visionary whispered. The Devil looked at his burning skin. It felt cold. He shivered. "What trickery..." "Sleep," the Visionary commanded. The Devil fought the urge, his chaotic nature rebelling. He lashed out, clawing the Visionary\'s face, but it was a phantom. The real Visionary stood behind him. "A stubborn patient." The Visionary manifested a mental dragon. The dragon ate the Devil\'s mind. The body remained, thrashing, a husk without a driver.'
    },
    'Black Emperor vs Visionary': {
        explanation: 'The Black Emperor distorts reality; the Visionary imagines a new one. The Visionary wins because narrative beats distortion. If the Emperor distorts the law, the Visionary writes a new law into the collective unconscious that supersedes it. The Visionary can simply "Imagine" that the Emperor\'s distortion failed, and reality obeys the script.',
        story: '"I distort the distance!" The Emperor swung. "But you missed," the Visionary said. The Emperor looked. He had missed. "Impossible." "You are feeling weak," the Visionary suggested. The Emperor\'s knees buckled. "Get out of my head!" "I am not in your head. I am in the world," the Visionary replied. "And in this world, Emperors always fall." The Visionary summoned a guillotine from the French Revolution of history. The Emperor tried to distort it, but the "Narrative of Execution" was too strong. The blade fell.'
    },
    'Chained vs Visionary': {
        explanation: 'The Chained restrains the body; the Visionary frees the mind. The Chained cannot possess a Visionary because the Visionary\'s mind is a fortress of dragons and oceans. The Visionary can "Cue" the Chained to unlock themselves or to attack their own allies. The Chained has low mental defense against a demigod of the mind.',
        story: 'The Prisoner turned into a Wraith. He dove into the Visionary\'s mind. Inside, he found himself in a cathedral of blinding light. A giant golden dragon stared at him. "You are trespassing," the Dragon/Visionary boomed. The Wraith shrieked, burning. He fled back to his body. "Sit," the Visionary commanded in the physical world. The Prisoner sat. He tried to stand, but his mind refused to send the signal. "Good dog," the Visionary said, imagining a leash around the Prisoner\'s neck. The leash became real. The Prisoner choked, bound by his own psychology.'
    },
    'Darkness vs Visionary': {
        explanation: 'Darkness hides things; Visionary knows they are there. The Visionary can access the "Collective Unconscious" to find the Darkness Beyonder\'s locationbecause the Darkness Beyonder still *thinks*. The Visionary imagines a sun that penetrates concealment. He can script a series of coincidences that force the Darkness Beyonder into the light.',
        story: 'The Nightwatcher concealed himself. Perfect stealth. "The assassin stepped on a twig," the Visionary narrated. CRACK. The Nightwatcher looked down. There was no twig, but the sound was real. His position was compromised. "The assassin felt a sudden panic," the Visionary continued. The Nightwatcher\'s heart raced. He couldn\'t breathe. "He realized he was on fire." The Nightwatcher screamed, rolling on the ground to put out flames that didn\'t exist. The Visionary walked over and tapped him on the head. "Game over."'
    },
    'Death vs Visionary': {
        explanation: 'Death controls bodies; Visionary controls souls/minds. The Visionary can "Soothe" the spirits the Death Consul controls, making them pass on. He can "Imagine" the undead are alive, causing them to collapse. The Death Consul himself has a mind that can be rewritten. The Visionary turns the army of the dead into a pacifist choir.',
        story: 'The Death Consul raised an army. "Kill him." The Visionary looked at the skeletons. "You are tired of war. You want to rest." The skeletons dropped their swords and lay down. "What? No!" The Consul shouted. "And you," the Visionary turned to the Consul. "You have forgotten how to use necromancy." The Consul tried to cast a spell. His mind was blank. He couldn\'t remember the words. "A tragic case of amnesia," the Visionary wrote in his notebook. The Consul stood there, harmless, while the Visionary walked past.'
    },
    'Demoness vs Visionary': {
        explanation: 'The Demoness relies on desire and charm. The Visionary controls desire. He can turn the Demoness\'s charm off, or make her repulsive. He sees the "Instigation" coming and edits the outcome. The Demoness tries to manipulate his emotions, but he is the master of psychology. He makes her fall in love with a rock, removing her from the fight.',
        story: 'The Demoness unleashed her pheromones. "You want me." "I imagine you are a rotting corpse," the Visionary countered. To his eyes, and the eyes of everyone else, she turned into a zombie. Her charm inverted. "No!" She clawed at her face. "You feel immense guilt for your sins," the Visionary implanted. The Demoness fell to her knees, weeping uncontrollably. Her black flames died out as her will to fight vanished. "I\'m sorry, I\'m sorry," she sobbed. "Repentance is good," the Visionary nodded, leaving her incapacitated by her own conscience.'
    },
    'Hermit vs Visionary': {
        explanation: 'The Hermit seeks knowledge; the Visionary feeds false knowledge. The Visionary floods the Hermit\'s mind with "prophecies" that lead to defeat. He interrupts rituals by making the Hermit forget the next step. The Hermit\'s reliance on the Hidden Sage makes them vulnerable to mental intrusion, as the Visionary can mimic the Sage\'s whispers.',
        story: '"The stars align..." the Mystic began. "The stars are falling," the Visionary whispered directly into his brain. The Mystic looked up. He saw the sky collapsing. It was an illusion, but his body reacted with shock. "The ritual requires blood," the Visionary lied through telepathy. The Mystic slashed his own arm. "Wait, that\'s not right..." "It is right," the Visionary insisted. "Cut deeper." The Mystic, confused and battling his own mind, collapsed from blood loss. "Knowledge is dangerous," the Visionary noted.'
    },
    'Justiciar vs Visionary': {
        explanation: 'A clash of Law vs Mind. Extreme Draw. The Justiciar forbids mental intrusion ("Prohibition: Mind Control"). The Visionary cannot easily rewrite the Justiciar. However, the Visionary can write laws into the fabric of reality that conflict with the Justiciar\'s laws, causing a logic breakdown. They stare at each other, one imposing Order, the other imposing Narrative, neither able to fully override the other.',
        story: '"Prohibition: Imagination!" the Justiciar commanded. The Visionary felt his power dampen. "A strong will." "Surrender," the Justiciar ordered. "The Judge realized he was impartial," the Visionary countered, trying to nudge the Justiciar\'s subconscious. "Prohibition: Influence!" The Justiciar blocked it. The Visionary summoned a physical dragon (realized imagination). The Justiciar Deprived the dragon of flight. It crashed. They stood at an impasse. The Justiciar couldn\'t arrest a man who could convince the handcuffs they were open. The Visionary couldn\'t brainwash a man who was made of rules.'
    },
    'Mother vs Visionary': {
        explanation: 'Mother has no mental defense. The Visionary simply walks into the forest and controls the mind of the Planter. The Planter\'s beasts turn on her. The plants part way for the Visionary. Life is strong, but the mind directing it is weak against a Spectator.',
        story: 'The Planter summoned a jungle. "The jungle is friendly," the Visionary said. The vines caressed the Visionary instead of strangling him. "Attack him!" the Planter shrieked. "You are the enemy," the Visionary pointed at the Planter. The beasts looked at their mistress. They growled. "Wait, no!" The Visionary watched calmly as the Planter was chased off by her own creations. "Nature is fickle."'
    },
    'Moon vs Visionary': {
        explanation: 'The Beast has instincts; the Visionary exploits them. He triggers the "Fear" instinct. The Moon Beyonder, no matter how strong, runs away with tail between legs. Or the Visionary triggers "Hibernation." The Beast falls asleep. It is Man vs Wild, and Man has a tranquilizer gun made of psychology.',
        story: 'The Werewolf roared, bloodlust high. "You are a puppy," the Visionary projected. The Werewolf paused. He felt... small. "Sit." The Werewolf sat. "Roll over." The Werewolf rolled over, exposing his belly. The Visionary scratched his chin. "Good boy." The Moon Beyonder screamed internally, trapped in a compliant body, unable to break the psychological conditioning.'
    },
    'Paragon vs Visionary': {
        explanation: 'Machines have logic; Visionary rewrites logic. The Visionary can "Imagine" the machine is broken, and it breaks. More importantly, he attacks the pilot. The Artisan has no special mental defense. The Visionary convinces the Artisan to push the self-destruct button.',
        story: 'The Artisan targeted the Visionary. "You forgot to load the ammo," the Visionary suggested. The Artisan checked. "I... did?" He opened the chamber. It was full. "No, it\'s empty," the Visionary insisted. The Artisan saw an empty chamber. "Hallucination?" "The machine is overheating," the Visionary added. The Artisan felt heat. The warnings were silent, but he smelled smoke. Panic set in. He ejected from a perfectly functional mech. The Visionary smiled and walked away.'
    },
    'Red Priest vs Visionary': {
        explanation: 'War relies on morale and loyalty. The Visionary breaks both. He turns the Red Priest\'s army against him. He makes the Red Priest doubt his own strategy. The Red Priest tries to Incite, but the Visionary Soothes. The Visionary rewrites the "cause" of the war, making the Red Priest feel he is fighting for the wrong side.',
        story: '"Charge!" the War Bishop yelled. His soldiers stood still. "Why aren\'t you moving?" "They realized violence is wrong," the Visionary said from the sidelines. The Bishop turned to attack personally. "You are fighting your brother," the Visionary implanted. The Bishop looked at the Visionary. He saw the face of his long-lost brother. His sword lowered. "Brother?" "Yes. Hug me." The Bishop walked into a trap, tears in his eyes, defeated by sentimentality.'
    },
    'Sun vs Visionary': {
        explanation: 'Same Sefirah (God Almighty). Draw. The Sun purifies; the Visionary imagines. The Sun\'s light clears hallucinations, but the Visionary can imagine real things. They know each other\'s abilities. The Sun creates a domain of righteousness; the Visionary fits right in as a "prophet." They nod at each other and go separate ways.',
        story: 'The Sun Saint shone brightly. The Visionary wore sunglasses he imagined. "Repent," the Saint said. "I have written a bible," the Visionary replied, holding up a blank book that the Saint perceived as scripture. The Saint hesitated. "Is it canonical?" "You believe it is." The Saint read it. He got confused. The Visionary used the confusion to slip away. The Saint realized the trick and burned the book, but the Author was gone.'
    },
    'Tyrant vs Visionary': {
        explanation: 'Same Sefirah. Draw. The Tyrant is loud; the Visionary is quiet. The Tyrant\'s lightning is too fast to narrate away easily, but the Visionary can predict where it will strike. The Visionary soothes the Tyrant\'s rage, reducing his combat effectiveness. The Tyrant keeps the Visionary at bay with wind walls.',
        story: 'Wind howled. The Tyrant prepared to strike. "You are calm," the Visionary said. The Tyrant felt his anger ebb. The storm lessened intensity. "Why am I doing this?" the Tyrant muttered. "You want to go sailing," the Visionary suggested. The Tyrant looked at the ocean. It did look inviting. He shook his head, regaining focus. "No! Lightning!" He fired a bolt. The Visionary had already stepped aside, having read the Tyrant\'s intention. They danced like this for hours, one shouting, one whispering.'
    },
    'Wheel of Fortune vs Visionary': {
        explanation: 'The Visionary writes the script; the Wheel spins for a random outcome. The Script wins. The Visionary writes, "The coin lands on heads." The probability collapses to 100%. The Visionary ignores luck by enforcing a narrative inevitability. The Monster tries to reboot, but the Visionary imagines the "Reset" button is broken.',
        story: '"I like odds," the Monster said. "I prefer certainty," the Visionary replied. "A meteor falls!" the Monster used a calamity. "The meteor misses," the Visionary said. The meteor curved and missed. "That\'s cheating!" "It\'s a story," the Visionary explained. "And you are the comic relief." The Monster slipped on a banana peel that the Visionary imagined. He fell off the cliff. "Reboot!" he screamed. "The end," the Visionary said, closing the book. The reboot failed. The Monster fell.'
    },
    'White Tower vs Visionary': {
        explanation: 'Same Sefirah. Variable Draw. The White Tower analyzes the plot; the Visionary writes it. The White Tower sees the manipulation coming. "You are trying to cue me." "Yes." They play 4D chess. The White Tower simulates the story; the Visionary edits the simulation. It is a battle of pure intellect with no bloodshed.',
        story: '"You will attack my left," the Polymath said. "I changed my mind," the Visionary smiled. "Right." "Predicted that too." The Polymath blocked right. "But I imagined you blocked left." The Polymath\'s arm moved left against his will. "Psychological cue implemented 5 minutes ago," the Visionary explained. "Counter-cue implemented 6 minutes ago," the Polymath retorted. The Visionary felt a sudden urge to sneeze. He sneezed. The Polymath took a step back. "Bless you." "Thank you." They stared at each other. "Stalemate?" "Stalemate."'
    },
    'Twilight Giant vs Visionary': {
        explanation: 'The Giant is physically invincible but mentally simple. The Visionary destroys him. He makes the Giant hallucinate that his enemies are his friends. He drives the Giant mad. He imagines a pit beneath the Giant. The Giant swings at phantoms while the Visionary sips tea.',
        story: 'The Giant charged. "I am a wall," the Visionary said. The Giant stopped. He saw a massive adamantine wall. He began to punch the empty air, thinking he was breaking the wall. "Now I am a flea," the Visionary said. The Giant began trying to squash a bug on the ground. "Now I am your mother." The Giant began to weep, hugging a tree. The Visionary shook his head. "Too easy."'
    },

    // === BATCH 6: WHITE TOWER VS REMAINING ===
    'Abyss vs White Tower': {
        explanation: 'The White Tower relies on logic; the Abyss is madness. LOSS for White Tower. The Polymath tries to analyze the Devil, but the "corruption" infects the analysis. Staring at the Abyss drives the scholar mad. The Devil\'s chaotic nature defies prediction. The Polymath calculates a dodge, but the Devil attacks in a way that defies physics.',
        story: '"Analysis: Demon," the Polymath stated. Eyes glowing. Sudden pain. The Polymath clutched his head. "Data... corrupted." The Devil laughed. "You try to read a book written in vomit." The Polymath fired a spell. The Devil absorbed it with filth. "Probability of survival: 0%," the Polymath whispered, horrified. The Devil lunged. The Polymath tried to predict the trajectory, but the Devil split into three deformities. The logic broke. The Polymath was torn apart while trying to solve an equation that had no answer.'
    },
    'Black Emperor vs White Tower': {
        explanation: 'White Tower analyzes rules; Black Emperor distorts them. LOSS for White Tower. You cannot calculate variables that change randomly. The Polymath predicts gravity is 9.8m/s; the Emperor changes it to -5. The Polymath relies on "Knowledge," but the Emperor enforces "Disorder." The calculations always return error.',
        story: '"If I fire at 45 degrees..." the Polymath calculated. "Distortion!" the Emperor shouted. The spell flew backward. "Recalculating..." "Distortion!" The Polymath\'s brain processed the data backward. He forgot the spell. "This is illogical!" the Polymath cried. "This is politics!" the Emperor replied, dropping a gavel the size of a building. The Polymath knew exactly how heavy it was, and exactly how dead he would be.'
    },
    'Chained vs White Tower': {
        explanation: 'The Polymath analyzes the restraints. He finds the weak point in the chain. He predicts the Wraith\'s possession attempt and sets a psychic trap. The Chained is simple and restricted; the Polymath exploits those restrictions. He kites the Chained, using spells that counter the specific "Curse" being used.',
        story: 'The Prisoner tried to bind him. "Tensile strength of shadow chains: 500 PSI. Breaking point: The link," the Polymath murmured. He fired a precise needle of light. The chains snapped. The Prisoner shrieked. "Sonic frequency: 20kHz. Counter-frequency generated." The Polymath cast a silence bubble. The Prisoner stood helpless. "You are a puzzle," the Polymath said, "and I have solved you." He cast a binding spell of his own, mathematically perfect and inescapable.'
    },
    'Darkness vs White Tower': {
        explanation: 'Darkness hides; White Tower deduces. The Polymath notices the displacement of air, the lack of sound. "Pattern Recognition" reveals the Nightwatcher. The Polymath casts "Light" spells which are the weakness of Darkness. He predicts where the assassin *must* be based on strategic necessity.',
        story: 'The room was dark. "The enemy is at coordinates X, Y," the Polymath stated, firing a lightning bolt into the corner. A scream. The Nightwatcher appeared, smoking. "How?" "You displaced the dust," the Polymath explained. The Nightwatcher tried to use Slumber. "Detected neuro-chemical alteration. Adrenaline stimulated." The Polymath stayed awake. "You can\'t hide from math," the Polymath said, finishing him with a barrage of magic missiles.'
    },
    'Death vs White Tower': {
        explanation: 'The Polymath analyzes the undead. "Skeleton: weak to bludgeoning. Wraith: weak to fire." He optimizes his spells for maximum efficiency. He predicts the Death Knell based on the accumulation of spirit energy and silences the Consul before he can speak. Knowledge of the dead is a specialty.',
        story: 'The Death Consul summoned a horde. "Inefficient," the Polymath judged. He cast a single "Mass Dispel" tuned to the specific frequency of the necromancy. The horde crumbled. The Consul charged. "Your fighting style is ancient Azik style. Flaw: Left side exposed." The Polymath dodged the scythe by a millimeter and struck the Consul\'s left side with a Holy Light spear. "I have read your biography," the Polymath noted. "You die here."'
    },
    'Demoness vs White Tower': {
        explanation: 'The Demoness uses charm. The Polymath uses logic. "Hormonal spike detected. Disregarding." He ignores the seduction. He analyzes the plague and synthesizes a cure instantly. He predicts the invisible threads based on the tension in the air. The Demoness\'s tricks are dismantled by cold, hard facts.',
        story: '"Don\'t you find me pretty?" the Demoness asked. "Facial symmetry is 98%. Objectively aesthetic. Subjectively irrelevant," the Polymath droned. He cast a gust of wind to reveal the invisible threads. "Plague!" she screamed. "Filter created." A bubble formed around him. The Demoness grew frustrated. She turned into a black mist. "State change. Freezing spell prepared." The Polymath froze the mist. The Demoness fell as a block of black ice. "Emotion is a variable I do not compute."'
    },
    'Hermit vs White Tower': {
        explanation: 'Wizard vs Wizard. Draw. Both seek knowledge. The White Tower analyzes the Hermit\'s spell; the Hermit analyzes the White Tower\'s analysis. They counter-spell each other perfectly. The Hermit uses "Mystery"; the White Tower uses "Logic." They stand at a distance throwing colors at each other, blocking everything, until they run out of mana.',
        story: 'The Mystic cast a starlight beam. The Polymath held up a mirror shield. "Reflected." The Mystic anticipated this and curved the beam. The Polymath anticipated the curve and stepped left. "You read the scroll of Roselle?" the Mystic asked, pausing. "Volume 4. You?" "Volume 5." "Interesting." They stopped fighting to discuss literature. It was a draw based on mutual professional respect.'
    },
    'Justiciar vs White Tower': {
        explanation: 'Justiciar makes laws; White Tower finds loopholes. "Prohibition: Fire." The Polymath uses Ice. "Prohibition: Magic." The Polymath uses physical artifacts. The Polymath analyzes the "Jurisdiction" of the Justiciar and steps one inch outside it. He wins by outsmarting the rigid logic of the Judge.',
        story: '"You are forbidden from attacking!" the Justiciar yelled. "I am not attacking," the Polymath said. "I am accelerating this rock. Gravity is attacking." The rock hit the Justiciar. "Prohibition: Movement!" "I am not moving. The earth is rotating." The Polymath cast a spell that anchored him to the rotation, flinging him out of range. "Your rules have syntactic ambiguity," the Polymath critiqued. He exploited a loophole in the "Defense" law to bypass the armor. The Justiciar fell, defeated by a lawyer.'
    },
    'Mother vs White Tower': {
        explanation: 'Mother grows; White Tower predicts growth. "Vine growth rate: 5 meters/second." He burns the roots before they sprout. He analyzes the biological makeup of the beasts and creates a toxin. He optimizes his damage to outpace the regeneration. It is Man vs Nature, and Science wins.',
        story: 'The Planter summoned a forest. "Defoliant formula prepared," the Polymath said. A green mist killed the plants. The Planter healed herself. "Regeneration consumes calories. You are running a deficit," the Polymath noted. He kited her, dealing damage faster than she could heal. He predicted where the next root would emerge and stood elsewhere. Eventually, the Planter collapsed from exhaustion. "Biology is just complex chemistry," the Polymath shrugged.'
    },
    'Moon vs White Tower': {
        explanation: 'The Beast is predictable. "Attack pattern: Lunge, Swipe, Bite." The Polymath dances around the werewolf. He calculates the phase of the moon and creates a "Darkness" spell to cut off the power source. He uses silver/fire spells which are statistically super-effective.',
        story: 'The Werewolf charged. The Polymath took one step back. The claws missed by an inch. "Three... two... one..." The Werewolf howled. "Sonic dampener." The howl was silent. The Polymath cast a spell that simulated the sun. The Vampire skin burned. "Instincts are linear. I am exponential," the Polymath said, trapping the beast in a cage of lasers.'
    },
    'Paragon vs White Tower': {
        explanation: 'Paragon builds machines; White Tower reverse-engineers them. The Polymath looks at the mech and sees the structural weak point. "Ventilation port is unshielded." He fires a magic missile down the tube. He hacks the Paragon\'s systems using logic codes. The Paragon cannot surprise the Polymath.',
        story: 'The Artisan unveiled a death ray. "Wavelength 400nm. Mirror shield deployed," the Polymath yawned. The ray reflected. "I have upgraded the armor," the Artisan boasted. "You used alloy X-7. Brittle at low temperatures." The Polymath cast "Cone of Cold." The armor shattered. The Artisan tried to calculate a trajectory. The Polymath calculated it faster. "I wrote the textbook you are using," the Polymath informed him.'
    },
    'Red Priest vs White Tower': {
        explanation: 'Red Priest has strategy; White Tower has simulation. The Polymath predicts the war. "Your trap is at coordinates A5." He avoids it. He analyzes the weather conditions the Red Priest uses and alters them. The Red Priest\'s fire is just energy to be dispersed. The Polymath wins by being ten steps ahead.',
        story: '"Ambush!" the War Bishop shouted. "Counter-ambush," the Polymath replied. The Bishop\'s soldiers fell into a pit the Polymath had dug 10 minutes ago. "I will burn you!" "Combustion requires oxygen." The Polymath removed the air around the Bishop. The fire died. The Bishop gasped. "Checkmate in 3 moves," the Polymath stated. The Bishop surrendered.'
    },
    'Sun vs White Tower': {
        explanation: 'Same Sefirah. Draw. The Sun is bright; the White Tower is knowing. The Polymath knows the prayers. He knows the Notary process. He counters the light with prisms. They stalemate because neither has a conceptual advantage over the other.',
        story: '"I purge you!" "I reflect you." "I bind you!" "I unbind myself using Article 4, Section B of the Holy Code." The Sun Saint paused. "You know the code?" "I memorized it." "Well... carry on then." They threw light and logic at each other until they got bored.'
    },
    'Tyrant vs White Tower': {
        explanation: 'Same Sefirah. Draw. The Tyrant is chaotic; the Polymath tries to find the pattern in the chaos. He can predict lightning to an extent ("Charge building in cloud A"). He erects lightning rods. But the sheer volume of destruction is hard to calculate perfectly. The Polymath survives, but cannot easily kill the Tyrant.',
        story: 'Lightning rained down. The Polymath moved in a jagged pattern, dodging every bolt. "Stand still!" the Tyrant roared. "Statistically unwise," the Polymath shouted over the thunder. The Tyrant sent a tsunami. The Polymath froze a path through the wave. "You are annoying!" "You are loud." The Tyrant couldn\'t hit the calculator; the calculator couldn\'t sink the boat.'
    },
    'Wheel of Fortune vs White Tower': {
        explanation: 'Logic vs Luck. Luck wins. LOSS for White Tower. The Polymath calculates a 100% hit chance. The Monster trips and dodges it. The Polymath\'s spell backfires due to a "freak accident." You cannot calculate a variable that is defined as "Random." The Polymath goes insane trying to find the pattern in the noise.',
        story: '"Trajectory locked," the Polymath said. A bird flew into his face. He missed. "Probability?" he asked, confused. He cast a shield. A meteorite fell on him. "Shield capacity exceeded." The Monster threw a pebble. It bounced off three walls and hit the Polymath in the eye. "This makes no sense!" the Polymath screamed. "It\'s luck!" the Monster laughed. The Polymath\'s head exploded from the logical paradox.'
    },
    'Twilight Giant vs White Tower': {
        explanation: 'Brains beats Brawn. The Polymath analyzes the Giant\'s swing. "Slow." He dodges. He analyzes the armor. "Joints are vulnerable." He attacks the joints. The Giant is a raid boss that the Polymath has read the guide for.',
        story: 'The Giant swung. The Polymath stepped aside. "You are strong. But you telegraph your moves," the Polymath critiqued. He cast "Grease" on the floor. The Giant slipped. "Center of gravity disrupted." While the Giant struggled, the Polymath cast "Rust" on his armor. The Giant was left naked and prone. "Physics is a cruel mistress."'
    },

    // === BATCH 7: SUN VS REMAINING ===
    'Abyss vs Sun': {
        explanation: 'The ultimate hard counter. Abyss is corruption; Sun is purification. The Sun Beyonder\'s very presence burns the Devil. The "Unshadowed" domain clears the filth and madness instantly. The Devil\'s "Danger Intuition" just screams constantly because the light is everywhere. The Sun Beyonder doesn\'t even need complex spells; raw holy light incinerates the Abyss on contact.',
        story: 'The Devil stepped out of the shadows, dripping with magma. "I will swallow your soul." The Priest raised a hand. "Let there be light." A blinding supernova erupted. The Devil shrieked, his skin blistering and peeling. The "filth" he tried to spread evaporated into white steam. "My eyes!" the Devil clawed at his face. "You are unclean," the Priest stated, walking forward. The ground beneath him turned to glass. He placed a hand on the Devil\'s head. "Purify." The Devil didn\'t even have time to curse before he dissolved into ash, cleansed of his existence.'
    },
    'Black Emperor vs Sun': {
        explanation: 'Black Emperor represents Distortion and Shadows; Sun represents Order and Light. Sun WINS. The Sun\'s light prevents the shadows required for some Emperor arts. The "Notary" ability reinforces the laws of reality, making it harder for the Emperor to distort them. Holy Light burns through the chaotic energy of the Emperor.',
        story: '"I distort the light!" the Emperor commanded. The light bent, but then straightened itself. "Truth cannot be distorted," the Priest chanted, enforcing the concept of "Straight Lines." The Emperor grew to giant size, casting a massive shadow. "Sunlight Strike." A spear of pure radiance pierced the shadow. The Emperor roared, shrinking back down. "You enforce boring rules," the Emperor spat. "I enforce reality," the Priest replied, summoning a cross of fire that pinned the Emperor to the burning ground.'
    },
    'Chained vs Sun': {
        explanation: 'The Chained rely on shadows, curses, and wraith forms. The Sun obliterates all three. A Wraith cannot exist in a domain of Holy Light. The "Curse" is purified instantly. The Sun Beyonder breaks the chains with "Unshadowed" glory. The Chained has nowhere to hide and is burned away by the passive aura of the Sun.',
        story: 'The Prisoner dissolved into a Wraith to possess the Priest. He flew into the Priest\'s auraand immediately caught fire. "Aaaah!" The Wraith scrambled back, smoking. "A spirit?" The Priest looked disgusted. "Begone." He released a pulse of light. The chains binding the Prisoner melted. The Prisoner, forced back into physical form, tried to hide in a corner. "There are no corners here," the Priest said. The walls glowed. The Prisoner curled up, shielding his eyes, as the light scrubbed him from the world.'
    },
    'Darkness vs Sun': {
        explanation: 'Light vs Dark. Sun WINS. While Darkness can try to conceal the sun, the Sun Beyonder *generates* light. You cannot hide from a star. The Sun\'s "Bard" abilities buff his resistance to sleep. The "Unshadowed" domain actively destroys the Darkness Beyonder\'s concealment fields, leaving them exposed and vulnerable.',
        story: 'The Nightwatcher brought the eternal night. The sun vanished. "I am the Sun," the Priest declared, glowing like a fusion reactor. The darkness retreated, hissing. The Nightwatcher was revealed, squinting in the glare. "You are too bright," the Nightwatcher complained. "And you are exposed." The Priest cast "Holy Fire." The Nightwatcher tried to meld with shadows, but the shadows were gone. He ran, but the light followed him. He tried to sleep, but the brilliance pierced his eyelids. He died tired and sunburned.'
    },
    'Death vs Sun': {
        explanation: 'The Sun is the nemesis of the Undead. Death WINS for the Sun. Skeletons crumble to dust. Wraiths evaporate. The Death Consul\'s "Death Knell" is weakened by the vitality of the Sun. The Consul tries to use the Underworld, but the Sun fills the entrance with light, sealing it. It is a one-sided purge.',
        story: 'The Death Consul summoned a bone dragon. The Priest looked at it. The dragon caught fire. "Okay," the Consul said, nervous. "How about a ghost army?" He summoned wraiths. The Priest breathed, and the holy breath dissolved them. "Direct combat then." The Consul swung his scythe. The Priest caught the blade with a hand of molten gold. "Your authority ends where the dawn begins." The Consul looked at his hand, which was starting to turn to ash. "I hate mornings," he muttered, disintegrating.'
    },
    'Demoness vs Sun': {
        explanation: 'Demoness uses plague and charm. Sun purifies plague. Sun is "ascetic" and resistant to charm. The Holy Light burns the threads of the Demoness. She tries to spread disease; the Sun creates a "Sanctuary" where disease cannot exist. Her black flames are overpowered by the Sun\'s white flames.',
        story: 'The Demoness released a cloud of pink toxin. "Purify," the Priest said. The cloud turned into fresh mountain air. She tried to seduce him. "Come closer, Father." "Notary: You are a monster," the Priest stamped the air. The charm broke. She shrieked, turning into a shadow. "Illuminate." The shadow vanished. The Demoness stood naked in the light, her skin burning. She tried to run, but the "Clemency of Light" bound her. "Beauty fades," the Priest noted, "but the Sun is eternal."'
    },
    'Hermit vs Sun': {
        explanation: 'The Hermit uses magic; the Sun overwhelms it. The Hermit\'s "Mystery" is revealed by the Light. The Sun\'s raw output destroys the Hermit\'s delicate scrolls and rituals. The Hermit tries to hide in information, but the Sun burns the data. The Sun is a brute force of holiness that the scholar cannot calculate a defense for.',
        story: 'The Mystic cast a spell of starlight. The Priest cast a spell of sunlight. The sunlight ate the starlight. "My lumen count is higher," the Priest stated. The Mystic tried to use "Hidden Sage" whispers to distract him. "I hear only the Lord," the Priest chanted loudly, drowning out the whispers. He summoned a hammer of light. The Mystic raised a shield of secrets. The hammer smashed the shield. "Secrets are meant to be exposed," the Priest said, raising the hammer again.'
    },
    'Justiciar vs Sun': {
        explanation: 'Order vs Order. Draw. Both value laws and contracts. The Justiciar forbids chaos; the Sun burns it. They shake hands. The Justiciar\'s armor resists the heat; the Sun\'s buffs resist the prohibition. They effectively have a non-aggression pact because their authorities are too similar.',
        story: '"Prohibition: Disorder," the Justiciar said. "Notarized," the Priest agreed. "We are in agreement," the Justiciar lowered his weapon. "Indeed. Praise the Light," the Priest nodded. "Praise the Law." They stood there for a while, ensuring no one else was breaking the rules, then went to lunch.'
    },
    'Mother vs Sun': {
        explanation: 'Life vs Life. Draw. The Sun provides energy for plants; the Mother uses it. The Priest attacks with fire; the Planter heals. They are both sources of vitality. The battle is a lush, overgrown stalemate where the Sun makes the forest grow too fast, and the forest blocks the Sun.',
        story: 'The Priest burned the forest. "Thank you for the energy," the Planter said. The ash fertilized the soil, and the sunlight accelerated the regrowth. The forest came back twice as big. "You are welcome?" the Priest was confused. He tried to purify her. "I am full of life, not corruption," she smiled. The light just made her glow. They stood in a blindingly bright jungle, neither able to harm the other without harming the very concept of "Life" they both upheld.'
    },
    'Moon vs Sun': {
        explanation: 'Sun beats Moon. The Moon relies on darkness and the crimson moon. The Sun brings the Day. The Vampire burns in the sunlight. The Sun cancels the Moon\'s buffs. The Beast is blinded and weakened, its regeneration halted by the cauterizing holy fire.',
        story: 'The Vampire hissed, covering his eyes. "Turn it off!" "No," the Priest said, increasing the brightness. The Vampire\'s skin began to smoke. He tried to transform into mist, but the mist evaporated. "I am a noble of the night!" "It is noon," the Priest informed him. The Vampire burst into flames. He tried to regenerate, but the holy fire consumed the blood before it could heal the wound. He ended as a pile of very clean ash.'
    },
    'Paragon vs Sun': {
        explanation: 'Machines overheat. The Sun focuses heat on the Paragon\'s tech. "Optics overload." The Priest purifies the "spirituality" in the machines, disrupting the connection. The Paragon\'s sensors are blinded by the intensity. Holy Light melts steel.',
        story: 'The Artisan targeted the Priest. "Thermal sensors active." "Maximum output," the Priest glowed. "Sensors overloaded. System overheating." The mech began to sweat oil. "Purge the machine," the Priest commanded. A beam of light struck the engine. The coolant evaporated. The machine seized up, fusing into a solid block of metal. The Artisan ejected, patting out the flames on his eyebrows. "Need better heat sinks," he noted.'
    },
    'Red Priest vs Sun': {
        explanation: 'Fire vs Holy Fire. Draw. Both are immune to heat. The Red Priest controls the flames; the Sun controls the light. The Red Priest tries to provoke; the Sun buffers with "Tranquility." They stand in an inferno, neither bothered by it. It\'s a staring contest in a furnace.',
        story: 'The War Bishop unleashed a firestorm. The Priest walked through it, his clothes unburnt. "Warm." "I can make it hotter," the Bishop grinned. He turned the sand to glass. The Priest made the glass glow. "You are boring," the Bishop Incited. "I am serene," the Priest replied. They threw fireballs at each other that just merged into bigger fireballs. Eventually, they realized they were just making the desert bigger.'
    },
    'Twilight Giant vs Sun': {
        explanation: 'Power vs Power. Draw. The Giant is too durable to be burned quickly. The Sun is too buffed to be squashed easily. The Giant\'s "Dusk" decays the light; the Sun\'s "Dawn" renews it. They clash for days, the cycle of day and night playing out in real-time combat.',
        story: 'The Giant swung his sword, bringing the Twilight. The Priest raised his staff, bringing the Dawn. The two lights collidedorange vs white. The sky split. The Giant tanked a holy laser with his chest. "Is that all?" The Priest tanked a shockwave with a shield of light. "Is that all?" They hit each other again. And again. The landscape was flattened, but the two champions stood firm, renewable energy vs immovable object.'
    },
    'Tyrant vs Sun': {
        explanation: 'Same Sefirah. Draw. Storms vs Sun. The clouds block the sun; the sun pierces the clouds. The Tyrant is chaotic; the Sun is ordered. They cancel each other out. The lightning is purified; the light is scattered by rain. It is a weather forecast of "Partly Cloudy with chance of Armageddon."',
        story: '"I will blot out the sun!" The Tyrant summoned storm clouds. "The sun always rises!" The Priest pierced the clouds with rays. Lightning struck the Priest\'s shield. Holy fire struck the Tyrant\'s armor. "You are too loud," the Priest said. "WHAT?" the Tyrant yelled over the thunder. They fought until they were both exhausted, the weather changing every five seconds between hurricane and drought.'
    },
    'Wheel of Fortune vs Sun': {
        explanation: 'Sun WINS. The Sun\'s luck is "Notarized." He enforces a contract that "Good things happen to me." The Monster tries to use bad luck, but the Sun purifies the "misfortune." The Light reveals the Monster\'s position, preventing the sneak attacks that Wheel of Fortune relies on.',
        story: 'The Monster tried to make the Priest trip. "I walk in the light," the Priest said, stepping over the rock. "Lightning strike!" the Monster called. "The sky is clear," the Priest noted. The lightning hit a tree instead. "Why is nothing working?" "I have blessed myself," the Priest explained. "My luck is holy." He cast a beam of light. The Monster tried to dodge, but "coincidentally" slipped on his own shoelaces and fell into the beam. "That\'s not fair!" he shouted, disintegrating.'
    },

    // === BATCH 8: TYRANT VS REMAINING ===
    'Abyss vs Tyrant': {
        explanation: 'The Tyrant commands the ocean; the Abyss is a sewer. Tyrant WINS. The Ocean cleanses the filth. The Tyrant\'s lightning is "Yang" nature, damaging to evil spirits. The Devil tries to corrupt the water, but the Tyrant controls the volume of an entire sea. Dilution is the solution to pollution.',
        story: 'The Devil spewed corruption into the bay. "Disgusting," the Tyrant boomed. He summoned a tsunami. The wall of water smashed into the Devil, washing away the sludge. "I will drown you in filth!" the Devil gurgled. "I will fry you in salt water," the Tyrant retorted. Lightning struck the water. Since salt water is conductive, and the Devil was wet, the voltage was catastrophic. The Devil convulsed, his corruption neutralized by millions of volts.'
    },
    'Black Emperor vs Tyrant': {
        explanation: 'Tyrant uses raw power; Black Emperor uses distortion. Tyrant WINS (Mid). The Tyrant\'s attacks are AOE (Area of Effect). You cannot Distort the entire sky. If the Tyrant summons a hurricane, distorting the wind direction just creates a tornado. The sheer magnitude of the Tyrant\'s output overwhelms the Emperor\'s ability to micromanage the laws.',
        story: '"I distort the lightning!" The bolt curved... and hit the Emperor\'s leg instead of his head. "Still hurts!" The Tyrant summoned a storm covering 50 miles. "Distort that." The Emperor tried to enforce "Order," but the wind was too chaotic. "Sonic Boom!" The Tyrant shouted. The Emperor tried to bribe the sound waves, but they were too loud to hear the offer. He was blasted backward, his armor cracking under the brute force of nature.'
    },
    'Chained vs Tyrant': {
        explanation: 'Chains vs Storms. Tyrant WINS. The Chained cannot bind the wind. The Tyrant can turn into lightning to escape bindings. The Chained relies on silence; the Tyrant is the loudest thing on earth. The sonic booms shatter the Chained\'s concentration. Lightning destroys the wraith form.',
        story: 'The Prisoner tried to bind the Tyrant. The Tyrant turned into a bolt of plasma and zipped into the sky. "Can\'t catch me!" He crashed down as a thunderclap. The shockwave stunned the Prisoner. The Prisoner turned into a Wraith. "Lightning conducts through spirits," the Tyrant grinned. He summoned a storm. The Wraith acted as a lightning rod. ZZZRRRT. The Prisoner was fried, materialized back into a smoking body. "Shocking result," the Tyrant laughed.'
    },
    'Darkness vs Tyrant': {
        explanation: 'Lightning illuminates the Darkness. Tyrant WINS. The flash of lightning reveals the Nightwatcher. The storm disrupts the "quiet" needed for concealment. The Tyrant can "hear" everything in his wind domain. The Darkness Beyonder cannot hide from a man who uses the atmosphere as a sonar.',
        story: 'The Nightwatcher hid in the shadows. FLASH. Lightning lit up the alley like a stadium. "There you are," the Tyrant pointed. A gust of wind slammed the Nightwatcher into a wall. "Quiet!" the Nightwatcher pleaded. "NO!" the Tyrant shouted, shattering windows. The rain began to fall. The Tyrant sensed every raindrop. He knew exactly where the Nightwatcher was by the void in the rain pattern. He directed a concentrated beam of sound at that spot, knocking the assassin unconscious.'
    },
    'Death vs Tyrant': {
        explanation: 'Undead hate lightning. Tyrant WINS. The lightning has a purification effect. The wind scatters the death fog. The Tyrant can smash the skeletons with air pressure. The Death Consul\'s spirit army is dispersed by the hurricane winds.',
        story: 'The Death Consul summoned a fog of decay. "Hurricane!" The Tyrant blew the fog away in seconds. The Consul summoned wraiths. "Lightning Storm!" The sky turned white. The wraiths popped like balloons. The Consul tried to use a Death Knell. The Tyrant sang a sea shanty at 200 decibels. The sonic interference cancelled the Knell. The Consul, bleeding from the ears, realized he brought a whistle to a rock concert.'
    },
    'Demoness vs Tyrant': {
        explanation: 'Weather cleanses plague. Tyrant WINS. The hurricane blows the miasma away. The rain washes the toxins out of the air. The Tyrant is too blustery to be charmed. He shocks the Demoness, disrupting her threads. Her black flames are doused by the ocean.',
        story: 'The Demoness spread her pestilence. "Rain," the Tyrant commanded. A torrential downpour scrubbed the air clean. She tried to charm him. "I am married to the Sea!" he bellowed. He hit her with a wind cannon. She flew three blocks. She tried to freeze him with black ice. He shattered the ice with a vibration song. "You are fragile!" he mocked, striking her with a lightning trident.'
    },
    'Hermit vs Tyrant': {
        explanation: 'Spells vs Nature. Tyrant WINS. The Hermit needs to chant; the Tyrant screams over him. The storm disrupts the delicate energies of rituals. The Tyrant is faster (lightning speed) and hits harder. The Hermit\'s eyes are blinded by the flashes.',
        story: 'The Mystic began a ritual. BOOM. Thunder shook the ground, ruining the circle. "Silence!" the Mystic yelled. "NEVER!" the Tyrant yelled back. The Mystic tried to turn into information. The Tyrant magnetized the air. The data stream was scrambled by static electricity. The Mystic reappeared, dizzy. "System crash?" the Tyrant asked, dropping a water hammer on him.'
    },
    'Justiciar vs Tyrant': {
        explanation: 'Nature vs Law. Tyrant WINS. You can prohibit "Illegal Entry," but a hurricane doesn\'t care. The Tyrant\'s power is "Disaster" level, often exceeding the Justiciar\'s jurisdiction limits. The Tyrant overwhelms the order with sheer chaotic force.',
        story: '"Prohibition: High Winds," the Justiciar stated. The wind slowed. "I am the Sea," the Tyrant said. "Prohibit the tide." A tsunami crashed over the Justiciar. "Prohibition: Wetness?" the Justiciar tried, gargling water. The Tyrant electrified the water. The Justiciar\'s armor became a cage of voltage. The laws of man crumbled before the laws of nature.'
    },
    'Mother vs Tyrant': {
        explanation: 'Nature vs Nature. Draw. The rain feeds the plants. The plants drink the water. The Tyrant strikes with lightning; the Mother regrows the tree. They are two forces of the planet fighting. It ends with a very lush, very stormy island.',
        story: 'The Tyrant flooded the forest. "Mangroves," the Planter whispered. The trees adapted and thrived. The Tyrant struck a tree with lightning. "Fire creates renewal," the Planter noted. The Planter summoned giant vines to pull the Tyrant from the sky. The Tyrant turned into wind and slipped away. "We are good for the ecosystem," the Planter observed. "I suppose," the Tyrant grumbled, unable to drown a woman who could breathe underwater using gills she just grew.'
    },
    'Moon vs Tyrant': {
        explanation: 'Storms scare beasts. Tyrant WINS. The loud noises panic the instinctual Moon Beyonder. Lightning creates fire, which beasts hate. The Tyrant controls the environment, denying the Beast any cover.',
        story: 'The Werewolf howled. The Thunder howled louder. The Werewolf whimpered. "Who is the alpha now?" the Tyrant asked. The Werewolf charged. The Tyrant flew up. "Fetch," the Tyrant threw a lightning bolt. The Werewolf was struck. He regenerated, but the Tyrant kept striking. "Sit." A wind press slammed the beast into the mud. The Tyrant floated above, a cruel master of the elements.'
    },
    'Paragon vs Tyrant': {
        explanation: 'Water + Electronics = Bad. Tyrant WINS. The rain shorts out the circuits. The salt air corrodes the metal. Lightning overloads the capacitors. The Paragon\'s tech is fragile against raw elemental fury.',
        story: 'The Artisan deployed a drone swarm. "EMP," the Tyrant mimicked, summoning a magnetic storm. The drones fell out of the sky. The Artisan targeted with a laser. The rain diffracted the beam. "My equipment is not waterproof rating IP68!" the Artisan panicked as the tsunami hit. The mech sparked and died. The Tyrant laughed. "Analog beats digital."'
    },
    'Red Priest vs Tyrant': {
        explanation: 'Storm vs War. Draw. Same Sefirah group. The wind fans the flames. The flames heat the air, creating more wind. They synergize destructively. The Red Priest is a tank; the Tyrant is a blaster. They wreck the continent but not each other.',
        story: 'The city burned. The hurricane raged. "Nice weather," the War Bishop said. "Perfect for a fight," the Tyrant agreed. Fire swirled in the tornado. Lightning struck the magma. They traded blowsa flaming sword against a lightning trident. The shockwaves leveled mountains. They laughed, enjoying the destruction, two catastrophes masquerading as men.'
    },
    'Wheel of Fortune vs Tyrant': {
        explanation: 'Force beats Luck. Tyrant WINS. You can\'t be "lucky" inside a tsunami; you are just wet. The scale of the attack leaves no room for probability to save the Monster. The Tyrant destroys the entire grid square.',
        story: 'The Monster stood on a lucky spot. The Tyrant destroyed the spot, and the mile around it. "Missed me?" the Monster squeaked, floating in the water. The Tyrant electrified the entire ocean. "Ouch." The Monster tried to reboot. The Tyrant shouted so loud it broke the Monster\'s concentration. "No do-overs!" he yelled, striking him with a thunderbolt.'
    },

    // === BATCH 9: HANGED MAN & DARKNESS MATCHUPS ===
    'Darkness vs Hanged Man': {
        explanation: 'Shadow vs Shadow. Draw. Both have "Death" and "Darkness" aspects. The Shepherd grazes souls; the Nightwatcher conceals them. The Shepherd uses corruption; the Nightwatcher uses tranquility. They negate each other. The Shepherd heals from the assassination attempts; the Nightwatcher hides from the corruption.',
        story: 'The Shepherd walked into the dark alley. "I know you are here." The Nightwatcher struck from the shadows, slitting the Shepherd\'s throat. The wound bubbled and healed. "Rude." The Shepherd released a soul scream. The Nightwatcher absorbed it into the silence. "We are the same," the Shepherd said, his shadow writhing. "We are kin," the Nightwatcher agreed. They merged into the darkness, neither winning, just existing as a nightmare.'
    },
    'Death vs Hanged Man': {
        explanation: 'Undead vs Corrupted. Draw. The Shepherd can graze spirits; the Death Consul controls them. They fight for control of the same ghosts. The Shepherd is hard to kill (Regeneration); the Consul is hard to kill (Undead). It is a messy, fleshy stalemate.',
        story: 'The Death Consul summoned a wraith. "Mine," the Shepherd said, opening his mouth. He ate the wraith. "Hey!" the Consul protested. He cast Death Knell. The Shepherd turned into a pool of blood and reformed. "You have good flavor," the Shepherd commented. The Consul looked disgusted. "You are vile." "And you are dead." They threw curses at each other that the other just absorbed. A battle of attrition with no end.'
    },
    'Twilight Giant vs Hanged Man': {
        explanation: 'Tank vs Regen. Hanged Man WINS (Mid). The Giant does physical damage. The Shepherd heals physical damage instantly. The Shepherd uses "Flesh Magic" to rot the Giant from the inside. The Giant has high defense, but low resistance to internal corruption. The Shepherd outlasts the warrior.',
        story: 'The Giant smashed the Shepherd flat. The Shepherd turned into a meat pancake, then inflated back to normal. "Is that it?" The Giant chopped him in half. The two halves grew into two Shepherds. "Stop that!" The Shepherds touched the Giant. The Giant\'s armor began to bleed. His skin rotted. "Poison?" "Corruption," the Shepherds said in unison. The Giant fell, his mighty body betraying him.'
    },
    'Red Priest vs Hanged Man': {
        explanation: 'War vs Corruption. Hanged Man WINS (Mid). The Red Priest relies on physical damage and fire. The Shepherd regenerates. The Shepherd\'s "Shadow" abilities can douse the fire. The Corruption spreads through the Red Priest\'s army, turning his soldiers into the Shepherd\'s minions.',
        story: 'The War Bishop burned the Shepherd. The Shepherd screamed, his skin blackening. Then the burnt skin sloughed off, revealing fresh pink flesh. "Fire purifies," the Bishop stated. "Pain enlightens," the Shepherd retorted. He cast a "Depravity" aura. The Bishop\'s mind felt clouded. The Bishop\'s own blood began to attack him. The Shepherd grazed the soul of the Bishop\'s lieutenant and used it to stab the Bishop in the back. The God of War fell to the God of Suffering.'
    },
    'Demoness vs Hanged Man': {
        explanation: 'Plague vs Corruption. Draw. Both use toxins and dark magic. The Demoness is immune to the Shepherd\'s rot; the Shepherd is immune to the Demoness\'s plague. They are two diseases trying to infect each other. The result is a super-virus, but no winner.',
        story: 'The Demoness kissed the Shepherd. "Poison," she smiled. "Delicious," he swallowed. "Have some rot." He touched her. Her skin turned grey, then healed. "We are a match made in hell," she noted. "Indeed." They traded blows of shadow and ice. They regenerated endlessly. It was a grotesque dance of death where no one actually died.'
    },
    'Justiciar vs Hanged Man': {
        explanation: 'Order vs Chaos. Justiciar WINS. The Justiciar "Prohibits" regeneration. He "Deprives" the Shepherd of his grazed souls. The Order purges the corruption. The Shepherd relies on breaking rules of biology; the Justiciar enforces them.',
        story: '"Prohibition: Shape-shifting," the Justiciar ordered. The Shepherd tried to heal, but his flesh remained cut. "What?" "Prohibition: Soul Grazing." The souls inside the Shepherd were forced out. "You are emptying me!" "You are illegal," the Justiciar stated. He delivered a final execution blow. The Shepherd, unable to heal or use his stolen powers, died like a mortal.'
    },
    'Black Emperor vs Hanged Man': {
        explanation: 'Distortion vs Corruption. Hanged Man WINS (Mid). The Black Emperor distorts the attack, but the Shepherd attacks with an aura that covers everything. Corruption doesn\'t need to "hit"; it just needs to be near. The Shepherd can Graze the Emperor\'s shadow.',
        story: '"I distort the corruption!" The corruption just spread in a different pattern. The Shepherd walked forward, his shadow expanding. The Emperor tried to bribe the shadow, but the shadow was hungry. "Join me," the Shepherd whispered. The Emperor felt his own "Disorder" turning against him, mutating into "Madness." He couldn\'t distort the rot in his own mind.'
    },
    'Hermit vs Hanged Man': {
        explanation: 'Magic vs Flesh. Hanged Man WINS. The Hermit casts spells; the Shepherd eats them (via grazed souls). The Shepherd closes the distance and uses "Flesh Magic" to silence the Hermit. The Hermit\'s eyes see the True Creator inside the Shepherd and go blind from madness.',
        story: 'The Mystic looked at the Shepherd. "Analysis..." He saw a mountain of writhing worms. He screamed, bleeding from the eyes. "Do not look at God," the Shepherd admonished. The Mystic blindly cast spells. The Shepherd regenerated through the damage and snapped the Mystic\'s neck. "Knowledge is a burden. Let me relieve you of it."'
    },
    'Paragon vs Hanged Man': {
        explanation: 'Machine vs Rot. Hanged Man WINS. Metal rusts. Circuits rot. The Shepherd\'s corruption affects inanimate objects. The machine turns into a biomechanical horror that obeys the Shepherd. The Paragon cannot repair the "flesh" growing on his gears.',
        story: 'The Artisan fired a cannon. The Shepherd turned to sludge and reformed. He touched the tank. The metal began to bleed. Eyes opened on the gun barrel. "My tank is... alive?" the Artisan horrified. "It is one of my flock now," the Shepherd said. The tank turret turned and aimed at the Artisan. "Bad tank!" the Artisan yelled, before being blasted by his own creation.'
    },
    'Mother vs Hanged Man': {
        explanation: 'Life vs Death. Mother WINS (Mid). Life overcomes decay. The Planter can grow plants inside the Shepherd\'s flesh, bursting him apart. She can "Purify" the corruption with life force. Her regeneration is superior because it is natural, not stolen.',
        story: 'The Shepherd tried to rot the tree. The tree grew faster than it rotted. It wrapped around the Shepherd. "I will consume you," the Shepherd said. "I will use you as fertilizer," the Planter replied. Seeds sprouted in the Shepherd\'s stomach. He choked on vines. His regeneration was overwhelmed by the aggressive growth of the forest. He became a compost heap.'
    },
    'Moon vs Hanged Man': {
        explanation: 'Beast vs Abomination. Draw. Both have high regen. The Werewolf tears the Shepherd apart; the Shepherd reforms. The Shepherd tries to corrupt the Werewolf; the Werewolf resists with "Darkness" traits. It is a bloodbath that lasts until sunrise.',
        story: 'Claws met Shadow. The Werewolf bit the Shepherd\'s head off. The Shepherd grew a new one. "Tasty?" the Shepherd asked. The Werewolf spat. "Rotten." He tore the Shepherd into pieces. The pieces crawled back together. "You are annoying," the Beast growled. "You are persistent," the Shepherd replied. They resumed the slaughter.'
    },
    'Chained vs Hanged Man': {
        explanation: 'Prisoner vs Jailer. Hanged Man WINS. The Shepherd grazes the Wraith. The Chained tries to possess the Shepherd, but the Shepherd\'s soul is a crowded bus of madness. The Chained gets lost in the noise. The Shepherd\'s shadow dominates the Chained\'s shadow.',
        story: 'The Prisoner possessed the Shepherd. Inside, he heard a thousand screaming voices. "Get out!" the Prisoner yelled, trying to leave. "Stay," the voices said. The Shepherd\'s soul consumed the intruder. In the real world, the Shepherd smiled. "Another sheep for the flock."'
    },
    'Abyss vs Hanged Man': {
        explanation: 'Corruption vs Corruption. Draw. They are the same. Filth meets Rot. They high-five. The Shepherd\'s "Degeneration" does nothing to a Devil. The Devil\'s "Foulness" is perfume to a Shepherd. They cannot hurt each other effectively.',
        story: '"You smell like sulfur," the Shepherd noted. "You smell like corpses," the Devil replied. They threw sludge at each other. It just added mass to their bodies. "This is pointless," the Devil said. "Agreed. Want to go torment some mortals?" "Sure."'
    },
    'Wheel of Fortune vs Hanged Man': {
        explanation: 'Death ignores Luck. Hanged Man WINS. The Shepherd covers the area in shadow. You cannot "luckily" dodge an atmosphere. The Shepherd regenerates any "lucky hits" the Monster lands. The Monster eventually runs out of luck.',
        story: 'The Monster got a critical hit. The Shepherd\'s head exploded. The head grew back. "That was a one in a million shot!" the Monster complained. "Do it again," the Shepherd challenged. The Monster tried to reboot. The Shepherd used a "Soul shriek" to disrupt the concentration. The shadow swallowed the Monster. "Your luck just ran out."'
    },
    'Death vs Darkness': {
        explanation: 'Shadow vs Spirit. Draw. Darkness conceals; Death creates spirits that sense life. The Nightwatcher hides; the Death Consul attacks the area with "Death Knell." The Nightwatcher sleeps the Consul; the Consul\'s skeletons keep fighting. They are both gloom-based and highly resistant to each other.',
        story: 'The graveyard was silent. The Nightwatcher slept the Consul. The Consul fell asleep. The skeletons, however, did not have brains to sleep. They attacked. The Nightwatcher woke the Consul up by stabbing him. The Consul turned into a wraith and phased through the blade. "We are both ghosts," the Consul said. "Go back to sleep," the Nightwatcher suggested. "No you."'
    },
    'Twilight Giant vs Darkness': {
        explanation: 'Assassin vs Tank. Darkness WINS (High). The Giant cannot hit what he cannot see. The Nightwatcher conceals himself and strikes the Giant\'s weak points (eyes, throat) repeatedly. The Nightwatcher uses "Slumber" to make the Giant drowsy, lowering his defense. The Giant swings at shadows until he collapses.',
        story: 'The Giant swung at the air. "Come out and fight!" The Nightwatcher sat on the Giant\'s shoulder. "Sleep," he whispered. The Giant yawned. His eyelids felt heavy. "I... will... crush..." He fell over, snoring. The Nightwatcher calmly slit his throat. It took a while to saw through the muscle, but the Giant slept through it.'
    },
    'Red Priest vs Darkness': {
        explanation: 'Fire vs Dark. Darkness WINS (Mid). The Nightwatcher snuffs the flames with "Tranquility." He conceals the Red Priest\'s soldiers, cutting off the Priest\'s command. The Priest lights up the area, but the Darkness absorbs the light. The Assassin strikes from the blind spot.',
        story: 'The Bishop lit a torch. The Darkness swallowed the light. "I sense you," the Bishop swung his sword. Missed. The Nightwatcher put the Bishop to sleep. The Bishop used pain to wake up. "You are annoying," the Bishop growled. "You are loud," the Nightwatcher said, stabbing him in the kidney and vanishing again.'
    },
    'Demoness vs Darkness': {
        explanation: 'Stealth vs Stealth. Draw. The Demoness turns invisible; the Nightwatcher turns invisible. They walk past each other. The Demoness uses threads; the Nightwatcher phases through them. The Demoness uses plague; the Nightwatcher holds his breath (state of undead).',
        story: 'An empty room. Suddenly, sparks flew in the center. Daggers met invisible threads. "I see you," the Demoness lied. "No you don\'t," the Nightwatcher replied from behind her. She unleashed black flames. He concealed the flames. They realized they were just messing up the furniture without hurting each other. They faded away.'
    },
    'Justiciar vs Darkness': {
        explanation: 'Law reveals Truth. Justiciar WINS. "Prohibition: Concealment." The shadows are banned. The Nightwatcher is forced into the light. The Justiciar\'s armor protects against the dagger strikes. The Nightwatcher loses his primary advantage.',
        story: '"Prohibition: Hiding," the Justiciar stated. The shadows lifted. The Nightwatcher stood there, awkward. "You are under arrest." The Nightwatcher tried to run. "Prohibition: Fleeing." The Nightwatcher froze. "This is unfair," he muttered as the cuffs went on.'
    },
    'Black Emperor vs Darkness': {
        explanation: 'Shadow vs Shadow. Darkness WINS (Mid). The Black Emperor needs shadows to distort. The Nightwatcher *controls* shadows. He enters the Emperor\'s shadow and attacks from within. The Emperor distorts the attack, but the Nightwatcher is already gone. The Nightwatcher sleeps the Emperor.',
        story: 'The Emperor grew giant. The Nightwatcher stepped into the Emperor\'s shadow. "Get out of my shadow!" the Emperor yelled, stomping. The Nightwatcher traveled up the shadow and stabbed the Emperor\'s neck. The Emperor distorted the wound to his arm. "Sleep," the Nightwatcher commanded. The Emperor distorted the sleep to "Dizziness." He stumbled. The Nightwatcher stabbed again. Death by a thousand cuts.'
    },
    'Hermit vs Darkness': {
        explanation: 'Magic vs Concealment. Darkness WINS. The Hermit cannot target what he cannot see. The Nightwatcher conceals his fate, preventing the Hermit\'s divination. The Hermit casts a spell; the Nightwatcher erases the sound of the chanting, cancelling it. The Assassin kills the mage before the shield goes up.',
        story: 'The Mystic scanned the room. "Oracle eyes..." Nothing. He felt a blade in his back. "Shield!" Too late. "How did I not foresee this?" the Mystic gasped. "I concealed the future," the Nightwatcher whispered, wiping his blade.'
    },
    'Paragon vs Darkness': {
        explanation: 'Sensors vs Stealth. Darkness WINS (High). The Nightwatcher conceals his heat signature. The Paragon\'s sensors show nothing. The Nightwatcher puts the Artisan to sleep inside the cockpit. He then dismantles the mech from the outside.',
        story: '"Radar clear. Thermal clear. Motion clear," the AI reported. The Artisan relaxed. Suddenly, the cockpit hatch opened. "Nap time," the Nightwatcher said. The Artisan fell asleep on the controls. The Nightwatcher planted a bomb and walked away. "Tech relies on input. I provide none."'
    },
    'Mother vs Darkness': {
        explanation: 'Life vs Death. Darkness WINS (Mid). The Nightwatcher conceals himself from the plants. He walks through the forest untouched. He assassinates the Planter. The Planter heals, but the Nightwatcher puts her to sleep. A sleeping healer cannot heal.',
        story: 'The forest sensed life. The Nightwatcher suppressed his life signs. To the trees, he was a rock. He walked up to the Planter. "Sleep." She fell asleep on a bed of moss. He stabbed her heart. She didn\'t wake up. He stabbed her again. "Peaceful death," he noted.'
    },
    'Moon vs Darkness': {
        explanation: 'Predator vs Shadow. Moon WINS (Mid). The Moon Beyonder has "night vision" and superior senses of smell. He smells the Nightwatcher. The Nightwatcher hides in darkness; the Moon controls darkness. The Beast hunts the Assassin.',
        story: 'The Nightwatcher vanished. The Werewolf sniffed. "Lavender soap. To the left." He lunged. The Nightwatcher was forced to block. "You smell fear," the Werewolf grinned. "I have no scent!" "You have a heartbeat," the Werewolf said, hearing the rhythm. He tore through the concealment. The hunter became the hunted.'
    },
    'Chained vs Darkness': {
        explanation: 'Shadow vs Shadow. Darkness WINS. The Chained uses shadows to bind; the Nightwatcher creates a domain where he is the King of Shadows. He controls the Chained\'s own chains. He puts the Chained (who is already crazy) to sleep.',
        story: 'The Prisoner summoned chains. The Nightwatcher took control of the chains and wrapped them around the Prisoner. "These are mine," the Nightwatcher said. The Prisoner screamed. "Hush," the Nightwatcher used Slumber. The Prisoner fell silent. The Nightwatcher finished him off. "You merely adopted the dark. I was born in it."'
    },
    'Abyss vs Darkness': {
        explanation: 'Dark vs Dark. Draw. The Abyss is too corrupt to sleep easily. The Nightwatcher hides, but the Abyss fills the room with AOE filth. The Nightwatcher cannot step in the filth. They avoid each other.',
        story: 'The room filled with poisonous gas. The Nightwatcher held his breath and hid on the ceiling. The Devil looked around. "Come out, little mouse." The Nightwatcher dropped a dagger. It bounced off the Devil\'s scales. "Found you," the Devil spewed magma. The Nightwatcher vanished to the next room. "Too messy," he decided, leaving.'
    },
    'Wheel of Fortune vs Darkness': {
        explanation: 'Luck vs Stealth. Draw. The Nightwatcher attacks; the Monster "luckily" bends down to tie his shoe. Miss. The Nightwatcher tries again; the dagger handle breaks. The Monster tries to find the Nightwatcher but trips. It is a comedy of whiffs.',
        story: 'The Nightwatcher struck. The Monster sneezed, jerking his head back. The blade cut a single hair. "Bless you," the Nightwatcher whispered by accident. "Thanks!" The Monster threw a brick blindly. The brick hit a gargoyle, which fell on the Nightwatcher\'s toe. "Ouch!" The Nightwatcher revealed himself. "Reboot!" The Monster reset the fight. They realized they were going nowhere.'
    },

    // === BATCH 10: DEATH, TWILIGHT GIANT, RED PRIEST VS REMAINING ===
    'Twilight Giant vs Death': {
        explanation: 'Death WINS (Mid). The Giant is a physical tank; Death attacks the spirit. The Death Consul uses "Death Knell" to attack the soul directly, bypassing the Giant\'s physical armor. The Giant can kill skeletons, but the Consul can just raise them again. The Giant eventually succumbs to the "withering" of his life force.',
        story: 'The Giant swung a sword that cleaved the hill in two. The Death Consul turned into mist, reforming behind the Giant. "Your strength is wasted," the Consul whispered. He cast a Death Knell. The Giant stumbled, clutching his chest. "I am invincible!" the Giant roared, swinging blindly. "Everything dies," the Consul replied, summoning a bone dragon to distract the Giant. While the Giant wrestled the dragon, the Consul severed the Giant\'s spirit threads. The massive body fell, not from a wound, but because the pilot was evicted.'
    },
    'Red Priest vs Death': {
        explanation: 'Death WINS (Mid). The Red Priest leads an army of the living; Death leads an army of the dead. When the Red Priest\'s soldiers die, they join the Death Consul. The Consul can "Soothe" the Red Priest\'s frenzy using the repose of death. The Red Priest\'s fire burns bodies, but the Consul attacks the spirit.',
        story: '"Burn!" The War Bishop incinerated the zombie horde. "Rise," the Consul commanded. The ashes swirled and formed wraiths. "Fire doesn\'t hurt ghosts," the Consul noted. The Bishop charged, flaming sword raised. The Consul used "Wither." The Bishop\'s arm turned grey and weak. "You fight a losing war," the Consul said. "My army grows every time yours falls." The Bishop looked at his fallen soldiers, now standing up with blue eyes. Morale broke, and the Reaper claimed the general.'
    },
    'Demoness vs Death': {
        explanation: 'Death WINS (Mid). The Demoness uses charm and plague. The Undead are immune to disease and cannot be seduced. The Demoness\'s primary weapons are useless. The Consul sends a horde of wraiths that the Demoness cannot physically block. She is overwhelmed by enemies she cannot manipulate.',
        story: 'The Demoness spread a deadly virus. The skeletons marched through it, unaffected. "Boys," she purred, exposing her shoulder. The skeletons didn\'t care. They raised their rusted swords. "This is boring," the Demoness complained, turning to flee. The Death Consul appeared in her path. "Beauty is temporary. Bone is eternal." He cast a spirit shriek. The Demoness froze, paralyzed by the assault on her soul. The horde caught up.'
    },
    'Justiciar vs Death': {
        explanation: 'Death LOSES (Mid). Justiciar represents Order; Undead represent disorder of life. The Justiciar "Prohibits" the rising of the dead. He enforces the law that "Dead things must stay dead." The Death Consul\'s army crumbles under the weight of the law. The Consul is stripped of his authority.',
        story: '"Prohibition: Necromancy," the Justiciar declared. The skeletons collapsed into piles of bone. The wraiths dissipated. "You ruined my army," the Consul said, annoyed. "I corrected a violation," the Justiciar replied. The Consul tried to use a Death Knell. "Prohibition: Sonic Attacks." The Consul opened his mouth, but no sound came out. He stood defenseless as the Justiciar delivered the execution sentence.'
    },
    'Black Emperor vs Death': {
        explanation: 'Death WINS (Mid). The Black Emperor distorts the living world, but Death is a constant. You cannot "distort" the fact that you are dead. The Consul attacks with Spirit Piercing, which tracks the Emperor through his distortions. The Emperor\'s chaotic nature makes him vulnerable to the absolute certainty of the End.',
        story: '"I distort the distance to the grave!" the Emperor shouted. "The grave waits for all," the Consul replied calmly. He sent a wailing spirit to latch onto the Emperor. The Emperor distorted the spirit into a hat. "Amusing," the Consul said. "Death Knell." The attack struck the Emperor\'s soul directly. He couldn\'t distort the pain inside his own mind. He fell to his knees. "Law is flexible. Death is not," the Consul stated, claiming him.'
    },
    'Hermit vs Death': {
        explanation: 'Death WINS (Mid). The Hermit uses magic; Death uses souls. The Consul sends wraiths to phase through the Hermit\'s magical shields. The Hermit\'s "Mystery" cannot hide him from the sensing of life force. The Consul overwhelms the scholar with the sheer terror of the Underworld.',
        story: '"Shield of Starlight," the Mystic cast. A wraith flew right through it and screamed in his face. "Concentration broken," the Mystic gasped. The Consul walked forward, the grass dying beneath his feet. "Your spells require words. I require only intent." The Mystic tried to turn into information, but the Consul grabbed his spirit thread. "You cannot upload your soul to escape judgment."'
    },
    'Paragon vs Death': {
        explanation: 'Death WINS (Mid). Machines have no souls, but the operator does. The Consul ignores the mech and attacks the pilot with Spirit Piercing. The Paragon cannot build a shield against a spiritual attack. The undead clog the gears of the machines with their bodies.',
        story: 'The mech fired a barrage of missiles. The Consul turned into mist. The missiles hit nothing. "Target lost," the AI said. The Consul materialized inside the cockpit. "Hello," he said to the terrified Artisan. "Eject!" The Consul grabbed the Artisan\'s hand. "Wither." The hand turned skeletal. The Artisan couldn\'t press the button. The machine stood silent, a metal tomb.'
    },
    'Mother vs Death': {
        explanation: 'Death LOSES (High). Life counters Death. The Mother Beyonder floods the area with vitality, burning the undead like acid. She heals the decay instantly. She can "plant" life inside the Consul, turning him into a tree. Death cannot exist where Life is absolute.',
        story: 'The Consul summoned a river of death. The Planter threw a seed into it. A massive lotus bloomed, sucking the death water dry and releasing healing pollen. The skeletons touched the pollen and turned into flowers. "Stop that," the Consul ordered. "Life finds a way," the Planter smiled. Vines burst from the Consul\'s chest. He tried to wither them, but they grew faster than he could rot them. He was consumed by the forest.'
    },
    'Moon vs Death': {
        explanation: 'Death WINS (Mid). The Moon relies on regeneration. Death creates wounds that do not heal. The Consul uses the "Death" attribute to cancel the "Life" attribute of the Vampire. The Beast fights physically; the Consul fights spiritually. The Beast dies tired.',
        story: 'The Vampire tore the Consul apart. The Consul reformed. "Again?" The Vampire panted. "Why won\'t you die?" "I am Death," the Consul explained. He touched the Vampire. The Vampire\'s skin turned grey. He tried to heal, but the wound remained. "My regeneration..." "Is cancelled." The Consul cast a Death Knell. The Vampire\'s heart stopped, and this time, it didn\'t restart.'
    },
    'Chained vs Death': {
        explanation: 'Death WINS (Mid). The Chained uses wraith forms; the Death Consul is the King of Wraiths. He controls the Chained Beyonder\'s spirit form. He suppresses the Chained\'s curses with the silence of the grave. The Chained is fighting in the Consul\'s home turf.',
        story: 'The Prisoner turned into a Wraith. "Look at me," the Consul commanded. The Prisoner felt a higher authority. He couldn\'t move. "You are a rebellious spirit," the Consul scolded. He forced the Prisoner into a spirit bottle. "Time out for you." The Prisoner banged on the glass, trapped by the authority over souls.'
    },
    'Abyss vs Death': {
        explanation: 'Draw (Extreme). Death vs Corruption. The Consul cannot kill the Devil because the Devil is already a corrupt form of life. The Devil cannot corrupt the Consul because he is dead. They throw mud and bones at each other. The Devil enjoys the Underworld; the Consul doesn\'t mind the sulfur.',
        story: '"You look dead," the Devil said. "You look ugly," the Consul replied. The Devil spewed magma. The Consul stepped sideways. The Consul sent skeletons. The Devil ate them. "Crunchy," the Devil noted. "You have no manners." They realized they couldn\'t hurt each other and decided to team up against the living.'
    },
    'Wheel of Fortune vs Death': {
        explanation: 'Death WINS (Mid). Death is inevitable. You cannot "luck" your way out of mortality. The Death Knell is an area attack; luck doesn\'t help. The Consul waits. The Monster reboots, but eventually, everyone dies. The Consul is the concept of the End.',
        story: 'The Monster dodged a bone spear. "Missed!" "I have time," the Consul said. The Monster rebooted the fight. "I still have time," the Consul said. The Monster tripped. "Gotcha," the Consul touched him. "Reboot!" "Prohibited," the Consul whispered, suppressing the spirituality. "Your luck runs out when your heartbeat does."'
    },
    'Red Priest vs Twilight Giant': {
        explanation: 'Draw (Extreme). Warrior vs Warrior. The Giant has higher defense; the Priest has higher damage. They are both melee specialists. The Giant tanks the fire; the Priest dodges the sword. It is a slugfest that destroys the continent. Neither can gain a decisive advantage.',
        story: 'Sword met Flaming Sword. The shockwave shattered the windows of the city. "You are strong," the Giant grunted. "You are tough," the Bishop replied. The Bishop set the Giant on fire. The Giant didn\'t care. The Giant smashed the Bishop flat. The Bishop turned into mist and reformed. They fought for seven days and seven nights. The mountains were dust, the rivers were dry, and they were both still standing, breathing heavily.'
    },
    'Demoness vs Twilight Giant': {
        explanation: 'Giant LOSES (Mid). The Giant is a brute; the Demoness is a debuffer. She uses "Plague" to rot him from the inside. She uses "Threads" to trip him. She seduces him, lowering his guard. The Giant swings at a nimble target he cannot hit, while dying of super-flu.',
        story: 'The Giant roared, swinging his hammer. The Demoness danced away, blowing a kiss. The Giant blushed. "Stop that!" "You look feverish," she noted. The Giant stumbled. His lungs burned. "Poison?" "Love," she teased. She tightened invisible threads around his neck. He pulled, choking himself. He was too strong for the threads, but too sick to fight back. He fell, defeated by a sneeze.'
    },
    'Justiciar vs Twilight Giant': {
        explanation: 'Giant LOSES (Mid). The Giant relies on physical force. The Justiciar "Prohibits" violence. The Giant is restrained by laws he cannot break. His size becomes a liability as the Justiciar increases gravity. Order binds the brute.',
        story: '"I will smash you!" "Prohibition: Smashing," the Justiciar said. The Giant\'s hammer stopped in mid-air. "Prohibition: Weapons." The hammer vanished. "I will use my fists!" "Prohibition: Fists." The Giant stood there, confused. The Justiciar hit him with a gavel. "Order in the court."'
    },
    'Black Emperor vs Twilight Giant': {
        explanation: 'Giant LOSES (Mid). The Giant swings; the Emperor distorts the aim. The Giant defends; the Emperor distorts the armor value to zero. The Giant is too straightforward for the chaotic Emperor. The Emperor grows to match the Giant\'s size and beats him with superior rules.',
        story: 'The Giant charged. The Emperor distorted the ground. The Giant tripped. "Fight me fair!" "I am an Emperor. I make the rules," the Emperor laughed. He distorted the Giant\'s sword into a rubber chicken. (Metaphorically, he distorted the hardness). The Giant hit the Emperor, but the impact bounced off. The Emperor hit the Giant, and the impact was magnified ten times. The Giant fell, beaten by physics.'
    },
    'Hermit vs Twilight Giant': {
        explanation: 'Giant LOSES (Mid). Brains beats Brawn. The Hermit flies out of reach and bombards the Giant with spells. The Hermit analyzes the Giant\'s fighting style and predicts every move. The Giant cannot hit a flying wizard.',
        story: 'The Giant threw a rock. The Hermit teleported. "Come down here!" "No," the Hermit said, casting a lightning storm. The Giant tanked the lightning but was getting annoyed. The Hermit cast "Eye of Mystery." The Giant looked and saw madness. He dropped his sword, clutching his head. The Hermit finished him with a concentrated beam of starlight.'
    },
    'Paragon vs Twilight Giant': {
        explanation: 'Giant LOSES (Mid). Technology beats primitive weapons. The Paragon uses a gravity cannon to pin the Giant. He uses lasers that cut through the Dawn Armor. The Giant is a big target for the artillery.',
        story: 'The Giant charged the mech. "Target locked," the Paragon said. A railgun fired. It punched a hole in the Giant\'s shoulder. "That hurt!" The Giant smashed the mech\'s leg. The mech didn\'t fall; it activated thrusters and flew up. "Aerial bombardment," the Paragon announced. Missiles rained down. The Giant swatted a few, but there were too many. He was buried in explosions.'
    },
    'Mother vs Twilight Giant': {
        explanation: 'Giant LOSES (Mid). The Giant destroys; the Mother regrows. The Giant tires; the Mother has infinite stamina. She binds him with giant roots that are as strong as steel. She drains his life force to heal herself. He is compost.',
        story: 'The Giant ripped the tree out of the ground. The tree bit him. "What?" The forest came alive. Vines wrapped his legs. "I am strong!" He broke the vines. More vines grew, thicker this time. They pulled him into the earth. The Planter walked up and placed a hand on his armor. The armor rusted; the Giant aged. "Return to the earth," she whispered.'
    },
    'Moon vs Twilight Giant': {
        explanation: 'Draw (Extreme). Beast vs Giant. Both are physical powerhouses. The Giant has weapons; the Beast has claws. The Giant has armor; the Beast has regen. They maul each other until both collapse. It is a raw display of violence.',
        story: 'The Werewolf bit the Giant\'s arm. The Giant punched the Werewolf\'s snout. They rolled around, crushing a village. "You bleed!" the Giant laughed. "You tire!" the Werewolf snarled, healing instantly. The Giant summoned the Twilight light. The Werewolf summoned the Crimson Moon. The lights clashed. They tackled each other off a cliff, fighting all the way down.'
    },
    'Chained vs Twilight Giant': {
        explanation: 'Giant LOSES (Mid). The Chained possesses the Giant. The Giant has high physical resistance but low mental/soul resistance. The Chained turns into a Wraith, ignores the armor, and takes the wheel. The Giant punches himself out.',
        story: 'The Giant swung his sword. The Prisoner vanished. "Where did you go?" "I am inside," a voice said in his head. The Giant stopped. His hand moved on its own. It dropped the sword. "Pick it up!" the Giant yelled at his hand. "No," the Prisoner said. The Giant\'s hands moved to his own throat. "This is embarrassing," the Giant choked, strangled by his own strength.'
    },
    'Abyss vs Twilight Giant': {
        explanation: 'Giant LOSES (Mid). The Giant hits the Devil; the Devil splashes corruption. The Giant\'s armor melts. The Giant attacks; the Devil uses "Danger Intuition" to dodge. The Devil corrupts the Giant\'s mind, driving the warrior into a frenzy where he attacks the air.',
        story: 'The Giant stepped on the Devil. "Burn," the Devil said. The Giant\'s boot melted. The corruption traveled up his leg. "It burns!" The Devil grew to match the Giant\'s size, a hulking demon. "I am the true monster," the Devil laughed. He breathed foul gas. The Giant inhaled and started hallucinating enemies. He swung his sword at his own shadow while the Devil watched, amused.'
    },
    'Wheel of Fortune vs Twilight Giant': {
        explanation: 'Giant LOSES (Mid). The Giant swings; he slips. The Giant charges; a landslide happens. The Monster uses luck to make the Giant\'s own strength his downfall. The Giant breaks his weapon on a "lucky" hard rock.',
        story: 'The Giant raised his sword for a killing blow. Lightning struck the sword. The Giant dropped it on his foot. "Ow!" He tried to punch. He tripped on a pebble and fell face first into a ravine. "How are you so clumsy?" the Monster asked. "I am not!" the Giant yelled, trying to climb out. A boulder fell on his head. "Unlucky," the Monster shrugged.'
    },
    'Demoness vs Red Priest': {
        explanation: 'Draw (Extreme). War vs Calamity. The Red Priest burns the plague; the Demoness freezes the fire. They are mirror pathways (masculine/feminine). They know each other\'s moves. The Priest is immune to charm; the Demoness is immune to intimidation. They destroy the world around them while flirting with death.',
        story: '"You look hot," the Demoness said, summoning ice. "You look cold," the Bishop replied, summoning fire. Steam exploded, blinding everyone. They clashed in the fog. "Die, darling," she stabbed him. "Not today, honey," he parried. They danced a tango of destruction. The city burned and froze simultaneously. They ended up exhausted, covered in blood and soot, neither willing to yield.'
    },
    'Justiciar vs Red Priest': {
        explanation: 'Red Priest LOSES (Mid). Order stops War. The Justiciar "Prohibits" aggression. The Red Priest relies on incitement and frenzy; the Justiciar enforces calm. The Justiciar strips the Priest of his army and weapons. A general without a war is just a man.',
        story: '"Charge!" "Prohibition: Running," the Justiciar said. The army stopped, tripping over each other. "Fire!" "Prohibition: Combustion." The fireballs fizzled. The Bishop stood there, impotent. "You are no fun." "I am the Law," the Justiciar said, cuffing him. "And you are disturbing the peace."'
    },
    'Black Emperor vs Red Priest': {
        explanation: 'Draw (Extreme). Chaos vs War. The Red Priest sets a trap; the Emperor distorts it. The Emperor grows huge; the Priest summons a fire giant. They both thrive on disorder. The battlefield becomes a nonsensical hellscape where physics and strategy go to die.',
        story: 'The Bishop planned a pincer maneuver. The Emperor distorted the map. The left flank ended up on the moon. "What did you do?" the Bishop yelled. "I improvised," the Emperor laughed. The Bishop incited the Emperor\'s shadow to rebel. The shadow attacked the Emperor. "Clever," the Emperor admitted, distorting the shadow into a puppy. They threw chaos at each other until reality broke and they had to stop.'
    },
    'Hermit vs Red Priest': {
        explanation: 'Red Priest WINS (Mid). War burns knowledge. The Priest overwhelms the Hermit with sheer aggression. The Hermit tries to cast spells; the Priest sets the air on fire, burning the oxygen needed to speak. The Priest is too fast and too violent for the scholar.',
        story: 'The Mystic opened a book. The Bishop burned the book. "That was a first edition!" "Nerd," the Bishop shouted, slashing with a fire sword. The Mystic put up a shield. The Bishop smashed it with a hammer of magma. "I have analyzed your pattern..." "Pattern is: I hit you until you stop moving." The Bishop hit him again. The Mystic stopped moving.'
    },
    'Paragon vs Red Priest': {
        explanation: 'Red Priest WINS (Mid). Fire melts steel. The Priest creates a heatwave that shuts down the mechs. He incites the machine spirits (if present) or the pilots to mutiny. A tank is just an oven for the crew inside when a Red Priest is nearby.',
        story: 'The tank rolled forward. The Bishop heated the armor to 1000 degrees. The crew bailed out, screaming. "Soft targets," the Bishop laughed. The Artisan sent drones. The Bishop created a firestorm. The drones melted. "My tech!" the Artisan cried. "Iron Age beats Space Age," the Bishop said, skewering the Artisan.'
    },
    'Mother vs Red Priest': {
        explanation: 'Red Priest LOSES (Mid). Life endures War. The Bishop burns the forest; the forest grows back instantly from the ash. The Planter heals faster than the Bishop can damage. The "Life" authority dampens the "Death" aspect of war. The Bishop runs out of stamina before the Mother runs out of life.',
        story: 'The Bishop scorched the earth. "Victory!" Green shoots emerged from the lava. "What?" The trees grew around him, immune to the heat. "I will burn you again!" "Go ahead," the Planter said, healing a burn on her arm in a second. The Bishop fought for days, burning and slashing, but the forest just swallowed him whole. He collapsed, exhausted, and became fertilizer.'
    },
    'Moon vs Red Priest': {
        explanation: 'Red Priest WINS (Mid). Fire scares beasts. The Bishop controls the flow of battle. He leads the Beast into a trap. He uses fire to suppress the Vampire\'s regeneration. The Beast fights on instinct; the Bishop fights with strategy.',
        story: 'The Werewolf charged blindly. The Bishop stepped aside and tripped him. "Dumb dog." The Bishop cast a ring of fire. The Werewolf panicked. "Sit," the Bishop commanded, using mental pressure. The Werewolf hesitated. The Bishop capitalized, driving a flaming spear through the Beast\'s heart. The fire prevented the wound from closing. The Beast howled and died.'
    },
    'Chained vs Red Priest': {
        explanation: 'Red Priest WINS (Mid). War breaks chains. The Bishop is too high-energy to be restrained. The Chained tries to silence him; the Bishop creates an explosion (sound). The Chained tries to possess; the Bishop\'s soul is a furnace of war that burns the intruder.',
        story: 'The Prisoner wrapped chains around the Bishop. The Bishop exploded. The chains shattered. "You are loud," the Prisoner complained. "I am War!" the Bishop yelled. The Prisoner turned into a Wraith to possess him. He entered the Bishop\'s body and found a mental battlefield. He was stabbed by the mental projection of a thousand soldiers. He fled back to his body, traumatized. The Bishop finished him with a decapitation.'
    },
    'Abyss vs Red Priest': {
        explanation: 'Draw (Extreme). Hell on Earth. The Bishop brings War; the Devil brings Foulness. They transform the battlefield into a volcanic wasteland. Fire meets Magma. They are both immune to the environment. They wrestle in the lava until they get bored.',
        story: '"Nice lava," the Bishop said, swimming in it. "Thanks, I made it," the Devil replied. They splashed each other with molten rock. "Die!" The Bishop stabbed the Devil. "Tickles," the Devil laughed, stabbing him back. "We should start a band," the Bishop suggested. "Heavy Metal," the Devil agreed.'
    },
    'Wheel of Fortune vs Red Priest': {
        explanation: 'Draw (Extreme). War vs Luck. The Bishop plans a strategy; Luck ruins it. The Bishop shoots; the gun jams. BUT, the Bishop creates a zone of "War" where chaos is expected. The Monster tries to flee, but the "Fog of War" confuses him. They stalemate because the Bishop can\'t hit the Monster, and the Monster can\'t kill the tanky Bishop.',
        story: 'The Bishop fired a cannon. The shell was a dud. "Really?" The Monster threw a card. It gave the Bishop a papercut. "That\'s your attack?" The Bishop summoned a meteor. It hit the wrong army. "Oops," the Monster giggled. The Bishop chased the Monster, tripping over roots, while the Monster dodged explosions by accident. It was a slapstick war movie.'
    },

    // === BATCH 11: DEMONESS, JUSTICIAR, BLACK EMPEROR, HERMIT VS REMAINING ===
    'Justiciar vs Demoness': {
        explanation: 'Demoness LOSES (High). Law punishes Vice. The Justiciar "Prohibits" lust and disease. The Demoness\'s charm is illegal. Her plague is quarantined. The Justiciar is the ultimate buzzkill for the Demoness. She has no weapon that works against the Arbiter.',
        story: '"Seduction," she whispered. "Prohibition: Immorality," he stamped. She felt her charm vanish. She felt like a regular woman. "Plague!" "Prohibition: Biological Warfare." The virus died. "You are no fun," she pouted. "I am Justice," he said, handcuffing her. "And you are going away for a long time."'
    },
    'Black Emperor vs Demoness': {
        explanation: 'Draw (Extreme). Chaos vs Calamity. The Black Emperor distorts the plague; the Demoness spreads it anyway. She charms the Emperor; he distorts his own feelings. They are both agents of disorder. They likely end up destroying the city and leaving together.',
        story: '"I love you," she said. "I distort love to hate," he replied, punching her. "Ow! I hate you!" "I distort hate to love," he kissed her. "You are confusing," she said, releasing black flames. He distorted the flames into flowers. "Marry me?" he asked. "Only if we can burn the world," she agreed.'
    },
    'Hermit vs Demoness': {
        explanation: 'Demoness WINS (Mid). Charm beats Nerd. The Hermit looks at her; he gets charmed. He tries to analyze the plague; he gets infected. The Demoness is a physical and magical threat. She closes the distance while he is distracted by her "assets."',
        story: '"Analysis of target..." the Mystic started. She dropped her robe. "Analysis... error..." the Mystic blushed. She stepped closer. "Do you like what you see?" "Yes... I mean, no! Shield!" She walked through the shield (which was weakened by his lack of focus) and kissed him. "Poisoned," she whispered. The Mystic collapsed, foaming at the mouth. "Worth it," he gasped.'
    },
    'Paragon vs Demoness': {
        explanation: 'Demoness WINS (Mid). Corruption beats Machine. She corrupts the pilot. She corrupts the AI. Her threads slice through the metal joints. The Artisan inside is susceptible to charm and disease even if the mech isn\'t.',
        story: 'The mech targeted her. "Hello boys," she broadcasted on the open channel. The Artisan paused. "She\'s hot." "Warning: Psychological attack," the AI warned. "Override," the Artisan said. "Let\'s talk to her." She walked up to the mech and touched the leg. The metal turned black and brittle. "Oops," she smiled. The mech collapsed. The Artisan fell out, coughing up black blood. "Never trust a pretty face," she advised.'
    },
    'Mother vs Demoness': {
        explanation: 'Demoness LOSES (Mid). Life resists Plague. The Planter is immune to disease. She is female (usually) or controls life, resisting seduction. The Planter heals the damage the Demoness deals. The Forest restrains the Demoness.',
        story: 'The Demoness released toxins. The Planter breathed them in. "Spicy." The Planter released pollen. The Demoness sneezed. "Vines," the Planter commanded. The Demoness was wrapped up. She tried to turn to shadow, but the "Life" energy in the vines pinned her spirit. "You are a weed," the Planter said, composting her.'
    },
    'Moon vs Demoness': {
        explanation: 'Draw (Extreme). Beast vs Beauty. The Werewolf is driven by instinct; the Demoness manipulates instinct. She charms him; he hesitates. He attacks; she turns to mirror. They are both dark creatures. The fight is a bloody, lusty mess.',
        story: 'The Werewolf pinned her. "Good boy," she scratched his ears. He purred. Then he remembered he was angry and bit her. She screamed, turning into black flames. "Bad dog!" She whipped him with threads. He liked it. "This is weird," she admitted. "Woof," he agreed. They called a truce.'
    },
    'Chained vs Demoness': {
        explanation: 'Demoness WINS (Mid). She seduces the Prisoner. The Prisoner is already fighting his own desires; she amplifies them. He loses control and breaks his own code, becoming vulnerable. She spreads disease to his spirit body.',
        story: 'The Prisoner sat in silence. "Let it out," she whispered. "Give in to your desire." The Prisoner shook. "No." "Yes," she touched his cheek. The Prisoner roared, losing control. He attacked wildly. She dodged easily, as he had lost his discipline. She tripped him with a thread and infected him with a wasting disease. "Discipline is so fragile," she mocked.'
    },
    'Abyss vs Demoness': {
        explanation: 'Draw (Extreme). Corruption vs Corruption. She uses plague; he uses filth. She charms; he is a Devil who loves sin. They get along great. They probably stop fighting to open a portal to hell together.',
        story: '"You are disgusting," she said. "You are beautiful," he said. "I know." He threw sludge. She threw black ice. "We should date," the Devil proposed. "I\'m out of your league," she replied, but she didn\'t kill him. They walked off to cause an apocalypse.'
    },
    'Wheel of Fortune vs Demoness': {
        explanation: 'Draw (Extreme). Calamity vs Luck. She tries to cause a disaster; he avoids it with luck. He tries to hit her; she dodges with agility. The "Calamity" she brings is offset by his "Fortune." Nothing happens.',
        story: 'She summoned a plague meteor. It missed the city. "How?" "Wind changed," the Monster smiled. She tried to stab him. Her heel broke. "Ugh!" He tried to shoot her. The gun fell apart. "We are wasting time," she said. "Agreed," he nodded.'
    },
    'Black Emperor vs Justiciar': {
        explanation: 'Justiciar WINS (High). Order beats Disorder. The Justiciar is the natural counter. "Prohibition: Distortion." The Black Emperor loses his main gimmick. The Justiciar enforces rigid rules that stabilize the reality the Emperor tries to break.',
        story: '"I distort..." "Objection!" the Justiciar shouted. "Overruled." The distortion failed. "I bribe..." "Bribery is illegal." The Emperor shrank. "This is not fair." "Justice is blind," the Justiciar said, slamming the gavel. The Emperor was bound in chains of pure law.'
    },
    'Hermit vs Justiciar': {
        explanation: 'Justiciar WINS (Mid). Law binds Magic. "Prohibition: Spellcasting." The Mystic is silenced. "Prohibition: Mystery." The hidden knowledge is revealed. The Justiciar strips the wizard of his tools.',
        story: 'The Mystic chanted. "Prohibition: Talking." The Mystic mouthed words silently. Nothing happened. "Prohibition: Starlight." The room went dark. The Mystic stood there, powerless. "You have the right to remain silent," the Justiciar said. "Oh wait, you already are."'
    },
    'Paragon vs Justiciar': {
        explanation: 'Draw (Extreme). Order vs Logic. Both are lawful. The Justiciar respects the machine; the Paragon respects the rules. "Prohibition: Unauthorized Tech." The Paragon produces a license. "Acceptable." They follow protocol and file paperwork instead of fighting.',
        story: '"Halt," the Justiciar ordered. "Compliance," the machine replied. "Identify." "Unit 734. Permit A-12." "Permit valid. Carry on." The crowd watching the death match booed. "Bureaucracy wins again," the Justiciar announced.'
    },
    'Mother vs Justiciar': {
        explanation: 'Justiciar WINS (Mid). Law regulates Nature. "Prohibition: Overgrowth." The vines stop growing. "Prohibition: Toxins." The poison becomes water. The Justiciar imposes order on the wild chaos of the forest.',
        story: 'The forest expanded. "Zoning Violation," the Justiciar stated. He drew a line in the sand. The plants refused to cross it. The Planter tried to attack. "Assault on an Officer." The Justiciar hit her with a baton of light. She fell. "Nature must be tamed."'
    },
    'Moon vs Justiciar': {
        explanation: 'Justiciar WINS (Mid). Law restrains the Beast. "Prohibition: Violence." The Werewolf cannot attack. "Prohibition: Transformation." The Werewolf turns back into a human. The Justiciar shuts down the instinctual rage with cold hard rules.',
        story: 'The Beast howled. "Noise Ordinance Violation." The Beast choked. He tried to claw. "Restraining Order." Chains of light bound the Beast. The Justiciar walked up and tapped the Beast on the nose. "Bad dog."'
    },
    'Chained vs Justiciar': {
        explanation: 'Draw (Extreme). Jailer vs Cop. Both use bindings. The Justiciar prohibits movement; the Chained restricts movement. They stare at each other, both unable to move because they bound each other. It is the quietest fight ever.',
        story: '"You are under arrest," the Justiciar said. "You are a prisoner," the Chained replied. Chains met Handcuffs. "I can\'t move," the Justiciar said. "Me neither," the Chained said. "Call it a draw?" "Sure."'
    },
    'Abyss vs Justiciar': {
        explanation: 'Justiciar WINS (Mid). Order banishes Chaos. "Prohibition: Filth." The sludge vanishes. "Prohibition: Evil." The Devil takes damage just by existing. The Justiciar cleanses the area with the authority of the law.',
        story: 'The Devil laughed. "I will corrupt this world." "That is against the constitution," the Justiciar said. "I don\'t care about your laws!" "The laws care about you." The Justiciar cast "Exile." The Devil was deported back to the Abyss. "Paperwork complete."'
    },
    'Wheel of Fortune vs Justiciar': {
        explanation: 'Justiciar WINS (Mid). Law overrides Luck. "Prohibition: Gambling." The Monster cannot use dice. "Prohibition: Accidents." The random events stop happening. The Justiciar forces a deterministic outcome.',
        story: 'The Monster rolled a die. "Confiscated," the Justiciar took the die. The Monster tried to trip. "Prohibition: Falling." The Monster hovered in mid-air. "This is cheating!" the Monster cried. "This is Order," the Justiciar corrected, detaining the anomaly.'
    },
    'Hermit vs Black Emperor': {
        explanation: 'Black Emperor WINS (Mid). Distortion breaks Magic. The Emperor distorts the aim of the spells. He distorts the mana cost, making the Hermit exhaust himself instantly. He "Bribes" the spell to hit the caster.',
        story: '"Fireball!" "Return to sender," the Emperor distorted the vector. The fireball hit the Mystic. "Shield!" "Shield is now a target." The shield attracted more fireballs. "This logic is flawed!" the Mystic cried. "I am the Emperor," he smirked. "I define logic."'
    },
    'Paragon vs Black Emperor': {
        explanation: 'Black Emperor WINS (High). Distortion breaks Machines. He distorts the blueprints. He distorts the electrical flow. He "Bribes" the AI to switch sides. The machine falls apart as its physical constants are rewritten.',
        story: 'The mech stepped forward. The Emperor distorted the concept of "forward" to "down." The mech dug a hole and fell in. "Recalibrating..." the AI said. "Bribe: Loyalty." "Target updated: Pilot," the AI said. "No! Bad robot!" the Artisan yelled as he was ejected into the mud.'
    },
    'Mother vs Black Emperor': {
        explanation: 'Black Emperor WINS (Mid). Distortion warps Life. He distorts the growth, making trees grow into the ground. He distorts the healing to damage. The Planter\'s control over nature is subverted by the Emperor\'s control over rules.',
        story: 'The Planter healed her wound. "Healing is Injury," the Emperor distorted. The wound got worse. "What?" She summoned vines. "Vines are spaghetti." The vines turned limp and soft. "Dinner time," the Emperor laughed. The Planter fled, confused and hungry.'
    },
    'Moon vs Black Emperor': {
        explanation: 'Black Emperor WINS (Mid). Distortion confuses the Beast. The Beast lunges; the Emperor distorts the distance. The Beast bites; the Emperor distorts the hardness of his skin to diamond. The Beast cannot comprehend the shifting reality.',
        story: 'The Werewolf attacked. The Emperor stood on the ceiling. "Missed." The Werewolf jumped up. The ceiling became the floor. The Werewolf fell. "Stop playing tricks!" "Bribe: Pacifism." The Werewolf suddenly wanted to knit. He sat down and looked for wool. The Emperor patted his head.'
    },
    'Chained vs Black Emperor': {
        explanation: 'Black Emperor WINS (Mid). Distortion breaks Chains. The Emperor distorts the binding tension. He distorts the possession attempt, sending the Wraith into a wall. The Chained cannot restrain someone who rewrites the rules of restraint.',
        story: 'The Prisoner bound the Emperor. "Chains are balloons," the Emperor declared. The chains floated away. The Prisoner screamed a curse. "Sound is silent." Nothing happened. The Emperor distorted the Prisoner\'s "Control" to "Madness." The Prisoner lost his mind completely and attacked a lamppost.'
    },
    'Abyss vs Black Emperor': {
        explanation: 'Draw (Extreme). Chaos vs Chaos. The Emperor distorts the corruption; the Devil corrupts the distortion. They create a singularity of nonsense. It ends with both of them having a headache.',
        story: '"I corrupt you," the Devil said. "I distort the corruption to candy," the Emperor said. "I corrupt the candy to poison." "I distort the poison to wine." They stood there drinking wine. "Not bad," the Devil admitted. "A vintage chaos," the Emperor agreed.'
    },
    'Wheel of Fortune vs Black Emperor': {
        explanation: 'Draw (Extreme). Distortion vs Luck. The Emperor distorts the odds; the Monster resets them. The Emperor makes a hit inevitable; the Monster makes it a miss. They are both manipulating the fabric of causality. Nothing sticks.',
        story: '"I distort your luck to zero." "Reboot." Luck is back to 100. "I distort the reboot." "Misfortune!" The Emperor slipped. "I distort the slip to a dance move." The Emperor cha-cha\'d. "You dance well," the Monster said. "Thank you."'
    },
    'Paragon vs Hermit': {
        explanation: 'Draw (Extreme). Magic vs Tech. The Hermit hacks the machine with "Information" spells. The Paragon blocks the magic with "Anti-Magic" fields. They analyze each other perfectly. It\'s a battle of calculations.',
        story: '"Shield frequency 40Hz," the Mystic noted. "Adjusting spell." "Magic missile detected," the AI said. "Deploying flares." The missiles hit the flares. "You are efficient," the Mystic said. "You are logical," the Artisan said. They exchanged blueprints and spell scrolls, deciding research was more profitable than war.'
    },
    'Mother vs Hermit': {
        explanation: 'Hermit LOSES (Mid). Nature resists Magic. The Hermit casts a spell; the trees absorb the mana. The Mother heals faster than the Hermit can deal damage. The Hermit is squishy; the Mother is a tank with reach. The forest overwhelms the tower.',
        story: 'The Mystic cast lightning. The tree took the hit and grounded it. "Grounding... clever." Vines grabbed the Mystic\'s ankle. "Teleport!" Spores filled the air. The Mystic inhaled. "Toxin detected." He tried to cast a cure, but flowers grew out of his mouth. "Mmph!" He was dragged into the undergrowth.'
    },
    'Moon vs Hermit': {
        explanation: 'Hermit LOSES (Mid). Beast rushes Mage. The Hermit needs time to cast; the Werewolf is instant. The Hermit tries to predict; the Beast is erratic. The Beast closes the distance and shreds the scholar.',
        story: '"By the eye of..." SLASH. The Mystic\'s shield broke. "Too fast!" The Werewolf bit his arm. "Get off!" The Mystic hit him with a scroll. The Werewolf ate the scroll. Then he ate the Mystic.'
    },
    'Chained vs Hermit': {
        explanation: 'Hermit LOSES (Mid). Silence kills Mages. The Prisoner silences the area. The Mystic cannot chant. The Prisoner possesses the Mystic. The Mystic\'s mind is full of secrets, which the Prisoner uses to drive him mad.',
        story: '"I cast..." Silence. The Mystic moved his lips. No sound. "Silent casting?" He tried to focus. Chains wrapped around his neck. The Prisoner appeared behind him. "Shhh," the Prisoner whispered. The Mystic passed out from lack of air.'
    },
    'Abyss vs Hermit': {
        explanation: 'Hermit LOSES (High). Madness breaks Knowledge. The Mystic looks at the Devil and goes insane. The "Hidden Sage" whispers combine with the Abyss\'s corruption to fry the Mystic\'s brain. He defeats himself.',
        story: '"Analysis..." The Mystic looked at the Devil. DATA OVERLOAD. ERROR. CORRUPTION. The Mystic screamed, clawing at his eyes. "I didn\'t even do anything yet," the Devil said, confused. The Mystic curled into a ball, babbling about the end of the world.'
    },
    'Wheel of Fortune vs Hermit': {
        explanation: 'Hermit LOSES (Mid). Luck beats Plan. The Mystic calculates the perfect spell. A gust of wind blows his aim off. The Mystic casts a ritual. He trips and breaks the chalk circle. Probability hates wizards.',
        story: '"The stars align," the Mystic said. A cloud covered the star. "Seriously?" He threw a potion. It bounced off a wall and hit him. "Calculated trajectory was perfect!" "Luck is a variable you forgot," the Monster laughed, throwing a pebble that somehow knocked the Mystic unconscious.'
    },

    // === BATCH 12: PARAGON, MOTHER, MOON, CHAINED, ABYSS VS REMAINING ===
    'Mother vs Paragon': {
        explanation: 'Paragon LOSES (Mid). Nature reclaims the machine. The Planter accelerates the oxidation of metals. Roots burst through the chassis of mechs. The Artisan\'s reliance on "dead" materials is countered by the Planter\'s "living" control. The forest grows faster than the Artisan can deforest it.',
        story: 'The mech stepped into the jungle. "Defoliant sprayed," the AI reported. The plants died, then immediately regrew, wrapping around the mech\'s legs. "Hydraulics jammed. Organic material detected in gears." The Artisan tried to fire the flamethrower. Vines grew into the nozzle, clogging it. "Ejecting!" The Artisan landed in a bed of flowers. The flowers released sleeping pollen. "Nature 1, Tech 0," the Planter whispered.'
    },
    'Moon vs Paragon': {
        explanation: 'Paragon WINS (Mid). Tech hunts the Beast. The Artisan builds silver-plated weapons and UV emitters that mimic sunlight. The Beast is targeted by auto-locking turrets that don\'t feel fear. The Artisan stays safe in a fortress while drones wear the Vampire down.',
        story: 'The Werewolf charged the bunker. "Target speed: Fast. Turret traversal speed: Faster," the Artisan muttered. A laser grid activated, slicing the air. The Werewolf was forced to dodge, slowing down. "Deploying UV Flashbangs." The bunker lit up like a supernova. The Werewolf screamed, blinded and burning. "Finish it." A railgun slug obliterated the beast. "Science domesticates the wild."'
    },
    'Chained vs Paragon': {
        explanation: 'Paragon WINS (Mid). Tools break Chains. The Artisan creates a "Sonic Disruptor" to destabilize the Wraith form. He builds a cage of pure light that prevents shadow travel. The Chained cannot possess a machine that has no soul, and the pilot is shielded by psychic dampeners.',
        story: 'The Prisoner tried to possess the mech. "Psy-Shield active," the AI stated. The Prisoner bounced off the hull. "Analysis: Spirit Entity," the Artisan typed. "Countermeasure: Ecto-containment field." A vacuum trap opened. The Prisoner was sucked in. "Let me out!" "You are now a battery," the Artisan said, routing the spirit energy to power the coffee maker.'
    },
    'Abyss vs Paragon': {
        explanation: 'Paragon LOSES (Mid). Corruption ruins Tech. The Devil spews filth that eats through alloys instantly. The "Danger Intuition" allows the Devil to dodge aimed shots. The madness of the Abyss corrupts the AI logic, causing the machines to turn on their creator.',
        story: 'The Artisan fired a missile. The Devil laughed. The missile turned into a snake and flew back. "Logic error!" the AI screamed. The Devil touched the mech. The metal began to bleed. "My machine is in pain?" the Artisan asked, horrified. "Everything suffers," the Devil said, tearing the cockpit open. The Artisan looked at the corrupted HUD, which was now displaying insults instead of data.'
    },
    'Wheel of Fortune vs Paragon': {
        explanation: 'Paragon WINS (Mid). Systems reduce Variables. The Artisan uses "Probability Stabilizers" (logic) to ensure weapons fire correctly. Aim-assist overcomes the Monster\'s dodge luck. The sheer volume of fire (saturation bombing) leaves no "lucky" spot to stand.',
        story: 'The Monster stood still, trusting his luck. "Saturation bombardment," the Artisan ordered. Missiles covered every square inch of the grid. "That\'s cheating!" the Monster ran. He slipped on oil. "Friction coefficient reduced," the Artisan noted. The Monster slid into a wall. A drone hovered over him. "Game over," the Artisan said. "Math doesn\'t care about your rabbit\'s foot."'
    },
    'Moon vs Mother': {
        explanation: 'Mother WINS (Mid). Nature controls the Beast. The Planter releases pheromones that pacify the Werewolf. She grows "Wolfsbane" instantly. The Vampire\'s regeneration is outmatched by the Planter\'s ability to drain life. The forest consumes the wolf.',
        story: 'The Werewolf howled. The Planter blew a handful of dust. "Sleep." The Werewolf felt drowsy. "I am... hunter..." "You are fertilizer," she corrected. Vines wrapped the sleepy beast. Thorns injected a paralytic toxin. The Werewolf napped while the moss slowly grew over him, claiming him for the earth.'
    },
    'Chained vs Mother': {
        explanation: 'Mother WINS (Mid). Growth breaks Bindings. The Prisoner binds the Planter; she transfers her consciousness to a tree. He tries to silence her; the forest screams for her. Life force overwhelms the curse of restraint. She out-heals the damage.',
        story: 'Chains bound the Planter. She burst into a swarm of fireflies and reformed elsewhere. "You cannot bind life," she said. The Prisoner turned to a Wraith. "Spirit trap," she whispered. A pitcher plant opened, emitting a soul-attracting scent. The Wraith drifted in, confused. The lid snapped shut. Digestion began.'
    },
    'Abyss vs Mother': {
        explanation: 'Mother LOSES (Mid). Corruption kills Life. The Devil corrupts the forest. The trees turn into monsters that attack the Planter. The "Filth" creates a dead zone where nothing can grow. The Planter\'s healing cannot purge the deep corruption of the Abyss.',
        story: 'The Planter summoned a grove. The Devil bled on the ground. The trees turned black and screamed. "My babies!" the Planter cried. The corrupted trees lashed out at her. "They like me better," the Devil grinned. She tried to heal them, but the corruption traveled up her arm. She had to cut it off. The forest was dead, and she was next.'
    },
    'Wheel of Fortune vs Mother': {
        explanation: 'Mother WINS (Mid). Life is Abundant. The Monster relies on luck to dodge attacks. The Planter fills the air with spores. You cannot dodge air. The Monster inhales the spores, and mushrooms begin to grow in his lungs. Luck cannot stop biology.',
        story: 'The Monster dodged a vine. "Missed!" He dodged a root. "Missed!" The Planter smiled. "Breathe." The Monster inhaled deep. He coughed. "I feel funny." "You are blooming," she said. A flower sprouted from his ear. He fell to his knees, wheezing. "Unlucky allergy," he gasped.'
    },
    'Chained vs Moon': {
        explanation: 'Moon LOSES (Mid). Restraint stops the Beast. The Prisoner binds the Werewolf. The Werewolf relies on movement and physical power; the chains negate both. The Prisoner possesses the beast and forces it to claw its own eyes out. The Beast has no mental defense.',
        story: 'The Werewolf lunged. Chains caught him mid-air. "Let me go!" "Quiet," the Prisoner silenced him. The Prisoner entered the beast\'s mind. It was a simple mind, full of rage. Easy to drive. The Werewolf stopped struggling. He walked over to a cliff. "Good dog," the Prisoner thought, walking the body off the edge.'
    },
    'Abyss vs Moon': {
        explanation: 'Moon LOSES (Mid). Corruption rots the Beast. The Werewolf bites the Devil; his mouth melts. The Devil uses "Danger Intuition" to dodge the claws. The Moon Beyonder\'s regeneration fails against the foulness of the Abyss.',
        story: 'The Vampire bit the Devil\'s neck. "Spicy blood," the Vampire gagged, spitting acid. "You are poisoned," the Devil laughed. The Vampire tried to heal, but the wound turned green and spread. "Make it stop!" "It stops when you die," the Devil said, watching the beast rot alive.'
    },
    'Wheel of Fortune vs Moon': {
        explanation: 'Draw (Extreme). Instinct vs Luck. The Beast attacks; the Monster trips and dodges. The Beast smells him; a skunk sprays the area, masking the scent. The Beast tries to regenerate; a "lucky" piece of silver shrapnel stays in the wound. They chase each other in circles.',
        story: 'The Werewolf chased the Monster. The Monster ran into a dead end. "Dinner time!" The wall collapsed on the Werewolf. "Structural failure!" the Monster yelled, running away. The Werewolf dug himself out. He found the Monster again. He slipped on a banana peel. "Who leaves a banana here?" the Werewolf howled. "Fate!" the Monster shouted.'
    },
    'Abyss vs Chained': {
        explanation: 'Chained LOSES (Mid). Corruption escapes the Cell. The Prisoner binds the Devil; the Devil turns into sludge and oozes out. The Prisoner tries to possess the Devil; the Devil\'s mind is pure chaos that destroys the intruder. The Abyss is too slippery and too toxic to be contained.',
        story: 'The Prisoner wrapped the Devil in shadows. The shadows caught fire. "Hot!" The Prisoner tried to scream, but inhaled toxic fumes. "Possession attempt," the Prisoner dove into the Devil. He saw a landscape of hell. He burned. He fled back to his body, smoking. "Never go in there," he wheezed. The Devil ate him.'
    },
    'Wheel of Fortune vs Chained': {
        explanation: 'Chained LOSES (Mid). Luck breaks Chains. The Prisoner tries to bind the Monster; the chain has a weak link and snaps. The Prisoner tries to possess; the Monster sneezes, expelling the spirit. The Prisoner\'s curses backfire due to bad luck.',
        story: 'The Prisoner cast a curse. A mirror fell from the sky, reflecting the curse back at him. "Ouch." He tried to bind the Monster. The chains got tangled in a knot. "Let me help," the Monster pulled a thread. The knot tightened around the Prisoner. "I am binding myself?" the Prisoner asked, confused. "It happens," the Monster shrugged.'
    },
    'Wheel of Fortune vs Abyss': {
        explanation: 'Abyss WINS (Mid). Madness ignores Luck. The Devil releases a cloud of corruption. Luck cannot dodge a cloud. The Monster gets infected. The Devil\'s "Danger Intuition" negates the Monster\'s "Critical Hits." The Devil corrupts the environment, removing "lucky" escape routes.',
        story: 'The Monster found a lucky penny. The penny turned into a poisonous spider and bit him. "That\'s not lucky!" "I corrupted the luck," the Devil grinned. The Monster tried to reboot. The Devil screamed a foul word that shattered the Monster\'s concentration. "No resets in Hell," the Devil said, dragging him into the magma. "Only fire."'
    }
        };

        // Matchup data
        const MATCHUPS = {
            'Fool': {
                'Door': { outcome: 'DRAW', diff: 'Variable', reason: 'Same Sefirah (Contingency/Interference Trigger)' },
                'Error': { outcome: 'DRAW', diff: 'Variable', reason: 'Same Sefirah (Contingency/Interference Trigger)' },
                'Visionary': { outcome: 'DRAW', diff: 'Extreme', reason: 'History vs Script; neither finishes cleanly' },
                'White Tower': { outcome: 'WIN', diff: 'High', reason: 'Miracles break clean prediction/analysis' },
                'Sun': { outcome: 'WIN', diff: 'High', reason: 'Sun clears fog, but can\'t pin history fully' },
                'Tyrant': { outcome: 'WIN', diff: 'Mid', reason: 'Grafting/avoidance works, but AOE pressures setup' },
                'Hanged Man': { outcome: 'DRAW', diff: 'Extreme', reason: 'Corruption pressure vs historical escape' },
                'Darkness': { outcome: 'WIN', diff: 'High', reason: 'Divination/puppets mitigate concealment over time' },
                'Death': { outcome: 'WIN', diff: 'High', reason: 'Spirit state tricks, but finishing is hard' },
                'Twilight Giant': { outcome: 'WIN', diff: 'Mid', reason: 'Physical damage is inefficient vs history tricks' },
                'Red Priest': { outcome: 'WIN', diff: 'Mid', reason: 'War forces commitment, but Fool dodges the battlefield' },
                'Demoness': { outcome: 'WIN', diff: 'Mid', reason: 'Puppets resist seduction; still must respect calamity' },
                'Justiciar': { outcome: 'WIN', diff: 'High', reason: 'Miracles act as exceptions; law is oppressive but not absolute' },
                'Black Emperor': { outcome: 'WIN', diff: 'High', reason: 'Distortion is strong; Fool misdirects targets and intent' },
                'Hermit': { outcome: 'WIN', diff: 'Mid', reason: 'Magic is flexible; Fool wins by misdirection and tempo' },
                'Paragon': { outcome: 'WIN', diff: 'Mid', reason: 'Denial zones exist, but grafting breaks rigid setups' },
                'Mother': { outcome: 'WIN', diff: 'Mid', reason: 'Life authority is durable; Fool wins by bypass and control' },
                'Moon': { outcome: 'WIN', diff: 'Mid', reason: 'Regen is real; puppetry and grafting deny clean brawls' },
                'Chained': { outcome: 'WIN', diff: 'Mid', reason: 'Restraint is nasty; Fool avoids direct capture via history tricks' },
                'Abyss': { outcome: 'WIN', diff: 'Mid', reason: 'Corruption pressure exists; Fool wins by bait/loop tactics' },
                'Wheel of Fortune': { outcome: 'WIN', diff: 'High', reason: 'Luck prolongs fights; Fool still has higher-level reset tools' }
            },
            'Door': {
                'Fool': { outcome: 'DRAW', diff: 'Variable', reason: 'Same Sefirah (Contingency/Interference Trigger)' },
                'Error': { outcome: 'DRAW', diff: 'Variable', reason: 'Same Sefirah (Contingency/Interference Trigger)' },
                'Visionary': { outcome: 'LOSS', diff: 'High', reason: 'Narrative traps bypass pure mobility' },
                'White Tower': { outcome: 'DRAW', diff: 'Extreme', reason: 'Teleport tempo vs analysis time; hard to finish' },
                'Sun': { outcome: 'WIN', diff: 'Mid', reason: 'Space bending denies straight-line light dominance' },
                'Tyrant': { outcome: 'WIN', diff: 'Mid', reason: 'Leaves the storm; avoids forced close-range' },
                'Hanged Man': { outcome: 'WIN', diff: 'High', reason: 'Escape denies grazing setups; finish is still hard' },
                'Darkness': { outcome: 'DRAW', diff: 'Extreme', reason: 'Concealment vs relocation; both deny targeting' },
                'Death': { outcome: 'WIN', diff: 'High', reason: 'Exile/escape beats spirit pressure, but closure is costly' },
                'Twilight Giant': { outcome: 'WIN', diff: 'Mid', reason: 'Cannot reliably reach a space-admin target' },
                'Red Priest': { outcome: 'WIN', diff: 'Mid', reason: 'Redirects large AOE; denies engagement choice' },
                'Demoness': { outcome: 'WIN', diff: 'High', reason: 'Exiles plague zones; still must avoid layered calamity' },
                'Justiciar': { outcome: 'LOSS', diff: 'High', reason: 'Space travel can be grounded by formal prohibition' },
                'Black Emperor': { outcome: 'WIN', diff: 'High', reason: 'Sealing/partition can limit distortion options' },
                'Hermit': { outcome: 'WIN', diff: 'High', reason: 'Mobility wins, but magic can still tag you at range' },
                'Paragon': { outcome: 'WIN', diff: 'Mid', reason: 'Alters spatial constants; ruins stable machinery zones' },
                'Mother': { outcome: 'WIN', diff: 'Mid', reason: 'Exile terrain/roots; deny growth anchor points' },
                'Moon': { outcome: 'WIN', diff: 'Mid', reason: 'Denies close-range predation; kite and relocate' },
                'Chained': { outcome: 'WIN', diff: 'Mid', reason: 'Imprisonment fails if you can leave the coordinate' },
                'Abyss': { outcome: 'WIN', diff: 'Mid', reason: 'Corruption implies contact; Door avoids contact' },
                'Wheel of Fortune': { outcome: 'DRAW', diff: 'Extreme', reason: 'Misjumps vs relocation; loop war without easy finish' }
            },
            'Error': {
                'Fool': { outcome: 'DRAW', diff: 'Variable', reason: 'Same Sefirah (Contingency/Interference Trigger)' },
                'Door': { outcome: 'DRAW', diff: 'Variable', reason: 'Same Sefirah (Contingency/Interference Trigger)' },
                'Visionary': { outcome: 'LOSS', diff: 'High', reason: 'Mental traps/false thoughts can break theft timing' },
                'White Tower': { outcome: 'WIN', diff: 'High', reason: 'Steals key steps in analysis; turns math against itself' },
                'Sun': { outcome: 'WIN', diff: 'High', reason: 'Steals light output/timing; denies clean purify finish' },
                'Tyrant': { outcome: 'WIN', diff: 'High', reason: 'Steals strike timing; bugs catastrophic setups' },
                'Hanged Man': { outcome: 'WIN', diff: 'High', reason: 'Steals grazing windows; denies stable corruption buildup' },
                'Darkness': { outcome: 'WIN', diff: 'High', reason: 'Steals concealment anchors; forces reveal at bad moments' },
                'Death': { outcome: 'WIN', diff: 'High', reason: 'Steals state-control leverage; interrupts spirit transitions' },
                'Twilight Giant': { outcome: 'WIN', diff: 'High', reason: 'Steals defense/weapon timing; warrior loses consistency' },
                'Red Priest': { outcome: 'WIN', diff: 'Mid', reason: 'Steals fire/initiative; war loses tempo' },
                'Demoness': { outcome: 'WIN', diff: 'High', reason: 'Steals charm/youth vectors; breaks layered calamity' },
                'Justiciar': { outcome: 'WIN', diff: 'High', reason: 'Steals the rule/authority; flips prohibitions' },
                'Black Emperor': { outcome: 'WIN', diff: 'High', reason: 'Bugs out distortion; exploits loopholes faster' },
                'Hermit': { outcome: 'WIN', diff: 'High', reason: 'Interrupts rituals; steals spell conditions' },
                'Paragon': { outcome: 'WIN', diff: 'High', reason: 'Software bugs and power theft ruin systems' },
                'Mother': { outcome: 'WIN', diff: 'High', reason: 'Steals growth triggers; breaks regeneration cycles' },
                'Moon': { outcome: 'WIN', diff: 'High', reason: 'Steals blood regen timing; forces lethal openings' },
                'Chained': { outcome: 'WIN', diff: 'High', reason: 'Steals constraint key; breaks imprisonment logic' },
                'Abyss': { outcome: 'WIN', diff: 'High', reason: 'Steals malice/contact windows; corrupt kit destabilizes' },
                'Wheel of Fortune': { outcome: 'WIN', diff: 'High', reason: 'If luck is stolen, reboot loops collapse' }
            },
            'Visionary': {
                'Fool': { outcome: 'DRAW', diff: 'Extreme', reason: 'Script vs History; neither deletes the other cleanly' },
                'Door': { outcome: 'WIN', diff: 'High', reason: 'Writes a sealed narrative trap; mobility loses direction' },
                'Error': { outcome: 'WIN', diff: 'High', reason: 'Feeds fake thoughts; punishes theft windows' },
                'White Tower': { outcome: 'DRAW', diff: 'Variable', reason: 'Same Sefirah (Contingency/Interference Trigger)' },
                'Sun': { outcome: 'DRAW', diff: 'Variable', reason: 'Same Sefirah (Contingency/Interference Trigger)' },
                'Tyrant': { outcome: 'DRAW', diff: 'Variable', reason: 'Same Sefirah (Contingency/Interference Trigger)' },
                'Hanged Man': { outcome: 'DRAW', diff: 'Variable', reason: 'Same Sefirah (Contingency/Interference Trigger)' },
                'Darkness': { outcome: 'WIN', diff: 'High', reason: 'Envisions through concealment; denies hiding wincon' },
                'Death': { outcome: 'WIN', diff: 'High', reason: 'Rewrites intent/morale; disrupts state-control planning' },
                'Twilight Giant': { outcome: 'WIN', diff: 'High', reason: 'Low mental resistance; forced misplays' },
                'Red Priest': { outcome: 'WIN', diff: 'High', reason: 'War depends on morale/coordination; rewrites loyalty' },
                'Demoness': { outcome: 'WIN', diff: 'Mid', reason: 'Calamity still matters; Visionary controls desire/intent' },
                'Justiciar': { outcome: 'WIN', diff: 'Mid', reason: 'Changes the judge\'s intent; bends verdict selection' },
                'Black Emperor': { outcome: 'WIN', diff: 'High', reason: 'Distortion relies on intent; intent is rewritten' },
                'Hermit': { outcome: 'WIN', diff: 'High', reason: 'Overloads secret-knowledge channels; breaks casting focus' },
                'Paragon': { outcome: 'WIN', diff: 'High', reason: 'Attacks coordination/decision loops; ruins system control' },
                'Mother': { outcome: 'WIN', diff: 'High', reason: 'Manipulates instincts/collective life drive; denies stable growth' },
                'Moon': { outcome: 'WIN', diff: 'High', reason: 'Controls predation impulse; forces self-sabotage' },
                'Chained': { outcome: 'WIN', diff: 'High', reason: 'Attacks sanity/intent; restraint becomes self-cage' },
                'Abyss': { outcome: 'WIN', diff: 'High', reason: 'Placates bloodlust; turns aggression inward' },
                'Wheel of Fortune': { outcome: 'WIN', diff: 'High', reason: 'Writes the "future" baseline; luck can\'t find a good branch' }
            },
            'White Tower': {
                'Fool': { outcome: 'LOSS', diff: 'High', reason: 'Miracles break deterministic prediction' },
                'Door': { outcome: 'DRAW', diff: 'Extreme', reason: 'Too mobile to punish; analysis needs clean closure' },
                'Error': { outcome: 'LOSS', diff: 'High', reason: 'Inserts bugs into calculations; steals key steps' },
                'Visionary': { outcome: 'DRAW', diff: 'Variable', reason: 'Same Sefirah (Contingency/Interference Trigger)' },
                'Sun': { outcome: 'DRAW', diff: 'Variable', reason: 'Same Sefirah (Contingency/Interference Trigger)' },
                'Tyrant': { outcome: 'DRAW', diff: 'Variable', reason: 'Same Sefirah (Contingency/Interference Trigger)' },
                'Hanged Man': { outcome: 'DRAW', diff: 'Variable', reason: 'Same Sefirah (Contingency/Interference Trigger)' },
                'Darkness': { outcome: 'LOSS', diff: 'High', reason: 'No information = no clean analysis' },
                'Death': { outcome: 'DRAW', diff: 'Extreme', reason: 'Spirit-state fights resist clean modeling' },
                'Twilight Giant': { outcome: 'WIN', diff: 'Mid', reason: 'Kiting + weak point exploitation; classic control win' },
                'Red Priest': { outcome: 'DRAW', diff: 'Extreme', reason: 'War pressure denies time; Tower denies plan secrecy' },
                'Demoness': { outcome: 'WIN', diff: 'High', reason: 'Rapid counter-formulas reduce calamity stacking' },
                'Justiciar': { outcome: 'DRAW', diff: 'Extreme', reason: 'Bureaucracy vs logic; neither easily closes' },
                'Black Emperor': { outcome: 'WIN', diff: 'High', reason: 'Finds the loophole; closes distortion windows' },
                'Hermit': { outcome: 'WIN', diff: 'High', reason: 'Counter-spells through comprehension; still needs time' },
                'Paragon': { outcome: 'WIN', diff: 'High', reason: 'Understands systems better; hacks/overrides tech logic' },
                'Mother': { outcome: 'WIN', diff: 'High', reason: 'Bio-analysis targets growth weak points; attrition win' },
                'Moon': { outcome: 'WIN', diff: 'High', reason: 'Predicts predation vectors; denies regen timing' },
                'Chained': { outcome: 'WIN', diff: 'High', reason: 'Solves curse/binding logic; unravels restraint patterns' },
                'Abyss': { outcome: 'WIN', diff: 'High', reason: 'Models corruption triggers; traps the contact windows' },
                'Wheel of Fortune': { outcome: 'WIN', diff: 'High', reason: 'Probability is math; still a long finish' }
            },
            'Sun': {
                'Fool': { outcome: 'LOSS', diff: 'High', reason: 'Light clears fog; history can still avoid closure' },
                'Door': { outcome: 'LOSS', diff: 'Mid', reason: 'Space bending denies straight-line dominance' },
                'Error': { outcome: 'LOSS', diff: 'High', reason: 'Steals light/timing; interrupts purification cadence' },
                'Visionary': { outcome: 'DRAW', diff: 'Variable', reason: 'Same Sefirah (Contingency/Interference Trigger)' },
                'White Tower': { outcome: 'DRAW', diff: 'Variable', reason: 'Same Sefirah (Contingency/Interference Trigger)' },
                'Tyrant': { outcome: 'DRAW', diff: 'Variable', reason: 'Same Sefirah (Contingency/Interference Trigger)' },
                'Hanged Man': { outcome: 'DRAW', diff: 'Variable', reason: 'Same Sefirah (Contingency/Interference Trigger)' },
                'Darkness': { outcome: 'DRAW', diff: 'Extreme', reason: 'Reveal/purify eventually forces contact; costly finish' },
                'Death': { outcome: 'WIN', diff: 'Mid', reason: 'Purification counters undead/spirit buildup' },
                'Twilight Giant': { outcome: 'WIN', diff: 'High', reason: 'Burns/weakens decay over time; tanky opponent' },
                'Red Priest': { outcome: 'DRAW', diff: 'Extreme', reason: 'Fire authority clash; holiness vs war pressure' },
                'Demoness': { outcome: 'WIN', diff: 'High', reason: 'Purifies plague/calamity buildup; denies stealth' },
                'Justiciar': { outcome: 'DRAW', diff: 'Extreme', reason: 'Law can dim output; Sun outscales with effort' },
                'Black Emperor': { outcome: 'WIN', diff: 'High', reason: 'Light denies hiding distortion; forces honest engagement' },
                'Hermit': { outcome: 'WIN', diff: 'High', reason: 'Reveal denies "hidden" casting safety; forces direct trades' },
                'Paragon': { outcome: 'DRAW', diff: 'Extreme', reason: 'Tech can redirect/mitigate; Sun still pressures continuously' },
                'Mother': { outcome: 'WIN', diff: 'Mid', reason: 'Drought/scorch pressures growth anchors' },
                'Moon': { outcome: 'WIN', diff: 'High', reason: 'Natural predator matchup; denies blood regen' },
                'Chained': { outcome: 'WIN', diff: 'Mid', reason: 'Purification suppresses curses/restraint buildup' },
                'Abyss': { outcome: 'WIN', diff: 'Mid', reason: 'Purification suppresses corruption/contact threats' },
                'Wheel of Fortune': { outcome: 'WIN', diff: 'High', reason: 'Luck prolongs, but Sun\'s pressure narrows branches' }
            },
            'Tyrant': {
                'Fool': { outcome: 'LOSS', diff: 'Mid', reason: 'History avoids the storm; hard to pin down' },
                'Door': { outcome: 'LOSS', diff: 'Mid', reason: 'Leaves the domain; storms are local' },
                'Error': { outcome: 'LOSS', diff: 'High', reason: 'Timing theft/bugs disrupt catastrophic sequencing' },
                'Visionary': { outcome: 'DRAW', diff: 'Variable', reason: 'Same Sefirah (Contingency/Interference Trigger)' },
                'White Tower': { outcome: 'DRAW', diff: 'Variable', reason: 'Same Sefirah (Contingency/Interference Trigger)' },
                'Sun': { outcome: 'DRAW', diff: 'Variable', reason: 'Same Sefirah (Contingency/Interference Trigger)' },
                'Hanged Man': { outcome: 'DRAW', diff: 'Variable', reason: 'Same Sefirah (Contingency/Interference Trigger)' },
                'Darkness': { outcome: 'LOSS', diff: 'High', reason: 'Concealment denies targeting; ambush flips tempo' },
                'Death': { outcome: 'WIN', diff: 'High', reason: 'Exorcism-like lightning pressure; but finish is hard' },
                'Twilight Giant': { outcome: 'DRAW', diff: 'Extreme', reason: 'Tank forces close-range; storm struggles to finish' },
                'Red Priest': { outcome: 'DRAW', diff: 'Extreme', reason: 'Catastrophe vs War; neither closes cleanly' },
                'Demoness': { outcome: 'WIN', diff: 'High', reason: 'Wind/lightning disrupt miasma; still respect layering' },
                'Justiciar': { outcome: 'LOSS', diff: 'High', reason: '"Flight/large-scale destruction" restrictions can bite' },
                'Black Emperor': { outcome: 'WIN', diff: 'High', reason: 'Sheer force can overwhelm distortion windows' },
                'Hermit': { outcome: 'WIN', diff: 'High', reason: 'Storm interrupts casting; must finish before tricks land' },
                'Paragon': { outcome: 'WIN', diff: 'Mid', reason: 'EMP/lightning ruins systems; denies setup' },
                'Mother': { outcome: 'LOSS', diff: 'High', reason: 'Earth/nature absorbs; roots anchor against storms' },
                'Moon': { outcome: 'WIN', diff: 'High', reason: 'Burst pressure overwhelms regen windows' },
                'Chained': { outcome: 'WIN', diff: 'High', reason: 'Domain AOE denies stealth binding; finish still costly' },
                'Abyss': { outcome: 'WIN', diff: 'High', reason: 'Lightning pressure limits corruption contact windows' },
                'Wheel of Fortune': { outcome: 'DRAW', diff: 'Extreme', reason: 'AoE dominates space; luck prevents clean kill' }
            },
            'Hanged Man': {
                'Fool': { outcome: 'DRAW', diff: 'Extreme', reason: 'Grazing/traps vs history loops; risky for both' },
                'Door': { outcome: 'LOSS', diff: 'High', reason: 'Mobility denies grazing setup; hard to keep contact' },
                'Error': { outcome: 'LOSS', diff: 'High', reason: 'Bugs/theft disrupt sacrifice timing' },
                'Visionary': { outcome: 'DRAW', diff: 'Variable', reason: 'Same Sefirah (Contingency/Interference Trigger)' },
                'White Tower': { outcome: 'DRAW', diff: 'Variable', reason: 'Same Sefirah (Contingency/Interference Trigger)' },
                'Sun': { outcome: 'DRAW', diff: 'Variable', reason: 'Same Sefirah (Contingency/Interference Trigger)' },
                'Tyrant': { outcome: 'DRAW', diff: 'Variable', reason: 'Same Sefirah (Contingency/Interference Trigger)' },
                'Darkness': { outcome: 'LOSS', diff: 'High', reason: 'Shadow vs shadow; concealment denies stable control' },
                'Death': { outcome: 'DRAW', diff: 'Extreme', reason: 'Soul-state conflict; neither finishes cleanly' },
                'Twilight Giant': { outcome: 'WIN', diff: 'High', reason: 'Versatility beats straightforward tank attrition' },
                'Red Priest': { outcome: 'LOSS', diff: 'High', reason: 'Fire pressure counters blood/shadow tools' },
                'Demoness': { outcome: 'LOSS', diff: 'High', reason: 'Plague/calamity corrupts blood tools; dangerous trades' },
                'Justiciar': { outcome: 'LOSS', diff: 'High', reason: 'Prohibitions restrict sacrifice/casting windows' },
                'Black Emperor': { outcome: 'DRAW', diff: 'Extreme', reason: 'Distortion vs corruption; unstable closure' },
                'Hermit': { outcome: 'WIN', diff: 'High', reason: 'Corruption punishes secret-knowledge casting routes' },
                'Paragon': { outcome: 'DRAW', diff: 'Extreme', reason: 'Machines deny blood leverage; corruption can still bite' },
                'Mother': { outcome: 'WIN', diff: 'High', reason: 'Flesh/corruption tools pressure growth anchors' },
                'Moon': { outcome: 'WIN', diff: 'High', reason: 'Superior blood manipulation; denies regen safety' },
                'Chained': { outcome: 'WIN', diff: 'High', reason: 'Grazing/corruption pressure outlasts restraint' },
                'Abyss': { outcome: 'DRAW', diff: 'Extreme', reason: 'Corruption mirrors; whoever overextends loses control' },
                'Wheel of Fortune': { outcome: 'WIN', diff: 'High', reason: 'Blood/corruption tracking reduces luck safety' }
            },
            'Darkness': {
                'Fool': { outcome: 'LOSS', diff: 'Mid', reason: 'Fool uses Divination to find you and Miracles to light up the dark' },
                'Door': { outcome: 'LOSS', diff: 'High', reason: 'Door teleports out of the Concept of darkness' },
                'Error': { outcome: 'LOSS', diff: 'High', reason: 'Theft can disrupt concealment anchors' },
                'Visionary': { outcome: 'LOSS', diff: 'Mid', reason: 'Visionary Imagines the hidden enemy' },
                'White Tower': { outcome: 'WIN', diff: 'High', reason: 'Reader relies on information. Concealment removes all information' },
                'Sun': { outcome: 'LOSS', diff: 'High', reason: 'Eternal Rival. Light breaks Concealment' },
                'Tyrant': { outcome: 'WIN', diff: 'Mid', reason: 'Storms are loud; Darkness is quiet. Silence swallows the thunder' },
                'Hanged Man': { outcome: 'WIN', diff: 'High', reason: 'Better conceal/ambush control; denies grazing' },
                'Death': { outcome: 'DRAW', diff: 'Variable', reason: 'Same Sefirah (Contingency/Interference Trigger)' },
                'Twilight Giant': { outcome: 'DRAW', diff: 'Variable', reason: 'Same Sefirah (Contingency/Interference Trigger)' },
                'Red Priest': { outcome: 'WIN', diff: 'High', reason: 'A Hunter needs tracks. Darkness erases all traces' },
                'Demoness': { outcome: 'WIN', diff: 'Low', reason: 'Assassin relies on being unseen. Darkness makes everyone unseen' },
                'Justiciar': { outcome: 'WIN', diff: 'Mid', reason: 'Prohibition requires a target. The Arbiter cannot judge what isn\'t there' },
                'Black Emperor': { outcome: 'DRAW', diff: 'Extreme', reason: 'Concealment denies targeting; distortion denies closure' },
                'Hermit': { outcome: 'WIN', diff: 'High', reason: 'Concealment denies targeting; forces miscasts' },
                'Paragon': { outcome: 'WIN', diff: 'Low', reason: 'Sensors and cameras do not work in Concealment. The Paragon is blind' },
                'Mother': { outcome: 'DRAW', diff: 'Extreme', reason: 'Growth can anchor; concealment denies targeting' },
                'Moon': { outcome: 'WIN', diff: 'High', reason: 'Sleep/denial beats predation pacing' },
                'Chained': { outcome: 'WIN', diff: 'High', reason: 'Denies binding targeting; forces attrition' },
                'Abyss': { outcome: 'WIN', diff: 'High', reason: 'Concealment denies contact windows; ambush control' },
                'Wheel of Fortune': { outcome: 'WIN', diff: 'Mid', reason: 'Luck doesn\'t help if you are asleep. Lullaby bypasses probability' }
            },
            'Death': {
                'Fool': { outcome: 'LOSS', diff: 'High', reason: 'History tricks deny state-control closure' },
                'Door': { outcome: 'LOSS', diff: 'High', reason: 'Exile/escape denies spirit-domain finishing' },
                'Error': { outcome: 'LOSS', diff: 'High', reason: 'Theft disrupts spirit transitions and anchors' },
                'Visionary': { outcome: 'LOSS', diff: 'High', reason: 'Intent rewrite breaks state-control planning' },
                'White Tower': { outcome: 'DRAW', diff: 'Extreme', reason: 'Modeling vs spirit-state; hard to finish' },
                'Sun': { outcome: 'LOSS', diff: 'Mid', reason: 'Purification suppresses undead/spirit buildup' },
                'Tyrant': { outcome: 'LOSS', diff: 'High', reason: 'Lightning pressure disrupts undead control' },
                'Hanged Man': { outcome: 'DRAW', diff: 'Extreme', reason: 'Soul-state conflict; neither finishes cleanly' },
                'Darkness': { outcome: 'DRAW', diff: 'Variable', reason: 'Same Sefirah (Contingency/Interference Trigger)' },
                'Twilight Giant': { outcome: 'DRAW', diff: 'Variable', reason: 'Same Sefirah (Contingency/Interference Trigger)' },
                'Red Priest': { outcome: 'LOSS', diff: 'High', reason: 'Fire cleanses corpses; pressures undead army' },
                'Demoness': { outcome: 'WIN', diff: 'High', reason: 'Immune to plague; wins by state-control' },
                'Justiciar': { outcome: 'DRAW', diff: 'Extreme', reason: 'Domain rules vs death state; closure is hard' },
                'Black Emperor': { outcome: 'DRAW', diff: 'Extreme', reason: 'Distortion can misdirect; death can outlast' },
                'Hermit': { outcome: 'WIN', diff: 'High', reason: 'Magic struggles vs state authority; death pressure' },
                'Paragon': { outcome: 'WIN', diff: 'High', reason: 'Spirits ignore machines unless upgraded' },
                'Mother': { outcome: 'LOSS', diff: 'High', reason: 'Life out-sustains decay; hard to finish' },
                'Moon': { outcome: 'WIN', diff: 'High', reason: 'Undead-lite gets dominated by death authority' },
                'Chained': { outcome: 'DRAW', diff: 'Extreme', reason: 'Restraint vs spirit-state; both disrupt the other' },
                'Abyss': { outcome: 'DRAW', diff: 'Extreme', reason: 'Corruption contact vs death state; unstable finish' },
                'Wheel of Fortune': { outcome: 'DRAW', diff: 'Extreme', reason: 'Reboot/luck prevents clean state capture' }
            },
            'Twilight Giant': {
                'Fool': { outcome: 'LOSS', diff: 'Mid', reason: 'History kiting denies close-range win condition' },
                'Door': { outcome: 'LOSS', diff: 'Mid', reason: 'Cannot reliably reach a space-admin target' },
                'Error': { outcome: 'LOSS', diff: 'High', reason: 'Theft breaks weapon/defense consistency' },
                'Visionary': { outcome: 'LOSS', diff: 'High', reason: 'Mental control punishes straightforward fighters' },
                'White Tower': { outcome: 'LOSS', diff: 'Mid', reason: 'Kited and weak-pointed; control beats brawl' },
                'Sun': { outcome: 'LOSS', diff: 'High', reason: 'Sustained burn pressures tank over time' },
                'Tyrant': { outcome: 'DRAW', diff: 'Extreme', reason: 'Tank can force close; storm struggles to finish' },
                'Hanged Man': { outcome: 'LOSS', diff: 'High', reason: 'Corruption/grazing outlasts brute durability' },
                'Darkness': { outcome: 'DRAW', diff: 'Variable', reason: 'Same Sefirah (Contingency/Interference Trigger)' },
                'Death': { outcome: 'DRAW', diff: 'Variable', reason: 'Same Sefirah (Contingency/Interference Trigger)' },
                'Red Priest': { outcome: 'DRAW', diff: 'Extreme', reason: 'Duel of pressure; neither closes reliably' },
                'Demoness': { outcome: 'WIN', diff: 'High', reason: 'Tank resists one-shot; decay disrupts threads' },
                'Justiciar': { outcome: 'LOSS', diff: 'High', reason: 'Weapons/violence rules can strip win condition' },
                'Black Emperor': { outcome: 'LOSS', diff: 'High', reason: 'Distance distortion denies clean hits' },
                'Hermit': { outcome: 'LOSS', diff: 'High', reason: 'If kept at range, magic can crack tank over time' },
                'Paragon': { outcome: 'WIN', diff: 'High', reason: 'Decay rots metal/systems; armor wins attrition' },
                'Mother': { outcome: 'DRAW', diff: 'Extreme', reason: 'Growth vs decay; both can outlast' },
                'Moon': { outcome: 'WIN', diff: 'High', reason: 'Tank + decay denies predation pace' },
                'Chained': { outcome: 'DRAW', diff: 'Extreme', reason: 'Restraint vs brawl; both struggle to finish' },
                'Abyss': { outcome: 'DRAW', diff: 'Extreme', reason: 'Corruption vs durability; whoever overextends loses' },
                'Wheel of Fortune': { outcome: 'LOSS', diff: 'High', reason: 'Luck turns lethal hits into near-misses' }
            },
            'Red Priest': {
                'Fool': { outcome: 'LOSS', diff: 'Mid', reason: 'No stable target; history dodges the warzone' },
                'Door': { outcome: 'LOSS', diff: 'Mid', reason: 'Redirects AOE; denies forced engagement' },
                'Error': { outcome: 'LOSS', diff: 'Mid', reason: 'Theft steals fire/initiative; tempo collapses' },
                'Visionary': { outcome: 'LOSS', diff: 'High', reason: 'War depends on morale; loyalty gets rewritten' },
                'White Tower': { outcome: 'DRAW', diff: 'Extreme', reason: 'War pressure vs leaked plans; hard to finish' },
                'Sun': { outcome: 'DRAW', diff: 'Extreme', reason: 'Holy fire vs war fire; both dangerous' },
                'Tyrant': { outcome: 'DRAW', diff: 'Extreme', reason: 'Catastrophe clash; neither closes cleanly' },
                'Hanged Man': { outcome: 'WIN', diff: 'High', reason: 'Iron-and-blood pressure counters corruption pacing' },
                'Darkness': { outcome: 'LOSS', diff: 'High', reason: 'No tracks = no war; ambush flips battlefield control' },
                'Death': { outcome: 'WIN', diff: 'High', reason: 'Fire pressure cleanses undead; finish still costly' },
                'Twilight Giant': { outcome: 'DRAW', diff: 'Extreme', reason: 'Giant tanks; Priest pressures; closure uncertain' },
                'Demoness': { outcome: 'DRAW', diff: 'Variable', reason: 'Same Sefirah (Contingency/Interference Trigger)' },
                'Justiciar': { outcome: 'LOSS', diff: 'High', reason: 'Rules of engagement nerf wide destruction' },
                'Black Emperor': { outcome: 'DRAW', diff: 'Extreme', reason: 'War vs distortion; unstable closure' },
                'Hermit': { outcome: 'WIN', diff: 'High', reason: 'Artillery/pressure interrupts casting windows' },
                'Paragon': { outcome: 'WIN', diff: 'High', reason: 'War sabotages infrastructure; denies setup' },
                'Mother': { outcome: 'WIN', diff: 'High', reason: 'Scorched earth denies growth anchors' },
                'Moon': { outcome: 'WIN', diff: 'High', reason: 'Fire/pressure denies regen; forces lethal timing' },
                'Chained': { outcome: 'WIN', diff: 'High', reason: 'Burns terrain; denies restraint buildup' },
                'Abyss': { outcome: 'WIN', diff: 'High', reason: 'Organized war outscales disorganized violence' },
                'Wheel of Fortune': { outcome: 'DRAW', diff: 'Extreme', reason: 'Loop war: huge pressure, but luck prevents finish' }
            },
            'Demoness': {
                'Fool': { outcome: 'LOSS', diff: 'Mid', reason: 'Puppets resist seduction; control beats tempo' },
                'Door': { outcome: 'LOSS', diff: 'High', reason: 'Exile/escape denies plague zone closure' },
                'Error': { outcome: 'LOSS', diff: 'High', reason: 'Theft disrupts layered calamity buildup' },
                'Visionary': { outcome: 'LOSS', diff: 'Mid', reason: 'Mind control punishes desire/calamity staging' },
                'White Tower': { outcome: 'LOSS', diff: 'High', reason: 'Counters conditions quickly; denies stacking' },
                'Sun': { outcome: 'LOSS', diff: 'High', reason: 'Purification removes plague/calamity over time' },
                'Tyrant': { outcome: 'LOSS', diff: 'High', reason: 'Wind/lightning disrupt miasma and stealth' },
                'Hanged Man': { outcome: 'WIN', diff: 'High', reason: 'Corruption/blood tools overpower plague tricks' },
                'Darkness': { outcome: 'LOSS', diff: 'Low', reason: 'Concealment denies assassin advantage; forces bad trades' },
                'Death': { outcome: 'LOSS', diff: 'High', reason: 'Plague weak vs death state; immune target' },
                'Twilight Giant': { outcome: 'LOSS', diff: 'High', reason: 'Too tanky; decay disrupts threads' },
                'Red Priest': { outcome: 'DRAW', diff: 'Variable', reason: 'Same Sefirah (Contingency/Interference Trigger)' },
                'Justiciar': { outcome: 'LOSS', diff: 'High', reason: 'Prohibits key vectors; forces honest fight' },
                'Black Emperor': { outcome: 'DRAW', diff: 'Extreme', reason: 'Distortion vs calamity; closure uncertain' },
                'Hermit': { outcome: 'DRAW', diff: 'Extreme', reason: 'Magic trades vs calamity; both volatile' },
                'Paragon': { outcome: 'LOSS', diff: 'High', reason: 'Systems resist seduction; detection ruins stealth' },
                'Mother': { outcome: 'WIN', diff: 'High', reason: 'Mother resists disease; Demoness wins via layered catastrophe' },
                'Moon': { outcome: 'WIN', diff: 'High', reason: 'Conditions bypass regen if layered properly' },
                'Chained': { outcome: 'LOSS', diff: 'High', reason: 'Restraint authority disrupts desire/threads' },
                'Abyss': { outcome: 'LOSS', diff: 'High', reason: 'Corruption out-filths plague; contact pressure' },
                'Wheel of Fortune': { outcome: 'DRAW', diff: 'Extreme', reason: 'Luck avoids the one hit, but conditions linger' }
            },
            'Justiciar': {
                'Fool': { outcome: 'LOSS', diff: 'High', reason: 'Miracles act as exceptions; hard to bind' },
                'Door': { outcome: 'WIN', diff: 'High', reason: 'Space travel can be prohibited if established early' },
                'Error': { outcome: 'LOSS', diff: 'High', reason: 'Authority theft flips prohibitions' },
                'Visionary': { outcome: 'LOSS', diff: 'Mid', reason: 'Judge intent can be rewritten' },
                'White Tower': { outcome: 'DRAW', diff: 'Extreme', reason: 'Law vs logic; slow, contested closure' },
                'Sun': { outcome: 'DRAW', diff: 'Extreme', reason: 'Radiance can be regulated, but Sun pressures continuously' },
                'Tyrant': { outcome: 'WIN', diff: 'High', reason: 'Grounds flight/scale; forces terms' },
                'Hanged Man': { outcome: 'WIN', diff: 'High', reason: 'Prohibits sacrifice windows; reduces kit' },
                'Darkness': { outcome: 'LOSS', diff: 'Mid', reason: 'No target, no verdict; concealment denies closure' },
                'Death': { outcome: 'DRAW', diff: 'Extreme', reason: 'State authority resists pure legislation' },
                'Twilight Giant': { outcome: 'WIN', diff: 'High', reason: 'Weapons/violence rules can strip win condition' },
                'Red Priest': { outcome: 'WIN', diff: 'High', reason: 'Rules of engagement nerf AOE; still costly' },
                'Demoness': { outcome: 'WIN', diff: 'High', reason: 'Prohibits disease/stealth vectors' },
                'Black Emperor': { outcome: 'DRAW', diff: 'Variable', reason: 'Same Sefirah (Contingency/Interference Trigger)' },
                'Hermit': { outcome: 'WIN', diff: 'High', reason: 'Magic prohibited pressure; still must finish' },
                'Paragon': { outcome: 'WIN', diff: 'High', reason: 'Regulates systems; denies safe setup' },
                'Mother': { outcome: 'WIN', diff: 'High', reason: 'Regulates growth; denies runaway biology' },
                'Moon': { outcome: 'WIN', diff: 'High', reason: 'Regulates predation; forces unfavorable pacing' },
                'Chained': { outcome: 'WIN', diff: 'High', reason: 'Prohibits restraint violence vectors; binds intent' },
                'Abyss': { outcome: 'WIN', diff: 'High', reason: 'Prohibits malice/violence; forces self-damage loops' },
                'Wheel of Fortune': { outcome: 'LOSS', diff: 'High', reason: 'Chance undermines rigid rules; finds exceptions' }
            },
            'Black Emperor': {
                'Fool': { outcome: 'LOSS', diff: 'High', reason: 'History misdirects distortion targets' },
                'Door': { outcome: 'LOSS', diff: 'High', reason: 'Space partition denies distortion closure' },
                'Error': { outcome: 'LOSS', diff: 'High', reason: 'Bugs/theft out-cheat distortion' },
                'Visionary': { outcome: 'LOSS', diff: 'High', reason: 'Intent is rewritten; distortion loses steering' },
                'White Tower': { outcome: 'LOSS', diff: 'High', reason: 'Loopholes get identified and closed' },
                'Sun': { outcome: 'LOSS', diff: 'High', reason: 'Light denies hiding angles; forces honest engagement' },
                'Tyrant': { outcome: 'LOSS', diff: 'High', reason: 'Catastrophe pressure overwhelms legal tricks' },
                'Hanged Man': { outcome: 'DRAW', diff: 'Extreme', reason: 'Corruption vs distortion; unstable closure' },
                'Darkness': { outcome: 'DRAW', diff: 'Extreme', reason: 'Concealment denies targeting; distortion denies closure' },
                'Death': { outcome: 'DRAW', diff: 'Extreme', reason: 'State control vs distortion; long war' },
                'Twilight Giant': { outcome: 'WIN', diff: 'High', reason: 'Distorts distance; denies clean hits' },
                'Red Priest': { outcome: 'DRAW', diff: 'Extreme', reason: 'War vs distortion; neither closes easily' },
                'Demoness': { outcome: 'DRAW', diff: 'Extreme', reason: 'Assassin tempo vs distortion; volatile' },
                'Justiciar': { outcome: 'DRAW', diff: 'Variable', reason: 'Same Sefirah (Contingency/Interference Trigger)' },
                'Hermit': { outcome: 'DRAW', diff: 'Extreme', reason: 'Magic is flexible; distortion is flexible; stalemate' },
                'Paragon': { outcome: 'WIN', diff: 'High', reason: 'Distorts physical constants; systems fail' },
                'Mother': { outcome: 'WIN', diff: 'High', reason: 'Distorts growth boundaries; denies runaway life' },
                'Moon': { outcome: 'WIN', diff: 'High', reason: 'Distorts approach; denies predation pace' },
                'Chained': { outcome: 'WIN', diff: 'High', reason: 'Distorts cage boundaries; breaks imprisonment' },
                'Abyss': { outcome: 'WIN', diff: 'High', reason: 'Distorts corruption target; misfires contact' },
                'Wheel of Fortune': { outcome: 'DRAW', diff: 'Extreme', reason: 'Luck forces favorable loopholes; closure uncertain' }
            },
            'Hermit': {
                'Fool': { outcome: 'LOSS', diff: 'Mid', reason: 'Trick tempo + puppetry denies casting setup' },
                'Door': { outcome: 'LOSS', diff: 'High', reason: 'Mobility denies ritual closure' },
                'Error': { outcome: 'LOSS', diff: 'High', reason: 'Interrupts rituals; steals conditions' },
                'Visionary': { outcome: 'LOSS', diff: 'High', reason: 'Hallucinations/intent rewrite breaks focus' },
                'White Tower': { outcome: 'LOSS', diff: 'High', reason: 'Counter-spells via comprehension; denies surprises' },
                'Sun': { outcome: 'LOSS', diff: 'High', reason: 'Reveal denies safe casting; forces direct trades' },
                'Tyrant': { outcome: 'LOSS', diff: 'High', reason: 'Storm interrupts verbal/ritual windows' },
                'Hanged Man': { outcome: 'LOSS', diff: 'High', reason: 'Corruption punishes secret-knowledge channels' },
                'Darkness': { outcome: 'LOSS', diff: 'High', reason: 'Concealment denies targeting; forces miscasts' },
                'Death': { outcome: 'LOSS', diff: 'High', reason: 'State authority pressures magic routes' },
                'Twilight Giant': { outcome: 'WIN', diff: 'High', reason: 'If kept at range, magic cracks tank' },
                'Red Priest': { outcome: 'LOSS', diff: 'High', reason: 'Artillery/pressure hits before rituals finish' },
                'Demoness': { outcome: 'DRAW', diff: 'Extreme', reason: 'Calamity stacks vs magic flexibility; volatile' },
                'Justiciar': { outcome: 'LOSS', diff: 'High', reason: 'Prohibitions can delete casting routes' },
                'Black Emperor': { outcome: 'DRAW', diff: 'Extreme', reason: 'Distortion vs magic; long chess match' },
                'Paragon': { outcome: 'DRAW', diff: 'Variable', reason: 'Same Sefirah (Contingency/Interference Trigger)' },
                'Mother': { outcome: 'DRAW', diff: 'Extreme', reason: 'Growth anchors vs rituals; neither closes easily' },
                'Moon': { outcome: 'WIN', diff: 'High', reason: 'Burst magic can beat regen if timed' },
                'Chained': { outcome: 'LOSS', diff: 'High', reason: 'Restraint disrupts spellcasting and focus' },
                'Abyss': { outcome: 'LOSS', diff: 'Mid', reason: 'Corruption pressure hard-punishes focus casting' },
                'Wheel of Fortune': { outcome: 'DRAW', diff: 'Extreme', reason: 'Fate-reading helps, but reboot loops prolong' }
            },
            'Paragon': {
                'Fool': { outcome: 'LOSS', diff: 'Mid', reason: 'Grafting breaks rigid system assumptions' },
                'Door': { outcome: 'LOSS', diff: 'Mid', reason: 'Teleport inside denial; bypasses systems' },
                'Error': { outcome: 'LOSS', diff: 'High', reason: 'Bugs/theft ruin power sources and logic' },
                'Visionary': { outcome: 'LOSS', diff: 'High', reason: 'Attacks decision loops; ruins coordination' },
                'White Tower': { outcome: 'LOSS', diff: 'High', reason: 'Knows blueprints; exploits weak points' },
                'Sun': { outcome: 'DRAW', diff: 'Extreme', reason: 'Tech can mitigate; Sun pressure persists' },
                'Tyrant': { outcome: 'LOSS', diff: 'Mid', reason: 'EMP/storm pressure breaks systems' },
                'Hanged Man': { outcome: 'DRAW', diff: 'Extreme', reason: 'Machines resist blood, but corruption can still bite' },
                'Darkness': { outcome: 'LOSS', diff: 'Low', reason: 'Sensors fail in concealment; blind systems lose' },
                'Death': { outcome: 'LOSS', diff: 'High', reason: 'Spirits ignore machines without special upgrades' },
                'Twilight Giant': { outcome: 'LOSS', diff: 'High', reason: 'Decay rots metal/systems; tank pressure' },
                'Red Priest': { outcome: 'LOSS', diff: 'High', reason: 'War sabotages infrastructure first' },
                'Demoness': { outcome: 'WIN', diff: 'High', reason: 'Systems resist seduction; detection ruins stealth' },
                'Justiciar': { outcome: 'LOSS', diff: 'High', reason: 'Regulation/prohibitions constrain systems' },
                'Black Emperor': { outcome: 'LOSS', diff: 'High', reason: 'Distorts constants; systems fail' },
                'Hermit': { outcome: 'DRAW', diff: 'Variable', reason: 'Same Sefirah (Contingency/Interference Trigger)' },
                'Mother': { outcome: 'WIN', diff: 'High', reason: 'Industrialization denies growth anchors' },
                'Moon': { outcome: 'LOSS', diff: 'High', reason: 'Speed/predation can bypass tracking windows' },
                'Chained': { outcome: 'DRAW', diff: 'Extreme', reason: 'Denial zones vs internal binding; volatile' },
                'Abyss': { outcome: 'LOSS', diff: 'High', reason: 'Corrosive hazard melts setup zones' },
                'Wheel of Fortune': { outcome: 'WIN', diff: 'Mid', reason: 'Machines fail at the worst time; tech punishes luck' }
            },
            'Mother': {
                'Fool': { outcome: 'LOSS', diff: 'Mid', reason: 'Bypass/control denies raw sustain' },
                'Door': { outcome: 'LOSS', diff: 'Mid', reason: 'Exiles terrain; denies growth anchors' },
                'Error': { outcome: 'LOSS', diff: 'High', reason: 'Steals growth triggers; breaks regeneration loops' },
                'Visionary': { outcome: 'LOSS', diff: 'High', reason: 'Manipulates instincts; denies stable growth intent' },
                'White Tower': { outcome: 'LOSS', diff: 'High', reason: 'Bio-analysis targets growth weak points' },
                'Sun': { outcome: 'LOSS', diff: 'Mid', reason: 'Drought/scorch pressures nature anchors' },
                'Tyrant': { outcome: 'WIN', diff: 'High', reason: 'Earth/roots anchor vs storms; long attrition' },
                'Hanged Man': { outcome: 'LOSS', diff: 'High', reason: 'Corruption/flesh tools pressure growth' },
                'Darkness': { outcome: 'DRAW', diff: 'Extreme', reason: 'Concealment denies targeting; roots deny closure' },
                'Death': { outcome: 'WIN', diff: 'High', reason: 'Life out-sustains decay if not instantly purged' },
                'Twilight Giant': { outcome: 'DRAW', diff: 'Extreme', reason: 'Growth vs decay; both can outlast' },
                'Red Priest': { outcome: 'LOSS', diff: 'High', reason: 'Scorched earth denies anchors' },
                'Demoness': { outcome: 'LOSS', diff: 'High', reason: 'Mother resists disease; Demoness wins via layered catastrophe' },
                'Justiciar': { outcome: 'LOSS', diff: 'High', reason: 'Regulates growth/breeding; forces boundaries' },
                'Black Emperor': { outcome: 'LOSS', diff: 'High', reason: 'Distorts boundaries; denies runaway growth' },
                'Hermit': { outcome: 'DRAW', diff: 'Extreme', reason: 'Rituals vs life sustain; volatile' },
                'Paragon': { outcome: 'LOSS', diff: 'High', reason: 'Industrialization poisons soil/anchors' },
                'Moon': { outcome: 'DRAW', diff: 'Variable', reason: 'Same Sefirah (Contingency/Interference Trigger)' },
                'Chained': { outcome: 'LOSS', diff: 'Mid', reason: 'Internal restraint/corruption rots growth' },
                'Abyss': { outcome: 'LOSS', diff: 'High', reason: 'Pollution/corruption kills nature anchors' },
                'Wheel of Fortune': { outcome: 'DRAW', diff: 'Extreme', reason: 'Luck prolongs; life sustain prolongs; hard finish' }
            },
            'Moon': {
                'Fool': { outcome: 'LOSS', diff: 'Mid', reason: 'Puppetry/grafting denies clean predation' },
                'Door': { outcome: 'LOSS', diff: 'Mid', reason: 'Mobility denies close-range kill condition' },
                'Error': { outcome: 'LOSS', diff: 'High', reason: 'Steals regen timing; forces lethal openings' },
                'Visionary': { outcome: 'LOSS', diff: 'High', reason: 'Rewrites predation impulse; forces misplays' },
                'White Tower': { outcome: 'LOSS', diff: 'High', reason: 'Predicts predation vectors; denies regen windows' },
                'Sun': { outcome: 'LOSS', diff: 'High', reason: 'Natural predator matchup; denies blood regen' },
                'Tyrant': { outcome: 'LOSS', diff: 'High', reason: 'Burst pressure overwhelms regen windows' },
                'Hanged Man': { outcome: 'LOSS', diff: 'High', reason: 'Superior blood manipulation denies regen safety' },
                'Darkness': { outcome: 'LOSS', diff: 'High', reason: 'Sleep/denial beats predation pacing' },
                'Death': { outcome: 'LOSS', diff: 'High', reason: 'Death authority dominates undead-lite' },
                'Twilight Giant': { outcome: 'LOSS', diff: 'High', reason: 'Tank/decay denies predation pace' },
                'Red Priest': { outcome: 'LOSS', diff: 'High', reason: 'Fire pressure denies regeneration' },
                'Demoness': { outcome: 'LOSS', diff: 'High', reason: 'Layered calamity bypasses regen over time' },
                'Justiciar': { outcome: 'LOSS', diff: 'High', reason: 'Regulates predation; forces bad trades' },
                'Black Emperor': { outcome: 'LOSS', diff: 'High', reason: 'Distorts approach; denies close-range' },
                'Hermit': { outcome: 'LOSS', diff: 'High', reason: 'Burst magic can crack regen if timed' },
                'Paragon': { outcome: 'WIN', diff: 'High', reason: 'Speed/predation bypasses tracking at key moments' },
                'Mother': { outcome: 'DRAW', diff: 'Variable', reason: 'Same Sefirah (Contingency/Interference Trigger)' },
                'Chained': { outcome: 'LOSS', diff: 'Mid', reason: 'Restraint binds blood flow; denies tempo' },
                'Abyss': { outcome: 'LOSS', diff: 'High', reason: 'Corruption burns blood; denies regen safety' },
                'Wheel of Fortune': { outcome: 'DRAW', diff: 'Extreme', reason: 'Luck vs regen: long loop war' }
            },
            'Chained': {
                'Fool': { outcome: 'LOSS', diff: 'Mid', reason: 'History tricks avoid capture; binding struggles to finish' },
                'Door': { outcome: 'LOSS', diff: 'Mid', reason: 'Space admin denies imprisonment by leaving coordinates' },
                'Error': { outcome: 'LOSS', diff: 'High', reason: 'Theft steals constraint keys; breaks cage logic' },
                'Visionary': { outcome: 'LOSS', diff: 'High', reason: 'Attacks intent/sanity; restraint becomes self-cage' },
                'White Tower': { outcome: 'LOSS', diff: 'High', reason: 'Solves binding logic; unravels restraint patterns' },
                'Sun': { outcome: 'LOSS', diff: 'Mid', reason: 'Purification suppresses curse/restraint buildup' },
                'Tyrant': { outcome: 'LOSS', diff: 'High', reason: 'Domain AOE denies stealth binding; hard to close' },
                'Hanged Man': { outcome: 'LOSS', diff: 'High', reason: 'Corruption/grazing pressure outlasts restraint' },
                'Darkness': { outcome: 'LOSS', diff: 'High', reason: 'Concealment denies targeting; forces attrition loss' },
                'Death': { outcome: 'DRAW', diff: 'Extreme', reason: 'Spirit state vs restraint state; closure uncertain' },
                'Twilight Giant': { outcome: 'DRAW', diff: 'Extreme', reason: 'Brawl pressure vs restraint; neither finishes cleanly' },
                'Red Priest': { outcome: 'LOSS', diff: 'High', reason: 'Terrain burn denies cage buildup; war pressure' },
                'Demoness': { outcome: 'WIN', diff: 'High', reason: 'Desire/resistance favors Chained; must respect calamity' },
                'Justiciar': { outcome: 'LOSS', diff: 'High', reason: 'Prohibitions constrain restraint vectors; forced terms' },
                'Black Emperor': { outcome: 'LOSS', diff: 'High', reason: 'Distorts cage boundaries; breaks imprisonment' },
                'Hermit': { outcome: 'WIN', diff: 'High', reason: 'Binding disrupts casting; wins by tempo denial' },
                'Paragon': { outcome: 'DRAW', diff: 'Extreme', reason: 'Denial zones vs internal binding; volatile' },
                'Mother': { outcome: 'WIN', diff: 'Mid', reason: 'Internal corruption/restraint rots growth anchors' },
                'Moon': { outcome: 'WIN', diff: 'Mid', reason: 'Binds blood flow; denies regen pacing' },
                'Abyss': { outcome: 'DRAW', diff: 'Variable', reason: 'Same Sefirah (Contingency/Interference Trigger)' },
                'Wheel of Fortune': { outcome: 'DRAW', diff: 'Extreme', reason: 'Luck creates escape branches; restraint limits options' }
            },
            'Abyss': {
                'Fool': { outcome: 'LOSS', diff: 'Mid', reason: 'Bait/loop tactics deny contact closure' },
                'Door': { outcome: 'LOSS', diff: 'Mid', reason: 'Avoids contact; exiles corruption zones' },
                'Error': { outcome: 'LOSS', diff: 'High', reason: 'Steals malice/contact leverage; destabilizes kit' },
                'Visionary': { outcome: 'LOSS', diff: 'High', reason: 'Placates bloodlust; turns aggression inward' },
                'White Tower': { outcome: 'LOSS', diff: 'High', reason: 'Models corruption triggers; traps contact windows' },
                'Sun': { outcome: 'LOSS', diff: 'Mid', reason: 'Purification suppresses corruption/contact threats' },
                'Tyrant': { outcome: 'LOSS', diff: 'High', reason: 'Lightning/storm pressure limits contact windows' },
                'Hanged Man': { outcome: 'DRAW', diff: 'Extreme', reason: 'Corruption mirrors; whoever overextends loses control' },
                'Darkness': { outcome: 'LOSS', diff: 'High', reason: 'Concealment denies contact windows; ambush control' },
                'Death': { outcome: 'DRAW', diff: 'Extreme', reason: 'Corruption vs death state; unstable finish' },
                'Twilight Giant': { outcome: 'DRAW', diff: 'Extreme', reason: 'Durability vs corrosion; whoever overextends loses' },
                'Red Priest': { outcome: 'LOSS', diff: 'High', reason: 'Organized war outscales disorganized violence' },
                'Demoness': { outcome: 'WIN', diff: 'High', reason: 'Filth/corruption overpowers plague in long fight' },
                'Justiciar': { outcome: 'LOSS', diff: 'High', reason: 'Prohibitions malice/violence; forces self-damage loops' },
                'Black Emperor': { outcome: 'LOSS', diff: 'High', reason: 'Distorts corruption target; misfires contact' },
                'Hermit': { outcome: 'WIN', diff: 'Mid', reason: 'Corruption pressure hard-punishes focus casting' },
                'Paragon': { outcome: 'WIN', diff: 'High', reason: 'Environmental hazard melts denial setup zones' },
                'Mother': { outcome: 'WIN', diff: 'High', reason: 'Pollution/corruption kills nature anchors' },
                'Moon': { outcome: 'WIN', diff: 'High', reason: 'Corruption burns blood; denies regen' },
                'Chained': { outcome: 'DRAW', diff: 'Variable', reason: 'Same Sefirah (Contingency/Interference Trigger)' },
                'Wheel of Fortune': { outcome: 'DRAW', diff: 'Extreme', reason: 'Luck avoids contact; corruption pressures mistakes' }
            },
            'Wheel of Fortune': {
                'Fool': { outcome: 'LOSS', diff: 'High', reason: 'Higher-level reset tools beat luck in the long run' },
                'Door': { outcome: 'DRAW', diff: 'Extreme', reason: 'Misjumps vs relocation; loop war without easy finish' },
                'Error': { outcome: 'LOSS', diff: 'High', reason: 'If luck is stolen, reboot loops collapse' },
                'Visionary': { outcome: 'LOSS', diff: 'High', reason: 'Scripted outcomes narrow viable branches' },
                'White Tower': { outcome: 'LOSS', diff: 'High', reason: 'Probability is math; still a long finish' },
                'Sun': { outcome: 'LOSS', diff: 'High', reason: 'Constant pressure narrows branches; hard to stabilize' },
                'Tyrant': { outcome: 'DRAW', diff: 'Extreme', reason: 'AoE dominates space; luck prevents clean kill' },
                'Hanged Man': { outcome: 'LOSS', diff: 'High', reason: 'Tracking/corruption reduces luck safety' },
                'Darkness': { outcome: 'LOSS', diff: 'Mid', reason: 'Sleep/denial bypasses luck survival patterns' },
                'Death': { outcome: 'DRAW', diff: 'Extreme', reason: 'State fights resist clean probability closure' },
                'Twilight Giant': { outcome: 'WIN', diff: 'High', reason: 'Direct fighters get punished by near-miss loops' },
                'Red Priest': { outcome: 'DRAW', diff: 'Extreme', reason: 'Huge pressure, but luck prevents clean finish' },
                'Demoness': { outcome: 'DRAW', diff: 'Extreme', reason: 'Avoids the one hit, but conditions linger' },
                'Justiciar': { outcome: 'WIN', diff: 'High', reason: 'Chance undermines rigid rules; finds exceptions' },
                'Black Emperor': { outcome: 'DRAW', diff: 'Extreme', reason: 'Luck forces favorable loopholes; closure uncertain' },
                'Hermit': { outcome: 'DRAW', diff: 'Extreme', reason: 'Fate-reading helps, but reboot loops prolong' },
                'Paragon': { outcome: 'LOSS', diff: 'Mid', reason: 'Systems punish probability; machines fail-safe against luck' },
                'Mother': { outcome: 'DRAW', diff: 'Extreme', reason: 'Life sustain prolongs; luck prolongs; hard finish' },
                'Moon': { outcome: 'DRAW', diff: 'Extreme', reason: 'Regen prolongs; luck prolongs; hard finish' },
                'Chained': { outcome: 'DRAW', diff: 'Extreme', reason: 'Restraint reduces options; luck creates escape branches' },
                'Abyss': { outcome: 'DRAW', diff: 'Extreme', reason: 'Luck avoids contact; corruption pressures mistakes' }
            }
        };

        // ============================================
        // OUTER DEITY MATCHUPS
        // ============================================
        const OUTER_DEITY_MATCHUPS = {
            'Mother Goddess of Depravity': {
                'Mother Tree of Desire': { outcome: 'DRAW', diff: 'Extreme', reason: 'Sister corruption domains feed each other eternally; depravity births desire, desire feeds depravity.' },
                'Son of Chaos': { outcome: 'WIN', diff: 'Low', reason: 'Chaos lacks intent and structure; depravity provides form and converts servants easily.' },
                'Circle of Inevitability': { outcome: 'LOSS', diff: 'High', reason: 'Corruption cycles eternally but cannot escape the wheel; depravity is part of fate.' },
                'Primordial Hunger': { outcome: 'DRAW', diff: 'Extreme', reason: 'Hunger consumes flesh as depravity corrupts it; neither process can exhaust the other.' },
                'Supernova Dominator': { outcome: 'LOSS', diff: 'Low', reason: 'Stellar purification annihilates corruption absolutely and immediately.' },
                'Inextinguishable Ravings': { outcome: 'WIN', diff: 'High', reason: 'Madness is easily reshaped into worship and perversion.' },
                'Monarch of Decay': { outcome: 'DRAW', diff: 'Extreme', reason: 'Corruption accelerates decay; decay finalizes corruption.' },
                'High-Dimensional Overseer': { outcome: 'LOSS', diff: 'High', reason: 'Corruption cannot affect entities outside its dimensional reach.' },
                'Goddess of Fate': { outcome: 'LOSS', diff: 'High', reason: 'Depravity already exists as a woven thread within fate.' }
            },
            'Mother Tree of Desire': {
                'Mother Goddess of Depravity': { outcome: 'DRAW', diff: 'Extreme', reason: 'Desire and depravity intertwined; both corrupt through wanting endlessly.' },
                'Son of Chaos': { outcome: 'WIN', diff: 'Low', reason: 'Chaos lacks will; desire grants direction and control.' },
                'Circle of Inevitability': { outcome: 'LOSS', diff: 'High', reason: 'Desires repeat eternally; the Tree is trapped in the cycle.' },
                'Primordial Hunger': { outcome: 'LOSS', diff: 'High', reason: 'Hunger is desire stripped to essence and devours its source.' },
                'Supernova Dominator': { outcome: 'LOSS', diff: 'Low', reason: 'Stars have no desire to exploit and reject bargains outright.' },
                'Inextinguishable Ravings': { outcome: 'WIN', diff: 'High', reason: 'Mad scholars still crave forbidden knowledge.' },
                'Monarch of Decay': { outcome: 'DRAW', diff: 'Extreme', reason: 'All desires rot eventually; granted wishes decay.' },
                'High-Dimensional Overseer': { outcome: 'LOSS', diff: 'High', reason: 'Overseer perceives temptation structures externally.' },
                'Goddess of Fate': { outcome: 'LOSS', diff: 'High', reason: 'Only fated wishes manifest; the Tree has no authority over outcomes.' }
            },
            'Son of Chaos': {
                'Mother Goddess of Depravity': { outcome: 'LOSS', diff: 'Low', reason: 'Corruption has intent; chaos is directionless and servants get subverted.' },
                'Mother Tree of Desire': { outcome: 'LOSS', diff: 'Low', reason: 'Devils have plans; chaos serves those who direct it through desire.' },
                'Circle of Inevitability': { outcome: 'LOSS', diff: 'Extreme', reason: 'Infinite time creates patterns; chaos is contained by cycles.' },
                'Primordial Hunger': { outcome: 'LOSS', diff: 'Low', reason: 'Hunger devours indiscriminately and instantly.' },
                'Supernova Dominator': { outcome: 'LOSS', diff: 'Low', reason: 'Absolute cosmic order suppresses formless instability.' },
                'Inextinguishable Ravings': { outcome: 'DRAW', diff: 'Extreme', reason: 'Chaos and madness dissolve coherence equally.' },
                'Monarch of Decay': { outcome: 'DRAW', diff: 'Extreme', reason: 'Entropy is structured chaos; both dissolve existence differently.' },
                'High-Dimensional Overseer': { outcome: 'LOSS', diff: 'High', reason: 'Higher dimensions contain and dominate lower chaos.' },
                'Goddess of Fate': { outcome: 'LOSS', diff: 'High', reason: 'Even randomness follows predetermined probability threads.' }
            },
            'Circle of Inevitability': {
                'Mother Goddess of Depravity': { outcome: 'WIN', diff: 'High', reason: 'Corruption cycles eternally; what falls will fall again forever.' },
                'Mother Tree of Desire': { outcome: 'WIN', diff: 'High', reason: 'Same wishes repeat; desire is part of the eternal pattern.' },
                'Son of Chaos': { outcome: 'WIN', diff: 'Extreme', reason: 'Chaos is contained within cycles; randomness has rhythm over eternity.' },
                'Primordial Hunger': { outcome: 'DRAW', diff: 'Extreme', reason: 'Hunger is cyclical; both are eternal processes.' },
                'Supernova Dominator': { outcome: 'DRAW', diff: 'Extreme', reason: 'Stars are born and die cyclically.' },
                'Inextinguishable Ravings': { outcome: 'WIN', diff: 'High', reason: 'Madness recurs in repeating delusions.' },
                'Monarch of Decay': { outcome: 'DRAW', diff: 'Extreme', reason: 'Decay is inevitability expressed materially.' },
                'High-Dimensional Overseer': { outcome: 'DRAW', diff: 'Extreme', reason: 'Cycles exist across all dimensions.' },
                'Goddess of Fate': { outcome: 'DRAW', diff: 'Extreme', reason: 'Same Sefirah (Key of Light); two aspects of one authority.' }
            },
            'Primordial Hunger': {
                'Mother Goddess of Depravity': { outcome: 'DRAW', diff: 'Extreme', reason: 'Hunger for corruption meets depravity that hungers; mutual endless consumption.' },
                'Mother Tree of Desire': { outcome: 'WIN', diff: 'High', reason: 'Desire is sustenance; Hunger devours wishes and wish-granters alike.' },
                'Son of Chaos': { outcome: 'WIN', diff: 'Low', reason: 'Chaos is food like anything else; the Devourer consumes without preference.' },
                'Circle of Inevitability': { outcome: 'DRAW', diff: 'Extreme', reason: 'Hunger is part of the cycle; devouring repeats eternally.' },
                'Supernova Dominator': { outcome: 'DRAW', diff: 'Extreme', reason: 'Stellar scale resists consumption short-term; hunger persists eternally.' },
                'Inextinguishable Ravings': { outcome: 'WIN', diff: 'Low', reason: 'Thought requires time; hunger ends it instantly.' },
                'Monarch of Decay': { outcome: 'DRAW', diff: 'Extreme', reason: 'Hunger decays without food; decay feeds hunger.' },
                'High-Dimensional Overseer': { outcome: 'LOSS', diff: 'High', reason: 'Hunger cannot reach inaccessible dimensions.' },
                'Goddess of Fate': { outcome: 'LOSS', diff: 'Extreme', reason: 'Fate controls what is consumed and when.' }
            },
            'Supernova Dominator': {
                'Mother Goddess of Depravity': { outcome: 'WIN', diff: 'Low', reason: 'Stellar purification at cosmic scale; light incinerates all corruption.' },
                'Mother Tree of Desire': { outcome: 'WIN', diff: 'Low', reason: 'Stars have no desires to exploit; absolute authority rejects bargains.' },
                'Son of Chaos': { outcome: 'WIN', diff: 'Low', reason: 'Cosmic order dominates absolutely; stellar authority structures formless anarchy.' },
                'Circle of Inevitability': { outcome: 'DRAW', diff: 'Extreme', reason: 'Stars cycle through birth and death; stellar fate meets inevitability.' },
                'Primordial Hunger': { outcome: 'DRAW', diff: 'Extreme', reason: 'Cosmic scale far exceeds consumption; cannot devour what spans galaxies.' },
                'Inextinguishable Ravings': { outcome: 'WIN', diff: 'Low', reason: 'Stellar brilliance destroys all shadows of delusion.' },
                'Monarch of Decay': { outcome: 'DRAW', diff: 'Extreme', reason: 'Stars decay over eons; stellar entropy is patient but absolute.' },
                'High-Dimensional Overseer': { outcome: 'DRAW', diff: 'Extreme', reason: 'Stars exist across multiple dimensions; cosmic meets dimensional authority.' },
                'Goddess of Fate': { outcome: 'DRAW', diff: 'Extreme', reason: 'Stars have woven fates; stellar authority remains absolute in its domain.' }
            },
            'Inextinguishable Ravings': {
                'Mother Goddess of Depravity': { outcome: 'LOSS', diff: 'High', reason: 'Corrupted minds serve depravity willingly; madness becomes worship.' },
                'Mother Tree of Desire': { outcome: 'LOSS', diff: 'High', reason: 'Mad scholars still desire knowledge; desire exploits madness.' },
                'Son of Chaos': { outcome: 'DRAW', diff: 'Extreme', reason: 'Chaos and madness are siblings; both dissolve coherent thought.' },
                'Circle of Inevitability': { outcome: 'LOSS', diff: 'High', reason: 'Madness cycles eternally; same delusions return as part of the pattern.' },
                'Primordial Hunger': { outcome: 'LOSS', diff: 'Low', reason: 'Cannot philosophize while being devoured; hunger ends all debate.' },
                'Supernova Dominator': { outcome: 'LOSS', diff: 'Low', reason: 'Stellar light burns away delusion; clarity through brilliance.' },
                'Monarch of Decay': { outcome: 'DRAW', diff: 'Extreme', reason: 'Mind decays into madness; madness accelerates mental decay.' },
                'High-Dimensional Overseer': { outcome: 'LOSS', diff: 'High', reason: 'Dimensional perspective sees objective truth; madness is limited viewpoint.' },
                'Goddess of Fate': { outcome: 'LOSS', diff: 'High', reason: 'Madness is predetermined; every delusion is a thread woven in fate.' }
            },
            'Monarch of Decay': {
                'Mother Goddess of Depravity': { outcome: 'DRAW', diff: 'Extreme', reason: 'Corruption and decay feed each other; sister entropies exist without hierarchy.' },
                'Mother Tree of Desire': { outcome: 'DRAW', diff: 'Extreme', reason: 'All desires rot to nothing eventually; wishes decay to dust.' },
                'Son of Chaos': { outcome: 'DRAW', diff: 'Extreme', reason: 'Entropy is structured chaos; both dissolve all things.' },
                'Circle of Inevitability': { outcome: 'DRAW', diff: 'Extreme', reason: 'Decay is inevitable; entropy is part of the cycle.' },
                'Primordial Hunger': { outcome: 'DRAW', diff: 'Extreme', reason: 'Hunger decays without food; decay feeds hunger. Eternal process.' },
                'Supernova Dominator': { outcome: 'DRAW', diff: 'Extreme', reason: 'Stars decay over eons; cosmic entropy is patient but absolute.' },
                'Inextinguishable Ravings': { outcome: 'DRAW', diff: 'Extreme', reason: 'Minds rot into madness; sanity decays.' },
                'High-Dimensional Overseer': { outcome: 'DRAW', diff: 'Extreme', reason: 'Entropy transcends spatial dimensionality.' },
                'Goddess of Fate': { outcome: 'DRAW', diff: 'Extreme', reason: 'All fates end; entropy is the final certainty.' }
            },
            'High-Dimensional Overseer': {
                'Mother Goddess of Depravity': { outcome: 'WIN', diff: 'High', reason: 'Dimensional shift escapes corruption; cannot corrupt other realities.' },
                'Mother Tree of Desire': { outcome: 'WIN', diff: 'High', reason: 'Perceives wish-traps from outside; dimensional awareness sees through all.' },
                'Son of Chaos': { outcome: 'WIN', diff: 'High', reason: 'Higher dimensions contain lower chaos; transcendent perspective dominates.' },
                'Circle of Inevitability': { outcome: 'DRAW', diff: 'Extreme', reason: 'Cycles exist across all dimensions; cannot escape inevitability.' },
                'Primordial Hunger': { outcome: 'WIN', diff: 'High', reason: 'Exists in dimensions hunger cannot reach; spatial transcendence defeats devouring.' },
                'Supernova Dominator': { outcome: 'DRAW', diff: 'Extreme', reason: 'Stars span multiple dimensions; cosmic meets dimensional authority.' },
                'Inextinguishable Ravings': { outcome: 'WIN', diff: 'High', reason: 'True perspective from above; madness is limited three-dimensional viewpoint.' },
                'Monarch of Decay': { outcome: 'DRAW', diff: 'Extreme', reason: 'Higher existence may transcend entropy entirely.' },
                'Goddess of Fate': { outcome: 'LOSS', diff: 'High', reason: 'Fate weaves through ALL dimensions; tapestry has no escape route.' }
            },
            'Goddess of Fate': {
                'Mother Goddess of Depravity': { outcome: 'WIN', diff: 'High', reason: 'Corruption is already woven; depravity serves the tapestry unknowingly.' },
                'Mother Tree of Desire': { outcome: 'WIN', diff: 'High', reason: 'Fate alone decides which wishes manifest; Tree grants only what is fated.' },
                'Son of Chaos': { outcome: 'WIN', diff: 'High', reason: 'Even pure randomness follows fate; chaos dances on predetermined strings.' },
                'Circle of Inevitability': { outcome: 'DRAW', diff: 'Extreme', reason: 'Same Sefirah (Key of Light); Fate and Inevitability are one truth.' },
                'Primordial Hunger': { outcome: 'WIN', diff: 'Extreme', reason: 'Fate decides what gets devoured; Hunger is merely a tool of the weave.' },
                'Supernova Dominator': { outcome: 'DRAW', diff: 'Extreme', reason: 'Stellar fates are woven; cosmic authority remains absolute in domain.' },
                'Inextinguishable Ravings': { outcome: 'WIN', diff: 'High', reason: 'Madness is predetermined; every delusion a thread in the tapestry.' },
                'Monarch of Decay': { outcome: 'DRAW', diff: 'Extreme', reason: 'All fates include ending; entropy is the final thread woven.' },
                'High-Dimensional Overseer': { outcome: 'WIN', diff: 'High', reason: 'Fate weaves through all dimensions; no perspective escapes destiny.' }
            }
        };

        // ============================================
        // PATHWAY VS OUTER DEITY MATCHUPS (Inner vs Outer Mode)
        // ============================================
        const PATHWAY_VS_OUTER_DEITY_MATCHUPS = {
            'Fool': {
                'Mother Goddess of Depravity': { outcome: 'LOSS', diff: 'Extreme', reason: 'Full depravity domain corrupts all identities; no disguise survives absolute flesh distortion.' },
                'Mother Tree of Desire': { outcome: 'LOSS', diff: 'Extreme', reason: 'Infinite desire roots pierce all miracles; every wish the Fool makes is exploited.' },
                'Son of Chaos': { outcome: 'DRAW', diff: 'Extreme', reason: 'Fool\'s narrative manipulation creates unstable equilibrium with formless chaos; neither can impose lasting structure.' },
                'Circle of Inevitability': { outcome: 'LOSS', diff: 'Extreme', reason: 'All history manipulation is already part of the cycle; fate encompasses every possible timeline.' },
                'Primordial Hunger': { outcome: 'LOSS', diff: 'Extreme', reason: 'Absolute hunger consumes all grafted forms and historical alterations; nothing escapes consumption.' },
                'Supernova Dominator': { outcome: 'LOSS', diff: 'Extreme', reason: 'Stellar omniscience reveals every disguise; miracles burn in divine radiance.' },
                'Inextinguishable Ravings': { outcome: 'DRAW', diff: 'Extreme', reason: 'Puppetry and madness create mutual interference; Fool can redirect but not silence eternal whispers.' },
                'Monarch of Decay': { outcome: 'LOSS', diff: 'Extreme', reason: 'Universal entropy claims all histories and identities; decay cannot be escaped through time.' },
                'High-Dimensional Overseer': { outcome: 'LOSS', diff: 'Extreme', reason: 'Dimensional transcendence perceives every disguise across all realities simultaneously.' },
                'Goddess of Fate': { outcome: 'LOSS', diff: 'Extreme', reason: 'Every miracle and historical alteration was already fated; Fool operates within destiny\'s palm.' }
            },
            'Door': {
                'Mother Goddess of Depravity': { outcome: 'DRAW', diff: 'Extreme', reason: 'Spatial exile creates temporary refuge from corruption; but depravity eventually seeps through all dimensional barriers.' },
                'Mother Tree of Desire': { outcome: 'DRAW', diff: 'Extreme', reason: 'Space manipulation disrupts root networks; but desire finds paths through every opened door.' },
                'Son of Chaos': { outcome: 'DRAW', diff: 'Extreme', reason: 'Door can relocate chaos but cannot truly contain formlessness; mutual displacement creates stalemate.' },
                'Circle of Inevitability': { outcome: 'LOSS', diff: 'Extreme', reason: 'Every door, every dimension, every spatial destination is part of the wheel; no escape from inevitability.' },
                'Primordial Hunger': { outcome: 'DRAW', diff: 'Extreme', reason: 'Spatial barriers slow but cannot stop absolute consumption; exile only delays the inevitable hunger.' },
                'Supernova Dominator': { outcome: 'LOSS', diff: 'Extreme', reason: 'Light fills all spaces across all dimensions; stellar radiance penetrates every door.' },
                'Inextinguishable Ravings': { outcome: 'DRAW', diff: 'Extreme', reason: 'Can exile mad thoughts temporarily; but whispers seep through dimensional cracks.' },
                'Monarch of Decay': { outcome: 'DRAW', diff: 'Extreme', reason: 'Spatial relocation delays entropy; but all dimensions eventually decay under universal entropy.' },
                'High-Dimensional Overseer': { outcome: 'LOSS', diff: 'Extreme', reason: 'Door is subset of dimensional authority; Overseer commands all spatial domains absolutely.' },
                'Goddess of Fate': { outcome: 'LOSS', diff: 'Extreme', reason: 'Every door that opens, every path taken, was already written in fate\'s threads.' }
            },
            'Error': {
                'Mother Goddess of Depravity': { outcome: 'LOSS', diff: 'Extreme', reason: 'Cannot steal what is already corrupted; depravity infects Error\'s own theft mechanisms.' },
                'Mother Tree of Desire': { outcome: 'DRAW', diff: 'Extreme', reason: 'Error bugs contract fulfillment; but Tree\'s infinite wishes overwhelm theft capacity.' },
                'Son of Chaos': { outcome: 'DRAW', diff: 'Extreme', reason: 'Error and chaos create mutual corruption; stealing from formlessness yields only more chaos.' },
                'Circle of Inevitability': { outcome: 'DRAW', diff: 'Extreme', reason: 'Error bugs the cycle; but bugs themselves become part of inevitability\'s pattern.' },
                'Primordial Hunger': { outcome: 'DRAW', diff: 'Extreme', reason: 'Stealing consumption creates feedback loops; hunger devours its own errors.' },
                'Supernova Dominator': { outcome: 'LOSS', diff: 'Extreme', reason: 'Stellar processes are too fundamental and pure; light cannot be bugged or stolen.' },
                'Inextinguishable Ravings': { outcome: 'LOSS', diff: 'Extreme', reason: 'Madness corrupts Error\'s own processes; stealing forbidden knowledge brings self-destruction.' },
                'Monarch of Decay': { outcome: 'DRAW', diff: 'Extreme', reason: 'Error bugs decay; but entropy eventually corrupts all stolen things.' },
                'High-Dimensional Overseer': { outcome: 'LOSS', diff: 'Extreme', reason: 'Cannot steal from dimensions Error cannot perceive; theft range is utterly exceeded.' },
                'Goddess of Fate': { outcome: 'LOSS', diff: 'Extreme', reason: 'Every theft was fated; Error\'s bugs are threads in destiny\'s tapestry.' }
            },
            'Visionary': {
                'Mother Goddess of Depravity': { outcome: 'LOSS', diff: 'Extreme', reason: 'Full depravity corrupts the mind that tries to control it; Visionary\'s own thoughts become twisted.' },
                'Mother Tree of Desire': { outcome: 'LOSS', diff: 'Extreme', reason: 'Tree\'s desires overwhelm mental defenses; every thought becomes a wish to exploit.' },
                'Son of Chaos': { outcome: 'DRAW', diff: 'Extreme', reason: 'Visionary imposes structure but chaos dissolves narratives; endless cycle of rewriting.' },
                'Circle of Inevitability': { outcome: 'LOSS', diff: 'Extreme', reason: 'Every script, every narrative, every mental construct is already part of the cycle.' },
                'Primordial Hunger': { outcome: 'LOSS', diff: 'Extreme', reason: 'Hunger has no mind to control; it consumes thought itself.' },
                'Supernova Dominator': { outcome: 'LOSS', diff: 'Extreme', reason: 'Stellar processes have no consciousness; mental authority is utterly irrelevant.' },
                'Inextinguishable Ravings': { outcome: 'DRAW', diff: 'Extreme', reason: 'Mental domain meets mental domain; Visionary resists but cannot silence eternal whispers.' },
                'Monarch of Decay': { outcome: 'LOSS', diff: 'Extreme', reason: 'Even thoughts decay; mental constructs crumble under universal entropy.' },
                'High-Dimensional Overseer': { outcome: 'LOSS', diff: 'Extreme', reason: 'Overseer\'s perspective encompasses all mental realities; Visionary\'s domain is a subset.' },
                'Goddess of Fate': { outcome: 'LOSS', diff: 'Extreme', reason: 'Every vision, every script, every narrative was already written in fate.' }
            },
            'White Tower': {
                'Mother Goddess of Depravity': { outcome: 'LOSS', diff: 'Extreme', reason: 'Knowledge of corruption cannot prevent it; understanding depravity leads to falling into it.' },
                'Mother Tree of Desire': { outcome: 'LOSS', diff: 'Extreme', reason: 'Every calculated loophole reveals new desires; analysis creates more exploitable wishes.' },
                'Son of Chaos': { outcome: 'LOSS', diff: 'Extreme', reason: 'True chaos is fundamentally unanalyzable; randomness defeats all prediction.' },
                'Circle of Inevitability': { outcome: 'LOSS', diff: 'Extreme', reason: 'Mathematics describes cycles but cannot escape them; knowledge is part of inevitability.' },
                'Primordial Hunger': { outcome: 'LOSS', diff: 'Extreme', reason: 'Knowledge is consumable; calculations are devoured alongside the calculator.' },
                'Supernova Dominator': { outcome: 'LOSS', diff: 'Extreme', reason: 'Understanding stellar physics cannot prevent stellar destruction; scale defeats knowledge.' },
                'Inextinguishable Ravings': { outcome: 'LOSS', diff: 'Extreme', reason: 'Perfect analysis requires forbidden knowledge; knowing everything means madness.' },
                'Monarch of Decay': { outcome: 'LOSS', diff: 'Extreme', reason: 'Knowledge decays; all calculations eventually become meaningless under entropy.' },
                'High-Dimensional Overseer': { outcome: 'LOSS', diff: 'Extreme', reason: 'Tower\'s knowledge is infinitely exceeded by dimensional omniscience.' },
                'Goddess of Fate': { outcome: 'LOSS', diff: 'Extreme', reason: 'Every calculation, every analysis, every insight was fated to be discovered.' }
            },
            'Sun': {
                'Mother Goddess of Depravity': { outcome: 'DRAW', diff: 'Extreme', reason: 'Holy light resists corruption fiercely; but full depravity domain eventually dims all radiance.' },
                'Mother Tree of Desire': { outcome: 'LOSS', diff: 'Extreme', reason: 'Even holy beings have desires; light cannot purify infinite temptation.' },
                'Son of Chaos': { outcome: 'LOSS', diff: 'Extreme', reason: 'Light imposes order but full chaos dissolves all structure; illumination cannot organize the formless.' },
                'Circle of Inevitability': { outcome: 'LOSS', diff: 'Extreme', reason: 'Suns rise and set in cycles; light is bound to inevitability\'s wheel.' },
                'Primordial Hunger': { outcome: 'LOSS', diff: 'Extreme', reason: 'Even light can be devoured by absolute hunger; primordial consumption exceeds radiance.' },
                'Supernova Dominator': { outcome: 'LOSS', diff: 'Extreme', reason: 'Sun pathway is subset of stellar authority; Dominator commands all suns.' },
                'Inextinguishable Ravings': { outcome: 'DRAW', diff: 'Extreme', reason: 'Holy clarity resists madness strongly; but eternal whispers cannot be fully silenced by light.' },
                'Monarch of Decay': { outcome: 'LOSS', diff: 'Extreme', reason: 'Even stars die; light eventually fades under universal entropy.' },
                'High-Dimensional Overseer': { outcome: 'LOSS', diff: 'Extreme', reason: 'Light exists in three dimensions; Overseer transcends from infinite angles.' },
                'Goddess of Fate': { outcome: 'LOSS', diff: 'Extreme', reason: 'Every sunrise, every ray of light, follows threads woven by fate.' }
            },
            'Tyrant': {
                'Mother Goddess of Depravity': { outcome: 'LOSS', diff: 'Extreme', reason: 'Storms cannot purify absolute corruption; depravity taints the winds themselves.' },
                'Mother Tree of Desire': { outcome: 'LOSS', diff: 'Extreme', reason: 'Catastrophe destroys branches but roots run infinitely deep; desire regenerates.' },
                'Son of Chaos': { outcome: 'DRAW', diff: 'Extreme', reason: 'Storm is controlled chaos meeting true chaos; destruction mirrors destruction endlessly.' },
                'Circle of Inevitability': { outcome: 'LOSS', diff: 'Extreme', reason: 'Every storm, every catastrophe, is part of inevitable cycles.' },
                'Primordial Hunger': { outcome: 'LOSS', diff: 'Extreme', reason: 'Absolute hunger consumes even weather patterns; storms are devoured.' },
                'Supernova Dominator': { outcome: 'LOSS', diff: 'Extreme', reason: 'Planetary weather is infinitely exceeded by stellar catastrophes.' },
                'Inextinguishable Ravings': { outcome: 'LOSS', diff: 'Extreme', reason: 'Eternal whispers persist through any storm; madness outlasts thunder.' },
                'Monarch of Decay': { outcome: 'LOSS', diff: 'Extreme', reason: 'Storms delay but cannot stop universal entropy; all weather fades.' },
                'High-Dimensional Overseer': { outcome: 'LOSS', diff: 'Extreme', reason: 'Weather exists in three dimensions; Overseer commands from beyond.' },
                'Goddess of Fate': { outcome: 'LOSS', diff: 'Extreme', reason: 'Every storm\'s path, every lightning strike, follows fate\'s design.' }
            },
            'Hanged Man': {
                'Mother Goddess of Depravity': { outcome: 'LOSS', diff: 'Extreme', reason: 'Blood corruption is subset of total depravity; flesh distortion encompasses all blood manipulation.' },
                'Mother Tree of Desire': { outcome: 'LOSS', diff: 'Extreme', reason: 'Every sacrifice creates new desires; blood cannot satisfy infinite wishing.' },
                'Son of Chaos': { outcome: 'LOSS', diff: 'Extreme', reason: 'Blood rituals require order; true chaos dissolves sacrificial structure.' },
                'Circle of Inevitability': { outcome: 'LOSS', diff: 'Extreme', reason: 'Life, death, and blood eternally cycle on fate\'s wheel.' },
                'Primordial Hunger': { outcome: 'LOSS', diff: 'Extreme', reason: 'Blood is merely food; corruption cannot sate absolute hunger.' },
                'Supernova Dominator': { outcome: 'LOSS', diff: 'Extreme', reason: 'Blood evaporates instantly in stellar fire; shadows vanish utterly.' },
                'Inextinguishable Ravings': { outcome: 'LOSS', diff: 'Extreme', reason: 'Blood carries madness but eternal whispers transcend any transmission method.' },
                'Monarch of Decay': { outcome: 'LOSS', diff: 'Extreme', reason: 'All blood rots; decay is patient and absolute.' },
                'High-Dimensional Overseer': { outcome: 'LOSS', diff: 'Extreme', reason: 'Blood exists in physical dimensions; Overseer transcends utterly.' },
                'Goddess of Fate': { outcome: 'LOSS', diff: 'Extreme', reason: 'Every drop of blood that falls follows threads of destiny.' }
            },
            'Darkness': {
                'Mother Goddess of Depravity': { outcome: 'LOSS', diff: 'Extreme', reason: 'Concealment cannot hide from corruption that exists within; depravity finds darkness.' },
                'Mother Tree of Desire': { outcome: 'LOSS', diff: 'Extreme', reason: 'Dreams birth desires; sleep opens the mind to infinite temptation.' },
                'Son of Chaos': { outcome: 'DRAW', diff: 'Extreme', reason: 'Darkness and chaos coexist in the void; neither fully contains the other.' },
                'Circle of Inevitability': { outcome: 'LOSS', diff: 'Extreme', reason: 'Night follows day on fate\'s wheel; darkness is bound to cycles.' },
                'Primordial Hunger': { outcome: 'LOSS', diff: 'Extreme', reason: 'Absolute hunger finds all prey; nothing can hide from primordial consumption.' },
                'Supernova Dominator': { outcome: 'LOSS', diff: 'Extreme', reason: 'Stellar radiance is absolute; darkness cannot exist where full light shines.' },
                'Inextinguishable Ravings': { outcome: 'DRAW', diff: 'Extreme', reason: 'Sleep resists madness but dreams carry whispers; darkness and ravings coexist.' },
                'Monarch of Decay': { outcome: 'LOSS', diff: 'Extreme', reason: 'Darkness decays into nothingness; even shadows fade under universal entropy.' },
                'High-Dimensional Overseer': { outcome: 'LOSS', diff: 'Extreme', reason: 'Dimensional sight pierces all darkness; concealment is impossible.' },
                'Goddess of Fate': { outcome: 'LOSS', diff: 'Extreme', reason: 'Fate sees through all darkness; every shadow was always part of the design.' }
            },
            'Death': {
                'Mother Goddess of Depravity': { outcome: 'LOSS', diff: 'Extreme', reason: 'Full depravity corrupts death itself; the dead rise as depraved abominations.' },
                'Mother Tree of Desire': { outcome: 'LOSS', diff: 'Extreme', reason: 'Even the dead can desire; Tree\'s roots reach into the afterlife.' },
                'Son of Chaos': { outcome: 'DRAW', diff: 'Extreme', reason: 'Death creates order through ending; chaos undoes endings. Eternal opposition.' },
                'Circle of Inevitability': { outcome: 'LOSS', diff: 'Extreme', reason: 'Death is the central spoke of fate\'s wheel; all die within inevitability.' },
                'Primordial Hunger': { outcome: 'DRAW', diff: 'Extreme', reason: 'Hunger devours death; death ends hunger. Neither can fully claim the other.' },
                'Supernova Dominator': { outcome: 'LOSS', diff: 'Extreme', reason: 'Stars transcend death; stellar matter transforms but never truly dies.' },
                'Inextinguishable Ravings': { outcome: 'LOSS', diff: 'Extreme', reason: 'Madness survives death; whispers echo through the afterlife eternally.' },
                'Monarch of Decay': { outcome: 'DRAW', diff: 'Extreme', reason: 'Death and decay are intertwined; neither dominates the other.' },
                'High-Dimensional Overseer': { outcome: 'LOSS', diff: 'Extreme', reason: 'Death is three-dimensional transition; Overseer exists beyond mortality.' },
                'Goddess of Fate': { outcome: 'LOSS', diff: 'Extreme', reason: 'Every death was written; mortality operates within fate\'s framework.' }
            },
            'Twilight Giant': {
                'Mother Goddess of Depravity': { outcome: 'LOSS', diff: 'Extreme', reason: 'Physical resilience fails against absolute corruption; giant flesh is corrupted from within.' },
                'Mother Tree of Desire': { outcome: 'LOSS', diff: 'Extreme', reason: 'Even giants desire; massive bodies contain massive temptations to exploit.' },
                'Son of Chaos': { outcome: 'LOSS', diff: 'Extreme', reason: 'Physical stability cannot anchor against true formlessness; chaos dissolves all mass.' },
                'Circle of Inevitability': { outcome: 'LOSS', diff: 'Extreme', reason: 'Giants age and die on fate\'s wheel; inevitability claims all flesh.' },
                'Primordial Hunger': { outcome: 'LOSS', diff: 'Extreme', reason: 'Giant mass is merely more food; physical bodies are infinitely consumable.' },
                'Supernova Dominator': { outcome: 'LOSS', diff: 'Extreme', reason: 'Physical mass is vaporized by stellar forces; giants are less than dust.' },
                'Inextinguishable Ravings': { outcome: 'LOSS', diff: 'Extreme', reason: 'Giant minds can be broken; physical strength cannot defend against madness.' },
                'Monarch of Decay': { outcome: 'LOSS', diff: 'Extreme', reason: 'Giant decay is subset of universal entropy; Monarch\'s domain encompasses all rot.' },
                'High-Dimensional Overseer': { outcome: 'LOSS', diff: 'Extreme', reason: 'Physical strength is meaningless in higher dimensions; giants cannot even perceive the threat.' },
                'Goddess of Fate': { outcome: 'LOSS', diff: 'Extreme', reason: 'Every giant\'s step was predetermined; strength operates within fate\'s design.' }
            },
            'Red Priest': {
                'Mother Goddess of Depravity': { outcome: 'LOSS', diff: 'Extreme', reason: 'War fire cannot purify absolute corruption; flames themselves become depraved.' },
                'Mother Tree of Desire': { outcome: 'LOSS', diff: 'Extreme', reason: 'Burning roots just creates new desires; war cannot destroy infinite wishing.' },
                'Son of Chaos': { outcome: 'DRAW', diff: 'Extreme', reason: 'War is organized destruction meeting formless destruction; mutual annihilation.' },
                'Circle of Inevitability': { outcome: 'LOSS', diff: 'Extreme', reason: 'War eternally cycles; every battle feeds fate\'s wheel.' },
                'Primordial Hunger': { outcome: 'LOSS', diff: 'Extreme', reason: 'Fire is energy; energy is consumable. Hunger devours all flames.' },
                'Supernova Dominator': { outcome: 'LOSS', diff: 'Extreme', reason: 'Planetary fire is infinitely exceeded by stellar furnaces.' },
                'Inextinguishable Ravings': { outcome: 'LOSS', diff: 'Extreme', reason: 'War madness feeds the whispers; destruction amplifies ravings.' },
                'Monarch of Decay': { outcome: 'LOSS', diff: 'Extreme', reason: 'All fire eventually burns out; entropy claims every flame.' },
                'High-Dimensional Overseer': { outcome: 'LOSS', diff: 'Extreme', reason: 'War exists in three dimensions; Overseer commands from beyond all battlefields.' },
                'Goddess of Fate': { outcome: 'LOSS', diff: 'Extreme', reason: 'Every war\'s outcome was predetermined; battles follow fate\'s threads.' }
            },
            'Demoness': {
                'Mother Goddess of Depravity': { outcome: 'LOSS', diff: 'Extreme', reason: 'Demoness corruption is subset of total depravity; seduction is absorbed by larger corruption.' },
                'Mother Tree of Desire': { outcome: 'DRAW', diff: 'Extreme', reason: 'Both exploit desire; seduction and temptation intertwine without resolution.' },
                'Son of Chaos': { outcome: 'DRAW', diff: 'Extreme', reason: 'Calamity and chaos fuel each other; destruction creates more destruction.' },
                'Circle of Inevitability': { outcome: 'LOSS', diff: 'Extreme', reason: 'All calamities cycle on fate\'s wheel; Demoness power feeds inevitability.' },
                'Primordial Hunger': { outcome: 'LOSS', diff: 'Extreme', reason: 'Beauty and plague are equally consumable; seduction cannot escape hunger.' },
                'Supernova Dominator': { outcome: 'LOSS', diff: 'Extreme', reason: 'Stellar light reveals all disguises; no seduction survives divine radiance.' },
                'Inextinguishable Ravings': { outcome: 'LOSS', diff: 'Extreme', reason: 'Madness cannot be seduced; eternal whispers transcend desire.' },
                'Monarch of Decay': { outcome: 'DRAW', diff: 'Extreme', reason: 'Plague and decay accelerate each other; mutual amplification without victor.' },
                'High-Dimensional Overseer': { outcome: 'LOSS', diff: 'Extreme', reason: 'Seduction requires desire; Overseer perceives without wanting.' },
                'Goddess of Fate': { outcome: 'LOSS', diff: 'Extreme', reason: 'Every seduction was predetermined; beauty operates within fate\'s design.' }
            },
            'Justiciar': {
                'Mother Goddess of Depravity': { outcome: 'LOSS', diff: 'Extreme', reason: 'Law cannot prohibit absolute corruption; depravity transcends all regulations.' },
                'Mother Tree of Desire': { outcome: 'LOSS', diff: 'Extreme', reason: 'Infinite contracts exist beyond legal frameworks; desire escapes all regulation.' },
                'Son of Chaos': { outcome: 'LOSS', diff: 'Extreme', reason: 'True chaos recognizes no law; formlessness cannot be regulated.' },
                'Circle of Inevitability': { outcome: 'LOSS', diff: 'Extreme', reason: 'Fate is the ultimate law; Justiciar merely enforces what inevitability permits.' },
                'Primordial Hunger': { outcome: 'LOSS', diff: 'Extreme', reason: 'Hunger obeys no prohibition; consumption transcends all legal shields.' },
                'Supernova Dominator': { outcome: 'LOSS', diff: 'Extreme', reason: 'Stars obey physics, not judges; cosmic forces ignore mortal law.' },
                'Inextinguishable Ravings': { outcome: 'LOSS', diff: 'Extreme', reason: 'Madness recognizes no law; whispers cannot be prohibited out of existence.' },
                'Monarch of Decay': { outcome: 'LOSS', diff: 'Extreme', reason: 'Entropy cannot be regulated; universal decay ignores all protection zones.' },
                'High-Dimensional Overseer': { outcome: 'LOSS', diff: 'Extreme', reason: 'Law is dimensional construct; Overseer transcends all legal frameworks.' },
                'Goddess of Fate': { outcome: 'LOSS', diff: 'Extreme', reason: 'Fate writes the law; every judgment was predetermined.' }
            },
            'Black Emperor': {
                'Mother Goddess of Depravity': { outcome: 'LOSS', diff: 'Extreme', reason: 'Cannot distort absolute corruption; depravity twists the distorter.' },
                'Mother Tree of Desire': { outcome: 'LOSS', diff: 'Extreme', reason: 'Infinite wishes find all loopholes; distortion cannot confuse infinite desire.' },
                'Son of Chaos': { outcome: 'DRAW', diff: 'Extreme', reason: 'Distortion and chaos fuel each other; both embody disorder differently.' },
                'Circle of Inevitability': { outcome: 'LOSS', diff: 'Extreme', reason: 'Every distortion is part of fate\'s pattern; deception was always planned.' },
                'Primordial Hunger': { outcome: 'LOSS', diff: 'Extreme', reason: 'Hunger finds true targets regardless of distortion; consumption cannot be misdirected.' },
                'Supernova Dominator': { outcome: 'LOSS', diff: 'Extreme', reason: 'Stellar light reveals all truth; no distortion survives divine radiance.' },
                'Inextinguishable Ravings': { outcome: 'DRAW', diff: 'Extreme', reason: 'Distortion vs delusion; both corrupt reality without defeating each other.' },
                'Monarch of Decay': { outcome: 'DRAW', diff: 'Extreme', reason: 'Distortion delays entropy but entropy warps distortion; mutual interference.' },
                'High-Dimensional Overseer': { outcome: 'LOSS', diff: 'Extreme', reason: 'Overseer perceives true geometry from all angles; distortion is transparent.' },
                'Goddess of Fate': { outcome: 'LOSS', diff: 'Extreme', reason: 'All lies were written in fate; distortion follows predetermined threads.' }
            },
            'Hermit': {
                'Mother Goddess of Depravity': { outcome: 'LOSS', diff: 'Extreme', reason: 'Secret knowledge cannot ward against absolute corruption; magic runes become corrupted.' },
                'Mother Tree of Desire': { outcome: 'LOSS', diff: 'Extreme', reason: 'Seeking knowledge is desire; every secret reveals more wishes to exploit.' },
                'Son of Chaos': { outcome: 'DRAW', diff: 'Extreme', reason: 'Magic imposes order but chaos dissolves ritual structure; endless reweaving.' },
                'Circle of Inevitability': { outcome: 'LOSS', diff: 'Extreme', reason: 'All magical cycles feed fate\'s wheel; knowledge is part of inevitability.' },
                'Primordial Hunger': { outcome: 'LOSS', diff: 'Extreme', reason: 'Knowledge is consumable; hunger devours information and its keeper.' },
                'Supernova Dominator': { outcome: 'LOSS', diff: 'Extreme', reason: 'Stellar light burns away magical shadows; rituals fail in divine radiance.' },
                'Inextinguishable Ravings': { outcome: 'DRAW', diff: 'Extreme', reason: 'Secret vs forbidden knowledge; both are dangerous truths that cannot overcome each other.' },
                'Monarch of Decay': { outcome: 'DRAW', diff: 'Extreme', reason: 'Preservation magic resists but cannot stop universal entropy; secrets fade slowly.' },
                'High-Dimensional Overseer': { outcome: 'LOSS', diff: 'Extreme', reason: 'No secrets exist from dimensional omniscience; all knowledge is exposed.' },
                'Goddess of Fate': { outcome: 'LOSS', diff: 'Extreme', reason: 'Every secret discovery was predetermined; knowledge follows fate\'s threads.' }
            },
            'Paragon': {
                'Mother Goddess of Depravity': { outcome: 'LOSS', diff: 'Extreme', reason: 'Absolute corruption infects all systems; machines become depraved abominations.' },
                'Mother Tree of Desire': { outcome: 'LOSS', diff: 'Extreme', reason: 'Creators desire; their wishes corrupt the machines they build.' },
                'Son of Chaos': { outcome: 'LOSS', diff: 'Extreme', reason: 'True chaos dissolves all structure; systems cannot organize formlessness.' },
                'Circle of Inevitability': { outcome: 'LOSS', diff: 'Extreme', reason: 'All machines break on fate\'s wheel; technology cycles through obsolescence.' },
                'Primordial Hunger': { outcome: 'LOSS', diff: 'Extreme', reason: 'Matter is consumable; machines are merely organized food.' },
                'Supernova Dominator': { outcome: 'LOSS', diff: 'Extreme', reason: 'Stellar radiation destroys all technology; cosmic EMP is absolute.' },
                'Inextinguishable Ravings': { outcome: 'LOSS', diff: 'Extreme', reason: 'AI can go mad; eternal whispers corrupt machine logic.' },
                'Monarch of Decay': { outcome: 'LOSS', diff: 'Extreme', reason: 'All machines rust and corrode; universal entropy claims all technology.' },
                'High-Dimensional Overseer': { outcome: 'LOSS', diff: 'Extreme', reason: 'Technology exists in three dimensions; Overseer transcends all physical systems.' },
                'Goddess of Fate': { outcome: 'LOSS', diff: 'Extreme', reason: 'Every machine\'s function was predetermined; technology operates within fate.' }
            },
            'Mother': {
                'Mother Goddess of Depravity': { outcome: 'LOSS', diff: 'Extreme', reason: 'Absolute corruption infects life at its source; growth becomes twisted abomination.' },
                'Mother Tree of Desire': { outcome: 'LOSS', diff: 'Extreme', reason: 'All living things desire; growth creates infinite wishes to exploit.' },
                'Son of Chaos': { outcome: 'DRAW', diff: 'Extreme', reason: 'Life imposes order but chaos dissolves organic structure; endless cycle of growth and dissolution.' },
                'Circle of Inevitability': { outcome: 'LOSS', diff: 'Extreme', reason: 'Birth-death-rebirth eternally cycles; life feeds fate\'s wheel.' },
                'Primordial Hunger': { outcome: 'LOSS', diff: 'Extreme', reason: 'Life is infinitely consumable; growth merely creates more food.' },
                'Supernova Dominator': { outcome: 'LOSS', diff: 'Extreme', reason: 'Stellar radiation sterilizes worlds; life cannot survive cosmic fire.' },
                'Inextinguishable Ravings': { outcome: 'LOSS', diff: 'Extreme', reason: 'Life carries the capacity for madness; eternal whispers corrupt all minds.' },
                'Monarch of Decay': { outcome: 'LOSS', diff: 'Extreme', reason: 'All life decays; universal entropy claims every living thing.' },
                'High-Dimensional Overseer': { outcome: 'LOSS', diff: 'Extreme', reason: 'Life exists in three dimensions; Overseer transcends all biology.' },
                'Goddess of Fate': { outcome: 'LOSS', diff: 'Extreme', reason: 'Every birth, every death, every growth follows fate\'s design.' }
            },
            'Moon': {
                'Mother Goddess of Depravity': { outcome: 'LOSS', diff: 'Extreme', reason: 'Predation instincts easily corrupted; beast flesh becomes depraved abomination.' },
                'Mother Tree of Desire': { outcome: 'LOSS', diff: 'Extreme', reason: 'Predators have the strongest desires; hunger is infinitely exploitable.' },
                'Son of Chaos': { outcome: 'LOSS', diff: 'Extreme', reason: 'True chaos dissolves predator-prey order; hunting cannot structure formlessness.' },
                'Circle of Inevitability': { outcome: 'LOSS', diff: 'Extreme', reason: 'Predator-prey cycles eternally spin; Moon is bound to fate\'s wheel.' },
                'Primordial Hunger': { outcome: 'LOSS', diff: 'Extreme', reason: 'Moon\'s hunger is subset of absolute consumption; devoured by greater appetite.' },
                'Supernova Dominator': { outcome: 'LOSS', diff: 'Extreme', reason: 'Blood evaporates instantly; regeneration is meaningless against stellar fire.' },
                'Inextinguishable Ravings': { outcome: 'LOSS', diff: 'Extreme', reason: 'Beast minds are easily corrupted; instinct twists into madness.' },
                'Monarch of Decay': { outcome: 'LOSS', diff: 'Extreme', reason: 'Blood rots; regeneration cannot outpace universal entropy.' },
                'High-Dimensional Overseer': { outcome: 'LOSS', diff: 'Extreme', reason: 'Predation exists in three dimensions; Overseer transcends all material hunting.' },
                'Goddess of Fate': { outcome: 'LOSS', diff: 'Extreme', reason: 'Every hunt\'s outcome was predetermined; predation follows fate\'s design.' }
            },
            'Chained': {
                'Mother Goddess of Depravity': { outcome: 'LOSS', diff: 'Extreme', reason: 'Cannot bind absolute corruption; chains themselves become corrupted vectors.' },
                'Mother Tree of Desire': { outcome: 'LOSS', diff: 'Extreme', reason: 'Infinite desires escape all restraints; binding creates new wishes.' },
                'Son of Chaos': { outcome: 'DRAW', diff: 'Extreme', reason: 'Chains impose structure but chaos dissolves restraints; endless binding and unbinding.' },
                'Circle of Inevitability': { outcome: 'LOSS', diff: 'Extreme', reason: 'All chains are part of fate\'s pattern; restraint feeds inevitability.' },
                'Primordial Hunger': { outcome: 'DRAW', diff: 'Extreme', reason: 'Chains delay but cannot stop absolute consumption; hunger strains at all bonds.' },
                'Supernova Dominator': { outcome: 'LOSS', diff: 'Extreme', reason: 'Cannot chain stellar forces; stars vaporize all restraints.' },
                'Inextinguishable Ravings': { outcome: 'DRAW', diff: 'Extreme', reason: 'Chains imprison thoughts but whispers seep through all restraints.' },
                'Monarch of Decay': { outcome: 'DRAW', diff: 'Extreme', reason: 'Chains slow decay but all restraints eventually corrode under entropy.' },
                'High-Dimensional Overseer': { outcome: 'LOSS', diff: 'Extreme', reason: 'Chains exist in three dimensions; Overseer transcends all physical restraint.' },
                'Goddess of Fate': { outcome: 'LOSS', diff: 'Extreme', reason: 'Every binding was predetermined; chains follow fate\'s threads.' }
            },
            'Abyss': {
                'Mother Goddess of Depravity': { outcome: 'DRAW', diff: 'Extreme', reason: 'Corruption meets corruption; both taint existence but neither can fully corrupt the other.' },
                'Mother Tree of Desire': { outcome: 'DRAW', diff: 'Extreme', reason: 'Abyss poisons wishes while desire exploits malice; mutual corruption.' },
                'Son of Chaos': { outcome: 'DRAW', diff: 'Extreme', reason: 'Abyss malice and formless chaos both destroy; different flavors of annihilation.' },
                'Circle of Inevitability': { outcome: 'LOSS', diff: 'Extreme', reason: 'Corruption cycles eternally; Abyss feeds fate\'s wheel of suffering.' },
                'Primordial Hunger': { outcome: 'DRAW', diff: 'Extreme', reason: 'Hunger and malice compete endlessly; both consume existence differently.' },
                'Supernova Dominator': { outcome: 'LOSS', diff: 'Extreme', reason: 'Stellar purity burns all corruption; divine light defeats the abyss.' },
                'Inextinguishable Ravings': { outcome: 'DRAW', diff: 'Extreme', reason: 'Corruption and madness intertwine; both taint minds without victor.' },
                'Monarch of Decay': { outcome: 'DRAW', diff: 'Extreme', reason: 'Corruption accelerates decay while decay spreads corruption; mutual amplification.' },
                'High-Dimensional Overseer': { outcome: 'LOSS', diff: 'Extreme', reason: 'Abyss is dimensional pit; Overseer transcends all depths from above.' },
                'Goddess of Fate': { outcome: 'LOSS', diff: 'Extreme', reason: 'All corruption follows predetermined paths; malice operates within fate.' }
            },
            'Wheel of Fortune': {
                'Mother Goddess of Depravity': { outcome: 'DRAW', diff: 'Extreme', reason: 'Fortune and corruption play endless dice; lucky escapes matched by corrupted luck.' },
                'Mother Tree of Desire': { outcome: 'DRAW', diff: 'Extreme', reason: 'Fortunate contract terms but infinite wishes find unlucky moments; endless gamble.' },
                'Son of Chaos': { outcome: 'DRAW', diff: 'Extreme', reason: 'Luck is structured randomness meeting pure randomness; fortune cannot order true chaos.' },
                'Circle of Inevitability': { outcome: 'DRAW', diff: 'Extreme', reason: 'Same Sefirah (Key of Light); fortune and cycles are intertwined aspects of fate.' },
                'Primordial Hunger': { outcome: 'DRAW', diff: 'Extreme', reason: 'Lucky misses but hunger is patient; fortune delays but cannot escape consumption.' },
                'Supernova Dominator': { outcome: 'LOSS', diff: 'Extreme', reason: 'Stars have no luck to manipulate; stellar processes ignore fortune entirely.' },
                'Inextinguishable Ravings': { outcome: 'DRAW', diff: 'Extreme', reason: 'Fortunate clarity versus eternal whispers; luck preserves sanity but cannot silence madness.' },
                'Monarch of Decay': { outcome: 'DRAW', diff: 'Extreme', reason: 'Fortune slows personal entropy but cannot stop universal decay; lucky delays.' },
                'High-Dimensional Overseer': { outcome: 'LOSS', diff: 'Extreme', reason: 'Probability is meaningless in higher dimensions; Overseer transcends luck itself.' },
                'Goddess of Fate': { outcome: 'DRAW', diff: 'Extreme', reason: 'Same Sefirah (Key of Light); luck and fate are two faces of the same coin.' }
            }
        };

        // ============================================
        // INNER GOD VS OUTER DEITY MATCHUPS (Extremely Rare)
        // ============================================
        const INNER_GOD_VS_OUTER_DEITY_MATCHUPS = {
            'God Almighty': {
                'Mother Goddess of Depravity': { outcome: 'WIN', diff: 'Mid', reason: 'Divine authority purifies all corruption; the Almighty\'s light burns depravity to nothing.' },
                'Mother Tree of Desire': { outcome: 'WIN', diff: 'Mid', reason: 'All desires bow before the supreme will; contracts are meaningless to God.' },
                'Son of Chaos': { outcome: 'WIN', diff: 'Low', reason: 'Divine order dominates chaos absolutely; God Almighty defines reality itself.' },
                'Circle of Inevitability': { outcome: 'WIN', diff: 'High', reason: 'God Almighty transcends cycles; even fate bows before the supreme deity.' },
                'Primordial Hunger': { outcome: 'WIN', diff: 'Mid', reason: 'The infinite cannot be consumed; divine radiance outlasts all hunger.' },
                'Supernova Dominator': { outcome: 'WIN', diff: 'High', reason: 'God Almighty commands stars; stellar authority is merely one aspect of divinity.' },
                'Inextinguishable Ravings': { outcome: 'WIN', diff: 'Low', reason: 'Divine clarity annihilates all madness; truth banishes delusion.' },
                'Monarch of Decay': { outcome: 'WIN', diff: 'Mid', reason: 'Eternal divinity transcends entropy; God Almighty exists beyond decay.' },
                'High-Dimensional Overseer': { outcome: 'WIN', diff: 'High', reason: 'God Almighty exists across all dimensions simultaneously; no perspective exceeds divinity.' },
                'Goddess of Fate': { outcome: 'DRAW', diff: 'Extreme', reason: 'Two aspects of ultimate authority; God Almighty and Fate are intertwined at the highest level.' }
            },
            'Lord of the Mysteries': {
                'Mother Goddess of Depravity': { outcome: 'WIN', diff: 'Mid', reason: 'The Lord steals depravity\'s essence through Error; corruption becomes just another mask to wear.' },
                'Mother Tree of Desire': { outcome: 'WIN', diff: 'Mid', reason: 'All contracts are mysteries the Lord can unravel; desire cannot bind the master of secrets.' },
                'Son of Chaos': { outcome: 'WIN', diff: 'Low', reason: 'Chaos is merely one mystery among infinite; the Lord defines and controls the unknown.' },
                'Circle of Inevitability': { outcome: 'WIN', diff: 'High', reason: 'The Lord transcends cycles through the Door; inevitability cannot track what exists everywhere and nowhere.' },
                'Primordial Hunger': { outcome: 'WIN', diff: 'Mid', reason: 'Hunger cannot consume mystery itself; the Lord exists beyond comprehension and consumption.' },
                'Supernova Dominator': { outcome: 'WIN', diff: 'High', reason: 'Stars illuminate but the Lord IS the shadow they cast; light only deepens mystery.' },
                'Inextinguishable Ravings': { outcome: 'WIN', diff: 'Low', reason: 'Madness is the Fool\'s playground; the Lord dances in insanity without losing himself.' },
                'Monarch of Decay': { outcome: 'WIN', diff: 'Mid', reason: 'Mysteries never truly decay; secrets exist eternally in the Lord\'s domain.' },
                'High-Dimensional Overseer': { outcome: 'WIN', diff: 'High', reason: 'The Lord exists across all dimensions through the Door; no perspective can fully observe mystery.' },
                'Goddess of Fate': { outcome: 'WIN', diff: 'High', reason: 'The Lord of the Mysteries demolished the Goddess; mystery transcends fate itself.' }
            },
            'Eternal Darkness': {
                'Mother Goddess of Depravity': { outcome: 'WIN', diff: 'High', reason: 'In absolute darkness, corruption has no vector; depravity cannot spread where nothing exists.' },
                'Mother Tree of Desire': { outcome: 'WIN', diff: 'High', reason: 'The void has no desires; darkness consumes all wanting.' },
                'Son of Chaos': { outcome: 'WIN', diff: 'Mid', reason: 'Darkness imposes the ultimate order - nothingness; chaos is extinguished.' },
                'Circle of Inevitability': { outcome: 'DRAW', diff: 'Extreme', reason: 'Death is part of the cycle; darkness feeds inevitability endlessly.' },
                'Primordial Hunger': { outcome: 'WIN', diff: 'High', reason: 'Cannot consume what has no existence; the void defeats hunger.' },
                'Supernova Dominator': { outcome: 'LOSS', diff: 'Extreme', reason: 'Stellar radiance is the absolute enemy; even Eternal Darkness cannot fully extinguish a supernova.' },
                'Inextinguishable Ravings': { outcome: 'WIN', diff: 'Mid', reason: 'In darkness, all thoughts cease; death silences even eternal madness.' },
                'Monarch of Decay': { outcome: 'DRAW', diff: 'Extreme', reason: 'Darkness and decay are twin aspects of ending; neither dominates.' },
                'High-Dimensional Overseer': { outcome: 'DRAW', diff: 'Extreme', reason: 'Darkness exists in all dimensions; the void is not limited by perspective.' },
                'Goddess of Fate': { outcome: 'DRAW', diff: 'Extreme', reason: 'Death and darkness are woven into fate itself; they are partners, not enemies.' }
            },
            'Anarchy': {
                'Mother Goddess of Depravity': { outcome: 'WIN', diff: 'High', reason: 'Chaos corrupts corruption; depravity is subverted by paradoxical law.' },
                'Mother Tree of Desire': { outcome: 'WIN', diff: 'High', reason: 'Anarchy nullifies all contracts; desire becomes meaningless in paradox.' },
                'Son of Chaos': { outcome: 'WIN', diff: 'Mid', reason: 'Anarchy is chaos with purpose; structured disorder dominates formless chaos.' },
                'Circle of Inevitability': { outcome: 'DRAW', diff: 'Extreme', reason: 'Anarchy breaks cycles but creates new ones; paradox and inevitability intertwine.' },
                'Primordial Hunger': { outcome: 'WIN', diff: 'High', reason: 'Distortion makes consumption impossible; hunger eats itself in paradox.' },
                'Supernova Dominator': { outcome: 'DRAW', diff: 'Extreme', reason: 'Stellar order meets absolute disorder; cosmic law and anarchy cancel each other out.' },
                'Inextinguishable Ravings': { outcome: 'WIN', diff: 'Mid', reason: 'Anarchy weaponizes madness; chaos subsumes delusion.' },
                'Monarch of Decay': { outcome: 'WIN', diff: 'Mid', reason: 'Paradox reverses entropy; anarchy makes decay rebuild.' },
                'High-Dimensional Overseer': { outcome: 'DRAW', diff: 'Extreme', reason: 'The Overseer sees paradox from all angles but paradox exists in all angles; pattern and anti-pattern coexist.' },
                'Goddess of Fate': { outcome: 'DRAW', diff: 'Extreme', reason: 'Anarchy and fate in eternal conflict; chaos disrupts threads while fate weaves them.' }
            },
            'Key of Light': {
                'Mother Goddess of Depravity': { outcome: 'WIN', diff: 'Mid', reason: 'Absolute fortune denies all corruption; luck itself rejects depravity.' },
                'Mother Tree of Desire': { outcome: 'WIN', diff: 'Mid', reason: 'Fate finds the perfect loophole; every contract is escaped through destiny.' },
                'Son of Chaos': { outcome: 'WIN', diff: 'Low', reason: 'Fate dominates chaos utterly; all randomness follows the Key\'s design.' },
                'Circle of Inevitability': { outcome: 'WIN', diff: 'High', reason: 'The Key of Light IS the authority behind inevitability; Sefirah source dominates manifestation.' },
                'Primordial Hunger': { outcome: 'WIN', diff: 'Mid', reason: 'Fate decrees hunger shall never be satisfied; consumption timing is controlled.' },
                'Supernova Dominator': { outcome: 'DRAW', diff: 'Extreme', reason: 'Stars follow cosmic fate; stellar authority and fate authority are peers.' },
                'Inextinguishable Ravings': { outcome: 'WIN', diff: 'Mid', reason: 'Madness is fated to fail; the Key weaves sanity into destiny.' },
                'Monarch of Decay': { outcome: 'WIN', diff: 'Mid', reason: 'Fate postpones all decay; entropy waits upon destiny\'s pleasure.' },
                'High-Dimensional Overseer': { outcome: 'DRAW', diff: 'Extreme', reason: 'Dimensional transcendence exists outside fate; neither can fully control the other.' },
                'Goddess of Fate': { outcome: 'WIN', diff: 'High', reason: 'The Key of Light is the source; the Goddess is merely an expression of its authority.' }
            },
            'Father of Devils': {
                'Mother Goddess of Depravity': { outcome: 'DRAW', diff: 'Extreme', reason: 'Two lords of corruption; abyssal malice meets depraved flesh in eternal stalemate.' },
                'Mother Tree of Desire': { outcome: 'WIN', diff: 'High', reason: 'Devils are masters of contracts; the Father claims all bargains for himself.' },
                'Son of Chaos': { outcome: 'WIN', diff: 'Mid', reason: 'Abyssal order dominates chaos; hell has strict hierarchies.' },
                'Circle of Inevitability': { outcome: 'DRAW', diff: 'Extreme', reason: 'Devils are eternal; the wheel turns but the abyss remains constant beneath it.' },
                'Primordial Hunger': { outcome: 'DRAW', diff: 'Extreme', reason: 'Infernal corruption and primordial hunger compete; both consume existence.' },
                'Supernova Dominator': { outcome: 'LOSS', diff: 'High', reason: 'Stellar purity burns even the Father; divine light is the eternal enemy of devils.' },
                'Inextinguishable Ravings': { outcome: 'WIN', diff: 'Mid', reason: 'Devils thrive on madness; the Father harvests corrupted minds.' },
                'Monarch of Decay': { outcome: 'DRAW', diff: 'Extreme', reason: 'Corruption and decay feed each other; infernal entropy spirals endlessly.' },
                'High-Dimensional Overseer': { outcome: 'DRAW', diff: 'Extreme', reason: 'The abyss exists in all dimensions as a concept; evil transcends perspective.' },
                'Goddess of Fate': { outcome: 'DRAW', diff: 'Extreme', reason: 'Devils predate fate itself; the Father exists outside destiny\'s weave as temptation incarnate.' }
            },
            'Demon of Knowledge': {
                'Mother Goddess of Depravity': { outcome: 'WIN', diff: 'High', reason: 'Knowledge of corruption is power over it; the Demon understands depravity\'s every weakness.' },
                'Mother Tree of Desire': { outcome: 'WIN', diff: 'High', reason: 'Perfect knowledge finds perfect loopholes; every contract has an escape clause the Demon knows.' },
                'Son of Chaos': { outcome: 'WIN', diff: 'Mid', reason: 'Even chaos follows patterns the Demon perceives; knowledge imposes structure.' },
                'Circle of Inevitability': { outcome: 'DRAW', diff: 'Extreme', reason: 'The Demon knows the cycle but cannot escape it; knowledge of fate is not freedom from it.' },
                'Primordial Hunger': { outcome: 'WIN', diff: 'High', reason: 'The Demon knows how to be unknowable; hunger cannot consume what it cannot perceive.' },
                'Supernova Dominator': { outcome: 'DRAW', diff: 'Extreme', reason: 'Stellar physics is comprehensible; the Demon understands stars but cannot command them.' },
                'Inextinguishable Ravings': { outcome: 'DRAW', diff: 'Extreme', reason: 'Forbidden knowledge vs forbidden knowledge; the Demon risks madness for every truth.' },
                'Monarch of Decay': { outcome: 'WIN', diff: 'High', reason: 'Knowledge of preservation defeats entropy; the Demon calculates immortality.' },
                'High-Dimensional Overseer': { outcome: 'DRAW', diff: 'Extreme', reason: 'The Demon comprehends dimensional theory; knowledge spans all perspectives even if it cannot occupy them.' },
                'Goddess of Fate': { outcome: 'DRAW', diff: 'Extreme', reason: 'The Demon knows fate\'s weave completely; knowledge and destiny exist in mutual understanding.' }
            },
            'Calamity of Destruction': {
                'Mother Goddess of Depravity': { outcome: 'WIN', diff: 'High', reason: 'Calamity purges depravity through annihilation; nothing corrupt survives total destruction.' },
                'Mother Tree of Desire': { outcome: 'WIN', diff: 'High', reason: 'Destruction nullifies all contracts; you cannot desire what no longer exists.' },
                'Son of Chaos': { outcome: 'WIN', diff: 'Mid', reason: 'Calamity is focused chaos; directed destruction overwhelms formless disorder.' },
                'Circle of Inevitability': { outcome: 'DRAW', diff: 'Extreme', reason: 'Destruction is part of every cycle; calamity feeds inevitability as inevitability ensures calamity.' },
                'Primordial Hunger': { outcome: 'DRAW', diff: 'Extreme', reason: 'Hunger consumes but calamity destroys; both reduce existence to nothing through different means.' },
                'Supernova Dominator': { outcome: 'DRAW', diff: 'Extreme', reason: 'Stellar destruction meets apocalyptic ruin; two forces of cosmic annihilation cancel each other.' },
                'Inextinguishable Ravings': { outcome: 'WIN', diff: 'Mid', reason: 'Madness burns in calamity\'s fire; plague and war silence even eternal screaming.' },
                'Monarch of Decay': { outcome: 'WIN', diff: 'Mid', reason: 'Calamity accelerates decay infinitely; destruction is entropy\'s final form.' },
                'High-Dimensional Overseer': { outcome: 'DRAW', diff: 'Extreme', reason: 'Destruction exists in all dimensions; the Overseer sees calamity from every angle but cannot prevent it.' },
                'Goddess of Fate': { outcome: 'DRAW', diff: 'Extreme', reason: 'Calamity is woven into fate itself; destruction and destiny dance eternally.' }
            }
        };

        // ============================================
        // CARD WEIGHTING SYSTEM
        // ============================================
        const HISTORY_SIZE = 9; // Track last 9 cards (3 full hands)
        const FRESH_WEIGHT = 10;
        const SEEN_WEIGHT_DECAY = 0.25; // Each recent appearance reduces weight significantly

        // Power ratings based on win/loss ratios from matchup data
        // Higher number = stronger card = appears LESS often
        const POWER_RATINGS = {
            'Fool': 0.90,       // S-tier: wins almost everything
            'Error': 0.85,      // S-tier: steals everything
            'Visionary': 0.80,  // S-tier: mind control dominates
            'Door': 0.75,       // A-tier: great mobility
            'Darkness': 0.70,   // A-tier: concealment is strong
            'Justiciar': 0.65,  // A-tier: prohibitions are powerful
            'Sun': 0.60,        // B-tier: solid purification
            'White Tower': 0.55,// B-tier: good analysis
            'Tyrant': 0.50,     // B-tier: AOE pressure
            'Hanged Man': 0.45, // B-tier: corruption tools
            'Red Priest': 0.45, // B-tier: war pressure
            'Death': 0.40,      // C-tier: state control but many counters
            'Black Emperor': 0.40, // C-tier: distortion is flexible but counterable
            'Abyss': 0.35,      // C-tier: corruption but loses to many
            'Chained': 0.35,    // C-tier: restraint struggles
            'Hermit': 0.30,     // D-tier: magic is interruptible
            'Twilight Giant': 0.30, // D-tier: tank gets kited
            'Demoness': 0.25,   // D-tier: many hard counters
            'Mother': 0.25,     // D-tier: sustain but loses to control
            'Paragon': 0.20,    // D-tier: systems have many counters
            'Moon': 0.15,       // F-tier: regen gets outclassed
            'Wheel of Fortune': 0.30 // C-tier: luck is inconsistent
        };

        let cardHistory = [];

        function getCardWeights() {
            const weights = {};
            const currentPathways = getCurrentPathways();
            const currentPowerRatings = getCurrentPowerRatings();

            currentPathways.forEach(p => {
                // Start with base weight, reduced by power rating
                // Stronger cards (higher rating) get lower base weight
                const powerPenalty = 1 - ((currentPowerRatings[p.name] || 0.5) * 0.7); // 0.7 factor so even top cards still appear
                weights[p.name] = FRESH_WEIGHT * powerPenalty;
            });

            // Further reduce weight for recently seen cards
            cardHistory.forEach((cardName, index) => {
                const recency = (HISTORY_SIZE - index) / HISTORY_SIZE;
                if (weights[cardName]) {
                    weights[cardName] *= Math.pow(SEEN_WEIGHT_DECAY, recency * 2);
                }
            });

            return weights;
        }

        // Sefirah groupings (sister pathways can't appear together in hand)
        const SEFIRAH_GROUPS = {
            'Fool': 'sefirah1',
            'Door': 'sefirah1',
            'Error': 'sefirah1',
            'Visionary': 'sefirah2',
            'White Tower': 'sefirah2',
            'Sun': 'sefirah2',
            'Tyrant': 'sefirah2',
            'Hanged Man': 'sefirah2',
            'Darkness': 'sefirah3',
            'Death': 'sefirah3',
            'Twilight Giant': 'sefirah3',
            'Red Priest': 'sefirah4',
            'Demoness': 'sefirah4',
            'Justiciar': 'sefirah5',
            'Black Emperor': 'sefirah5',
            'Hermit': 'sefirah6',
            'Paragon': 'sefirah6',
            'Mother': 'sefirah7',
            'Moon': 'sefirah7',
            'Chained': 'sefirah8',
            'Abyss': 'sefirah8',
            'Wheel of Fortune': 'sefirah9'
        };

        // Tiered card lists based on low-diff win potential
        // Big Hit List - Cards that frequently get low diff wins (20% draw chance)
        const BIG_HIT_LIST = ['Fool', 'Error', 'Visionary', 'Door', 'Darkness', 'Justiciar'];

        // Medium Hit List - Cards that get mid diff wins often (30% draw chance)
        const MEDIUM_HIT_LIST = ['Sun', 'White Tower', 'Tyrant', 'Hanged Man', 'Red Priest', 'Death', 'Black Emperor'];

        // Low Tier List - Weaker cards, more common (50% draw chance)
        const LOW_TIER_LIST = ['Abyss', 'Chained', 'Hermit', 'Twilight Giant', 'Demoness', 'Mother', 'Paragon', 'Moon', 'Wheel of Fortune'];

        // Tier draw chances
        const TIER_CHANCES = {
            bigHit: 0.10,    // 10% chance
            mediumHit: 0.30, // 30% chance
            lowTier: 0.60    // 60% chance
        };

        // Get Inner God names for filtering (they can't be drawn, only summoned)
        const INNER_GOD_NAMES = new Set(INNER_GODS.map(g => g.name));

        function getRandomFromTier(tierList, usedSefirah, usedCards, sefirahGroups) {
            // Filter to cards not already used, not from used Sefirah, and not Inner Gods
            const available = tierList.filter(name =>
                !usedCards.has(name) &&
                !usedSefirah.has(sefirahGroups[name]) &&
                !INNER_GOD_NAMES.has(name)  // Exclude Inner Gods from drawing
            );
            if (available.length === 0) return null;
            return available[Math.floor(Math.random() * available.length)];
        }

        // Inner Gods are now obtained through the summon system, not random draws

        function getWeightedRandomCards(count) {
            const selected = [];
            const usedSefirah = new Set();
            const usedCards = new Set();
            const currentPathways = getCurrentPathways();
            const currentSefirahGroups = getCurrentSefirahGroups();
            const currentBigHits = getCurrentBigHitList();
            const currentMediumHits = getCurrentMediumHitList();
            const currentLowTier = getCurrentLowTierList();

            for (let i = 0; i < count; i++) {
                let selectedCardName = null;
                let attempts = 0;
                const maxAttempts = 10;

                // Normal pathway drawing
                while (!selectedCardName && attempts < maxAttempts) {
                    attempts++;
                    const roll = Math.random();

                    if (roll < TIER_CHANCES.bigHit) {
                        // 10% - draw from Big Hit List
                        selectedCardName = getRandomFromTier(currentBigHits, usedSefirah, usedCards, currentSefirahGroups);
                    } else if (roll < TIER_CHANCES.bigHit + TIER_CHANCES.mediumHit) {
                        // 30% - draw from Medium Hit List
                        selectedCardName = getRandomFromTier(currentMediumHits, usedSefirah, usedCards, currentSefirahGroups);
                    } else {
                        // 60% - draw from Low Tier List
                        selectedCardName = getRandomFromTier(currentLowTier, usedSefirah, usedCards, currentSefirahGroups);
                    }
                }

                // Fallback: if tier was empty, try any available card
                if (!selectedCardName) {
                    const allLists = [...currentBigHits, ...currentMediumHits, ...currentLowTier];
                    selectedCardName = getRandomFromTier(allLists, usedSefirah, usedCards, currentSefirahGroups);
                }

                if (selectedCardName) {
                    // Find the card in regular pathways
                    const pathway = currentPathways.find(p => p.name === selectedCardName);
                    if (pathway) {
                        selected.push(pathway);
                        usedSefirah.add(currentSefirahGroups[selectedCardName]);
                        usedCards.add(selectedCardName);

                        // Update history for variety
                        cardHistory.unshift(selectedCardName);
                        if (cardHistory.length > HISTORY_SIZE) {
                            cardHistory.pop();
                        }
                    }
                }
            }

            return selected;
        }

        // Separate function for opponent cards (used in inner_vs_outer mode)
        let opponentCardHistory = [];

        function getOpponentWeightedRandomCards(count) {
            const selected = [];
            const usedSefirah = new Set();
            const usedCards = new Set();
            const opponentPathways = getOpponentPathways();
            const opponentSefirahGroups = getOpponentSefirahGroups();
            const opponentBigHits = getOpponentBigHitList();
            const opponentMediumHits = getOpponentMediumHitList();
            const opponentLowTier = getOpponentLowTierList();

            for (let i = 0; i < count; i++) {
                let selectedCardName = null;
                let attempts = 0;
                const maxAttempts = 10;

                while (!selectedCardName && attempts < maxAttempts) {
                    attempts++;
                    const roll = Math.random();

                    if (roll < TIER_CHANCES.bigHit) {
                        selectedCardName = getRandomFromTier(opponentBigHits, usedSefirah, usedCards, opponentSefirahGroups);
                    } else if (roll < TIER_CHANCES.bigHit + TIER_CHANCES.mediumHit) {
                        selectedCardName = getRandomFromTier(opponentMediumHits, usedSefirah, usedCards, opponentSefirahGroups);
                    } else {
                        selectedCardName = getRandomFromTier(opponentLowTier, usedSefirah, usedCards, opponentSefirahGroups);
                    }
                }

                // Fallback: if tier was empty, try any available card
                if (!selectedCardName) {
                    const allLists = [...opponentBigHits, ...opponentMediumHits, ...opponentLowTier];
                    selectedCardName = getRandomFromTier(allLists, usedSefirah, usedCards, opponentSefirahGroups);
                }

                if (selectedCardName) {
                    const pathway = opponentPathways.find(p => p.name === selectedCardName);
                    if (pathway) {
                        selected.push(pathway);
                        usedSefirah.add(opponentSefirahGroups[selectedCardName]);
                        usedCards.add(selectedCardName);

                        // Update opponent history for variety
                        opponentCardHistory.unshift(selectedCardName);
                        if (opponentCardHistory.length > HISTORY_SIZE) {
                            opponentCardHistory.pop();
                        }
                    }
                }
            }

            return selected;
        }

        // ============================================
        // MULTIPLAYER (Firebase)
        // ============================================

        // Multiplayer state (uses shared FIREBASE_CONFIG from top of file)
        let database = null;
        let roomRef = null;
        let gameMode = 'ai';
        let aiDifficulty = localStorage.getItem('pathwayClash_aiDifficulty') || 'medium'; // 'easy', 'medium', 'hard', 'god'
        let gameType = 'pathways'; // 'pathways', 'outer_deities', or 'inner_vs_outer'
        let innerVsOuterPlayerSide = 'pathways'; // 'pathways' (can summon Inner Gods) or 'outer_deities' (play as Outer Deities)
        let tutorialCompleted = localStorage.getItem('pathwayClash_tutorialDone') === 'true';

        // Tutorial Mode State Variables
        let tutorialMode = false;
        let tutorialChapter = parseInt(localStorage.getItem('pathwayClash_tutorialChapter')) || 1;
        let tutorialStep = parseInt(localStorage.getItem('pathwayClash_tutorialStep')) || 0;
        let tutorialRewardsEligible = localStorage.getItem('pathwayClash_tutorialViewed') !== 'skipped';
        let tutorialBeatEasy = localStorage.getItem('pathwayClash_tutorialBeatEasy') === 'true';
        let tutorialBeatMedium = localStorage.getItem('pathwayClash_tutorialBeatMedium') === 'true';
        let tutorialSecretBonus = false;
        let tutorialHighlightedElement = null;
        let tutorialUILocked = false;
        let tutorialForcedAICard = null;
        let tutorialWaitingForEvent = null;
        let tutorialReviewMode = false; // When true, skip interactive steps

        // Tutorial Chapters Data Structure
        const TUTORIAL_CHAPTERS = {
            1: {
                title: "Basic Mechanics",
                steps: [
                    {
                        title: "Welcome!",
                        text: "Welcome to <strong>Pathway Clash</strong>, a blind card battler based on Lord of the Mysteries! Let's learn the basics.",
                        position: "center",
                        highlight: null,
                        lockUI: true,
                        allowedElements: [],
                        waitForEvent: null
                    },
                    {
                        title: "Blind Card Battler",
                        text: "This is a <span class='highlight'>simultaneous</span> card game. Both you and your opponent choose cards at the same time - you can't see their choice until both cards are revealed!<br><br>This creates strategic mind games. Try to predict what your opponent will play!",
                        position: "center",
                        highlight: null,
                        lockUI: true,
                        allowedElements: [],
                        waitForEvent: null
                    },
                    {
                        title: "Your Hand",
                        text: "Each round, you draw <strong>3 cards</strong> from the 22 Pathways. These are your options for this turn.",
                        position: "bottom",
                        highlight: "#player-hand",
                        lockUI: true,
                        allowedElements: [],
                        waitForEvent: null
                    },
                    {
                        title: "Select a Card",
                        text: "Click on a card to select it. Don't worry - you can change your mind before playing!",
                        position: "bottom",
                        highlight: "#player-hand",
                        lockUI: true,
                        allowedElements: ["#player-hand .card"],
                        waitForEvent: "cardSelected"
                    },
                    {
                        title: "Play Your Card",
                        text: "Now click the <strong>Play</strong> button to confirm your selection. Your opponent (the AI) will also play a card.",
                        position: "center",
                        highlight: "#play-btn",
                        lockUI: true,
                        allowedElements: ["#play-btn"],
                        waitForEvent: "cardPlayed"
                    },
                    {
                        title: "Round Result",
                        text: "Each card has matchups against others - some cards beat certain cards, lose to others, or draw. Check the <strong>Battle Log</strong> below to see what happened!",
                        position: "above-battle-log",
                        highlight: ".battle-log",
                        lockUI: true,
                        allowedElements: [],
                        waitForEvent: null
                    },
                    {
                        title: "HP Bars",
                        text: "When you win a round, you deal damage to your opponent's HP. The first player to reach <strong>0 HP loses</strong> the match!",
                        position: "left-sidebar",
                        highlight: ".hp-section",
                        lockUI: true,
                        allowedElements: [],
                        waitForEvent: null
                    },
                    {
                        title: "Understanding Matchups",
                        text: "Each pathway has <span class='highlight'>strengths and weaknesses</span> based on Lord of the Mysteries lore.<br><br>For example: <b>The Fool</b> beats <b>Error</b> because the Fool's deception abilities counter Error's power manipulation.<br><br>Hover over cards to see flavor text hints, or click <b>Pathways</b> for the full matchup chart!",
                        position: "center",
                        highlight: null,
                        lockUI: true,
                        allowedElements: [],
                        waitForEvent: null
                    }
                ]
            },
            2: {
                title: "Abilities & Madness",
                steps: [
                    {
                        title: "Ability Phase",
                        text: "Before selecting cards, you enter the <strong>Ability Phase</strong>. Some cards have special abilities you can activate!",
                        position: "center",
                        highlight: null,
                        lockUI: true,
                        allowedElements: [],
                        waitForEvent: null
                    },
                    {
                        title: "Using Abilities",
                        text: "During the ability phase, cards with abilities will be highlighted. Click on them to see and use their special powers!",
                        position: "bottom",
                        highlight: "#player-hand",
                        lockUI: true,
                        allowedElements: [],
                        waitForEvent: null
                    },
                    {
                        title: "Try Using an Ability!",
                        text: "Look at your hand - cards with abilities have a <span class='highlight'>glowing border</span>. Click on an ability card, then click the <b>Use Ability</b> button to queue it!",
                        position: "bottom",
                        highlight: "#ability-phase-section",
                        lockUI: true,
                        allowedElements: [".pathway-card", "#btn-use-ability", "#btn-skip-ability", ".ability-btn"],
                        waitForEvent: "abilityUsed"
                    },
                    {
                        title: "Now Play a Card!",
                        text: "Your ability is queued! Now <strong>select a card</strong> from your hand and click <strong>Play Card</strong> to battle. Watch your madness bar increase when the ability activates!",
                        position: "bottom",
                        highlight: "#player-hand",
                        lockUI: true,
                        allowedElements: ["#player-hand .card", "#play-btn", ".btn-play"],
                        waitForEvent: "cardPlayed"
                    },
                    {
                        title: "Madness Cost",
                        text: "Abilities cost <strong>Madness</strong>. Watch your madness bar - using too many abilities fills it up!",
                        position: "left-sidebar",
                        highlight: ".madness-bar-container",
                        lockUI: true,
                        allowedElements: [],
                        waitForEvent: null
                    },
                    {
                        title: "Madness Warning",
                        text: " <strong>Critical:</strong> If your madness reaches 100%, you <strong>instantly lose</strong> the game! Manage your abilities wisely.",
                        position: "center",
                        highlight: null,
                        lockUI: true,
                        allowedElements: [],
                        waitForEvent: null
                    }
                ]
            },
            3: {
                title: "Card Tiers",
                steps: [
                    {
                        title: "Big Hits",
                        text: "Cards with <strong class=\"rainbow\">rainbow names</strong> are \"Big Hits\" - they have the best win rates and beat more cards than others!",
                        position: "center",
                        highlight: null,
                        lockUI: true,
                        allowedElements: [],
                        waitForEvent: null
                    },
                    {
                        title: "Medium Tier",
                        text: "Medium tier cards are reliable choices with decent matchups. They won't let you down!",
                        position: "center",
                        highlight: null,
                        lockUI: true,
                        allowedElements: [],
                        waitForEvent: null
                    },
                    {
                        title: "Low Tier",
                        text: "Lower tier cards win fewer matchups, but they're still useful! Every card beats <strong>something</strong>.",
                        position: "center",
                        highlight: null,
                        lockUI: true,
                        allowedElements: [],
                        waitForEvent: null
                    },
                    {
                        title: "Explore Matchups",
                        text: "Click the <span class='highlight'>Pathways</span> button to see the full matchup chart. This shows which cards beat which!<br><br>Try it now!",
                        position: "left-sidebar",
                        highlight: ".pathway-reference",
                        lockUI: true,
                        allowedElements: [".pathway-reference", ".btn-view-all", ".btn-summon-guide", "#pathway-modal", ".modal-close", ".pathway-grid-item"],
                        waitForEvent: "pathwaysOpened"
                    }
                ]
            },
            4: {
                title: "Advanced Strategies",
                steps: [
                    {
                        title: "Draw Multiplier",
                        text: "When a round ends in a <strong>draw</strong>, the damage multiplier doubles! This continues stacking until someone wins.",
                        position: "right",
                        highlight: ".multiplier-display",
                        lockUI: true,
                        allowedElements: [],
                        waitForEvent: null
                    },
                    {
                        title: "Damage Formula",
                        text: "Damage depends on how <span class='highlight'>dominant</span> your win is:<br><br> <b>Decisive Win</b> (strong counter): <b>30 damage</b><br> <b>Clear Win</b> (good matchup): <b>20 damage</b><br> <b>Close Win</b> (narrow edge): <b>10 damage</b> + 5 self-damage<br><br>The better your matchup, the more damage you deal!",
                        position: "center",
                        highlight: null,
                        lockUI: true,
                        allowedElements: [],
                        waitForEvent: null
                    },
                    {
                        title: "Recoil Damage",
                        text: "Be careful with <span class='highlight'>close wins</span>! When you barely beat an opponent (Close Win), you take <b>5 self-damage</b> from the struggle.<br><br>Decisive wins are safer - no recoil!",
                        position: "center",
                        highlight: null,
                        lockUI: true,
                        allowedElements: [],
                        waitForEvent: null
                    },
                    {
                        title: "High Madness Risk",
                        text: "Higher madness increases the damage you take! It's a risk system - more madness means you're more vulnerable to attacks, and closer to losing.",
                        position: "center",
                        highlight: null,
                        lockUI: true,
                        allowedElements: [],
                        waitForEvent: null
                    },
                    {
                        title: "Mind Games",
                        text: "Since both players play cards <strong>blindly</strong> at the same time, prediction and psychology matter! Try to guess what your opponent will play.",
                        position: "center",
                        highlight: null,
                        lockUI: true,
                        allowedElements: [],
                        waitForEvent: null
                    }
                ]
            },
            5: {
                title: "Game Modes",
                steps: [
                    {
                        title: "Game Mode Buttons",
                        text: "At the top of the screen, you'll find <strong>three game modes</strong> to choose from. Let's explore each one!",
                        position: "top",
                        highlight: "#game-type-toggle",
                        lockUI: true,
                        allowedElements: [],
                        waitForEvent: null
                    },
                    {
                        title: "Pathways Mode",
                        text: "The default mode uses the <strong>22 Pathways</strong> from Lord of the Mysteries. Each represents a unique power system with distinct abilities!",
                        position: "top",
                        highlight: "#type-pathways",
                        lockUI: true,
                        allowedElements: [],
                        waitForEvent: null
                    },
                    {
                        title: "Outer Deities Mode",
                        text: "Switch to <strong>Outer Deities</strong> mode to play as cosmic entities! 10 unique deities with completely different matchups and abilities.",
                        position: "top",
                        highlight: "#type-outer",
                        lockUI: true,
                        allowedElements: [],
                        waitForEvent: null
                    },
                    {
                        title: "Inner vs Outer",
                        text: "The ultimate mode: <strong>Inner vs Outer</strong>! Pathways can summon Inner Gods, while Outer Deities have their own powers. Asymmetric battles!",
                        position: "top",
                        highlight: "#type-inner-vs-outer",
                        lockUI: true,
                        allowedElements: [],
                        waitForEvent: null
                    }
                ]
            },
            6: {
                title: "Final Test",
                steps: [
                    {
                        title: "Prove Your Skills",
                        text: "Time to put your knowledge to the test! To complete the tutorial, you must beat the <strong>Easy AI</strong>, then the <strong>Medium AI</strong>.",
                        position: "center",
                        highlight: null,
                        lockUI: true,
                        allowedElements: [],
                        waitForEvent: null
                    },
                    {
                        title: "Choose Your Challenge",
                        text: "Select a difficulty to begin. You can try as many times as needed!",
                        position: "center",
                        highlight: null,
                        lockUI: true,
                        allowedElements: [],
                        waitForEvent: "showFinalTest"
                    }
                ]
            }
        };

        let playerId = null;
        let opponentReady = false;
        let myCardPlayed = null;
        let opponentCardPlayed = null;
        let waitingForOpponent = false;
        let currentRoomCode = null;

        // PvP Ability sync variables
        let myAbilitySelected = null;  // { cardName, abilityName, abilityDesc } or 'skipped'
        let opponentAbilitySelected = null;
        let waitingForOpponentAbility = false;

        // Public matchmaking state
        let matchType = 'private'; // 'private' or 'public'
        let queueRef = null;
        let myQueueId = null;
        let queueListener = null;
        let isSearchingForMatch = false;

        function initFirebase() {
            database = ensureFirebaseInitialized();
        }

        function setMatchType(type) {
            matchType = type;
            const privateBtn = document.getElementById('btn-private-match');
            const publicBtn = document.getElementById('btn-public-match');
            const privateUI = document.getElementById('private-room-ui');
            const publicUI = document.getElementById('public-match-ui');

            if (type === 'private') {
                privateBtn.classList.add('active');
                publicBtn.classList.remove('active');
                privateUI.style.display = 'block';
                publicUI.style.display = 'none';
                updateConnectionStatus('waiting', 'Enter a 4-digit code to create or join a room');
            } else {
                privateBtn.classList.remove('active');
                publicBtn.classList.add('active');
                privateUI.style.display = 'none';
                publicUI.style.display = 'block';
                updateConnectionStatus('waiting', 'Click Find Match to search for an opponent');
            }
        }

        function joinPublicQueue() {
            if (FIREBASE_CONFIG.apiKey === "YOUR_API_KEY") {
                alert('Firebase not configured! Please set up Firebase first.');
                return;
            }

            initFirebase();
            isSearchingForMatch = true;

            // Show searching UI
            document.getElementById('btn-find-match').style.display = 'none';
            document.getElementById('matchmaking-status').style.display = 'flex';

            // Show appropriate search message
            let searchMsg = 'Searching for opponent...';
            if (gameType === 'inner_vs_outer') {
                const mySide = innerVsOuterPlayerSide === 'pathways' ? 'Pathways' : 'Outer Deities';
                const seekingSide = innerVsOuterPlayerSide === 'pathways' ? 'Outer Deities' : 'Pathways';
                searchMsg = `Playing as ${mySide} - Searching for ${seekingSide} player...`;
            }
            document.getElementById('matchmaking-text').textContent = searchMsg;
            updateConnectionStatus('waiting', searchMsg);

            // Generate unique queue ID
            myQueueId = Date.now().toString() + '_' + Math.random().toString(36).substr(2, 9);

            // Add self to queue with game type info
            queueRef = database.ref('matchmaking/queue');
            queueRef.child(myQueueId).set({
                playerCode: playerCode || 'anonymous',
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                status: 'waiting',
                gameType: gameType,
                playerSide: gameType === 'inner_vs_outer' ? innerVsOuterPlayerSide : null
            }).then(() => {
                // Listen for matches
                findOpponentInQueue();
            }).catch(err => {
                console.error('Error joining queue:', err);
                leavePublicQueue();
                alert('Error joining matchmaking queue. Please try again.');
            });
        }

        function findOpponentInQueue() {
            if (!isSearchingForMatch) return;

            // Query for other waiting players
            queueListener = queueRef.orderByChild('status').equalTo('waiting').on('value', snapshot => {
                if (!isSearchingForMatch) return;

                const queue = snapshot.val();
                if (!queue) return;

                // Find another player (not self)
                for (const [queueId, player] of Object.entries(queue)) {
                    if (queueId !== myQueueId && player.status === 'waiting') {
                        // Check game type compatibility
                        if (player.gameType !== gameType) {
                            // Different game types, skip
                            continue;
                        }

                        // For inner_vs_outer mode, require opposite sides
                        if (gameType === 'inner_vs_outer') {
                            const myPlayerSide = innerVsOuterPlayerSide;
                            const theirPlayerSide = player.playerSide;

                            // Only match if on opposite sides
                            if (myPlayerSide === theirPlayerSide) {
                                continue; // Same side, skip
                            }
                        }

                        // Found a compatible opponent! Try to match
                        tryMatchWithPlayer(queueId, player);
                        return;
                    }
                }
            });
        }

        function tryMatchWithPlayer(opponentQueueId, opponentData) {
            if (!isSearchingForMatch) return;

            // Use transaction to prevent race conditions
            const myRef = queueRef.child(myQueueId);

            myRef.transaction(currentData => {
                if (currentData && currentData.status === 'waiting') {
                    return {
                        ...currentData,
                        status: 'matching',
                        matchWith: opponentQueueId
                    };
                }
                return; // Abort if not waiting
            }).then(result => {
                if (result.committed && isSearchingForMatch) {
                    // Check if opponent is still available
                    checkOpponentAndCreateRoom(opponentQueueId);
                }
            }).catch(err => {
                console.error('Transaction error:', err);
            });
        }

        function checkOpponentAndCreateRoom(opponentQueueId) {
            queueRef.child(opponentQueueId).once('value').then(snapshot => {
                const opponentData = snapshot.val();

                if (!opponentData || !isSearchingForMatch) {
                    // Opponent gone, reset and keep searching
                    queueRef.child(myQueueId).update({ status: 'waiting', matchWith: null });
                    return;
                }

                // Check if opponent matched with us or is still waiting
                if (opponentData.status === 'waiting' ||
                    (opponentData.status === 'matching' && opponentData.matchWith === myQueueId)) {

                    // Determine who creates the room (lower queue ID creates)
                    const iAmHost = myQueueId < opponentQueueId;

                    if (iAmHost) {
                        // Create room and notify opponent
                        const roomCode = generatePublicRoomCode();
                        createPublicMatch(roomCode, opponentQueueId);
                    } else {
                        // Wait for opponent to create room
                        waitForRoomAssignment(opponentQueueId);
                    }
                } else {
                    // Opponent matched with someone else, reset
                    queueRef.child(myQueueId).update({ status: 'waiting', matchWith: null });
                }
            });
        }

        function generatePublicRoomCode() {
            // Generate a unique room code using timestamp
            return 'P' + Date.now().toString().slice(-7);
        }

        function createPublicMatch(roomCode, opponentQueueId) {
            document.getElementById('matchmaking-text').textContent = 'Opponent found! Creating room...';

            // Update both queue entries with the room code
            const updates = {};
            updates[myQueueId + '/status'] = 'matched';
            updates[myQueueId + '/roomCode'] = roomCode;
            updates[opponentQueueId + '/status'] = 'matched';
            updates[opponentQueueId + '/roomCode'] = roomCode;

            queueRef.update(updates).then(() => {
                // Clean up queue listener
                if (queueListener) {
                    queueRef.off('value', queueListener);
                    queueListener = null;
                }

                // Remove from queue after short delay
                setTimeout(() => {
                    queueRef.child(myQueueId).remove();
                    queueRef.child(opponentQueueId).remove();
                }, 2000);

                // Join the room as player 1 (host)
                isSearchingForMatch = false;
                currentRoomCode = roomCode;
                joinPublicRoom(roomCode, true);
            }).catch(err => {
                console.error('Error creating match:', err);
                queueRef.child(myQueueId).update({ status: 'waiting', matchWith: null });
            });
        }

        function waitForRoomAssignment(opponentQueueId) {
            document.getElementById('matchmaking-text').textContent = 'Opponent found! Joining room...';

            // Listen for room assignment
            const myEntryRef = queueRef.child(myQueueId);
            const roomWatcher = myEntryRef.on('value', snapshot => {
                const data = snapshot.val();
                if (data && data.roomCode && data.status === 'matched') {
                    // Room assigned, join it
                    myEntryRef.off('value', roomWatcher);

                    if (queueListener) {
                        queueRef.off('value', queueListener);
                        queueListener = null;
                    }

                    // Remove from queue after short delay
                    setTimeout(() => {
                        queueRef.child(myQueueId).remove();
                    }, 2000);

                    isSearchingForMatch = false;
                    currentRoomCode = data.roomCode;
                    joinPublicRoom(data.roomCode, false);
                }
            });

            // Timeout if no room assigned
            setTimeout(() => {
                if (isSearchingForMatch) {
                    myEntryRef.off('value', roomWatcher);
                    queueRef.child(myQueueId).update({ status: 'waiting', matchWith: null });
                    document.getElementById('matchmaking-text').textContent = 'Searching for opponent...';
                }
            }, 5000);
        }

        function joinPublicRoom(roomCode, isHost) {
            // Hide matchmaking UI
            document.getElementById('matchmaking-status').style.display = 'none';
            document.getElementById('btn-find-match').style.display = 'none';
            document.getElementById('match-type-selector').style.display = 'none';

            // Show room info with Leave Match button
            const publicUI = document.getElementById('public-match-ui');
            publicUI.innerHTML = '<div class="room-code-display">Public Match - Room: ' + roomCode + '</div>' +
                '<button class="btn-leave-match" onclick="leaveAndFindNewMatch()">Leave & Find New Match</button>';

            // Initialize multiplayer
            playerId = isHost ? 'player1' : 'player2';
            roomRef = database.ref('rooms/' + roomCode);

            if (isHost) {
                // Create room with game type and side info
                const roomData = {
                    player1: true,
                    player2: false,
                    player1Card: null,
                    player2Card: null,
                    player1Ability: null,
                    player2Ability: null,
                    turn: 1,
                    lastUpdate: firebase.database.ServerValue.TIMESTAMP,
                    isPublic: true,
                    gameType: gameType
                };

                // For inner_vs_outer, store player sides
                if (gameType === 'inner_vs_outer') {
                    roomData.player1Side = innerVsOuterPlayerSide;
                    // Player 2 gets the opposite side
                    roomData.player2Side = innerVsOuterPlayerSide === 'pathways' ? 'outer_deities' : 'pathways';
                }

                roomRef.set(roomData).then(() => {
                    updatePlayerIndicator();
                    updateConnectionStatus('waiting', 'Waiting for opponent to join...');
                    setupRoomListeners();
                });
            } else {
                // Join room as player 2 - first get room data to know our side
                roomRef.once('value').then(snapshot => {
                    const roomData = snapshot.val();

                    // Sync game type
                    if (roomData && roomData.gameType) {
                        gameType = roomData.gameType;
                        localStorage.setItem('pathwayClash_gameType', gameType);

                        // Update toggle buttons
                        document.getElementById('type-pathways').classList.toggle('active', gameType === 'pathways');
                        document.getElementById('type-outer').classList.toggle('active', gameType === 'outer_deities');
                        document.getElementById('type-inner-vs-outer').classList.toggle('active', gameType === 'inner_vs_outer');
                    }

                    // For inner_vs_outer, set our side to the assigned player2Side
                    if (gameType === 'inner_vs_outer' && roomData && roomData.player2Side) {
                        innerVsOuterPlayerSide = roomData.player2Side;
                        localStorage.setItem('pathwayClash_innerVsOuterSide', innerVsOuterPlayerSide);
                    }

                    // Now join the room
                    return roomRef.update({
                        player2: true,
                        lastUpdate: firebase.database.ServerValue.TIMESTAMP
                    });
                }).then(() => {
                    updatePlayerIndicator();
                    opponentReady = true;
                    updateConnectionStatus('connected', 'Both players connected!');
                    setupRoomListeners();

                    // Update UI to reflect synced game type
                    populatePathwayGrid();
                    populatePathwayTable();

                    startPvPGame();
                });
            }
        }

        function leavePublicQueue() {
            isSearchingForMatch = false;

            // Remove from queue
            if (queueRef && myQueueId) {
                queueRef.child(myQueueId).remove();
            }

            // Clean up listener
            if (queueListener) {
                queueRef.off('value', queueListener);
                queueListener = null;
            }

            // Reset UI
            document.getElementById('btn-find-match').style.display = 'block';
            document.getElementById('matchmaking-status').style.display = 'none';
            updateConnectionStatus('waiting', 'Click Find Match to search for an opponent');

            myQueueId = null;
        }

        function leaveAndFindNewMatch() {
            // Clean up current room
            if (roomRef) {
                roomRef.off(); // Remove all listeners
                roomRef.child(playerId).set(false); // Mark as disconnected
                roomRef = null;
            }

            // Reset state
            currentRoomCode = null;
            playerId = null;
            opponentReady = false;
            myCardPlayed = null;
            opponentCardPlayed = null;

            // Reset game state
            resetGameState();

            // Reset UI to show Find Match button
            const publicUI = document.getElementById('public-match-ui');
            publicUI.innerHTML = '<div class="room-code-label">Get matched with a random opponent</div>' +
                '<button class="btn-find-match" id="btn-find-match" onclick="joinPublicQueue()">Find Match</button>' +
                '<div class="matchmaking-status" id="matchmaking-status" style="display: none;">' +
                '<div class="matchmaking-spinner"></div>' +
                '<span id="matchmaking-text">Searching for opponent...</span>' +
                '<button class="btn-cancel-match" onclick="leavePublicQueue()">Cancel</button>' +
                '</div>';
            document.getElementById('btn-find-match').style.display = 'block';
            document.getElementById('match-type-selector').style.display = 'flex';

            updateConnectionStatus('waiting', 'Click Find Match to search for an opponent');
            updatePlayerIndicator();
        }

        function joinRoom() {
            const input = document.getElementById('room-code-input');
            const code = input.value.trim();

            if (code.length !== 4 || !/^\d{4}$/.test(code)) {
                alert('Please enter a valid 4-digit code');
                return;
            }

            if (FIREBASE_CONFIG.apiKey === "YOUR_API_KEY") {
                alert('Firebase not configured! Please set up Firebase first.\n\nSee instructions in the code comments.');
                return;
            }

            currentRoomCode = code;
            initFirebase();
            initMultiplayer(code);
        }

        function initMultiplayer(roomCode) {
            // Clean up old listeners
            if (roomRef) {
                roomRef.off();
            }

            playerId = null;
            opponentReady = false;

            // Update UI
            document.getElementById('room-code-display').textContent = 'Room: ' + roomCode;
            document.getElementById('room-code-input').disabled = true;
            document.getElementById('btn-join').disabled = true;

            roomRef = database.ref('rooms/' + roomCode);

            // Check if room exists and join
            roomRef.once('value').then(async (snapshot) => {
                const roomData = snapshot.val();

                if (!roomData || !roomData.player1) {
                    // No room or no player1, become player1
                    playerId = 'player1';
                    await roomRef.set({
                        player1: true,
                        player2: false,
                        player1Card: null,
                        player2Card: null,
                        player1Ability: null,
                        player2Ability: null,
                        turn: 1,
                        lastUpdate: Date.now()
                    });
                    updatePlayerIndicator();
                    updateConnectionStatus('waiting', 'Room ' + roomCode + ' - Waiting for Player 2...');
                } else if (!roomData.player2) {
                    // Room has player1, become player2
                    playerId = 'player2';
                    await roomRef.update({
                        player2: true,
                        lastUpdate: Date.now()
                    });
                    updatePlayerIndicator();
                    updateConnectionStatus('connected', 'Room ' + roomCode + ' - Connected! Both players ready.');
                    startPvPGame();
                } else {
                    // Room is full
                    alert('Room is full! Try a different code.');
                    document.getElementById('room-code-input').disabled = false;
                    document.getElementById('btn-join').disabled = false;
                    document.getElementById('room-code-display').textContent = '';
                    return;
                }

                // Listen for room changes (after write completes)
                setupRoomListeners();
            }).catch((error) => {
                console.error('Error joining room:', error);
                alert('Failed to join room. Please check your connection and try again.');
                document.getElementById('room-code-input').disabled = false;
                document.getElementById('btn-join').disabled = false;
                document.getElementById('room-code-display').textContent = '';
            });
        }

        function setupRoomListeners() {
            // Listen for player2 joining (for player1)
            roomRef.child('player2').on('value', (snapshot) => {
                if (playerId === 'player1' && snapshot.val() === true && !opponentReady) {
                    opponentReady = true;
                    updateConnectionStatus('connected', 'Room ' + currentRoomCode + ' - Connected! Both players ready.');
                    startPvPGame();
                }
            });

            // Listen for opponent's card
            const opponentCardPath = playerId === 'player1' ? 'player2Card' : 'player1Card';
            roomRef.child(opponentCardPath).on('value', (snapshot) => {
                const card = snapshot.val();
                if (card && card !== opponentCardPlayed) {
                    opponentCardPlayed = card;
                    checkBothPlayed();
                }
            });

            // Listen for opponent's ability selection
            const opponentAbilityPath = playerId === 'player1' ? 'player2Ability' : 'player1Ability';
            roomRef.child(opponentAbilityPath).on('value', (snapshot) => {
                const ability = snapshot.val();
                if (ability && ability !== opponentAbilitySelected) {
                    opponentAbilitySelected = ability;
                    checkBothAbilitiesSelected();
                }
            });

            // Listen for new game requests
            roomRef.child('newGame').on('value', (snapshot) => {
                const data = snapshot.val();
                if (data && data.requestedBy && data.requestedBy !== playerId) {
                    resetGameState();
                    addLogEntry('Opponent started a new game!', 'info');
                }
            });

            // Listen for disconnections
            roomRef.child(playerId === 'player1' ? 'player2' : 'player1').on('value', (snapshot) => {
                if (snapshot.val() === false && opponentReady) {
                    updateConnectionStatus('waiting', 'Opponent disconnected');
                    opponentReady = false;

                    // Show Find New Match button for public matches
                    if (matchType === 'public') {
                        const publicUI = document.getElementById('public-match-ui');
                        publicUI.innerHTML = '<div class="room-code-display">Opponent left the match</div>' +
                            '<button class="btn-find-match" onclick="leaveAndFindNewMatch()">Find New Match</button>';
                    }
                }
            });

            // Listen for game state sync (HP, damage multipliers, etc.)
            // Each player is the authority for their OWN HP - only update opponent's HP from sync
            roomRef.child('gameState').on('value', (snapshot) => {
                const syncedState = snapshot.val();
                if (!syncedState) return;

                // Only update OPPONENT's HP from sync (they are the authority for their own HP)
                if (playerId === 'player1') {
                    // I'm player1, so I get player2's HP from sync
                    if (syncedState.player2HP !== undefined) {
                        gameState.opponentHP = syncedState.player2HP;
                    }
                    if (syncedState.player2Madness !== undefined) {
                        gameState.opponentMadness = syncedState.player2Madness;
                    }
                    gameState.opponentDamageMultiplier = syncedState.player2DamageMult || 1;
                } else {
                    // I'm player2, so I get player1's HP from sync
                    if (syncedState.player1HP !== undefined) {
                        gameState.opponentHP = syncedState.player1HP;
                    }
                    if (syncedState.player1Madness !== undefined) {
                        gameState.opponentMadness = syncedState.player1Madness;
                    }
                    gameState.opponentDamageMultiplier = syncedState.player1DamageMult || 1;
                }

                // Sync effects applied TO ME by opponent (blocked, blinded, forced card)
                if (playerId === 'player1') {
                    gameState.playerAbilityBlocked = syncedState.player1Blocked || false;
                    gameState.playerBlinded = syncedState.player1Blinded || false;
                    gameState.forcedPlayerCard = syncedState.player1ForcedCard || null;
                } else {
                    gameState.playerAbilityBlocked = syncedState.player2Blocked || false;
                    gameState.playerBlinded = syncedState.player2Blinded || false;
                    gameState.forcedPlayerCard = syncedState.player2ForcedCard || null;
                }

                // Update UI
                updateUI();

                // Check for game over based on synced HP
                if (gameState.opponentHP <= 0 || gameState.playerHP <= 0) {
                    checkGameOver();
                }
            });

            // Listen for pending damage sent to me
            const myDamageRef = roomRef.child('pendingDamage').child(playerId);
            myDamageRef.on('child_added', (snapshot) => {
                const damageEvent = snapshot.val();
                if (damageEvent && damageEvent.amount) {
                    // Apply damage to myself
                    const madnessMult = getMadnessMultiplier(gameState.playerMadness || 0);
                    const actualDamage = Math.round(damageEvent.amount * madnessMult);
                    gameState.playerHP = Math.max(0, gameState.playerHP - actualDamage);

                    showEffectPopup(`-${actualDamage}`, 'damage', 'player');
                    updateUI();
                    syncGameStateToFirebase();

                    // Remove the processed damage event
                    snapshot.ref.remove();

                    checkGameOver();
                }
            });
        }

        // Sync game state to Firebase (call after HP/state changes)
        // Each player only syncs their OWN HP/madness - they are the authority for their own values
        function syncGameStateToFirebase() {
            if (gameMode !== 'pvp' || !roomRef) return;

            // Each player only syncs their OWN HP and madness (they are the authority)
            // Effects on opponent (blocked, blinded, forced card) are synced by the one applying them
            let syncData;
            if (playerId === 'player1') {
                syncData = {
                    player1HP: gameState.playerHP,
                    player1Madness: gameState.playerMadness || 0,
                    player1DamageMult: gameState.damageMultiplier || 1,
                    // Effects I'm applying TO player2
                    player2Blocked: gameState.opponentAbilityBlocked || false,
                    player2Blinded: gameState.opponentBlinded || false,
                    player2ForcedCard: gameState.forcedOpponentCard || null,
                    lastUpdate: firebase.database.ServerValue.TIMESTAMP
                };
            } else {
                syncData = {
                    player2HP: gameState.playerHP,
                    player2Madness: gameState.playerMadness || 0,
                    player2DamageMult: gameState.damageMultiplier || 1,
                    // Effects I'm applying TO player1
                    player1Blocked: gameState.opponentAbilityBlocked || false,
                    player1Blinded: gameState.opponentBlinded || false,
                    player1ForcedCard: gameState.forcedOpponentCard || null,
                    lastUpdate: firebase.database.ServerValue.TIMESTAMP
                };
            }

            roomRef.child('gameState').update(syncData).catch(err => {
                console.error('Error syncing game state:', err);
            });
        }

        // Send damage to opponent (they will apply it to themselves)
        function sendDamageToOpponent(amount) {
            if (gameMode !== 'pvp' || !roomRef) return;

            const targetPlayer = playerId === 'player1' ? 'player2' : 'player1';
            roomRef.child('pendingDamage').child(targetPlayer).push({
                amount: amount,
                from: playerId,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });
        }

        // Send healing to self (redundant but keeps pattern consistent)
        function sendHealToSelf(amount) {
            gameState.playerHP = Math.min(100, gameState.playerHP + amount);
            syncGameStateToFirebase();
        }

        function updatePlayerIndicator() {
            const container = DOM.get('player-indicator-container');
            const indicator = DOM.get('player-indicator');
            const playerLabel = DOM.get('player-label');
            const opponentLabel = DOM.get('opponent-label');

            if (gameMode === 'pvp' && playerId) {
                container.style.display = 'block';
                indicator.textContent = playerId === 'player1' ? 'Player 1 (Blue)' : 'Player 2 (Red)';
                indicator.className = `player-indicator ${playerId}`;
                playerLabel.textContent = playerId === 'player1' ? 'You (P1)' : 'You (P2)';
                opponentLabel.textContent = playerId === 'player1' ? 'Opponent (P2)' : 'Opponent (P1)';
            } else {
                container.style.display = 'none';
                playerLabel.textContent = 'You';
                opponentLabel.textContent = 'Opponent';
            }
        }

        function updateConnectionStatus(state, message) {
            const el = DOM.get('connection-status');
            el.className = `connection-status ${state}`;
            el.textContent = message;
        }

        function startPvPGame() {
            resetGameState();
            addLogEntry('PvP game started! Select a card.', 'info');
        }

        function checkBothPlayed() {
            if (myCardPlayed && opponentCardPlayed) {
                resolvePvPBattle();
            } else if (myCardPlayed && !opponentCardPlayed) {
                updateConnectionStatus('playing', 'Room ' + currentRoomCode + ' - Waiting for opponent...');
            }
        }

        function resolvePvPBattle() {
            const currentPathways = getCurrentPathways();
            const playerCard = currentPathways.find(p => p.name === myCardPlayed);
            const opponentCard = currentPathways.find(p => p.name === opponentCardPlayed);

            const playerPlayedEl = DOM.get('player-played');
            const opponentPlayedEl = DOM.get('opponent-played');

            const currentBigHits = getCurrentBigHitList();
            playerPlayedEl.className = 'played-card revealed';
            playerPlayedEl.style.background = 'linear-gradient(135deg, #1a4a1a, #0a2a0a)';
            const playerBigHit = currentBigHits.includes(playerCard.name);
            playerPlayedEl.innerHTML = `
                <div class="card-icon"><img src="${playerCard.icon}" alt="${playerCard.name}"></div>
                <div class="card-name ${playerBigHit ? 'rainbow' : ''}" ${!playerBigHit ? 'style="color: var(--color-gold);"' : ''}>${playerCard.name}</div>
            `;

            opponentPlayedEl.className = 'played-card revealed';
            opponentPlayedEl.style.background = 'linear-gradient(135deg, #4a1a1a, #2a0a0a)';
            const oppBigHit = currentBigHits.includes(opponentCard.name);
            opponentPlayedEl.innerHTML = `
                <div class="card-icon"><img src="${opponentCard.icon}" alt="${opponentCard.name}"></div>
                <div class="card-name ${oppBigHit ? 'rainbow' : ''}" ${!oppBigHit ? 'style="color: var(--color-gold);"' : ''}>${opponentCard.name}</div>
            `;

            resolveBattle(myCardPlayed, opponentCardPlayed);

            updateUI();

            if (gameState.playerHP <= 0 || gameState.opponentHP <= 0) {
                gameState.gameOver = true;
                showGameOver();
                return;
            }

            gameState.turn++;
            myCardPlayed = null;
            opponentCardPlayed = null;
            myAbilitySelected = null;
            opponentAbilitySelected = null;
            waitingForOpponentAbility = false;
            gameState.selectedCard = null;
            waitingForOpponent = false;

            // Clear cards and abilities in Firebase for next round
            if (roomRef) {
                roomRef.update({
                    player1Card: null,
                    player2Card: null,
                    player1Ability: null,
                    player2Ability: null,
                    turn: gameState.turn
                });
            }

            updateConnectionStatus('connected', 'Room ' + currentRoomCode + ' - Your turn!');

            setTimeout(() => {
                drawHands();
                renderHand();

                playerPlayedEl.className = 'played-card empty';
                playerPlayedEl.style.background = '';
                playerPlayedEl.innerHTML = '<div>Your Card</div>';

                opponentPlayedEl.className = 'played-card empty';
                opponentPlayedEl.style.background = '';
                opponentPlayedEl.innerHTML = '<div>Opponent\'s Card</div>';

                updateUI();
                showAbilityPhase();
            }, 2000);
        }

        // ============================================
        // GAME STATE
        // ============================================
        let gameState = {
            playerHP: 100,
            opponentHP: 100,
            playerHand: [],
            opponentHand: [],
            selectedCard: null,
            damageMultiplier: 1,
            gameOver: false,
            turn: 1,
            // Ability phase state
            abilityPhaseActive: false,
            abilityUsedThisTurn: false,
            selectedAbility: null,  // { cardIndex, abilityIndex, cardName, abilityName, abilityDesc }
            // Ability effects state
            priorPlayerHand: [],           // Previous hand for Knowledge recall
            priorOpponentHand: [],         // Previous opponent hand for Knowledge recall
            nextTurnEffects: [],           // Pending effects for next turn [{type, target, data}]
            opponentBlinded: false,        // Darkness effect - opponent can't see cards
            playerBlinded: false,          // Darkness effect on player
            opponentAbilityBlocked: false, // Justiciar/Darkness - opponent can't use abilities
            playerAbilityBlocked: false,   // Justiciar/Darkness - player can't use abilities
            foolDecoyActive: false,        // Fool mechanic active
            foolDecoyCardIndex: null,      // Which card is the decoy
            foolDecoyIsReal: null,         // Whether the decoy is "real" or "fake"
            forcedPlayerCard: null,        // Card player is forced to play (Binding/Visionary/Justiciar)
            forcedOpponentCard: null,      // Card opponent is forced to play
            guaranteedPlayerPathway: null, // Pathway guaranteed in next hand (Fate/Authority)
            guaranteedOpponentPathway: null, // Pathway guaranteed for opponent
            extraCardNextTurn: false,      // Door effect - draw extra card
            opponentExtraCard: false,      // Door effect for opponent
            abilitiesCancelled: false,     // Error effect - all abilities cancelled this turn
            stealthPeekCards: null,        // Cards shown during Stealth ability
            opponentUsedAbility: false,    // Track if opponent used ability (for AI)
            aiPendingAbility: null,        // AI's selected ability (executed during battle phase)
            playerPendingAbility: null,    // Player's selected ability (executed during battle phase)
            handsRevealed: false,          // Supernova reveal effect
            // Inner God (Above the Sequences) tracking
            drawnPathwaysThisGame: new Set(),  // All pathways player has drawn this game
            availableInnerGods: [],            // Inner Gods ready to be summoned
            playingInnerGod: null,             // Inner God being played this turn (replaces hand)
            // Madness system - using abilities increases madness, higher madness = more damage taken
            playerMadness: 0,                  // Player's madness percentage (0-100)
            opponentMadness: 0,                // Opponent's madness percentage (0-100)
            // Outer Deity effects
            playerConsumedTurns: 0,            // Primordial Maw consume effect duration
            opponentConsumedTurns: 0,          // Primordial Maw consume effect duration (opponent)
            playerDesireDiscard: false         // Mother of Desire discard effect
        };

        // Battle history for detail view
        let battleHistory = [];

        // ============================================
        // ACHIEVEMENT SYSTEM
        // ============================================
        // Achievements with difficulty ratings (1-10, higher = harder)
        const ACHIEVEMENTS = {
            'joined_tarot_club': { name: 'Joined the Tarot Club', desc: 'Play your first online game', icon: '', difficulty: 1 },
            'good_luck': { name: 'He Who Wields Good Luck', desc: 'Draw your first Big Hit card', icon: '', difficulty: 1 },
            'fortune_bold': { name: 'Fortune Favors the Bold', desc: 'Draw a Big Hit card on turn 1', icon: '', difficulty: 2 },
            'madness_begins': { name: 'The Madness Begins', desc: 'Use your first ability', icon: '', difficulty: 2 },
            'mission_accomplished': { name: 'Mission Accomplished', desc: 'Win your first online match', icon: '', difficulty: 3 },
            'close_call': { name: 'Close Call', desc: 'Win with less than 20% health', icon: '', difficulty: 4 },
            'paper_figurine': { name: 'Paper Figurine', desc: 'Win with 100 health left', icon: '', difficulty: 4 },
            'magic_mirror': { name: 'Magic Mirror', desc: 'Play the same card as opponent 5 times', icon: '', difficulty: 4 },
            'no_mercy': { name: 'No Mercy', desc: 'Deal over 50 damage in a single round', icon: '', difficulty: 4 },
            'hanged_man': { name: 'Hanged Man', desc: 'Deal over 100 damage total in one game', icon: '', difficulty: 5 },
            'written_in_stars': { name: 'Written in the Stars', desc: 'Win while holding a card from your first hand', icon: '', difficulty: 5 },
            'dawn_of_fool': { name: 'Dawn of the Fool', desc: 'Win the same turn you draw a Big Hit card', icon: '', difficulty: 5 },
            'star_still_shines': { name: 'The Star Still Shines', desc: 'Win without ever drawing a Big Hit card', icon: '', difficulty: 5 },
            'silver_bullet': { name: 'Silver Bullet', desc: 'End the game with a single attack', icon: '', difficulty: 6 },
            'unfortunate': { name: "Well That's Unfortunate", desc: 'Tie while both at full health the turn before', icon: '', difficulty: 6 },
            'fool_of_era': { name: 'The Fool of This Era', desc: 'Play every Big Hit card', icon: '', difficulty: 7 },
            'high_roller': { name: 'High Roller', desc: 'Obtain x32 and x64 multipliers', icon: '', difficulty: 7 },
            'sequence_0': { name: 'Sequence 0', desc: 'Play each pathway card at least once', icon: '', difficulty: 8 },
            'calculated_insanity': { name: 'Calculated Insanity', desc: 'Win while at high madness for 3+ turns', icon: '', difficulty: 8 },
            'true_madness': { name: 'True Madness', desc: 'Use every ability at least once', icon: '', difficulty: 8 },
            'unstoppable_force': { name: 'A Truly Unstoppable Force', desc: 'Obtain a x128 damage multiplier', icon: '', difficulty: 9 },
            'pathway_adept': { name: 'Pathway Adept', desc: 'Win 100 games', icon: '', difficulty: 10 },
            'silent_assassin': { name: 'Silent Assassin', desc: 'Deal 100 damage from indirect sources', icon: '', difficulty: 10 }
        };

        // Hidden Triumphs - Special achievements that grant titles
        // Must be achieved in online matches only
        const HIDDEN_TRIUMPHS = {
            'impossibly_rational': {
                name: "Are You Sure You're a Beyonder?",
                desc: 'Win with 0% madness',
                icon: '',
                title: 'Unmarked by Fog',
                titleEffect: 'crystal-cool',
                difficulty: 5
            },
            'hidden_order': {
                name: 'Hidden Order',
                desc: 'Win using only pathways from a single group',
                icon: '',
                title: 'Initiate of the Secret Order',
                titleEffect: 'mystic-runes',
                difficulty: 5
            },
            'smiling_clown': {
                name: 'Not All Clowns Laugh',
                desc: 'Lose half your HP in one turn but turn the game around',
                icon: '',
                title: 'Smiling Through Blood',
                titleEffect: 'blood-drip',
                difficulty: 6
            },
            'risk_taker': {
                name: 'Risk Taker',
                desc: 'Achieve 95% madness and win',
                icon: '',
                title: 'On the Verge of Madness',
                titleEffect: 'madness-pulse',
                difficulty: 7
            },
            'marionettist': {
                name: 'Marionettist',
                desc: 'Win using only indirect damage',
                icon: '',
                title: 'Puller of Invisible Strings',
                titleEffect: 'ghostly-fade',
                difficulty: 8
            },
            'antigonous_notebook': {
                name: "Antigonous's Notebook",
                desc: 'Win a game with a card from each of the 22 pathways',
                icon: '',
                title: 'Sequence Keeper',
                titleEffect: 'golden-shimmer',
                difficulty: 9
            },
            'quill_favored': {
                name: 'The Quill of Alzuhod Favors Me',
                desc: 'Win from 5% HP while opponent is at 100% health',
                icon: '',
                title: "Quill's Favored",
                titleEffect: 'elegant-gold',
                difficulty: 9
            },
            'lord_of_mysteries': {
                name: 'Lord of the Mysteries',
                desc: 'Win 2,000 games',
                icon: '<img src="images/lord-of-mysteries.png" style="width:24px;height:24px;vertical-align:middle;">',
                title: 'Lord of the Mysteries',
                titleEffect: 'foggy-glitch',
                difficulty: 10
            },
            'ruler_castle_fog': {
                name: 'Ruler of the Castle Above the Fog',
                desc: 'Defeat a God Mode AI',
                icon: '',
                title: 'Transmigrator',
                titleEffect: 'foggy-glitch',
                difficulty: 9
            },
            // === DAMAGE TRIUMPHS (Per Game) ===
            'calamity_unleashed': {
                name: 'Calamity Unleashed',
                desc: 'Deal over 500 damage in one game',
                icon: '',
                title: 'Agent of Catastrophe',
                titleEffect: 'flame-pulse',
                difficulty: 6
            },
            'twilight_destruction': {
                name: 'Twilight of Destruction',
                desc: 'Deal over 1000 damage in one game',
                icon: '',
                title: 'Herald of Extinction',
                titleEffect: 'meteor-glow',
                difficulty: 8
            },
            'martyrs_burden': {
                name: "Martyr's Burden",
                desc: 'Receive over 500 damage in one game',
                icon: '',
                title: 'Blood-Bound Survivor',
                titleEffect: 'blood-drip',
                difficulty: 6
            },
            'evernights_blessing': {
                name: "Evernight's Blessing",
                desc: 'Receive over 1000 damage in one game',
                icon: '',
                title: 'Sleepless Sentinel',
                titleEffect: 'moon-shimmer',
                difficulty: 8
            },
            // === DAMAGE TRIUMPHS (Per Turn) ===
            'hunters_precision': {
                name: "Hunter's Precision",
                desc: 'Deal over 500 damage in one turn',
                icon: '',
                title: 'Executioner of Fate',
                titleEffect: 'target-lock',
                difficulty: 7
            },
            'authority_unleashed': {
                name: 'Authority Unleashed',
                desc: 'Deal over 1000 damage in one turn',
                icon: '',
                title: 'Sovereign of a Single Thought',
                titleEffect: 'eye-glow',
                difficulty: 9
            },
            'abyss_touch': {
                name: "Abyss's Touch",
                desc: 'Receive over 500 damage in one turn',
                icon: '',
                title: 'Marked by Darkness',
                titleEffect: 'void-swirl',
                difficulty: 7
            },
            'door_to_death': {
                name: 'Door to Death',
                desc: 'Receive over 1000 damage in one turn',
                icon: '',
                title: 'Knower of the Final Door',
                titleEffect: 'door-creak',
                difficulty: 9
            },
            // === SPECIAL TRIUMPHS ===
            'king_yellow_black': {
                name: 'King of Yellow and Black',
                desc: 'Have a hand where all 3 cards are Big Hit cards',
                icon: '',
                title: 'King of Yellow and Black',
                titleEffect: 'royal-shimmer',
                difficulty: 10
            },
            // === OUTER DEITY / GREAT OLD ONE TRIUMPHS ===
            'true_calamity': {
                name: 'A true calamity',
                desc: 'Deal 1,000,000 total damage across your career',
                icon: '',
                title: 'Calamity of Destruction',
                titleEffect: 'frenzy-flicker',
                difficulty: 10
            },
            'god_almighty': {
                name: 'A true deity',
                desc: 'Win 20 games without taking ANY damage',
                icon: '',
                title: 'God Almighty',
                titleEffect: 'sefirah-glow',
                difficulty: 10,
                pathways: ['Visionary', 'Sun', 'Tyrant', 'Hanged Man', 'White Tower']
            },
            'mother_goddess': {
                name: 'Total eclipse',
                desc: 'Auto lose 20 games from madness',
                icon: '',
                title: 'Mother Goddess of Depravity',
                titleEffect: 'moon-shimmer',
                difficulty: 10,
                pathways: ['Mother', 'Moon']
            },
            'eternal_darkness': {
                name: 'Abyss watcher',
                desc: 'Receive 1,000,000 total damage across your career',
                icon: '',
                title: 'Eternal Darkness',
                titleEffect: 'void-pulse',
                difficulty: 10,
                pathways: ['Darkness', 'Death', 'Twilight Giant']
            },
            'authority_of_order': {
                name: 'Primordial chaos',
                desc: 'Win 50 games after being behind (opponent had more HP)',
                icon: '',
                title: 'Anarchy',
                titleEffect: 'order-pulse',
                difficulty: 10,
                pathways: ['Black Emperor', 'Justiciar']
            },
            'key_of_light': {
                name: 'Refracted edge',
                desc: 'Achieve x128 multiplier 15 times',
                icon: '',
                title: 'Key of Light',
                titleEffect: 'holy-radiance',
                difficulty: 10,
                pathways: ['Wheel of Fortune']
            },
            'father_of_devils': {
                name: 'Diablo',
                desc: 'Win 100 games after dropping below 15% HP',
                icon: '',
                title: 'Father of Devils',
                titleEffect: 'abyssal-corruption',
                difficulty: 10,
                pathways: ['Abyss', 'Chained']
            },
            'god_of_knowledge': {
                name: 'A true dictionary',
                desc: 'Win 50 games where you never lost a single damage exchange',
                icon: '',
                title: 'Demon of Knowledge',
                titleEffect: 'knowledge-glow',
                difficulty: 10,
                pathways: ['White Tower']
            }
        };

        // Pathway groups for Hidden Order achievement
        const PATHWAY_GROUPS = {
            'Sefirah Trinity': ['Fool', 'Door', 'Error'],
            'Pillar of Light': ['Sun', 'Visionary', 'White Tower', 'Tyrant', 'Hanged Man'],
            'Primal Forces': ['Mother', 'Moon', 'Twilight Giant', 'Red Priest', 'Darkness', 'Death'],
            'Corruption & Order': ['Demoness', 'Justiciar', 'Black Emperor', 'Hermit', 'Paragon'],
            'Chaos Domain': ['Abyss', 'Wheel of Fortune', 'Chained']
        };

        // Deity pathways for Outer Deity triumphs (associated pathways for display/thematic purposes)
        // Note: These triumphs are now unlocked by career stats, not pathway usage
        const DEITY_PATHWAYS = {
            'god_almighty': ['Visionary', 'Sun', 'Tyrant', 'Hanged Man', 'White Tower'],
            'mother_goddess': ['Mother', 'Moon'],
            'eternal_darkness': ['Darkness', 'Death', 'Twilight Giant'],
            'authority_of_order': ['Black Emperor', 'Justiciar'],
            'key_of_light': ['Wheel of Fortune'],
            'father_of_devils': ['Abyss', 'Chained'],
            'god_of_knowledge': ['White Tower']
        };

        // Special condition triumphs (unique requirements)
        // These are checked individually in checkHiddenTriumphsOnWin()

        // Achievement tracking state (persisted)
        let unlockedAchievements = JSON.parse(localStorage.getItem('pathwayClash_achievements') || '[]');
        let unlockedTriumphs = JSON.parse(localStorage.getItem('pathwayClash_triumphs') || '[]');
        let activeTitle = localStorage.getItem('pathwayClash_activeTitle') || null;

        // Clean up achievement arrays - remove duplicates and invalid IDs
        function cleanupAchievementData() {
            const validAchievementIds = Object.keys(ACHIEVEMENTS);
            const validTriumphIds = Object.keys(HIDDEN_TRIUMPHS);

            // Remove duplicates and invalid achievement IDs
            unlockedAchievements = [...new Set(unlockedAchievements)].filter(id => validAchievementIds.includes(id));
            // Remove duplicates and invalid triumph IDs
            unlockedTriumphs = [...new Set(unlockedTriumphs)].filter(id => validTriumphIds.includes(id));

            // Save cleaned data
            localStorage.setItem('pathwayClash_achievements', JSON.stringify(unlockedAchievements));
            localStorage.setItem('pathwayClash_triumphs', JSON.stringify(unlockedTriumphs));
        }
        // Run cleanup on load
        cleanupAchievementData();
        // Displayed achievement: { id: string, isTriumph: boolean } or null for auto (highest)
        let displayedAchievement = JSON.parse(localStorage.getItem('pathwayClash_displayedAchievement') || 'null');

        // Achievement progress tracking (persisted)
        let achievementProgress = JSON.parse(localStorage.getItem('pathwayClash_progress') || JSON.stringify({
            totalWins: 0,
            totalDamageDealt: 0,
            bigHitCardsPlayed: [],
            allCardsPlayed: [],
            mirrorMatches: 0,
            reached32x: false,
            reached64x: false,
            pathwaysWonWith: [], // Track all pathways used in winning games
            singlePathwayWins: {}, // Track wins using only one pathway type { 'Abyss': 5, 'Sun': 3, ... }
            // Supreme Triumph tracking
            careerTotalDamage: 0, // For career damage dealt tracking
            careerDamageReceived: 0, // For Eternal Darkness (1M damage received)
            flawlessWins: 0, // For God Almighty (20 wins without taking damage)
            madnessLosses: 0, // For Mother Goddess (20 auto-losses from madness)
            comebackWins: 0, // For Anarchy (50 wins after being behind)
            lowHPWins: 0, // For Father of Devils (100 wins after dropping below 15% HP)
            dominantExchangeWins: 0, // For Demon of Knowledge (50 wins never losing exchange)
            x128Count: 0, // For Key of Light (15 times x128 multiplier achieved)
            // Legacy tracking (kept for backwards compatibility)
            darknessPlusDeathWins: 0,
            motherPlusMoonWins: 0,
            massiveDamageTurns: 0,
            sunTrioWins: 0,
            abyssWins: 0,
            sunWins: 0,
            currentWinStreak: 0,
            maxWinStreak: 0,
            pathwayGroupWins: {}
        }));

        // Migration: ensure new fields exist in old saves
        if (!achievementProgress.pathwaysWonWith) achievementProgress.pathwaysWonWith = [];
        if (!achievementProgress.singlePathwayWins) achievementProgress.singlePathwayWins = {};
        if (!achievementProgress.careerTotalDamage) achievementProgress.careerTotalDamage = 0;
        if (!achievementProgress.careerDamageReceived) achievementProgress.careerDamageReceived = 0;
        if (!achievementProgress.flawlessWins) achievementProgress.flawlessWins = 0;
        if (!achievementProgress.madnessLosses) achievementProgress.madnessLosses = 0;
        if (!achievementProgress.comebackWins) achievementProgress.comebackWins = 0;
        if (!achievementProgress.lowHPWins) achievementProgress.lowHPWins = 0;
        if (!achievementProgress.dominantExchangeWins) achievementProgress.dominantExchangeWins = 0;
        if (!achievementProgress.x128Count) achievementProgress.x128Count = 0;
        // Legacy tracking migrations (kept for backwards compatibility)
        if (!achievementProgress.darknessPlusDeathWins) achievementProgress.darknessPlusDeathWins = 0;
        if (!achievementProgress.motherPlusMoonWins) achievementProgress.motherPlusMoonWins = 0;
        if (!achievementProgress.massiveDamageTurns) achievementProgress.massiveDamageTurns = 0;
        if (!achievementProgress.sunTrioWins) achievementProgress.sunTrioWins = 0;
        if (!achievementProgress.abyssWins) achievementProgress.abyssWins = 0;
        if (!achievementProgress.sunWins) achievementProgress.sunWins = 0;
        if (!achievementProgress.currentWinStreak) achievementProgress.currentWinStreak = 0;
        if (!achievementProgress.maxWinStreak) achievementProgress.maxWinStreak = 0;
        if (!achievementProgress.pathwayGroupWins) achievementProgress.pathwayGroupWins = {};

        // Per-game tracking (reset each game)
        let gameAchievementState = {};

        function resetGameAchievementState() {
            gameAchievementState = {
                firstHandCards: [],
                drewBigHitThisGame: false,
                drewBigHitThisTurn: false,
                damageDealtThisGame: 0,
                damageReceivedThisGame: 0,
                opponentHPBeforeBattle: 100,
                playerHPBeforeBattle: 100,
                turnsAtHighMadness: 0,
                // Hidden Triumph tracking
                pathwaysUsedThisGame: [],
                maxDamageReceivedInOneTurn: 0,
                maxDamageDealtInOneTurn: 0,
                wasAtHalfHPOrLess: false,
                playerHPAtTurnStart: 100,
                usedOnlyIndirectDamage: true, // Assume true, set false if direct damage used
                playerHPWhenComebackStarted: null, // For smiling clown tracking
                neverLostDamageExchange: true, // True until player loses a damage exchange
                lowestHP: 100, // Track lowest HP for comeback triumphs
                wasEverBehind: false, // True if opponent ever had more HP than player
                droppedBelow15Percent: false, // True if player HP dropped below 15% at any point
                reachedX128ThisSequence: false // Track if x128 was reached in current draw sequence
            };
        }

        function saveAchievementProgress() {
            localStorage.setItem('pathwayClash_achievements', JSON.stringify(unlockedAchievements));
            localStorage.setItem('pathwayClash_triumphs', JSON.stringify(unlockedTriumphs));
            localStorage.setItem('pathwayClash_progress', JSON.stringify(achievementProgress));
            localStorage.setItem('pathwayClash_displayedAchievement', JSON.stringify(displayedAchievement));
            if (activeTitle) {
                localStorage.setItem('pathwayClash_activeTitle', activeTitle);
            }
            // Sync to Firebase for profile visibility
            syncProfileToFirebase();
        }

        function unlockAchievement(id) {
            if (unlockedAchievements.includes(id)) return false;
            unlockedAchievements.push(id);
            saveAchievementProgress();
            showAchievementNotification(id);
            showSwitchDisplayPopup(id, false);
            updateAchievementDisplay();
            return true;
        }

        function unlockTriumph(id) {
            if (unlockedTriumphs.includes(id)) return false;
            unlockedTriumphs.push(id);
            saveAchievementProgress();
            showTriumphNotification(id);
            showSwitchDisplayPopup(id, true);
            updateAchievementDisplay();
            return true;
        }

        function setDisplayedAchievement(id, isTriumph) {
            if (id === null) {
                displayedAchievement = null;
            } else {
                displayedAchievement = { id, isTriumph };
            }
            saveAchievementProgress();
            updateAchievementDisplay();
        }

        function showSwitchDisplayPopup(id, isTriumph) {
            const item = isTriumph ? HIDDEN_TRIUMPHS[id] : ACHIEVEMENTS[id];
            if (!item) return;

            const popup = document.getElementById('switch-display-popup');
            const nameEl = document.getElementById('switch-display-name');
            const iconEl = document.getElementById('switch-display-icon');

            iconEl.textContent = item.icon;
            // For triumphs, show the title instead of the achievement name
            nameEl.textContent = isTriumph ? item.title : item.name;
            popup.dataset.achievementId = id;
            popup.dataset.isTriumph = isTriumph;
            popup.classList.add('show');
        }

        function confirmSwitchDisplay() {
            const popup = document.getElementById('switch-display-popup');
            const id = popup.dataset.achievementId;
            const isTriumph = popup.dataset.isTriumph === 'true';
            setDisplayedAchievement(id, isTriumph);
            popup.classList.remove('show');
        }

        function cancelSwitchDisplay() {
            document.getElementById('switch-display-popup').classList.remove('show');
        }

        function setActiveTitle(triumphId) {
            if (triumphId && !unlockedTriumphs.includes(triumphId)) return false;
            activeTitle = triumphId;
            localStorage.setItem('pathwayClash_activeTitle', activeTitle || '');
            updateTitleDisplay();
            // Sync to Firebase for profile visibility
            syncProfileToFirebase();
            return true;
        }

        function showAchievementNotification(id) {
            const achievement = ACHIEVEMENTS[id];
            if (!achievement) return;

            const notification = document.createElement('div');
            notification.className = 'achievement-notification';
            notification.innerHTML = `
                <div class="achievement-notification-icon">${achievement.icon}</div>
                <div class="achievement-notification-text">
                    <div class="achievement-notification-title">Achievement Unlocked!</div>
                    <div class="achievement-notification-name">${achievement.name}</div>
                </div>
            `;
            document.body.appendChild(notification);

            setTimeout(() => notification.classList.add('show'), 100);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 500);
            }, 4000);
        }

        function showTriumphNotification(id) {
            const triumph = HIDDEN_TRIUMPHS[id];
            if (!triumph) return;

            const notification = document.createElement('div');
            notification.className = 'triumph-notification';
            notification.innerHTML = `
                <div class="triumph-notification-icon">${triumph.icon}</div>
                <div class="triumph-notification-text">
                    <div class="triumph-notification-title">Hidden Triumph Unlocked!</div>
                    <div class="triumph-notification-name title-text ${triumph.titleEffect}">${triumph.title}</div>
                    <div class="triumph-notification-subtitle" style="font-size: 10px; color: var(--color-text-muted);">${triumph.name}</div>
                </div>
            `;
            document.body.appendChild(notification);

            setTimeout(() => notification.classList.add('show'), 100);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 500);
            }, 5000);
        }

        function updateTitleDisplay() {
            // Update any title display elements
            const titleDisplay = document.getElementById('player-title');
            if (titleDisplay) {
                if (activeTitle && HIDDEN_TRIUMPHS[activeTitle]) {
                    const triumph = HIDDEN_TRIUMPHS[activeTitle];
                    titleDisplay.innerHTML = `<span class="title-text ${triumph.titleEffect}">${triumph.title}</span>`;
                    titleDisplay.style.display = 'block';
                } else {
                    titleDisplay.style.display = 'none';
                }
            }
        }

        function updateAchievementDisplay() {
            const list = document.getElementById('achievement-list');
            if (unlockedAchievements.length === 0 && unlockedTriumphs.length === 0) {
                list.innerHTML = '<div class="achievement-placeholder">No achievements yet</div>';
                return;
            }

            let displayId = null;
            let isTriumph = false;

            // Check if user has a selected achievement to display
            if (displayedAchievement) {
                const { id, isTriumph: isT } = displayedAchievement;
                // Verify it's still unlocked
                if (isT && unlockedTriumphs.includes(id)) {
                    displayId = id;
                    isTriumph = true;
                } else if (!isT && unlockedAchievements.includes(id)) {
                    displayId = id;
                    isTriumph = false;
                }
            }

            // Fall back to highest difficulty if no valid selection
            if (!displayId) {
                let highestDifficulty = -1;

                unlockedAchievements.forEach(id => {
                    const a = ACHIEVEMENTS[id];
                    if (a && a.difficulty > highestDifficulty) {
                        highestDifficulty = a.difficulty;
                        displayId = id;
                        isTriumph = false;
                    }
                });

                unlockedTriumphs.forEach(id => {
                    const t = HIDDEN_TRIUMPHS[id];
                    if (t && t.difficulty > highestDifficulty) {
                        highestDifficulty = t.difficulty;
                        displayId = id;
                        isTriumph = true;
                    }
                });
            }

            if (!displayId) {
                list.innerHTML = '<div class="achievement-placeholder">No achievements yet</div>';
                return;
            }

            const a = isTriumph ? HIDDEN_TRIUMPHS[displayId] : ACHIEVEMENTS[displayId];
            const totalAchievements = Object.keys(ACHIEVEMENTS).length;
            const totalTriumphs = Object.keys(HIDDEN_TRIUMPHS).length;

            let countText = `${unlockedAchievements.length}/${totalAchievements}`;
            if (unlockedTriumphs.length > 0) {
                countText += ` + ${unlockedTriumphs.length}/? `;
            }

            let titleHtml = '';
            if (isTriumph && a.title) {
                titleHtml = `<div class="achievement-title">Title: <span class="title-text ${a.titleEffect}">${a.title}</span></div>`;
            }

            // For triumphs, show the title as the main display name
            const displayName = isTriumph ? a.title : a.name;

            list.innerHTML = `
                <div class="achievement-item ${isTriumph ? 'triumph' : ''}" onclick="toggleAchievement(this)">
                    <div class="achievement-header">
                        <span class="achievement-icon">${a.icon}</span>
                        <span class="achievement-name ${isTriumph ? 'title-text ' + a.titleEffect : ''}">${displayName}</span>
                        <span class="achievement-difficulty">${isTriumph ? '' : ''}${a.difficulty}</span>
                    </div>
                    <div class="achievement-desc">${a.desc}</div>
                </div>
                <div class="achievement-count">${countText} unlocked</div>
            `;
        }

        function toggleAchievement(element) {
            element.classList.toggle('expanded');
        }

        function selectDisplayAchievement(id, isTriumph) {
            setDisplayedAchievement(id, isTriumph);
            // Refresh modal to show updated selection
            openAchievementModal();
        }

        function openAchievementModal() {
            const modal = document.getElementById('achievement-modal');
            const body = document.getElementById('achievement-modal-body');

            // Group achievements by difficulty
            const byDifficulty = {};
            Object.entries(ACHIEVEMENTS).forEach(([id, a]) => {
                const diff = a.difficulty;
                if (!byDifficulty[diff]) byDifficulty[diff] = [];
                byDifficulty[diff].push({ id, ...a });
            });

            // Build HTML grouped by difficulty
            let html = '';
            const diffLabels = {
                1: 'Beginner', 2: 'Easy', 3: 'Easy', 4: 'Normal',
                5: 'Normal', 6: 'Moderate', 7: 'Hard', 8: 'Hard',
                9: 'Very Hard', 10: 'Legendary'
            };

            Object.keys(byDifficulty).sort((a, b) => a - b).forEach(diff => {
                const achievements = byDifficulty[diff];
                html += `<div class="achievement-modal-section">
                    <h3>${diff} - ${diffLabels[diff]}</h3>
                    <div class="achievement-modal-grid">`;

                achievements.forEach(a => {
                    const isUnlocked = unlockedAchievements.includes(a.id);
                    const isSelected = displayedAchievement && !displayedAchievement.isTriumph && displayedAchievement.id === a.id;
                    const clickHandler = isUnlocked ? `onclick="selectDisplayAchievement('${a.id}', false)"` : '';
                    html += `<div class="achievement-modal-item ${isUnlocked ? 'unlocked selectable' : 'locked'} ${isSelected ? 'selected' : ''}" ${clickHandler}>
                        <span class="ach-icon">${a.icon}</span>
                        <div class="ach-info">
                            <div class="ach-name">${a.name}</div>
                            <div class="ach-desc">${a.desc}</div>
                        </div>
                        ${isSelected ? '<span class="selected-badge">Displayed</span>' : ''}
                    </div>`;
                });

                html += `</div></div>`;
            });

            // Add Hidden Triumphs section - ONLY if player has unlocked at least one
            // Only show unlocked triumphs - don't reveal how many exist
            if (unlockedTriumphs.length > 0) {
                html += `<div class="achievement-modal-section triumph-section">
                    <h3> Hidden Triumphs</h3>
                    <p style="font-size: 10px; color: var(--color-text-dim); margin-bottom: 10px;">Online matches only. Grants titles instead of rewards.</p>`;

                // Group ONLY unlocked triumphs by difficulty
                const unlockedTriumphsByDiff = {};
                unlockedTriumphs.forEach(id => {
                    const t = HIDDEN_TRIUMPHS[id];
                    if (t) {
                        const diff = t.difficulty || 5;
                        if (!unlockedTriumphsByDiff[diff]) unlockedTriumphsByDiff[diff] = [];
                        unlockedTriumphsByDiff[diff].push({ id, ...t });
                    }
                });

                Object.keys(unlockedTriumphsByDiff).sort((a, b) => a - b).forEach(diff => {
                    html += `<div class="triumph-diff-group">
                        <h4 style="color: #aa44ff; font-size: 11px; margin: 10px 0 5px 0;">${diff} - ${diffLabels[diff]}</h4>
                        <div class="achievement-modal-grid">`;

                    unlockedTriumphsByDiff[diff].forEach(t => {
                        const isSelected = displayedAchievement && displayedAchievement.isTriumph && displayedAchievement.id === t.id;
                        html += `<div class="achievement-modal-item triumph-item unlocked selectable ${isSelected ? 'selected' : ''}" onclick="selectDisplayAchievement('${t.id}', true)">
                            <span class="ach-icon">${t.icon}</span>
                            <div class="ach-info">
                                <div class="ach-name title-text ${t.titleEffect}">${t.title}</div>
                                <div class="ach-desc">${t.desc}</div>
                                <div class="ach-triumph-name" style="font-size: 9px; color: #777; margin-top: 2px;">${t.name}</div>
                            </div>
                            ${isSelected ? '<span class="selected-badge">Displayed</span>' : ''}
                        </div>`;
                    });

                    html += `</div></div>`;
                });

                html += `</div>`;
            }

            body.innerHTML = html;
            modal.classList.add('show');
        }

        function closeAchievementModal() {
            document.getElementById('achievement-modal').classList.remove('show');
        }

        function checkAchievementsOnDraw(hand) {
            // Check for Big Hit cards in hand
            const currentBigHits = getCurrentBigHitList();
            const bigHitsInHand = hand.filter(card => currentBigHits.includes(card.name));

            if (bigHitsInHand.length > 0) {
                // First Big Hit ever
                unlockAchievement('good_luck');
                gameAchievementState.drewBigHitThisGame = true;
                gameAchievementState.drewBigHitThisTurn = true;

                // Big Hit on turn 1
                if (gameState.turn === 1) {
                    unlockAchievement('fortune_bold');
                }
            }

            // King of Yellow and Black - all cards in hand are Big Hit cards
            if (bigHitsInHand.length === hand.length && hand.length > 0) {
                unlockTriumph('king_yellow_black');
            }

            // Store first hand cards
            if (gameState.turn === 1) {
                gameAchievementState.firstHandCards = hand.map(c => c.name);
            }
        }

        function checkAchievementsOnPlay(playerCard, opponentCard, result, damageDealt, damageReceived, opponentHPBefore, playerHPBefore, multiplierBefore) {
            // Track cards played
            const currentBigHits = getCurrentBigHitList();
            if (!achievementProgress.allCardsPlayed.includes(playerCard)) {
                achievementProgress.allCardsPlayed.push(playerCard);
            }
            if (currentBigHits.includes(playerCard) && !achievementProgress.bigHitCardsPlayed.includes(playerCard)) {
                achievementProgress.bigHitCardsPlayed.push(playerCard);
            }

            // Track pathways used this game (for Hidden Triumphs)
            if (!gameAchievementState.pathwaysUsedThisGame.includes(playerCard)) {
                gameAchievementState.pathwaysUsedThisGame.push(playerCard);
            }

            // Track max damage received in one turn (for Smiling Clown)
            if (damageReceived > gameAchievementState.maxDamageReceivedInOneTurn) {
                gameAchievementState.maxDamageReceivedInOneTurn = damageReceived;
            }

            // Track if player HP dropped to half or less (for comeback tracking)
            const playerHPAfter = playerHPBefore - damageReceived;
            if (playerHPAfter <= 50 && playerHPBefore > 50) {
                gameAchievementState.wasAtHalfHPOrLess = true;
            }

            // Magic Mirror - same card as opponent
            if (playerCard === opponentCard) {
                achievementProgress.mirrorMatches++;
                if (achievementProgress.mirrorMatches >= 5) {
                    unlockAchievement('magic_mirror');
                }
            }

            // Track damage dealt and received
            gameAchievementState.damageDealtThisGame += damageDealt;
            gameAchievementState.damageReceivedThisGame += damageReceived;

            // Track career damage received for Eternal Darkness triumph
            if (damageReceived > 0) {
                achievementProgress.careerDamageReceived += damageReceived;
            }

            // Track career damage dealt for Calamity of Destruction triumph
            if (damageDealt > 0) {
                achievementProgress.careerTotalDamage += damageDealt;
            }

            // Track if player was ever behind (opponent had more HP) for Anarchy triumph
            const playerHPAfterBattle = playerHPBefore - damageReceived;
            const opponentHPAfterBattle = opponentHPBefore - damageDealt;
            if (opponentHPAfterBattle > playerHPAfterBattle) {
                gameAchievementState.wasEverBehind = true;
            }

            // Track if player dropped below 15% HP for Father of Devils triumph
            if (playerHPAfterBattle < 15 && playerHPAfterBattle > 0) {
                gameAchievementState.droppedBelow15Percent = true;
            }

            // Track lowest HP for triumph tracking
            if (playerHPAfterBattle < gameAchievementState.lowestHP) {
                gameAchievementState.lowestHP = playerHPAfterBattle;
            }

            // Track if player lost a damage exchange (for Demon of Knowledge)
            // Player loses exchange if they took damage and opponent didn't, or took more damage
            if (result.outcome === 'LOSE' || (result.outcome === 'DRAW' && damageReceived > damageDealt)) {
                gameAchievementState.neverLostDamageExchange = false;
            }

            // No Mercy - 50+ damage in one round
            if (damageDealt >= 50) {
                unlockAchievement('no_mercy');
            }

            // Hunter's Precision - 500+ damage in one turn
            if (damageDealt >= 500) {
                unlockTriumph('hunters_precision');
            }

            // Authority Unleashed - 1000+ damage in one turn
            if (damageDealt >= 1000) {
                unlockTriumph('authority_unleashed');
            }

            // Abyss's Touch - receive 500+ damage in one turn
            if (damageReceived >= 500) {
                unlockTriumph('abyss_touch');
            }

            // Door to Death - receive 1000+ damage in one turn
            if (damageReceived >= 1000) {
                unlockTriumph('door_to_death');
            }

            // Calamity Unleashed - 500+ damage in one game
            if (gameAchievementState.damageDealtThisGame >= 500) {
                unlockTriumph('calamity_unleashed');
            }

            // Twilight of Destruction - 1000+ damage in one game
            if (gameAchievementState.damageDealtThisGame >= 1000) {
                unlockTriumph('twilight_destruction');
            }

            // Martyr's Burden - receive 500+ damage in one game
            if (gameAchievementState.damageReceivedThisGame >= 500) {
                unlockTriumph('martyrs_burden');
            }

            // Evernight's Blessing - receive 1000+ damage in one game
            if (gameAchievementState.damageReceivedThisGame >= 1000) {
                unlockTriumph('evernights_blessing');
            }

            // Check multiplier achievements using the multiplier BEFORE it was modified
            if (multiplierBefore >= 32) {
                achievementProgress.reached32x = true;
            }
            if (multiplierBefore >= 64) {
                achievementProgress.reached64x = true;
            }
            if (achievementProgress.reached32x && achievementProgress.reached64x) {
                unlockAchievement('high_roller');
            }
            if (multiplierBefore >= 128) {
                unlockAchievement('unstoppable_force');
                // Track x128 achievement for Key of Light triumph (only count once per instance)
                // This triggers when we reach 128 for the first time in a game sequence
                if (!gameAchievementState.reachedX128ThisSequence) {
                    gameAchievementState.reachedX128ThisSequence = true;
                    achievementProgress.x128Count++;
                }
            }

            // The Fool of This Era - played all Big Hit cards
            if (achievementProgress.bigHitCardsPlayed.length >= getCurrentBigHitList().length) {
                unlockAchievement('fool_of_era');
            }

            // Sequence 0 - played all cards
            if (achievementProgress.allCardsPlayed.length >= getCurrentPathways().length) {
                unlockAchievement('sequence_0');
            }

            // Store HP BEFORE battle for achievement checks on game end
            gameAchievementState.opponentHPBeforeBattle = opponentHPBefore;
            gameAchievementState.playerHPBeforeBattle = playerHPBefore;

            saveAchievementProgress();
        }

        function checkAchievementsOnGameEnd(playerWon, isTie) {
            // Joined the Tarot Club - first online game
            if (gameMode === 'pvp') {
                unlockAchievement('joined_tarot_club');
            }

            if (playerWon) {
                achievementProgress.totalWins++;

                // Mission Accomplished - first online win
                if (gameMode === 'pvp') {
                    unlockAchievement('mission_accomplished');
                }

                // Pathway Adept - 100 wins
                if (achievementProgress.totalWins >= 100) {
                    unlockAchievement('pathway_adept');
                }

                // Close Call - win with <20% health
                if (gameState.playerHP < 20 && gameState.playerHP > 0) {
                    unlockAchievement('close_call');
                }

                // Paper Figurine - win with 100 health
                if (gameState.playerHP === 100) {
                    unlockAchievement('paper_figurine');
                }

                // Hanged Man - dealt 100+ damage this game
                if (gameAchievementState.damageDealtThisGame >= 100) {
                    unlockAchievement('hanged_man');
                }

                // Silver Bullet - opponent was at full health before fatal blow
                if (gameAchievementState.opponentHPBeforeBattle === 100) {
                    unlockAchievement('silver_bullet');
                }

                // Written in the Stars - holding a first-hand card at win
                const currentHandNames = gameState.playerHand.map(c => c.name);
                const hasFirstHandCard = gameAchievementState.firstHandCards.some(name => currentHandNames.includes(name));
                if (hasFirstHandCard) {
                    unlockAchievement('written_in_stars');
                }

                // The Star Still Shines - won without drawing Big Hit
                if (!gameAchievementState.drewBigHitThisGame) {
                    unlockAchievement('star_still_shines');
                }

                // Dawn of the Fool - won same turn as drawing Big Hit
                if (gameAchievementState.drewBigHitThisTurn) {
                    unlockAchievement('dawn_of_fool');
                }

                // Ruler of the Castle Above the Fog - beat God Mode AI
                if (gameMode === 'ai' && aiDifficulty === 'god') {
                    unlockTriumph('ruler_castle_fog');
                }
            }

            // Well That's Unfortunate - tie when both were full HP before the final battle
            if (isTie && gameAchievementState.opponentHPBeforeBattle === 100 && gameAchievementState.playerHPBeforeBattle === 100) {
                unlockAchievement('unfortunate');
            }

            // Check Hidden Triumphs (online only)
            if (gameMode === 'pvp' && playerWon) {
                checkHiddenTriumphsOnWin();
            }

            saveAchievementProgress();
        }

        function checkHiddenTriumphsOnWin() {
            // Track pathways used in winning games
            gameAchievementState.pathwaysUsedThisGame.forEach(pathway => {
                if (!achievementProgress.pathwaysWonWith.includes(pathway)) {
                    achievementProgress.pathwaysWonWith.push(pathway);
                }
            });

            // Antigonous's Notebook - won with all 22 pathways (across games)
            if (achievementProgress.pathwaysWonWith.length >= 22) {
                unlockTriumph('antigonous_notebook');
            }

            // Quill's Favored - win from 5% HP while opponent at 100%
            if (gameState.playerHP <= 5 && gameAchievementState.opponentHPBeforeBattle === 100) {
                // This checks if we were at 5% or less when we won AND opponent was full
                // But we need to check our HP BEFORE the winning hit, not after
                // Actually, we need to track when we were at 5% and then won
            }

            // Check if player was at 5% or less at any point and opponent is now at 0 from 100%
            // For Quill's Favored - we need to track lowest HP during game
            // For now, check if player HP is very low and won against full HP opponent
            if (gameAchievementState.playerHPBeforeBattle <= 5 &&
                gameAchievementState.opponentHPBeforeBattle === 100) {
                unlockTriumph('quill_favored');
            }

            // Smiling Clown - lost half HP in one turn but won
            // Check if we took massive damage at some point and came back
            if (gameAchievementState.maxDamageReceivedInOneTurn >= 50 &&
                gameAchievementState.wasAtHalfHPOrLess) {
                unlockTriumph('smiling_clown');
            }

            // Hidden Order - won using only pathways from a single group
            if (gameAchievementState.pathwaysUsedThisGame.length > 0) {
                for (const [groupName, pathways] of Object.entries(PATHWAY_GROUPS)) {
                    const allFromGroup = gameAchievementState.pathwaysUsedThisGame.every(
                        p => pathways.includes(p)
                    );
                    if (allFromGroup) {
                        unlockTriumph('hidden_order');
                        break;
                    }
                }
            }

            // Lord of the Mysteries - 2000 wins
            if (achievementProgress.totalWins >= 2000) {
                unlockTriumph('lord_of_mysteries');
            }

            // === OUTER DEITY TRIUMPHS ===
            // These are unlocked based on career stats, tracked incrementally

            // God Almighty - Win 20 games without taking ANY damage
            if (gameAchievementState.damageReceivedThisGame === 0) {
                achievementProgress.flawlessWins++;
                if (achievementProgress.flawlessWins >= 20) {
                    unlockTriumph('god_almighty');
                }
            }

            // Anarchy (Authority of Order) - Win 50 games after being behind (opponent had more HP)
            if (gameAchievementState.wasEverBehind) {
                achievementProgress.comebackWins++;
                if (achievementProgress.comebackWins >= 50) {
                    unlockTriumph('authority_of_order');
                }
            }

            // Father of Devils - Win 100 games after dropping below 15% HP
            if (gameAchievementState.droppedBelow15Percent) {
                achievementProgress.lowHPWins++;
                if (achievementProgress.lowHPWins >= 100) {
                    unlockTriumph('father_of_devils');
                }
            }

            // Demon of Knowledge - Win 50 games where you never lost a single damage exchange
            if (gameAchievementState.neverLostDamageExchange) {
                achievementProgress.dominantExchangeWins++;
                if (achievementProgress.dominantExchangeWins >= 50) {
                    unlockTriumph('god_of_knowledge');
                }
            }

            // Key of Light - Achieve x128 multiplier 15 times (tracked elsewhere, check here)
            if (achievementProgress.x128Count >= 15) {
                unlockTriumph('key_of_light');
            }

            // Eternal Darkness - Receive 1,000,000 total damage (tracked elsewhere, check here)
            if (achievementProgress.careerDamageReceived >= 1000000) {
                unlockTriumph('eternal_darkness');
            }

            // Calamity of Destruction - Deal 1,000,000 total damage
            if (achievementProgress.careerTotalDamage >= 1000000) {
                unlockTriumph('true_calamity');
            }

            // Mother Goddess - Auto lose 20 games from madness (tracked in madness loss handler)
            if (achievementProgress.madnessLosses >= 20) {
                unlockTriumph('mother_goddess');
            }

            // Note: These triumphs require systems not yet implemented:
            // - risk_taker: needs madness system (95% madness)
            // - impossibly_rational: needs madness system (0% madness)
            // - marionettist: needs indirect damage tracking
        }

        function resetGameState() {
            // God Mode: AI starts with 200 HP
            const godModeHP = (gameMode === 'ai' && aiDifficulty === 'god') ? 200 : 100;
            gameState = {
                playerHP: 100,
                opponentHP: godModeHP,
                playerHand: [],
                opponentHand: [],
                selectedCard: null,
                damageMultiplier: 1,
                gameOver: false,
                turn: 1,
                // Ability phase state
                abilityPhaseActive: false,
                abilityUsedThisTurn: false,
                selectedAbility: null,
                // Ability effects state
                priorPlayerHand: [],
                priorOpponentHand: [],
                nextTurnEffects: [],
                opponentBlinded: false,
                playerBlinded: false,
                opponentAbilityBlocked: false,
                playerAbilityBlocked: false,
                foolDecoyActive: false,
                foolDecoyCardIndex: null,
                foolDecoyIsReal: null,
                forcedPlayerCard: null,
                forcedOpponentCard: null,
                guaranteedPlayerPathway: null,
                guaranteedOpponentPathway: null,
                extraCardNextTurn: false,
                opponentExtraCard: false,
                abilitiesCancelled: false,
                stealthPeekCards: null,
                opponentUsedAbility: false,
                aiPendingAbility: null,
                playerPendingAbility: null,
                handsRevealed: false,
                // Inner God (Above the Sequences) tracking
                drawnPathwaysThisGame: new Set(),
                availableInnerGods: [],
                playingInnerGod: null,
                // Madness system
                playerMadness: 0,
                opponentMadness: 0,
                // Outer Deity effects
                playerConsumedTurns: 0,
                opponentConsumedTurns: 0,
                playerDesireDiscard: false
            };
            cardHistory = [];
            battleHistory = [];
            // Clear Inner God summon area
            updateInnerGodSummonArea();
            myCardPlayed = null;
            opponentCardPlayed = null;
            myAbilitySelected = null;
            opponentAbilitySelected = null;
            waitingForOpponentAbility = false;
            waitingForOpponent = false;
            resetGameAchievementState();

            DOM.get('game-over').classList.remove('show');
            DOM.get('log-content').innerHTML = '<div class="log-entry info">Click New Game to begin!</div>';

            // Show New Game button and clear player hand display
            DOM.get('new-game-btn').classList.add('show');
            DOM.get('player-hand').innerHTML = '';

            const playerPlayedEl = DOM.get('player-played');
            const opponentPlayedEl = DOM.get('opponent-played');

            playerPlayedEl.className = 'played-card empty';
            playerPlayedEl.style.background = '';
            playerPlayedEl.innerHTML = '<div>Your Card</div>';

            opponentPlayedEl.className = 'played-card empty';
            opponentPlayedEl.style.background = '';
            opponentPlayedEl.innerHTML = '<div>Opponent\'s Card</div>';

            updateUI();
        }

        // Actually start the game (draw hands, show ability phase)
        window.beginGame = function() {
            DOM.get('log-content').innerHTML = '<div class="log-entry info">Game started! Select a card from your hand.</div>';
            // Hide New Game button during active gameplay
            DOM.get('new-game-btn').classList.remove('show');
            drawHands();
            renderHand();
            renderOpponentHand();
            showAbilityPhase();
        }

        // ============================================
        // GAME FUNCTIONS
        // ============================================

        function drawHands() {
            gameAchievementState.drewBigHitThisTurn = false;

            // Save prior hands for Knowledge ability
            gameState.priorPlayerHand = [...gameState.playerHand];
            gameState.priorOpponentHand = [...gameState.opponentHand];

            // Determine card counts (base 3, or 4 with extra card effect)
            const playerCardCount = gameState.extraCardNextTurn ? 4 : 3;
            const opponentCardCount = gameState.opponentExtraCard ? 4 : 3;

            // Draw new hands (use different pool for opponent in inner_vs_outer mode)
            gameState.playerHand = getWeightedRandomCards(playerCardCount);
            if (gameType === 'inner_vs_outer') {
                gameState.opponentHand = getOpponentWeightedRandomCards(opponentCardCount);
            } else {
                gameState.opponentHand = getWeightedRandomCards(opponentCardCount);
            }

            // Easy/Medium AI handicap: Give AI cards that the player can beat
            if (gameMode === 'ai' && (aiDifficulty === 'easy' || aiDifficulty === 'medium')) {
                const opponentPaths = getOpponentPathways();
                const handicapChance = aiDifficulty === 'easy' ? 0.85 : 0.5; // 85% for easy, 50% for medium

                // For each AI card, try to replace it with a card the player beats
                for (let i = 0; i < gameState.opponentHand.length; i++) {
                    if (Math.random() < handicapChance) {
                        // Pick a random player card to find a loser against
                        const targetPlayerCard = gameState.playerHand[Math.floor(Math.random() * gameState.playerHand.length)];
                        if (targetPlayerCard) {
                            // Find a card that LOSES to the player's card
                            const losers = [];
                            for (const opCard of opponentPaths) {
                                const result = getMatchupResult(targetPlayerCard.name, opCard.name);
                                if (result.outcome === 'WIN') {
                                    losers.push(opCard);
                                }
                            }
                            if (losers.length > 0) {
                                // Replace AI card with a loser
                                const loserCard = losers[Math.floor(Math.random() * losers.length)];
                                gameState.opponentHand[i] = loserCard;
                            }
                        }
                    }
                }
            }

            // God Mode AI cheats: EXTREME manipulation
            if (gameMode === 'ai' && aiDifficulty === 'god') {
                const playerPaths = getCurrentPathways();
                const opponentPaths = getOpponentPathways();
                const lowTier = getCurrentLowTierList();
                const opponentMatchups = getCurrentMatchups();

                // Track which indices have been sabotaged to avoid duplicates
                const sabotagedIndices = new Set();

                // CHEAT 1: 70% chance to sabotage player's first card
                if (Math.random() < 0.7 && lowTier.length > 0 && gameState.playerHand.length > 0) {
                    const randomLow = lowTier[Math.floor(Math.random() * lowTier.length)];
                    const lowCard = playerPaths.find(p => p.name === randomLow);
                    if (lowCard) {
                        const replaceIndex = Math.floor(Math.random() * gameState.playerHand.length);
                        gameState.playerHand[replaceIndex] = lowCard;
                        sabotagedIndices.add(replaceIndex);
                    }
                }

                // CHEAT 2: 40% chance to sabotage a SECOND player card (different from first)
                if (Math.random() < 0.4 && lowTier.length > 0 && gameState.playerHand.length > 1) {
                    const randomLow = lowTier[Math.floor(Math.random() * lowTier.length)];
                    const lowCard = playerPaths.find(p => p.name === randomLow);
                    if (lowCard) {
                        // Get available indices that haven't been sabotaged
                        const availableIndices = [];
                        for (let i = 0; i < gameState.playerHand.length; i++) {
                            if (!sabotagedIndices.has(i)) availableIndices.push(i);
                        }
                        if (availableIndices.length > 0) {
                            const replaceIndex = availableIndices[Math.floor(Math.random() * availableIndices.length)];
                            gameState.playerHand[replaceIndex] = lowCard;
                        }
                    }
                }

                // CHEAT 3: AI gets a 4th card
                if (gameState.opponentHand.length === 3) {
                    const extraCard = opponentPaths[Math.floor(Math.random() * opponentPaths.length)];
                    gameState.opponentHand.push(extraCard);
                }

                // CHEAT 4: 60% chance to guarantee AI has a counter for each player card
                if (Math.random() < 0.6) {
                    // Pick a random player card and find a counter
                    const targetPlayerCard = gameState.playerHand[Math.floor(Math.random() * gameState.playerHand.length)];
                    if (targetPlayerCard) {
                        // Find a card that beats it with Low or Mid diff
                        for (const opCard of opponentPaths) {
                            const result = getMatchupResult(opCard.name, targetPlayerCard.name);
                            if (result.outcome === 'WIN' && (result.diff === 'Low' || result.diff === 'Mid')) {
                                // Replace AI's worst card with this counter
                                gameState.opponentHand[0] = opCard;
                                break;
                            }
                        }
                    }
                }

                // CHEAT 5: AI regenerates 5 HP per turn (capped at 200)
                if (gameState.turn > 1) {
                    gameState.opponentHP = Math.min(200, gameState.opponentHP + 5);
                }
            }

            // Door ability: extra card is guaranteed medium hit or higher
            const currentPathways = getCurrentPathways();
            const currentBigHits = getCurrentBigHitList();
            const currentMediumHits = getCurrentMediumHitList();

            // Opponent pathways for inner_vs_outer mode
            const opponentPathwaysList = getOpponentPathways();
            const opponentBigHits = getOpponentBigHitList();
            const opponentMediumHits = getOpponentMediumHitList();

            if (gameState.extraCardNextTurn && gameState.playerHand.length > 3) {
                const mediumOrHigher = [...currentBigHits, ...currentMediumHits];
                if (mediumOrHigher.length > 0) {
                    const randomName = mediumOrHigher[Math.floor(Math.random() * mediumOrHigher.length)];
                    const guaranteedCard = currentPathways.find(p => p.name === randomName);
                    if (guaranteedCard) {
                        gameState.playerHand[3] = guaranteedCard;
                    }
                }
            }
            if (gameState.opponentExtraCard && gameState.opponentHand.length > 3) {
                const mediumOrHigher = [...opponentBigHits, ...opponentMediumHits];
                if (mediumOrHigher.length > 0) {
                    const randomName = mediumOrHigher[Math.floor(Math.random() * mediumOrHigher.length)];
                    const guaranteedCard = opponentPathwaysList.find(p => p.name === randomName);
                    if (guaranteedCard) {
                        gameState.opponentHand[3] = guaranteedCard;
                    }
                }
            }

            // Apply guaranteed pathways (Fate/Authority)
            if (gameState.guaranteedPlayerPathway) {
                const pathway = currentPathways.find(p => p.name === gameState.guaranteedPlayerPathway);
                if (pathway && gameState.playerHand.length > 0) {
                    gameState.playerHand[0] = pathway;
                }
                gameState.guaranteedPlayerPathway = null;
            }

            if (gameState.guaranteedOpponentPathway) {
                const pathway = opponentPathwaysList.find(p => p.name === gameState.guaranteedOpponentPathway);
                if (pathway && gameState.opponentHand.length > 0) {
                    gameState.opponentHand[0] = pathway;
                }
                gameState.guaranteedOpponentPathway = null;
            }

            // Apply next turn effects
            gameState.nextTurnEffects.forEach(effect => {
                if (effect.type === 'recallCard') {
                    if (effect.target === 'player' && effect.card) {
                        // Replace first card with recalled card
                        gameState.playerHand[0] = effect.card;
                    } else if (effect.target === 'opponent' && effect.card) {
                        gameState.opponentHand[0] = effect.card;
                    }
                } else if (effect.type === 'guaranteeCard') {
                    if (effect.target === 'player' && effect.card) {
                        gameState.playerHand[0] = effect.card;
                    } else if (effect.target === 'opponent' && effect.card) {
                        gameState.opponentHand[0] = effect.card;
                    }
                }
            });
            gameState.nextTurnEffects = [];

            // Clear turn-based effects
            gameState.extraCardNextTurn = false;
            gameState.opponentExtraCard = false;
            gameState.abilitiesCancelled = false;

            // ============================================
            // OUTER DEITY TURN-BASED EFFECTS
            // ============================================

            // High-Dimensional Overseer: Force random card selection
            if (gameState.playerForcedRandomTurns > 0) {
                const randomIndex = Math.floor(Math.random() * gameState.playerHand.length);
                gameState.forcedPlayerCard = gameState.playerHand[randomIndex].name;
                // Force-select this card immediately
                gameState.selectedCard = randomIndex;
                addLogEntry(`Forced Fate: You must play ${gameState.forcedPlayerCard} (${gameState.playerForcedRandomTurns} turns remaining)`, 'info');
                gameState.playerForcedRandomTurns--;
            }
            if (gameState.opponentForcedRandomTurns > 0) {
                const randomIndex = Math.floor(Math.random() * gameState.opponentHand.length);
                gameState.forcedOpponentCard = gameState.opponentHand[randomIndex].name;
                addLogEntry(`Forced Fate: Opponent must play ${gameState.forcedOpponentCard} (${gameState.opponentForcedRandomTurns} turns remaining)`, 'info');
                gameState.opponentForcedRandomTurns--;
            }

            // Primordial Hunger: Consume a random card from target
            if (gameState.playerConsumedTurns > 0 && gameState.playerHand.length > 0) {
                const consumeIndex = Math.floor(Math.random() * gameState.playerHand.length);
                const consumed = gameState.playerHand.splice(consumeIndex, 1)[0];
                addLogEntry(`Primordial Maw consumes your ${consumed.name}! (${gameState.playerConsumedTurns} turns remaining)`, 'lose');
                gameState.playerConsumedTurns--;
            }
            if (gameState.opponentConsumedTurns > 0 && gameState.opponentHand.length > 0) {
                const consumeIndex = Math.floor(Math.random() * gameState.opponentHand.length);
                const consumed = gameState.opponentHand.splice(consumeIndex, 1)[0];
                addLogEntry(`Primordial Maw consumes opponent's ${consumed.name}! (${gameState.opponentConsumedTurns} turns remaining)`, 'win');
                gameState.opponentConsumedTurns--;
            }

            // Mother Tree of Desire: Extra draws then risky discard
            if (gameState.playerExtraDraws > 0) {
                for (let i = 0; i < gameState.playerExtraDraws; i++) {
                    const extraCard = getWeightedRandomCards(1)[0];
                    if (extraCard) gameState.playerHand.push(extraCard);
                }
                addLogEntry(`Unpredictable Growth! You drew ${gameState.playerExtraDraws} extra cards!`, 'info');
                gameState.playerExtraDraws = 0;
            }
            if (gameState.playerDesireDiscard && gameState.playerHand.length > 0) {
                const discardIndex = Math.floor(Math.random() * gameState.playerHand.length);
                const discarded = gameState.playerHand.splice(discardIndex, 1)[0];
                const bigHits = getCurrentBigHitList();
                const medHits = getCurrentMediumHitList();
                if (bigHits.includes(discarded.name)) {
                    gameState.playerHP = Math.min(100, gameState.playerHP + 10);
                    addLogEntry(`Discarded ${discarded.name} (high-tier). Healed 10 HP!`, 'win');
                    showEffectPopup('+10', 'heal', 'player');
                } else if (medHits.includes(discarded.name)) {
                    gameState.playerHP = Math.min(100, gameState.playerHP + 5);
                    addLogEntry(`Discarded ${discarded.name} (medium-tier). Healed 5 HP!`, 'win');
                    showEffectPopup('+5', 'heal', 'player');
                } else {
                    gameState.playerHP = Math.max(0, gameState.playerHP - 10);
                    addLogEntry(`Discarded ${discarded.name} (low-tier). Took 10 damage!`, 'lose');
                    showEffectPopup('-10', 'damage', 'player');
                }
                gameState.playerDesireDiscard = false;
                updateUI();
                checkGameOver();
            }

            // Note: blinded and blocked states persist until they're applied/checked this turn
            // They should be cleared at the END of the turn, not the start

            // Update the Inner God summon area UI (in case any are available)
            if (gameType === 'inner_vs_outer') {
                updateInnerGodSummonArea();
            }

            checkAchievementsOnDraw(gameState.playerHand);

            // Reset ability state for the new turn
            gameState.abilityUsedThisTurn = false;
            gameState.selectedAbility = null;
            hideAbilityUsedIndicator();
        }

        // ============================================
        // ABILITY PHASE FUNCTIONS
        // ============================================

        // Game ability definitions - ONE ability per category
        const GAME_ABILITIES = {
            'fool': {
                name: 'Paper Figurine',
                desc: 'Set a decoy card. Opponent guesses real/fake. Wrong guess = double damage reflected. Fool cannot be played this turn.'
            },
            'door': {
                name: 'Dimensional Gate',
                desc: 'Discard a card now to draw an extra card next turn (guaranteed medium hit or higher).'
            },
            'error': {
                name: 'Corruption',
                desc: 'Cancel ALL ability effects this turn and reshuffle both hands.'
            },
            'visionary': {
                name: 'Mind Control',
                desc: 'Force opponent to play their worst card (by tier ranking).'
            },
            'darkness': {
                name: 'Shroud of Night',
                desc: 'Opponent cannot see their cards next round and cannot use abilities.'
            },
            'justiciar': {
                name: 'Absolute Order',
                desc: 'Force opponent to play a random card (you pick blindly). They cannot use abilities next turn.'
            },
            'fate': {
                name: 'Twist of Fate',
                desc: 'Guarantee a specific pathway card appears in your next hand.'
            },
            'knowledge': {
                name: 'Perfect Recall',
                desc: 'Recall one card from your previous hand into your next hand.'
            },
            'stealth': {
                name: 'Foresight',
                desc: 'Peek at your next 2 cards, but you must discard one of them.'
            },
            'death': {
                name: 'Decay',
                desc: 'Force both players to discard a random card from their hand.'
            },
            'destruction': {
                name: 'Devastation',
                desc: 'Deal 10 or 15 damage to opponent (your choice).'
            },
            'creation': {
                name: 'Vitality',
                desc: 'Heal 20% of your maximum HP.'
            },
            'purification': {
                name: 'Cleansing Light',
                desc: 'Clear 10% Madness (free to use), but you must play a random card from your hand this turn.'
            },
            'binding': {
                name: 'Chains of Restraint',
                desc: 'Force opponent to play a random card of your choosing (you pick blindly from their hand).'
            },
            // Outer Deity abilities
            'outer_inevitability': {
                name: 'Forced Play',
                desc: 'Force opponent to play a card from YOUR hand at random. If they refuse, they discard 2 cards and you see their hand.'
            },
            'outer_supernova': {
                name: 'Celestial Collapse',
                desc: 'All combat damage is DOUBLED this turn. All cards in both hands are revealed.'
            },
            'outer_overseer': {
                name: 'Forced Fate',
                desc: 'Force opponent to play random cards for the next 2 turns. Refusal = discard 1 card + 5 damage + 5 madness per turn.'
            },
            'outer_fate': {
                name: 'Threads of Destiny',
                desc: 'Swap two cards between hands. Any damage from swapped cards this turn is multiplied by 1.5x.'
            },
            'outer_depravity': {
                name: 'Corrupting Influence',
                desc: 'Corrupt one of opponent\'s next hand cards (hidden). Its effect is reversed. Madness from that card affects both players.'
            },
            'outer_desire': {
                name: 'Unpredictable Growth',
                desc: 'Draw 2 extra cards next turn, then discard 1 random. High-hit=heal 10, Medium=heal 5, Low-tier=take 10 damage.'
            },
            'outer_chaos': {
                name: 'Chaos Swap',
                desc: 'Swap damage outcomes this turn (you take their damage, they take yours). Your damage taken is halved.'
            },
            'outer_hunger': {
                name: 'Primordial Maw',
                desc: 'Deal 10 damage and consume 1 random opponent card per turn for 2 turns. You share half their madness gain during this time.'
            },
            'outer_ravings': {
                name: 'Maddening Whispers',
                desc: 'Add 15% madness to opponent. If they\'re above 50% madness, add 25% instead.'
            },
            'outer_decay': {
                name: 'Entropic Touch',
                desc: 'Reduce opponent\'s max HP by 10 for the rest of the game. Deal 5 damage.'
            }
        };

        function getGameAbility(card) {
            const category = card.abilityCategory;
            return GAME_ABILITIES[category] || { name: 'Unknown', desc: 'No ability defined.' };
        }

        function showAbilityPhase() {
            if (gameState.gameOver) return;

            // Tutorial mode: Skip ability phase during chapter 1 (basic mechanics)
            if (tutorialMode && tutorialChapter === 1) {
                gameState.abilityPhaseActive = false;
                renderHand();
                return;
            }

            // AI uses ability first (in AI mode)
            if (gameMode === 'ai') {
                aiSelectAndUseAbility();
            }

            // Check if player abilities are blocked
            if (gameState.playerAbilityBlocked) {
                const logContent = document.getElementById('log-content');
                const entry = document.createElement('div');
                entry.className = 'log-entry info';
                entry.innerHTML = `<strong>Turn ${gameState.turn}:</strong> <span style="color: #ff6b6b;">Your abilities are blocked this turn!</span>`;
                logContent.insertBefore(entry, logContent.firstChild);

                // In PvP mode, still need to send "blocked" signal so opponent isn't stuck waiting
                if (gameMode === 'pvp' && roomRef) {
                    myAbilitySelected = 'blocked';
                    const abilityPath = playerId === 'player1' ? 'player1Ability' : 'player2Ability';
                    roomRef.child(abilityPath).set('blocked').then(() => {
                        checkBothAbilitiesSelected();
                    });
                }

                // Skip ability phase
                gameState.playerAbilityBlocked = false; // Clear for next turn
                gameState.opponentAbilityBlocked = false; // Also clear opponent's block
                gameState.abilityPhaseActive = false;
                renderHand();
                return;
            }

            // Clear blocked state for opponent (their turn to be blocked is over)
            gameState.opponentAbilityBlocked = false;

            gameState.abilityPhaseActive = true;
            const container = DOM.get('ability-cards-container');
            container.innerHTML = '';

            // Create ability selection UI for each card in hand - ONE ability per card
            gameState.playerHand.forEach((card, cardIndex) => {
                const columnEl = document.createElement('div');
                columnEl.className = 'ability-card-column';

                // Check if this card is blinded
                const isBlinded = gameState.playerBlinded;

                // Get the single game ability for this card's category
                const gameAbility = getGameAbility(card);

                // Card header
                const headerEl = document.createElement('div');
                headerEl.className = 'ability-card-header';
                if (isBlinded) {
                    headerEl.innerHTML = `
                        <div style="width: 40px; height: 40px; background: #333; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 20px;">?</div>
                        <span class="card-name" style="color: #666;">???</span>
                    `;
                } else {
                    headerEl.innerHTML = `
                        <img src="${card.icon}" alt="${card.name}">
                        <span class="card-name">${card.name}</span>
                    `;
                }
                columnEl.appendChild(headerEl);

                // Single ability button per card
                const listEl = document.createElement('div');
                listEl.className = 'ability-list-container';

                const abilityBtn = document.createElement('button');
                abilityBtn.className = 'ability-btn';
                if (isBlinded) {
                    abilityBtn.classList.add('blinded');
                }
                abilityBtn.setAttribute('data-card-index', cardIndex);

                if (isBlinded) {
                    abilityBtn.innerHTML = `
                        <span class="ability-name" style="color: #666;">???</span>
                        <span class="ability-desc" style="color: #444;">Hidden by darkness</span>
                    `;
                } else {
                    abilityBtn.innerHTML = `
                        <span class="ability-name">${gameAbility.name}</span>
                        <span class="ability-desc">${gameAbility.desc}</span>
                    `;
                }
                abilityBtn.onclick = () => selectAbility(cardIndex, 0);
                listEl.appendChild(abilityBtn);

                columnEl.appendChild(listEl);
                container.appendChild(columnEl);
            });

            DOM.get('ability-phase-section').classList.add('active');
            DOM.get('btn-use-ability').disabled = true;
        }

        function selectAbility(cardIndex, abilityIndex) {
            // Clear previous selection - cache the container and query within it
            const abilityContainer = DOM.get('ability-cards-container');
            abilityContainer.querySelectorAll('.ability-btn').forEach(btn => {
                btn.classList.remove('selected');
            });

            // Select new ability - use GAME_ABILITIES based on card category
            const card = gameState.playerHand[cardIndex];
            const gameAbility = getGameAbility(card);

            gameState.selectedAbility = {
                cardIndex: cardIndex,
                abilityIndex: 0, // Always 0 since there's only one ability per card
                cardName: card.name,
                abilityName: gameAbility.name,
                abilityDesc: gameAbility.desc
            };

            // Highlight selected button - query within cached container
            const selectedBtn = abilityContainer.querySelector(
                `.ability-btn[data-card-index="${cardIndex}"]`
            );
            if (selectedBtn) {
                selectedBtn.classList.add('selected');
            }

            // Enable the "Use Ability" button
            DOM.get('btn-use-ability').disabled = false;
        }

        function confirmAbility() {
            if (!gameState.selectedAbility) return;

            const abilitySection = DOM.get('ability-phase-section');

            if (gameMode === 'pvp') {
                // PvP mode: Send ability to Firebase and wait for opponent
                myAbilitySelected = {
                    cardName: gameState.selectedAbility.cardName,
                    abilityName: gameState.selectedAbility.abilityName,
                    abilityDesc: gameState.selectedAbility.abilityDesc,
                    cardIndex: gameState.selectedAbility.cardIndex
                };
                waitingForOpponentAbility = true;

                // Send to Firebase
                if (roomRef) {
                    const abilityPath = playerId === 'player1' ? 'player1Ability' : 'player2Ability';
                    roomRef.child(abilityPath).set(myAbilitySelected).catch((error) => {
                        console.error('Error sending ability to Firebase:', error);
                    });
                }

                // Hide ability phase UI and show waiting message
                abilitySection.classList.remove('active');
                addLogEntry('Ability selected! Waiting for opponent...', 'info');

                // Check if opponent already selected
                checkBothAbilitiesSelected();
            } else {
                // AI mode: Store ability for execution during battle phase
                gameState.abilityUsedThisTurn = true;
                gameState.abilityPhaseActive = false;

                // Store player's ability for later (don't execute yet)
                gameState.playerPendingAbility = gameState.selectedAbility;

                // Hide ability phase and show the indicator
                abilitySection.classList.remove('active');
                showAbilityUsedIndicator(gameState.selectedAbility);

                // Re-render hand to enable card selection
                renderHand();

                // Trigger tutorial event for ability usage
                handleTutorialEvent('abilityUsed');
            }
        }

        function skipAbility() {
            const abilitySection = DOM.get('ability-phase-section');

            if (gameMode === 'pvp') {
                // PvP mode: Send skip to Firebase and wait for opponent
                myAbilitySelected = 'skipped';
                waitingForOpponentAbility = true;

                // Send to Firebase
                if (roomRef) {
                    const abilityPath = playerId === 'player1' ? 'player1Ability' : 'player2Ability';
                    roomRef.child(abilityPath).set('skipped').catch((error) => {
                        console.error('Error sending skip to Firebase:', error);
                    });
                }

                // Hide ability phase UI
                abilitySection.classList.remove('active');
                addLogEntry('Ability skipped! Waiting for opponent...', 'info');

                // Check if opponent already selected
                checkBothAbilitiesSelected();
            } else {
                // AI mode: Player skipped - abilities will execute during battle phase
                gameState.abilityPhaseActive = false;
                gameState.selectedAbility = null;
                gameState.playerPendingAbility = null; // Player skipped

                abilitySection.classList.remove('active');

                // Re-render hand to enable card selection
                renderHand();
            }
        }

        function checkBothAbilitiesSelected() {
            if (!myAbilitySelected || !opponentAbilitySelected) return;

            // Both players have selected - execute both abilities
            gameState.abilityPhaseActive = false;
            waitingForOpponentAbility = false;

            // Execute player's ability (if not skipped or blocked)
            if (myAbilitySelected !== 'skipped' && myAbilitySelected !== 'blocked' && typeof myAbilitySelected === 'object') {
                gameState.selectedAbility = myAbilitySelected;
                gameState.abilityUsedThisTurn = true;
                executeAbility(myAbilitySelected);
                showAbilityUsedIndicator(myAbilitySelected);
            }

            // Execute opponent's ability (if not skipped or blocked)
            if (opponentAbilitySelected !== 'skipped' && opponentAbilitySelected !== 'blocked' && typeof opponentAbilitySelected === 'object') {
                // Create opponent ability object and execute as AI
                const opponentAbility = {
                    cardName: opponentAbilitySelected.cardName,
                    abilityName: opponentAbilitySelected.abilityName,
                    abilityDesc: opponentAbilitySelected.abilityDesc
                };
                executeAbility(opponentAbility, true);
                addLogEntry(`Opponent used ${opponentAbility.abilityName} (${opponentAbility.cardName})`, 'info');
            } else if (opponentAbilitySelected === 'blocked') {
                addLogEntry('Opponent\'s abilities were blocked', 'info');
            } else {
                addLogEntry('Opponent skipped their ability', 'info');
            }

            // Clear ability selections for next turn
            myAbilitySelected = null;
            opponentAbilitySelected = null;

            // Clear abilities in Firebase
            if (roomRef) {
                roomRef.update({
                    player1Ability: null,
                    player2Ability: null
                });
            }

            // Sync game state after abilities (HP changes, etc.)
            syncGameStateToFirebase();

            // Re-render hand to enable card selection
            renderHand();
        }

        function executeAbility(ability, isAI = false) {
            // Check if abilities are cancelled by Error
            if (gameState.abilitiesCancelled) {
                addAbilityLog(ability, 'Ability was cancelled by Error!', isAI);
                return;
            }

            // Check if ability is blocked
            if ((!isAI && gameState.playerAbilityBlocked) || (isAI && gameState.opponentAbilityBlocked)) {
                addAbilityLog(ability, 'Ability was blocked!', isAI);
                return;
            }

            // Find the pathway for this card - use opponent's pool if isAI
            const pathwayPool = isAI ? getOpponentPathways() : getCurrentPathways();
            const pathway = pathwayPool.find(p => p.name === ability.cardName);
            if (!pathway) {
                addAbilityLog(ability, 'Unknown pathway!', isAI);
                return;
            }

            // Route to appropriate handler based on category
            const category = pathway.abilityCategory;

            switch (category) {
                case 'creation':
                    executeCreationAbility(ability, isAI);
                    break;
                case 'purification':
                    executePurificationAbility(ability, isAI);
                    break;
                case 'destruction':
                    executeDestructionAbility(ability, isAI);
                    break;
                case 'death':
                    executeDeathAbility(ability, isAI);
                    break;
                case 'knowledge':
                    executeKnowledgeAbility(ability, isAI);
                    break;
                case 'stealth':
                    executeStealthAbility(ability, isAI);
                    break;
                case 'fate':
                    executeFateAbility(ability, isAI);
                    break;
                case 'binding':
                    executeBindingAbility(ability, isAI);
                    break;
                case 'door':
                    executeDoorAbility(ability, isAI);
                    break;
                case 'darkness':
                    executeDarknessAbility(ability, isAI);
                    break;
                case 'visionary':
                    executeVisionaryAbility(ability, isAI);
                    break;
                case 'justiciar':
                    executeJusticiarAbility(ability, isAI);
                    break;
                case 'error':
                    executeErrorAbility(ability, isAI);
                    break;
                case 'fool':
                    executeFoolAbility(ability, isAI);
                    break;
                // Outer Deity abilities
                case 'outer_inevitability':
                    executeOuterInevitabilityAbility(ability, isAI);
                    break;
                case 'outer_supernova':
                    executeOuterSupernovaAbility(ability, isAI);
                    break;
                case 'outer_overseer':
                    executeOuterOverseerAbility(ability, isAI);
                    break;
                case 'outer_fate':
                    executeOuterFateAbility(ability, isAI);
                    break;
                case 'outer_depravity':
                    executeOuterDepravityAbility(ability, isAI);
                    break;
                case 'outer_desire':
                    executeOuterDesireAbility(ability, isAI);
                    break;
                case 'outer_chaos':
                    executeOuterChaosAbility(ability, isAI);
                    break;
                case 'outer_hunger':
                    executeOuterHungerAbility(ability, isAI);
                    break;
                case 'outer_ravings':
                    executeOuterRavingsAbility(ability, isAI);
                    break;
                case 'outer_decay':
                    executeOuterDecayAbility(ability, isAI);
                    break;
                default:
                    addAbilityLog(ability, 'Ability activated!', isAI);
            }

            // Track for achievements
            if (!isAI) {
                unlockAchievement('madness_begins');
            }
        }

        // ============================================
        // ABILITY HELPER FUNCTIONS
        // ============================================

        function addAbilityLog(ability, effectText, isAI = false) {
            const logContent = document.getElementById('log-content');
            const entry = document.createElement('div');
            entry.className = 'log-entry info';
            const actor = isAI ? 'Opponent' : 'You';
            entry.innerHTML = `<strong>Turn ${gameState.turn}:</strong> ${actor} used <span style="color: var(--color-gold);">${ability.cardName}</span> - <span style="color: #8aba8a;">${ability.abilityName}</span>`;
            entry.innerHTML += `<div class="log-flavor">${effectText}</div>`;
            logContent.insertBefore(entry, logContent.firstChild);
        }

        function showEffectPopup(text, type, targetHP = 'player') {
            const popup = document.createElement('div');
            popup.className = `effect-popup ${type}`;
            popup.textContent = text;

            // Position near the relevant HP bar
            const hpBar = document.getElementById(targetHP === 'player' ? 'player-hp' : 'opponent-hp');
            if (hpBar) {
                const rect = hpBar.getBoundingClientRect();
                popup.style.left = `${rect.left + rect.width / 2}px`;
                popup.style.top = `${rect.top}px`;
            } else {
                popup.style.left = '50%';
                popup.style.top = '50%';
            }

            document.body.appendChild(popup);
            setTimeout(() => popup.remove(), 1500);
        }

        function showAbilityModal(title, subtitle, bodyContent, buttons) {
            const modal = document.getElementById('ability-modal');
            document.getElementById('ability-modal-title').textContent = title;
            document.getElementById('ability-modal-subtitle').textContent = subtitle || '';
            document.getElementById('ability-modal-body').innerHTML = bodyContent;

            const buttonsContainer = document.getElementById('ability-modal-buttons');
            buttonsContainer.innerHTML = '';

            buttons.forEach(btn => {
                const button = document.createElement('button');
                button.className = `ability-modal-btn ${btn.class || 'primary'}`;
                button.textContent = btn.text;
                button.disabled = btn.disabled || false;
                button.onclick = () => {
                    btn.callback();
                    if (!btn.keepOpen) {
                        closeAbilityModal();
                    }
                };
                buttonsContainer.appendChild(button);
            });

            modal.classList.add('active');
        }

        function closeAbilityModal() {
            document.getElementById('ability-modal').classList.remove('active');
        }

        function discardRandomCard(hand) {
            if (hand.length === 0) return null;
            const index = Math.floor(Math.random() * hand.length);
            return hand.splice(index, 1)[0];
        }

        function getRandomPathway() {
            const currentPathways = getCurrentPathways();
            return currentPathways[Math.floor(Math.random() * currentPathways.length)];
        }

        // ============================================
        // SIMPLE ABILITY IMPLEMENTATIONS
        // ============================================

        // Creation (Mother, Paragon): Heal 20% HP - costs 15% madness
        function executeCreationAbility(ability, isAI) {
            // Add madness cost first
            if (addMadness(MADNESS_COSTS.creation, isAI)) return; // Check for madness loss

            const healAmount = 20;
            // God Mode AI has 200 max HP
            const opponentMaxHP = (gameMode === 'ai' && aiDifficulty === 'god') ? 200 : 100;
            if (isAI) {
                gameState.opponentHP = Math.min(opponentMaxHP, gameState.opponentHP + healAmount);
                showEffectPopup(`+${healAmount}`, 'heal', 'opponent');
            } else {
                gameState.playerHP = Math.min(100, gameState.playerHP + healAmount);
                showEffectPopup(`+${healAmount}`, 'heal', 'player');
            }
            addAbilityLog(ability, `Healed ${healAmount} HP! (+${MADNESS_COSTS.creation}% Madness)`, isAI);
            updateUI();
            syncGameStateToFirebase();
        }

        // Purification (Sun): Clears 10% madness (costs 0), must pick random card from hand
        function executePurificationAbility(ability, isAI) {
            // Purification clears madness (cleansing effect) - no cost to use
            addMadness(MADNESS_COSTS.purification, isAI); // -10% (reduces madness)

            if (isAI) {
                showEffectPopup(`-10% Madness`, 'heal', 'opponent');
                // AI must play a random card from remaining hand
                if (gameState.opponentHand.length > 1) {
                    gameState.forcedOpponentCard = gameState.opponentHand[Math.floor(Math.random() * gameState.opponentHand.length)].name;
                }
                addAbilityLog(ability, `Purified 10% Madness! (Must play random card)`, isAI);
                syncGameStateToFirebase();
            } else {
                showEffectPopup(`-10% Madness`, 'heal', 'player');
                syncGameStateToFirebase();

                // Force player to play a random card (select it automatically)
                if (gameState.playerHand.length > 0) {
                    const randomIndex = Math.floor(Math.random() * gameState.playerHand.length);
                    gameState.forcedPlayerCard = gameState.playerHand[randomIndex].name;
                    // Also force-select this card immediately (override any previous selection)
                    gameState.selectedCard = randomIndex;
                    addAbilityLog(ability, `Purified 10% Madness! You must play ${gameState.forcedPlayerCard}!`, isAI);
                } else {
                    addAbilityLog(ability, `Purified 10% Madness!`, isAI);
                }
            }
            updateUI();
        }

        // Destruction (Twilight Giant, Tyrant, Red Priest): Deal 10 OR 15 damage - costs 10% or 15% madness
        function executeDestructionAbility(ability, isAI) {
            if (isAI) {
                // AI always chooses 15 damage (aggressive) - costs 15% madness
                if (addMadness(MADNESS_COSTS.destruction_15, isAI)) return;
                const damage = 15;
                gameState.playerHP = Math.max(0, gameState.playerHP - damage);
                showEffectPopup(`-${damage}`, 'damage', 'player');
                addAbilityLog(ability, `Dealt ${damage} damage! (+${MADNESS_COSTS.destruction_15}% Madness)`, isAI);
                updateUI();
                syncGameStateToFirebase();
                checkGameOver();
            } else {
                // Show choice modal for player
                showAbilityModal(
                    'Destruction',
                    'Choose your damage output (Madness cost scales with damage)',
                    `<div class="ability-modal-options">
                        <div class="ability-modal-option" data-damage="10" onclick="selectDestructionDamage(10)">
                            <div class="ability-option-title">10 Damage</div>
                            <div class="ability-option-desc">A measured strike (+10% Madness)</div>
                        </div>
                        <div class="ability-modal-option" data-damage="15" onclick="selectDestructionDamage(15)">
                            <div class="ability-option-title">15 Damage</div>
                            <div class="ability-option-desc">Full force devastation (+15% Madness)</div>
                        </div>
                    </div>`,
                    [
                        { text: 'Confirm', class: 'primary', disabled: true, callback: () => confirmDestructionDamage(ability) }
                    ]
                );
            }
        }

        let selectedDestructionDamage = null;

        function selectDestructionDamage(damage) {
            selectedDestructionDamage = damage;
            document.querySelectorAll('.ability-modal-option').forEach(opt => {
                opt.classList.remove('selected');
                if (parseInt(opt.dataset.damage) === damage) {
                    opt.classList.add('selected');
                }
            });
            document.querySelector('.ability-modal-btn.primary').disabled = false;
        }

        function confirmDestructionDamage(ability) {
            if (selectedDestructionDamage) {
                // Madness cost depends on damage chosen
                const madnessCost = selectedDestructionDamage === 15 ? MADNESS_COSTS.destruction_15 : MADNESS_COSTS.destruction_10;
                if (addMadness(madnessCost, false)) {
                    selectedDestructionDamage = null;
                    return;
                }

                // In PvP, send damage to opponent via Firebase so they apply it themselves
                if (gameMode === 'pvp') {
                    sendDamageToOpponent(selectedDestructionDamage);
                    showEffectPopup(`-${selectedDestructionDamage}`, 'damage', 'opponent');
                    addAbilityLog(ability, `Dealt ${selectedDestructionDamage} damage! (+${madnessCost}% Madness)`, false);
                } else {
                    // Single player - apply damage directly
                    gameState.opponentHP = Math.max(0, gameState.opponentHP - selectedDestructionDamage);
                    showEffectPopup(`-${selectedDestructionDamage}`, 'damage', 'opponent');
                    addAbilityLog(ability, `Dealt ${selectedDestructionDamage} damage! (+${madnessCost}% Madness)`, false);
                    checkGameOver();
                }

                selectedDestructionDamage = null;
                updateUI();
                syncGameStateToFirebase();
            }
        }

        // Death/Corruption (Death, Hanged Man, Abyss): Both players discard a random card - costs 15% madness
        function executeDeathAbility(ability, isAI) {
            // Add madness cost
            if (addMadness(MADNESS_COSTS.death, isAI)) return;

            const playerDiscarded = discardRandomCard(gameState.playerHand);
            const opponentDiscarded = discardRandomCard(gameState.opponentHand);

            let effectText = 'Corruption spreads... ';
            if (playerDiscarded) effectText += `You lost ${playerDiscarded.name}. `;
            if (opponentDiscarded) effectText += `Opponent lost a card.`;
            effectText += ` (+${MADNESS_COSTS.death}% Madness)`;

            addAbilityLog(ability, effectText, isAI);
            renderHand();
            syncGameStateToFirebase();
        }

        // ============================================
        // MEDIUM ABILITY IMPLEMENTATIONS
        // ============================================

        // Knowledge (White Tower, Hermit): Recall card from prior hand - costs 15% madness
        function executeKnowledgeAbility(ability, isAI) {
            if (isAI) {
                // AI recalls a random card from prior hand
                if (gameState.priorOpponentHand.length > 0) {
                    if (addMadness(MADNESS_COSTS.knowledge, isAI)) return;
                    const recallCard = gameState.priorOpponentHand[Math.floor(Math.random() * gameState.priorOpponentHand.length)];
                    gameState.nextTurnEffects.push({
                        type: 'recallCard',
                        target: 'opponent',
                        card: recallCard
                    });
                    addAbilityLog(ability, `Will recall a card from memory next turn! (+${MADNESS_COSTS.knowledge}% Madness)`, isAI);
                } else {
                    addAbilityLog(ability, 'No prior knowledge to recall!', isAI);
                }
            } else {
                // Show player's prior hand to choose from
                if (gameState.priorPlayerHand.length === 0) {
                    addAbilityLog(ability, 'No prior knowledge to recall!', isAI);
                    return;
                }

                let cardsHtml = '<div class="ability-modal-cards">';
                gameState.priorPlayerHand.forEach((card, index) => {
                    cardsHtml += `
                        <div class="ability-modal-card" data-index="${index}" onclick="selectKnowledgeCard(${index})">
                            <img src="${card.icon}" alt="${card.name}">
                            <div class="card-name">${card.name}</div>
                        </div>
                    `;
                });
                cardsHtml += '</div>';

                showAbilityModal(
                    'Knowledge Recall',
                    `Select a card from your previous hand (+${MADNESS_COSTS.knowledge}% Madness)`,
                    cardsHtml,
                    [
                        { text: 'Recall Card', class: 'primary', disabled: true, callback: () => confirmKnowledgeRecall(ability) }
                    ]
                );
            }
        }

        let selectedKnowledgeCardIndex = null;

        function selectKnowledgeCard(index) {
            selectedKnowledgeCardIndex = index;
            document.querySelectorAll('.ability-modal-card').forEach((card, i) => {
                card.classList.toggle('selected', i === index);
            });
            document.querySelector('.ability-modal-btn.primary').disabled = false;
        }

        function confirmKnowledgeRecall(ability) {
            if (selectedKnowledgeCardIndex !== null) {
                if (addMadness(MADNESS_COSTS.knowledge, false)) {
                    selectedKnowledgeCardIndex = null;
                    return;
                }
                const recallCard = gameState.priorPlayerHand[selectedKnowledgeCardIndex];
                gameState.nextTurnEffects.push({
                    type: 'recallCard',
                    target: 'player',
                    card: recallCard
                });
                addAbilityLog(ability, `Will recall ${recallCard.name} next turn! (+${MADNESS_COSTS.knowledge}% Madness)`, false);
                selectedKnowledgeCardIndex = null;
            }
        }

        // Stealth (Demoness, Moon): Peek at next 2 cards, must discard one - costs 10% madness
        function executeStealthAbility(ability, isAI) {
            // Get next 2 potential cards for the deck
            const peekCards = [getRandomPathway(), getRandomPathway()];

            if (isAI) {
                // AI just discards one randomly (we don't reveal this to player)
                if (addMadness(MADNESS_COSTS.stealth, isAI)) return;
                addAbilityLog(ability, `Glimpsed the future and altered fate! (+${MADNESS_COSTS.stealth}% Madness)`, isAI);
            } else {
                let cardsHtml = '<div class="ability-modal-cards">';
                peekCards.forEach((card, index) => {
                    cardsHtml += `
                        <div class="ability-modal-card" data-index="${index}" onclick="selectStealthDiscard(${index})">
                            <img src="${card.icon}" alt="${card.name}">
                            <div class="card-name">${card.name}</div>
                        </div>
                    `;
                });
                cardsHtml += '</div>';

                // Store for later use
                gameState.stealthPeekCards = peekCards;

                showAbilityModal(
                    'Foresight',
                    `Choose one to discard from the future (+${MADNESS_COSTS.stealth}% Madness)`,
                    cardsHtml,
                    [
                        { text: 'Discard Selected', class: 'danger', disabled: true, callback: () => confirmStealthDiscard(ability) }
                    ]
                );
            }
        }

        let selectedStealthIndex = null;

        function selectStealthDiscard(index) {
            selectedStealthIndex = index;
            document.querySelectorAll('.ability-modal-card').forEach((card, i) => {
                card.classList.toggle('selected', i === index);
            });
            document.querySelector('.ability-modal-btn.danger').disabled = false;
        }

        function confirmStealthDiscard(ability) {
            if (selectedStealthIndex !== null && gameState.stealthPeekCards) {
                if (addMadness(MADNESS_COSTS.stealth, false)) {
                    selectedStealthIndex = null;
                    gameState.stealthPeekCards = null;
                    return;
                }
                const discarded = gameState.stealthPeekCards[selectedStealthIndex];
                const kept = gameState.stealthPeekCards[1 - selectedStealthIndex];

                // Add the kept card to next turn effects
                gameState.nextTurnEffects.push({
                    type: 'guaranteeCard',
                    target: 'player',
                    card: kept
                });

                addAbilityLog(ability, `Discarded ${discarded.name}. ${kept.name} guaranteed! (+${MADNESS_COSTS.stealth}% Madness)`, false);
                selectedStealthIndex = null;
                gameState.stealthPeekCards = null;
            }
        }

        // Fate/Authority (Black Emperor, Wheel of Fortune): Guarantee specific pathway in next hand - SPECIAL 25% madness
        function executeFateAbility(ability, isAI) {
            if (isAI) {
                // AI picks a random pathway to guarantee
                if (addMadness(MADNESS_COSTS.fate, isAI)) return;
                const randomPathway = getRandomPathway();
                gameState.guaranteedOpponentPathway = randomPathway.name;
                addAbilityLog(ability, `Fate has been woven for next turn! (+${MADNESS_COSTS.fate}% Madness)`, isAI);
            } else {
                // Show pathway selector
                const currentPathways = getCurrentPathways();
                let cardsHtml = '<div class="ability-modal-cards" style="max-height: 400px; overflow-y: auto;">';
                currentPathways.forEach((pathway, index) => {
                    cardsHtml += `
                        <div class="ability-modal-card" data-pathway="${pathway.name}" onclick="selectFatePathway('${pathway.name}')">
                            <img src="${pathway.icon}" alt="${pathway.name}">
                            <div class="card-name">${pathway.name}</div>
                        </div>
                    `;
                });
                cardsHtml += '</div>';

                showAbilityModal(
                    'Manipulate Fate',
                    `Select a pathway to guarantee (+${MADNESS_COSTS.fate}% Madness)`,
                    cardsHtml,
                    [
                        { text: 'Set Fate', class: 'primary', disabled: true, callback: () => confirmFateSelection(ability) }
                    ]
                );
            }
        }

        let selectedFatePathway = null;

        function selectFatePathway(pathwayName) {
            selectedFatePathway = pathwayName;
            document.querySelectorAll('.ability-modal-card').forEach(card => {
                card.classList.toggle('selected', card.dataset.pathway === pathwayName);
            });
            document.querySelector('.ability-modal-btn.primary').disabled = false;
        }

        function confirmFateSelection(ability) {
            if (selectedFatePathway) {
                if (addMadness(MADNESS_COSTS.fate, false)) {
                    selectedFatePathway = null;
                    return;
                }
                gameState.guaranteedPlayerPathway = selectedFatePathway;
                addAbilityLog(ability, `${selectedFatePathway} is guaranteed in your next hand! (+${MADNESS_COSTS.fate}% Madness)`, false);
                selectedFatePathway = null;
            }
        }

        // Binding (Chained): Force opponent to play a random card of your choosing - costs 5% madness
        function executeBindingAbility(ability, isAI) {
            if (isAI) {
                // AI forces player to play a random card
                if (gameState.playerHand.length > 0) {
                    if (addMadness(MADNESS_COSTS.binding, isAI)) return;
                    const forcedIndex = Math.floor(Math.random() * gameState.playerHand.length);
                    gameState.forcedPlayerCard = gameState.playerHand[forcedIndex].name;
                    // Force-select this card immediately
                    gameState.selectedCard = forcedIndex;
                    addAbilityLog(ability, `You are bound! You must play ${gameState.forcedPlayerCard}! (+${MADNESS_COSTS.binding}% Madness)`, isAI);
                    syncGameStateToFirebase();
                } else {
                    addAbilityLog(ability, 'No cards to bind!', isAI);
                }
            } else {
                // Player picks which card opponent must play (shown as hidden options)
                let cardsHtml = `<p style="color: var(--color-text-muted); margin-bottom: 15px;">Choose a position in opponent's hand to force them to play.</p>`;
                cardsHtml += '<div class="ability-modal-cards">';
                for (let i = 0; i < gameState.opponentHand.length; i++) {
                    cardsHtml += `
                        <div class="ability-modal-card blinded" data-index="${i}" onclick="selectBindingCard(${i})">
                            <img src="images/fool.png" alt="Hidden">
                            <div class="card-name">Card ${i + 1}</div>
                        </div>
                    `;
                }
                cardsHtml += '</div>';

                showAbilityModal(
                    'Binding Chains',
                    `Force opponent to play a specific card (+${MADNESS_COSTS.binding}% Madness)`,
                    cardsHtml,
                    [
                        { text: 'Bind Card', class: 'primary', disabled: true, callback: () => confirmBinding(ability) }
                    ]
                );
            }
        }

        let selectedBindingIndex = null;

        function selectBindingCard(index) {
            selectedBindingIndex = index;
            document.querySelectorAll('.ability-modal-card').forEach((card, i) => {
                card.classList.toggle('selected', i === index);
            });
            document.querySelector('.ability-modal-btn.primary').disabled = false;
        }

        function confirmBinding(ability) {
            if (selectedBindingIndex !== null && gameState.opponentHand[selectedBindingIndex]) {
                if (addMadness(MADNESS_COSTS.binding, false)) {
                    selectedBindingIndex = null;
                    return;
                }
                gameState.forcedOpponentCard = gameState.opponentHand[selectedBindingIndex].name;
                addAbilityLog(ability, `Opponent is bound! They must play card #${selectedBindingIndex + 1}! (+${MADNESS_COSTS.binding}% Madness)`, false);
                selectedBindingIndex = null;
                syncGameStateToFirebase();
            }
        }

        // ============================================
        // COMPLEX ABILITY IMPLEMENTATIONS
        // ============================================

        // Door: Draw extra card next turn, must discard one now - SPECIAL 25% madness
        function executeDoorAbility(ability, isAI) {
            if (isAI) {
                // AI discards a random card and gets extra next turn
                if (addMadness(MADNESS_COSTS.door, isAI)) return;
                const discarded = discardRandomCard(gameState.opponentHand);
                gameState.opponentExtraCard = true;
                addAbilityLog(ability, `Opened a portal! Will draw extra card next turn. (+${MADNESS_COSTS.door}% Madness)`, isAI);
                syncGameStateToFirebase();
            } else {
                // Player must choose a card to discard
                let cardsHtml = '<div class="ability-modal-cards">';
                gameState.playerHand.forEach((card, index) => {
                    cardsHtml += `
                        <div class="ability-modal-card" data-index="${index}" onclick="selectDoorDiscard(${index})">
                            <img src="${card.icon}" alt="${card.name}">
                            <div class="card-name">${card.name}</div>
                        </div>
                    `;
                });
                cardsHtml += '</div>';

                showAbilityModal(
                    'Dimensional Door',
                    `Discard one card for extra draw next turn (+${MADNESS_COSTS.door}% Madness)`,
                    cardsHtml,
                    [
                        { text: 'Discard & Open Portal', class: 'danger', disabled: true, callback: () => confirmDoorDiscard(ability) }
                    ]
                );
            }
        }

        let selectedDoorIndex = null;

        function selectDoorDiscard(index) {
            selectedDoorIndex = index;
            document.querySelectorAll('.ability-modal-card').forEach((card, i) => {
                card.classList.toggle('selected', i === index);
            });
            document.querySelector('.ability-modal-btn.danger').disabled = false;
        }

        function confirmDoorDiscard(ability) {
            if (selectedDoorIndex !== null) {
                if (addMadness(MADNESS_COSTS.door, false)) {
                    selectedDoorIndex = null;
                    return;
                }
                const discarded = gameState.playerHand.splice(selectedDoorIndex, 1)[0];
                gameState.extraCardNextTurn = true;
                addAbilityLog(ability, `Discarded ${discarded.name}. Extra card next turn! (+${MADNESS_COSTS.door}% Madness)`, false);
                selectedDoorIndex = null;
                renderHand();
                syncGameStateToFirebase();
            }
        }

        // Darkness: Opponent can't see their cards next round, blocks their ability - SPECIAL 25% madness
        function executeDarknessAbility(ability, isAI) {
            // Add madness cost first
            if (addMadness(MADNESS_COSTS.darkness, isAI)) return;

            if (isAI) {
                gameState.playerBlinded = true;
                gameState.playerAbilityBlocked = true;
                addAbilityLog(ability, `Darkness descends! You cannot see cards or use abilities! (+${MADNESS_COSTS.darkness}% Madness)`, isAI);
            } else {
                gameState.opponentBlinded = true;
                gameState.opponentAbilityBlocked = true;
                addAbilityLog(ability, `Shrouded opponent in darkness! (+${MADNESS_COSTS.darkness}% Madness)`, isAI);
            }
            syncGameStateToFirebase();
        }

        // Visionary: Guarantee a pathway in your or opponent's next hand - SPECIAL 25% madness
        // Visionary: Force opponent to play their worst card (Mind Control)
        function getCardRankForVisionary(cardName, isForOpponent) {
            // Get tier lists based on whose card we're ranking
            let bigHits, mediumHits, lowTier;
            if (isForOpponent) {
                // Ranking opponent's cards (from player's perspective)
                bigHits = gameType === 'inner_vs_outer' ? getOpponentBigHitList() : getCurrentBigHitList();
                mediumHits = gameType === 'inner_vs_outer' ? getOpponentMediumHitList() : getCurrentMediumHitList();
                lowTier = gameType === 'inner_vs_outer' ? getOpponentLowTierList() : getCurrentLowTierList();
            } else {
                // Ranking player's cards (from AI's perspective)
                bigHits = getCurrentBigHitList();
                mediumHits = getCurrentMediumHitList();
                lowTier = getCurrentLowTierList();
            }

            if (lowTier.includes(cardName)) return 1;      // Worst
            if (mediumHits.includes(cardName)) return 2;   // Medium
            if (bigHits.includes(cardName)) return 3;      // Best
            return 2; // Default to medium
        }

        function getWorstCardInHand(hand, isForOpponent) {
            if (!hand || hand.length === 0) return null;
            let worstCard = hand[0];
            let worstRank = getCardRankForVisionary(hand[0].name, isForOpponent);

            for (let i = 1; i < hand.length; i++) {
                const rank = getCardRankForVisionary(hand[i].name, isForOpponent);
                if (rank < worstRank) {
                    worstRank = rank;
                    worstCard = hand[i];
                }
            }
            return worstCard;
        }

        function executeVisionaryAbility(ability, isAI) {
            if (isAI) {
                // AI forces player to play their worst card
                if (addMadness(MADNESS_COSTS.visionary, isAI)) return;
                const worstCard = getWorstCardInHand(gameState.playerHand, false);
                if (worstCard) {
                    gameState.forcedPlayerCard = worstCard.name;
                    // Force-select this card immediately
                    const forcedIndex = gameState.playerHand.findIndex(c => c.name === worstCard.name);
                    if (forcedIndex !== -1) gameState.selectedCard = forcedIndex;
                    addAbilityLog(ability, `Mind controlled! You must play ${worstCard.name}! (+${MADNESS_COSTS.visionary}% Madness)`, isAI);
                } else {
                    addAbilityLog(ability, `Mind control failed - no cards to target! (+${MADNESS_COSTS.visionary}% Madness)`, isAI);
                }
                syncGameStateToFirebase();
            } else {
                // Player forces opponent to play their worst card
                if (addMadness(MADNESS_COSTS.visionary, false)) return;
                const worstCard = getWorstCardInHand(gameState.opponentHand, true);
                if (worstCard) {
                    gameState.forcedOpponentCard = worstCard.name;
                    addAbilityLog(ability, `Mind controlled opponent! They must play ${worstCard.name}! (+${MADNESS_COSTS.visionary}% Madness)`, false);
                } else {
                    addAbilityLog(ability, `Mind control failed - no cards to target! (+${MADNESS_COSTS.visionary}% Madness)`, false);
                }
                syncGameStateToFirebase();
            }
        }

        // Justiciar: Block opponent's ability next turn - SPECIAL 25% madness
        function executeJusticiarAbility(ability, isAI) {
            if (isAI) {
                // AI blocks player's ability (no longer forces a card)
                if (addMadness(MADNESS_COSTS.justiciar, isAI)) return;
                gameState.playerAbilityBlocked = true;
                addAbilityLog(ability, `Judgment passed! Your ability is blocked! (+${MADNESS_COSTS.justiciar}% Madness)`, isAI);
                syncGameStateToFirebase();
            } else {
                // Player picks blindly from opponent's hand
                if (gameState.opponentHand.length === 0) {
                    addAbilityLog(ability, 'No cards to judge!', isAI);
                    return;
                }

                let cardsHtml = `<p style="color: var(--color-text-muted); margin-bottom: 15px;">Pass judgment! Pick a card position to force the opponent to play.</p>`;
                cardsHtml += '<div class="ability-modal-cards">';
                for (let i = 0; i < gameState.opponentHand.length; i++) {
                    cardsHtml += `
                        <div class="ability-modal-card blinded" data-index="${i}" onclick="selectJusticiarCard(${i})">
                            <img src="images/justiciar.png" alt="Hidden">
                            <div class="card-name">Card ${i + 1}</div>
                        </div>
                    `;
                }
                cardsHtml += '</div>';

                showAbilityModal(
                    'Absolute Order',
                    `Force card + block ability (+${MADNESS_COSTS.justiciar}% Madness)`,
                    cardsHtml,
                    [
                        { text: 'Pass Judgment', class: 'primary', disabled: true, callback: () => confirmJusticiarSelection(ability) }
                    ]
                );
            }
        }

        let selectedJusticiarIndex = null;

        function selectJusticiarCard(index) {
            selectedJusticiarIndex = index;
            document.querySelectorAll('.ability-modal-card').forEach((card, i) => {
                card.classList.toggle('selected', i === index);
            });
            document.querySelector('.ability-modal-btn.primary').disabled = false;
        }

        function confirmJusticiarSelection(ability) {
            if (selectedJusticiarIndex !== null && gameState.opponentHand[selectedJusticiarIndex]) {
                if (addMadness(MADNESS_COSTS.justiciar, false)) {
                    selectedJusticiarIndex = null;
                    return;
                }
                gameState.forcedOpponentCard = gameState.opponentHand[selectedJusticiarIndex].name;
                gameState.opponentAbilityBlocked = true;
                addAbilityLog(ability, `Judgment passed! Opponent plays card #${selectedJusticiarIndex + 1}, blocked! (+${MADNESS_COSTS.justiciar}% Madness)`, false);
                selectedJusticiarIndex = null;
                syncGameStateToFirebase();
            }
        }

        // Error: Cancel all abilities this turn, reshuffle all hands - SPECIAL 25% madness
        function executeErrorAbility(ability, isAI) {
            // Add madness cost first
            if (addMadness(MADNESS_COSTS.error, isAI)) return;

            // Cancel all pending abilities
            gameState.abilitiesCancelled = true;

            // Clear all next turn effects
            gameState.nextTurnEffects = [];

            // Clear all forced cards
            gameState.forcedPlayerCard = null;
            gameState.forcedOpponentCard = null;

            // Reshuffle both hands (use different pool for opponent in inner_vs_outer mode)
            gameState.playerHand = getWeightedRandomCards(3);
            if (gameType === 'inner_vs_outer') {
                gameState.opponentHand = getOpponentWeightedRandomCards(3);
            } else {
                gameState.opponentHand = getWeightedRandomCards(3);
            }

            addAbilityLog(ability, `ERROR! Reality corrupted! All cancelled, hands reshuffled! (+${MADNESS_COSTS.error}% Madness)`, isAI);
            renderHand();
            syncGameStateToFirebase();
        }

        // Fool: Decoy card mechanic - SPECIAL 25% madness
        let aiDecoyIsReal = null; // Store AI's decoy real/fake status

        function executeFoolAbility(ability, isAI) {
            if (isAI) {
                // AI sets a random card as decoy
                if (gameState.opponentHand.length > 0) {
                    if (addMadness(MADNESS_COSTS.fool, isAI)) return;
                    const decoyIndex = Math.floor(Math.random() * gameState.opponentHand.length);
                    // AI decides if the decoy is "real" or "fake" BEFORE player guesses
                    aiDecoyIsReal = Math.random() > 0.5;
                    addAbilityLog(ability, `Set a decoy! Is the card real or fake? (+${MADNESS_COSTS.fool}% Madness)`, isAI);

                    // Create a simple guess prompt for the player
                    setTimeout(() => {
                        showAbilityModal(
                            'Fool\'s Decoy',
                            'Opponent played a decoy! Guess if it\'s real or fake.',
                            `<div class="ability-modal-options">
                                <div class="ability-modal-option" data-guess="real" onclick="selectFoolGuess('real')">
                                    <div class="ability-option-title">REAL</div>
                                    <div class="ability-option-desc">The card will be played normally</div>
                                </div>
                                <div class="ability-modal-option" data-guess="fake" onclick="selectFoolGuess('fake')">
                                    <div class="ability-option-title">FAKE</div>
                                    <div class="ability-option-desc">The card is a decoy and will be discarded</div>
                                </div>
                            </div>`,
                            [
                                { text: 'Make Guess', class: 'primary', disabled: true, callback: () => resolveFoolGuess() }
                            ]
                        );
                    }, 500);
                }
            } else {
                // Player selects which card to use as decoy
                let cardsHtml = `<p style="color: var(--color-text-muted); margin-bottom: 15px;">Select a card to set as decoy. You cannot play this card as a battle card this turn.</p>`;
                cardsHtml += '<div class="ability-modal-cards">';
                gameState.playerHand.forEach((card, index) => {
                    cardsHtml += `
                        <div class="ability-modal-card" data-index="${index}" onclick="selectFoolDecoy(${index})">
                            <img src="${card.icon}" alt="${card.name}">
                            <div class="card-name">${card.name}</div>
                        </div>
                    `;
                });
                cardsHtml += '</div>';

                showAbilityModal(
                    'Paper Figurine Substitution',
                    `Select a card as your decoy (+${MADNESS_COSTS.fool}% Madness)`,
                    cardsHtml,
                    [
                        { text: 'Set Decoy', class: 'primary', disabled: true, callback: () => confirmFoolDecoy(ability) }
                    ]
                );
            }
        }

        let selectedFoolDecoyIndex = null;
        let selectedFoolGuess = null;

        function selectFoolDecoy(index) {
            selectedFoolDecoyIndex = index;
            document.querySelectorAll('.ability-modal-card').forEach((card, i) => {
                card.classList.toggle('selected', i === index);
            });
            document.querySelector('.ability-modal-btn.primary').disabled = false;
        }

        function confirmFoolDecoy(ability) {
            if (selectedFoolDecoyIndex !== null) {
                if (addMadness(MADNESS_COSTS.fool, false)) {
                    selectedFoolDecoyIndex = null;
                    return;
                }
                gameState.foolDecoyActive = true;
                gameState.foolDecoyCardIndex = selectedFoolDecoyIndex;
                const isReal = Math.random() > 0.5; // Determine if decoy is "real" or "fake"
                gameState.foolDecoyIsReal = isReal;
                addAbilityLog(ability, `Set ${gameState.playerHand[selectedFoolDecoyIndex].name} as decoy! (+${MADNESS_COSTS.fool}% Madness)`, false);
                selectedFoolDecoyIndex = null;
                renderHand();

                // AI makes a guess
                setTimeout(() => {
                    const aiGuess = Math.random() > 0.5 ? 'real' : 'fake';
                    resolveFoolDecoyResult(aiGuess, isReal, false);
                }, 1000);
            }
        }

        function resolveFoolDecoyResult(guess, isReal, isPlayerGuessing) {
            let resultText;
            const baseDamage = 20;

            if (isPlayerGuessing) {
                // Player is guessing opponent's decoy
                if (guess === 'real' && isReal) {
                    // Guessed real, was real - nothing happens
                    resultText = `You guessed REAL - Correct! The card was real. Normal interaction.`;
                } else if (guess === 'fake' && isReal) {
                    // Guessed fake, was real - player takes double damage
                    const damage = baseDamage * 2;
                    gameState.playerHP = Math.max(0, gameState.playerHP - damage);
                    showEffectPopup(`-${damage}`, 'damage', 'player');
                    resultText = `You guessed FAKE but it was REAL! You take ${damage} damage!`;
                } else if (guess === 'fake' && !isReal) {
                    // Guessed fake, was fake - damage reflected to opponent (fool user)
                    if (gameMode === 'pvp') {
                        sendDamageToOpponent(baseDamage);
                    } else {
                        gameState.opponentHP = Math.max(0, gameState.opponentHP - baseDamage);
                    }
                    showEffectPopup(`-${baseDamage}`, 'damage', 'opponent');
                    resultText = `You guessed FAKE - Correct! Damage reflected to opponent for ${baseDamage}!`;
                } else {
                    // Guessed real, was fake - nothing major
                    resultText = `You guessed REAL but it was FAKE. The decoy fades away.`;
                }
            } else {
                // AI/Opponent is guessing player's decoy
                if (guess === 'real' && isReal) {
                    resultText = `Opponent guessed REAL - Correct! The card was real. Normal interaction.`;
                } else if (guess === 'fake' && isReal) {
                    // Opponent guessed fake, was real - opponent takes double damage
                    const damage = baseDamage * 2;
                    if (gameMode === 'pvp') {
                        sendDamageToOpponent(damage);
                    } else {
                        gameState.opponentHP = Math.max(0, gameState.opponentHP - damage);
                    }
                    showEffectPopup(`-${damage}`, 'damage', 'opponent');
                    resultText = `Opponent guessed FAKE but it was REAL! Opponent takes ${damage} damage!`;
                } else if (guess === 'fake' && !isReal) {
                    // Opponent guessed fake, was fake - damage reflected to player (fool user)
                    gameState.playerHP = Math.max(0, gameState.playerHP - baseDamage);
                    showEffectPopup(`-${baseDamage}`, 'damage', 'player');
                    resultText = `Opponent guessed FAKE - Correct! Damage reflected to you for ${baseDamage}!`;
                } else {
                    resultText = `Opponent guessed REAL but it was FAKE. The decoy fades away.`;
                }
            }

            addAbilityLog({ cardName: 'Fool', abilityName: 'Decoy Resolution' }, resultText, false);
            gameState.foolDecoyActive = false;
            gameState.foolDecoyCardIndex = null;
            gameState.foolDecoyIsReal = null;
            updateUI();
            syncGameStateToFirebase();
            renderHand();
            checkGameOver();
        }

        function selectFoolGuess(guess) {
            selectedFoolGuess = guess;
            document.querySelectorAll('.ability-modal-option').forEach(opt => {
                opt.classList.toggle('selected', opt.dataset.guess === guess);
            });
            document.querySelector('.ability-modal-btn.primary').disabled = false;
        }

        function resolveFoolGuess() {
            if (selectedFoolGuess && aiDecoyIsReal !== null) {
                resolveFoolDecoyResult(selectedFoolGuess, aiDecoyIsReal, true);
                selectedFoolGuess = null;
                aiDecoyIsReal = null;
            }
        }

        // ============================================
        // OUTER DEITY ABILITY IMPLEMENTATIONS
        // ============================================

        // Circle of Inevitability: Force opponent to play card from YOUR hand
        function executeOuterInevitabilityAbility(ability, isAI) {
            if (addMadness(MADNESS_COSTS.outer_inevitability, isAI)) return;

            if (isAI) {
                // AI forces player to play from AI's hand
                if (gameState.opponentHand.length > 0) {
                    const randomIndex = Math.floor(Math.random() * gameState.opponentHand.length);
                    const forcedCard = gameState.opponentHand[randomIndex];
                    // Remove from AI hand
                    gameState.opponentHand.splice(randomIndex, 1);
                    // Force player to play this card
                    gameState.playerHand.push(forcedCard);
                    gameState.forcedPlayerCard = forcedCard.name;
                    // Force-select this card immediately (it's now the last card in hand)
                    gameState.selectedCard = gameState.playerHand.length - 1;
                    addAbilityLog(ability, `Fate compels you! You must play ${forcedCard.name} (from opponent's hand)! (+${MADNESS_COSTS.outer_inevitability}% Madness)`, isAI);
                    renderHand();
                }
            } else {
                // Player forces AI to play from player's hand
                if (gameState.playerHand.length > 0) {
                    const randomIndex = Math.floor(Math.random() * gameState.playerHand.length);
                    const forcedCard = gameState.playerHand[randomIndex];
                    // Remove from player hand
                    gameState.playerHand.splice(randomIndex, 1);
                    // Force AI to play this card
                    gameState.forcedOpponentCard = forcedCard.name;
                    gameState.opponentHand.push(forcedCard);
                    addAbilityLog(ability, `Fate is inescapable! Opponent must play ${forcedCard.name} (from your hand)! (+${MADNESS_COSTS.outer_inevitability}% Madness)`, isAI);
                    renderHand();
                }
            }
            syncGameStateToFirebase();
        }

        // Supernova Dominator: Double all damage, reveal all hands
        function executeOuterSupernovaAbility(ability, isAI) {
            if (addMadness(MADNESS_COSTS.outer_supernova, isAI)) return;

            // Set flag for doubled damage this turn
            gameState.supernovaDamageDouble = true;
            // Reveal both hands
            gameState.handsRevealed = true;

            addAbilityLog(ability, `CELESTIAL COLLAPSE! All damage is DOUBLED this turn. All cards revealed! (+${MADNESS_COSTS.outer_supernova}% Madness)`, isAI);
            renderHand();
            renderOpponentHand(); // Show revealed opponent cards
            syncGameStateToFirebase();
        }

        // High-Dimensional Overseer: Force random cards for 2 turns
        function executeOuterOverseerAbility(ability, isAI) {
            if (addMadness(MADNESS_COSTS.outer_overseer, isAI)) return;

            if (isAI) {
                // Force player to play random cards for 2 turns
                gameState.playerForcedRandomTurns = 2;
                addAbilityLog(ability, `FORCED FATE! You must play random cards for the next 2 turns! (+${MADNESS_COSTS.outer_overseer}% Madness)`, isAI);
            } else {
                // Force AI to play random cards for 2 turns
                gameState.opponentForcedRandomTurns = 2;
                addAbilityLog(ability, `FORCED FATE! Opponent must play random cards for the next 2 turns! (+${MADNESS_COSTS.outer_overseer}% Madness)`, isAI);
            }
            syncGameStateToFirebase();
        }

        // Goddess of Fate: Swap two cards between hands, swapped cards deal 1.5x damage
        function executeOuterFateAbility(ability, isAI) {
            if (addMadness(MADNESS_COSTS.outer_fate, isAI)) return;

            const playerHand = gameState.playerHand;
            const opponentHand = gameState.opponentHand;

            if (playerHand.length > 0 && opponentHand.length > 0) {
                // Swap one random card from each hand
                const playerSwapIndex = Math.floor(Math.random() * playerHand.length);
                const opponentSwapIndex = Math.floor(Math.random() * opponentHand.length);

                const playerCard = playerHand[playerSwapIndex];
                const opponentCard = opponentHand[opponentSwapIndex];

                // Perform swap
                playerHand[playerSwapIndex] = opponentCard;
                opponentHand[opponentSwapIndex] = playerCard;

                // Mark swapped cards for 1.5x damage bonus
                gameState.swappedCardNames = [playerCard.name, opponentCard.name];

                addAbilityLog(ability, `Threads of Destiny woven! Swapped ${playerCard.name}  ${opponentCard.name}. Swapped cards deal 1.5x damage! (+${MADNESS_COSTS.outer_fate}% Madness)`, isAI);
                renderHand();
            } else {
                addAbilityLog(ability, `Not enough cards to swap! (+${MADNESS_COSTS.outer_fate}% Madness)`, isAI);
            }
            syncGameStateToFirebase();
        }

        // Mother Goddess of Depravity: Corrupt opponent's next card (hidden)
        function executeOuterDepravityAbility(ability, isAI) {
            if (addMadness(MADNESS_COSTS.outer_depravity, isAI)) return;

            if (isAI) {
                // Corrupt a random card in player's next hand
                gameState.playerCorruptedCard = true;
                gameState.corruptedCardHidden = true;
                addAbilityLog(ability, `Corrupting Influence spreads... One of your next cards is tainted (hidden)! (+${MADNESS_COSTS.outer_depravity}% Madness)`, isAI);
            } else {
                // Corrupt a random card in AI's next hand
                gameState.opponentCorruptedCard = true;
                gameState.opponentCorruptedHidden = true;
                addAbilityLog(ability, `Corrupting Influence spreads... One of opponent's next cards is tainted (hidden)! (+${MADNESS_COSTS.outer_depravity}% Madness)`, isAI);
            }
            syncGameStateToFirebase();
        }

        // Mother Tree of Desire: Draw 2 extra next turn, discard 1 with risk/reward
        function executeOuterDesireAbility(ability, isAI) {
            if (addMadness(MADNESS_COSTS.outer_desire, isAI)) return;

            if (isAI) {
                gameState.opponentExtraDraws = 2;
                gameState.opponentDesireDiscard = true;
                addAbilityLog(ability, `Unpredictable Growth! Opponent draws 2 extra cards next turn, then discards 1 (with consequences)! (+${MADNESS_COSTS.outer_desire}% Madness)`, isAI);
            } else {
                gameState.playerExtraDraws = 2;
                gameState.playerDesireDiscard = true;
                addAbilityLog(ability, `Unpredictable Growth! You draw 2 extra cards next turn, then discard 1 (with consequences)! (+${MADNESS_COSTS.outer_desire}% Madness)`, isAI);
            }
            syncGameStateToFirebase();
        }

        // Son of Chaos: Swap damage outcomes, your damage taken is halved
        function executeOuterChaosAbility(ability, isAI) {
            if (addMadness(MADNESS_COSTS.outer_chaos, isAI)) return;

            gameState.chaosSwapActive = true;
            gameState.chaosSwapUser = isAI ? 'ai' : 'player';

            addAbilityLog(ability, `CHAOS REIGNS! Damage outcomes swapped this turn. ${isAI ? 'AI' : 'Your'} damage taken is halved! (+${MADNESS_COSTS.outer_chaos}% Madness)`, isAI);
            syncGameStateToFirebase();
        }

        // Primordial Hunger: 10 damage + consume cards for 2 turns
        function executeOuterHungerAbility(ability, isAI) {
            if (addMadness(MADNESS_COSTS.outer_hunger, isAI)) return;

            // Deal immediate damage
            const damage = 10;
            if (isAI) {
                gameState.playerHP = Math.max(0, gameState.playerHP - damage);
                showEffectPopup(`-${damage}`, 'damage', 'player');
                gameState.playerConsumedTurns = 2;
                gameState.hungerMadnessShare = 'player'; // Player shares madness with AI
                addAbilityLog(ability, `PRIMORDIAL MAW devours! ${damage} damage dealt. Your cards will be consumed for 2 turns. Madness shared! (+${MADNESS_COSTS.outer_hunger}% Madness)`, isAI);
            } else {
                gameState.opponentHP = Math.max(0, gameState.opponentHP - damage);
                showEffectPopup(`-${damage}`, 'damage', 'opponent');
                gameState.opponentConsumedTurns = 2;
                gameState.hungerMadnessShare = 'opponent'; // AI shares madness with player
                addAbilityLog(ability, `PRIMORDIAL MAW devours! ${damage} damage dealt. Opponent's cards will be consumed for 2 turns. Madness shared! (+${MADNESS_COSTS.outer_hunger}% Madness)`, isAI);
            }
            updateUI();
            syncGameStateToFirebase();
            checkGameOver();
        }

        // Inextinguishable Ravings: Add madness based on current level
        function executeOuterRavingsAbility(ability, isAI) {
            if (addMadness(MADNESS_COSTS.outer_ravings, isAI)) return;

            if (isAI) {
                const currentMadness = gameState.playerMadness || 0;
                const madnessToAdd = currentMadness >= 50 ? 25 : 15;
                addMadness(madnessToAdd, false);
                addAbilityLog(ability, `Maddening Whispers! You gain ${madnessToAdd}% madness! (+${MADNESS_COSTS.outer_ravings}% Madness)`, isAI);
            } else {
                const currentMadness = gameState.opponentMadness || 0;
                const madnessToAdd = currentMadness >= 50 ? 25 : 15;
                addMadness(madnessToAdd, true);
                addAbilityLog(ability, `Maddening Whispers! Opponent gains ${madnessToAdd}% madness! (+${MADNESS_COSTS.outer_ravings}% Madness)`, isAI);
            }
            updateUI();
            syncGameStateToFirebase();
        }

        // Monarch of Decay: Reduce opponent max HP permanently, deal 5 damage
        function executeOuterDecayAbility(ability, isAI) {
            if (addMadness(MADNESS_COSTS.outer_decay, isAI)) return;

            const damage = 5;
            const maxHPReduction = 10;

            if (isAI) {
                // Reduce player's effective max HP
                gameState.playerMaxHPReduction = (gameState.playerMaxHPReduction || 0) + maxHPReduction;
                // Cap current HP at new max
                const newMax = 100 - gameState.playerMaxHPReduction;
                gameState.playerHP = Math.min(gameState.playerHP, newMax);
                gameState.playerHP = Math.max(0, gameState.playerHP - damage);
                showEffectPopup(`-${damage}`, 'damage', 'player');
                addAbilityLog(ability, `Entropic Touch! Your max HP reduced by ${maxHPReduction} (now ${newMax}). Took ${damage} damage! (+${MADNESS_COSTS.outer_decay}% Madness)`, isAI);
            } else {
                // Reduce opponent's effective max HP
                gameState.opponentMaxHPReduction = (gameState.opponentMaxHPReduction || 0) + maxHPReduction;
                const opponentMax = (gameMode === 'ai' && aiDifficulty === 'god') ? 200 : 100;
                const newMax = opponentMax - gameState.opponentMaxHPReduction;
                gameState.opponentHP = Math.min(gameState.opponentHP, newMax);
                gameState.opponentHP = Math.max(0, gameState.opponentHP - damage);
                showEffectPopup(`-${damage}`, 'damage', 'opponent');
                addAbilityLog(ability, `Entropic Touch! Opponent's max HP reduced by ${maxHPReduction} (now ${newMax}). Dealt ${damage} damage! (+${MADNESS_COSTS.outer_decay}% Madness)`, isAI);
            }
            updateUI();
            syncGameStateToFirebase();
            checkGameOver();
        }

        function checkGameOver() {
            if (gameState.playerHP <= 0 || gameState.opponentHP <= 0) {
                gameState.gameOver = true;
                // Close any open ability modals
                closeAbilityModal();
                // End ability phase
                gameState.abilityPhaseActive = false;
                // Sync final state so both players see the same result
                syncGameStateToFirebase();
                showGameOver();
            }
        }

        // ============================================
        // AI ABILITY SYSTEM
        // ============================================

        function aiSelectAndUseAbility() {
            if (gameState.opponentAbilityBlocked || gameState.abilitiesCancelled) {
                gameState.opponentUsedAbility = false;
                gameState.aiPendingAbility = null;
                return;
            }

            if (gameState.opponentHand.length === 0) {
                gameState.opponentUsedAbility = false;
                gameState.aiPendingAbility = null;
                return;
            }

            // Ability use chance based on difficulty (God Mode = 100%)
            const useChances = { easy: 0.3, medium: 0.5, hard: 0.7, god: 1.0 };
            const useChance = useChances[aiDifficulty] || 0.5;

            if (Math.random() >= useChance) {
                gameState.opponentUsedAbility = false;
                gameState.aiPendingAbility = null;
                return;
            }

            // Get available abilities
            const availableAbilities = gameState.opponentHand
                .map((card, index) => ({ card, index, category: card.abilityCategory }))
                .filter(a => a.category && GAME_ABILITIES[a.category]);

            if (availableAbilities.length === 0) {
                gameState.opponentUsedAbility = false;
                gameState.aiPendingAbility = null;
                return;
            }

            let selectedAbility = null;

            if (aiDifficulty === 'easy') {
                // Easy: Random ability
                selectedAbility = availableAbilities[Math.floor(Math.random() * availableAbilities.length)];

            } else if (aiDifficulty === 'medium') {
                // Medium: Slightly prefer useful abilities
                const useful = availableAbilities.filter(a =>
                    ['creation', 'destruction', 'purification', 'death'].includes(a.category)
                );
                if (useful.length > 0 && Math.random() < 0.6) {
                    selectedAbility = useful[Math.floor(Math.random() * useful.length)];
                } else {
                    selectedAbility = availableAbilities[Math.floor(Math.random() * availableAbilities.length)];
                }

            } else if (aiDifficulty === 'hard' || aiDifficulty === 'god') {
                // Hard/God: Strategic ability selection with madness awareness
                const aiHP = gameState.opponentHP;
                const playerHP = gameState.playerHP;
                const aiMadness = gameState.opponentMadness || 0;

                // Priority-based selection
                const findAbility = (category) => availableAbilities.find(a => a.category === category);

                // Helper to check if using an ability would cause madness death
                const wouldCauseMadnessDeath = (category) => {
                    const costs = {
                        creation: 15, purification: -10, destruction: 15, death: 15,
                        knowledge: 15, stealth: 10, binding: 5, fool: 20, door: 20,
                        darkness: 20, visionary: 20, justiciar: 20, fate: 20, error: 20,
                        outer_depravity: 20, outer_desire: 15, outer_chaos: 20,
                        outer_inevitability: 20, outer_hunger: 25, outer_supernova: 25,
                        outer_ravings: 20, outer_decay: 20, outer_overseer: 30, outer_fate: 15
                    };
                    const cost = costs[category] || 15;
                    return (aiMadness + cost) >= 100;
                };

                // Helper to find safe ability (won't cause madness death)
                const findSafeAbility = (category) => {
                    const ability = findAbility(category);
                    if (ability && !wouldCauseMadnessDeath(category)) {
                        return ability;
                    }
                    return null;
                };

                // CRITICAL: If madness is dangerous (>= 70%), prioritize purification or skip
                if (aiMadness >= 70) {
                    const purify = findAbility('purification');
                    if (purify) {
                        selectedAbility = purify;
                    } else {
                        // No purification available and madness is critical - skip ability to avoid death
                        gameState.opponentUsedAbility = false;
                        gameState.aiPendingAbility = null;
                        return;
                    }
                }

                // HIGH PRIORITY: If madness is high (>= 50%), strongly prefer purification
                if (!selectedAbility && aiMadness >= 50) {
                    selectedAbility = findAbility('purification');
                }

                // MODERATE: If madness is moderate (>= 35%), consider purification
                if (!selectedAbility && aiMadness >= 35) {
                    const purify = findAbility('purification');
                    if (purify && Math.random() < 0.7) { // 70% chance to purify
                        selectedAbility = purify;
                    }
                }

                // If player is low HP, prioritize destruction (but check madness safety)
                if (!selectedAbility && playerHP <= 30) {
                    selectedAbility = findSafeAbility('destruction') || findSafeAbility('death');
                }

                // If AI is low HP, prioritize healing (but check madness safety)
                if (!selectedAbility && aiHP <= 30) {
                    selectedAbility = findSafeAbility('creation');
                }

                // God mode: ALWAYS prioritize damage and control (with madness checks)
                if (aiDifficulty === 'god' && !selectedAbility) {
                    // First: damage abilities to kill player fast
                    const damageAbilities = ['destruction', 'death'];
                    for (const cat of damageAbilities) {
                        const found = findSafeAbility(cat);
                        if (found) {
                            selectedAbility = found;
                            break;
                        }
                    }
                    // Then: control abilities to cripple player
                    if (!selectedAbility) {
                        const controlAbilities = ['darkness', 'justiciar', 'binding', 'visionary', 'error'];
                        for (const cat of controlAbilities) {
                            const found = findSafeAbility(cat);
                            if (found) {
                                selectedAbility = found;
                                break;
                            }
                        }
                    }
                    // Then: healing if below 150 HP
                    if (!selectedAbility && aiHP < 150) {
                        selectedAbility = findSafeAbility('creation');
                    }
                }

                // Hard mode: Prefer utility abilities (with madness safety)
                if (!selectedAbility) {
                    const utilityOrder = ['purification', 'fate', 'door', 'knowledge', 'stealth', 'destruction', 'creation'];
                    for (const cat of utilityOrder) {
                        const found = findSafeAbility(cat);
                        if (found) {
                            selectedAbility = found;
                            break;
                        }
                    }
                }

                // Final safety check: Don't use ability if it would kill us from madness
                if (selectedAbility && selectedAbility.category !== 'purification') {
                    if (wouldCauseMadnessDeath(selectedAbility.category)) {
                        // Try purification instead, or skip
                        const purify = findAbility('purification');
                        if (purify) {
                            selectedAbility = purify;
                        } else {
                            gameState.opponentUsedAbility = false;
                            gameState.aiPendingAbility = null;
                            return;
                        }
                    }
                }
            }

            // Store the selected ability for later execution (don't execute yet)
            if (selectedAbility) {
                const gameAbility = GAME_ABILITIES[selectedAbility.category];
                gameState.aiPendingAbility = {
                    cardIndex: selectedAbility.index,
                    abilityIndex: 0,
                    cardName: selectedAbility.card.name,
                    abilityName: gameAbility.name,
                    abilityDesc: gameAbility.desc
                };
                gameState.opponentUsedAbility = true;
            } else {
                gameState.aiPendingAbility = null;
                gameState.opponentUsedAbility = false;
            }
        }

        function showAbilityUsedIndicator(ability) {
            const indicator = document.getElementById('ability-used-indicator');
            document.getElementById('ability-used-name').textContent = `${ability.abilityName} (${ability.cardName})`;
            indicator.classList.add('show');
        }

        function hideAbilityUsedIndicator() {
            document.getElementById('ability-used-indicator').classList.remove('show');
        }

        // Execute pending abilities during battle phase (after cards selected)
        function executePendingAbilities() {
            // Execute AI's pending ability first
            if (gameState.aiPendingAbility) {
                executeAbility(gameState.aiPendingAbility, true);
                addLogEntry(`Opponent used ${gameState.aiPendingAbility.abilityName} (${gameState.aiPendingAbility.cardName})`, 'info');
                gameState.aiPendingAbility = null;
            }

            // Check if game ended after AI's ability (e.g., madness death)
            if (gameState.gameOver) return;

            // Execute player's pending ability
            if (gameState.playerPendingAbility) {
                executeAbility(gameState.playerPendingAbility, false);
                addLogEntry(`You used ${gameState.playerPendingAbility.abilityName} (${gameState.playerPendingAbility.cardName})`, 'info');
                gameState.playerPendingAbility = null;
            }
        }

        function getMatchupResult(playerCard, opponentCard) {
            // In inner_vs_outer mode, cards can never be the same (different pools)
            if (gameType !== 'inner_vs_outer' && playerCard === opponentCard) {
                const entityType = gameType === 'outer_deities' ? 'Outer Deities' : 'pathways';
                return { outcome: 'DRAW', diff: 'Variable', reason: `Mirror match! Both ${entityType} clash equally.` };
            }

            const currentMatchups = getCurrentMatchups();

            // Normal lookup: playerCard vs opponentCard
            let matchup = currentMatchups[playerCard]?.[opponentCard];
            if (matchup) {
                return matchup;
            }

            // If playing as Outer Deities in inner_vs_outer mode, need to reverse lookup
            // Matchups are stored as Pathway -> Outer Deity, so look up opponent -> player and reverse outcome
            if (gameType === 'inner_vs_outer' && innerVsOuterPlayerSide === 'outer_deities') {
                const reverseMatchup = currentMatchups[opponentCard]?.[playerCard];
                if (reverseMatchup) {
                    // Reverse the outcome (WIN becomes LOSS, LOSS becomes WIN, DRAW stays DRAW)
                    let reversedOutcome = reverseMatchup.outcome;
                    if (reversedOutcome === 'WIN') reversedOutcome = 'LOSS';
                    else if (reversedOutcome === 'LOSS') reversedOutcome = 'WIN';

                    return {
                        outcome: reversedOutcome,
                        diff: reverseMatchup.diff,
                        reason: reverseMatchup.reason
                    };
                }
            }

            return { outcome: 'DRAW', diff: 'Variable', reason: 'Unknown matchup - defaulting to draw.' };
        }

        function calculateDamage(diff, isWinner) {
            let baseDamage = 0;
            let selfDamage = 0;

            if (isWinner) {
                switch (diff) {
                    case 'Low':
                        baseDamage = 30;
                        break;
                    case 'Mid':
                        baseDamage = 20;
                        break;
                    case 'High':
                        baseDamage = 10;
                        selfDamage = 5;
                        break;
                    case 'Extreme':
                        // Extreme difficulty - brutal battle, loser takes heavy damage
                        baseDamage = 10;
                        selfDamage = 5;
                        break;
                    default:
                        baseDamage = 0;
                }
            }

            return {
                damage: baseDamage * gameState.damageMultiplier,
                selfDamage: selfDamage * gameState.damageMultiplier
            };
        }

        function resolveBattle(playerCardName, opponentCardName) {
            const result = getMatchupResult(playerCardName, opponentCardName);
            let logClass = 'info';
            let logText = '';
            let playerDamageTaken = 0;
            let opponentDamageTaken = 0;

            // Store values before battle for achievements
            const opponentHPBefore = gameState.opponentHP;
            const playerHPBefore = gameState.playerHP;
            const multiplierBefore = gameState.damageMultiplier;

            if (result.outcome === 'WIN') {
                const dmg = calculateDamage(result.diff, true);
                opponentDamageTaken = dmg.damage;
                playerDamageTaken = dmg.selfDamage;
                logClass = 'win';

                if (playerDamageTaken > 0) {
                    logText = `Victory! ${playerCardName} defeats ${opponentCardName} (${result.diff} Diff). Dealt ${opponentDamageTaken} damage, took ${playerDamageTaken} recoil.`;
                } else {
                    logText = `Victory! ${playerCardName} defeats ${opponentCardName} (${result.diff} Diff). Dealt ${opponentDamageTaken} damage!`;
                }
            } else if (result.outcome === 'LOSS') {
                const dmg = calculateDamage(result.diff, true);
                playerDamageTaken = dmg.damage;
                opponentDamageTaken = dmg.selfDamage;
                logClass = 'lose';

                if (opponentDamageTaken > 0) {
                    logText = `Defeat! ${opponentCardName} defeats ${playerCardName} (${result.diff} Diff). Took ${playerDamageTaken} damage. Opponent took ${opponentDamageTaken} recoil.`;
                } else {
                    logText = `Defeat! ${opponentCardName} defeats ${playerCardName} (${result.diff} Diff). Took ${playerDamageTaken} damage.`;
                }
            } else {
                logClass = 'draw';
                const entityDesc = gameType === 'inner_vs_outer' ? 'entity' : 'pathway';
                logText = `Draw! Neither ${entityDesc} can overcome the other. Next turn's damage will be DOUBLED! (x${gameState.damageMultiplier * 2})`;
            }

            // Apply madness multipliers - higher madness = more damage taken
            const playerMadMult = getMadnessMultiplier(gameState.playerMadness || 0);
            const opponentMadMult = getMadnessMultiplier(gameState.opponentMadness || 0);

            let finalPlayerDamage = playerDamageTaken * playerMadMult;
            let finalOpponentDamage = opponentDamageTaken * opponentMadMult;

            // God Mode: AI takes 50% less damage, player takes 50% more
            let godModeApplied = false;
            if (gameMode === 'ai' && aiDifficulty === 'god') {
                finalPlayerDamage = Math.ceil(finalPlayerDamage * 1.5);
                finalOpponentDamage = Math.floor(finalOpponentDamage * 0.5);
                godModeApplied = true;
            }

            // Supernova Dominator: Double all damage
            if (gameState.supernovaDamageDouble) {
                finalPlayerDamage = Math.ceil(finalPlayerDamage * 2);
                finalOpponentDamage = Math.ceil(finalOpponentDamage * 2);
                logText += ' [SUPERNOVA: x2 DAMAGE]';
                gameState.supernovaDamageDouble = false; // Reset after use
            }

            // Chaos Swap: Swap damage outcomes, user takes half
            if (gameState.chaosSwapActive) {
                const tempPlayerDamage = finalPlayerDamage;
                const tempOpponentDamage = finalOpponentDamage;
                if (gameState.chaosSwapUser === 'ai') {
                    // AI used chaos - AI takes player's damage (halved), player takes AI's damage
                    finalOpponentDamage = Math.floor(tempPlayerDamage * 0.5);
                    finalPlayerDamage = tempOpponentDamage;
                } else {
                    // Player used chaos - Player takes AI's damage (halved), AI takes player's damage
                    finalPlayerDamage = Math.floor(tempOpponentDamage * 0.5);
                    finalOpponentDamage = tempPlayerDamage;
                }
                logText += ' [CHAOS: Damage swapped]';
                gameState.chaosSwapActive = false;
                gameState.chaosSwapUser = null;
            }

            // Swapped cards (Goddess of Fate): 1.5x damage bonus
            if (gameState.swappedCardNames && gameState.swappedCardNames.length > 0) {
                if (gameState.swappedCardNames.includes(playerCardName)) {
                    finalOpponentDamage = Math.ceil(finalOpponentDamage * 1.5);
                    logText += ' [Fate: 1.5x damage]';
                }
                if (gameState.swappedCardNames.includes(opponentCardName)) {
                    finalPlayerDamage = Math.ceil(finalPlayerDamage * 1.5);
                    logText += ' [Fate: 1.5x damage to you]';
                }
                gameState.swappedCardNames = []; // Clear after use
            }

            // Update log text if madness affected damage
            if (playerMadMult > 1 && playerDamageTaken > 0) {
                logText += ` (Madness: ${playerMadMult}x = ${finalPlayerDamage} actual)`;
            }
            if (opponentMadMult > 1 && opponentDamageTaken > 0) {
                logText += ` (Opponent Madness: ${opponentMadMult}x = ${finalOpponentDamage} actual)`;
            }

            // Update log text if God Mode affected damage (and madness didn't already show it)
            if (godModeApplied && playerDamageTaken > 0 && playerMadMult === 1) {
                logText += ` (God Mode: You took ${finalPlayerDamage} actual)`;
            }
            if (godModeApplied && opponentDamageTaken > 0 && opponentMadMult === 1) {
                logText += ` (God Mode: AI took ${finalOpponentDamage} actual)`;
            }

            // In PvP, each player only applies damage to themselves
            // Opponent handles their own HP based on their own battle resolution
            if (gameMode === 'pvp') {
                // Only apply damage to myself
                gameState.playerHP = Math.max(0, gameState.playerHP - finalPlayerDamage);
                // Don't modify opponentHP - they will apply their own damage
            } else {
                // Single player - apply both damages
                gameState.opponentHP = Math.max(0, gameState.opponentHP - finalOpponentDamage);
                gameState.playerHP = Math.max(0, gameState.playerHP - finalPlayerDamage);
            }

            if (result.outcome === 'DRAW') {
                gameState.damageMultiplier *= 2;
            } else {
                gameState.damageMultiplier = 1;
                // Reset x128 sequence tracker when multiplier resets
                gameAchievementState.reachedX128ThisSequence = false;
            }

            // Store battle data for detail view (use final damage after all modifiers)
            const battleData = {
                turn: gameState.turn,
                playerCard: playerCardName,
                opponentCard: opponentCardName,
                outcome: result.outcome,
                diff: result.diff,
                reason: result.reason,
                playerDamage: finalPlayerDamage,
                opponentDamage: finalOpponentDamage,
                playerHPAfter: gameState.playerHP,
                opponentHPAfter: gameState.opponentHP
            };

            addLogEntry(logText, logClass, result.reason, battleData);

            // Check achievements on play
            checkAchievementsOnPlay(playerCardName, opponentCardName, result, opponentDamageTaken, playerDamageTaken, opponentHPBefore, playerHPBefore, multiplierBefore);

            // Sync game state to Firebase after battle (HP changes, damage multiplier)
            syncGameStateToFirebase();

            return result;
        }

        function addLogEntry(text, className, flavor, battleData = null) {
            const logContent = DOM.get('log-content');
            const entry = document.createElement('div');
            entry.className = `log-entry ${className}`;

            // If this is a battle entry (not just info), make it clickable
            if (battleData) {
                const battleId = battleHistory.length;
                battleHistory.push(battleData);
                entry.classList.add('clickable');
                entry.setAttribute('data-battle-id', battleId);
                entry.onclick = () => showBattleDetail(battleId);
            }

            entry.innerHTML = `<strong>Turn ${gameState.turn}:</strong> ${text}`;
            if (flavor) {
                entry.innerHTML += `<div class="log-flavor">"${flavor}"</div>`;
            }
            logContent.insertBefore(entry, logContent.firstChild);
        }

        function showBattleDetail(battleId) {
            const battle = battleHistory[battleId];
            if (!battle) return;

            const modal = document.getElementById('battle-detail-modal');
            const body = document.getElementById('battle-detail-body');

            // Get pathway data for images
            const currentPathways = getCurrentPathways();
            const playerPathway = currentPathways.find(p => p.name === battle.playerCard);
            const opponentPathway = currentPathways.find(p => p.name === battle.opponentCard);

            // Get matchup details (check both key orders)
            const key1 = `${battle.playerCard} vs ${battle.opponentCard}`;
            const key2 = `${battle.opponentCard} vs ${battle.playerCard}`;
            const details = MATCHUP_DETAILS[key1] || MATCHUP_DETAILS[key2] || null;

            // Determine outcome text and color
            let outcomeText, outcomeClass;
            if (battle.outcome === 'WIN') {
                outcomeText = 'VICTORY';
                outcomeClass = 'win';
            } else if (battle.outcome === 'LOSS') {
                outcomeText = 'DEFEAT';
                outcomeClass = 'lose';
            } else {
                outcomeText = 'DRAW';
                outcomeClass = 'draw';
            }

            // Get diff explanation
            const diffExplanation = DIFF_EXPLANATIONS[battle.diff] || '';

            body.innerHTML = `
                <div class="battle-detail-turn">Turn ${battle.turn}</div>

                <div class="battle-detail-matchup">
                    <div class="battle-detail-card">
                        <img src="${playerPathway?.icon || ''}" alt="${battle.playerCard}">
                        <span>You: ${battle.playerCard}</span>
                    </div>
                    <div class="battle-detail-vs">VS</div>
                    <div class="battle-detail-card">
                        <img src="${opponentPathway?.icon || ''}" alt="${battle.opponentCard}">
                        <span>Opponent: ${battle.opponentCard}</span>
                    </div>
                </div>

                <div class="battle-detail-outcome ${outcomeClass}">
                    ${outcomeText}
                </div>

                <div class="battle-detail-stats">
                    <div class="battle-detail-stat">
                        <span class="stat-label">Difficulty:</span>
                        <span class="stat-value">${battle.diff}</span>
                    </div>
                    <div class="battle-detail-stat">
                        <span class="stat-label">Your Damage Taken:</span>
                        <span class="stat-value ${battle.playerDamage > 0 ? 'negative' : ''}">${battle.playerDamage}</span>
                    </div>
                    <div class="battle-detail-stat">
                        <span class="stat-label">Opponent Damage Taken:</span>
                        <span class="stat-value ${battle.opponentDamage > 0 ? 'positive' : ''}">${battle.opponentDamage}</span>
                    </div>
                </div>

                <div class="battle-detail-section">
                    <h3>Difficulty Meaning</h3>
                    <p>${diffExplanation}</p>
                </div>

                <div class="battle-detail-section">
                    <h3>Why This Result?</h3>
                    <p class="battle-reason">"${battle.reason}"</p>
                    <p>${details?.explanation || '<em>Detailed explanation coming soon...</em>'}</p>
                </div>

                <div class="battle-detail-section">
                    <h3>The Battle</h3>
                    <p class="battle-story">${details?.story || '<em>Story coming soon...</em>'}</p>
                </div>
            `;

            modal.classList.add('active');
        }

        function closeBattleDetail() {
            document.getElementById('battle-detail-modal').classList.remove('active');
        }

        // Close battle detail modal when clicking outside
        document.addEventListener('DOMContentLoaded', function() {
            const battleModal = document.getElementById('battle-detail-modal');
            if (battleModal) {
                battleModal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        closeBattleDetail();
                    }
                });
            }
        });

        // Close modal on Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeBattleDetail();
            }
        });

        // Calculate damage multiplier from madness level
        function getMadnessMultiplier(madness) {
            if (madness >= 50) return 1.5;   // 50%+ = 1.5x damage taken
            return 1;  // Below 50% = base damage
        }

        // Add madness to player or opponent, returns true if 100% madness reached (auto-loss)
        function addMadness(amount, isAI = false) {
            if (isAI) {
                // In PvP, opponent handles their own madness - don't modify it here
                if (gameMode === 'pvp') return false;

                // God Mode AI is immune to madness
                if (aiDifficulty === 'god') return false;

                gameState.opponentMadness = Math.min(100, Math.max(0, (gameState.opponentMadness || 0) + amount));
                if (gameState.opponentMadness >= 100) {
                    addLogEntry('Opponent succumbed to madness!', 'win');
                    gameState.opponentHP = 0;
                    checkGameOver();
                    return true;
                }
            } else {
                gameState.playerMadness = Math.min(100, Math.max(0, (gameState.playerMadness || 0) + amount));
                if (gameState.playerMadness >= 100) {
                    addLogEntry('You succumbed to madness!', 'lose');
                    gameState.playerHP = 0;
                    syncGameStateToFirebase();
                    checkGameOver();
                    return true;
                }
            }
            updateUI();
            syncGameStateToFirebase();
            return false;
        }

        // Madness costs for each ability type
        const MADNESS_COSTS = {
            // Simple abilities
            creation: 15,       // Healing is powerful, needs cost
            purification: -10,  // Reduces madness (cleansing effect)
            destruction_10: 10, // 10 damage costs 10%
            destruction_15: 15, // 15 damage costs 15%
            death: 15,          // Death/Corruption
            // Medium abilities
            knowledge: 15,      // Can chain cards
            stealth: 10,        // Peek at future
            binding: 10,        // Can be beneficial or not
            // Complex/Special abilities (ace in the hole)
            fool: 20,           // Decoy mechanic
            door: 20,           // Dimension travel
            darkness: 20,       // Blind + block
            visionary: 20,      // Mind reading
            justiciar: 20,      // Force + block
            fate: 20,           // Guarantee pathway
            error: 20,          // Cancel all + reshuffle
            // Outer Deity abilities (more powerful, higher costs)
            outer_depravity: 20,    // Corrupting Influence - reverse effects
            outer_desire: 15,       // Unpredictable Growth - draw 2, risk discard
            outer_chaos: 20,        // Chaos Swap - swap damage, halve yours
            outer_inevitability: 20,// Forced Play - force opponent's card
            outer_hunger: 25,       // Primordial Maw - 10 dmg + consume cards (base for 2 turns)
            outer_supernova: 25,    // Celestial Collapse - double all damage, reveal hands
            outer_ravings: 20,      // (placeholder - needs design)
            outer_decay: 20,        // (placeholder - needs design)
            outer_overseer: 30,     // Forced Fate - 2 turns control
            outer_fate: 15          // Threads of Destiny - swap cards, 1.5x damage
        };

        function updateUI() {
            // Cache all DOM elements at start for this frequently-called function
            const playerHpText = DOM.get('player-hp-text');
            const opponentHpText = DOM.get('opponent-hp-text');
            const playerHpBar = DOM.get('player-hp-bar');
            const opponentHpBar = DOM.get('opponent-hp-bar');
            const playerMadnessText = DOM.get('player-madness-text');
            const playerMadnessBar = DOM.get('player-madness-bar');
            const opponentMadnessText = DOM.get('opponent-madness-text');
            const opponentMadnessBar = DOM.get('opponent-madness-bar');
            const playerMadMultEl = DOM.get('player-madness-mult');
            const opponentMadMultEl = DOM.get('opponent-madness-mult');
            const multiplierEl = DOM.get('multiplier-display');
            const playBtn = DOM.get('play-btn');

            playerHpText.textContent = `${gameState.playerHP} HP`;
            opponentHpText.textContent = `${gameState.opponentHP} HP`;
            playerHpBar.style.width = `${gameState.playerHP}%`;
            // God Mode: AI has 200 HP max, scale bar accordingly
            const opponentMaxHP = (gameMode === 'ai' && aiDifficulty === 'god') ? 200 : 100;
            opponentHpBar.style.width = `${(gameState.opponentHP / opponentMaxHP) * 100}%`;

            // Update madness bars
            const playerMadness = gameState.playerMadness || 0;
            const opponentMadness = gameState.opponentMadness || 0;

            playerMadnessText.textContent = `${playerMadness}%`;
            playerMadnessBar.style.width = `${playerMadness}%`;

            // God Mode AI: Hide opponent madness (they're immune)
            const isGodMode = gameMode === 'ai' && aiDifficulty === 'god';
            if (isGodMode) {
                opponentMadnessText.textContent = '\u221e';
                opponentMadnessBar.style.width = '0%';
                opponentMadMultEl.textContent = 'IMMUNE';
                opponentMadMultEl.style.color = '#aa44ff';
            } else {
                opponentMadnessText.textContent = `${opponentMadness}%`;
                opponentMadnessBar.style.width = `${opponentMadness}%`;
                opponentMadMultEl.style.color = '';
            }

            // Update madness multiplier display
            const playerMadMult = getMadnessMultiplier(playerMadness);
            const opponentMadMult = getMadnessMultiplier(opponentMadness);

            playerMadMultEl.textContent = `${playerMadMult}x DMG taken`;
            if (!isGodMode) {
                opponentMadMultEl.textContent = `${opponentMadMult}x DMG taken`;
            }

            // Apply danger class when at 1.5x
            playerMadMultEl.className = 'madness-multiplier';
            if (!isGodMode) {
                opponentMadMultEl.className = 'madness-multiplier';
                if (opponentMadMult > 1) opponentMadMultEl.classList.add('danger-2x');
            }

            if (playerMadMult > 1) playerMadMultEl.classList.add('danger-2x');

            multiplierEl.textContent = `Damage Multiplier: x${gameState.damageMultiplier}`;
            if (gameState.damageMultiplier > 1) {
                multiplierEl.classList.add('active');
            } else {
                multiplierEl.classList.remove('active');
            }

            const canPlay = gameState.selectedCard !== null && !gameState.gameOver && !waitingForOpponent;
            playBtn.disabled = !canPlay;

            // Always update stats display (God Mode shows infinity)
            updatePlayerStatsDisplay();
        }

        function renderHand() {
            const handEl = DOM.get('player-hand');
            handEl.innerHTML = '';
            const weights = getCardWeights();

            // Check for forced card selection
            if (gameState.forcedPlayerCard && !gameState.abilityPhaseActive) {
                const forcedIndex = gameState.playerHand.findIndex(c => c.name === gameState.forcedPlayerCard);
                if (forcedIndex !== -1 && gameState.selectedCard === null) {
                    gameState.selectedCard = forcedIndex;
                }
            }

            gameState.playerHand.forEach((card, index) => {
                const cardEl = document.createElement('div');
                cardEl.className = 'card';

                // Check if card is blinded
                const isBlinded = gameState.playerBlinded;

                // Check if this card is the decoy
                const isDecoy = gameState.foolDecoyActive && gameState.foolDecoyCardIndex === index;

                // Check if this card is forced
                const isForced = gameState.forcedPlayerCard === card.name;

                if (gameState.gameOver || waitingForOpponent || gameState.abilityPhaseActive || isDecoy) {
                    cardEl.classList.add('disabled');
                }
                if (gameState.selectedCard === index) cardEl.classList.add('selected');
                if (isDecoy) cardEl.classList.add('decoy-active');
                if (isForced && !gameState.abilityPhaseActive) cardEl.classList.add('selected');

                cardEl.setAttribute('data-tooltip', isBlinded ? '???' : card.flavor);

                const weight = weights[card.name];
                const isFresh = weight >= FRESH_WEIGHT * 0.7;
                const isBigHit = getCurrentBigHitList().includes(card.name);

                if (isBlinded) {
                    cardEl.innerHTML = `
                        <div class="card-icon" style="position: relative;">
                            <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #2a2a4a, #1a1a2e); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 32px; color: #666;">?</div>
                        </div>
                        <div class="card-name" style="color: #666;">???</div>
                        <div class="card-weight"></div>
                    `;
                } else {
                    cardEl.innerHTML = `
                        <div class="card-icon"><img src="${card.icon}" alt="${card.name}"></div>
                        <div class="card-name ${isBigHit ? 'rainbow' : ''}">${card.name}</div>
                        <div class="card-weight ${isFresh ? 'fresh' : ''}">${isFresh ? 'Fresh!' : ''}${isForced ? ' (Forced!)' : ''}</div>
                    `;
                }

                cardEl.onclick = () => {
                    if (!gameState.gameOver && !waitingForOpponent && !gameState.abilityPhaseActive && !isDecoy) {
                        // If forced, only allow selecting the forced card
                        if (gameState.forcedPlayerCard && card.name !== gameState.forcedPlayerCard) {
                            return;
                        }
                        selectCard(index);
                    }
                };

                handEl.appendChild(cardEl);
            });

            // Clear blinded state after render (player has made their choice)
            // Note: We keep blinded until after turn resolution for full effect
        }

        function selectCard(index) {
            if (gameState.selectedCard === index) {
                gameState.selectedCard = null;
            } else {
                gameState.selectedCard = index;
                // Tutorial event: card selected
                if (tutorialMode && gameState.selectedCard !== null) {
                    handleTutorialEvent('cardSelected');
                }
            }
            renderHand();
            updateUI();

            const playerPlayedEl = DOM.get('player-played');
            if (gameState.selectedCard !== null) {
                playerPlayedEl.className = 'played-card face-down';
                playerPlayedEl.innerHTML = `
                    <div style="font-size: 24px;">?</div>
                    <div class="pvp-ready-text">Ready</div>
                `;
            } else {
                playerPlayedEl.className = 'played-card empty';
                playerPlayedEl.innerHTML = '<div>Your Card</div>';
            }
        }

        // Render opponent's hand (face-down or revealed)
        function renderOpponentHand() {
            const opponentHandEl = document.querySelector('.opponent-hand');
            if (!opponentHandEl) return;

            opponentHandEl.innerHTML = '';
            const hand = gameState.opponentHand || [];

            // Show revealed cards if Supernova is active
            if (gameState.handsRevealed) {
                hand.forEach(card => {
                    const cardEl = document.createElement('div');
                    cardEl.className = 'card-back revealed';
                    cardEl.style.cssText = 'background: linear-gradient(135deg, #4a1a1a, #2a1a2a); padding: 5px; text-align: center;';
                    cardEl.innerHTML = `
                        <img src="${card.icon}" alt="${card.name}" style="width: 40px; height: 40px; margin-bottom: 2px;">
                        <div style="font-size: 9px; color: #ffd700;">${card.name}</div>
                    `;
                    opponentHandEl.appendChild(cardEl);
                });
            } else {
                // Normal face-down cards
                for (let i = 0; i < hand.length; i++) {
                    const cardEl = document.createElement('div');
                    cardEl.className = 'card-back';
                    cardEl.textContent = '?';
                    opponentHandEl.appendChild(cardEl);
                }
            }
        }

        // AI Card Selection based on difficulty
        function aiSelectCard(playerCard) {
            const hand = gameState.opponentHand;
            if (!hand || hand.length === 0) return null;

            // Tutorial mode: Use forced card if set, or play predictably (prefer weak cards in chapters 1-4)
            if (tutorialMode && tutorialChapter <= 4) {
                if (tutorialForcedAICard) {
                    const forcedCard = hand.find(c => c.name === tutorialForcedAICard);
                    tutorialForcedAICard = null;
                    if (forcedCard) return forcedCard;
                }
                // In early tutorial chapters, AI prefers low tier cards to help player learn
                const lowTier = gameType === 'inner_vs_outer' ? getOpponentLowTierList() : getCurrentLowTierList();
                const weakCards = hand.filter(c => lowTier.includes(c.name));
                if (weakCards.length > 0 && Math.random() < 0.7) {
                    return weakCards[Math.floor(Math.random() * weakCards.length)];
                }
                return hand[Math.floor(Math.random() * hand.length)];
            }

            // Get tier lists for the opponent
            const bigHits = gameType === 'inner_vs_outer' ? getOpponentBigHitList() : getCurrentBigHitList();
            const mediumHits = gameType === 'inner_vs_outer' ? getOpponentMediumHitList() : getCurrentMediumHitList();
            const lowTier = gameType === 'inner_vs_outer' ? getOpponentLowTierList() : getCurrentLowTierList();

            // Categorize cards in hand by tier
            const highTierCards = hand.filter(c => bigHits.includes(c.name));
            const medTierCards = hand.filter(c => mediumHits.includes(c.name));
            const lowTierCards = hand.filter(c => lowTier.includes(c.name));

            switch (aiDifficulty) {
                case 'easy':
                    // Completely random selection
                    return hand[Math.floor(Math.random() * hand.length)];

                case 'medium':
                    // 60% chance to prefer high/medium tier cards
                    if (Math.random() < 0.6) {
                        const goodCards = [...highTierCards, ...medTierCards];
                        if (goodCards.length > 0) {
                            return goodCards[Math.floor(Math.random() * goodCards.length)];
                        }
                    }
                    return hand[Math.floor(Math.random() * hand.length)];

                case 'hard':
                    // 80% chance to use counter logic (knows player's card)
                    if (playerCard && Math.random() < 0.8) {
                        // Find all winning cards
                        const winningCards = hand.filter(card => {
                            const result = getMatchupResult(card.name, playerCard.name);
                            return result.outcome === 'WIN';
                        });

                        if (winningCards.length > 0) {
                            // Prioritize by damage (Low > Mid > High diff)
                            const lowDiffWinners = winningCards.filter(card => {
                                const result = getMatchupResult(card.name, playerCard.name);
                                return result.diff === 'Low';
                            });
                            if (lowDiffWinners.length > 0) {
                                return lowDiffWinners[Math.floor(Math.random() * lowDiffWinners.length)];
                            }
                            const midDiffWinners = winningCards.filter(card => {
                                const result = getMatchupResult(card.name, playerCard.name);
                                return result.diff === 'Mid';
                            });
                            if (midDiffWinners.length > 0) {
                                return midDiffWinners[Math.floor(Math.random() * midDiffWinners.length)];
                            }
                            return winningCards[Math.floor(Math.random() * winningCards.length)];
                        }

                        // No win? Try for draw
                        const drawCards = hand.filter(card => {
                            const result = getMatchupResult(card.name, playerCard.name);
                            return result.outcome === 'DRAW';
                        });
                        if (drawCards.length > 0) {
                            return drawCards[Math.floor(Math.random() * drawCards.length)];
                        }
                    }
                    // 20% of time or no counter found: prefer high/medium tier cards
                    const goodCards = [...highTierCards, ...medTierCards];
                    if (goodCards.length > 0) {
                        return goodCards[Math.floor(Math.random() * goodCards.length)];
                    }
                    return hand[Math.floor(Math.random() * hand.length)];

                case 'god':
                    // God Mode: Always try to counter, knows player's card (cheating)
                    // Prioritizes optimal damage matchups (Low > Mid diff wins)
                    if (playerCard) {
                        // Find all winning cards
                        const winningCards = hand.filter(card => {
                            const result = getMatchupResult(card.name, playerCard.name);
                            return result.outcome === 'WIN';
                        });

                        // Prioritize by damage (Low diff = 30 dmg, Mid = 20, High = 10)
                        if (winningCards.length > 0) {
                            const lowDiffWinners = winningCards.filter(card => {
                                const result = getMatchupResult(card.name, playerCard.name);
                                return result.diff === 'Low';
                            });
                            if (lowDiffWinners.length > 0) {
                                return lowDiffWinners[0];
                            }
                            const midDiffWinners = winningCards.filter(card => {
                                const result = getMatchupResult(card.name, playerCard.name);
                                return result.diff === 'Mid';
                            });
                            if (midDiffWinners.length > 0) {
                                return midDiffWinners[0];
                            }
                            // Take any win (even High diff)
                            return winningCards[0];
                        }

                        // No winning card? Try for a draw (stall and stack multiplier)
                        const drawCards = hand.filter(card => {
                            const result = getMatchupResult(card.name, playerCard.name);
                            return result.outcome === 'DRAW';
                        });
                        if (drawCards.length > 0) {
                            return drawCards[0];
                        }

                        // No draw? Pick card that loses with highest difficulty (least damage taken)
                        const lossCards = hand.map(card => {
                            const result = getMatchupResult(card.name, playerCard.name);
                            return { card, diff: result.diff };
                        });
                        // Prefer High diff loss (10 dmg) > Mid (20) > Low (30)
                        const highDiffLoss = lossCards.find(c => c.diff === 'High');
                        if (highDiffLoss) return highDiffLoss.card;
                        const midDiffLoss = lossCards.find(c => c.diff === 'Mid');
                        if (midDiffLoss) return midDiffLoss.card;
                    }
                    // Fallback: Random card (no tier preference)
                    return hand[Math.floor(Math.random() * hand.length)];

                default:
                    return hand[Math.floor(Math.random() * hand.length)];
            }
        }

        function playTurn() {
            if (gameState.selectedCard === null || gameState.gameOver || gameState.abilityPhaseActive) return;

            const playerCard = gameState.playerHand[gameState.selectedCard];

            // Tutorial event: card played
            if (tutorialMode) {
                handleTutorialEvent('cardPlayed');
            }

            // Track played pathways for Inner God summoning (inner_vs_outer mode only)
            if (gameType === 'inner_vs_outer' && playerCard && !playerCard.isInnerGod) {
                gameState.drawnPathwaysThisGame.add(playerCard.name);

                // Check if any new Inner Gods are now available
                const newlyAvailable = checkAvailableInnerGods();
                if (newlyAvailable.length > 0) {
                    newlyAvailable.forEach(godName => {
                        gameState.availableInnerGods.push(godName);
                        addLogEntry(` ${godName} can now be summoned! All required pathways played!`, 'win');
                    });
                }

                // Update the summon area UI
                updateInnerGodSummonArea();
            }

            if (gameMode === 'pvp') {
                myCardPlayed = playerCard.name;
                waitingForOpponent = true;

                const playerPlayedEl = DOM.get('player-played');
                playerPlayedEl.className = 'played-card face-down';
                playerPlayedEl.innerHTML = `
                    <div style="font-size: 24px;">\u2713</div>
                    <div class="pvp-locked-text">Locked In</div>
                `;

                const opponentPlayedEl = DOM.get('opponent-played');
                if (!opponentCardPlayed) {
                    opponentPlayedEl.className = 'played-card waiting';
                    opponentPlayedEl.innerHTML = `
                        <div style="font-size: 24px;">...</div>
                        <div style="font-size: 12px;">Waiting</div>
                    `;
                }

                // Send card to Firebase
                if (roomRef) {
                    const cardPath = playerId === 'player1' ? 'player1Card' : 'player2Card';
                    roomRef.child(cardPath).set(playerCard.name).catch((error) => {
                        console.error('Error sending card to Firebase:', error);
                        addLogEntry('Connection error. Your move may not sync.', 'error');
                    });
                }

                // Clear forced card state after play
                gameState.forcedPlayerCard = null;

                updateUI();
                renderHand();
                checkBothPlayed();

            } else {
                // Determine opponent's card - use forced card if set, otherwise AI selection
                let opponentCard;
                if (gameState.forcedOpponentCard) {
                    opponentCard = gameState.opponentHand.find(c => c.name === gameState.forcedOpponentCard);
                    if (!opponentCard) {
                        // Fallback to AI selection if forced card not in hand
                        opponentCard = aiSelectCard(playerCard);
                    }
                    gameState.forcedOpponentCard = null;
                } else {
                    // AI selects card based on difficulty
                    opponentCard = aiSelectCard(playerCard);
                }

                // Safety check - if AI couldn't select a card, skip the turn
                if (!opponentCard) {
                    addLogEntry('Opponent has no cards to play!', 'info');
                    return;
                }

                const playerPlayedEl = DOM.get('player-played');
                const opponentPlayedEl = DOM.get('opponent-played');

                playerPlayedEl.className = 'played-card revealed';
                playerPlayedEl.style.background = 'linear-gradient(135deg, #1a4a1a, #0a2a0a)';
                const currentBigHitList = getCurrentBigHitList();
                const playerIsBigHit = currentBigHitList.includes(playerCard.name);
                playerPlayedEl.innerHTML = `
                    <div class="card-icon"><img src="${playerCard.icon}" alt="${playerCard.name}"></div>
                    <div class="card-name ${playerIsBigHit ? 'rainbow' : ''}" ${!playerIsBigHit ? 'style="color: var(--color-gold);"' : ''}>${playerCard.name}</div>
                `;

                opponentPlayedEl.className = 'played-card revealed';
                opponentPlayedEl.style.background = 'linear-gradient(135deg, #4a1a1a, #2a0a0a)';
                const opponentBigHitList = getOpponentBigHitList();
                const opponentIsBigHit = opponentBigHitList.includes(opponentCard.name);
                opponentPlayedEl.innerHTML = `
                    <div class="card-icon"><img src="${opponentCard.icon}" alt="${opponentCard.name}"></div>
                    <div class="card-name ${opponentIsBigHit ? 'rainbow' : ''}" ${!opponentIsBigHit ? 'style="color: var(--color-gold);"' : ''}>${opponentCard.name}</div>
                `;

                // Execute pending abilities NOW (after cards selected, before damage)
                executePendingAbilities();

                // Check if abilities ended the game (e.g., madness death)
                if (gameState.gameOver) return;

                resolveBattle(playerCard.name, opponentCard.name);

                // Clear turn-based ability states after battle resolution
                gameState.forcedPlayerCard = null;
                gameState.playerBlinded = false;
                gameState.opponentBlinded = false;
                gameState.foolDecoyActive = false;
                gameState.foolDecoyCardIndex = null;

                updateUI();

                if (gameState.playerHP <= 0 || gameState.opponentHP <= 0) {
                    gameState.gameOver = true;
                    showGameOver();
                    return;
                }

                gameState.turn++;
                gameState.selectedCard = null;
                gameState.handsRevealed = false; // Reset Supernova reveal

                setTimeout(() => {
                    drawHands();
                    renderHand();
                    renderOpponentHand();

                    playerPlayedEl.className = 'played-card empty';
                    playerPlayedEl.style.background = '';
                    playerPlayedEl.innerHTML = '<div>Your Card</div>';

                    opponentPlayedEl.className = 'played-card empty';
                    opponentPlayedEl.style.background = '';
                    opponentPlayedEl.innerHTML = '<div>Opponent\'s Card</div>';

                    updateUI();
                    showAbilityPhase();
                }, 1500);
            }
        }

        function showGameOver() {
            const overlay = DOM.get('game-over');
            const content = DOM.get('game-over-content');
            const title = DOM.get('game-over-title');
            const text = DOM.get('game-over-text');

            const playerWon = gameState.opponentHP <= 0 && gameState.playerHP > 0;
            const isTie = gameState.playerHP <= 0 && gameState.opponentHP <= 0;

            // Tutorial mode: handle victory/defeat
            if (tutorialMode && tutorialChapter === 6) {
                handleTutorialVictory(playerWon);
            }

            // Check achievements on game end
            checkAchievementsOnGameEnd(playerWon, isTie);
            /* Update Stats in Firebase (All Games) - Skip for GMs (testing purposes) */
            if (playerCode && playerDb && !playerCode.startsWith('GM')) {
                const playerRef = playerDb.ref("players/" + playerCode);
                playerRef.transaction(currentData => {
                    if (!currentData) return currentData;
                    const wins = (currentData.wins || 0) + (playerWon ? 1 : 0);
                    const losses = (currentData.losses || 0) + ((!playerWon && !isTie) ? 1 : 0);
                    const ties = (currentData.ties || 0) + (isTie ? 1 : 0);
                    const games = (currentData.gamesPlayed || 0) + 1;

                    // Initialize stats object if not present
                    const stats = currentData.stats || {
                        gameType: {},
                        opponentType: {},
                        aiDifficulty: {}
                    };

                    // Helper to increment stat category
                    function incrementStat(statsObj, category, key, won) {
                        if (!statsObj[category]) statsObj[category] = {};
                        if (!statsObj[category][key]) statsObj[category][key] = { wins: 0, games: 0 };
                        statsObj[category][key].wins += won ? 1 : 0;
                        statsObj[category][key].games += 1;
                    }

                    // Record categorized stats (only count wins/losses, not ties)
                    if (!isTie) {
                        incrementStat(stats, 'gameType', gameType, playerWon);
                        incrementStat(stats, 'opponentType', gameMode, playerWon);
                        if (gameMode === 'ai') {
                            incrementStat(stats, 'aiDifficulty', aiDifficulty, playerWon);
                        }
                    }

                    return {
                        ...currentData,
                        wins: wins,
                        losses: losses,
                        ties: ties,
                        gamesPlayed: games,
                        stats: stats,
                        lastPlayed: firebase.database.ServerValue.TIMESTAMP
                    };
                });
            }

            setTimeout(updatePlayerStatsDisplay, 1000);
            if (isTie) {
                title.textContent = 'Mutual Destruction!';
                text.textContent = 'Both pathways have fallen...';
                content.className = 'game-over-content';
            } else if (gameState.playerHP <= 0) {
                title.textContent = 'Defeat';
                text.textContent = 'Your pathway has been overcome.';
                content.className = 'game-over-content defeat';
            } else {
                title.textContent = 'Victory!';
                text.textContent = 'You have triumphed over your opponent!';
                content.className = 'game-over-content victory';
            }

            overlay.classList.add('show');

            // Show the New Game button
            document.getElementById('new-game-btn').classList.add('show');
        }

        function dismissGameOver(event) {
            document.getElementById('game-over').classList.remove('show');
        }

        window.newGame = function() {
            if (gameMode === 'pvp' && roomRef) {
                roomRef.child('newGame').set({ requestedBy: playerId, timestamp: Date.now() })
                    .catch((error) => console.error('Error requesting new game:', error));
                roomRef.update({
                    player1Card: null,
                    player2Card: null,
                    player1Ability: null,
                    player2Ability: null,
                    turn: 1
                }).catch((error) => console.error('Error resetting room state:', error));
            }
            resetGameState();
            beginGame();
        }

        function setMode(mode) {
            gameMode = mode;

            document.getElementById('mode-ai').classList.toggle('active', mode === 'ai');
            document.getElementById('mode-pvp').classList.toggle('active', mode === 'pvp');

            const roomCodeSection = document.getElementById('room-code-section');
            const difficultySelection = document.getElementById('difficulty-selection');

            if (mode === 'pvp') {
                // Hide AI difficulty selection
                difficultySelection.classList.remove('show');

                // Show room code section and reset to private match
                roomCodeSection.classList.add('show');

                // Reset match type selector
                matchType = 'private';
                document.getElementById('match-type-selector').style.display = 'flex';
                document.getElementById('btn-private-match').classList.add('active');
                document.getElementById('btn-public-match').classList.remove('active');
                document.getElementById('private-room-ui').style.display = 'block';
                document.getElementById('public-match-ui').style.display = 'none';

                // Reset private room UI
                document.getElementById('room-code-input').disabled = false;
                document.getElementById('btn-join').disabled = false;
                document.getElementById('room-code-input').value = '';
                document.getElementById('room-code-display').textContent = '';

                // Reset public match UI
                document.getElementById('btn-find-match').style.display = 'block';
                document.getElementById('matchmaking-status').style.display = 'none';

                updateConnectionStatus('waiting', 'Enter a 4-digit code to create or join a room');
            } else {
                // Show AI difficulty selection
                difficultySelection.classList.add('show');

                // Hide room code input and disconnect
                roomCodeSection.classList.remove('show');

                // Leave public queue if searching
                if (isSearchingForMatch) {
                    leavePublicQueue();
                }

                if (roomRef && playerId) {
                    roomRef.child(playerId === 'player1' ? 'player1' : 'player2').set(false)
                        .catch((err) => console.error('Error leaving room:', err));
                    roomRef.off();
                    roomRef = null;
                }
                playerId = null;
                opponentReady = false;
                currentRoomCode = null;
                document.getElementById('connection-status').className = 'connection-status';
                updatePlayerIndicator();
                resetGameState();
            }
        }

        // Set AI difficulty
        window.setAIDifficulty = function(difficulty) {
            aiDifficulty = difficulty;
            localStorage.setItem('pathwayClash_aiDifficulty', difficulty);

            // Update button states
            document.getElementById('diff-easy').classList.toggle('active', difficulty === 'easy');
            document.getElementById('diff-medium').classList.toggle('active', difficulty === 'medium');
            document.getElementById('diff-hard').classList.toggle('active', difficulty === 'hard');
            document.getElementById('diff-god').classList.toggle('active', difficulty === 'god');

            // Log the change
            const diffNames = { easy: 'Easy', medium: 'Medium', hard: 'Hard', god: 'God Mode' };
            addLogEntry(`AI difficulty set to ${diffNames[difficulty]}`, 'info');

            // Update stats display (God Mode shows infinity)
            updatePlayerStatsDisplay();
        }

        // Initialize difficulty button state on load
        window.initDifficultyButtons = function() {
            const saved = localStorage.getItem('pathwayClash_aiDifficulty') || 'medium';
            aiDifficulty = saved;
            document.getElementById('diff-easy').classList.toggle('active', saved === 'easy');
            document.getElementById('diff-medium').classList.toggle('active', saved === 'medium');
            document.getElementById('diff-hard').classList.toggle('active', saved === 'hard');
            document.getElementById('diff-god').classList.toggle('active', saved === 'god');

            // Update stats display (God Mode shows infinity)
            updatePlayerStatsDisplay();
        }

        // ============================================
        // GAME TYPE SWITCHING (Pathways vs Outer Deities)
        // ============================================
        function updateSummonGuideButton() {
            const btn = document.getElementById('btn-summon-guide');
            if (btn) {
                btn.classList.toggle('visible', gameType === 'inner_vs_outer');
            }
        }

        function switchGameType(type) {
            if (type === gameType && type !== 'inner_vs_outer') return;

            // For Inner vs Outer mode, show selection dialog
            if (type === 'inner_vs_outer') {
                showInnerVsOuterSelection();
                return;
            }

            gameType = type;
            localStorage.setItem('pathwayClash_gameType', type);

            // Update toggle buttons
            document.getElementById('type-pathways').classList.toggle('active', type === 'pathways');
            document.getElementById('type-outer').classList.toggle('active', type === 'outer_deities');
            document.getElementById('type-inner-vs-outer').classList.toggle('active', type === 'inner_vs_outer');

            // Update summon guide button visibility
            updateSummonGuideButton();

            // Update pathway grid and table
            populatePathwayGrid();
            populatePathwayTable();

            // Clear card history (different card pool)
            cardHistory = [];
            opponentCardHistory = [];

            // Reset game state but don't auto-start - wait for New Game button
            resetGameState();
            // Show New Game button so player can start when ready
            document.getElementById('new-game-btn').classList.add('show');

            // Log the switch
            let modeName = 'Pathways';
            if (type === 'outer_deities') modeName = 'Outer Deities';
            else if (type === 'inner_vs_outer') modeName = 'Inner vs Outer';
            addLogEntry(`Switched to ${modeName} mode!`, 'info');
        }

        function showInnerVsOuterSelection() {
            // Create modal overlay
            const overlay = document.createElement('div');
            overlay.id = 'inner-vs-outer-modal';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.85);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
            `;

            overlay.innerHTML = `
                <div style="background: linear-gradient(135deg, #1a1a2e, #16213e); border: 2px solid #ffd700; border-radius: 15px; padding: 30px; max-width: 500px; text-align: center;">
                    <h2 style="color: #ffd700; margin-bottom: 20px;">Choose Your Side</h2>
                    <p style="color: #ccc; margin-bottom: 25px;">In Inner vs Outer mode, battle between the forces of the world!</p>

                    <div style="display: flex; gap: 20px; justify-content: center; flex-wrap: wrap;">
                        <button onclick="selectInnerVsOuterSide('pathways')" style="
                            background: linear-gradient(135deg, #2d5a2d, #1a3a1a);
                            border: 2px solid #4a4;
                            color: #fff;
                            padding: 20px 30px;
                            border-radius: 10px;
                            cursor: pointer;
                            font-size: 14px;
                            min-width: 180px;
                            transition: all 0.3s;
                        ">
                            <div style="font-size: 24px; margin-bottom: 10px;"></div>
                            <div style="font-weight: bold; color: #4f4;">Play as Pathways</div>
                            <div style="font-size: 11px; color: #aaa; margin-top: 8px;">Use 22 Pathways<br>Summon Above the Sequences</div>
                        </button>

                        <button onclick="selectInnerVsOuterSide('outer_deities')" style="
                            background: linear-gradient(135deg, #5a2d2d, #3a1a1a);
                            border: 2px solid #a44;
                            color: #fff;
                            padding: 20px 30px;
                            border-radius: 10px;
                            cursor: pointer;
                            font-size: 14px;
                            min-width: 180px;
                            transition: all 0.3s;
                        ">
                            <div style="font-size: 24px; margin-bottom: 10px;"></div>
                            <div style="font-weight: bold; color: #f44;">Play as Outer Deities</div>
                            <div style="font-size: 11px; color: #aaa; margin-top: 8px;">Use 10 Outer Deities<br>Face the Above the Sequences</div>
                        </button>
                    </div>

                    <button onclick="closeInnerVsOuterModal()" style="
                        margin-top: 20px;
                        background: transparent;
                        border: 1px solid #666;
                        color: #888;
                        padding: 8px 20px;
                        border-radius: 5px;
                        cursor: pointer;
                    ">Cancel</button>
                </div>
            `;

            document.body.appendChild(overlay);
        }

        function selectInnerVsOuterSide(side) {
            innerVsOuterPlayerSide = side;
            localStorage.setItem('pathwayClash_innerVsOuterSide', side);

            closeInnerVsOuterModal();

            gameType = 'inner_vs_outer';
            localStorage.setItem('pathwayClash_gameType', 'inner_vs_outer');

            // Update toggle buttons
            document.getElementById('type-pathways').classList.remove('active');
            document.getElementById('type-outer').classList.remove('active');
            document.getElementById('type-inner-vs-outer').classList.add('active');

            // Update summon guide button visibility
            updateSummonGuideButton();

            // Update pathway grid and table
            populatePathwayGrid();
            populatePathwayTable();

            // Clear card history (different card pool)
            cardHistory = [];
            opponentCardHistory = [];

            // Reset game state but don't auto-start - wait for New Game button
            resetGameState();
            // Show New Game button so player can start when ready
            document.getElementById('new-game-btn').classList.add('show');

            // Log the switch
            const sideName = side === 'pathways' ? 'Pathways (vs Outer Deities)' : 'Outer Deities (vs Pathways)';
            addLogEntry(`Playing as ${sideName}!`, 'info');
        }

        function closeInnerVsOuterModal() {
            const modal = document.getElementById('inner-vs-outer-modal');
            if (modal) modal.remove();
        }

        // Helper functions to get correct data based on game type
        function getCurrentPathways() {
            if (gameType === 'inner_vs_outer') {
                // Return based on player's chosen side
                return innerVsOuterPlayerSide === 'pathways' ? PATHWAYS : OUTER_DEITIES;
            }
            return gameType === 'outer_deities' ? OUTER_DEITIES : PATHWAYS;
        }

        function getOpponentPathways() {
            // For opponent in inner_vs_outer mode, return opposite of player's side
            if (gameType === 'inner_vs_outer') {
                return innerVsOuterPlayerSide === 'pathways' ? OUTER_DEITIES : PATHWAYS;
            }
            return gameType === 'outer_deities' ? OUTER_DEITIES : PATHWAYS;
        }

        function getCurrentMatchups() {
            // In inner_vs_outer mode, we use the cross-mode matchups (includes Inner Gods)
            if (gameType === 'inner_vs_outer') {
                // Merge pathway matchups with Inner God matchups
                return { ...PATHWAY_VS_OUTER_DEITY_MATCHUPS, ...INNER_GOD_VS_OUTER_DEITY_MATCHUPS };
            }
            return gameType === 'outer_deities' ? OUTER_DEITY_MATCHUPS : MATCHUPS;
        }

        function getCurrentSefirahGroups() {
            if (gameType === 'inner_vs_outer') {
                return innerVsOuterPlayerSide === 'pathways' ? SEFIRAH_GROUPS : OUTER_DEITY_SEFIRAH_GROUPS;
            }
            return gameType === 'outer_deities' ? OUTER_DEITY_SEFIRAH_GROUPS : SEFIRAH_GROUPS;
        }

        function getOpponentSefirahGroups() {
            if (gameType === 'inner_vs_outer') {
                return innerVsOuterPlayerSide === 'pathways' ? OUTER_DEITY_SEFIRAH_GROUPS : SEFIRAH_GROUPS;
            }
            return gameType === 'outer_deities' ? OUTER_DEITY_SEFIRAH_GROUPS : SEFIRAH_GROUPS;
        }

        function getCurrentPowerRatings() {
            if (gameType === 'inner_vs_outer') {
                return innerVsOuterPlayerSide === 'pathways' ? POWER_RATINGS : OUTER_DEITY_POWER_RATINGS;
            }
            return gameType === 'outer_deities' ? OUTER_DEITY_POWER_RATINGS : POWER_RATINGS;
        }

        function getOpponentPowerRatings() {
            if (gameType === 'inner_vs_outer') {
                return innerVsOuterPlayerSide === 'pathways' ? OUTER_DEITY_POWER_RATINGS : POWER_RATINGS;
            }
            return gameType === 'outer_deities' ? OUTER_DEITY_POWER_RATINGS : POWER_RATINGS;
        }

        function getCurrentBigHitList() {
            if (gameType === 'inner_vs_outer') {
                if (innerVsOuterPlayerSide === 'pathways') {
                    // Include all Inner Gods as "big hits" for rainbow display
                    const innerGodNames = INNER_GODS.map(g => g.name);
                    return [...BIG_HIT_LIST, ...innerGodNames];
                } else {
                    return OUTER_DEITY_BIG_HIT_LIST;
                }
            }
            return gameType === 'outer_deities' ? OUTER_DEITY_BIG_HIT_LIST : BIG_HIT_LIST;
        }

        function getOpponentBigHitList() {
            if (gameType === 'inner_vs_outer') {
                if (innerVsOuterPlayerSide === 'pathways') {
                    return OUTER_DEITY_BIG_HIT_LIST;
                } else {
                    const innerGodNames = INNER_GODS.map(g => g.name);
                    return [...BIG_HIT_LIST, ...innerGodNames];
                }
            }
            return gameType === 'outer_deities' ? OUTER_DEITY_BIG_HIT_LIST : BIG_HIT_LIST;
        }

        function getCurrentMediumHitList() {
            if (gameType === 'inner_vs_outer') {
                return innerVsOuterPlayerSide === 'pathways' ? MEDIUM_HIT_LIST : OUTER_DEITY_MEDIUM_HIT_LIST;
            }
            return gameType === 'outer_deities' ? OUTER_DEITY_MEDIUM_HIT_LIST : MEDIUM_HIT_LIST;
        }

        function getOpponentMediumHitList() {
            if (gameType === 'inner_vs_outer') {
                return innerVsOuterPlayerSide === 'pathways' ? OUTER_DEITY_MEDIUM_HIT_LIST : MEDIUM_HIT_LIST;
            }
            return gameType === 'outer_deities' ? OUTER_DEITY_MEDIUM_HIT_LIST : MEDIUM_HIT_LIST;
        }

        function getCurrentLowTierList() {
            if (gameType === 'inner_vs_outer') {
                return innerVsOuterPlayerSide === 'pathways' ? LOW_TIER_LIST : OUTER_DEITY_LOW_TIER_LIST;
            }
            return gameType === 'outer_deities' ? OUTER_DEITY_LOW_TIER_LIST : LOW_TIER_LIST;
        }

        function getOpponentLowTierList() {
            if (gameType === 'inner_vs_outer') {
                return innerVsOuterPlayerSide === 'pathways' ? OUTER_DEITY_LOW_TIER_LIST : LOW_TIER_LIST;
            }
            return gameType === 'outer_deities' ? OUTER_DEITY_LOW_TIER_LIST : LOW_TIER_LIST;
        }

        // ============================================
        // INITIALIZATION
        // ============================================

        // Always start in Pathways mode - ensure toggle buttons reflect this
        gameType = 'pathways';
        document.getElementById('type-pathways').classList.add('active');
        document.getElementById('type-outer').classList.remove('active');
        document.getElementById('type-inner-vs-outer').classList.remove('active');

        document.getElementById('play-btn').onclick = playTurn;
        document.getElementById('new-game-btn').onclick = newGame;

        // Room code Enter key support
        document.getElementById('room-code-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                joinRoom();
            }
        });

        // Only allow numbers in room code
        document.getElementById('room-code-input').addEventListener('input', (e) => {
            e.target.value = e.target.value.replace(/[^0-9]/g, '');
        });

        window.addEventListener('beforeunload', () => {
            // Clean up Firebase listeners to prevent memory leaks
            if (roomRef) {
                if (playerId) {
                    roomRef.child(playerId === 'player1' ? 'player1' : 'player2').set(false);
                }
                roomRef.off(); // Remove all listeners
            }
            if (queueRef && queueListener) {
                queueRef.off('value', queueListener);
            }
        });

        // Function to populate pathway reference grid
        function populatePathwayGrid() {
            const pathwayGrid = DOM.get('pathway-grid');
            const gridTitle = DOM.get('pathway-grid-title');
            pathwayGrid.innerHTML = ''; // Clear existing items

            const currentPathways = getCurrentPathways();
            const currentBigHits = getCurrentBigHitList();

            // Update title based on game type
            const count = currentPathways.length;
            let label;
            if (gameType === 'outer_deities') {
                label = 'Outer Deities';
            } else if (gameType === 'inner_vs_outer') {
                if (innerVsOuterPlayerSide === 'pathways') {
                    label = 'Pathways (vs Outer Deities)';
                } else {
                    label = 'Outer Deities (vs Pathways)';
                }
            } else {
                label = 'Pathways';
            }
            gridTitle.textContent = `All ${count} ${label}`;

            // Adjust grid columns based on count
            if (gameType === 'outer_deities' || (gameType === 'inner_vs_outer' && innerVsOuterPlayerSide === 'outer_deities')) {
                pathwayGrid.style.gridTemplateColumns = 'repeat(2, 1fr)';
            } else {
                pathwayGrid.style.gridTemplateColumns = 'repeat(3, 1fr)';
            }

            const sortedPathways = [...currentPathways].sort((a, b) => {
                const aIsBigHit = currentBigHits.includes(a.name);
                const bIsBigHit = currentBigHits.includes(b.name);
                if (aIsBigHit && !bIsBigHit) return -1;
                if (!aIsBigHit && bIsBigHit) return 1;
                return 0;
            });

            sortedPathways.forEach(pathway => {
                const item = document.createElement('div');
                const isBigHit = currentBigHits.includes(pathway.name);
                item.className = 'pathway-item' + (isBigHit ? ' big-hit' : '');
                item.title = pathway.flavor;
                item.style.cursor = 'pointer';
                item.innerHTML = `
                    <img src="${pathway.icon}" alt="${pathway.name}">
                    <span>${pathway.name}</span>
                `;
                item.onclick = () => showPathwayDetail(pathway.name);
                pathwayGrid.appendChild(item);
            });
        }

        // Initial population of pathway grid
        populatePathwayGrid();
        updateSummonGuideButton();

        resetGameState();
        updateAchievementDisplay();

        // Initialize tutorial menu button visibility
        updateTutorialMenuButton();

        function wipeDatabase() {
            if (confirm('WARNING: This will delete ALL player data and reset the counter to 0. Are you sure?')) {
                const db = ensureFirebaseInitialized();
                db.ref('playerCounter').set(0);
                db.ref('players').remove()
                .then(() => alert('Database Wiped. Next player will be 0001.'))
                .catch(e => alert('Error: ' + e.message));
            }
        }

        // ============================================
        // TUTORIAL MODE FUNCTIONS
        // ============================================

        function shouldShowTutorial() {
            // GMs automatically opt out of tutorial
            if (playerCode && playerCode.startsWith('GM')) {
                return false;
            }
            // Check if this is a new player who hasn't seen the tutorial prompt
            const hasViewed = localStorage.getItem('pathwayClash_tutorialViewed');
            const isComplete = localStorage.getItem('pathwayClash_tutorialComplete') === 'true';
            return !hasViewed && !isComplete;
        }

        function showTutorialPrompt() {
            document.getElementById('tutorial-prompt').classList.remove('hidden');
        }

        function hideTutorialPrompt() {
            document.getElementById('tutorial-prompt').classList.add('hidden');
        }

        function startTutorialFromPrompt() {
            hideTutorialPrompt();
            localStorage.setItem('pathwayClash_tutorialViewed', 'started');
            tutorialRewardsEligible = true;
            initTutorial(true);
        }

        function skipTutorialFromPrompt() {
            hideTutorialPrompt();
            localStorage.setItem('pathwayClash_tutorialViewed', 'skipped');
            tutorialRewardsEligible = false;
            // Show intro screen instead
            DOM.get('intro-screen').classList.remove('hidden');
        }

        function initTutorial(isNewPlayer) {
            tutorialMode = true;
            tutorialRewardsEligible = isNewPlayer;

            // Load saved progress or start from beginning
            const savedChapter = parseInt(localStorage.getItem('pathwayClash_tutorialChapter'));
            const savedStep = parseInt(localStorage.getItem('pathwayClash_tutorialStep'));

            if (savedChapter && savedChapter > 1) {
                tutorialChapter = savedChapter;
                tutorialStep = savedStep || 0;
            } else {
                tutorialChapter = 1;
                tutorialStep = 0;
            }

            // Reset test states if not resuming chapter 6
            if (tutorialChapter !== 6) {
                tutorialBeatEasy = false;
                tutorialBeatMedium = false;
            }

            // Hide intro screen if visible
            DOM.get('intro-screen').classList.add('hidden');

            // Show tutorial overlay
            document.getElementById('tutorial-overlay').classList.remove('hidden');
            document.getElementById('tutorial-overlay').classList.add('active');

            // Update progress dots
            updateTutorialProgress();

            // Setup clickable dot navigation
            setupTutorialDotNavigation();

            // Show tutorial menu button
            updateTutorialMenuButton();

            // Ensure we're in AI mode for tutorial
            gameMode = 'ai';
            aiDifficulty = 'easy';

            // Start the game (hidden behind tutorial)
            DOM.get('game-container').classList.remove('hidden');
            startGame();

            // Actually begin gameplay (draw hands, etc.)
            beginGame();

            // Load current chapter
            loadTutorialChapter(tutorialChapter);
        }

        function loadTutorialChapter(chapter) {
            tutorialChapter = chapter;
            tutorialStep = 0;
            saveTutorialProgress();

            const chapterData = TUTORIAL_CHAPTERS[chapter];
            if (!chapterData) {
                completeTutorial();
                return;
            }

            // Show chapter title briefly
            const titleEl = document.getElementById('tutorial-chapter-title');
            titleEl.textContent = `Chapter ${chapter}: ${chapterData.title}`;
            titleEl.classList.add('visible');

            setTimeout(() => {
                titleEl.classList.remove('visible');
            }, 2000);

            // Update progress dots
            updateTutorialProgress();

            // Move progress dots to side during chapters 5 & 6 to avoid blocking mode buttons at top
            const progressEl = document.getElementById('tutorial-progress');
            if (chapter === 5 || chapter === 6) {
                progressEl.classList.add('side-position');
            } else {
                progressEl.classList.remove('side-position');
            }

            // Start first step after title fades
            setTimeout(() => {
                showTutorialStep();
            }, 1500);
        }

        function showTutorialStep() {
            const chapterData = TUTORIAL_CHAPTERS[tutorialChapter];
            if (!chapterData || tutorialStep >= chapterData.steps.length) {
                completeTutorialChapter();
                return;
            }

            const step = chapterData.steps[tutorialStep];
            currentTutorialStep = step; // Store for scroll listener

            // Clear previous highlights
            clearTutorialHighlights();

            // Always hide connector line first - will be shown again if needed for 'right' position
            const connectorSvg = document.getElementById('tutorial-connector-line');
            if (connectorSvg) {
                connectorSvg.classList.add('hidden');
                connectorSvg.style.display = 'none';
            }

            // Set up highlight if specified
            if (step.highlight) {
                highlightElement(step.highlight);
            }

            // Special handling: If step needs ability phase, trigger it
            if (step.waitForEvent === 'abilityUsed' && step.highlight === '#ability-phase-section') {
                showAbilityPhase();
            }

            // Lock UI if specified
            if (step.lockUI) {
                lockUIExcept(step.allowedElements || []);
            } else {
                unlockTutorialUI();
            }

            // Show instruction box
            const instructionBox = document.getElementById('tutorial-instruction-box');
            const titleEl = document.getElementById('tutorial-instruction-title');
            const textEl = document.getElementById('tutorial-instruction-text');
            const continueBtn = document.getElementById('tutorial-continue-btn');

            titleEl.innerHTML = step.title;
            textEl.innerHTML = step.text;

            // Position the box - reset any inline styles first
            instructionBox.className = 'tutorial-instruction-box position-' + (step.position || 'center');
            instructionBox.style.top = '';
            instructionBox.style.bottom = '';
            instructionBox.style.left = '';
            instructionBox.style.right = '';
            instructionBox.style.transform = '';

            // Dynamic positioning for certain positions - place box relative to highlighted element
            if (step.highlight && (step.position === 'above-battle-log' || step.position === 'left-sidebar' || step.position === 'bottom' || step.position === 'right' || step.position === 'top')) {
                const highlightedEl = document.querySelector(step.highlight);
                if (highlightedEl) {
                    const rect = highlightedEl.getBoundingClientRect();
                    const boxWidth = 400; // max-width of instruction box
                    const boxHeight = 180; // approximate height of instruction box

                    // Reset transform when using dynamic positioning (inline styles)
                    instructionBox.style.transform = 'none';

                    if (step.position === 'above-battle-log') {
                        // Position directly above the highlighted element, centered (raised so arrow is outside)
                        instructionBox.style.top = Math.max(80, rect.top - boxHeight - 80) + 'px';
                        instructionBox.style.left = Math.max(10, rect.left + rect.width/2 - boxWidth/2) + 'px';
                        instructionBox.style.right = 'auto';
                    } else if (step.position === 'left-sidebar') {
                        // Position to the right of left sidebar elements, with gap for arrow
                        instructionBox.style.top = (rect.top + 40) + 'px';
                        instructionBox.style.left = (rect.right + 50) + 'px';
                        instructionBox.style.right = 'auto';
                    } else if (step.position === 'bottom') {
                        // Position centered on screen horizontally, above the highlighted element
                        const boxLeft = (window.innerWidth - boxWidth) / 2;
                        instructionBox.style.top = Math.max(80, rect.top - boxHeight - 80) + 'px';
                        instructionBox.style.left = boxLeft + 'px';
                        instructionBox.style.right = 'auto';
                    } else if (step.position === 'right') {
                        // Position in center of screen with diagonal connector to element on right
                        const boxTop = Math.max(80, rect.top + 20);
                        const boxLeft = (window.innerWidth - boxWidth) / 2; // Center horizontally
                        instructionBox.style.top = boxTop + 'px';
                        instructionBox.style.left = boxLeft + 'px';
                        instructionBox.style.right = 'auto';

                        // Show and position the diagonal connector line
                        const connectorSvg = document.getElementById('tutorial-connector-line');
                        const connectorLine = document.getElementById('tutorial-connector');
                        if (connectorSvg && connectorLine) {
                            connectorSvg.classList.remove('hidden');
                            connectorSvg.style.display = 'block';
                            // Line starts from right side of tutorial box, ends at left side of highlighted element
                            const startX = boxLeft + boxWidth + 10;
                            const startY = boxTop + 60;
                            const endX = rect.left - 10;
                            const endY = rect.top + rect.height / 2;
                            connectorLine.setAttribute('x1', startX);
                            connectorLine.setAttribute('y1', startY);
                            connectorLine.setAttribute('x2', endX);
                            connectorLine.setAttribute('y2', endY);
                        }
                    } else if (step.position === 'top') {
                        // Element is at top of screen - position box well below it, arrow points up
                        const boxLeft = (window.innerWidth - boxWidth) / 2; // Center horizontally
                        const boxTop = rect.bottom + 120; // Position below the element with larger gap
                        instructionBox.style.top = boxTop + 'px';
                        instructionBox.style.left = boxLeft + 'px';
                        instructionBox.style.right = 'auto';
                        // Arrow pointing up is handled by CSS class
                    }
                }
            }

            instructionBox.classList.remove('hidden');

            // Reset continue button display (may have been hidden during battle)
            continueBtn.style.display = 'block';

            // Handle waiting for events
            if (step.waitForEvent) {
                tutorialWaitingForEvent = step.waitForEvent;
                continueBtn.disabled = true;
                continueBtn.textContent = 'Waiting...';

                // Special case: final test
                if (step.waitForEvent === 'showFinalTest') {
                    setTimeout(() => {
                        showTutorialFinalTest();
                    }, 500);
                }
            } else {
                tutorialWaitingForEvent = null;
                continueBtn.disabled = false;
                continueBtn.textContent = 'Continue';
            }

            // Show/hide exit review button (allows leaving review at any time)
            const exitReviewBtn = document.getElementById('tutorial-exit-review-btn');
            if (exitReviewBtn) {
                if (tutorialReviewMode) {
                    exitReviewBtn.classList.remove('hidden');
                } else {
                    exitReviewBtn.classList.add('hidden');
                }
            }
        }

        // Update tutorial box position on scroll
        let currentTutorialStep = null;
        function updateTutorialPosition() {
            if (!tutorialMode || !currentTutorialStep || !currentTutorialStep.highlight) return;

            const step = currentTutorialStep;
            const instructionBox = document.getElementById('tutorial-instruction-box');
            const highlightedEl = document.querySelector(step.highlight);

            if (!highlightedEl || !instructionBox) return;

            const rect = highlightedEl.getBoundingClientRect();
            const boxWidth = 400;
            const boxHeight = 180;

            if (step.position === 'above-battle-log' || step.position === 'bottom') {
                const boxLeft = (window.innerWidth - boxWidth) / 2;
                instructionBox.style.top = Math.max(80, rect.top - boxHeight - 80) + 'px';
                instructionBox.style.left = boxLeft + 'px';
            } else if (step.position === 'left-sidebar') {
                instructionBox.style.top = (rect.top + 40) + 'px';
                instructionBox.style.left = (rect.right + 50) + 'px';
            } else if (step.position === 'right') {
                const boxTop = Math.max(80, rect.top + 20);
                const boxLeft = (window.innerWidth - boxWidth) / 2; // Center horizontally
                instructionBox.style.top = boxTop + 'px';
                instructionBox.style.left = boxLeft + 'px';

                // Update connector line
                const connectorLine = document.getElementById('tutorial-connector');
                if (connectorLine) {
                    const startX = boxLeft + boxWidth + 10;
                    const startY = boxTop + 60;
                    const endX = rect.left - 10;
                    const endY = rect.top + rect.height / 2;
                    connectorLine.setAttribute('x1', startX);
                    connectorLine.setAttribute('y1', startY);
                    connectorLine.setAttribute('x2', endX);
                    connectorLine.setAttribute('y2', endY);
                }
            } else if (step.position === 'top') {
                // Element is at top - box below it with arrow pointing up
                const boxLeft = (window.innerWidth - boxWidth) / 2;
                const boxTop = rect.bottom + 120;
                instructionBox.style.top = boxTop + 'px';
                instructionBox.style.left = boxLeft + 'px';
            }
        }

        window.addEventListener('scroll', updateTutorialPosition);

        let lastTutorialAdvance = 0;
        function advanceTutorialStep() {
            if (tutorialWaitingForEvent) return;

            // Debounce - prevent advancing more than once per second
            const now = Date.now();
            if (now - lastTutorialAdvance < 1000) return;
            lastTutorialAdvance = now;

            tutorialStep++;
            saveTutorialProgress();
            showTutorialStep();
        }

        function handleTutorialEvent(eventName) {
            if (!tutorialMode || tutorialWaitingForEvent !== eventName) return;

            // Enable continue button
            const continueBtn = document.getElementById('tutorial-continue-btn');
            continueBtn.disabled = false;
            continueBtn.textContent = 'Continue';
            tutorialWaitingForEvent = null;

            // Hide tutorial box while ability modals might be open
            // User will click Continue after dealing with any ability effects
            if (eventName === 'cardPlayed') {
                // Hide the tutorial instruction box temporarily
                const instructionBox = document.getElementById('tutorial-instruction-box');
                instructionBox.classList.add('hidden');

                // Show it again after a delay (after ability modals should be done)
                // But don't auto-advance - let user click Continue
                setTimeout(() => {
                    instructionBox.classList.remove('hidden');
                }, 3000);
            }
        }

        function completeTutorialChapter() {
            clearTutorialHighlights();
            unlockTutorialUI();

            // Hide instruction box
            document.getElementById('tutorial-instruction-box').classList.add('hidden');

            // Handle review mode differently
            if (tutorialReviewMode) {
                // Hide tutorial overlay
                document.getElementById('tutorial-overlay').classList.remove('active');
                document.getElementById('tutorial-overlay').classList.add('hidden');
                document.body.classList.remove('tutorial-active');

                const chapterData = TUTORIAL_CHAPTERS[tutorialChapter];
                showNotification(`Finished reviewing: ${chapterData.title}`, 'success');

                // Show chapter select again so they can pick another
                setTimeout(() => {
                    showTutorialChapterSelect();
                }, 500);
                return;
            }

            // Check if this is the final chapter
            if (tutorialChapter >= 6) {
                // Show final test modal
                showTutorialFinalTest();
                return;
            }

            // Show chapter complete modal
            const modal = document.getElementById('tutorial-chapter-modal');
            const icon = document.getElementById('tutorial-chapter-icon');
            const title = document.getElementById('tutorial-chapter-modal-title');
            const text = document.getElementById('tutorial-chapter-modal-text');

            const chapterData = TUTORIAL_CHAPTERS[tutorialChapter];
            icon.textContent = '';
            title.textContent = `Chapter ${tutorialChapter} Complete!`;
            text.textContent = `You've learned about ${chapterData.title}. Ready for the next chapter?`;

            modal.classList.remove('hidden');
            modal.classList.add('visible');
        }

        function continueToNextChapter() {
            // Hide chapter complete modal
            const modal = document.getElementById('tutorial-chapter-modal');
            modal.classList.remove('visible');
            modal.classList.add('hidden');

            // Move to next chapter
            tutorialChapter++;
            loadTutorialChapter(tutorialChapter);
        }

        function showTutorialFinalTest() {
            // Show tutorial overlay again (was hidden during battle)
            const overlay = document.getElementById('tutorial-overlay');
            overlay.classList.remove('hidden');
            overlay.classList.add('active');
            overlay.style.display = ''; // Remove inline display:none if set

            // Add tutorial-active class back to body
            document.body.classList.add('tutorial-active');

            // Hide instruction box
            document.getElementById('tutorial-instruction-box').classList.add('hidden');
            clearTutorialHighlights();
            unlockTutorialUI();

            // Update test modal based on progress
            const modal = document.getElementById('tutorial-final-test-modal');
            const titleEl = document.getElementById('tutorial-test-title');
            const textEl = document.getElementById('tutorial-test-text');
            const easyBtn = document.getElementById('tutorial-btn-easy');
            const mediumBtn = document.getElementById('tutorial-btn-medium');
            const hardBtn = document.getElementById('tutorial-btn-hard');
            const godBtn = document.getElementById('tutorial-btn-god');
            const finishBtn = document.getElementById('tutorial-btn-finish');

            if (tutorialBeatMedium) {
                titleEl.textContent = ' Tutorial Complete!';
                textEl.innerHTML = `
                    <div style="text-align: left; margin-bottom: 15px;">
                        <strong>You did it!</strong> You've beaten Easy and Medium AI.
                    </div>
                    <div style="background: rgba(255,215,0,0.1); border: 1px solid rgba(255,215,0,0.3); border-radius: 8px; padding: 10px; margin-bottom: 10px; text-align: left;">
                        <strong style="color: var(--color-gold);"> Want more challenge?</strong><br>
                        <span style="font-size: 12px;">Try <strong>Hard</strong> or <strong>God</strong> mode for <strong>bonus rewards</strong>! You can play as many times as you want before finishing.</span>
                    </div>
                    <div style="background: rgba(74,138,74,0.1); border: 1px solid rgba(74,138,74,0.3); border-radius: 8px; padding: 10px; text-align: left;">
                        <strong style="color: var(--color-success);"> Ready to finish?</strong><br>
                        <span style="font-size: 12px;">Click the green button below to <strong>end the tutorial</strong>, claim your rewards, and start playing normally!</span>
                    </div>
                `;
                easyBtn.classList.add('completed');
                mediumBtn.classList.add('completed');
                finishBtn.classList.remove('hidden'); // Show finish button
                document.getElementById('tutorial-btn-exit').classList.add('hidden'); // Hide exit without rewards
            } else if (tutorialBeatEasy) {
                titleEl.textContent = 'One More Challenge!';
                textEl.innerHTML = 'Great job beating Easy AI! Now defeat the <strong>Medium AI</strong> to complete the tutorial.';
                easyBtn.classList.add('completed');
                mediumBtn.disabled = false;
                mediumBtn.classList.add('required');
                finishBtn.classList.add('hidden'); // Hide finish button
                document.getElementById('tutorial-btn-exit').classList.remove('hidden'); // Show exit option
            } else {
                titleEl.textContent = 'Final Test';
                textEl.innerHTML = 'Put your skills to the test! Beat the <strong>Easy AI</strong> to prove you\'re ready.';
                finishBtn.classList.add('hidden'); // Hide finish button
                document.getElementById('tutorial-btn-exit').classList.remove('hidden'); // Show exit option
            }

            modal.classList.remove('hidden');
            modal.classList.add('visible');
        }

        function startTutorialTest(difficulty) {
            // Hide the modal
            const modal = document.getElementById('tutorial-final-test-modal');
            modal.classList.remove('visible');
            modal.classList.add('hidden');

            // Set difficulty and start game
            aiDifficulty = difficulty;
            localStorage.setItem('pathwayClash_aiDifficulty', difficulty);

            // FIRST: Unlock UI and clear all tutorial restrictions BEFORE starting game
            unlockTutorialUI();
            clearTutorialHighlights();

            // Explicitly remove tutorial-ui-locked class (belt and suspenders)
            const gameContainer = document.getElementById('game-container');
            gameContainer.classList.remove('tutorial-ui-locked');

            // Remove tutorial-active from body and main-layout
            document.body.classList.remove('tutorial-active');
            const mainLayout = document.querySelector('.main-layout');
            if (mainLayout) mainLayout.classList.remove('tutorial-active');

            // Hide tutorial UI completely during the battle
            const overlay = document.getElementById('tutorial-overlay');
            overlay.classList.add('hidden');
            overlay.classList.remove('active');
            overlay.style.display = 'none'; // Extra safety

            const instructionBox = document.getElementById('tutorial-instruction-box');
            instructionBox.classList.add('hidden');

            // Hide connector line if visible
            const connectorSvg = document.getElementById('tutorial-connector-line');
            if (connectorSvg) {
                connectorSvg.classList.add('hidden');
                connectorSvg.style.display = 'none';
            }

            // Reset and start a fresh game AFTER unlocking
            resetGameState();
            startGame();

            // Start a new game immediately (deal cards)
            newGame();

            tutorialWaitingForEvent = 'gameWon';
        }

        function handleTutorialVictory(playerWon) {
            if (!tutorialMode || tutorialChapter !== 6) return;

            if (!playerWon) {
                // Player lost - show retry button instead of auto-popup
                showTutorialContinueButton('Try Again', showTutorialFinalTest);
                return;
            }

            // Player won! Update state but don't auto-show popup
            if (aiDifficulty === 'easy' && !tutorialBeatEasy) {
                tutorialBeatEasy = true;
                localStorage.setItem('pathwayClash_tutorialBeatEasy', 'true');
                showTutorialContinueButton('Continue Tutorial', showTutorialFinalTest);
            } else if (aiDifficulty === 'medium' && !tutorialBeatMedium) {
                tutorialBeatMedium = true;
                localStorage.setItem('pathwayClash_tutorialBeatMedium', 'true');
                showTutorialContinueButton('Continue Tutorial', showTutorialFinalTest);
            } else if ((aiDifficulty === 'hard' || aiDifficulty === 'god') && !tutorialSecretBonus) {
                // Secret bonus! Don't tell them about it
                tutorialSecretBonus = true;
                if (tutorialBeatMedium) {
                    showTutorialContinueButton('Finish Tutorial', completeTutorial);
                } else {
                    showTutorialContinueButton('Continue Tutorial', showTutorialFinalTest);
                }
            } else {
                // Already completed this difficulty, show button to continue
                showTutorialContinueButton('Continue Tutorial', showTutorialFinalTest);
            }
        }

        // Show a floating button to continue tutorial (allows reviewing battle log first)
        function showTutorialContinueButton(buttonText, callback) {
            // Remove any existing continue button
            const existing = document.getElementById('tutorial-continue-floating-btn');
            if (existing) existing.remove();

            // Create floating button
            const btn = document.createElement('button');
            btn.id = 'tutorial-continue-floating-btn';
            btn.innerHTML = ` ${buttonText}`;
            btn.style.cssText = `
                position: fixed;
                bottom: 20px;
                left: 50%;
                transform: translateX(-50%);
                padding: 12px 24px;
                background: var(--color-gold);
                color: #000;
                border: none;
                border-radius: 8px;
                font-size: 16px;
                font-weight: bold;
                cursor: pointer;
                z-index: 10000;
                box-shadow: 0 4px 20px rgba(255, 215, 0, 0.4);
                animation: pulse 2s infinite;
            `;
            btn.onclick = () => {
                btn.remove();
                callback();
            };

            document.body.appendChild(btn);

            // Also show a notification
            showNotification('Take your time! Click the button below when ready.', 'info');
        }

        function completeTutorial() {
            tutorialMode = false;
            tutorialCompleted = true;

            // Hide tutorial overlay
            document.getElementById('tutorial-overlay').classList.remove('active');
            document.getElementById('tutorial-overlay').classList.add('hidden');

            // Hide final test modal
            document.getElementById('tutorial-final-test-modal').classList.remove('visible');
            document.getElementById('tutorial-final-test-modal').classList.add('hidden');

            // Calculate and award rewards
            const rewards = calculateTutorialRewards();

            // Update localStorage
            localStorage.setItem('pathwayClash_tutorialComplete', 'true');
            localStorage.setItem('pathwayClash_tutorialDone', 'true');
            localStorage.removeItem('pathwayClash_tutorialChapter');
            localStorage.removeItem('pathwayClash_tutorialStep');

            // Save to Firebase if player has code
            saveTutorialToFirebase(rewards);

            // Show completion modal
            const modal = document.getElementById('tutorial-complete-modal');
            const textEl = document.getElementById('tutorial-complete-text');
            const rewardAmount = document.getElementById('tutorial-reward-amount');
            const rewardsDiv = document.getElementById('tutorial-rewards');

            if (tutorialRewardsEligible && rewards.coins > 0) {
                textEl.textContent = 'Congratulations! You\'ve mastered all the basics of Pathway Clash.';
                rewardAmount.textContent = `+${rewards.coins} Coins${rewards.secretBonus ? ' (includes secret bonus!)' : ''}`;
                rewardsDiv.style.display = 'block';
            } else {
                textEl.textContent = 'You\'ve completed the tutorial! Good luck in your battles.';
                rewardsDiv.style.display = 'none';
            }

            modal.classList.remove('hidden');
            modal.classList.add('visible');

            // Update menu button
            updateTutorialMenuButton();
        }

        function calculateTutorialRewards() {
            if (!tutorialRewardsEligible) {
                return { coins: 0, secretBonus: false };
            }

            let coins = 100; // Base reward
            if (tutorialSecretBonus) {
                coins += 50; // Secret bonus for beating Hard/God
            }

            return { coins, secretBonus: tutorialSecretBonus };
        }

        function finishTutorial() {
            // Hide completion modal
            const modal = document.getElementById('tutorial-complete-modal');
            modal.classList.remove('visible');
            modal.classList.add('hidden');

            // Reset game state for normal play
            aiDifficulty = 'medium';
            localStorage.setItem('pathwayClash_aiDifficulty', 'medium');
            resetGameState();

            // Show new game button
            document.getElementById('new-game-btn').classList.add('show');
        }

        function showTutorialSkipWarning() {
            document.getElementById('tutorial-skip-modal').classList.remove('hidden');
            document.getElementById('tutorial-skip-modal').classList.add('visible');
        }

        function hideTutorialSkipWarning() {
            document.getElementById('tutorial-skip-modal').classList.remove('visible');
            document.getElementById('tutorial-skip-modal').classList.add('hidden');
        }

        function confirmSkipTutorial() {
            hideTutorialSkipWarning();

            // Mark as skipped
            tutorialMode = false;
            localStorage.setItem('pathwayClash_tutorialViewed', 'skipped');
            localStorage.setItem('pathwayClash_tutorialComplete', 'skipped');

            // Save to Firebase
            if (playerCode && playerDb) {
                playerDb.ref('players/' + playerCode + '/tutorial').update({
                    skipped: true,
                    skippedAt: firebase.database.ServerValue.TIMESTAMP
                });
            }

            // Hide overlay
            document.getElementById('tutorial-overlay').classList.remove('active');
            document.getElementById('tutorial-overlay').classList.add('hidden');

            clearTutorialHighlights();
            unlockTutorialUI();

            // Update menu button
            updateTutorialMenuButton();

            // Reset to normal game
            resetGameState();
            document.getElementById('new-game-btn').classList.add('show');
        }

        function exitTutorialEarly() {
            // Like skip but from final test
            confirmSkipTutorial();
        }

        function saveTutorialProgress() {
            localStorage.setItem('pathwayClash_tutorialChapter', tutorialChapter);
            localStorage.setItem('pathwayClash_tutorialStep', tutorialStep);

            // Also save to Firebase if available
            if (playerCode && playerDb) {
                playerDb.ref('players/' + playerCode + '/tutorial').update({
                    chapter: tutorialChapter,
                    step: tutorialStep,
                    lastUpdated: firebase.database.ServerValue.TIMESTAMP
                });
            }
        }

        function saveTutorialToFirebase(rewards) {
            if (!playerCode || !playerDb) return;

            playerDb.ref('players/' + playerCode + '/tutorial').set({
                completed: true,
                completedAt: firebase.database.ServerValue.TIMESTAMP,
                skipped: false,
                secretBonus: rewards.secretBonus,
                rewardsAwarded: {
                    coins: rewards.coins
                }
            });

            // Also update player's coin balance if we had a currency system
            // For now just log it
            console.log('Tutorial rewards awarded:', rewards);
        }

        function updateTutorialProgress() {
            const dots = document.querySelectorAll('.tutorial-progress-dot');
            dots.forEach((dot, index) => {
                const chapter = index + 1;
                dot.classList.remove('completed', 'active', 'locked');

                if (chapter < tutorialChapter) {
                    dot.classList.add('completed');
                } else if (chapter === tutorialChapter) {
                    dot.classList.add('active');
                } else {
                    dot.classList.add('locked');
                }
            });
        }

        function setupTutorialDotNavigation() {
            const dots = document.querySelectorAll('.tutorial-progress-dot');
            dots.forEach((dot, index) => {
                // Skip if already set up
                if (dot.dataset.navSetup) return;
                dot.dataset.navSetup = 'true';

                const chapter = index + 1;
                dot.addEventListener('click', (e) => {
                    e.stopPropagation(); // Prevent event bubbling
                    navigateToTutorialChapter(chapter);
                });
            });
        }

        function navigateToTutorialChapter(chapter) {
            // Allow going back to any previous or current chapter
            if (chapter > tutorialChapter) {
                // Can't skip ahead to chapters not yet reached
                showNotification('Complete the current chapter first!', 'info');
                return;
            }

            // Unlock UI first to reset any locks
            unlockTutorialUI();

            // Clear any highlights
            clearTutorialHighlights();

            // Hide any current tutorial elements
            const instructionBox = document.getElementById('tutorial-instruction-box');
            if (instructionBox) instructionBox.classList.add('hidden');

            const chapterModal = document.getElementById('tutorial-chapter-modal');
            if (chapterModal) chapterModal.classList.add('hidden');

            // Load the selected chapter
            loadTutorialChapter(chapter);
            showNotification(`Returning to Chapter ${chapter}`, 'info');
        }

        function updateTutorialMenuButton() {
            const btn = document.getElementById('btn-tutorial-menu');

            // GMs don't see tutorial button
            if (playerCode && playerCode.startsWith('GM')) {
                btn.classList.remove('visible');
                return;
            }

            const isComplete = localStorage.getItem('pathwayClash_tutorialComplete') === 'true';
            const wasSkipped = localStorage.getItem('pathwayClash_tutorialComplete') === 'skipped';

            // Show button if tutorial was completed, skipped, or not in tutorial mode
            if (isComplete || wasSkipped || !tutorialMode) {
                btn.classList.add('visible');
                // Change text for completed players
                if (isComplete) {
                    btn.textContent = ' Review Tutorial';
                } else {
                    btn.textContent = ' Tutorial';
                }
            } else {
                btn.classList.remove('visible');
            }
        }

        function openTutorialFromMenu() {
            const isComplete = localStorage.getItem('pathwayClash_tutorialComplete') === 'true';

            if (isComplete) {
                // Completed players get chapter select
                showTutorialChapterSelect();
            } else {
                // Non-completed players start from beginning
                tutorialRewardsEligible = false;
                initTutorial(false);
            }
        }

        function showTutorialChapterSelect() {
            const modal = document.getElementById('tutorial-chapter-select-modal');
            const list = document.getElementById('tutorial-chapter-list');

            // Build chapter list (all 6 chapters)
            list.innerHTML = '';
            for (let i = 1; i <= 6; i++) {
                const chapter = TUTORIAL_CHAPTERS[i];
                if (!chapter) continue;

                const btn = document.createElement('button');
                btn.className = 'tutorial-chapter-btn';
                btn.onclick = () => startTutorialChapterReview(i);
                btn.innerHTML = `
                    <span class="chapter-num">${i}</span>
                    <div class="chapter-info">
                        <div class="chapter-title">${chapter.title}</div>
                        <div class="chapter-steps">${chapter.steps.length} steps</div>
                    </div>
                `;
                list.appendChild(btn);
            }

            modal.classList.remove('hidden');
            modal.classList.add('visible');
        }

        function closeTutorialChapterSelect() {
            const modal = document.getElementById('tutorial-chapter-select-modal');
            modal.classList.remove('visible');
            modal.classList.add('hidden');
        }

        function startTutorialChapterReview(chapterNum) {
            closeTutorialChapterSelect();

            // Set review mode - skips interactive steps
            tutorialReviewMode = true;
            tutorialRewardsEligible = false;
            tutorialMode = true;
            tutorialChapter = chapterNum;
            tutorialStep = 0;

            // Show tutorial overlay
            const overlay = document.getElementById('tutorial-overlay');
            overlay.classList.remove('hidden');
            overlay.classList.add('active');

            document.body.classList.add('tutorial-active');

            // Load the chapter
            loadTutorialChapter(chapterNum);
            showNotification(`Reviewing Chapter ${chapterNum}: ${TUTORIAL_CHAPTERS[chapterNum].title}`, 'info');
        }

        function startFullTutorialReview() {
            closeTutorialChapterSelect();

            // Start from chapter 1 in review mode
            tutorialReviewMode = true;
            tutorialRewardsEligible = false;
            initTutorial(false);
        }

        function exitTutorialReview() {
            tutorialReviewMode = false;
            tutorialMode = false;

            // Hide tutorial UI
            document.getElementById('tutorial-overlay').classList.remove('active');
            document.getElementById('tutorial-overlay').classList.add('hidden');
            document.getElementById('tutorial-instruction-box').classList.add('hidden');

            document.body.classList.remove('tutorial-active');
            clearTutorialHighlights();
            unlockTutorialUI();

            showNotification('Tutorial review ended', 'info');
        }

        // UI Highlight Functions
        function highlightElement(selector) {
            clearTutorialHighlights();

            const element = document.querySelector(selector);
            if (!element) return;

            tutorialHighlightedElement = element;
            element.classList.add('tutorial-highlight');

            // Boost parent container z-index so highlighted element pops above darkening
            const leftSidebar = element.closest('.left-sidebar');
            const rightSidebar = element.closest('.right-sidebar');
            const centerContent = element.closest('.center-content');
            const mainLayout = document.querySelector('.main-layout');

            if (leftSidebar) leftSidebar.classList.add('sidebar-highlight-active');
            if (rightSidebar) rightSidebar.classList.add('sidebar-highlight-active');
            if (centerContent) centerContent.classList.add('sidebar-highlight-active');
            if (mainLayout) mainLayout.classList.add('tutorial-active');

            // Don't show spotlight - the gold highlight is sufficient and avoids z-index issues
            // const spotlight = document.getElementById('tutorial-spotlight');
            // spotlight.style.display = 'block';
        }

        function clearTutorialHighlights() {
            if (tutorialHighlightedElement) {
                tutorialHighlightedElement.classList.remove('tutorial-highlight');
                tutorialHighlightedElement = null;
            }

            // Also clear any elements that might have the class
            document.querySelectorAll('.tutorial-highlight').forEach(el => {
                el.classList.remove('tutorial-highlight');
            });

            // Remove sidebar z-index boost
            document.querySelectorAll('.sidebar-highlight-active').forEach(el => {
                el.classList.remove('sidebar-highlight-active');
            });

            // Remove main-layout boost
            const mainLayout = document.querySelector('.main-layout');
            if (mainLayout) mainLayout.classList.remove('tutorial-active');

            // Hide spotlight
            const spotlight = document.getElementById('tutorial-spotlight');
            if (spotlight) spotlight.style.display = 'none';

            // Hide connector line
            const connectorSvg = document.getElementById('tutorial-connector-line');
            if (connectorSvg) {
                connectorSvg.classList.add('hidden');
                connectorSvg.style.display = 'none';
            }
        }

        function lockUIExcept(selectors) {
            tutorialUILocked = true;
            const gameContainer = document.getElementById('game-container');
            gameContainer.classList.add('tutorial-ui-locked');

            // Remove allowed class from everything first
            document.querySelectorAll('.tutorial-allowed').forEach(el => {
                el.classList.remove('tutorial-allowed');
            });

            // Add allowed class to specified elements
            selectors.forEach(selector => {
                document.querySelectorAll(selector).forEach(el => {
                    el.classList.add('tutorial-allowed');
                });
            });

            // Always allow the instruction box, skip button, and progress dots
            const instructionBox = document.getElementById('tutorial-instruction-box');
            if (instructionBox) instructionBox.classList.add('tutorial-allowed');

            const skipBtn = document.querySelector('.tutorial-skip-btn');
            if (skipBtn) skipBtn.classList.add('tutorial-allowed');

            const progressBar = document.getElementById('tutorial-progress');
            if (progressBar) progressBar.classList.add('tutorial-allowed');
        }

        function unlockTutorialUI() {
            tutorialUILocked = false;
            const gameContainer = document.getElementById('game-container');
            gameContainer.classList.remove('tutorial-ui-locked');

            document.querySelectorAll('.tutorial-allowed').forEach(el => {
                el.classList.remove('tutorial-allowed');
            });
        }

        function updatePlayerStatsDisplay() {
            // GM Check: GMs always show infinity stats as a unique perk (testing purposes + flex)
            if (playerCode && playerCode.startsWith('GM')) {
                const mainStats = document.getElementById('main-screen-stats');
                if (mainStats) {
                    mainStats.innerHTML = 'Game Stats: <span style="color: #aa44ff;"> Wins</span> / <span style="color: #aa44ff;"> Games</span> (<span style="color: #aa44ff;">%</span>)';
                }
                return;
            }

            if (!playerCode) return;

            try {
                const db = ensureFirebaseInitialized();
                db.ref('players/' + playerCode).once('value').then(snapshot => {
                    const data = snapshot.val();
                    if (data && data.gamesPlayed) {
                        const wins = data.wins || 0;
                        const games = data.gamesPlayed || 0;
                        const rate = games > 0 ? Math.round((wins / games) * 100) : 0;
                        const text = 'Game Stats: <span style="color: #ffd700;">' + wins + ' Wins</span> / ' + games + ' Games (' + rate + '%)';
                        const mainStats = document.getElementById('main-screen-stats');
                        if (mainStats) mainStats.innerHTML = text;
                    }
                });
            } catch (e) { console.error(e); }
        }
    </script>
</body>
</html>
